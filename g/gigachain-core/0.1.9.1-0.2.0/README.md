# Comparing `tmp/gigachain_core-0.1.9.1.tar.gz` & `tmp/gigachain_core-0.2.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "gigachain_core-0.1.9.1.tar", max compression
+gzip compressed data, was "gigachain_core-0.2.0.tar", max compression
```

## Comparing `gigachain_core-0.1.9.1.tar` & `gigachain_core-0.2.0.tar`

### file list

```diff
@@ -1,120 +1,154 @@
--rw-r--r--   0        0        0     3047 2024-01-10 09:04:40.240772 gigachain_core-0.1.9.1/README.md
--rw-r--r--   0        0        0      390 2024-01-15 11:51:25.597152 gigachain_core-0.1.9.1/langchain_core/__init__.py
--rw-r--r--   0        0        0     1025 2024-01-15 11:51:25.598286 gigachain_core-0.1.9.1/langchain_core/_api/__init__.py
--rw-r--r--   0        0        0     8977 2024-01-15 11:51:25.599167 gigachain_core-0.1.9.1/langchain_core/_api/beta_decorator.py
--rw-r--r--   0        0        0    13829 2024-01-15 11:51:25.601616 gigachain_core-0.1.9.1/langchain_core/_api/deprecation.py
--rw-r--r--   0        0        0      662 2024-01-15 11:51:25.602108 gigachain_core-0.1.9.1/langchain_core/_api/internal.py
--rw-r--r--   0        0        0      984 2023-12-18 12:05:46.602514 gigachain_core-0.1.9.1/langchain_core/_api/path.py
--rw-r--r--   0        0        0     6197 2023-12-18 12:05:46.603051 gigachain_core-0.1.9.1/langchain_core/agents.py
--rw-r--r--   0        0        0        0 2023-12-18 12:05:46.603226 gigachain_core-0.1.9.1/langchain_core/beta/__init__.py
--rw-r--r--   0        0        0        0 2023-12-18 12:05:46.603462 gigachain_core-0.1.9.1/langchain_core/beta/runnables/__init__.py
--rw-r--r--   0        0        0    10617 2024-01-15 11:51:25.603332 gigachain_core-0.1.9.1/langchain_core/beta/runnables/context.py
--rw-r--r--   0        0        0      722 2023-12-18 12:05:46.604982 gigachain_core-0.1.9.1/langchain_core/caches.py
--rw-r--r--   0        0        0     1852 2023-12-18 12:05:46.605433 gigachain_core-0.1.9.1/langchain_core/callbacks/__init__.py
--rw-r--r--   0        0        0    16850 2023-12-18 12:05:46.606868 gigachain_core-0.1.9.1/langchain_core/callbacks/base.py
--rw-r--r--   0        0        0    62827 2024-01-15 11:51:25.606221 gigachain_core-0.1.9.1/langchain_core/callbacks/manager.py
--rw-r--r--   0        0        0     2256 2023-12-18 12:05:46.607875 gigachain_core-0.1.9.1/langchain_core/callbacks/stdout.py
--rw-r--r--   0        0        0     2433 2023-12-18 12:05:46.608271 gigachain_core-0.1.9.1/langchain_core/callbacks/streaming_stdout.py
--rw-r--r--   0        0        0     2493 2024-01-10 09:04:40.242637 gigachain_core-0.1.9.1/langchain_core/chat_history.py
--rw-r--r--   0        0        0      415 2023-12-18 12:05:46.609079 gigachain_core-0.1.9.1/langchain_core/chat_sessions.py
--rw-r--r--   0        0        0      176 2023-12-18 12:05:46.612530 gigachain_core-0.1.9.1/langchain_core/documents/__init__.py
--rw-r--r--   0        0        0      839 2023-12-18 12:05:46.612970 gigachain_core-0.1.9.1/langchain_core/documents/base.py
--rw-r--r--   0        0        0     2494 2024-01-15 11:51:25.608655 gigachain_core-0.1.9.1/langchain_core/documents/transformers.py
--rw-r--r--   0        0        0      787 2024-01-15 11:51:25.609545 gigachain_core-0.1.9.1/langchain_core/embeddings.py
--rw-r--r--   0        0        0      486 2024-01-10 09:04:40.243382 gigachain_core-0.1.9.1/langchain_core/env.py
--rw-r--r--   0        0        0      571 2023-12-18 12:05:46.615278 gigachain_core-0.1.9.1/langchain_core/example_selectors/__init__.py
--rw-r--r--   0        0        0      516 2024-01-15 11:51:25.610626 gigachain_core-0.1.9.1/langchain_core/example_selectors/base.py
--rw-r--r--   0        0        0     2453 2023-12-18 12:05:46.615913 gigachain_core-0.1.9.1/langchain_core/example_selectors/length_based.py
--rw-r--r--   0        0        0     7143 2024-01-15 11:51:25.612090 gigachain_core-0.1.9.1/langchain_core/example_selectors/semantic_similarity.py
--rw-r--r--   0        0        0     1869 2023-12-18 12:05:46.617107 gigachain_core-0.1.9.1/langchain_core/exceptions.py
--rw-r--r--   0        0        0     8376 2023-12-18 12:05:46.619340 gigachain_core-0.1.9.1/langchain_core/globals/__init__.py
--rw-r--r--   0        0        0      522 2024-01-10 09:04:40.244099 gigachain_core-0.1.9.1/langchain_core/language_models/__init__.py
--rw-r--r--   0        0        0    10688 2024-01-15 11:51:25.614043 gigachain_core-0.1.9.1/langchain_core/language_models/base.py
--rw-r--r--   0        0        0    29147 2024-01-15 11:51:25.615176 gigachain_core-0.1.9.1/langchain_core/language_models/chat_models.py
--rw-r--r--   0        0        0    41173 2024-01-15 11:51:25.616692 gigachain_core-0.1.9.1/langchain_core/language_models/llms.py
--rw-r--r--   0        0        0      261 2023-12-18 12:05:46.624002 gigachain_core-0.1.9.1/langchain_core/load/__init__.py
--rw-r--r--   0        0        0     1174 2024-01-15 11:51:25.618027 gigachain_core-0.1.9.1/langchain_core/load/dump.py
--rw-r--r--   0        0        0     5333 2024-01-15 11:51:25.620967 gigachain_core-0.1.9.1/langchain_core/load/load.py
--rw-r--r--   0        0        0    16194 2024-01-15 11:51:25.622324 gigachain_core-0.1.9.1/langchain_core/load/mapping.py
--rw-r--r--   0        0        0     6237 2024-01-10 09:04:40.251663 gigachain_core-0.1.9.1/langchain_core/load/serializable.py
--rw-r--r--   0        0        0     2019 2023-12-18 12:05:46.629384 gigachain_core-0.1.9.1/langchain_core/memory.py
--rw-r--r--   0        0        0     4642 2024-01-15 11:51:25.623839 gigachain_core-0.1.9.1/langchain_core/messages/__init__.py
--rw-r--r--   0        0        0     1754 2023-12-18 12:05:46.632061 gigachain_core-0.1.9.1/langchain_core/messages/ai.py
--rw-r--r--   0        0        0     6254 2024-01-10 09:04:40.253105 gigachain_core-0.1.9.1/langchain_core/messages/base.py
--rw-r--r--   0        0        0     2047 2023-12-18 12:05:46.633256 gigachain_core-0.1.9.1/langchain_core/messages/chat.py
--rw-r--r--   0        0        0     1759 2023-12-18 12:05:46.633621 gigachain_core-0.1.9.1/langchain_core/messages/function.py
--rw-r--r--   0        0        0     1093 2023-12-18 12:05:46.633934 gigachain_core-0.1.9.1/langchain_core/messages/human.py
--rw-r--r--   0        0        0     1046 2023-12-18 12:05:46.634652 gigachain_core-0.1.9.1/langchain_core/messages/system.py
--rw-r--r--   0        0        0     1753 2023-12-18 12:05:46.635449 gigachain_core-0.1.9.1/langchain_core/messages/tool.py
--rw-r--r--   0        0        0     1044 2024-01-15 11:51:25.624790 gigachain_core-0.1.9.1/langchain_core/output_parsers/__init__.py
--rw-r--r--   0        0        0     9740 2024-01-15 11:51:25.626109 gigachain_core-0.1.9.1/langchain_core/output_parsers/base.py
--rw-r--r--   0        0        0      527 2024-01-15 11:51:25.626544 gigachain_core-0.1.9.1/langchain_core/output_parsers/format_instructions.py
--rw-r--r--   0        0        0     7839 2024-01-15 11:51:25.627941 gigachain_core-0.1.9.1/langchain_core/output_parsers/json.py
--rw-r--r--   0        0        0     5507 2024-01-15 11:51:25.629059 gigachain_core-0.1.9.1/langchain_core/output_parsers/list.py
--rw-r--r--   0        0        0      789 2023-12-18 12:05:46.638058 gigachain_core-0.1.9.1/langchain_core/output_parsers/string.py
--rw-r--r--   0        0        0     4466 2023-12-18 12:05:46.638784 gigachain_core-0.1.9.1/langchain_core/output_parsers/transform.py
--rw-r--r--   0        0        0     6056 2024-01-15 11:51:25.630025 gigachain_core-0.1.9.1/langchain_core/output_parsers/xml.py
--rw-r--r--   0        0        0      482 2023-12-18 12:05:46.639458 gigachain_core-0.1.9.1/langchain_core/outputs/__init__.py
--rw-r--r--   0        0        0     2633 2023-12-18 12:05:46.639895 gigachain_core-0.1.9.1/langchain_core/outputs/chat_generation.py
--rw-r--r--   0        0        0      511 2023-12-18 12:05:46.640270 gigachain_core-0.1.9.1/langchain_core/outputs/chat_result.py
--rw-r--r--   0        0        0     1848 2023-12-18 12:05:46.640638 gigachain_core-0.1.9.1/langchain_core/outputs/generation.py
--rw-r--r--   0        0        0     2448 2023-12-18 12:05:46.640994 gigachain_core-0.1.9.1/langchain_core/outputs/llm_result.py
--rw-r--r--   0        0        0      295 2023-12-18 12:05:46.641373 gigachain_core-0.1.9.1/langchain_core/outputs/run_info.py
--rw-r--r--   0        0        0     2662 2023-12-18 12:05:46.641779 gigachain_core-0.1.9.1/langchain_core/prompt_values.py
--rw-r--r--   0        0        0     2581 2023-12-18 12:05:46.642206 gigachain_core-0.1.9.1/langchain_core/prompts/__init__.py
--rw-r--r--   0        0        0     8833 2024-01-10 09:04:40.259515 gigachain_core-0.1.9.1/langchain_core/prompts/base.py
--rw-r--r--   0        0        0    25556 2024-01-17 10:19:33.365957 gigachain_core-0.1.9.1/langchain_core/prompts/chat.py
--rw-r--r--   0        0        0    11888 2024-01-15 11:51:25.631091 gigachain_core-0.1.9.1/langchain_core/prompts/few_shot.py
--rw-r--r--   0        0        0     5817 2023-12-18 12:05:46.650203 gigachain_core-0.1.9.1/langchain_core/prompts/few_shot_with_templates.py
--rw-r--r--   0        0        0     6355 2024-01-17 10:19:33.363654 gigachain_core-0.1.9.1/langchain_core/prompts/loading.py
--rw-r--r--   0        0        0     2498 2023-12-18 12:05:46.656035 gigachain_core-0.1.9.1/langchain_core/prompts/pipeline.py
--rw-r--r--   0        0        0     9833 2024-01-15 11:51:25.632149 gigachain_core-0.1.9.1/langchain_core/prompts/prompt.py
--rw-r--r--   0        0        0     5684 2023-12-18 12:05:46.657304 gigachain_core-0.1.9.1/langchain_core/prompts/string.py
--rw-r--r--   0        0        0        0 2023-12-18 12:05:46.657488 gigachain_core-0.1.9.1/langchain_core/py.typed
--rw-r--r--   0        0        0      927 2023-12-18 12:05:46.657935 gigachain_core-0.1.9.1/langchain_core/pydantic_v1/__init__.py
--rw-r--r--   0        0        0      134 2023-12-18 12:05:46.658853 gigachain_core-0.1.9.1/langchain_core/pydantic_v1/dataclasses.py
--rw-r--r--   0        0        0      120 2023-12-18 12:05:46.659286 gigachain_core-0.1.9.1/langchain_core/pydantic_v1/main.py
--rw-r--r--   0        0        0    10835 2024-01-15 11:51:25.633405 gigachain_core-0.1.9.1/langchain_core/retrievers.py
--rw-r--r--   0        0        0     2184 2024-01-15 11:51:25.634897 gigachain_core-0.1.9.1/langchain_core/runnables/__init__.py
--rw-r--r--   0        0        0   143823 2024-01-15 11:51:25.638702 gigachain_core-0.1.9.1/langchain_core/runnables/base.py
--rw-r--r--   0        0        0    14400 2024-01-10 09:04:40.265078 gigachain_core-0.1.9.1/langchain_core/runnables/branch.py
--rw-r--r--   0        0        0    16801 2024-01-15 11:51:25.640474 gigachain_core-0.1.9.1/langchain_core/runnables/config.py
--rw-r--r--   0        0        0    16031 2024-01-15 11:51:25.642263 gigachain_core-0.1.9.1/langchain_core/runnables/configurable.py
--rw-r--r--   0        0        0    11862 2023-12-18 12:05:46.667535 gigachain_core-0.1.9.1/langchain_core/runnables/fallbacks.py
--rw-r--r--   0        0        0     5044 2024-01-10 09:04:40.266898 gigachain_core-0.1.9.1/langchain_core/runnables/graph.py
--rw-r--r--   0        0        0     8703 2024-01-10 09:04:40.267252 gigachain_core-0.1.9.1/langchain_core/runnables/graph_draw.py
--rw-r--r--   0        0        0    15977 2024-01-15 11:51:25.643796 gigachain_core-0.1.9.1/langchain_core/runnables/history.py
--rw-r--r--   0        0        0    21912 2024-01-15 11:51:25.645070 gigachain_core-0.1.9.1/langchain_core/runnables/passthrough.py
--rw-r--r--   0        0        0    11952 2023-12-18 12:05:46.671577 gigachain_core-0.1.9.1/langchain_core/runnables/retry.py
--rw-r--r--   0        0        0     6274 2023-12-18 12:05:46.672074 gigachain_core-0.1.9.1/langchain_core/runnables/router.py
--rw-r--r--   0        0        0    12554 2024-01-15 11:51:25.646185 gigachain_core-0.1.9.1/langchain_core/runnables/utils.py
--rw-r--r--   0        0        0     1647 2023-12-18 12:05:46.673359 gigachain_core-0.1.9.1/langchain_core/stores.py
--rw-r--r--   0        0        0     1604 2024-01-15 11:51:25.646707 gigachain_core-0.1.9.1/langchain_core/sys_info.py
--rw-r--r--   0        0        0    30198 2024-01-15 11:51:25.647602 gigachain_core-0.1.9.1/langchain_core/tools.py
--rw-r--r--   0        0        0      598 2023-12-18 12:05:46.674639 gigachain_core-0.1.9.1/langchain_core/tracers/__init__.py
--rw-r--r--   0        0        0    18584 2024-01-15 11:51:25.649094 gigachain_core-0.1.9.1/langchain_core/tracers/base.py
--rw-r--r--   0        0        0     7626 2024-01-15 11:51:25.650476 gigachain_core-0.1.9.1/langchain_core/tracers/context.py
--rw-r--r--   0        0        0     8220 2023-12-18 12:05:46.676253 gigachain_core-0.1.9.1/langchain_core/tracers/evaluation.py
--rw-r--r--   0        0        0     9208 2024-01-15 11:51:25.651383 gigachain_core-0.1.9.1/langchain_core/tracers/langchain.py
--rw-r--r--   0        0        0     7467 2024-01-15 11:51:25.652669 gigachain_core-0.1.9.1/langchain_core/tracers/langchain_v1.py
--rw-r--r--   0        0        0    11231 2024-01-15 11:51:25.653683 gigachain_core-0.1.9.1/langchain_core/tracers/log_stream.py
--rw-r--r--   0        0        0     1706 2024-01-10 09:04:40.273121 gigachain_core-0.1.9.1/langchain_core/tracers/root_listeners.py
--rw-r--r--   0        0        0     1532 2023-12-18 12:05:46.679787 gigachain_core-0.1.9.1/langchain_core/tracers/run_collector.py
--rw-r--r--   0        0        0     4265 2024-01-15 11:51:25.654740 gigachain_core-0.1.9.1/langchain_core/tracers/schemas.py
--rw-r--r--   0        0        0     6186 2023-12-18 12:05:46.681272 gigachain_core-0.1.9.1/langchain_core/tracers/stdout.py
--rw-r--r--   0        0        0     1232 2023-12-18 12:05:46.681692 gigachain_core-0.1.9.1/langchain_core/utils/__init__.py
--rw-r--r--   0        0        0     7198 2023-12-18 12:05:46.682359 gigachain_core-0.1.9.1/langchain_core/utils/aiter.py
--rw-r--r--   0        0        0     1297 2024-01-10 09:04:40.273915 gigachain_core-0.1.9.1/langchain_core/utils/env.py
--rw-r--r--   0        0        0      907 2024-01-10 09:04:40.274964 gigachain_core-0.1.9.1/langchain_core/utils/formatting.py
--rw-r--r--   0        0        0     6666 2024-01-15 11:51:25.655416 gigachain_core-0.1.9.1/langchain_core/utils/function_calling.py
--rw-r--r--   0        0        0     3090 2024-01-15 11:51:25.656309 gigachain_core-0.1.9.1/langchain_core/utils/html.py
--rw-r--r--   0        0        0     1289 2023-12-18 12:05:46.685205 gigachain_core-0.1.9.1/langchain_core/utils/input.py
--rw-r--r--   0        0        0     5822 2023-12-18 12:05:46.685803 gigachain_core-0.1.9.1/langchain_core/utils/iter.py
--rw-r--r--   0        0        0     2318 2024-01-15 11:51:25.657132 gigachain_core-0.1.9.1/langchain_core/utils/json_schema.py
--rw-r--r--   0        0        0     2012 2023-12-18 12:05:46.689559 gigachain_core-0.1.9.1/langchain_core/utils/loading.py
--rw-r--r--   0        0        0      301 2023-12-18 12:05:46.690144 gigachain_core-0.1.9.1/langchain_core/utils/pydantic.py
--rw-r--r--   0        0        0      908 2023-12-18 12:05:46.690493 gigachain_core-0.1.9.1/langchain_core/utils/strings.py
--rw-r--r--   0        0        0     6160 2023-12-18 12:05:46.691034 gigachain_core-0.1.9.1/langchain_core/utils/utils.py
--rw-r--r--   0        0        0    25692 2024-01-15 13:18:28.709684 gigachain_core-0.1.9.1/langchain_core/vectorstores.py
--rw-r--r--   0        0        0     2806 2024-01-17 10:40:26.854514 gigachain_core-0.1.9.1/pyproject.toml
--rw-r--r--   0        0        0     4009 1970-01-01 00:00:00.000000 gigachain_core-0.1.9.1/PKG-INFO
+-rw-r--r--   0        0        0     4982 2024-04-19 07:38:33.644451 gigachain_core-0.2.0/README.md
+-rw-r--r--   0        0        0       92 2024-02-22 08:54:02.864832 gigachain_core-0.2.0/langchain_core/__gigachain_core.py
+-rw-r--r--   0        0        0      390 2024-02-09 12:02:36.155932 gigachain_core-0.2.0/langchain_core/__init__.py
+-rw-r--r--   0        0        0     1026 2024-04-19 07:38:33.645877 gigachain_core-0.2.0/langchain_core/_api/__init__.py
+-rw-r--r--   0        0        0     9904 2024-05-06 14:45:38.252232 gigachain_core-0.2.0/langchain_core/_api/beta_decorator.py
+-rw-r--r--   0        0        0    15031 2024-05-06 14:45:38.253236 gigachain_core-0.2.0/langchain_core/_api/deprecation.py
+-rw-r--r--   0        0        0      662 2024-01-18 15:16:40.394159 gigachain_core-0.2.0/langchain_core/_api/internal.py
+-rw-r--r--   0        0        0      984 2023-12-18 12:05:46.602514 gigachain_core-0.2.0/langchain_core/_api/path.py
+-rw-r--r--   0        0        0     7003 2024-04-19 07:38:33.648966 gigachain_core-0.2.0/langchain_core/agents.py
+-rw-r--r--   0        0        0       68 2024-03-28 12:44:20.163721 gigachain_core-0.2.0/langchain_core/beta/__init__.py
+-rw-r--r--   0        0        0        0 2023-12-18 12:05:46.603462 gigachain_core-0.2.0/langchain_core/beta/runnables/__init__.py
+-rw-r--r--   0        0        0    12193 2024-04-19 07:38:33.650254 gigachain_core-0.2.0/langchain_core/beta/runnables/context.py
+-rw-r--r--   0        0        0     7272 2024-05-06 14:45:38.254609 gigachain_core-0.2.0/langchain_core/caches.py
+-rw-r--r--   0        0        0     2132 2024-05-06 14:45:38.256014 gigachain_core-0.2.0/langchain_core/callbacks/__init__.py
+-rw-r--r--   0        0        0    17992 2024-04-19 07:38:33.653366 gigachain_core-0.2.0/langchain_core/callbacks/base.py
+-rw-r--r--   0        0        0     2626 2024-05-06 14:45:38.256417 gigachain_core-0.2.0/langchain_core/callbacks/file.py
+-rw-r--r--   0        0        0    65384 2024-05-23 13:57:37.378170 gigachain_core-0.2.0/langchain_core/callbacks/manager.py
+-rw-r--r--   0        0        0     2314 2024-04-19 07:38:33.655823 gigachain_core-0.2.0/langchain_core/callbacks/stdout.py
+-rw-r--r--   0        0        0     2434 2024-04-19 07:38:33.656680 gigachain_core-0.2.0/langchain_core/callbacks/streaming_stdout.py
+-rw-r--r--   0        0        0     7415 2024-05-06 14:45:38.259292 gigachain_core-0.2.0/langchain_core/chat_history.py
+-rw-r--r--   0        0        0      444 2024-05-06 14:45:38.259738 gigachain_core-0.2.0/langchain_core/chat_loaders.py
+-rw-r--r--   0        0        0      489 2024-04-19 07:38:33.658541 gigachain_core-0.2.0/langchain_core/chat_sessions.py
+-rw-r--r--   0        0        0      261 2024-04-19 07:38:33.658920 gigachain_core-0.2.0/langchain_core/document_loaders/__init__.py
+-rw-r--r--   0        0        0     4236 2024-04-19 07:38:33.659715 gigachain_core-0.2.0/langchain_core/document_loaders/base.py
+-rw-r--r--   0        0        0     6637 2024-04-19 07:38:33.660698 gigachain_core-0.2.0/langchain_core/document_loaders/blob_loaders.py
+-rw-r--r--   0        0        0      378 2024-04-19 07:38:33.662000 gigachain_core-0.2.0/langchain_core/documents/__init__.py
+-rw-r--r--   0        0        0     1036 2024-02-22 08:54:02.874291 gigachain_core-0.2.0/langchain_core/documents/base.py
+-rw-r--r--   0        0        0     1039 2024-03-28 12:44:20.175971 gigachain_core-0.2.0/langchain_core/documents/compressor.py
+-rw-r--r--   0        0        0     2494 2024-01-18 15:16:40.402907 gigachain_core-0.2.0/langchain_core/documents/transformers.py
+-rw-r--r--   0        0        0      220 2024-04-19 07:38:33.662541 gigachain_core-0.2.0/langchain_core/embeddings/__init__.py
+-rw-r--r--   0        0        0      820 2024-04-19 07:38:33.663384 gigachain_core-0.2.0/langchain_core/embeddings/embeddings.py
+-rw-r--r--   0        0        0     1649 2024-04-19 07:38:33.663859 gigachain_core-0.2.0/langchain_core/embeddings/fake.py
+-rw-r--r--   0        0        0      486 2024-01-10 09:04:40.243382 gigachain_core-0.2.0/langchain_core/env.py
+-rw-r--r--   0        0        0      681 2024-04-19 07:38:33.664715 gigachain_core-0.2.0/langchain_core/example_selectors/__init__.py
+-rw-r--r--   0        0        0      980 2024-04-19 07:38:33.665561 gigachain_core-0.2.0/langchain_core/example_selectors/base.py
+-rw-r--r--   0        0        0     2805 2024-04-19 07:38:33.666431 gigachain_core-0.2.0/langchain_core/example_selectors/length_based.py
+-rw-r--r--   0        0        0    12866 2024-05-23 13:57:37.379743 gigachain_core-0.2.0/langchain_core/example_selectors/semantic_similarity.py
+-rw-r--r--   0        0        0     1913 2024-04-19 07:38:33.668685 gigachain_core-0.2.0/langchain_core/exceptions.py
+-rw-r--r--   0        0        0     8377 2024-04-19 07:38:33.669769 gigachain_core-0.2.0/langchain_core/globals.py
+-rw-r--r--   0        0        0      429 2024-05-06 14:45:38.261602 gigachain_core-0.2.0/langchain_core/indexing/__init__.py
+-rw-r--r--   0        0        0    22835 2024-05-06 14:45:38.262123 gigachain_core-0.2.0/langchain_core/indexing/api.py
+-rw-r--r--   0        0        0     6032 2024-05-06 14:45:39.440063 gigachain_core-0.2.0/langchain_core/indexing/base.py
+-rw-r--r--   0        0        0     1686 2024-04-19 07:38:33.670859 gigachain_core-0.2.0/langchain_core/language_models/__init__.py
+-rw-r--r--   0        0        0    13015 2024-05-23 13:57:37.381061 gigachain_core-0.2.0/langchain_core/language_models/base.py
+-rw-r--r--   0        0        0    35556 2024-05-23 13:57:37.381796 gigachain_core-0.2.0/langchain_core/language_models/chat_models.py
+-rw-r--r--   0        0        0     2901 2024-04-19 07:38:33.673221 gigachain_core-0.2.0/langchain_core/language_models/fake.py
+-rw-r--r--   0        0        0    10866 2024-05-06 14:45:38.268077 gigachain_core-0.2.0/langchain_core/language_models/fake_chat_models.py
+-rw-r--r--   0        0        0    48288 2024-05-23 13:57:37.382810 gigachain_core-0.2.0/langchain_core/language_models/llms.py
+-rw-r--r--   0        0        0      289 2024-04-19 07:38:33.675774 gigachain_core-0.2.0/langchain_core/load/__init__.py
+-rw-r--r--   0        0        0     1174 2024-01-18 15:16:40.410831 gigachain_core-0.2.0/langchain_core/load/dump.py
+-rw-r--r--   0        0        0     5744 2024-05-06 14:45:38.270761 gigachain_core-0.2.0/langchain_core/load/load.py
+-rw-r--r--   0        0        0    27029 2024-05-06 14:45:38.271792 gigachain_core-0.2.0/langchain_core/load/mapping.py
+-rw-r--r--   0        0        0     7069 2024-05-23 13:57:37.383953 gigachain_core-0.2.0/langchain_core/load/serializable.py
+-rw-r--r--   0        0        0     2913 2024-04-19 07:38:33.677876 gigachain_core-0.2.0/langchain_core/memory.py
+-rw-r--r--   0        0        0     1970 2024-05-06 14:45:38.273812 gigachain_core-0.2.0/langchain_core/messages/__init__.py
+-rw-r--r--   0        0        0     7448 2024-05-06 14:45:38.274487 gigachain_core-0.2.0/langchain_core/messages/ai.py
+-rw-r--r--   0        0        0     6134 2024-04-19 07:38:33.681705 gigachain_core-0.2.0/langchain_core/messages/base.py
+-rw-r--r--   0        0        0     2395 2024-04-19 07:38:33.682106 gigachain_core-0.2.0/langchain_core/messages/chat.py
+-rw-r--r--   0        0        0     1957 2024-04-19 07:38:33.682490 gigachain_core-0.2.0/langchain_core/messages/function.py
+-rw-r--r--   0        0        0     1089 2024-02-22 08:54:02.894782 gigachain_core-0.2.0/langchain_core/messages/human.py
+-rw-r--r--   0        0        0     1042 2024-02-22 08:54:02.895783 gigachain_core-0.2.0/langchain_core/messages/system.py
+-rw-r--r--   0        0        0     5678 2024-05-06 14:45:38.275045 gigachain_core-0.2.0/langchain_core/messages/tool.py
+-rw-r--r--   0        0        0     8303 2024-05-23 13:57:37.384688 gigachain_core-0.2.0/langchain_core/messages/utils.py
+-rw-r--r--   0        0        0     1453 2024-04-19 07:38:33.684017 gigachain_core-0.2.0/langchain_core/output_parsers/__init__.py
+-rw-r--r--   0        0        0     9841 2024-04-19 07:38:33.685034 gigachain_core-0.2.0/langchain_core/output_parsers/base.py
+-rw-r--r--   0        0        0      527 2024-01-18 15:16:40.421909 gigachain_core-0.2.0/langchain_core/output_parsers/format_instructions.py
+-rw-r--r--   0        0        0     4073 2024-04-19 07:38:33.685639 gigachain_core-0.2.0/langchain_core/output_parsers/gigachat_functions.py
+-rw-r--r--   0        0        0     3704 2024-04-19 07:38:33.686018 gigachain_core-0.2.0/langchain_core/output_parsers/json.py
+-rw-r--r--   0        0        0     5542 2024-05-06 14:45:38.275555 gigachain_core-0.2.0/langchain_core/output_parsers/list.py
+-rw-r--r--   0        0        0     8954 2024-04-19 07:38:33.686767 gigachain_core-0.2.0/langchain_core/output_parsers/openai_functions.py
+-rw-r--r--   0        0        0     7155 2024-04-19 07:38:33.687234 gigachain_core-0.2.0/langchain_core/output_parsers/openai_tools.py
+-rw-r--r--   0        0        0     3867 2024-04-19 07:38:33.687610 gigachain_core-0.2.0/langchain_core/output_parsers/pydantic.py
+-rw-r--r--   0        0        0      789 2023-12-18 12:05:46.638058 gigachain_core-0.2.0/langchain_core/output_parsers/string.py
+-rw-r--r--   0        0        0     4466 2023-12-18 12:05:46.638784 gigachain_core-0.2.0/langchain_core/output_parsers/transform.py
+-rw-r--r--   0        0        0     9277 2024-04-19 07:38:33.688754 gigachain_core-0.2.0/langchain_core/output_parsers/xml.py
+-rw-r--r--   0        0        0      594 2024-04-19 07:38:33.689789 gigachain_core-0.2.0/langchain_core/outputs/__init__.py
+-rw-r--r--   0        0        0     3280 2024-04-19 07:38:33.690365 gigachain_core-0.2.0/langchain_core/outputs/chat_generation.py
+-rw-r--r--   0        0        0      511 2023-12-18 12:05:46.640270 gigachain_core-0.2.0/langchain_core/outputs/chat_result.py
+-rw-r--r--   0        0        0     1809 2024-02-22 08:54:02.900896 gigachain_core-0.2.0/langchain_core/outputs/generation.py
+-rw-r--r--   0        0        0     2448 2023-12-18 12:05:46.640994 gigachain_core-0.2.0/langchain_core/outputs/llm_result.py
+-rw-r--r--   0        0        0      295 2023-12-18 12:05:46.641373 gigachain_core-0.2.0/langchain_core/outputs/run_info.py
+-rw-r--r--   0        0        0     3583 2024-05-06 14:45:38.276481 gigachain_core-0.2.0/langchain_core/prompt_values.py
+-rw-r--r--   0        0        0     2658 2024-05-06 14:45:38.277822 gigachain_core-0.2.0/langchain_core/prompts/__init__.py
+-rw-r--r--   0        0        0    13052 2024-04-19 07:38:33.693058 gigachain_core-0.2.0/langchain_core/prompts/base.py
+-rw-r--r--   0        0        0    44051 2024-04-19 11:34:55.527579 gigachain_core-0.2.0/langchain_core/prompts/chat.py
+-rw-r--r--   0        0        0    14119 2024-04-19 07:38:33.695465 gigachain_core-0.2.0/langchain_core/prompts/few_shot.py
+-rw-r--r--   0        0        0     7509 2024-04-19 07:38:33.696804 gigachain_core-0.2.0/langchain_core/prompts/few_shot_with_templates.py
+-rw-r--r--   0        0        0     3106 2024-05-06 14:45:38.278290 gigachain_core-0.2.0/langchain_core/prompts/image.py
+-rw-r--r--   0        0        0     6321 2024-05-06 14:45:38.279338 gigachain_core-0.2.0/langchain_core/prompts/loading.py
+-rw-r--r--   0        0        0     3138 2024-04-19 07:38:33.698845 gigachain_core-0.2.0/langchain_core/prompts/pipeline.py
+-rw-r--r--   0        0        0    10067 2024-05-06 14:45:38.281992 gigachain_core-0.2.0/langchain_core/prompts/prompt.py
+-rw-r--r--   0        0        0     8411 2024-04-19 07:38:33.700986 gigachain_core-0.2.0/langchain_core/prompts/string.py
+-rw-r--r--   0        0        0     4688 2024-05-06 14:45:38.282872 gigachain_core-0.2.0/langchain_core/prompts/structured.py
+-rw-r--r--   0        0        0        0 2023-12-18 12:05:46.657488 gigachain_core-0.2.0/langchain_core/py.typed
+-rw-r--r--   0        0        0      927 2023-12-18 12:05:46.657935 gigachain_core-0.2.0/langchain_core/pydantic_v1/__init__.py
+-rw-r--r--   0        0        0      134 2023-12-18 12:05:46.658853 gigachain_core-0.2.0/langchain_core/pydantic_v1/dataclasses.py
+-rw-r--r--   0        0        0      120 2023-12-18 12:05:46.659286 gigachain_core-0.2.0/langchain_core/pydantic_v1/main.py
+-rw-r--r--   0        0        0    14250 2024-05-06 14:45:38.283880 gigachain_core-0.2.0/langchain_core/retrievers.py
+-rw-r--r--   0        0        0     2259 2024-04-19 07:38:33.703095 gigachain_core-0.2.0/langchain_core/runnables/__init__.py
+-rw-r--r--   0        0        0   183372 2024-05-23 13:57:37.386109 gigachain_core-0.2.0/langchain_core/runnables/base.py
+-rw-r--r--   0        0        0    14612 2024-04-19 07:38:33.705718 gigachain_core-0.2.0/langchain_core/runnables/branch.py
+-rw-r--r--   0        0        0    17732 2024-04-19 07:38:33.706145 gigachain_core-0.2.0/langchain_core/runnables/config.py
+-rw-r--r--   0        0        0    23196 2024-05-06 14:45:38.286280 gigachain_core-0.2.0/langchain_core/runnables/configurable.py
+-rw-r--r--   0        0        0    20237 2024-04-19 07:38:33.708740 gigachain_core-0.2.0/langchain_core/runnables/fallbacks.py
+-rw-r--r--   0        0        0    13839 2024-05-06 14:45:38.288054 gigachain_core-0.2.0/langchain_core/runnables/graph.py
+-rw-r--r--   0        0        0     8787 2024-04-19 07:38:33.711154 gigachain_core-0.2.0/langchain_core/runnables/graph_ascii.py
+-rw-r--r--   0        0        0     9241 2024-05-23 13:57:37.386902 gigachain_core-0.2.0/langchain_core/runnables/graph_mermaid.py
+-rw-r--r--   0        0        0     5243 2024-05-06 14:45:38.289487 gigachain_core-0.2.0/langchain_core/runnables/graph_png.py
+-rw-r--r--   0        0        0    20156 2024-05-06 14:45:38.290424 gigachain_core-0.2.0/langchain_core/runnables/history.py
+-rw-r--r--   0        0        0      436 2024-04-19 07:38:33.714356 gigachain_core-0.2.0/langchain_core/runnables/learnable.py
+-rw-r--r--   0        0        0    24579 2024-05-06 14:45:38.291335 gigachain_core-0.2.0/langchain_core/runnables/passthrough.py
+-rw-r--r--   0        0        0    11947 2024-02-22 08:54:02.941565 gigachain_core-0.2.0/langchain_core/runnables/retry.py
+-rw-r--r--   0        0        0     6703 2024-04-19 07:38:33.716656 gigachain_core-0.2.0/langchain_core/runnables/router.py
+-rw-r--r--   0        0        0     4398 2024-04-19 07:38:33.717642 gigachain_core-0.2.0/langchain_core/runnables/schema.py
+-rw-r--r--   0        0        0    16922 2024-05-23 13:57:37.388005 gigachain_core-0.2.0/langchain_core/runnables/utils.py
+-rw-r--r--   0        0        0     8067 2024-05-06 14:45:38.294079 gigachain_core-0.2.0/langchain_core/stores.py
+-rw-r--r--   0        0        0     3834 2024-05-06 14:45:38.294491 gigachain_core-0.2.0/langchain_core/structured_query.py
+-rw-r--r--   0        0        0     2778 2024-03-28 12:44:20.255904 gigachain_core-0.2.0/langchain_core/sys_info.py
+-rw-r--r--   0        0        0    38753 2024-05-23 13:57:37.389013 gigachain_core-0.2.0/langchain_core/tools.py
+-rw-r--r--   0        0        0      896 2024-03-28 12:44:20.258388 gigachain_core-0.2.0/langchain_core/tracers/__init__.py
+-rw-r--r--   0        0        0      932 2024-05-23 13:57:37.389320 gigachain_core-0.2.0/langchain_core/tracers/_streaming.py
+-rw-r--r--   0        0        0    21440 2024-05-23 13:57:37.389783 gigachain_core-0.2.0/langchain_core/tracers/base.py
+-rw-r--r--   0        0        0     7095 2024-05-06 14:45:38.297953 gigachain_core-0.2.0/langchain_core/tracers/context.py
+-rw-r--r--   0        0        0     8219 2024-04-19 07:38:33.723373 gigachain_core-0.2.0/langchain_core/tracers/evaluation.py
+-rw-r--r--   0        0        0    26265 2024-05-23 13:57:37.390132 gigachain_core-0.2.0/langchain_core/tracers/event_stream.py
+-rw-r--r--   0        0        0     8283 2024-05-23 13:57:37.391007 gigachain_core-0.2.0/langchain_core/tracers/langchain.py
+-rw-r--r--   0        0        0      546 2024-05-06 14:45:38.298515 gigachain_core-0.2.0/langchain_core/tracers/langchain_v1.py
+-rw-r--r--   0        0        0    22373 2024-05-23 13:57:37.391541 gigachain_core-0.2.0/langchain_core/tracers/log_stream.py
+-rw-r--r--   0        0        0     4268 2024-05-23 13:57:37.392507 gigachain_core-0.2.0/langchain_core/tracers/memory_stream.py
+-rw-r--r--   0        0        0     1704 2024-02-22 08:54:02.963579 gigachain_core-0.2.0/langchain_core/tracers/root_listeners.py
+-rw-r--r--   0        0        0     1530 2024-02-22 08:54:02.964739 gigachain_core-0.2.0/langchain_core/tracers/run_collector.py
+-rw-r--r--   0        0        0     4210 2024-05-23 13:57:37.393466 gigachain_core-0.2.0/langchain_core/tracers/schemas.py
+-rw-r--r--   0        0        0     6136 2024-05-23 13:57:37.393936 gigachain_core-0.2.0/langchain_core/tracers/stdout.py
+-rw-r--r--   0        0        0     1284 2024-02-22 08:54:02.965858 gigachain_core-0.2.0/langchain_core/utils/__init__.py
+-rw-r--r--   0        0        0     2648 2024-04-19 07:38:33.730488 gigachain_core-0.2.0/langchain_core/utils/_merge.py
+-rw-r--r--   0        0        0     7199 2024-05-06 14:45:38.299201 gigachain_core-0.2.0/langchain_core/utils/aiter.py
+-rw-r--r--   0        0        0     1297 2024-01-10 09:04:40.273915 gigachain_core-0.2.0/langchain_core/utils/env.py
+-rw-r--r--   0        0        0      894 2024-04-19 07:38:33.732352 gigachain_core-0.2.0/langchain_core/utils/formatting.py
+-rw-r--r--   0        0        0    19786 2024-05-23 13:57:37.395470 gigachain_core-0.2.0/langchain_core/utils/function_calling.py
+-rw-r--r--   0        0        0     3722 2024-05-06 14:45:38.301126 gigachain_core-0.2.0/langchain_core/utils/html.py
+-rw-r--r--   0        0        0      423 2024-02-22 08:54:02.974418 gigachain_core-0.2.0/langchain_core/utils/image.py
+-rw-r--r--   0        0        0     1304 2024-02-22 08:54:02.975246 gigachain_core-0.2.0/langchain_core/utils/input.py
+-rw-r--r--   0        0        0      139 2024-02-22 08:54:02.975643 gigachain_core-0.2.0/langchain_core/utils/interactive_env.py
+-rw-r--r--   0        0        0     6011 2024-04-19 11:34:55.538336 gigachain_core-0.2.0/langchain_core/utils/iter.py
+-rw-r--r--   0        0        0     5805 2024-04-19 07:38:33.734586 gigachain_core-0.2.0/langchain_core/utils/json.py
+-rw-r--r--   0        0        0     3067 2024-04-19 07:38:33.735021 gigachain_core-0.2.0/langchain_core/utils/json_schema.py
+-rw-r--r--   0        0        0     2012 2024-05-21 13:05:24.492694 gigachain_core-0.2.0/langchain_core/utils/loading.py
+-rw-r--r--   0        0        0    19871 2024-05-06 14:45:38.302310 gigachain_core-0.2.0/langchain_core/utils/mustache.py
+-rw-r--r--   0        0        0      301 2023-12-18 12:05:46.690144 gigachain_core-0.2.0/langchain_core/utils/pydantic.py
+-rw-r--r--   0        0        0      908 2023-12-18 12:05:46.690493 gigachain_core-0.2.0/langchain_core/utils/strings.py
+-rw-r--r--   0        0        0     6235 2024-05-23 13:57:37.395965 gigachain_core-0.2.0/langchain_core/utils/utils.py
+-rw-r--r--   0        0        0    27150 2024-04-19 07:38:33.738377 gigachain_core-0.2.0/langchain_core/vectorstores.py
+-rw-r--r--   0        0        0     3070 2024-05-23 13:57:37.400834 gigachain_core-0.2.0/pyproject.toml
+-rw-r--r--   0        0        0     5925 1970-01-01 00:00:00.000000 gigachain_core-0.2.0/PKG-INFO
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/_api/__init__.py` & `gigachain_core-0.2.0/langchain_core/_api/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -4,14 +4,15 @@
 
 .. warning::
 
     This module and its submodules are for internal use only.  Do not use them
     in your own code.  We may change the API at any time with no warning.
 
 """
+
 from .beta_decorator import (
     LangChainBetaWarning,
     beta,
     suppress_langchain_beta_warning,
     surface_langchain_beta_warnings,
 )
 from .deprecation import (
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/_api/beta_decorator.py` & `gigachain_core-0.2.0/langchain_core/_api/beta_decorator.py`

 * *Files 12% similar despite different names*

```diff
@@ -5,31 +5,32 @@
 https://github.com/matplotlib/matplotlib/blob/main/lib/matplotlib/_api/deprecation.py
 
 .. warning::
 
     This module is for internal use only.  Do not use it in your own code.
     We may change the API at any time with no warning.
 """
+
 import contextlib
 import functools
 import inspect
 import warnings
-from typing import Any, Callable, Generator, Type, TypeVar
+from typing import Any, Callable, Generator, Type, TypeVar, Union, cast
 
 from langchain_core._api.internal import is_caller_internal
 
 
 class LangChainBetaWarning(DeprecationWarning):
     """A class for issuing beta warnings for LangChain users."""
 
 
 # PUBLIC API
 
 
-T = TypeVar("T", Type, Callable)
+T = TypeVar("T", bound=Union[Callable[..., Any], Type])
 
 
 def beta(
     *,
     message: str = "",
     name: str = "",
     obj_type: str = "",
@@ -104,22 +105,30 @@
             """
             nonlocal warned
             if not warned and not is_caller_internal():
                 warned = True
                 emit_warning()
             return wrapped(*args, **kwargs)
 
+        async def awarning_emitting_wrapper(*args: Any, **kwargs: Any) -> Any:
+            """Same as warning_emitting_wrapper, but for async functions."""
+            nonlocal warned
+            if not warned and not is_caller_internal():
+                warned = True
+                emit_warning()
+            return await wrapped(*args, **kwargs)
+
         if isinstance(obj, type):
             if not _obj_type:
                 _obj_type = "class"
             wrapped = obj.__init__  # type: ignore
-            _name = _name or obj.__name__
+            _name = _name or obj.__qualname__
             old_doc = obj.__doc__
 
-            def finalize(_: Any, new_doc: str) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Finalize the annotation of a class."""
                 try:
                     obj.__doc__ = new_doc
                 except AttributeError:  # Can't set on some extension objects.
                     pass
 
                 def warn_if_direct_instance(
@@ -131,97 +140,107 @@
                         warned = True
                         emit_warning()
                     return wrapped(self, *args, **kwargs)
 
                 obj.__init__ = functools.wraps(obj.__init__)(  # type: ignore[misc]
                     warn_if_direct_instance
                 )
-                return obj
+                return cast(T, obj)
 
         elif isinstance(obj, property):
+            # note(erick): this block doesn't seem to be used?
             if not _obj_type:
                 _obj_type = "attribute"
             wrapped = None
-            _name = _name or obj.fget.__name__
+            _name = _name or obj.fget.__qualname__
             old_doc = obj.__doc__
 
-            class _beta_property(type(obj)):  # type: ignore
+            class _beta_property(property):
                 """A beta property."""
 
-                def __get__(self, instance, owner=None):  # type: ignore
+                def __init__(self, fget=None, fset=None, fdel=None, doc=None):
+                    super().__init__(fget, fset, fdel, doc)
+                    self.__orig_fget = fget
+                    self.__orig_fset = fset
+                    self.__orig_fdel = fdel
+
+                def __get__(self, instance, owner=None):
                     if instance is not None or owner is not None:
                         emit_warning()
-                    return super().__get__(instance, owner)
+                    return self.fget(instance)
 
-                def __set__(self, instance, value):  # type: ignore
+                def __set__(self, instance, value):
                     if instance is not None:
                         emit_warning()
-                    return super().__set__(instance, value)
+                    return self.fset(instance, value)
 
-                def __delete__(self, instance):  # type: ignore
+                def __delete__(self, instance):
                     if instance is not None:
                         emit_warning()
-                    return super().__delete__(instance)
+                    return self.fdel(instance)
 
-                def __set_name__(self, owner, set_name):  # type: ignore
+                def __set_name__(self, owner, set_name):
                     nonlocal _name
                     if _name == "<lambda>":
                         _name = set_name
 
-            def finalize(_: Any, new_doc: str) -> Any:  # type: ignore
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> Any:
                 """Finalize the property."""
                 return _beta_property(
                     fget=obj.fget, fset=obj.fset, fdel=obj.fdel, doc=new_doc
                 )
 
         else:
+            _name = _name or obj.__qualname__
             if not _obj_type:
-                _obj_type = "function"
+                # edge case: when a function is within another function
+                # within a test, this will call it a "method" not a "function"
+                _obj_type = "function" if "." not in _name else "method"
             wrapped = obj
-            _name = _name or obj.__name__  # type: ignore
             old_doc = wrapped.__doc__
 
-            def finalize(  # type: ignore
-                wrapper: Callable[..., Any], new_doc: str
-            ) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Wrap the wrapped function using the wrapper and update the docstring.
 
                 Args:
                     wrapper: The wrapper function.
                     new_doc: The new docstring.
 
                 Returns:
                     The wrapped function.
                 """
                 wrapper = functools.wraps(wrapped)(wrapper)
                 wrapper.__doc__ = new_doc
-                return wrapper
+                return cast(T, wrapper)
 
         old_doc = inspect.cleandoc(old_doc or "").strip("\n")
 
+        # old_doc can be None
         if not old_doc:
-            new_doc = "[*Beta*]"
-        else:
-            new_doc = f"[*Beta*]  {old_doc}"
+            old_doc = ""
 
         # Modify the docstring to include a beta notice.
         notes_header = "\nNotes\n-----"
         components = [
             message,
             addendum,
         ]
         details = " ".join([component.strip() for component in components if component])
-        new_doc += (
+        new_doc = (
             f"[*Beta*] {old_doc}\n"
             f"{notes_header if notes_header not in old_doc else ''}\n"
             f".. beta::\n"
             f"   {details}"
         )
 
-        return finalize(warning_emitting_wrapper, new_doc)
+        if inspect.iscoroutinefunction(obj):
+            finalized = finalize(awarning_emitting_wrapper, new_doc)
+        else:
+            finalized = finalize(warning_emitting_wrapper, new_doc)
+        return cast(T, finalized)
 
     return beta
 
 
 @contextlib.contextmanager
 def suppress_langchain_beta_warning() -> Generator[None, None, None]:
     """Context manager to suppress LangChainDeprecationWarning."""
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/_api/deprecation.py` & `gigachain_core-0.2.0/langchain_core/_api/deprecation.py`

 * *Files 8% similar despite different names*

```diff
@@ -10,15 +10,15 @@
     We may change the API at any time with no warning.
 """
 
 import contextlib
 import functools
 import inspect
 import warnings
-from typing import Any, Callable, Generator, Type, TypeVar
+from typing import Any, Callable, Generator, Type, TypeVar, Union, cast
 
 from langchain_core._api.internal import is_caller_internal
 
 
 class LangChainDeprecationWarning(DeprecationWarning):
     """A class for issuing deprecation warnings for LangChain users."""
 
@@ -26,28 +26,29 @@
 class LangChainPendingDeprecationWarning(PendingDeprecationWarning):
     """A class for issuing deprecation warnings for LangChain users."""
 
 
 # PUBLIC API
 
 
-T = TypeVar("T", Type, Callable)
+T = TypeVar("T", bound=Union[Type, Callable[..., Any]])
 
 
 def deprecated(
     since: str,
     *,
     message: str = "",
     name: str = "",
     alternative: str = "",
     alternative_import: str = "",
     pending: bool = False,
     obj_type: str = "",
     addendum: str = "",
     removal: str = "",
+    package: str = "",
 ) -> Callable[[T], T]:
     """Decorator to mark a function, a class, or a property as deprecated.
 
     When deprecating a classmethod, a staticmethod, or a property, the
     ``@deprecated`` decorator should go *under* ``@classmethod`` and
     ``@staticmethod`` (i.e., `deprecated` should directly decorate the
     underlying callable), but *over* ``@property``.
@@ -105,14 +106,15 @@
         _obj_type: str = obj_type,
         _name: str = name,
         _message: str = message,
         _alternative: str = alternative,
         _alternative_import: str = alternative_import,
         _pending: bool = pending,
         _addendum: str = addendum,
+        _package: str = package,
     ) -> T:
         """Implementation of the decorator returned by `deprecated`."""
 
         def emit_warning() -> None:
             """Emit the warning."""
             warn_deprecated(
                 since,
@@ -120,14 +122,15 @@
                 name=_name,
                 alternative=_alternative,
                 alternative_import=_alternative_import,
                 pending=_pending,
                 obj_type=_obj_type,
                 addendum=_addendum,
                 removal=removal,
+                package=_package,
             )
 
         warned = False
 
         def warning_emitting_wrapper(*args: Any, **kwargs: Any) -> Any:
             """Wrapper for the original wrapped callable that emits a warning.
 
@@ -140,24 +143,33 @@
             """
             nonlocal warned
             if not warned and not is_caller_internal():
                 warned = True
                 emit_warning()
             return wrapped(*args, **kwargs)
 
+        async def awarning_emitting_wrapper(*args: Any, **kwargs: Any) -> Any:
+            """Same as warning_emitting_wrapper, but for async functions."""
+
+            nonlocal warned
+            if not warned and not is_caller_internal():
+                warned = True
+                emit_warning()
+            return await wrapped(*args, **kwargs)
+
+        _package = _package or obj.__module__.split(".")[0].replace("_", "-")
+
         if isinstance(obj, type):
             if not _obj_type:
                 _obj_type = "class"
             wrapped = obj.__init__  # type: ignore
-            _name = _name or (
-                f"{obj.__module__}.{obj.__name__}" if obj.__module__ else obj.__name__
-            )
+            _name = _name or obj.__qualname__
             old_doc = obj.__doc__
 
-            def finalize(_: Any, new_doc: str) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Finalize the deprecation of a class."""
                 try:
                     obj.__doc__ = new_doc
                 except AttributeError:  # Can't set on some extension objects.
                     pass
 
                 def warn_if_direct_instance(
@@ -169,98 +181,111 @@
                         warned = True
                         emit_warning()
                     return wrapped(self, *args, **kwargs)
 
                 obj.__init__ = functools.wraps(obj.__init__)(  # type: ignore[misc]
                     warn_if_direct_instance
                 )
-                return obj
+                return cast(T, obj)
 
         elif isinstance(obj, property):
             if not _obj_type:
                 _obj_type = "attribute"
             wrapped = None
-            _name = _name or obj.fget.__name__
+            _name = _name or obj.fget.__qualname__
             old_doc = obj.__doc__
 
-            class _deprecated_property(type(obj)):  # type: ignore
+            class _deprecated_property(property):
                 """A deprecated property."""
 
-                def __get__(self, instance, owner=None):  # type: ignore
+                def __init__(self, fget=None, fset=None, fdel=None, doc=None):
+                    super().__init__(fget, fset, fdel, doc)
+                    self.__orig_fget = fget
+                    self.__orig_fset = fset
+                    self.__orig_fdel = fdel
+
+                def __get__(self, instance, owner=None):
                     if instance is not None or owner is not None:
                         emit_warning()
-                    return super().__get__(instance, owner)
+                    return self.fget(instance)
 
-                def __set__(self, instance, value):  # type: ignore
+                def __set__(self, instance, value):
                     if instance is not None:
                         emit_warning()
-                    return super().__set__(instance, value)
+                    return self.fset(instance, value)
 
-                def __delete__(self, instance):  # type: ignore
+                def __delete__(self, instance):
                     if instance is not None:
                         emit_warning()
-                    return super().__delete__(instance)
+                    return self.fdel(instance)
 
-                def __set_name__(self, owner, set_name):  # type: ignore
+                def __set_name__(self, owner, set_name):
                     nonlocal _name
                     if _name == "<lambda>":
                         _name = set_name
 
-            def finalize(_: Any, new_doc: str) -> Any:  # type: ignore
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> Any:
                 """Finalize the property."""
                 return _deprecated_property(
                     fget=obj.fget, fset=obj.fset, fdel=obj.fdel, doc=new_doc
                 )
 
         else:
+            _name = _name or obj.__qualname__
             if not _obj_type:
-                _obj_type = "function"
+                # edge case: when a function is within another function
+                # within a test, this will call it a "method" not a "function"
+                _obj_type = "function" if "." not in _name else "method"
             wrapped = obj
-            _name = _name or obj.__name__  # type: ignore
             old_doc = wrapped.__doc__
 
-            def finalize(  # type: ignore
-                wrapper: Callable[..., Any], new_doc: str
-            ) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Wrap the wrapped function using the wrapper and update the docstring.
 
                 Args:
                     wrapper: The wrapper function.
                     new_doc: The new docstring.
 
                 Returns:
                     The wrapped function.
                 """
                 wrapper = functools.wraps(wrapped)(wrapper)
                 wrapper.__doc__ = new_doc
-                return wrapper
+                return cast(T, wrapper)
 
         old_doc = inspect.cleandoc(old_doc or "").strip("\n")
 
+        # old_doc can be None
         if not old_doc:
-            new_doc = "[*Deprecated*]"
-        else:
-            new_doc = f"[*Deprecated*]  {old_doc}"
+            old_doc = ""
 
         # Modify the docstring to include a deprecation notice.
         notes_header = "\nNotes\n-----"
         components = [
             message,
             f"Use {alternative} instead." if alternative else "",
             addendum,
         ]
         details = " ".join([component.strip() for component in components if component])
-        new_doc += (
+        package = (
+            _package or _name.split(".")[0].replace("_", "-") if "." in _name else None
+        )
+        since_str = f"{package}=={since}" if package else since
+        new_doc = (
             f"[*Deprecated*] {old_doc}\n"
             f"{notes_header if notes_header not in old_doc else ''}\n"
-            f".. deprecated:: {since}\n"
+            f".. deprecated:: {since_str}\n"
             f"   {details}"
         )
 
-        return finalize(warning_emitting_wrapper, new_doc)
+        if inspect.iscoroutinefunction(obj):
+            finalized = finalize(awarning_emitting_wrapper, new_doc)
+        else:
+            finalized = finalize(warning_emitting_wrapper, new_doc)
+        return cast(T, finalized)
 
     return deprecate
 
 
 @contextlib.contextmanager
 def suppress_langchain_deprecation_warning() -> Generator[None, None, None]:
     """Context manager to suppress LangChainDeprecationWarning."""
@@ -277,14 +302,15 @@
     name: str = "",
     alternative: str = "",
     alternative_import: str = "",
     pending: bool = False,
     obj_type: str = "",
     addendum: str = "",
     removal: str = "",
+    package: str = "",
 ) -> None:
     """Display a standardized deprecation.
 
     Arguments:
         since : str
             The release at which this API became deprecated.
         message : str, optional
@@ -326,32 +352,36 @@
                 f"{removal}"
             )
         else:
             removal = f"in {removal}"
 
     if not message:
         message = ""
-        package = name.split(".")[0].replace("_", "-") if "." in name else "LangChain"
+        _package = (
+            package or name.split(".")[0].replace("_", "-")
+            if "." in name
+            else "LangChain"
+        )
 
         if obj_type:
             message += f"The {obj_type} `{name}`"
         else:
             message += f"`{name}`"
 
         if pending:
             message += " will be deprecated in a future version"
         else:
-            message += f" was deprecated in {package} {since}"
+            message += f" was deprecated in {_package} {since}"
 
             if removal:
                 message += f" and will be removed {removal}"
 
         if alternative_import:
             alt_package = alternative_import.split(".")[0].replace("_", "-")
-            if alt_package == package:
+            if alt_package == _package:
                 message += f". Use {alternative_import} instead."
             else:
                 alt_module, alt_name = alternative_import.rsplit(".", 1)
                 message += (
                     f". An updated version of the {obj_type} exists in the "
                     f"{alt_package} package and should be used instead. To use it run "
                     f"`pip install -U {alt_package}` and import as "
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/_api/internal.py` & `gigachain_core-0.2.0/langchain_core/_api/internal.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/_api/path.py` & `gigachain_core-0.2.0/langchain_core/_api/path.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/agents.py` & `gigachain_core-0.2.0/langchain_core/agents.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,7 +1,38 @@
+"""
+**Agent** is a class that uses an LLM to choose a sequence of actions to take.
+
+In Chains, a sequence of actions is hardcoded. In Agents,
+a language model is used as a reasoning engine to determine which actions
+to take and in which order.
+
+Agents select and use **Tools** and **Toolkits** for actions.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    BaseSingleActionAgent --> LLMSingleActionAgent
+                              OpenAIFunctionsAgent
+                              XMLAgent
+                              Agent --> <name>Agent  # Examples: ZeroShotAgent, ChatAgent
+
+
+    BaseMultiActionAgent  --> OpenAIMultiFunctionsAgent
+
+
+**Main helpers:**
+
+.. code-block::
+
+    AgentType, AgentExecutor, AgentOutputParser, AgentExecutorIterator,
+    AgentAction, AgentFinish, AgentStep
+
+"""  # noqa: E501
+
 from __future__ import annotations
 
 import json
 from typing import Any, List, Literal, Sequence, Union
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.messages import (
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/beta/runnables/context.py` & `gigachain_core-0.2.0/langchain_core/beta/runnables/context.py`

 * *Files 9% similar despite different names*

```diff
@@ -237,15 +237,15 @@
         key: Optional[str] = None,
         value: Optional[SetValue] = None,
         prefix: str = "",
         **kwargs: SetValue,
     ):
         if key is not None:
             kwargs[key] = value
-        super().__init__(
+        super().__init__(  # type: ignore[call-arg]
             keys={
                 k: _coerce_set_value(v) if v is not None else None
                 for k, v in kwargs.items()
             },
             prefix=prefix,
         )
 
@@ -303,15 +303,54 @@
                 await configurable[id_](await mapper.ainvoke(input, config))
             else:
                 await configurable[id_](input)
         return input
 
 
 class Context:
-    """Context for a runnable."""
+    """
+    Context for a runnable.
+
+    The `Context` class provides methods for creating context scopes,
+    getters, and setters within a runnable. It allows for managing
+    and accessing contextual information throughout the execution
+    of a program.
+
+    Example:
+        .. code-block:: python
+
+            from langchain_core.beta.runnables.context import Context
+            from langchain_core.runnables.passthrough import RunnablePassthrough
+            from langchain_core.prompts.prompt import PromptTemplate
+            from langchain_core.output_parsers.string import StrOutputParser
+            from tests.unit_tests.fake.llm import FakeListLLM
+
+            chain = (
+                Context.setter("input")
+                | {
+                    "context": RunnablePassthrough()
+                            | Context.setter("context"),
+                    "question": RunnablePassthrough(),
+                }
+                | PromptTemplate.from_template("{context} {question}")
+                | FakeListLLM(responses=["hello"])
+                | StrOutputParser()
+                | {
+                    "result": RunnablePassthrough(),
+                    "context": Context.getter("context"),
+                    "input": Context.getter("input"),
+                }
+            )
+
+            # Use the chain
+            output = chain.invoke("What's your name?")
+            print(output["result"])  # Output: "hello"
+            print(output["context"])  # Output: "What's your name?"
+            print(output["input"])  # Output: "What's your name?
+    """
 
     @staticmethod
     def create_scope(scope: str, /) -> "PrefixContext":
         """Create a context scope.
 
         Args:
             scope: The scope.
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/callbacks/__init__.py` & `gigachain_core-0.2.0/langchain_core/callbacks/__init__.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,19 +1,29 @@
+"""**Callback handlers** allow listening to events in LangChain.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    BaseCallbackHandler --> <name>CallbackHandler  # Example: AimCallbackHandler
+"""
+
 from langchain_core.callbacks.base import (
     AsyncCallbackHandler,
     BaseCallbackHandler,
     BaseCallbackManager,
     CallbackManagerMixin,
     Callbacks,
     ChainManagerMixin,
     LLMManagerMixin,
     RetrieverManagerMixin,
     RunManagerMixin,
     ToolManagerMixin,
 )
+from langchain_core.callbacks.file import FileCallbackHandler
 from langchain_core.callbacks.manager import (
     AsyncCallbackManager,
     AsyncCallbackManagerForChainGroup,
     AsyncCallbackManagerForChainRun,
     AsyncCallbackManagerForLLMRun,
     AsyncCallbackManagerForRetrieverRun,
     AsyncCallbackManagerForToolRun,
@@ -58,8 +68,9 @@
     "AsyncCallbackManagerForRetrieverRun",
     "CallbackManager",
     "CallbackManagerForChainGroup",
     "AsyncCallbackManager",
     "AsyncCallbackManagerForChainGroup",
     "StdOutCallbackHandler",
     "StreamingStdOutCallbackHandler",
+    "FileCallbackHandler",
 ]
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/callbacks/base.py` & `gigachain_core-0.2.0/langchain_core/callbacks/base.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Base callback handler that can be used to handle callbacks in langchain."""
+
 from __future__ import annotations
 
 from typing import TYPE_CHECKING, Any, Dict, List, Optional, Sequence, TypeVar, Union
 from uuid import UUID
 
 from tenacity import RetryCallState
 
@@ -129,15 +130,15 @@
 
 
 class ToolManagerMixin:
     """Mixin for tool callbacks."""
 
     def on_tool_end(
         self,
-        output: str,
+        output: Any,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> Any:
         """Run when tool ends running."""
 
@@ -162,28 +163,39 @@
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
-        """Run when LLM starts running."""
+        """Run when LLM starts running.
+
+        **ATTENTION**: This method is called for non-chat models (regular LLMs). If
+            you're implementing a handler for a chat model,
+            you should use on_chat_model_start instead.
+        """
 
     def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
-        """Run when a chat model starts running."""
+        """Run when a chat model starts running.
+
+        **ATTENTION**: This method is called for chat models. If you're implementing
+            a handler for a non-chat model, you should use on_llm_start instead.
+        """
+        # NotImplementedError is thrown intentionally
+        # Callback handler will fall back to on_llm_start if this is exception is thrown
         raise NotImplementedError(
             f"{self.__class__.__name__} does not implement `on_chat_model_start`"
         )
 
     def on_retriever_start(
         self,
         serialized: Dict[str, Any],
@@ -215,14 +227,15 @@
         serialized: Dict[str, Any],
         input_str: str,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
         """Run when tool starts running."""
 
 
 class RunManagerMixin:
     """Mixin for run manager."""
@@ -303,28 +316,39 @@
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> None:
-        """Run when LLM starts running."""
+        """Run when LLM starts running.
+
+        **ATTENTION**: This method is called for non-chat models (regular LLMs). If
+            you're implementing a handler for a chat model,
+            you should use on_chat_model_start instead.
+        """
 
     async def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
-        """Run when a chat model starts running."""
+        """Run when a chat model starts running.
+
+        **ATTENTION**: This method is called for chat models. If you're implementing
+            a handler for a non-chat model, you should use on_llm_start instead.
+        """
+        # NotImplementedError is thrown intentionally
+        # Callback handler will fall back to on_llm_start if this is exception is thrown
         raise NotImplementedError(
             f"{self.__class__.__name__} does not implement `on_chat_model_start`"
         )
 
     async def on_llm_new_token(
         self,
         token: str,
@@ -354,16 +378,17 @@
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> None:
         """Run when LLM errors.
+
         Args:
-            error (BaseException): The error that occurred.
+            error: The error that occurred.
             kwargs (Any): Additional keyword arguments.
                 - response (LLMResult): The response which was generated before
                     the error occurred.
         """
 
     async def on_chain_start(
         self,
@@ -405,21 +430,22 @@
         serialized: Dict[str, Any],
         input_str: str,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> None:
         """Run when tool starts running."""
 
     async def on_tool_end(
         self,
-        output: str,
+        output: Any,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> None:
         """Run when tool ends running."""
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/callbacks/manager.py` & `gigachain_core-0.2.0/langchain_core/callbacks/manager.py`

 * *Files 4% similar despite different names*

```diff
@@ -37,14 +37,15 @@
     LLMManagerMixin,
     RetrieverManagerMixin,
     RunManagerMixin,
     ToolManagerMixin,
 )
 from langchain_core.callbacks.stdout import StdOutCallbackHandler
 from langchain_core.messages import BaseMessage, get_buffer_string
+from langchain_core.tracers.schemas import Run
 from langchain_core.utils.env import env_var_is_set
 
 if TYPE_CHECKING:
     from langchain_core.agents import AgentAction, AgentFinish
     from langchain_core.documents import Document
     from langchain_core.outputs import ChatGenerationChunk, GenerationChunk, LLMResult
 
@@ -63,14 +64,15 @@
     callback_manager: Optional[CallbackManager] = None,
     *,
     inputs: Optional[Dict[str, Any]] = None,
     project_name: Optional[str] = None,
     example_id: Optional[Union[str, UUID]] = None,
     run_id: Optional[UUID] = None,
     tags: Optional[List[str]] = None,
+    metadata: Optional[Dict[str, Any]] = None,
 ) -> Generator[CallbackManagerForChainGroup, None, None]:
     """Get a callback manager for a chain group in a context manager.
     Useful for grouping different calls together as a single run even if
     they aren't composed in a single chain.
 
     Args:
         group_name (str): The name of the chain group.
@@ -79,37 +81,40 @@
         project_name (str, optional): The name of the project.
             Defaults to None.
         example_id (str or UUID, optional): The ID of the example.
             Defaults to None.
         run_id (UUID, optional): The ID of the run.
         tags (List[str], optional): The inheritable tags to apply to all runs.
             Defaults to None.
+        metadata (Dict[str, Any], optional): The metadata to apply to all runs.
+            Defaults to None.
 
     Note: must have LANGCHAIN_TRACING_V2 env var set to true to see the trace in LangSmith.
 
     Returns:
         CallbackManagerForChainGroup: The callback manager for the chain group.
 
     Example:
         .. code-block:: python
 
             llm_input = "Foo"
             with trace_as_chain_group("group_name", inputs={"input": llm_input}) as manager:
                 # Use the callback manager for the chain group
-                res = llm.predict(llm_input, callbacks=manager)
+                res = llm.invoke(llm_input, {"callbacks": manager})
                 manager.on_chain_end({"output": res})
     """  # noqa: E501
     from langchain_core.tracers.context import _get_trace_callbacks
 
     cb = _get_trace_callbacks(
         project_name, example_id, callback_manager=callback_manager
     )
     cm = CallbackManager.configure(
         inheritable_callbacks=cb,
         inheritable_tags=tags,
+        inheritable_metadata=metadata,
     )
 
     run_manager = cm.on_chain_start({"name": group_name}, inputs or {}, run_id=run_id)
     child_cm = run_manager.get_child()
     group_cm = CallbackManagerForChainGroup(
         child_cm.handlers,
         child_cm.inheritable_handlers,
@@ -137,14 +142,15 @@
     callback_manager: Optional[AsyncCallbackManager] = None,
     *,
     inputs: Optional[Dict[str, Any]] = None,
     project_name: Optional[str] = None,
     example_id: Optional[Union[str, UUID]] = None,
     run_id: Optional[UUID] = None,
     tags: Optional[List[str]] = None,
+    metadata: Optional[Dict[str, Any]] = None,
 ) -> AsyncGenerator[AsyncCallbackManagerForChainGroup, None]:
     """Get an async callback manager for a chain group in a context manager.
     Useful for grouping different async calls together as a single run even if
     they aren't composed in a single chain.
 
     Args:
         group_name (str): The name of the chain group.
@@ -153,34 +159,38 @@
         project_name (str, optional): The name of the project.
             Defaults to None.
         example_id (str or UUID, optional): The ID of the example.
             Defaults to None.
         run_id (UUID, optional): The ID of the run.
         tags (List[str], optional): The inheritable tags to apply to all runs.
             Defaults to None.
+        metadata (Dict[str, Any], optional): The metadata to apply to all runs.
+            Defaults to None.
     Returns:
         AsyncCallbackManager: The async callback manager for the chain group.
 
     Note: must have LANGCHAIN_TRACING_V2 env var set to true to see the trace in LangSmith.
 
     Example:
         .. code-block:: python
 
             llm_input = "Foo"
             async with atrace_as_chain_group("group_name", inputs={"input": llm_input}) as manager:
                 # Use the async callback manager for the chain group
-                res = await llm.apredict(llm_input, callbacks=manager)
+                res = await llm.ainvoke(llm_input, {"callbacks": manager})
                 await manager.on_chain_end({"output": res})
     """  # noqa: E501
     from langchain_core.tracers.context import _get_trace_callbacks
 
     cb = _get_trace_callbacks(
         project_name, example_id, callback_manager=callback_manager
     )
-    cm = AsyncCallbackManager.configure(inheritable_callbacks=cb, inheritable_tags=tags)
+    cm = AsyncCallbackManager.configure(
+        inheritable_callbacks=cb, inheritable_tags=tags, inheritable_metadata=metadata
+    )
 
     run_manager = await cm.on_chain_start(
         {"name": group_name}, inputs or {}, run_id=run_id
     )
     child_cm = run_manager.get_child()
     group_cm = AsyncCallbackManagerForChainGroup(
         child_cm.handlers,
@@ -199,14 +209,29 @@
             await run_manager.on_chain_error(e)
         raise e
     else:
         if not group_cm.ended:
             await run_manager.on_chain_end({})
 
 
+Func = TypeVar("Func", bound=Callable)
+
+
+def shielded(func: Func) -> Func:
+    """
+    Makes so an awaitable method is always shielded from cancellation
+    """
+
+    @functools.wraps(func)
+    async def wrapped(*args: Any, **kwargs: Any) -> Any:
+        return await asyncio.shield(func(*args, **kwargs))
+
+    return cast(Func, wrapped)
+
+
 def handle_event(
     handlers: List[BaseCallbackHandler],
     event_name: str,
     ignore_condition_name: Optional[str],
     *args: Any,
     **kwargs: Any,
 ) -> None:
@@ -289,24 +314,30 @@
         # - install signal handlers
         # - run pending tasks scheduled by `coros`
         # - close asyncgens and executors
         # - close the loop
         with asyncio.Runner() as runner:
             # Run the coroutine, get the result
             for coro in coros:
-                runner.run(coro)
+                try:
+                    runner.run(coro)
+                except Exception as e:
+                    logger.warning(f"Error in callback coroutine: {repr(e)}")
 
             # Run pending tasks scheduled by coros until they are all done
             while pending := asyncio.all_tasks(runner.get_loop()):
                 runner.run(asyncio.wait(pending))
     else:
         # Before Python 3.11 we need to run each coroutine in a new event loop
         # as the Runner api is not available.
         for coro in coros:
-            asyncio.run(coro)
+            try:
+                asyncio.run(coro)
+            except Exception as e:
+                logger.warning(f"Error in callback coroutine: {repr(e)}")
 
 
 async def _ahandle_event_for_handler(
     handler: BaseCallbackHandler,
     event_name: str,
     ignore_condition_name: Optional[str],
     *args: Any,
@@ -678,14 +709,15 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
+    @shielded
     async def on_llm_new_token(
         self,
         token: str,
         *,
         chunk: Optional[Union[GenerationChunk, ChatGenerationChunk]] = None,
         **kwargs: Any,
     ) -> None:
@@ -702,14 +734,15 @@
             chunk=chunk,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_llm_end(self, response: LLMResult, **kwargs: Any) -> None:
         """Run when LLM ends running.
 
         Args:
             response (LLMResult): The LLM result.
         """
         await ahandle_event(
@@ -719,14 +752,15 @@
             response,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_llm_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when LLM errors.
 
@@ -849,14 +883,15 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
+    @shielded
     async def on_chain_end(
         self, outputs: Union[Dict[str, Any], Any], **kwargs: Any
     ) -> None:
         """Run when chain ends running.
 
         Args:
             outputs (Union[Dict[str, Any], Any]): The outputs of the chain.
@@ -868,14 +903,15 @@
             outputs,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_chain_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when chain errors.
 
@@ -889,14 +925,15 @@
             error,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_agent_action(self, action: AgentAction, **kwargs: Any) -> Any:
         """Run when agent action is received.
 
         Args:
             action (AgentAction): The agent action.
 
         Returns:
@@ -909,14 +946,15 @@
             action,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_agent_finish(self, finish: AgentFinish, **kwargs: Any) -> Any:
         """Run when agent finish is received.
 
         Args:
             finish (AgentFinish): The agent finish.
 
         Returns:
@@ -935,21 +973,21 @@
 
 
 class CallbackManagerForToolRun(ParentRunManager, ToolManagerMixin):
     """Callback manager for tool run."""
 
     def on_tool_end(
         self,
-        output: str,
+        output: Any,
         **kwargs: Any,
     ) -> None:
         """Run when tool ends running.
 
         Args:
-            output (str): The output of the tool.
+            output (Any): The output of the tool.
         """
         handle_event(
             self.handlers,
             "on_tool_end",
             "ignore_agent",
             output,
             run_id=self.run_id,
@@ -996,31 +1034,33 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
-    async def on_tool_end(self, output: str, **kwargs: Any) -> None:
+    @shielded
+    async def on_tool_end(self, output: Any, **kwargs: Any) -> None:
         """Run when tool ends running.
 
         Args:
-            output (str): The output of the tool.
+            output (Any): The output of the tool.
         """
         await ahandle_event(
             self.handlers,
             "on_tool_end",
             "ignore_agent",
             output,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_tool_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when tool errors.
 
@@ -1096,14 +1136,15 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
+    @shielded
     async def on_retriever_end(
         self, documents: Sequence[Document], **kwargs: Any
     ) -> None:
         """Run when retriever ends running."""
         await ahandle_event(
             self.handlers,
             "on_retriever_end",
@@ -1111,14 +1152,15 @@
             documents,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_retriever_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when retriever errors."""
         await ahandle_event(
@@ -1136,30 +1178,32 @@
 class CallbackManager(BaseCallbackManager):
     """Callback manager that handles callbacks from LangChain."""
 
     def on_llm_start(
         self,
         serialized: Dict[str, Any],
         prompts: List[str],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[CallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             prompts (List[str]): The list of prompts.
             run_id (UUID, optional): The ID of the run. Defaults to None.
 
         Returns:
             List[CallbackManagerForLLMRun]: A callback manager for each
                 prompt as an LLM run.
         """
         managers = []
-        for prompt in prompts:
-            run_id_ = uuid.uuid4()
+        for i, prompt in enumerate(prompts):
+            # Can't have duplicate runs with the same run ID (if provided)
+            run_id_ = run_id if i == 0 and run_id is not None else uuid.uuid4()
             handle_event(
                 self.handlers,
                 "on_llm_start",
                 "ignore_llm",
                 serialized,
                 [prompt],
                 run_id=run_id_,
@@ -1184,14 +1228,15 @@
 
         return managers
 
     def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[CallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             messages (List[List[BaseMessage]]): The list of messages.
@@ -1200,15 +1245,19 @@
         Returns:
             List[CallbackManagerForLLMRun]: A callback manager for each
                 list of messages as an LLM run.
         """
 
         managers = []
         for message_list in messages:
-            run_id_ = uuid.uuid4()
+            if run_id is not None:
+                run_id_ = run_id
+                run_id = None
+            else:
+                run_id_ = uuid.uuid4()
             handle_event(
                 self.handlers,
                 "on_chat_model_start",
                 "ignore_chat_model",
                 serialized,
                 [message_list],
                 run_id=run_id_,
@@ -1278,23 +1327,30 @@
 
     def on_tool_start(
         self,
         serialized: Dict[str, Any],
         input_str: str,
         run_id: Optional[UUID] = None,
         parent_run_id: Optional[UUID] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> CallbackManagerForToolRun:
         """Run when tool starts running.
 
         Args:
-            serialized (Dict[str, Any]): The serialized tool.
-            input_str (str): The input to the tool.
-            run_id (UUID, optional): The ID of the run. Defaults to None.
-            parent_run_id (UUID, optional): The ID of the parent run. Defaults to None.
+            serialized: Serialized representation of the tool.
+            input_str: The  input to the tool as a string.
+                Non-string inputs are cast to strings.
+            run_id: ID for the run. Defaults to None.
+            parent_run_id: The ID of the parent run. Defaults to None.
+            inputs: The original input to the tool if provided.
+                Recommended for usage instead of input_str when the original
+                input is needed.
+                If provided, the inputs are expected to be formatted as a dict.
+                The keys will correspond to the named-arguments in the tool.
 
         Returns:
             CallbackManagerForToolRun: The callback manager for the tool run.
         """
         if run_id is None:
             run_id = uuid.uuid4()
 
@@ -1304,14 +1360,15 @@
             "ignore_agent",
             serialized,
             input_str,
             run_id=run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             metadata=self.metadata,
+            inputs=inputs,
             **kwargs,
         )
 
         return CallbackManagerForToolRun(
             run_id=run_id,
             handlers=self.handlers,
             inheritable_handlers=self.inheritable_handlers,
@@ -1465,14 +1522,15 @@
         """Return whether the handler is async."""
         return True
 
     async def on_llm_start(
         self,
         serialized: Dict[str, Any],
         prompts: List[str],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[AsyncCallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             prompts (List[str]): The list of prompts.
@@ -1484,15 +1542,19 @@
                 to each prompt.
         """
 
         tasks = []
         managers = []
 
         for prompt in prompts:
-            run_id_ = uuid.uuid4()
+            if run_id is not None:
+                run_id_ = run_id
+                run_id = None
+            else:
+                run_id_ = uuid.uuid4()
 
             tasks.append(
                 ahandle_event(
                     self.handlers,
                     "on_llm_start",
                     "ignore_llm",
                     serialized,
@@ -1522,14 +1584,15 @@
 
         return managers
 
     async def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[AsyncCallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             messages (List[List[BaseMessage]]): The list of messages.
@@ -1540,15 +1603,19 @@
                 async callback managers, one for each LLM Run
                 corresponding to each inner  message list.
         """
         tasks = []
         managers = []
 
         for message_list in messages:
-            run_id_ = uuid.uuid4()
+            if run_id is not None:
+                run_id_ = run_id
+                run_id = None
+            else:
+                run_id_ = uuid.uuid4()
 
             tasks.append(
                 ahandle_event(
                     self.handlers,
                     "on_chat_model_start",
                     "ignore_chat_model",
                     serialized,
@@ -1843,15 +1910,14 @@
     Returns:
         T: The configured callback manager.
     """
     from langchain_core.tracers.context import (
         _configure_hooks,
         _get_tracer_project,
         _tracing_v2_is_enabled,
-        tracing_callback_var,
         tracing_v2_callback_var,
     )
 
     run_tree = get_run_tree_context()
     parent_run_id = None if run_tree is None else getattr(run_tree, "id")
     callback_manager = callback_manager_cls(handlers=[], parent_run_id=parent_run_id)
     if inheritable_callbacks or local_callbacks:
@@ -1882,28 +1948,33 @@
     if inheritable_tags or local_tags:
         callback_manager.add_tags(inheritable_tags or [])
         callback_manager.add_tags(local_tags or [], False)
     if inheritable_metadata or local_metadata:
         callback_manager.add_metadata(inheritable_metadata or {})
         callback_manager.add_metadata(local_metadata or {}, False)
 
-    tracer = tracing_callback_var.get()
-    tracing_enabled_ = (
-        env_var_is_set("LANGCHAIN_TRACING")
-        or tracer is not None
-        or env_var_is_set("LANGCHAIN_HANDLER")
+    v1_tracing_enabled_ = env_var_is_set("LANGCHAIN_TRACING") or env_var_is_set(
+        "LANGCHAIN_HANDLER"
     )
 
     tracer_v2 = tracing_v2_callback_var.get()
     tracing_v2_enabled_ = _tracing_v2_is_enabled()
+
+    if v1_tracing_enabled_ and not tracing_v2_enabled_:
+        # if both are enabled, can silently ignore the v1 tracer
+        raise RuntimeError(
+            "Tracing using LangChainTracerV1 is no longer supported. "
+            "Please set the LANGCHAIN_TRACING_V2 environment variable to enable "
+            "tracing instead."
+        )
+
     tracer_project = _get_tracer_project()
     debug = _get_debug()
-    if verbose or debug or tracing_enabled_ or tracing_v2_enabled_:
+    if verbose or debug or tracing_v2_enabled_:
         from langchain_core.tracers.langchain import LangChainTracer
-        from langchain_core.tracers.langchain_v1 import LangChainTracerV1
         from langchain_core.tracers.stdout import ConsoleCallbackHandler
 
         if verbose and not any(
             isinstance(handler, StdOutCallbackHandler)
             for handler in callback_manager.handlers
         ):
             if debug:
@@ -1911,41 +1982,42 @@
             else:
                 callback_manager.add_handler(StdOutCallbackHandler(), False)
         if debug and not any(
             isinstance(handler, ConsoleCallbackHandler)
             for handler in callback_manager.handlers
         ):
             callback_manager.add_handler(ConsoleCallbackHandler(), True)
-        if tracing_enabled_ and not any(
-            isinstance(handler, LangChainTracerV1)
-            for handler in callback_manager.handlers
-        ):
-            if tracer:
-                callback_manager.add_handler(tracer, True)
-            else:
-                handler = LangChainTracerV1()
-                handler.load_session(tracer_project)
-                callback_manager.add_handler(handler, True)
         if tracing_v2_enabled_ and not any(
             isinstance(handler, LangChainTracer)
             for handler in callback_manager.handlers
         ):
             if tracer_v2:
                 callback_manager.add_handler(tracer_v2, True)
             else:
                 try:
-                    handler = LangChainTracer(project_name=tracer_project)
+                    handler = LangChainTracer(
+                        project_name=tracer_project,
+                        client=run_tree.client if run_tree is not None else None,
+                    )
                     callback_manager.add_handler(handler, True)
                 except Exception as e:
                     logger.warning(
                         "Unable to load requested LangChainTracer."
                         " To disable this warning,"
                         " unset the LANGCHAIN_TRACING_V2 environment variables.",
-                        e,
+                        f"{repr(e)}",
+                    )
+        if run_tree is not None:
+            for handler in callback_manager.handlers:
+                if isinstance(handler, LangChainTracer):
+                    handler.order_map[run_tree.id] = (
+                        run_tree.trace_id,
+                        run_tree.dotted_order,
                     )
+                    handler.run_map[str(run_tree.id)] = cast(Run, run_tree)
     for var, inheritable, handler_class, env_var in _configure_hooks:
         create_one = (
             env_var is not None
             and env_var_is_set(env_var)
             and handler_class is not None
         )
         if var.get() is not None or create_one:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/callbacks/stdout.py` & `gigachain_core-0.2.0/langchain_core/callbacks/stdout.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Callback Handler that prints to std out."""
+
 from __future__ import annotations
 
 from typing import TYPE_CHECKING, Any, Dict, Optional
 
 from langchain_core.callbacks.base import BaseCallbackHandler
 from langchain_core.utils import print_text
 
@@ -18,35 +19,36 @@
         self.color = color
 
     def on_chain_start(
         self, serialized: Dict[str, Any], inputs: Dict[str, Any], **kwargs: Any
     ) -> None:
         """Print out that we are entering a chain."""
         class_name = serialized.get("name", serialized.get("id", ["<unknown>"])[-1])
-        print(f"\n\n\033[1m> Entering new {class_name} chain...\033[0m")
+        print(f"\n\n\033[1m> Entering new {class_name} chain...\033[0m")  # noqa: T201
 
     def on_chain_end(self, outputs: Dict[str, Any], **kwargs: Any) -> None:
         """Print out that we finished a chain."""
-        print("\n\033[1m> Finished chain.\033[0m")
+        print("\n\033[1m> Finished chain.\033[0m")  # noqa: T201
 
     def on_agent_action(
         self, action: AgentAction, color: Optional[str] = None, **kwargs: Any
     ) -> Any:
         """Run on agent action."""
         print_text(action.log, color=color or self.color)
 
     def on_tool_end(
         self,
-        output: str,
+        output: Any,
         color: Optional[str] = None,
         observation_prefix: Optional[str] = None,
         llm_prefix: Optional[str] = None,
         **kwargs: Any,
     ) -> None:
         """If not the final action, print out observation."""
+        output = str(output)
         if observation_prefix is not None:
             print_text(f"\n{observation_prefix}")
         print_text(output, color=color or self.color)
         if llm_prefix is not None:
             print_text(f"\n{llm_prefix}")
 
     def on_text(
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/callbacks/streaming_stdout.py` & `gigachain_core-0.2.0/langchain_core/callbacks/streaming_stdout.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Callback Handler streams to stdout on new llm token."""
+
 from __future__ import annotations
 
 import sys
 from typing import TYPE_CHECKING, Any, Dict, List
 
 from langchain_core.callbacks.base import BaseCallbackHandler
 
@@ -55,15 +56,15 @@
     ) -> None:
         """Run when tool starts running."""
 
     def on_agent_action(self, action: AgentAction, **kwargs: Any) -> Any:
         """Run on agent action."""
         pass
 
-    def on_tool_end(self, output: str, **kwargs: Any) -> None:
+    def on_tool_end(self, output: Any, **kwargs: Any) -> None:
         """Run when tool ends running."""
 
     def on_tool_error(self, error: BaseException, **kwargs: Any) -> None:
         """Run when tool errors."""
 
     def on_text(self, text: str, **kwargs: Any) -> None:
         """Run on arbitrary text."""
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/documents/base.py` & `gigachain_core-0.2.0/langchain_core/documents/base.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 from __future__ import annotations
 
-from typing import List, Literal
+from typing import Any, List, Literal
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.pydantic_v1 import Field
 
 
 class Document(Serializable):
     """Class for storing a piece of text and associated metadata."""
@@ -13,14 +13,18 @@
     """String text."""
     metadata: dict = Field(default_factory=dict)
     """Arbitrary metadata about the page content (e.g., source, relationships to other
         documents, etc.).
     """
     type: Literal["Document"] = "Document"
 
+    def __init__(self, page_content: str, **kwargs: Any) -> None:
+        """Pass page_content in as positional or named arg."""
+        super().__init__(page_content=page_content, **kwargs)
+
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """Return whether this class is serializable."""
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/documents/transformers.py` & `gigachain_core-0.2.0/langchain_core/documents/transformers.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/embeddings.py` & `gigachain_core-0.2.0/langchain_core/embeddings/embeddings.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,7 +1,9 @@
+"""**Embeddings** interface."""
+
 from abc import ABC, abstractmethod
 from typing import List
 
 from langchain_core.runnables.config import run_in_executor
 
 
 class Embeddings(ABC):
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/example_selectors/__init__.py` & `gigachain_core-0.2.0/langchain_core/example_selectors/__init__.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,8 +1,12 @@
-"""Logic for selecting examples to include in prompts."""
+"""**Example selector** implements logic for selecting examples to include them
+in prompts.
+This allows us to select examples that are most relevant to the input.
+"""
+
 from langchain_core.example_selectors.base import BaseExampleSelector
 from langchain_core.example_selectors.length_based import (
     LengthBasedExampleSelector,
 )
 from langchain_core.example_selectors.semantic_similarity import (
     MaxMarginalRelevanceExampleSelector,
     SemanticSimilarityExampleSelector,
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/example_selectors/length_based.py` & `gigachain_core-0.2.0/langchain_core/example_selectors/length_based.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Select examples based on length."""
+
 import re
 from typing import Callable, Dict, List
 
 from langchain_core.example_selectors.base import BaseExampleSelector
 from langchain_core.prompts.prompt import PromptTemplate
 from langchain_core.pydantic_v1 import BaseModel, validator
 
@@ -30,14 +31,18 @@
 
     def add_example(self, example: Dict[str, str]) -> None:
         """Add new example to list."""
         self.examples.append(example)
         string_example = self.example_prompt.format(**example)
         self.example_text_lengths.append(self.get_text_length(string_example))
 
+    async def aadd_example(self, example: Dict[str, str]) -> None:
+        """Add new example to list."""
+        self.add_example(example)
+
     @validator("example_text_lengths", always=True)
     def calculate_example_text_lengths(cls, v: List[int], values: Dict) -> List[int]:
         """Calculate text lengths if they don't exist."""
         # Check if text lengths were passed in
         if v:
             return v
         # If they were not, calculate them
@@ -57,7 +62,11 @@
             if new_length < 0:
                 break
             else:
                 examples.append(self.examples[i])
                 remaining_length = new_length
             i += 1
         return examples
+
+    async def aselect_examples(self, input_variables: Dict[str, str]) -> List[dict]:
+        """Select which examples to use based on the input lengths."""
+        return self.select_examples(input_variables)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/exceptions.py` & `gigachain_core-0.2.0/langchain_core/exceptions.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,7 +1,9 @@
+"""Custom **exceptions** for LangChain."""
+
 from typing import Any, Optional
 
 
 class LangChainException(Exception):
     """General LangChain exception."""
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/globals/__init__.py` & `gigachain_core-0.2.0/langchain_core/globals.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 # flake8: noqa
 """Global values and configuration that apply to all of LangChain."""
+
 import warnings
 from typing import TYPE_CHECKING, Optional
 
 if TYPE_CHECKING:
     from langchain_core.caches import BaseCache
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/language_models/base.py` & `gigachain_core-0.2.0/langchain_core/language_models/base.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,31 +1,42 @@
 from __future__ import annotations
 
 from abc import ABC, abstractmethod
 from functools import lru_cache
 from typing import (
     TYPE_CHECKING,
     Any,
+    Callable,
+    Dict,
     List,
+    Mapping,
     Optional,
     Sequence,
     Set,
+    Type,
     TypeVar,
     Union,
 )
 
 from typing_extensions import TypeAlias
 
 from langchain_core._api import deprecated
-from langchain_core.messages import AnyMessage, BaseMessage, get_buffer_string
+from langchain_core.messages import (
+    AnyMessage,
+    BaseMessage,
+    MessageLikeRepresentation,
+    get_buffer_string,
+)
 from langchain_core.prompt_values import PromptValue
+from langchain_core.pydantic_v1 import BaseModel, Field, validator
 from langchain_core.runnables import Runnable, RunnableSerializable
 from langchain_core.utils import get_pydantic_field_names
 
 if TYPE_CHECKING:
+    from langchain_core.caches import BaseCache
     from langchain_core.callbacks import Callbacks
     from langchain_core.outputs import LLMResult
 
 
 @lru_cache(maxsize=None)  # Cache the tokenizer
 def get_tokenizer() -> Any:
     try:
@@ -45,28 +56,68 @@
     # get the cached tokenizer
     tokenizer = get_tokenizer()
 
     # tokenize the text using the GPT-2 tokenizer
     return tokenizer.encode(text)
 
 
-LanguageModelInput = Union[PromptValue, str, Sequence[BaseMessage]]
+LanguageModelInput = Union[PromptValue, str, Sequence[MessageLikeRepresentation]]
 LanguageModelOutput = Union[BaseMessage, str]
 LanguageModelLike = Runnable[LanguageModelInput, LanguageModelOutput]
 LanguageModelOutputVar = TypeVar("LanguageModelOutputVar", BaseMessage, str)
 
 
+def _get_verbosity() -> bool:
+    from langchain_core.globals import get_verbose
+
+    return get_verbose()
+
+
 class BaseLanguageModel(
     RunnableSerializable[LanguageModelInput, LanguageModelOutputVar], ABC
 ):
     """Abstract base class for interfacing with language models.
 
     All language model wrappers inherit from BaseLanguageModel.
     """
 
+    cache: Union[BaseCache, bool, None] = None
+    """Whether to cache the response.
+    
+    * If true, will use the global cache.
+    * If false, will not use a cache
+    * If None, will use the global cache if it's set, otherwise no cache.
+    * If instance of BaseCache, will use the provided cache.
+    
+    Caching is not currently supported for streaming methods of models.
+    """
+    verbose: bool = Field(default_factory=_get_verbosity)
+    """Whether to print out response text."""
+    callbacks: Callbacks = Field(default=None, exclude=True)
+    """Callbacks to add to the run trace."""
+    tags: Optional[List[str]] = Field(default=None, exclude=True)
+    """Tags to add to the run trace."""
+    metadata: Optional[Dict[str, Any]] = Field(default=None, exclude=True)
+    """Metadata to add to the run trace."""
+    custom_get_token_ids: Optional[Callable[[str], List[int]]] = Field(
+        default=None, exclude=True
+    )
+    """Optional encoder to use for counting tokens."""
+
+    @validator("verbose", pre=True, always=True)
+    def set_verbose(cls, verbose: Optional[bool]) -> bool:
+        """If verbose is None, set it.
+
+        This allows users to pass in None as verbose to access the global setting.
+        """
+        if verbose is None:
+            return _get_verbosity()
+        else:
+            return verbose
+
     @property
     def InputType(self) -> TypeAlias:
         """Get the input type for this runnable."""
         from langchain_core.prompt_values import (
             ChatPromptValueConcrete,
             StringPromptValue,
         )
@@ -146,15 +197,23 @@
                 to the model provider API call.
 
         Returns:
             An LLMResult, which contains a list of candidate Generations for each input
                 prompt and additional model provider-specific output.
         """
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    def with_structured_output(
+        self, schema: Union[Dict, Type[BaseModel]], **kwargs: Any
+    ) -> Runnable[LanguageModelInput, Union[Dict, BaseModel]]:
+        """Not implemented on this class."""
+        # Implement this on child class if there is a way of steering the model to
+        # generate responses that match a given schema.
+        raise NotImplementedError()
+
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     @abstractmethod
     def predict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         """Pass a single string input to the model and return a string.
 
          Use this method when passing in raw text. If you want to pass in specific
@@ -167,15 +226,15 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a string.
         """
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     @abstractmethod
     def predict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
@@ -192,15 +251,15 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a message.
         """
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     @abstractmethod
     async def apredict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         """Asynchronously pass a string to the model and return a string.
 
         Use this method when calling pure text generation models and only the top
@@ -213,15 +272,15 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a string.
         """
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     @abstractmethod
     async def apredict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
@@ -238,25 +297,33 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a message.
         """
 
+    @property
+    def _identifying_params(self) -> Mapping[str, Any]:
+        """Get the identifying parameters."""
+        return self.lc_attributes
+
     def get_token_ids(self, text: str) -> List[int]:
         """Return the ordered ids of the tokens in a text.
 
         Args:
             text: The string input to tokenize.
 
         Returns:
             A list of ids corresponding to the tokens in the text, in order they occur
                 in the text.
         """
-        return _get_token_ids_default_method(text)
+        if self.custom_get_token_ids is not None:
+            return self.custom_get_token_ids(text)
+        else:
+            return _get_token_ids_default_method(text)
 
     def get_num_tokens(self, text: str) -> int:
         """Get the number of tokens present in the text.
 
         Useful for checking if an input will fit in a model's context window.
 
         Args:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/language_models/chat_models.py` & `gigachain_core-0.2.0/langchain_core/language_models/chat_models.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,26 +1,34 @@
 from __future__ import annotations
 
 import asyncio
 import inspect
+import uuid
 import warnings
 from abc import ABC, abstractmethod
 from typing import (
     TYPE_CHECKING,
     Any,
     AsyncIterator,
+    Callable,
     Dict,
     Iterator,
     List,
+    Literal,
     Optional,
     Sequence,
+    Type,
+    Union,
     cast,
 )
 
+from typing_extensions import TypedDict
+
 from langchain_core._api import deprecated
+from langchain_core.caches import BaseCache
 from langchain_core.callbacks import (
     AsyncCallbackManager,
     AsyncCallbackManagerForLLMRun,
     BaseCallbackManager,
     CallbackManager,
     CallbackManagerForLLMRun,
     Callbacks,
@@ -30,35 +38,42 @@
 from langchain_core.load import dumpd, dumps
 from langchain_core.messages import (
     AIMessage,
     AnyMessage,
     BaseMessage,
     BaseMessageChunk,
     HumanMessage,
+    convert_to_messages,
     message_chunk_to_message,
 )
 from langchain_core.outputs import (
     ChatGeneration,
     ChatGenerationChunk,
     ChatResult,
     LLMResult,
     RunInfo,
 )
 from langchain_core.prompt_values import ChatPromptValue, PromptValue, StringPromptValue
 from langchain_core.pydantic_v1 import Field, root_validator
 from langchain_core.runnables.config import ensure_config, run_in_executor
+from langchain_core.tracers._streaming import _StreamingCallbackHandler
 
 if TYPE_CHECKING:
-    from langchain_core.runnables import RunnableConfig
-
+    from langchain_core.pydantic_v1 import BaseModel
+    from langchain_core.runnables import Runnable, RunnableConfig
+    from langchain_core.tools import BaseTool
 
-def _get_verbosity() -> bool:
-    from langchain_core.globals import get_verbose
 
-    return get_verbose()
+class LangSmithParams(TypedDict, total=False):
+    ls_provider: str
+    ls_model_name: str
+    ls_model_type: Literal["chat"]
+    ls_temperature: Optional[float]
+    ls_max_tokens: Optional[int]
+    ls_stop: Optional[List[str]]
 
 
 def generate_from_stream(stream: Iterator[ChatGenerationChunk]) -> ChatResult:
     """Generate from a stream."""
 
     generation: Optional[ChatGenerationChunk] = None
     for chunk in stream:
@@ -98,26 +113,16 @@
         ]
     )
 
 
 class BaseChatModel(BaseLanguageModel[BaseMessage], ABC):
     """Base class for Chat models."""
 
-    cache: Optional[bool] = None
-    """Whether to cache the response."""
-    verbose: bool = Field(default_factory=_get_verbosity)
-    """Whether to print out response text."""
-    callbacks: Callbacks = Field(default=None, exclude=True)
-    """Callbacks to add to the run trace."""
     callback_manager: Optional[BaseCallbackManager] = Field(default=None, exclude=True)
     """[DEPRECATED] Callback manager to add to the run trace."""
-    tags: Optional[List[str]] = Field(default=None, exclude=True)
-    """Tags to add to the run trace."""
-    metadata: Optional[Dict[str, Any]] = Field(default=None, exclude=True)
-    """Metadata to add to the run trace."""
 
     @root_validator()
     def raise_deprecation(cls, values: Dict) -> Dict:
         """Raise deprecation warning if callback_manager is used."""
         if values.get("callback_manager") is not None:
             warnings.warn(
                 "callback_manager is deprecated. Please use callbacks instead.",
@@ -140,15 +145,15 @@
 
     def _convert_input(self, input: LanguageModelInput) -> PromptValue:
         if isinstance(input, PromptValue):
             return input
         elif isinstance(input, str):
             return StringPromptValue(text=input)
         elif isinstance(input, Sequence):
-            return ChatPromptValue(messages=input)
+            return ChatPromptValue(messages=convert_to_messages(input))
         else:
             raise ValueError(
                 f"Invalid input type {type(input)}. "
                 "Must be a PromptValue, str, or list of BaseMessages."
             )
 
     def invoke(
@@ -165,14 +170,15 @@
             self.generate_prompt(
                 [self._convert_input(input)],
                 stop=stop,
                 callbacks=config.get("callbacks"),
                 tags=config.get("tags"),
                 metadata=config.get("metadata"),
                 run_name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 **kwargs,
             ).generations[0][0],
         ).message
 
     async def ainvoke(
         self,
         input: LanguageModelInput,
@@ -185,14 +191,15 @@
         llm_result = await self.agenerate_prompt(
             [self._convert_input(input)],
             stop=stop,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
             **kwargs,
         )
         return cast(ChatGeneration, llm_result.generations[0][0]).message
 
     def stream(
         self,
         input: LanguageModelInput,
@@ -207,36 +214,45 @@
                 BaseMessageChunk, self.invoke(input, config=config, stop=stop, **kwargs)
             )
         else:
             config = ensure_config(config)
             messages = self._convert_input(input).to_messages()
             params = self._get_invocation_params(stop=stop, **kwargs)
             options = {"stop": stop, **kwargs}
+            inheritable_metadata = {
+                **(config.get("metadata") or {}),
+                **self._get_ls_params(stop=stop, **kwargs),
+            }
             callback_manager = CallbackManager.configure(
                 config.get("callbacks"),
                 self.callbacks,
                 self.verbose,
                 config.get("tags"),
                 self.tags,
-                config.get("metadata"),
+                inheritable_metadata,
                 self.metadata,
             )
             (run_manager,) = callback_manager.on_chat_model_start(
                 dumpd(self),
                 [messages],
                 invocation_params=params,
                 options=options,
                 name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 batch_size=1,
             )
             generation: Optional[ChatGenerationChunk] = None
             try:
-                for chunk in self._stream(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
-                ):
+                for chunk in self._stream(messages, stop=stop, **kwargs):
+                    if chunk.message.id is None:
+                        chunk.message.id = f"run-{run_manager.run_id}"
+                    chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                    run_manager.on_llm_new_token(
+                        cast(str, chunk.message.content), chunk=chunk
+                    )
                     yield chunk.message
                     if generation is None:
                         generation = chunk
                     else:
                         generation += chunk
                 assert generation is not None
             except BaseException as e:
@@ -254,65 +270,81 @@
         self,
         input: LanguageModelInput,
         config: Optional[RunnableConfig] = None,
         *,
         stop: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> AsyncIterator[BaseMessageChunk]:
-        if type(self)._astream == BaseChatModel._astream:
-            # model doesn't implement streaming, so use default implementation
+        if (
+            type(self)._astream is BaseChatModel._astream
+            and type(self)._stream is BaseChatModel._stream
+        ):
+            # No async or sync stream is implemented, so fall back to ainvoke
             yield cast(
                 BaseMessageChunk,
                 await self.ainvoke(input, config=config, stop=stop, **kwargs),
             )
-        else:
-            config = ensure_config(config)
-            messages = self._convert_input(input).to_messages()
-            params = self._get_invocation_params(stop=stop, **kwargs)
-            options = {"stop": stop, **kwargs}
-            callback_manager = AsyncCallbackManager.configure(
-                config.get("callbacks"),
-                self.callbacks,
-                self.verbose,
-                config.get("tags"),
-                self.tags,
-                config.get("metadata"),
-                self.metadata,
+            return
+
+        config = ensure_config(config)
+        messages = self._convert_input(input).to_messages()
+        params = self._get_invocation_params(stop=stop, **kwargs)
+        options = {"stop": stop, **kwargs}
+        inheritable_metadata = {
+            **(config.get("metadata") or {}),
+            **self._get_ls_params(stop=stop, **kwargs),
+        }
+        callback_manager = AsyncCallbackManager.configure(
+            config.get("callbacks"),
+            self.callbacks,
+            self.verbose,
+            config.get("tags"),
+            self.tags,
+            inheritable_metadata,
+            self.metadata,
+        )
+        (run_manager,) = await callback_manager.on_chat_model_start(
+            dumpd(self),
+            [messages],
+            invocation_params=params,
+            options=options,
+            name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            batch_size=1,
+        )
+
+        generation: Optional[ChatGenerationChunk] = None
+        try:
+            async for chunk in self._astream(
+                messages,
+                stop=stop,
+                **kwargs,
+            ):
+                if chunk.message.id is None:
+                    chunk.message.id = f"run-{run_manager.run_id}"
+                chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                await run_manager.on_llm_new_token(
+                    cast(str, chunk.message.content), chunk=chunk
+                )
+                yield chunk.message
+                if generation is None:
+                    generation = chunk
+                else:
+                    generation += chunk
+            assert generation is not None
+        except BaseException as e:
+            await run_manager.on_llm_error(
+                e,
+                response=LLMResult(generations=[[generation]] if generation else []),
             )
-            (run_manager,) = await callback_manager.on_chat_model_start(
-                dumpd(self),
-                [messages],
-                invocation_params=params,
-                options=options,
-                name=config.get("run_name"),
-                batch_size=1,
+            raise e
+        else:
+            await run_manager.on_llm_end(
+                LLMResult(generations=[[generation]]),
             )
-            generation: Optional[ChatGenerationChunk] = None
-            try:
-                async for chunk in self._astream(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
-                ):
-                    yield chunk.message
-                    if generation is None:
-                        generation = chunk
-                    else:
-                        generation += chunk
-                assert generation is not None
-            except BaseException as e:
-                await run_manager.on_llm_error(
-                    e,
-                    response=LLMResult(
-                        generations=[[generation]] if generation else []
-                    ),
-                )
-                raise e
-            else:
-                await run_manager.on_llm_end(
-                    LLMResult(generations=[[generation]]),
-                )
 
     # --- Custom methods ---
 
     def _combine_llm_outputs(self, llm_outputs: List[Optional[dict]]) -> dict:
         return {}
 
     def _get_invocation_params(
@@ -320,14 +352,25 @@
         stop: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> dict:
         params = self.dict()
         params["stop"] = stop
         return {**params, **kwargs}
 
+    def _get_ls_params(
+        self,
+        stop: Optional[List[str]] = None,
+        **kwargs: Any,
+    ) -> LangSmithParams:
+        """Get standard params for tracing."""
+        ls_params = LangSmithParams(ls_model_type="chat")
+        if stop:
+            ls_params["ls_stop"] = stop
+        return ls_params
+
     def _get_llm_string(self, stop: Optional[List[str]] = None, **kwargs: Any) -> str:
         if self.is_lc_serializable():
             params = {**kwargs, **{"stop": stop}}
             param_string = str(sorted([(k, v) for k, v in params.items()]))
             llm_string = dumps(self)
             return llm_string + "---" + param_string
         else:
@@ -340,14 +383,15 @@
         messages: List[List[BaseMessage]],
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Pass a sequence of prompts to the model and return model generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -368,30 +412,35 @@
 
         Returns:
             An LLMResult, which contains a list of candidate Generations for each input
                 prompt and additional model provider-specific output.
         """
         params = self._get_invocation_params(stop=stop, **kwargs)
         options = {"stop": stop}
+        inheritable_metadata = {
+            **(metadata or {}),
+            **self._get_ls_params(stop=stop, **kwargs),
+        }
 
         callback_manager = CallbackManager.configure(
             callbacks,
             self.callbacks,
             self.verbose,
             tags,
             self.tags,
-            metadata,
+            inheritable_metadata,
             self.metadata,
         )
         run_managers = callback_manager.on_chat_model_start(
             dumpd(self),
             messages,
             invocation_params=params,
             options=options,
             name=run_name,
+            run_id=run_id,
             batch_size=len(messages),
         )
         results = []
         for i, m in enumerate(messages):
             try:
                 results.append(
                     self._generate_with_cache(
@@ -402,20 +451,20 @@
                     )
                 )
             except BaseException as e:
                 if run_managers:
                     run_managers[i].on_llm_error(e, response=LLMResult(generations=[]))
                 raise e
         flattened_outputs = [
-            LLMResult(generations=[res.generations], llm_output=res.llm_output)
+            LLMResult(generations=[res.generations], llm_output=res.llm_output)  # type: ignore[list-item]
             for res in results
         ]
         llm_output = self._combine_llm_outputs([res.llm_output for res in results])
         generations = [res.generations for res in results]
-        output = LLMResult(generations=generations, llm_output=llm_output)
+        output = LLMResult(generations=generations, llm_output=llm_output)  # type: ignore[arg-type]
         if run_managers:
             run_infos = []
             for manager, flattened_output in zip(run_managers, flattened_outputs):
                 manager.on_llm_end(flattened_output)
                 run_infos.append(RunInfo(run_id=manager.run_id))
             output.run = run_infos
         return output
@@ -425,14 +474,15 @@
         messages: List[List[BaseMessage]],
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Asynchronously pass a sequence of prompts to a model and return generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -453,32 +503,37 @@
 
         Returns:
             An LLMResult, which contains a list of candidate Generations for each input
                 prompt and additional model provider-specific output.
         """
         params = self._get_invocation_params(stop=stop, **kwargs)
         options = {"stop": stop}
+        inheritable_metadata = {
+            **(metadata or {}),
+            **self._get_ls_params(stop=stop, **kwargs),
+        }
 
         callback_manager = AsyncCallbackManager.configure(
             callbacks,
             self.callbacks,
             self.verbose,
             tags,
             self.tags,
-            metadata,
+            inheritable_metadata,
             self.metadata,
         )
 
         run_managers = await callback_manager.on_chat_model_start(
             dumpd(self),
             messages,
             invocation_params=params,
             options=options,
             name=run_name,
             batch_size=len(messages),
+            run_id=run_id,
         )
 
         results = await asyncio.gather(
             *[
                 self._agenerate_with_cache(
                     m,
                     stop=stop,
@@ -499,29 +554,30 @@
                 exceptions.append(res)
         if exceptions:
             if run_managers:
                 await asyncio.gather(
                     *[
                         run_manager.on_llm_end(
                             LLMResult(
-                                generations=[res.generations], llm_output=res.llm_output
+                                generations=[res.generations],  # type: ignore[list-item, union-attr]
+                                llm_output=res.llm_output,  # type: ignore[list-item, union-attr]
                             )
                         )
                         for run_manager, res in zip(run_managers, results)
                         if not isinstance(res, Exception)
                     ]
                 )
             raise exceptions[0]
         flattened_outputs = [
-            LLMResult(generations=[res.generations], llm_output=res.llm_output)
+            LLMResult(generations=[res.generations], llm_output=res.llm_output)  # type: ignore[list-item, union-attr]
             for res in results
         ]
-        llm_output = self._combine_llm_outputs([res.llm_output for res in results])
-        generations = [res.generations for res in results]
-        output = LLMResult(generations=generations, llm_output=llm_output)
+        llm_output = self._combine_llm_outputs([res.llm_output for res in results])  # type: ignore[union-attr]
+        generations = [res.generations for res in results]  # type: ignore[union-attr]
+        output = LLMResult(generations=generations, llm_output=llm_output)  # type: ignore[arg-type]
         await asyncio.gather(
             *[
                 run_manager.on_llm_end(flattened_output)
                 for run_manager, flattened_output in zip(
                     run_managers, flattened_outputs
                 )
             ]
@@ -557,86 +613,169 @@
     def _generate_with_cache(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> ChatResult:
-        new_arg_supported = inspect.signature(self._generate).parameters.get(
-            "run_manager"
-        )
-        disregard_cache = self.cache is not None and not self.cache
-        llm_cache = get_llm_cache()
-        if llm_cache is None or disregard_cache:
-            # This happens when langchain.cache is None, but self.cache is True
-            if self.cache is not None and self.cache:
+        if isinstance(self.cache, BaseCache):
+            llm_cache = self.cache
+        else:
+            llm_cache = get_llm_cache()
+        # We should check the cache unless it's explicitly set to False
+        # A None cache means we should use the default global cache
+        # if it's configured.
+        check_cache = self.cache or self.cache is None
+        if check_cache:
+            if llm_cache:
+                llm_string = self._get_llm_string(stop=stop, **kwargs)
+                prompt = dumps(messages)
+                cache_val = llm_cache.lookup(prompt, llm_string)
+                if isinstance(cache_val, list):
+                    return ChatResult(generations=cache_val)
+            elif self.cache is None:
+                pass
+            else:
                 raise ValueError(
                     "Asked to cache, but no cache found at `langchain.cache`."
                 )
-            if new_arg_supported:
-                return self._generate(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
+        # If stream is not explicitly set, check if implicitly requested by
+        # astream_events() or astream_log(). Bail out if _stream not implemented
+        if type(self)._stream != BaseChatModel._stream and kwargs.pop(
+            "stream",
+            (
+                next(
+                    (
+                        True
+                        for h in run_manager.handlers
+                        if isinstance(h, _StreamingCallbackHandler)
+                    ),
+                    False,
                 )
-            else:
-                return self._generate(messages, stop=stop, **kwargs)
+                if run_manager
+                else False
+            ),
+        ):
+            chunks: List[ChatGenerationChunk] = []
+            for chunk in self._stream(messages, stop=stop, **kwargs):
+                chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                if run_manager:
+                    if chunk.message.id is None:
+                        chunk.message.id = f"run-{run_manager.run_id}"
+                    run_manager.on_llm_new_token(
+                        cast(str, chunk.message.content), chunk=chunk
+                    )
+                chunks.append(chunk)
+            result = generate_from_stream(iter(chunks))
         else:
-            llm_string = self._get_llm_string(stop=stop, **kwargs)
-            prompt = dumps(messages)
-            cache_val = llm_cache.lookup(prompt, llm_string)
-            if isinstance(cache_val, list):
-                return ChatResult(generations=cache_val)
+            if inspect.signature(self._generate).parameters.get("run_manager"):
+                result = self._generate(
+                    messages, stop=stop, run_manager=run_manager, **kwargs
+                )
             else:
-                if new_arg_supported:
-                    result = self._generate(
-                        messages, stop=stop, run_manager=run_manager, **kwargs
-                    )
-                else:
-                    result = self._generate(messages, stop=stop, **kwargs)
-                llm_cache.update(prompt, llm_string, result.generations)
-                return result
+                result = self._generate(messages, stop=stop, **kwargs)
+
+        # Add response metadata to each generation
+        for idx, generation in enumerate(result.generations):
+            if run_manager and generation.message.id is None:
+                generation.message.id = f"run-{run_manager.run_id}-{idx}"
+            generation.message.response_metadata = _gen_info_and_msg_metadata(
+                generation
+            )
+        if len(result.generations) == 1 and result.llm_output is not None:
+            result.generations[0].message.response_metadata = {
+                **result.llm_output,
+                **result.generations[0].message.response_metadata,
+            }
+        if check_cache and llm_cache:
+            llm_cache.update(prompt, llm_string, result.generations)
+        return result
 
     async def _agenerate_with_cache(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> ChatResult:
-        new_arg_supported = inspect.signature(self._agenerate).parameters.get(
-            "run_manager"
-        )
-        disregard_cache = self.cache is not None and not self.cache
-        llm_cache = get_llm_cache()
-        if llm_cache is None or disregard_cache:
-            # This happens when langchain.cache is None, but self.cache is True
-            if self.cache is not None and self.cache:
+        if isinstance(self.cache, BaseCache):
+            llm_cache = self.cache
+        else:
+            llm_cache = get_llm_cache()
+        # We should check the cache unless it's explicitly set to False
+        # A None cache means we should use the default global cache
+        # if it's configured.
+        check_cache = self.cache or self.cache is None
+        if check_cache:
+            if llm_cache:
+                llm_string = self._get_llm_string(stop=stop, **kwargs)
+                prompt = dumps(messages)
+                cache_val = await llm_cache.alookup(prompt, llm_string)
+                if isinstance(cache_val, list):
+                    return ChatResult(generations=cache_val)
+            elif self.cache is None:
+                pass
+            else:
                 raise ValueError(
                     "Asked to cache, but no cache found at `langchain.cache`."
                 )
-            if new_arg_supported:
-                return await self._agenerate(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
+        # If stream is not explicitly set, check if implicitly requested by
+        # astream_events() or astream_log(). Bail out if _astream not implemented
+        if (
+            type(self)._astream != BaseChatModel._astream
+            or type(self)._stream != BaseChatModel._stream
+        ) and kwargs.pop(
+            "stream",
+            (
+                next(
+                    (
+                        True
+                        for h in run_manager.handlers
+                        if isinstance(h, _StreamingCallbackHandler)
+                    ),
+                    False,
                 )
-            else:
-                return await self._agenerate(messages, stop=stop, **kwargs)
+                if run_manager
+                else False
+            ),
+        ):
+            chunks: List[ChatGenerationChunk] = []
+            async for chunk in self._astream(messages, stop=stop, **kwargs):
+                chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                if run_manager:
+                    if chunk.message.id is None:
+                        chunk.message.id = f"run-{run_manager.run_id}"
+                    await run_manager.on_llm_new_token(
+                        cast(str, chunk.message.content), chunk=chunk
+                    )
+                chunks.append(chunk)
+            result = generate_from_stream(iter(chunks))
         else:
-            llm_string = self._get_llm_string(stop=stop, **kwargs)
-            prompt = dumps(messages)
-            cache_val = llm_cache.lookup(prompt, llm_string)
-            if isinstance(cache_val, list):
-                return ChatResult(generations=cache_val)
+            if inspect.signature(self._agenerate).parameters.get("run_manager"):
+                result = await self._agenerate(
+                    messages, stop=stop, run_manager=run_manager, **kwargs
+                )
             else:
-                if new_arg_supported:
-                    result = await self._agenerate(
-                        messages, stop=stop, run_manager=run_manager, **kwargs
-                    )
-                else:
-                    result = await self._agenerate(messages, stop=stop, **kwargs)
-                llm_cache.update(prompt, llm_string, result.generations)
-                return result
+                result = await self._agenerate(messages, stop=stop, **kwargs)
+
+        # Add response metadata to each generation
+        for idx, generation in enumerate(result.generations):
+            if run_manager and generation.message.id is None:
+                generation.message.id = f"run-{run_manager.run_id}-{idx}"
+            generation.message.response_metadata = _gen_info_and_msg_metadata(
+                generation
+            )
+        if len(result.generations) == 1 and result.llm_output is not None:
+            result.generations[0].message.response_metadata = {
+                **result.llm_output,
+                **result.generations[0].message.response_metadata,
+            }
+        if check_cache and llm_cache:
+            await llm_cache.aupdate(prompt, llm_string, result.generations)
+        return result
 
     @abstractmethod
     def _generate(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
@@ -666,24 +805,42 @@
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> Iterator[ChatGenerationChunk]:
         raise NotImplementedError()
 
-    def _astream(
+    async def _astream(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> AsyncIterator[ChatGenerationChunk]:
-        raise NotImplementedError()
+        iterator = await run_in_executor(
+            None,
+            self._stream,
+            messages,
+            stop,
+            run_manager.get_sync() if run_manager else None,
+            **kwargs,
+        )
+        done = object()
+        while True:
+            item = await run_in_executor(
+                None,
+                next,
+                iterator,
+                done,  # type: ignore[call-arg, arg-type]
+            )
+            if item is done:
+                break
+            yield item  # type: ignore[misc]
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def __call__(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         **kwargs: Any,
     ) -> BaseMessage:
@@ -707,49 +864,49 @@
         )
         generation = result.generations[0][0]
         if isinstance(generation, ChatGeneration):
             return generation.message
         else:
             raise ValueError("Unexpected generation type")
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def call_as_llm(
         self, message: str, stop: Optional[List[str]] = None, **kwargs: Any
     ) -> str:
         return self.predict(message, stop=stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         result = self([HumanMessage(content=text)], stop=_stop, **kwargs)
         if isinstance(result.content, str):
             return result.content
         else:
             raise ValueError("Cannot use predict when output is not a string.")
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return self(messages, stop=_stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
@@ -757,47 +914,49 @@
             [HumanMessage(content=text)], stop=_stop, **kwargs
         )
         if isinstance(result.content, str):
             return result.content
         else:
             raise ValueError("Cannot use predict when output is not a string.")
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return await self._call_async(messages, stop=_stop, **kwargs)
 
     @property
-    def _identifying_params(self) -> Dict[str, Any]:
-        """Get the identifying parameters."""
-        return {}
-
-    @property
     @abstractmethod
     def _llm_type(self) -> str:
         """Return type of chat model."""
 
     def dict(self, **kwargs: Any) -> Dict:
         """Return a dictionary of the LLM."""
         starter_dict = dict(self._identifying_params)
         starter_dict["_type"] = self._llm_type
         return starter_dict
 
+    def bind_tools(
+        self,
+        tools: Sequence[Union[Dict[str, Any], Type[BaseModel], Callable, BaseTool]],
+        **kwargs: Any,
+    ) -> Runnable[LanguageModelInput, BaseMessage]:
+        raise NotImplementedError()
+
 
 class SimpleChatModel(BaseChatModel):
-    """Simple Chat Model."""
+    """Simplified implementation for a chat model to inherit from."""
 
     def _generate(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
@@ -828,7 +987,16 @@
             None,
             self._generate,
             messages,
             stop=stop,
             run_manager=run_manager.get_sync() if run_manager else None,
             **kwargs,
         )
+
+
+def _gen_info_and_msg_metadata(
+    generation: Union[ChatGeneration, ChatGenerationChunk],
+) -> dict:
+    return {
+        **(generation.generation_info or {}),
+        **generation.message.response_metadata,
+    }
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/language_models/llms.py` & `gigachain_core-0.2.0/langchain_core/language_models/llms.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,26 +1,27 @@
 """Base interface for large language models to expose."""
+
 from __future__ import annotations
 
 import asyncio
 import functools
 import inspect
 import json
 import logging
+import uuid
 import warnings
 from abc import ABC, abstractmethod
 from pathlib import Path
 from typing import (
     Any,
     AsyncIterator,
     Callable,
     Dict,
     Iterator,
     List,
-    Mapping,
     Optional,
     Sequence,
     Tuple,
     Type,
     Union,
     cast,
 )
@@ -33,41 +34,41 @@
     retry_base,
     retry_if_exception_type,
     stop_after_attempt,
     wait_exponential,
 )
 
 from langchain_core._api import deprecated
+from langchain_core.caches import BaseCache
 from langchain_core.callbacks import (
     AsyncCallbackManager,
     AsyncCallbackManagerForLLMRun,
     BaseCallbackManager,
     CallbackManager,
     CallbackManagerForLLMRun,
     Callbacks,
 )
 from langchain_core.globals import get_llm_cache
 from langchain_core.language_models.base import BaseLanguageModel, LanguageModelInput
 from langchain_core.load import dumpd
-from langchain_core.messages import AIMessage, BaseMessage, get_buffer_string
+from langchain_core.messages import (
+    AIMessage,
+    BaseMessage,
+    convert_to_messages,
+    get_buffer_string,
+)
 from langchain_core.outputs import Generation, GenerationChunk, LLMResult, RunInfo
 from langchain_core.prompt_values import ChatPromptValue, PromptValue, StringPromptValue
-from langchain_core.pydantic_v1 import Field, root_validator, validator
+from langchain_core.pydantic_v1 import Field, root_validator
 from langchain_core.runnables import RunnableConfig, ensure_config, get_config_list
 from langchain_core.runnables.config import run_in_executor
 
 logger = logging.getLogger(__name__)
 
 
-def _get_verbosity() -> bool:
-    from langchain_core.globals import get_verbose
-
-    return get_verbose()
-
-
 @functools.lru_cache
 def _log_error_once(msg: str) -> None:
     """Log an error once."""
     logger.error(msg)
 
 
 def create_base_retry_decorator(
@@ -110,67 +111,123 @@
         stop=stop_after_attempt(max_retries),
         wait=wait_exponential(multiplier=1, min=min_seconds, max=max_seconds),
         retry=retry_instance,
         before_sleep=_before_sleep,
     )
 
 
+def _resolve_cache(cache: Union[BaseCache, bool, None]) -> Optional[BaseCache]:
+    """Resolve the cache."""
+    if isinstance(cache, BaseCache):
+        llm_cache = cache
+    elif cache is None:
+        llm_cache = get_llm_cache()
+    elif cache is True:
+        llm_cache = get_llm_cache()
+        if llm_cache is None:
+            raise ValueError(
+                "No global cache was configured. Use `set_llm_cache`."
+                "to set a global cache if you want to use a global cache."
+                "Otherwise either pass a cache object or set cache to False/None"
+            )
+    elif cache is False:
+        llm_cache = None
+    else:
+        raise ValueError(f"Unsupported cache value {cache}")
+    return llm_cache
+
+
 def get_prompts(
-    params: Dict[str, Any], prompts: List[str]
+    params: Dict[str, Any],
+    prompts: List[str],
+    cache: Optional[Union[BaseCache, bool, None]] = None,
 ) -> Tuple[Dict[int, List], str, List[int], List[str]]:
     """Get prompts that are already cached."""
     llm_string = str(sorted([(k, v) for k, v in params.items()]))
     missing_prompts = []
     missing_prompt_idxs = []
     existing_prompts = {}
-    llm_cache = get_llm_cache()
+
+    llm_cache = _resolve_cache(cache)
     for i, prompt in enumerate(prompts):
-        if llm_cache is not None:
+        if llm_cache:
             cache_val = llm_cache.lookup(prompt, llm_string)
             if isinstance(cache_val, list):
                 existing_prompts[i] = cache_val
             else:
                 missing_prompts.append(prompt)
                 missing_prompt_idxs.append(i)
     return existing_prompts, llm_string, missing_prompt_idxs, missing_prompts
 
 
+async def aget_prompts(
+    params: Dict[str, Any],
+    prompts: List[str],
+    cache: Optional[Union[BaseCache, bool, None]] = None,
+) -> Tuple[Dict[int, List], str, List[int], List[str]]:
+    """Get prompts that are already cached. Async version."""
+    llm_string = str(sorted([(k, v) for k, v in params.items()]))
+    missing_prompts = []
+    missing_prompt_idxs = []
+    existing_prompts = {}
+    llm_cache = _resolve_cache(cache)
+    for i, prompt in enumerate(prompts):
+        if llm_cache:
+            cache_val = await llm_cache.alookup(prompt, llm_string)
+            if isinstance(cache_val, list):
+                existing_prompts[i] = cache_val
+            else:
+                missing_prompts.append(prompt)
+                missing_prompt_idxs.append(i)
+    return existing_prompts, llm_string, missing_prompt_idxs, missing_prompts
+
+
 def update_cache(
+    cache: Union[BaseCache, bool, None],
     existing_prompts: Dict[int, List],
     llm_string: str,
     missing_prompt_idxs: List[int],
     new_results: LLMResult,
     prompts: List[str],
 ) -> Optional[dict]:
     """Update the cache and get the LLM output."""
-    llm_cache = get_llm_cache()
+    llm_cache = _resolve_cache(cache)
     for i, result in enumerate(new_results.generations):
         existing_prompts[missing_prompt_idxs[i]] = result
         prompt = prompts[missing_prompt_idxs[i]]
         if llm_cache is not None:
             llm_cache.update(prompt, llm_string, result)
     llm_output = new_results.llm_output
     return llm_output
 
 
+async def aupdate_cache(
+    cache: Union[BaseCache, bool, None],
+    existing_prompts: Dict[int, List],
+    llm_string: str,
+    missing_prompt_idxs: List[int],
+    new_results: LLMResult,
+    prompts: List[str],
+) -> Optional[dict]:
+    """Update the cache and get the LLM output. Async version"""
+    llm_cache = _resolve_cache(cache)
+    for i, result in enumerate(new_results.generations):
+        existing_prompts[missing_prompt_idxs[i]] = result
+        prompt = prompts[missing_prompt_idxs[i]]
+        if llm_cache:
+            await llm_cache.aupdate(prompt, llm_string, result)
+    llm_output = new_results.llm_output
+    return llm_output
+
+
 class BaseLLM(BaseLanguageModel[str], ABC):
     """Base LLM abstract interface.
 
     It should take in a prompt and return a string."""
 
-    cache: Optional[bool] = None
-    """Whether to cache the response."""
-    verbose: bool = Field(default_factory=_get_verbosity)
-    """Whether to print out response text."""
-    callbacks: Callbacks = Field(default=None, exclude=True)
-    """Callbacks to add to the run trace."""
-    tags: Optional[List[str]] = Field(default=None, exclude=True)
-    """Tags to add to the run trace."""
-    metadata: Optional[Dict[str, Any]] = Field(default=None, exclude=True)
-    """Metadata to add to the run trace."""
     callback_manager: Optional[BaseCallbackManager] = Field(default=None, exclude=True)
     """[DEPRECATED]"""
 
     class Config:
         """Configuration for this pydantic object."""
 
         arbitrary_types_allowed = True
@@ -182,39 +239,28 @@
             warnings.warn(
                 "callback_manager is deprecated. Please use callbacks instead.",
                 DeprecationWarning,
             )
             values["callbacks"] = values.pop("callback_manager", None)
         return values
 
-    @validator("verbose", pre=True, always=True)
-    def set_verbose(cls, verbose: Optional[bool]) -> bool:
-        """If verbose is None, set it.
-
-        This allows users to pass in None as verbose to access the global setting.
-        """
-        if verbose is None:
-            return _get_verbosity()
-        else:
-            return verbose
-
     # --- Runnable methods ---
 
     @property
     def OutputType(self) -> Type[str]:
         """Get the input type for this runnable."""
         return str
 
     def _convert_input(self, input: LanguageModelInput) -> PromptValue:
         if isinstance(input, PromptValue):
             return input
         elif isinstance(input, str):
             return StringPromptValue(text=input)
         elif isinstance(input, Sequence):
-            return ChatPromptValue(messages=input)
+            return ChatPromptValue(messages=convert_to_messages(input))
         else:
             raise ValueError(
                 f"Invalid input type {type(input)}. "
                 "Must be a PromptValue, str, or list of BaseMessages."
             )
 
     def invoke(
@@ -230,14 +276,15 @@
             self.generate_prompt(
                 [self._convert_input(input)],
                 stop=stop,
                 callbacks=config.get("callbacks"),
                 tags=config.get("tags"),
                 metadata=config.get("metadata"),
                 run_name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 **kwargs,
             )
             .generations[0][0]
             .text
         )
 
     async def ainvoke(
@@ -252,14 +299,15 @@
         llm_result = await self.agenerate_prompt(
             [self._convert_input(input)],
             stop=stop,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
             **kwargs,
         )
         return llm_result.generations[0][0].text
 
     def batch(
         self,
         inputs: List[LanguageModelInput],
@@ -382,14 +430,15 @@
             )
             (run_manager,) = callback_manager.on_llm_start(
                 dumpd(self),
                 [prompt],
                 invocation_params=params,
                 options=options,
                 name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 batch_size=1,
             )
             generation: Optional[GenerationChunk] = None
             try:
                 for chunk in self._stream(
                     prompt, stop=stop, run_manager=run_manager, **kwargs
                 ):
@@ -414,62 +463,67 @@
         self,
         input: LanguageModelInput,
         config: Optional[RunnableConfig] = None,
         *,
         stop: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> AsyncIterator[str]:
-        if type(self)._astream == BaseLLM._astream:
-            # model doesn't implement streaming, so use default implementation
+        if (
+            type(self)._astream is BaseLLM._astream
+            and type(self)._stream is BaseLLM._stream
+        ):
             yield await self.ainvoke(input, config=config, stop=stop, **kwargs)
-        else:
-            prompt = self._convert_input(input).to_string()
-            config = ensure_config(config)
-            params = self.dict()
-            params["stop"] = stop
-            params = {**params, **kwargs}
-            options = {"stop": stop}
-            callback_manager = AsyncCallbackManager.configure(
-                config.get("callbacks"),
-                self.callbacks,
-                self.verbose,
-                config.get("tags"),
-                self.tags,
-                config.get("metadata"),
-                self.metadata,
-            )
-            (run_manager,) = await callback_manager.on_llm_start(
-                dumpd(self),
-                [prompt],
-                invocation_params=params,
-                options=options,
-                name=config.get("run_name"),
-                batch_size=1,
+            return
+
+        prompt = self._convert_input(input).to_string()
+        config = ensure_config(config)
+        params = self.dict()
+        params["stop"] = stop
+        params = {**params, **kwargs}
+        options = {"stop": stop}
+        callback_manager = AsyncCallbackManager.configure(
+            config.get("callbacks"),
+            self.callbacks,
+            self.verbose,
+            config.get("tags"),
+            self.tags,
+            config.get("metadata"),
+            self.metadata,
+        )
+        (run_manager,) = await callback_manager.on_llm_start(
+            dumpd(self),
+            [prompt],
+            invocation_params=params,
+            options=options,
+            name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            batch_size=1,
+        )
+        generation: Optional[GenerationChunk] = None
+        try:
+            async for chunk in self._astream(
+                prompt,
+                stop=stop,
+                run_manager=run_manager,
+                **kwargs,
+            ):
+                yield chunk.text
+                if generation is None:
+                    generation = chunk
+                else:
+                    generation += chunk
+            assert generation is not None
+        except BaseException as e:
+            await run_manager.on_llm_error(
+                e,
+                response=LLMResult(generations=[[generation]] if generation else []),
             )
-            generation: Optional[GenerationChunk] = None
-            try:
-                async for chunk in self._astream(
-                    prompt, stop=stop, run_manager=run_manager, **kwargs
-                ):
-                    yield chunk.text
-                    if generation is None:
-                        generation = chunk
-                    else:
-                        generation += chunk
-                assert generation is not None
-            except BaseException as e:
-                await run_manager.on_llm_error(
-                    e,
-                    response=LLMResult(
-                        generations=[[generation]] if generation else []
-                    ),
-                )
-                raise e
-            else:
-                await run_manager.on_llm_end(LLMResult(generations=[[generation]]))
+            raise e
+        else:
+            await run_manager.on_llm_end(LLMResult(generations=[[generation]]))
 
     # --- Custom methods ---
 
     @abstractmethod
     def _generate(
         self,
         prompts: List[str],
@@ -499,24 +553,78 @@
     def _stream(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> Iterator[GenerationChunk]:
+        """Stream the LLM on the given prompt.
+
+        This method should be overridden by subclasses that support streaming.
+
+        If not implemented, the default behavior of calls to stream will be to
+        fallback to the non-streaming version of the model and return
+        the output as a single chunk.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of these substrings.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            An iterator of GenerationChunks.
+        """
         raise NotImplementedError()
 
-    def _astream(
+    async def _astream(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> AsyncIterator[GenerationChunk]:
-        raise NotImplementedError()
+        """An async version of the _stream method.
+
+        The default implementation uses the synchronous _stream method and wraps it in
+        an async iterator. Subclasses that need to provide a true async implementation
+        should override this method.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of these substrings.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            An async iterator of GenerationChunks.
+        """
+        iterator = await run_in_executor(
+            None,
+            self._stream,
+            prompt,
+            stop,
+            run_manager.get_sync() if run_manager else None,
+            **kwargs,
+        )
+        done = object()
+        while True:
+            item = await run_in_executor(
+                None,
+                next,
+                iterator,
+                done,  # type: ignore[call-arg, arg-type]
+            )
+            if item is done:
+                break
+            yield item  # type: ignore[misc]
 
     def generate_prompt(
         self,
         prompts: List[PromptValue],
         stop: Optional[List[str]] = None,
         callbacks: Optional[Union[Callbacks, List[Callbacks]]] = None,
         **kwargs: Any,
@@ -574,14 +682,15 @@
         prompts: List[str],
         stop: Optional[List[str]] = None,
         callbacks: Optional[Union[Callbacks, List[Callbacks]]] = None,
         *,
         tags: Optional[Union[List[str], List[List[str]]]] = None,
         metadata: Optional[Union[Dict[str, Any], List[Dict[str, Any]]]] = None,
         run_name: Optional[Union[str, List[str]]] = None,
+        run_id: Optional[Union[uuid.UUID, List[Optional[uuid.UUID]]]] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Pass a sequence of prompts to a model and return generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -659,44 +768,40 @@
                     cast(List[str], tags),
                     self.tags,
                     cast(Dict[str, Any], metadata),
                     self.metadata,
                 )
             ] * len(prompts)
             run_name_list = [cast(Optional[str], run_name)] * len(prompts)
-
+        run_ids_list = self._get_run_ids_list(run_id, prompts)
         params = self.dict()
         params["stop"] = stop
         options = {"stop": stop}
         (
             existing_prompts,
             llm_string,
             missing_prompt_idxs,
             missing_prompts,
-        ) = get_prompts(params, prompts)
-        disregard_cache = self.cache is not None and not self.cache
+        ) = get_prompts(params, prompts, self.cache)
         new_arg_supported = inspect.signature(self._generate).parameters.get(
             "run_manager"
         )
-        if get_llm_cache() is None or disregard_cache:
-            if self.cache is not None and self.cache:
-                raise ValueError(
-                    "Asked to cache, but no cache found at `langchain.cache`."
-                )
+        if (self.cache is None and get_llm_cache() is None) or self.cache is False:
             run_managers = [
                 callback_manager.on_llm_start(
                     dumpd(self),
                     [prompt],
                     invocation_params=params,
                     options=options,
                     name=run_name,
                     batch_size=len(prompts),
+                    run_id=run_id_,
                 )[0]
-                for callback_manager, prompt, run_name in zip(
-                    callback_managers, prompts, run_name_list
+                for callback_manager, prompt, run_name, run_id_ in zip(
+                    callback_managers, prompts, run_name_list, run_ids_list
                 )
             ]
             output = self._generate_helper(
                 prompts, stop, run_managers, bool(new_arg_supported), **kwargs
             )
             return output
         if len(missing_prompts) > 0:
@@ -711,27 +816,47 @@
                 )[0]
                 for idx in missing_prompt_idxs
             ]
             new_results = self._generate_helper(
                 missing_prompts, stop, run_managers, bool(new_arg_supported), **kwargs
             )
             llm_output = update_cache(
-                existing_prompts, llm_string, missing_prompt_idxs, new_results, prompts
+                self.cache,
+                existing_prompts,
+                llm_string,
+                missing_prompt_idxs,
+                new_results,
+                prompts,
             )
             run_info = (
                 [RunInfo(run_id=run_manager.run_id) for run_manager in run_managers]
                 if run_managers
                 else None
             )
         else:
             llm_output = {}
             run_info = None
         generations = [existing_prompts[i] for i in range(len(prompts))]
         return LLMResult(generations=generations, llm_output=llm_output, run=run_info)
 
+    @staticmethod
+    def _get_run_ids_list(
+        run_id: Optional[Union[uuid.UUID, List[Optional[uuid.UUID]]]], prompts: list
+    ) -> list:
+        if run_id is None:
+            return [None] * len(prompts)
+        if isinstance(run_id, list):
+            if len(run_id) != len(prompts):
+                raise ValueError(
+                    "Number of manually provided run_id's does not match batch length."
+                    f" {len(run_id)} != {len(prompts)}"
+                )
+            return run_id
+        return [run_id] + [None] * (len(prompts) - 1)
+
     async def _agenerate_helper(
         self,
         prompts: List[str],
         stop: Optional[List[str]],
         run_managers: List[AsyncCallbackManagerForLLMRun],
         new_arg_supported: bool,
         **kwargs: Any,
@@ -775,14 +900,15 @@
         prompts: List[str],
         stop: Optional[List[str]] = None,
         callbacks: Optional[Union[Callbacks, List[Callbacks]]] = None,
         *,
         tags: Optional[Union[List[str], List[List[str]]]] = None,
         metadata: Optional[Union[Dict[str, Any], List[Dict[str, Any]]]] = None,
         run_name: Optional[Union[str, List[str]]] = None,
+        run_id: Optional[Union[uuid.UUID, List[Optional[uuid.UUID]]]] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Asynchronously pass a sequence of prompts to a model and return generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -851,51 +977,54 @@
                     cast(List[str], tags),
                     self.tags,
                     cast(Dict[str, Any], metadata),
                     self.metadata,
                 )
             ] * len(prompts)
             run_name_list = [cast(Optional[str], run_name)] * len(prompts)
-
+        run_ids_list = self._get_run_ids_list(run_id, prompts)
         params = self.dict()
         params["stop"] = stop
         options = {"stop": stop}
         (
             existing_prompts,
             llm_string,
             missing_prompt_idxs,
             missing_prompts,
-        ) = get_prompts(params, prompts)
-        disregard_cache = self.cache is not None and not self.cache
+        ) = await aget_prompts(params, prompts, self.cache)
+
+        # Verify whether the cache is set, and if the cache is set,
+        # verify whether the cache is available.
         new_arg_supported = inspect.signature(self._agenerate).parameters.get(
             "run_manager"
         )
-        if get_llm_cache() is None or disregard_cache:
-            if self.cache is not None and self.cache:
-                raise ValueError(
-                    "Asked to cache, but no cache found at `langchain.cache`."
-                )
+        if (self.cache is None and get_llm_cache() is None) or self.cache is False:
             run_managers = await asyncio.gather(
                 *[
                     callback_manager.on_llm_start(
                         dumpd(self),
                         [prompt],
                         invocation_params=params,
                         options=options,
                         name=run_name,
                         batch_size=len(prompts),
+                        run_id=run_id_,
                     )
-                    for callback_manager, prompt, run_name in zip(
-                        callback_managers, prompts, run_name_list
+                    for callback_manager, prompt, run_name, run_id_ in zip(
+                        callback_managers, prompts, run_name_list, run_ids_list
                     )
                 ]
             )
-            run_managers = [r[0] for r in run_managers]
+            run_managers = [r[0] for r in run_managers]  # type: ignore[misc]
             output = await self._agenerate_helper(
-                prompts, stop, run_managers, bool(new_arg_supported), **kwargs
+                prompts,
+                stop,
+                run_managers,  # type: ignore[arg-type]
+                bool(new_arg_supported),
+                **kwargs,  # type: ignore[arg-type]
             )
             return output
         if len(missing_prompts) > 0:
             run_managers = await asyncio.gather(
                 *[
                     callback_managers[idx].on_llm_start(
                         dumpd(self),
@@ -904,33 +1033,42 @@
                         options=options,
                         name=run_name_list[idx],
                         batch_size=len(missing_prompts),
                     )
                     for idx in missing_prompt_idxs
                 ]
             )
-            run_managers = [r[0] for r in run_managers]
+            run_managers = [r[0] for r in run_managers]  # type: ignore[misc]
             new_results = await self._agenerate_helper(
-                missing_prompts, stop, run_managers, bool(new_arg_supported), **kwargs
-            )
-            llm_output = update_cache(
-                existing_prompts, llm_string, missing_prompt_idxs, new_results, prompts
+                missing_prompts,
+                stop,
+                run_managers,  # type: ignore[arg-type]
+                bool(new_arg_supported),
+                **kwargs,  # type: ignore[arg-type]
+            )
+            llm_output = await aupdate_cache(
+                self.cache,
+                existing_prompts,
+                llm_string,
+                missing_prompt_idxs,
+                new_results,
+                prompts,
             )
             run_info = (
-                [RunInfo(run_id=run_manager.run_id) for run_manager in run_managers]
+                [RunInfo(run_id=run_manager.run_id) for run_manager in run_managers]  # type: ignore[attr-defined]
                 if run_managers
                 else None
             )
         else:
             llm_output = {}
             run_info = None
         generations = [existing_prompts[i] for i in range(len(prompts))]
         return LLMResult(generations=generations, llm_output=llm_output, run=run_info)
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def __call__(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
@@ -974,25 +1112,25 @@
             callbacks=callbacks,
             tags=tags,
             metadata=metadata,
             **kwargs,
         )
         return result.generations[0][0].text
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return self(text, stop=_stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
@@ -1000,25 +1138,25 @@
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         content = self(text, stop=_stop, **kwargs)
         return AIMessage(content=content)
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return await self._call_async(text, stop=_stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
@@ -1026,19 +1164,14 @@
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         content = await self._call_async(text, stop=_stop, **kwargs)
         return AIMessage(content=content)
 
-    @property
-    def _identifying_params(self) -> Mapping[str, Any]:
-        """Get the identifying parameters."""
-        return {}
-
     def __str__(self) -> str:
         """Get a string representation of the object for printing."""
         cls_name = f"\033[1m{self.__class__.__name__}\033[0m"
         return f"{cls_name}\nParams: {self._identifying_params}"
 
     @property
     @abstractmethod
@@ -1073,46 +1206,96 @@
 
         # Fetch dictionary to save
         prompt_dict = self.dict()
 
         if save_path.suffix == ".json":
             with open(file_path, "w") as f:
                 json.dump(prompt_dict, f, indent=4)
-        elif save_path.suffix == ".yaml":
+        elif save_path.suffix.endswith((".yaml", ".yml")):
             with open(file_path, "w") as f:
                 yaml.dump(prompt_dict, f, default_flow_style=False)
         else:
             raise ValueError(f"{save_path} must be json or yaml")
 
 
 class LLM(BaseLLM):
-    """Base LLM abstract class.
+    """Simple interface for implementing a custom LLM.
+
+    You should subclass this class and implement the following:
 
-    The purpose of this class is to expose a simpler interface for working
-    with LLMs, rather than expect the user to implement the full _generate method.
+    - `_call` method: Run the LLM on the given prompt and input (used by `invoke`).
+    - `_identifying_params` property: Return a dictionary of the identifying parameters
+        This is critical for caching and tracing purposes. Identifying parameters
+        is a dict that identifies the LLM.
+        It should mostly include a `model_name`.
+
+    Optional: Override the following methods to provide more optimizations:
+
+    - `_acall`: Provide a native async version of the `_call` method.
+        If not provided, will delegate to the synchronous version using
+        `run_in_executor`. (Used by `ainvoke`).
+    - `_stream`: Stream the LLM on the given prompt and input.
+        `stream` will use `_stream` if provided, otherwise it
+        use `_call` and output will arrive in one chunk.
+    - `_astream`: Override to provide a native async version of the `_stream` method.
+        `astream` will use `_astream` if provided, otherwise it will implement
+        a fallback behavior that will use `_stream` if `_stream` is implemented,
+        and use `_acall` if `_stream` is not implemented.
     """
 
     @abstractmethod
     def _call(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> str:
-        """Run the LLM on the given prompt and input."""
+        """Run the LLM on the given input.
+
+        Override this method to implement the LLM logic.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of the stop substrings.
+                If stop tokens are not supported consider raising NotImplementedError.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            The model output as a string. SHOULD NOT include the prompt.
+        """
 
     async def _acall(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> str:
-        """Run the LLM on the given prompt and input."""
+        """Async version of the _call method.
+
+        The default implementation delegates to the synchronous _call method using
+        `run_in_executor`. Subclasses that need to provide a true async implementation
+        should override this method to reduce the overhead of using `run_in_executor`.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of the stop substrings.
+                If stop tokens are not supported consider raising NotImplementedError.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            The model output as a string. SHOULD NOT include the prompt.
+        """
         return await run_in_executor(
             None,
             self._call,
             prompt,
             stop,
             run_manager.get_sync() if run_manager else None,
             **kwargs,
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/load/dump.py` & `gigachain_core-0.2.0/langchain_core/load/dump.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/load/load.py` & `gigachain_core-0.2.0/langchain_core/load/load.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,32 +1,46 @@
 import importlib
 import json
 import os
 from typing import Any, Dict, List, Optional
 
 from langchain_core._api import beta
 from langchain_core.load.mapping import (
-    OLD_PROMPT_TEMPLATE_FORMATS,
+    _JS_SERIALIZABLE_MAPPING,
+    _OG_SERIALIZABLE_MAPPING,
+    OLD_CORE_NAMESPACES_MAPPING,
     SERIALIZABLE_MAPPING,
 )
 from langchain_core.load.serializable import Serializable
 
-DEFAULT_NAMESPACES = ["langchain", "langchain_core", "langchain_community"]
-
-ALL_SERIALIZABLE_MAPPINGS = {**SERIALIZABLE_MAPPING, **OLD_PROMPT_TEMPLATE_FORMATS}
+DEFAULT_NAMESPACES = [
+    "langchain",
+    "langchain_core",
+    "langchain_community",
+    "langchain_anthropic",
+]
+
+ALL_SERIALIZABLE_MAPPINGS = {
+    **SERIALIZABLE_MAPPING,
+    **OLD_CORE_NAMESPACES_MAPPING,
+    **_OG_SERIALIZABLE_MAPPING,
+    **_JS_SERIALIZABLE_MAPPING,
+}
 
 
 class Reviver:
     """Reviver for JSON objects."""
 
     def __init__(
         self,
         secrets_map: Optional[Dict[str, str]] = None,
         valid_namespaces: Optional[List[str]] = None,
+        secrets_from_env: bool = True,
     ) -> None:
+        self.secrets_from_env = secrets_from_env
         self.secrets_map = secrets_map or dict()
         # By default only support langchain, but user can pass in additional namespaces
         self.valid_namespaces = (
             [*DEFAULT_NAMESPACES, *valid_namespaces]
             if valid_namespaces
             else DEFAULT_NAMESPACES
         )
@@ -37,15 +51,15 @@
             and value.get("type", None) == "secret"
             and value.get("id", None) is not None
         ):
             [key] = value["id"]
             if key in self.secrets_map:
                 return self.secrets_map[key]
             else:
-                if key in os.environ and os.environ[key]:
+                if self.secrets_from_env and key in os.environ and os.environ[key]:
                     return os.environ[key]
                 raise KeyError(f'Missing key "{key}" in load(secrets_map)')
 
         if (
             value.get("lc", None) == 1
             and value.get("type", None) == "not_implemented"
             and value.get("id", None) is not None
@@ -105,50 +119,54 @@
 
 @beta()
 def loads(
     text: str,
     *,
     secrets_map: Optional[Dict[str, str]] = None,
     valid_namespaces: Optional[List[str]] = None,
+    secrets_from_env: bool = True,
 ) -> Any:
     """Revive a LangChain class from a JSON string.
     Equivalent to `load(json.loads(text))`.
 
     Args:
         text: The string to load.
         secrets_map: A map of secrets to load.
         valid_namespaces: A list of additional namespaces (modules)
             to allow to be deserialized.
 
     Returns:
         Revived LangChain objects.
     """
-    return json.loads(text, object_hook=Reviver(secrets_map, valid_namespaces))
+    return json.loads(
+        text, object_hook=Reviver(secrets_map, valid_namespaces, secrets_from_env)
+    )
 
 
 @beta()
 def load(
     obj: Any,
     *,
     secrets_map: Optional[Dict[str, str]] = None,
     valid_namespaces: Optional[List[str]] = None,
+    secrets_from_env: bool = True,
 ) -> Any:
     """Revive a LangChain class from a JSON object. Use this if you already
     have a parsed JSON object, eg. from `json.load` or `orjson.loads`.
 
     Args:
         obj: The object to load.
         secrets_map: A map of secrets to load.
         valid_namespaces: A list of additional namespaces (modules)
             to allow to be deserialized.
 
     Returns:
         Revived LangChain objects.
     """
-    reviver = Reviver(secrets_map, valid_namespaces)
+    reviver = Reviver(secrets_map, valid_namespaces, secrets_from_env)
 
     def _load(obj: Any) -> Any:
         if isinstance(obj, dict):
             # Need to revive leaf nodes before reviving this node
             loaded_obj = {k: _load(v) for k, v in obj.items()}
             return reviver(loaded_obj)
         if isinstance(obj, list):
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/load/serializable.py` & `gigachain_core-0.2.0/langchain_core/load/serializable.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,18 +1,31 @@
 from abc import ABC
-from typing import Any, Dict, List, Literal, Optional, TypedDict, Union, cast
+from typing import (
+    Any,
+    Dict,
+    List,
+    Literal,
+    Optional,
+    TypedDict,
+    Union,
+    cast,
+)
 
-from langchain_core.pydantic_v1 import BaseModel, PrivateAttr
+from typing_extensions import NotRequired
+
+from langchain_core.pydantic_v1 import BaseModel
 
 
 class BaseSerialized(TypedDict):
     """Base class for serialized objects."""
 
     lc: int
     id: List[str]
+    name: NotRequired[str]
+    graph: NotRequired[Dict[str, Any]]
 
 
 class SerializedConstructor(BaseSerialized):
     """Serialized constructor."""
 
     type: Literal["constructor"]
     kwargs: Dict[str, Any]
@@ -97,30 +110,25 @@
     def __repr_args__(self) -> Any:
         return [
             (k, v)
             for k, v in super().__repr_args__()
             if (k not in self.__fields__ or try_neq_default(v, k, self))
         ]
 
-    _lc_kwargs = PrivateAttr(default_factory=dict)
-
-    def __init__(self, **kwargs: Any) -> None:
-        super().__init__(**kwargs)
-        self._lc_kwargs = kwargs
-
     def to_json(self) -> Union[SerializedConstructor, SerializedNotImplemented]:
         if not self.is_lc_serializable():
             return self.to_json_not_implemented()
 
         secrets = dict()
         # Get latest values for kwargs if there is an attribute with same name
         lc_kwargs = {
             k: getattr(self, k, v)
-            for k, v in self._lc_kwargs.items()
+            for k, v in self
             if not (self.__exclude_fields__ or {}).get(k, False)  # type: ignore
+            and _is_field_useful(self, k, v)
         }
 
         # Merge the lc_secrets and lc_attributes from every class in the MRO
         for cls in [None, *self.__class__.mro()]:
             # Once we get to Serializable, we're done
             if cls is Serializable:
                 break
@@ -139,14 +147,22 @@
                             f"classmethod instead."
                         )
 
             # Get a reference to self bound to each class in the MRO
             this = cast(Serializable, self if cls is None else super(cls, self))
 
             secrets.update(this.lc_secrets)
+            # Now also add the aliases for the secrets
+            # This ensures known secret aliases are hidden.
+            # Note: this does NOT hide any other extra kwargs
+            # that are not present in the fields.
+            for key in list(secrets):
+                value = secrets[key]
+                if key in this.__fields__:
+                    secrets[this.__fields__[key].alias] = value
             lc_kwargs.update(this.lc_attributes)
 
         # include all secrets, even if not specified in kwargs
         # as these secrets may be passed as an environment variable instead
         for key in secrets.keys():
             secret_value = getattr(self, key, None) or lc_kwargs.get(key)
             if secret_value is not None:
@@ -161,14 +177,31 @@
             else _replace_secrets(lc_kwargs, secrets),
         }
 
     def to_json_not_implemented(self) -> SerializedNotImplemented:
         return to_json_not_implemented(self)
 
 
+def _is_field_useful(inst: Serializable, key: str, value: Any) -> bool:
+    """Check if a field is useful as a constructor argument.
+
+    Args:
+        inst: The instance.
+        key: The key.
+        value: The value.
+
+    Returns:
+        Whether the field is useful.
+    """
+    field = inst.__fields__.get(key)
+    if not field:
+        return False
+    return field.required is True or value or field.get_default() != value
+
+
 def _replace_secrets(
     root: Dict[Any, Any], secrets_map: Dict[str, str]
 ) -> Dict[Any, Any]:
     result = root.copy()
     for path, secret_id in secrets_map.items():
         [*parts, last] = path.split(".")
         current = result
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/memory.py` & `gigachain_core-0.2.0/langchain_core/memory.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,13 +1,24 @@
+"""**Memory** maintains Chain state, incorporating context from past runs.
+
+**Class hierarchy for Memory:**
+
+.. code-block::
+
+    BaseMemory --> <name>Memory --> <name>Memory  # Examples: BaseChatMemory -> MotorheadMemory
+
+"""  # noqa: E501
+
 from __future__ import annotations
 
 from abc import ABC, abstractmethod
 from typing import Any, Dict, List
 
 from langchain_core.load.serializable import Serializable
+from langchain_core.runnables import run_in_executor
 
 
 class BaseMemory(Serializable, ABC):
     """Abstract base class for memory in Chains.
 
     Memory refers to state in Chains. Memory can be used to store information about
         past executions of a Chain and inject that information into the inputs of
@@ -46,14 +57,28 @@
     def memory_variables(self) -> List[str]:
         """The string keys this memory class will add to chain inputs."""
 
     @abstractmethod
     def load_memory_variables(self, inputs: Dict[str, Any]) -> Dict[str, Any]:
         """Return key-value pairs given the text input to the chain."""
 
+    async def aload_memory_variables(self, inputs: Dict[str, Any]) -> Dict[str, Any]:
+        """Return key-value pairs given the text input to the chain."""
+        return await run_in_executor(None, self.load_memory_variables, inputs)
+
     @abstractmethod
     def save_context(self, inputs: Dict[str, Any], outputs: Dict[str, str]) -> None:
         """Save the context of this chain run to memory."""
 
+    async def asave_context(
+        self, inputs: Dict[str, Any], outputs: Dict[str, str]
+    ) -> None:
+        """Save the context of this chain run to memory."""
+        await run_in_executor(None, self.save_context, inputs, outputs)
+
     @abstractmethod
     def clear(self) -> None:
         """Clear memory contents."""
+
+    async def aclear(self) -> None:
+        """Clear memory contents."""
+        await run_in_executor(None, self.clear)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/messages/ai.py` & `gigachain_core-0.2.0/langchain_core/messages/function.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,57 +1,60 @@
 from typing import Any, List, Literal
 
 from langchain_core.messages.base import (
     BaseMessage,
     BaseMessageChunk,
     merge_content,
 )
+from langchain_core.utils._merge import merge_dicts
 
 
-class AIMessage(BaseMessage):
-    """A Message from an AI."""
+class FunctionMessage(BaseMessage):
+    """Message for passing the result of executing a function back to a model."""
 
-    example: bool = False
-    """Whether this Message is being passed in to the model as part of an example 
-        conversation.
-    """
+    name: str
+    """The name of the function that was executed."""
 
-    type: Literal["ai"] = "ai"
+    type: Literal["function"] = "function"
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
 
-AIMessage.update_forward_refs()
+FunctionMessage.update_forward_refs()
 
 
-class AIMessageChunk(AIMessage, BaseMessageChunk):
-    """A Message chunk from an AI."""
+class FunctionMessageChunk(FunctionMessage, BaseMessageChunk):
+    """Function Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
-    type: Literal["AIMessageChunk"] = "AIMessageChunk"  # type: ignore[assignment] # noqa: E501
+    type: Literal["FunctionMessageChunk"] = "FunctionMessageChunk"  # type: ignore[assignment]
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
     def __add__(self, other: Any) -> BaseMessageChunk:  # type: ignore
-        if isinstance(other, AIMessageChunk):
-            if self.example != other.example:
+        if isinstance(other, FunctionMessageChunk):
+            if self.name != other.name:
                 raise ValueError(
-                    "Cannot concatenate AIMessageChunks with different example values."
+                    "Cannot concatenate FunctionMessageChunks with different names."
                 )
 
             return self.__class__(
-                example=self.example,
+                name=self.name,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
+                id=self.id,
             )
 
         return super().__add__(other)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/messages/base.py` & `gigachain_core-0.2.0/langchain_core/messages/base.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,51 +1,81 @@
 from __future__ import annotations
 
-from typing import TYPE_CHECKING, Any, Dict, List, Sequence, Union
+from typing import TYPE_CHECKING, Any, Dict, List, Optional, Sequence, Union
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.pydantic_v1 import Extra, Field
+from langchain_core.utils import get_bolded_text
+from langchain_core.utils._merge import merge_dicts
+from langchain_core.utils.interactive_env import is_interactive_env
 
 if TYPE_CHECKING:
     from langchain_core.prompts.chat import ChatPromptTemplate
 
 
 class BaseMessage(Serializable):
-    """The base abstract Message class.
+    """Base abstract Message class.
 
     Messages are the inputs and outputs of ChatModels.
     """
 
     content: Union[str, List[Union[str, Dict]]]
     """The string contents of the message."""
 
     additional_kwargs: dict = Field(default_factory=dict)
-    """Any additional information."""
+    """Reserved for additional payload data associated with the message.
+    
+    For example, for a message from an AI, this could include tool calls."""
+
+    response_metadata: dict = Field(default_factory=dict)
+    """Response metadata. For example: response headers, logprobs, token counts."""
 
     type: str
 
+    name: Optional[str] = None
+
+    id: Optional[str] = None
+    """An optional unique identifier for the message. This should ideally be
+    provided by the provider/model which created the message."""
+
     class Config:
         extra = Extra.allow
 
+    def __init__(
+        self, content: Union[str, List[Union[str, Dict]]], **kwargs: Any
+    ) -> None:
+        """Pass in content as positional arg."""
+        return super().__init__(content=content, **kwargs)
+
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """Return whether this class is serializable."""
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
     def __add__(self, other: Any) -> ChatPromptTemplate:
         from langchain_core.prompts.chat import ChatPromptTemplate
 
-        prompt = ChatPromptTemplate(messages=[self])
+        prompt = ChatPromptTemplate(messages=[self])  # type: ignore[call-arg]
         return prompt + other
 
+    def pretty_repr(self, html: bool = False) -> str:
+        title = get_msg_title_repr(self.type.title() + " Message", bold=html)
+        # TODO: handle non-string content.
+        if self.name is not None:
+            title += f"\nName: {self.name}"
+        return f"{title}\n\n{self.content}"
+
+    def pretty_print(self) -> None:
+        print(self.pretty_repr(html=is_interactive_env()))  # noqa: T201
+
 
 def merge_content(
     first_content: Union[str, List[Union[str, Dict]]],
     second_content: Union[str, List[Union[str, Dict]]],
 ) -> Union[str, List[Union[str, Dict]]]:
     """Merge two message contents.
 
@@ -76,79 +106,35 @@
             return first_content[:-1] + [first_content[-1] + second_content]
         else:
             # Otherwise, add the second content as a new element of the list
             return first_content + [second_content]
 
 
 class BaseMessageChunk(BaseMessage):
-    """A Message chunk, which can be concatenated with other Message chunks."""
+    """Message chunk, which can be concatenated with other Message chunks."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
-    def _merge_kwargs_dict(
-        self, left: Dict[str, Any], right: Dict[str, Any]
-    ) -> Dict[str, Any]:
-        """Merge additional_kwargs from another BaseMessageChunk into this one,
-        handling specific scenarios where a key exists in both dictionaries
-        but has a value of None in 'left'. In such cases, the method uses the
-        value from 'right' for that key in the merged dictionary.
-        Example:
-        If left = {"function_call": {"arguments": None}} and
-        right = {"function_call": {"arguments": "{\n"}}
-        then, after merging, for the key "function_call",
-        the value from 'right' is used,
-        resulting in merged = {"function_call": {"arguments": "{\n"}}.
-        """
-        merged = left.copy()
-        for k, v in right.items():
-            if k not in merged:
-                merged[k] = v
-            elif merged[k] is None and v:
-                merged[k] = v
-            elif v is None:
-                continue
-            elif merged[k] == v:
-                continue
-            elif type(merged[k]) != type(v):
-                raise TypeError(
-                    f'additional_kwargs["{k}"] already exists in this message,'
-                    " but with a different type."
-                )
-            elif isinstance(merged[k], str):
-                merged[k] += v
-            elif isinstance(merged[k], dict):
-                merged[k] = self._merge_kwargs_dict(merged[k], v)
-            elif isinstance(merged[k], list):
-                merged[k] = merged[k].copy()
-                for i, e in enumerate(v):
-                    if isinstance(e, dict) and isinstance(e.get("index"), int):
-                        i = e["index"]
-                    if i < len(merged[k]):
-                        merged[k][i] = self._merge_kwargs_dict(merged[k][i], e)
-                    else:
-                        merged[k] = merged[k] + [e]
-            else:
-                raise TypeError(
-                    f"Additional kwargs key {k} already exists in this message."
-                )
-        return merged
-
     def __add__(self, other: Any) -> BaseMessageChunk:  # type: ignore
         if isinstance(other, BaseMessageChunk):
             # If both are (subclasses of) BaseMessageChunk,
             # concat into a single BaseMessageChunk
 
-            return self.__class__(
+            return self.__class__(  # type: ignore[call-arg]
+                id=self.id,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
             )
         else:
             raise TypeError(
                 'unsupported operand type(s) for +: "'
                 f"{self.__class__.__name__}"
                 f'" and "{other.__class__.__name__}"'
             )
@@ -172,7 +158,26 @@
     Args:
         messages: Sequence of messages (as BaseMessages) to convert.
 
     Returns:
         List of messages as dicts.
     """
     return [message_to_dict(m) for m in messages]
+
+
+def get_msg_title_repr(title: str, *, bold: bool = False) -> str:
+    """Get a title representation for a message.
+
+    Args:
+        title: The title.
+        bold: Whether to bold the title.
+
+    Returns:
+        The title representation.
+    """
+    padded = " " + title + " "
+    sep_len = (80 - len(padded)) // 2
+    sep = "=" * sep_len
+    second_sep = sep + "=" if len(padded) % 2 else sep
+    if bold:
+        padded = get_bolded_text(padded)
+    return f"{sep}{padded}{second_sep}"
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/messages/chat.py` & `gigachain_core-0.2.0/langchain_core/messages/chat.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,18 +1,19 @@
 from typing import Any, List, Literal
 
 from langchain_core.messages.base import (
     BaseMessage,
     BaseMessageChunk,
     merge_content,
 )
+from langchain_core.utils._merge import merge_dicts
 
 
 class ChatMessage(BaseMessage):
-    """A Message that can be assigned an arbitrary speaker (i.e. role)."""
+    """Message that can be assigned an arbitrary speaker (i.e. role)."""
 
     role: str
     """The speaker / role of the Message."""
 
     type: Literal["chat"] = "chat"
 
     @classmethod
@@ -21,15 +22,15 @@
         return ["langchain", "schema", "messages"]
 
 
 ChatMessage.update_forward_refs()
 
 
 class ChatMessageChunk(ChatMessage, BaseMessageChunk):
-    """A Chat Message chunk."""
+    """Chat Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
     type: Literal["ChatMessageChunk"] = "ChatMessageChunk"  # type: ignore
 
     @classmethod
@@ -43,21 +44,29 @@
                 raise ValueError(
                     "Cannot concatenate ChatMessageChunks with different roles."
                 )
 
             return self.__class__(
                 role=self.role,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
+                id=self.id,
             )
         elif isinstance(other, BaseMessageChunk):
             return self.__class__(
                 role=self.role,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
+                id=self.id,
             )
         else:
             return super().__add__(other)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/messages/human.py` & `gigachain_core-0.2.0/langchain_core/messages/human.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from typing import List, Literal
 
 from langchain_core.messages.base import BaseMessage, BaseMessageChunk
 
 
 class HumanMessage(BaseMessage):
-    """A Message from a human."""
+    """Message from a human."""
 
     example: bool = False
     """Whether this Message is being passed in to the model as part of an example 
         conversation.
     """
 
     type: Literal["human"] = "human"
@@ -19,15 +19,15 @@
         return ["langchain", "schema", "messages"]
 
 
 HumanMessage.update_forward_refs()
 
 
 class HumanMessageChunk(HumanMessage, BaseMessageChunk):
-    """A Human Message chunk."""
+    """Human Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
     type: Literal["HumanMessageChunk"] = "HumanMessageChunk"  # type: ignore[assignment] # noqa: E501
 
     @classmethod
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/messages/system.py` & `gigachain_core-0.2.0/langchain_core/messages/system.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from typing import List, Literal
 
 from langchain_core.messages.base import BaseMessage, BaseMessageChunk
 
 
 class SystemMessage(BaseMessage):
-    """A Message for priming AI behavior, usually passed in as the first of a sequence
+    """Message for priming AI behavior, usually passed in as the first of a sequence
     of input messages.
     """
 
     type: Literal["system"] = "system"
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
@@ -16,15 +16,15 @@
         return ["langchain", "schema", "messages"]
 
 
 SystemMessage.update_forward_refs()
 
 
 class SystemMessageChunk(SystemMessage, BaseMessageChunk):
-    """A System Message chunk."""
+    """System Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
     type: Literal["SystemMessageChunk"] = "SystemMessageChunk"  # type: ignore[assignment] # noqa: E501
 
     @classmethod
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/output_parsers/base.py` & `gigachain_core-0.2.0/langchain_core/output_parsers/base.py`

 * *Files 3% similar despite different names*

```diff
@@ -11,23 +11,25 @@
     Type,
     TypeVar,
     Union,
 )
 
 from typing_extensions import get_args
 
+from langchain_core.language_models import LanguageModelOutput
 from langchain_core.messages import AnyMessage, BaseMessage
 from langchain_core.outputs import ChatGeneration, Generation
-from langchain_core.runnables import RunnableConfig, RunnableSerializable
+from langchain_core.runnables import Runnable, RunnableConfig, RunnableSerializable
 from langchain_core.runnables.config import run_in_executor
 
 if TYPE_CHECKING:
     from langchain_core.prompt_values import PromptValue
 
 T = TypeVar("T")
+OutputParserLike = Runnable[LanguageModelOutput, T]
 
 
 class BaseLLMOutputParser(Generic[T], ABC):
     """Abstract base class for parsing the outputs of a model."""
 
     @abstractmethod
     def parse_result(self, result: List[Generation], *, partial: bool = False) -> T:
@@ -53,15 +55,15 @@
         Returns:
             Structured output.
         """
         return await run_in_executor(None, self.parse_result, result)
 
 
 class BaseGenerationOutputParser(
-    BaseLLMOutputParser, RunnableSerializable[Union[str, BaseMessage], T]
+    BaseLLMOutputParser, RunnableSerializable[LanguageModelOutput, T]
 ):
     """Base class to parse the output of an LLM call."""
 
     @property
     def InputType(self) -> Any:
         return Union[str, AnyMessage]
 
@@ -112,15 +114,15 @@
                 input,
                 config,
                 run_type="parser",
             )
 
 
 class BaseOutputParser(
-    BaseLLMOutputParser, RunnableSerializable[Union[str, BaseMessage], T]
+    BaseLLMOutputParser, RunnableSerializable[LanguageModelOutput, T]
 ):
     """Base class to parse the output of an LLM call.
 
     Output parsers help structure language model responses.
 
     Example:
         .. code-block:: python
@@ -135,17 +137,17 @@
                         raise OutputParserException(
                             f"BooleanOutputParser expected output value to either be "
                             f"{self.true_val} or {self.false_val} (case-insensitive). "
                             f"Received {cleaned_text}."
                         )
                     return cleaned_text == self.true_val.upper()
 
-                    @property
-                    def _type(self) -> str:
-                            return "boolean_output_parser"
+                @property
+                def _type(self) -> str:
+                    return "boolean_output_parser"
     """  # noqa: E501
 
     @property
     def InputType(self) -> Any:
         return Union[str, AnyMessage]
 
     @property
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/output_parsers/format_instructions.py` & `gigachain_core-0.2.0/langchain_core/output_parsers/format_instructions.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/output_parsers/json.py` & `gigachain_core-0.2.0/langchain_core/utils/json.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,21 +1,14 @@
 from __future__ import annotations
 
 import json
 import re
-from json import JSONDecodeError
-from typing import Any, Callable, List, Optional, Type
-
-import jsonpatch  # type: ignore[import]
+from typing import Any, Callable, List
 
 from langchain_core.exceptions import OutputParserException
-from langchain_core.output_parsers.format_instructions import JSON_FORMAT_INSTRUCTIONS
-from langchain_core.output_parsers.transform import BaseCumulativeTransformOutputParser
-from langchain_core.outputs import Generation
-from langchain_core.pydantic_v1 import BaseModel
 
 
 def _replace_new_line(match: re.Match[str]) -> str:
     value = match.group(2)
     value = re.sub(r"\n", r"\\n", value)
     value = re.sub(r"\r", r"\\r", value)
     value = re.sub(r"\t", r"\\t", value)
@@ -31,25 +24,27 @@
     replaces those characters with their escaped counterparts.
     (newlines in JSON must be double-escaped: `\\n`)
     """
     if isinstance(multiline_string, (bytes, bytearray)):
         multiline_string = multiline_string.decode()
 
     multiline_string = re.sub(
-        r'("action_input"\:\s*")(.*)(")',
+        r'("action_input"\:\s*")(.*?)(")',
         _replace_new_line,
         multiline_string,
         flags=re.DOTALL,
     )
 
     return multiline_string
 
 
-# Adapted from https://github.com/KillianLucas/open-interpreter/blob/main/interpreter/utils/parse_partial_json.py
+# Adapted from https://github.com/KillianLucas/open-interpreter/blob/5b6080fae1f8c68938a1e4fa8667e3744084ee21/interpreter/utils/parse_partial_json.py
 # MIT License
+
+
 def parse_partial_json(s: str, *, strict: bool = False) -> Any:
     """Parse a JSON string that may be missing closing braces.
 
     Args:
         s: The JSON string to parse.
         strict: Whether to use strict parsing. Defaults to False.
 
@@ -133,34 +128,40 @@
 
     Args:
         json_string: The Markdown string.
 
     Returns:
         The parsed JSON object as a Python dictionary.
     """
-    # Try to find JSON string within triple backticks
-    match = re.search(r"```(json)?(.*)```", json_string, re.DOTALL)
+    try:
+        return _parse_json(json_string, parser=parser)
+    except json.JSONDecodeError:
+        # Try to find JSON string within triple backticks
+        match = re.search(r"```(json)?(.*)", json_string, re.DOTALL)
 
-    # If no match found, assume the entire string is a JSON string
-    if match is None:
-        json_str = json_string
-    else:
-        # If match found, use the content within the backticks
-        json_str = match.group(2)
+        # If no match found, assume the entire string is a JSON string
+        if match is None:
+            json_str = json_string
+        else:
+            # If match found, use the content within the backticks
+            json_str = match.group(2)
+    return _parse_json(json_str, parser=parser)
 
+
+def _parse_json(
+    json_str: str, *, parser: Callable[[str], Any] = parse_partial_json
+) -> dict:
     # Strip whitespace and newlines from the start and end
-    json_str = json_str.strip()
+    json_str = json_str.strip().strip("`")
 
     # handle newlines and other special characters inside the returned value
     json_str = _custom_parser(json_str)
 
     # Parse the JSON string into a Python dictionary
-    parsed = parser(json_str)
-
-    return parsed
+    return parser(json_str)
 
 
 def parse_and_check_json_markdown(text: str, expected_keys: List[str]) -> dict:
     """
     Parse a JSON string from a Markdown string and check that it
     contains the expected keys.
 
@@ -178,64 +179,7 @@
     for key in expected_keys:
         if key not in json_obj:
             raise OutputParserException(
                 f"Got invalid return object. Expected key `{key}` "
                 f"to be present, but got {json_obj}"
             )
     return json_obj
-
-
-class JsonOutputParser(BaseCumulativeTransformOutputParser[Any]):
-    """Parse the output of an LLM call to a JSON object.
-
-    When used in streaming mode, it will yield partial JSON objects containing
-    all the keys that have been returned so far.
-
-    In streaming, if `diff` is set to `True`, yields JSONPatch operations
-    describing the difference between the previous and the current object.
-    """
-
-    pydantic_object: Optional[Type[BaseModel]] = None
-
-    def _diff(self, prev: Optional[Any], next: Any) -> Any:
-        return jsonpatch.make_patch(prev, next).patch
-
-    def parse_result(self, result: List[Generation], *, partial: bool = False) -> Any:
-        text = result[0].text
-        text = text.strip()
-        if partial:
-            try:
-                return parse_json_markdown(text)
-            except JSONDecodeError:
-                return None
-        else:
-            try:
-                return parse_json_markdown(text)
-            except JSONDecodeError as e:
-                raise OutputParserException(f"Invalid json output: {text}") from e
-
-    def parse(self, text: str) -> Any:
-        return self.parse_result([Generation(text=text)])
-
-    def get_format_instructions(self) -> str:
-        if self.pydantic_object is None:
-            return "Return a JSON object."
-        else:
-            schema = self.pydantic_object.schema()
-
-            # Remove extraneous fields.
-            reduced_schema = schema
-            if "title" in reduced_schema:
-                del reduced_schema["title"]
-            if "type" in reduced_schema:
-                del reduced_schema["type"]
-            # Ensure json in context is well-formed with double quotes.
-            schema_str = json.dumps(reduced_schema)
-            return JSON_FORMAT_INSTRUCTIONS.format(schema=schema_str)
-
-    @property
-    def _type(self) -> str:
-        return "simple_json_output_parser"
-
-
-# For backwards compatibility
-SimpleJsonOutputParser = JsonOutputParser
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/output_parsers/list.py` & `gigachain_core-0.2.0/langchain_core/output_parsers/list.py`

 * *Files 2% similar despite different names*

```diff
@@ -111,20 +111,20 @@
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "output_parsers", "list"]
 
     def get_format_instructions(self) -> str:
         return (
             "Your response should be a list of comma separated values, "
-            "eg: `foo, bar, baz`"
+            "eg: `foo, bar, baz` or `foo,bar,baz`"
         )
 
     def parse(self, text: str) -> List[str]:
         """Parse the output of an LLM call."""
-        return text.strip().split(", ")
+        return [part.strip() for part in text.split(",")]
 
     @property
     def _type(self) -> str:
         return "comma-separated-list"
 
 
 class NumberedListOutputParser(ListOutputParser):
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/output_parsers/string.py` & `gigachain_core-0.2.0/langchain_core/output_parsers/string.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/output_parsers/transform.py` & `gigachain_core-0.2.0/langchain_core/output_parsers/transform.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/outputs/chat_generation.py` & `gigachain_core-0.2.0/langchain_core/outputs/chat_generation.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 from __future__ import annotations
 
 from typing import Any, Dict, List, Literal
 
 from langchain_core.messages import BaseMessage, BaseMessageChunk
 from langchain_core.outputs.generation import Generation
 from langchain_core.pydantic_v1 import root_validator
+from langchain_core.utils._merge import merge_dicts
 
 
 class ChatGeneration(Generation):
     """A single chat generation output."""
 
     text: str = ""
     """*SHOULD NOT BE SET DIRECTLY* The text contents of the output message."""
@@ -18,27 +19,44 @@
     type: Literal["ChatGeneration"] = "ChatGeneration"  # type: ignore[assignment]
     """Type is used exclusively for serialization purposes."""
 
     @root_validator
     def set_text(cls, values: Dict[str, Any]) -> Dict[str, Any]:
         """Set the text attribute to be the contents of the message."""
         try:
-            values["text"] = values["message"].content
+            text = ""
+            if isinstance(values["message"].content, str):
+                text = values["message"].content
+            # HACK: Assumes text in content blocks in OpenAI format.
+            # Uses first text block.
+            elif isinstance(values["message"].content, list):
+                for block in values["message"].content:
+                    if isinstance(block, str):
+                        text = block
+                        break
+                    elif isinstance(block, dict) and "text" in block:
+                        text = block["text"]
+                        break
+                    else:
+                        pass
+            else:
+                pass
+            values["text"] = text
         except (KeyError, AttributeError) as e:
             raise ValueError("Error while initializing ChatGeneration") from e
         return values
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
 
 class ChatGenerationChunk(ChatGeneration):
-    """A ChatGeneration chunk, which can be concatenated with other
+    """ChatGeneration chunk, which can be concatenated with other
       ChatGeneration chunks.
 
     Attributes:
         message: The message chunk output by the chat model.
     """
 
     message: BaseMessageChunk
@@ -49,20 +67,19 @@
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
     def __add__(self, other: ChatGenerationChunk) -> ChatGenerationChunk:
         if isinstance(other, ChatGenerationChunk):
-            generation_info = (
-                {**(self.generation_info or {}), **(other.generation_info or {})}
-                if self.generation_info is not None or other.generation_info is not None
-                else None
+            generation_info = merge_dicts(
+                self.generation_info or {},
+                other.generation_info or {},
             )
             return ChatGenerationChunk(
                 message=self.message + other.message,
-                generation_info=generation_info,
+                generation_info=generation_info or None,
             )
         else:
             raise TypeError(
                 f"unsupported operand type(s) for +: '{type(self)}' and '{type(other)}'"
             )
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/outputs/generation.py` & `gigachain_core-0.2.0/langchain_core/outputs/generation.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 
 from typing import Any, Dict, List, Literal, Optional
 
 from langchain_core.load import Serializable
+from langchain_core.utils._merge import merge_dicts
 
 
 class Generation(Serializable):
     """A single text generation output."""
 
     text: str
     """Generated text output."""
@@ -27,29 +28,28 @@
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
 
 class GenerationChunk(Generation):
-    """A Generation chunk, which can be concatenated with other Generation chunks."""
+    """Generation chunk, which can be concatenated with other Generation chunks."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
     def __add__(self, other: GenerationChunk) -> GenerationChunk:
         if isinstance(other, GenerationChunk):
-            generation_info = (
-                {**(self.generation_info or {}), **(other.generation_info or {})}
-                if self.generation_info is not None or other.generation_info is not None
-                else None
+            generation_info = merge_dicts(
+                self.generation_info or {},
+                other.generation_info or {},
             )
             return GenerationChunk(
                 text=self.text + other.text,
-                generation_info=generation_info,
+                generation_info=generation_info or None,
             )
         else:
             raise TypeError(
                 f"unsupported operand type(s) for +: '{type(self)}' and '{type(other)}'"
             )
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/outputs/llm_result.py` & `gigachain_core-0.2.0/langchain_core/outputs/llm_result.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompt_values.py` & `gigachain_core-0.2.0/langchain_core/prompt_values.py`

 * *Files 27% similar despite different names*

```diff
@@ -1,11 +1,19 @@
+"""**Prompt values** for language model prompts.
+
+Prompt values are used to represent different pieces of prompts.
+They can be used to represent text, images, or chat message pieces.
+"""
+
 from __future__ import annotations
 
 from abc import ABC, abstractmethod
-from typing import List, Literal, Sequence
+from typing import List, Literal, Sequence, cast
+
+from typing_extensions import TypedDict
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.messages import (
     AnyMessage,
     BaseMessage,
     HumanMessage,
     get_buffer_string,
@@ -78,14 +86,40 @@
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "prompts", "chat"]
 
 
+class ImageURL(TypedDict, total=False):
+    """Image URL."""
+
+    detail: Literal["auto", "low", "high"]
+    """Specifies the detail level of the image."""
+
+    url: str
+    """Either a URL of the image or the base64 encoded image data."""
+
+
+class ImagePromptValue(PromptValue):
+    """Image prompt value."""
+
+    image_url: ImageURL
+    """Prompt image."""
+    type: Literal["ImagePromptValue"] = "ImagePromptValue"
+
+    def to_string(self) -> str:
+        """Return prompt as string."""
+        return self.image_url["url"]
+
+    def to_messages(self) -> List[BaseMessage]:
+        """Return prompt as messages."""
+        return [HumanMessage(content=[cast(dict, self.image_url)])]
+
+
 class ChatPromptValueConcrete(ChatPromptValue):
     """Chat prompt value which explicitly lists out the message types it accepts.
     For use in external schemas."""
 
     messages: Sequence[AnyMessage]
 
     type: Literal["ChatPromptValueConcrete"] = "ChatPromptValueConcrete"
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/__init__.py` & `gigachain_core-0.2.0/langchain_core/prompts/__init__.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 """**Prompt** is the input to the model.
 
 Prompt is often constructed
-from multiple components. Prompt classes and functions make constructing
+from multiple components and prompt values. Prompt classes and functions make constructing
  and working with prompts easy.
 
 **Class hierarchy:**
 
 .. code-block::
 
     BasePromptTemplate --> PipelinePromptTemplate
@@ -20,15 +20,19 @@
     BaseMessagePromptTemplate --> MessagesPlaceholder
                                   BaseStringMessagePromptTemplate --> ChatMessagePromptTemplate
                                                                       HumanMessagePromptTemplate
                                                                       AIMessagePromptTemplate
                                                                       SystemMessagePromptTemplate
 
 """  # noqa: E501
-from langchain_core.prompts.base import BasePromptTemplate, format_document
+from langchain_core.prompts.base import (
+    BasePromptTemplate,
+    aformat_document,
+    format_document,
+)
 from langchain_core.prompts.chat import (
     AIMessagePromptTemplate,
     BaseChatPromptTemplate,
     ChatMessagePromptTemplate,
     ChatPromptTemplate,
     HumanMessagePromptTemplate,
     MessagesPlaceholder,
@@ -63,12 +67,13 @@
     "MessagesPlaceholder",
     "PipelinePromptTemplate",
     "PromptTemplate",
     "StringPromptTemplate",
     "SystemMessagePromptTemplate",
     "load_prompt",
     "format_document",
+    "aformat_document",
     "check_valid_template",
     "get_template_variables",
     "jinja2_formatter",
     "validate_jinja2",
 ]
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/base.py` & `gigachain_core-0.2.0/langchain_core/prompts/base.py`

 * *Files 17% similar despite different names*

```diff
@@ -4,49 +4,64 @@
 from abc import ABC, abstractmethod
 from pathlib import Path
 from typing import (
     TYPE_CHECKING,
     Any,
     Callable,
     Dict,
+    Generic,
     List,
     Mapping,
     Optional,
     Type,
+    TypeVar,
     Union,
 )
 
 import yaml
 
 from langchain_core.output_parsers.base import BaseOutputParser
 from langchain_core.prompt_values import (
     ChatPromptValueConcrete,
     PromptValue,
     StringPromptValue,
 )
-from langchain_core.pydantic_v1 import BaseModel, Field, create_model, root_validator
+from langchain_core.pydantic_v1 import BaseModel, Field, root_validator
 from langchain_core.runnables import RunnableConfig, RunnableSerializable
+from langchain_core.runnables.config import ensure_config
+from langchain_core.runnables.utils import create_model
 
 if TYPE_CHECKING:
     from langchain_core.documents import Document
 
 
-class BasePromptTemplate(RunnableSerializable[Dict, PromptValue], ABC):
+FormatOutputType = TypeVar("FormatOutputType")
+
+
+class BasePromptTemplate(
+    RunnableSerializable[Dict, PromptValue], Generic[FormatOutputType], ABC
+):
     """Base class for all prompt templates, returning a prompt."""
 
     input_variables: List[str]
     """A list of the names of the variables the prompt template expects."""
     input_types: Dict[str, Any] = Field(default_factory=dict)
     """A dictionary of the types of the variables the prompt template expects.
     If not provided, all variables are assumed to be strings."""
     output_parser: Optional[BaseOutputParser] = None
     """How to parse the output of calling an LLM on this formatted prompt."""
-    partial_variables: Mapping[str, Union[str, Callable[[], str]]] = Field(
-        default_factory=dict
-    )
+    partial_variables: Mapping[str, Any] = Field(default_factory=dict)
+    """A dictionary of the partial variables the prompt template carries.
+    
+    Partial variables populate the template so that you don't need to
+    pass them in every time you call the prompt."""
+    metadata: Optional[Dict[str, Any]] = None
+    """Metadata to be used for tracing."""
+    tags: Optional[List[str]] = None
+    """Tags to be used for tracing."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "prompt_template"]
 
     @classmethod
@@ -62,49 +77,107 @@
     @property
     def OutputType(self) -> Any:
         return Union[StringPromptValue, ChatPromptValueConcrete]
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
+        partial_kwargs = {}
+        for name in self.partial_variables:
+            if callable(self.partial_variables[name]):
+                doc = self.partial_variables[name].__doc__
+                description = "By default. It's calling function."
+                if doc:
+                    description += f" Function description: {doc.strip()}"
+                partial_kwargs[name] = (
+                    str,
+                    Field(
+                        default=self.partial_variables[name](), description=description
+                    ),
+                )
+            else:
+                partial_kwargs[name] = (
+                    self.input_types.get(name, str),
+                    self.partial_variables[name],
+                )
         # This is correct, but pydantic typings/mypy don't think so.
         return create_model(  # type: ignore[call-overload]
             "PromptInput",
             **{k: (self.input_types.get(k, str), None) for k in self.input_variables},
+            **partial_kwargs,
         )
 
-    def _format_prompt_with_error_handling(self, inner_input: Dict) -> PromptValue:
+    def _validate_input(self, inner_input: Dict) -> Dict:
         if not isinstance(inner_input, dict):
-            raise TypeError(
-                f"Expected mapping type as input to {self.__class__.__name__}. "
-                f"Received {type(inner_input)}."
-            )
+            if len(self.input_variables) == 1:
+                var_name = self.input_variables[0]
+                inner_input = {var_name: inner_input}
+
+            else:
+                raise TypeError(
+                    f"Expected mapping type as input to {self.__class__.__name__}. "
+                    f"Received {type(inner_input)}."
+                )
         missing = set(self.input_variables).difference(inner_input)
         if missing:
             raise KeyError(
                 f"Input to {self.__class__.__name__} is missing variables {missing}. "
                 f" Expected: {self.input_variables}"
                 f" Received: {list(inner_input.keys())}"
             )
-        return self.format_prompt(**inner_input)
+        return inner_input
+
+    def _format_prompt_with_error_handling(self, inner_input: Dict) -> PromptValue:
+        _inner_input = self._validate_input(inner_input)
+        return self.format_prompt(**_inner_input)
+
+    async def _aformat_prompt_with_error_handling(
+        self, inner_input: Dict
+    ) -> PromptValue:
+        _inner_input = self._validate_input(inner_input)
+        return await self.aformat_prompt(**_inner_input)
 
     def invoke(
         self, input: Dict, config: Optional[RunnableConfig] = None
     ) -> PromptValue:
+        config = ensure_config(config)
+        if self.metadata:
+            config["metadata"] = {**config["metadata"], **self.metadata}
+        if self.tags:
+            config["tags"] = config["tags"] + self.tags
         return self._call_with_config(
             self._format_prompt_with_error_handling,
             input,
             config,
             run_type="prompt",
         )
 
+    async def ainvoke(
+        self, input: Dict, config: Optional[RunnableConfig] = None, **kwargs: Any
+    ) -> PromptValue:
+        config = ensure_config(config)
+        if self.metadata:
+            config["metadata"].update(self.metadata)
+        if self.tags:
+            config["tags"].extend(self.tags)
+        return await self._acall_with_config(
+            self._aformat_prompt_with_error_handling,
+            input,
+            config,
+            run_type="prompt",
+        )
+
     @abstractmethod
     def format_prompt(self, **kwargs: Any) -> PromptValue:
         """Create Prompt Value."""
 
+    async def aformat_prompt(self, **kwargs: Any) -> PromptValue:
+        """Create Prompt Value."""
+        return self.format_prompt(**kwargs)
+
     @root_validator()
     def validate_variable_names(cls, values: Dict) -> Dict:
         """Validate variable names do not include restricted names."""
         if "stop" in values["input_variables"]:
             raise ValueError(
                 "Cannot have an input variable named 'stop', as it is used internally,"
                 " please rename."
@@ -132,21 +205,20 @@
         )
         prompt_dict["partial_variables"] = {**self.partial_variables, **kwargs}
         return type(self)(**prompt_dict)
 
     def _merge_partial_and_user_variables(self, **kwargs: Any) -> Dict[str, Any]:
         # Get partial params:
         partial_kwargs = {
-            k: v if isinstance(v, str) else v()
-            for k, v in self.partial_variables.items()
+            k: v if not callable(v) else v() for k, v in self.partial_variables.items()
         }
         return {**partial_kwargs, **kwargs}
 
     @abstractmethod
-    def format(self, **kwargs: Any) -> str:
+    def format(self, **kwargs: Any) -> FormatOutputType:
         """Format the prompt with the inputs.
 
         Args:
             kwargs: Any arguments to be passed to the prompt template.
 
         Returns:
             A formatted string.
@@ -154,14 +226,31 @@
         Example:
 
         .. code-block:: python
 
             prompt.format(variable1="foo")
         """
 
+    async def aformat(self, **kwargs: Any) -> FormatOutputType:
+        """Format the prompt with the inputs.
+
+        Args:
+            kwargs: Any arguments to be passed to the prompt template.
+
+        Returns:
+            A formatted string.
+
+        Example:
+
+        .. code-block:: python
+
+            await prompt.aformat(variable1="foo")
+        """
+        return self.format(**kwargs)
+
     @property
     def _prompt_type(self) -> str:
         """Return the prompt type key."""
         raise NotImplementedError
 
     def dict(self, **kwargs: Any) -> Dict:
         """Return dictionary representation of prompt."""
@@ -199,22 +288,37 @@
 
         directory_path = save_path.parent
         directory_path.mkdir(parents=True, exist_ok=True)
 
         if save_path.suffix == ".json":
             with open(file_path, "w") as f:
                 json.dump(prompt_dict, f, indent=4, ensure_ascii=False)
-        elif save_path.suffix == ".yaml":
-            with open(file_path, "w") as f:
+        elif save_path.suffix.endswith((".yaml", ".yml")):
+            with open(file_path, "w", encoding="utf-8") as f:
                 yaml.dump(prompt_dict, f, default_flow_style=False)
         else:
             raise ValueError(f"{save_path} must be json or yaml")
 
 
-def format_document(doc: Document, prompt: BasePromptTemplate) -> str:
+def _get_document_info(doc: Document, prompt: BasePromptTemplate[str]) -> Dict:
+    base_info = {"page_content": doc.page_content, **doc.metadata}
+    missing_metadata = set(prompt.input_variables).difference(base_info)
+    if len(missing_metadata) > 0:
+        required_metadata = [
+            iv for iv in prompt.input_variables if iv != "page_content"
+        ]
+        raise ValueError(
+            f"Document prompt requires documents to have metadata variables: "
+            f"{required_metadata}. Received document with missing metadata: "
+            f"{list(missing_metadata)}."
+        )
+    return {k: base_info[k] for k in prompt.input_variables}
+
+
+def format_document(doc: Document, prompt: BasePromptTemplate[str]) -> str:
     """Format a document into a string based on a prompt template.
 
     First, this pulls information from the document from two sources:
 
     1. `page_content`:
         This takes the information from the `document.page_content`
         and assigns it to a variable named `page_content`.
@@ -232,28 +336,42 @@
 
     Returns:
         string of the document formatted.
 
     Example:
         .. code-block:: python
 
-            from langchain_core import Document
+            from langchain_core.documents import Document
             from langchain_core.prompts import PromptTemplate
 
             doc = Document(page_content="This is a joke", metadata={"page": "1"})
             prompt = PromptTemplate.from_template("Page {page}: {page_content}")
             format_document(doc, prompt)
             >>> "Page 1: This is a joke"
     """
-    base_info = {"page_content": doc.page_content, **doc.metadata}
-    missing_metadata = set(prompt.input_variables).difference(base_info)
-    if len(missing_metadata) > 0:
-        required_metadata = [
-            iv for iv in prompt.input_variables if iv != "page_content"
-        ]
-        raise ValueError(
-            f"Document prompt requires documents to have metadata variables: "
-            f"{required_metadata}. Received document with missing metadata: "
-            f"{list(missing_metadata)}."
-        )
-    document_info = {k: base_info[k] for k in prompt.input_variables}
-    return prompt.format(**document_info)
+    return prompt.format(**_get_document_info(doc, prompt))
+
+
+async def aformat_document(doc: Document, prompt: BasePromptTemplate[str]) -> str:
+    """Format a document into a string based on a prompt template.
+
+    First, this pulls information from the document from two sources:
+
+    1. `page_content`:
+        This takes the information from the `document.page_content`
+        and assigns it to a variable named `page_content`.
+    2. metadata:
+        This takes information from `document.metadata` and assigns
+        it to variables of the same name.
+
+    Those variables are then passed into the `prompt` to produce a formatted string.
+
+    Args:
+        doc: Document, the page_content and metadata will be used to create
+            the final string.
+        prompt: BasePromptTemplate, will be used to format the page_content
+            and metadata into the final string.
+
+    Returns:
+        string of the document formatted.
+    """
+    return await prompt.aformat(**_get_document_info(doc, prompt))
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/few_shot.py` & `gigachain_core-0.2.0/langchain_core/prompts/few_shot.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 """Prompt template that contains few shot examples."""
+
 from __future__ import annotations
 
 from pathlib import Path
 from typing import Any, Dict, List, Literal, Optional, Union
 
+from langchain_core.example_selectors import BaseExampleSelector
 from langchain_core.messages import BaseMessage, get_buffer_string
 from langchain_core.prompts.chat import (
     BaseChatPromptTemplate,
     BaseMessagePromptTemplate,
 )
 from langchain_core.prompts.prompt import PromptTemplate
 from langchain_core.prompts.string import (
@@ -22,15 +24,15 @@
 class _FewShotPromptTemplateMixin(BaseModel):
     """Prompt template that contains few shot examples."""
 
     examples: Optional[List[dict]] = None
     """Examples to format into the prompt.
     Either this or example_selector should be provided."""
 
-    example_selector: Any = None
+    example_selector: Optional[BaseExampleSelector] = None
     """ExampleSelector to choose the examples to format into the prompt.
     Either this or examples should be provided."""
 
     class Config:
         """Configuration for this pydantic object."""
 
         extra = Extra.forbid
@@ -67,14 +69,32 @@
         elif self.example_selector is not None:
             return self.example_selector.select_examples(kwargs)
         else:
             raise ValueError(
                 "One of 'examples' and 'example_selector' should be provided"
             )
 
+    async def _aget_examples(self, **kwargs: Any) -> List[dict]:
+        """Get the examples to use for formatting the prompt.
+
+        Args:
+            **kwargs: Keyword arguments to be passed to the example selector.
+
+        Returns:
+            List of examples.
+        """
+        if self.examples is not None:
+            return self.examples
+        elif self.example_selector is not None:
+            return await self.example_selector.aselect_examples(kwargs)
+        else:
+            raise ValueError(
+                "One of 'examples' and 'example_selector' should be provided"
+            )
+
 
 class FewShotPromptTemplate(_FewShotPromptTemplateMixin, StringPromptTemplate):
     """Prompt template that contains few shot examples."""
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """Return whether or not the class is serializable."""
@@ -123,28 +143,14 @@
     class Config:
         """Configuration for this pydantic object."""
 
         extra = Extra.forbid
         arbitrary_types_allowed = True
 
     def format(self, **kwargs: Any) -> str:
-        """Format the prompt with the inputs.
-
-        Args:
-            **kwargs: Any arguments to be passed to the prompt template.
-
-        Returns:
-            A formatted string.
-
-        Example:
-
-        .. code-block:: python
-
-            prompt.format(variable1="foo")
-        """
         kwargs = self._merge_partial_and_user_variables(**kwargs)
         # Get the examples to use.
         examples = self._get_examples(**kwargs)
         examples = [
             {k: e[k] for k in self.example_prompt.input_variables} for e in examples
         ]
         # Format the examples.
@@ -154,14 +160,32 @@
         # Create the overall template.
         pieces = [self.prefix, *example_strings, self.suffix]
         template = self.example_separator.join([piece for piece in pieces if piece])
 
         # Format the template with the input variables.
         return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
 
+    async def aformat(self, **kwargs: Any) -> str:
+        kwargs = self._merge_partial_and_user_variables(**kwargs)
+        # Get the examples to use.
+        examples = await self._aget_examples(**kwargs)
+        examples = [
+            {k: e[k] for k in self.example_prompt.input_variables} for e in examples
+        ]
+        # Format the examples.
+        example_strings = [
+            await self.example_prompt.aformat(**example) for example in examples
+        ]
+        # Create the overall template.
+        pieces = [self.prefix, *example_strings, self.suffix]
+        template = self.example_separator.join([piece for piece in pieces if piece])
+
+        # Format the template with the input variables.
+        return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
+
     @property
     def _prompt_type(self) -> str:
         """Return the prompt type key."""
         return "few_shot"
 
     def save(self, file_path: Union[Path, str]) -> None:
         if self.example_selector:
@@ -273,15 +297,15 @@
                 SystemMessagePromptTemplate.from_template(
                     "You are a helpful AI Assistant"
                 )
                 + few_shot_prompt
                 + HumanMessagePromptTemplate.from_template("{input}")
             )
             # Show the prompt
-            print(final_prompt.format_messages(input="What's 3+3?"))
+            print(final_prompt.format_messages(input="What's 3+3?"))  # noqa: T201
 
             # Use within an LLM
             from langchain_core.chat_models import ChatAnthropic
             chain = final_prompt | ChatAnthropic()
             chain.invoke({"input": "What's 3+3?"})
     """
 
@@ -320,14 +344,36 @@
         messages = [
             message
             for example in examples
             for message in self.example_prompt.format_messages(**example)
         ]
         return messages
 
+    async def aformat_messages(self, **kwargs: Any) -> List[BaseMessage]:
+        """Format kwargs into a list of messages.
+
+        Args:
+            **kwargs: keyword arguments to use for filling in templates in messages.
+
+        Returns:
+            A list of formatted messages with all template variables filled in.
+        """
+        # Get the examples to use.
+        examples = await self._aget_examples(**kwargs)
+        examples = [
+            {k: e[k] for k in self.example_prompt.input_variables} for e in examples
+        ]
+        # Format the examples.
+        messages = [
+            message
+            for example in examples
+            for message in await self.example_prompt.aformat_messages(**example)
+        ]
+        return messages
+
     def format(self, **kwargs: Any) -> str:
         """Format the prompt with inputs generating a string.
 
         Use this method to generate a string representation of a prompt consisting
         of chat messages.
 
         Useful for feeding into a string based completion language model or debugging.
@@ -336,7 +382,14 @@
             **kwargs: keyword arguments to use for formatting.
 
         Returns:
             A string representation of the prompt
         """
         messages = self.format_messages(**kwargs)
         return get_buffer_string(messages)
+
+    async def aformat(self, **kwargs: Any) -> str:
+        messages = await self.aformat_messages(**kwargs)
+        return get_buffer_string(messages)
+
+    def pretty_repr(self, html: bool = False) -> str:
+        raise NotImplementedError()
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/few_shot_with_templates.py` & `gigachain_core-0.2.0/langchain_core/prompts/few_shot_with_templates.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Prompt template that contains few shot examples."""
+
 from pathlib import Path
 from typing import Any, Dict, List, Optional, Union
 
 from langchain_core.prompts.prompt import PromptTemplate
 from langchain_core.prompts.string import (
     DEFAULT_FORMATTER_MAPPING,
     StringPromptTemplate,
@@ -97,14 +98,22 @@
         if self.examples is not None:
             return self.examples
         elif self.example_selector is not None:
             return self.example_selector.select_examples(kwargs)
         else:
             raise ValueError
 
+    async def _aget_examples(self, **kwargs: Any) -> List[dict]:
+        if self.examples is not None:
+            return self.examples
+        elif self.example_selector is not None:
+            return await self.example_selector.aselect_examples(kwargs)
+        else:
+            raise ValueError
+
     def format(self, **kwargs: Any) -> str:
         """Format the prompt with the inputs.
 
         Args:
             kwargs: Any arguments to be passed to the prompt template.
 
         Returns:
@@ -144,14 +153,50 @@
             **suffix_kwargs,
         )
 
         pieces = [prefix, *example_strings, suffix]
         template = self.example_separator.join([piece for piece in pieces if piece])
         # Format the template with the input variables.
         return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
+
+    async def aformat(self, **kwargs: Any) -> str:
+        kwargs = self._merge_partial_and_user_variables(**kwargs)
+        # Get the examples to use.
+        examples = await self._aget_examples(**kwargs)
+        # Format the examples.
+        example_strings = [
+            # We can use the sync method here as PromptTemplate doesn't block
+            self.example_prompt.format(**example)
+            for example in examples
+        ]
+        # Create the overall prefix.
+        if self.prefix is None:
+            prefix = ""
+        else:
+            prefix_kwargs = {
+                k: v for k, v in kwargs.items() if k in self.prefix.input_variables
+            }
+            for k in prefix_kwargs.keys():
+                kwargs.pop(k)
+            prefix = await self.prefix.aformat(**prefix_kwargs)
+
+        # Create the overall suffix
+        suffix_kwargs = {
+            k: v for k, v in kwargs.items() if k in self.suffix.input_variables
+        }
+        for k in suffix_kwargs.keys():
+            kwargs.pop(k)
+        suffix = await self.suffix.aformat(
+            **suffix_kwargs,
+        )
+
+        pieces = [prefix, *example_strings, suffix]
+        template = self.example_separator.join([piece for piece in pieces if piece])
+        # Format the template with the input variables.
+        return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
 
     @property
     def _prompt_type(self) -> str:
         """Return the prompt type key."""
         return "few_shot_with_templates"
 
     def save(self, file_path: Union[Path, str]) -> None:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/loading.py` & `gigachain_core-0.2.0/langchain_core/prompts/loading.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,15 +9,14 @@
 from langchain_core.output_parsers.string import StrOutputParser
 from langchain_core.prompts.base import BasePromptTemplate
 from langchain_core.prompts.chat import ChatPromptTemplate
 from langchain_core.prompts.few_shot import FewShotPromptTemplate
 from langchain_core.prompts.prompt import PromptTemplate
 from langchain_core.utils import try_load_from_hub
 
-URL_BASE = "https://raw.githubusercontent.com/hwchase17/langchain-hub/master/prompts/"
 logger = logging.getLogger(__name__)
 
 
 def load_prompt_from_config(config: dict) -> BasePromptTemplate:
     """Load prompt from Config Dict."""
     if "_type" not in config:
         logger.warning("No `_type` key found, defaulting to `prompt`.")
@@ -140,18 +139,18 @@
     # Convert file to a Path object.
     if isinstance(file, str):
         file_path = Path(file)
     else:
         file_path = file
     # Load from either json or yaml.
     if file_path.suffix == ".json":
-        with open(file_path) as f:
+        with open(file_path, encoding="utf-8") as f:
             config = json.load(f)
-    elif file_path.suffix == ".yaml":
-        with open(file_path, "r") as f:
+    elif file_path.suffix.endswith((".yaml", ".yml")):
+        with open(file_path, "r", encoding="utf-8") as f:
             config = yaml.safe_load(f)
     else:
         raise ValueError(f"Got unsupported file type {file_path.suffix}")
     # Load the prompt from the config now.
     return load_prompt_from_config(config)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/pipeline.py` & `gigachain_core-0.2.0/langchain_core/prompts/pipeline.py`

 * *Files 14% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 
 
 def _get_inputs(inputs: dict, input_variables: List[str]) -> dict:
     return {k: inputs[k] for k in input_variables}
 
 
 class PipelinePromptTemplate(BasePromptTemplate):
-    """A prompt template for composing multiple prompt templates together.
+    """Prompt template for composing multiple prompt templates together.
 
     This can be useful when you want to reuse parts of prompts.
     A PipelinePrompt consists of two main parts:
         - final_prompt: This is the final prompt that is returned
         - pipeline_prompts: This is a list of tuples, consisting
             of a string (`name`) and a Prompt Template.
             Each PromptTemplate will be formatted and then passed
@@ -50,13 +50,26 @@
             if isinstance(prompt, BaseChatPromptTemplate):
                 kwargs[k] = prompt.format_messages(**_inputs)
             else:
                 kwargs[k] = prompt.format(**_inputs)
         _inputs = _get_inputs(kwargs, self.final_prompt.input_variables)
         return self.final_prompt.format_prompt(**_inputs)
 
+    async def aformat_prompt(self, **kwargs: Any) -> PromptValue:
+        for k, prompt in self.pipeline_prompts:
+            _inputs = _get_inputs(kwargs, prompt.input_variables)
+            if isinstance(prompt, BaseChatPromptTemplate):
+                kwargs[k] = await prompt.aformat_messages(**_inputs)
+            else:
+                kwargs[k] = await prompt.aformat(**_inputs)
+        _inputs = _get_inputs(kwargs, self.final_prompt.input_variables)
+        return await self.final_prompt.aformat_prompt(**_inputs)
+
     def format(self, **kwargs: Any) -> str:
         return self.format_prompt(**kwargs).to_string()
 
+    async def aformat(self, **kwargs: Any) -> str:
+        return (await self.aformat_prompt(**kwargs)).to_string()
+
     @property
     def _prompt_type(self) -> str:
         raise ValueError
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/prompts/prompt.py` & `gigachain_core-0.2.0/langchain_core/prompts/prompt.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,25 +1,28 @@
 """Prompt schema definition."""
+
 from __future__ import annotations
 
 import warnings
 from pathlib import Path
 from typing import Any, Dict, List, Literal, Optional, Union
 
 from langchain_core.prompts.string import (
     DEFAULT_FORMATTER_MAPPING,
     StringPromptTemplate,
     check_valid_template,
     get_template_variables,
+    mustache_schema,
 )
-from langchain_core.pydantic_v1 import root_validator
+from langchain_core.pydantic_v1 import BaseModel, root_validator
+from langchain_core.runnables.config import RunnableConfig
 
 
 class PromptTemplate(StringPromptTemplate):
-    """A prompt template for a language model.
+    """Prompt template for a language model.
 
     A prompt template consists of a string template. It accepts a set of parameters
     from the user that can be used to generate a prompt for a language model.
 
     The template can be formatted using either f-strings (default) or jinja2 syntax.
 
     *Security warning*: Prefer using `template_format="f-string"` instead of
@@ -61,20 +64,27 @@
 
     input_variables: List[str]
     """A list of the names of the variables the prompt template expects."""
 
     template: str
     """The prompt template."""
 
-    template_format: Literal["f-string", "jinja2"] = "f-string"
-    """The format of the prompt template. Options are: 'f-string', 'jinja2'."""
+    template_format: Literal["f-string", "mustache", "jinja2"] = "f-string"
+    """The format of the prompt template.
+    Options are: 'f-string', 'mustache', 'jinja2'."""
 
     validate_template: bool = False
     """Whether or not to try validating the template."""
 
+    def get_input_schema(self, config: RunnableConfig | None = None) -> type[BaseModel]:
+        if self.template_format != "mustache":
+            return super().get_input_schema(config)
+
+        return mustache_schema(self.template)
+
     def __add__(self, other: Any) -> PromptTemplate:
         """Override the + operator to allow for combining prompt templates."""
         # Allow for easy combining
         if isinstance(other, PromptTemplate):
             if self.template_format != "f-string":
                 raise ValueError(
                     "Adding prompt templates only supported for f-strings."
@@ -110,35 +120,23 @@
 
     @property
     def _prompt_type(self) -> str:
         """Return the prompt type key."""
         return "prompt"
 
     def format(self, **kwargs: Any) -> str:
-        """Format the prompt with the inputs.
-
-        Args:
-            kwargs: Any arguments to be passed to the prompt template.
-
-        Returns:
-            A formatted string.
-
-        Example:
-
-            .. code-block:: python
-
-                prompt.format(variable1="foo")
-        """
         kwargs = self._merge_partial_and_user_variables(**kwargs)
         return DEFAULT_FORMATTER_MAPPING[self.template_format](self.template, **kwargs)
 
     @root_validator()
     def template_is_valid(cls, values: Dict) -> Dict:
         """Check that template and input variables are consistent."""
         if values["validate_template"]:
+            if values["template_format"] == "mustache":
+                raise ValueError("Mustache templates cannot be validated.")
             all_inputs = values["input_variables"] + list(values["partial_variables"])
             check_valid_template(
                 values["template"], values["template_format"], all_inputs
             )
         elif values.get("template_format"):
             values["input_variables"] = [
                 var
@@ -195,15 +193,15 @@
                 template will expect.
 
         input_variables is ignored as from_file now delegates to from_template().
 
         Returns:
             The prompt loaded from the file.
         """
-        with open(str(template_file), "r") as f:
+        with open(str(template_file), "r", encoding="utf-8") as f:
             template = f.read()
         if input_variables:
             warnings.warn(
                 "`input_variables' is deprecated and ignored.", DeprecationWarning
             )
         return cls.from_template(template=template, **kwargs)
 
@@ -251,11 +249,11 @@
             input_variables = [
                 var for var in input_variables if var not in _partial_variables
             ]
 
         return cls(
             input_variables=input_variables,
             template=template,
-            template_format=template_format,
+            template_format=template_format,  # type: ignore[arg-type]
             partial_variables=_partial_variables,
             **kwargs,
         )
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/pydantic_v1/__init__.py` & `gigachain_core-0.2.0/langchain_core/pydantic_v1/__init__.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/__init__.py` & `gigachain_core-0.2.0/langchain_core/runnables/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -5,19 +5,22 @@
 
 Programs created using LCEL and LangChain Runnables inherently support
 synchronous, asynchronous, batch, and streaming operations.
 
 Support for **async** allows servers hosting LCEL based programs to scale better
 for higher concurrent loads.
 
-**Streaming** of intermediate outputs as they're being generated allows for
+**Batch** operations allow for processing multiple inputs in parallel.
+
+**Streaming** of intermediate outputs, as they're being generated, allows for
 creating more responsive UX.
 
 This module contains schema and implementation of LangChain Runnables primitives.
 """
+
 from langchain_core.runnables.base import (
     Runnable,
     RunnableBinding,
     RunnableGenerator,
     RunnableLambda,
     RunnableMap,
     RunnableParallel,
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/base.py` & `gigachain_core-0.2.0/langchain_core/runnables/base.py`

 * *Files 12% similar despite different names*

```diff
@@ -8,8982 +8,11454 @@
 00000070: 6d70 6f72 7420 4142 432c 2061 6273 7472  mport ABC, abstr
 00000080: 6163 746d 6574 686f 640a 6672 6f6d 2063  actmethod.from c
 00000090: 6f6e 6375 7272 656e 742e 6675 7475 7265  oncurrent.future
 000000a0: 7320 696d 706f 7274 2046 4952 5354 5f43  s import FIRST_C
 000000b0: 4f4d 504c 4554 4544 2c20 7761 6974 0a66  OMPLETED, wait.f
 000000c0: 726f 6d20 636f 6e74 6578 7476 6172 7320  rom contextvars 
 000000d0: 696d 706f 7274 2063 6f70 795f 636f 6e74  import copy_cont
-000000e0: 6578 740a 6672 6f6d 2063 6f70 7920 696d  ext.from copy im
-000000f0: 706f 7274 2064 6565 7063 6f70 790a 6672  port deepcopy.fr
-00000100: 6f6d 2066 756e 6374 6f6f 6c73 2069 6d70  om functools imp
-00000110: 6f72 7420 7772 6170 730a 6672 6f6d 2069  ort wraps.from i
-00000120: 7465 7274 6f6f 6c73 2069 6d70 6f72 7420  tertools import 
-00000130: 6772 6f75 7062 792c 2074 6565 0a66 726f  groupby, tee.fro
-00000140: 6d20 6f70 6572 6174 6f72 2069 6d70 6f72  m operator impor
-00000150: 7420 6974 656d 6765 7474 6572 0a66 726f  t itemgetter.fro
-00000160: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
-00000170: 280a 2020 2020 5459 5045 5f43 4845 434b  (.    TYPE_CHECK
-00000180: 494e 472c 0a20 2020 2041 6e79 2c0a 2020  ING,.    Any,.  
-00000190: 2020 4173 796e 6349 7465 7261 746f 722c    AsyncIterator,
-000001a0: 0a20 2020 2041 7761 6974 6162 6c65 2c0a  .    Awaitable,.
-000001b0: 2020 2020 4361 6c6c 6162 6c65 2c0a 2020      Callable,.  
-000001c0: 2020 436f 726f 7574 696e 652c 0a20 2020    Coroutine,.   
-000001d0: 2044 6963 742c 0a20 2020 2047 656e 6572   Dict,.    Gener
-000001e0: 6963 2c0a 2020 2020 4974 6572 6174 6f72  ic,.    Iterator
-000001f0: 2c0a 2020 2020 4c69 7374 2c0a 2020 2020  ,.    List,.    
-00000200: 4d61 7070 696e 672c 0a20 2020 204f 7074  Mapping,.    Opt
-00000210: 696f 6e61 6c2c 0a20 2020 2053 6571 7565  ional,.    Seque
-00000220: 6e63 652c 0a20 2020 2053 6574 2c0a 2020  nce,.    Set,.  
-00000230: 2020 5475 706c 652c 0a20 2020 2054 7970    Tuple,.    Typ
-00000240: 652c 0a20 2020 2054 7970 6556 6172 2c0a  e,.    TypeVar,.
-00000250: 2020 2020 556e 696f 6e2c 0a20 2020 2063      Union,.    c
-00000260: 6173 742c 0a20 2020 206f 7665 726c 6f61  ast,.    overloa
-00000270: 642c 0a29 0a0a 6672 6f6d 2074 7970 696e  d,.)..from typin
-00000280: 675f 6578 7465 6e73 696f 6e73 2069 6d70  g_extensions imp
-00000290: 6f72 7420 4c69 7465 7261 6c2c 2067 6574  ort Literal, get
-000002a0: 5f61 7267 730a 0a66 726f 6d20 6c61 6e67  _args..from lang
-000002b0: 6368 6169 6e5f 636f 7265 2e6c 6f61 642e  chain_core.load.
-000002c0: 6475 6d70 2069 6d70 6f72 7420 6475 6d70  dump import dump
-000002d0: 642c 2064 756d 7073 0a66 726f 6d20 6c61  d, dumps.from la
-000002e0: 6e67 6368 6169 6e5f 636f 7265 2e6c 6f61  ngchain_core.loa
-000002f0: 642e 7365 7269 616c 697a 6162 6c65 2069  d.serializable i
-00000300: 6d70 6f72 7420 5365 7269 616c 697a 6162  mport Serializab
-00000310: 6c65 0a66 726f 6d20 6c61 6e67 6368 6169  le.from langchai
-00000320: 6e5f 636f 7265 2e70 7964 616e 7469 635f  n_core.pydantic_
-00000330: 7631 2069 6d70 6f72 7420 4261 7365 436f  v1 import BaseCo
-00000340: 6e66 6967 2c20 4261 7365 4d6f 6465 6c2c  nfig, BaseModel,
-00000350: 2046 6965 6c64 2c20 6372 6561 7465 5f6d   Field, create_m
-00000360: 6f64 656c 0a66 726f 6d20 6c61 6e67 6368  odel.from langch
-00000370: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
-00000380: 6573 2e63 6f6e 6669 6720 696d 706f 7274  es.config import
-00000390: 2028 0a20 2020 2052 756e 6e61 626c 6543   (.    RunnableC
-000003a0: 6f6e 6669 672c 0a20 2020 2061 6361 6c6c  onfig,.    acall
-000003b0: 5f66 756e 635f 7769 7468 5f76 6172 6961  _func_with_varia
-000003c0: 626c 655f 6172 6773 2c0a 2020 2020 6361  ble_args,.    ca
-000003d0: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
-000003e0: 6961 626c 655f 6172 6773 2c0a 2020 2020  iable_args,.    
-000003f0: 656e 7375 7265 5f63 6f6e 6669 672c 0a20  ensure_config,. 
-00000400: 2020 2067 6574 5f61 7379 6e63 5f63 616c     get_async_cal
-00000410: 6c62 6163 6b5f 6d61 6e61 6765 725f 666f  lback_manager_fo
-00000420: 725f 636f 6e66 6967 2c0a 2020 2020 6765  r_config,.    ge
-00000430: 745f 6361 6c6c 6261 636b 5f6d 616e 6167  t_callback_manag
-00000440: 6572 5f66 6f72 5f63 6f6e 6669 672c 0a20  er_for_config,. 
-00000450: 2020 2067 6574 5f63 6f6e 6669 675f 6c69     get_config_li
-00000460: 7374 2c0a 2020 2020 6765 745f 6578 6563  st,.    get_exec
-00000470: 7574 6f72 5f66 6f72 5f63 6f6e 6669 672c  utor_for_config,
-00000480: 0a20 2020 206d 6572 6765 5f63 6f6e 6669  .    merge_confi
-00000490: 6773 2c0a 2020 2020 7061 7463 685f 636f  gs,.    patch_co
-000004a0: 6e66 6967 2c0a 2020 2020 7275 6e5f 696e  nfig,.    run_in
-000004b0: 5f65 7865 6375 746f 722c 0a20 2020 2076  _executor,.    v
-000004c0: 6172 5f63 6869 6c64 5f72 756e 6e61 626c  ar_child_runnabl
-000004d0: 655f 636f 6e66 6967 2c0a 290a 6672 6f6d  e_config,.).from
-000004e0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
-000004f0: 7275 6e6e 6162 6c65 732e 6772 6170 6820  runnables.graph 
-00000500: 696d 706f 7274 2047 7261 7068 0a66 726f  import Graph.fro
-00000510: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
-00000520: 2e72 756e 6e61 626c 6573 2e75 7469 6c73  .runnables.utils
-00000530: 2069 6d70 6f72 7420 280a 2020 2020 4164   import (.    Ad
-00000540: 6461 626c 6544 6963 742c 0a20 2020 2041  dableDict,.    A
-00000550: 6e79 436f 6e66 6967 7572 6162 6c65 4669  nyConfigurableFi
-00000560: 656c 642c 0a20 2020 2043 6f6e 6669 6775  eld,.    Configu
-00000570: 7261 626c 6546 6965 6c64 2c0a 2020 2020  rableField,.    
-00000580: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
-00000590: 6453 7065 632c 0a20 2020 2049 6e70 7574  dSpec,.    Input
-000005a0: 2c0a 2020 2020 4f75 7470 7574 2c0a 2020  ,.    Output,.  
-000005b0: 2020 6163 6365 7074 735f 636f 6e66 6967    accepts_config
-000005c0: 2c0a 2020 2020 6163 6365 7074 735f 636f  ,.    accepts_co
-000005d0: 6e74 6578 742c 0a20 2020 2061 6363 6570  ntext,.    accep
-000005e0: 7473 5f72 756e 5f6d 616e 6167 6572 2c0a  ts_run_manager,.
-000005f0: 2020 2020 6761 7468 6572 5f77 6974 685f      gather_with_
-00000600: 636f 6e63 7572 7265 6e63 792c 0a20 2020  concurrency,.   
-00000610: 2067 6574 5f66 756e 6374 696f 6e5f 6669   get_function_fi
-00000620: 7273 745f 6172 675f 6469 6374 5f6b 6579  rst_arg_dict_key
-00000630: 732c 0a20 2020 2067 6574 5f66 756e 6374  s,.    get_funct
-00000640: 696f 6e5f 6e6f 6e6c 6f63 616c 732c 0a20  ion_nonlocals,. 
-00000650: 2020 2067 6574 5f6c 616d 6264 615f 736f     get_lambda_so
-00000660: 7572 6365 2c0a 2020 2020 6765 745f 756e  urce,.    get_un
-00000670: 6971 7565 5f63 6f6e 6669 675f 7370 6563  ique_config_spec
-00000680: 732c 0a20 2020 2069 6e64 656e 745f 6c69  s,.    indent_li
-00000690: 6e65 735f 6166 7465 725f 6669 7273 742c  nes_after_first,
-000006a0: 0a29 0a66 726f 6d20 6c61 6e67 6368 6169  .).from langchai
-000006b0: 6e5f 636f 7265 2e75 7469 6c73 2e61 6974  n_core.utils.ait
-000006c0: 6572 2069 6d70 6f72 7420 6174 6565 2c20  er import atee, 
-000006d0: 7079 5f61 6e65 7874 0a66 726f 6d20 6c61  py_anext.from la
-000006e0: 6e67 6368 6169 6e5f 636f 7265 2e75 7469  ngchain_core.uti
-000006f0: 6c73 2e69 7465 7220 696d 706f 7274 2073  ls.iter import s
-00000700: 6166 6574 6565 0a0a 6966 2054 5950 455f  afetee..if TYPE_
-00000710: 4348 4543 4b49 4e47 3a0a 2020 2020 6672  CHECKING:.    fr
-00000720: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-00000730: 652e 6361 6c6c 6261 636b 732e 6d61 6e61  e.callbacks.mana
-00000740: 6765 7220 696d 706f 7274 2028 0a20 2020  ger import (.   
-00000750: 2020 2020 2041 7379 6e63 4361 6c6c 6261       AsyncCallba
-00000760: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-00000770: 6e52 756e 2c0a 2020 2020 2020 2020 4361  nRun,.        Ca
-00000780: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
-00000790: 4368 6169 6e52 756e 2c0a 2020 2020 290a  ChainRun,.    ).
-000007a0: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
-000007b0: 696e 5f63 6f72 652e 7072 6f6d 7074 732e  in_core.prompts.
-000007c0: 6261 7365 2069 6d70 6f72 7420 4261 7365  base import Base
-000007d0: 5072 6f6d 7074 5465 6d70 6c61 7465 0a20  PromptTemplate. 
-000007e0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
-000007f0: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
-00000800: 2e66 616c 6c62 6163 6b73 2069 6d70 6f72  .fallbacks impor
-00000810: 7420 280a 2020 2020 2020 2020 5275 6e6e  t (.        Runn
-00000820: 6162 6c65 5769 7468 4661 6c6c 6261 636b  ableWithFallback
-00000830: 7320 6173 2052 756e 6e61 626c 6557 6974  s as RunnableWit
-00000840: 6846 616c 6c62 6163 6b73 542c 0a20 2020  hFallbacksT,.   
-00000850: 2029 0a20 2020 2066 726f 6d20 6c61 6e67   ).    from lang
-00000860: 6368 6169 6e5f 636f 7265 2e74 7261 6365  chain_core.trace
-00000870: 7273 2e6c 6f67 5f73 7472 6561 6d20 696d  rs.log_stream im
-00000880: 706f 7274 2052 756e 4c6f 672c 2052 756e  port RunLog, Run
-00000890: 4c6f 6750 6174 6368 0a20 2020 2066 726f  LogPatch.    fro
-000008a0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
-000008b0: 2e74 7261 6365 7273 2e72 6f6f 745f 6c69  .tracers.root_li
-000008c0: 7374 656e 6572 7320 696d 706f 7274 204c  steners import L
-000008d0: 6973 7465 6e65 720a 0a0a 4f74 6865 7220  istener...Other 
-000008e0: 3d20 5479 7065 5661 7228 224f 7468 6572  = TypeVar("Other
-000008f0: 2229 0a0a 0a63 6c61 7373 205f 5363 6865  ")...class _Sche
-00000900: 6d61 436f 6e66 6967 2842 6173 6543 6f6e  maConfig(BaseCon
-00000910: 6669 6729 3a0a 2020 2020 6172 6269 7472  fig):.    arbitr
-00000920: 6172 795f 7479 7065 735f 616c 6c6f 7765  ary_types_allowe
-00000930: 6420 3d20 5472 7565 0a0a 0a63 6c61 7373  d = True...class
-00000940: 2052 756e 6e61 626c 6528 4765 6e65 7269   Runnable(Generi
-00000950: 635b 496e 7075 742c 204f 7574 7075 745d  c[Input, Output]
-00000960: 2c20 4142 4329 3a0a 2020 2020 2222 2241  , ABC):.    """A
-00000970: 2075 6e69 7420 6f66 2077 6f72 6b20 7468   unit of work th
-00000980: 6174 2063 616e 2062 6520 696e 766f 6b65  at can be invoke
-00000990: 642c 2062 6174 6368 6564 2c20 7374 7265  d, batched, stre
-000009a0: 616d 6564 2c20 7472 616e 7366 6f72 6d65  amed, transforme
-000009b0: 6420 616e 6420 636f 6d70 6f73 6564 2e0a  d and composed..
-000009c0: 0a20 2020 2020 4b65 7920 4d65 7468 6f64  .     Key Method
-000009d0: 730a 2020 2020 203d 3d3d 3d3d 3d3d 3d3d  s.     =========
-000009e0: 3d3d 0a0a 2020 2020 2a20 696e 766f 6b65  ==..    * invoke
-000009f0: 2f61 696e 766f 6b65 3a20 5472 616e 7366  /ainvoke: Transf
-00000a00: 6f72 6d73 2061 2073 696e 676c 6520 696e  orms a single in
-00000a10: 7075 7420 696e 746f 2061 6e20 6f75 7470  put into an outp
-00000a20: 7574 2e0a 2020 2020 2a20 6261 7463 682f  ut..    * batch/
-00000a30: 6162 6174 6368 3a20 4566 6669 6369 656e  abatch: Efficien
-00000a40: 746c 7920 7472 616e 7366 6f72 6d73 206d  tly transforms m
-00000a50: 756c 7469 706c 6520 696e 7075 7473 2069  ultiple inputs i
-00000a60: 6e74 6f20 6f75 7470 7574 732e 0a20 2020  nto outputs..   
-00000a70: 202a 2073 7472 6561 6d2f 6173 7472 6561   * stream/astrea
-00000a80: 6d3a 2053 7472 6561 6d73 206f 7574 7075  m: Streams outpu
-00000a90: 7420 6672 6f6d 2061 2073 696e 676c 6520  t from a single 
-00000aa0: 696e 7075 7420 6173 2069 7427 7320 7072  input as it's pr
-00000ab0: 6f64 7563 6564 2e0a 2020 2020 2a20 6173  oduced..    * as
-00000ac0: 7472 6561 6d5f 6c6f 673a 2053 7472 6561  tream_log: Strea
-00000ad0: 6d73 206f 7574 7075 7420 616e 6420 7365  ms output and se
-00000ae0: 6c65 6374 6564 2069 6e74 6572 6d65 6469  lected intermedi
-00000af0: 6174 6520 7265 7375 6c74 7320 6672 6f6d  ate results from
-00000b00: 2061 6e20 696e 7075 742e 0a0a 2020 2020   an input...    
-00000b10: 4275 696c 742d 696e 206f 7074 696d 697a  Built-in optimiz
-00000b20: 6174 696f 6e73 3a0a 0a20 2020 202a 2042  ations:..    * B
-00000b30: 6174 6368 3a20 4279 2064 6566 6175 6c74  atch: By default
-00000b40: 2c20 6261 7463 6820 7275 6e73 2069 6e76  , batch runs inv
-00000b50: 6f6b 6528 2920 696e 2070 6172 616c 6c65  oke() in paralle
-00000b60: 6c20 7573 696e 6720 6120 7468 7265 6164  l using a thread
-00000b70: 2070 6f6f 6c20 6578 6563 7574 6f72 2e0a   pool executor..
-00000b80: 2020 2020 2020 2020 2020 2020 204f 7665               Ove
-00000b90: 7272 6964 6520 746f 206f 7074 696d 697a  rride to optimiz
-00000ba0: 6520 6261 7463 6869 6e67 2e0a 0a20 2020  e batching...   
-00000bb0: 202a 2041 7379 6e63 3a20 4d65 7468 6f64   * Async: Method
-00000bc0: 7320 7769 7468 2022 6122 2073 7566 6669  s with "a" suffi
-00000bd0: 7820 6172 6520 6173 796e 6368 726f 6e6f  x are asynchrono
-00000be0: 7573 2e20 4279 2064 6566 6175 6c74 2c20  us. By default, 
-00000bf0: 7468 6579 2065 7865 6375 7465 0a20 2020  they execute.   
-00000c00: 2020 2020 2020 2020 2020 7468 6520 7379            the sy
-00000c10: 6e63 2063 6f75 6e74 6572 7061 7274 2075  nc counterpart u
-00000c20: 7369 6e67 2061 7379 6e63 696f 2773 2074  sing asyncio's t
-00000c30: 6872 6561 6420 706f 6f6c 2e0a 2020 2020  hread pool..    
-00000c40: 2020 2020 2020 2020 204f 7665 7272 6964           Overrid
-00000c50: 6520 666f 7220 6e61 7469 7665 2061 7379  e for native asy
-00000c60: 6e63 2e0a 0a20 2020 2041 6c6c 206d 6574  nc...    All met
-00000c70: 686f 6473 2061 6363 6570 7420 616e 206f  hods accept an o
-00000c80: 7074 696f 6e61 6c20 636f 6e66 6967 2061  ptional config a
-00000c90: 7267 756d 656e 742c 2077 6869 6368 2063  rgument, which c
-00000ca0: 616e 2062 6520 7573 6564 2074 6f20 636f  an be used to co
-00000cb0: 6e66 6967 7572 650a 2020 2020 6578 6563  nfigure.    exec
-00000cc0: 7574 696f 6e2c 2061 6464 2074 6167 7320  ution, add tags 
-00000cd0: 616e 6420 6d65 7461 6461 7461 2066 6f72  and metadata for
-00000ce0: 2074 7261 6369 6e67 2061 6e64 2064 6562   tracing and deb
-00000cf0: 7567 6769 6e67 2065 7463 2e0a 0a20 2020  ugging etc...   
-00000d00: 2052 756e 6e61 626c 6573 2065 7870 6f73   Runnables expos
-00000d10: 6520 7363 6865 6d61 7469 6320 696e 666f  e schematic info
-00000d20: 726d 6174 696f 6e20 6162 6f75 7420 7468  rmation about th
-00000d30: 6569 7220 696e 7075 742c 206f 7574 7075  eir input, outpu
-00000d40: 7420 616e 6420 636f 6e66 6967 2076 6961  t and config via
-00000d50: 0a20 2020 2074 6865 2069 6e70 7574 5f73  .    the input_s
-00000d60: 6368 656d 6120 7072 6f70 6572 7479 2c20  chema property, 
-00000d70: 7468 6520 6f75 7470 7574 5f73 6368 656d  the output_schem
-00000d80: 6120 7072 6f70 6572 7479 2061 6e64 2063  a property and c
-00000d90: 6f6e 6669 675f 7363 6865 6d61 206d 6574  onfig_schema met
-00000da0: 686f 642e 0a0a 2020 2020 4c43 454c 2061  hod...    LCEL a
-00000db0: 6e64 2043 6f6d 706f 7369 7469 6f6e 0a20  nd Composition. 
-00000dc0: 2020 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d     =============
-00000dd0: 3d3d 3d3d 3d3d 3d0a 0a20 2020 2054 6865  =======..    The
-00000de0: 204c 616e 6743 6861 696e 2045 7870 7265   LangChain Expre
-00000df0: 7373 696f 6e20 4c61 6e67 7561 6765 2028  ssion Language (
-00000e00: 4c43 454c 2920 6973 2061 2064 6563 6c61  LCEL) is a decla
-00000e10: 7261 7469 7665 2077 6179 2074 6f20 636f  rative way to co
-00000e20: 6d70 6f73 6520 5275 6e6e 6162 6c65 730a  mpose Runnables.
-00000e30: 2020 2020 696e 746f 2063 6861 696e 732e      into chains.
-00000e40: 2041 6e79 2063 6861 696e 2063 6f6e 7374   Any chain const
-00000e50: 7275 6374 6564 2074 6869 7320 7761 7920  ructed this way 
-00000e60: 7769 6c6c 2061 7574 6f6d 6174 6963 616c  will automatical
-00000e70: 6c79 2068 6176 6520 7379 6e63 2c20 6173  ly have sync, as
-00000e80: 796e 632c 0a20 2020 2062 6174 6368 2c20  ync,.    batch, 
-00000e90: 616e 6420 7374 7265 616d 696e 6720 7375  and streaming su
-00000ea0: 7070 6f72 742e 0a0a 2020 2020 5468 6520  pport...    The 
-00000eb0: 6d61 696e 2063 6f6d 706f 7369 7469 6f6e  main composition
-00000ec0: 2070 7269 6d69 7469 7665 7320 6172 6520   primitives are 
-00000ed0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
-00000ee0: 2061 6e64 2052 756e 6e61 626c 6550 6172   and RunnablePar
-00000ef0: 616c 6c65 6c2e 0a0a 2020 2020 5275 6e6e  allel...    Runn
-00000f00: 6162 6c65 5365 7175 656e 6365 2069 6e76  ableSequence inv
-00000f10: 6f6b 6573 2061 2073 6572 6965 7320 6f66  okes a series of
-00000f20: 2072 756e 6e61 626c 6573 2073 6571 7565   runnables seque
-00000f30: 6e74 6961 6c6c 792c 2077 6974 6820 6f6e  ntially, with on
-00000f40: 6520 7275 6e6e 6162 6c65 2773 0a20 2020  e runnable's.   
-00000f50: 206f 7574 7075 7420 7365 7276 696e 6720   output serving 
-00000f60: 6173 2074 6865 206e 6578 7427 7320 696e  as the next's in
-00000f70: 7075 742e 2043 6f6e 7374 7275 6374 2075  put. Construct u
-00000f80: 7369 6e67 2074 6865 2060 7c60 206f 7065  sing the `|` ope
-00000f90: 7261 746f 7220 6f72 2062 790a 2020 2020  rator or by.    
-00000fa0: 7061 7373 696e 6720 6120 6c69 7374 206f  passing a list o
-00000fb0: 6620 7275 6e6e 6162 6c65 7320 746f 2052  f runnables to R
-00000fc0: 756e 6e61 626c 6553 6571 7565 6e63 652e  unnableSequence.
-00000fd0: 0a0a 2020 2020 5275 6e6e 6162 6c65 5061  ..    RunnablePa
-00000fe0: 7261 6c6c 656c 2069 6e76 6f6b 6573 2072  rallel invokes r
-00000ff0: 756e 6e61 626c 6573 2063 6f6e 6375 7272  unnables concurr
-00001000: 656e 746c 792c 2070 726f 7669 6469 6e67  ently, providing
-00001010: 2074 6865 2073 616d 6520 696e 7075 740a   the same input.
-00001020: 2020 2020 746f 2065 6163 682e 2043 6f6e      to each. Con
-00001030: 7374 7275 6374 2069 7420 7573 696e 6720  struct it using 
-00001040: 6120 6469 6374 206c 6974 6572 616c 2077  a dict literal w
-00001050: 6974 6869 6e20 6120 7365 7175 656e 6365  ithin a sequence
-00001060: 206f 7220 6279 2070 6173 7369 6e67 2061   or by passing a
-00001070: 0a20 2020 2064 6963 7420 746f 2052 756e  .    dict to Run
-00001080: 6e61 626c 6550 6172 616c 6c65 6c2e 0a0a  nableParallel...
-00001090: 0a20 2020 2046 6f72 2065 7861 6d70 6c65  .    For example
-000010a0: 2c0a 0a20 2020 202e 2e20 636f 6465 2d62  ,..    .. code-b
-000010b0: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
-000010c0: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
-000010d0: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
-000010e0: 626c 6573 2069 6d70 6f72 7420 5275 6e6e  bles import Runn
-000010f0: 6162 6c65 4c61 6d62 6461 0a0a 2020 2020  ableLambda..    
-00001100: 2020 2020 2320 4120 5275 6e6e 6162 6c65      # A Runnable
-00001110: 5365 7175 656e 6365 2063 6f6e 7374 7275  Sequence constru
-00001120: 6374 6564 2075 7369 6e67 2074 6865 2060  cted using the `
-00001130: 7c60 206f 7065 7261 746f 720a 2020 2020  |` operator.    
-00001140: 2020 2020 7365 7175 656e 6365 203d 2052      sequence = R
-00001150: 756e 6e61 626c 654c 616d 6264 6128 6c61  unnableLambda(la
-00001160: 6d62 6461 2078 3a20 7820 2b20 3129 207c  mbda x: x + 1) |
-00001170: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
-00001180: 6c61 6d62 6461 2078 3a20 7820 2a20 3229  lambda x: x * 2)
-00001190: 0a20 2020 2020 2020 2073 6571 7565 6e63  .        sequenc
-000011a0: 652e 696e 766f 6b65 2831 2920 2320 340a  e.invoke(1) # 4.
-000011b0: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
-000011c0: 2e62 6174 6368 285b 312c 2032 2c20 335d  .batch([1, 2, 3]
-000011d0: 2920 2320 5b34 2c20 362c 2038 5d0a 0a0a  ) # [4, 6, 8]...
-000011e0: 2020 2020 2020 2020 2320 4120 7365 7175          # A sequ
-000011f0: 656e 6365 2074 6861 7420 636f 6e74 6169  ence that contai
-00001200: 6e73 2061 2052 756e 6e61 626c 6550 6172  ns a RunnablePar
-00001210: 616c 6c65 6c20 636f 6e73 7472 7563 7465  allel constructe
-00001220: 6420 7573 696e 6720 6120 6469 6374 206c  d using a dict l
-00001230: 6974 6572 616c 0a20 2020 2020 2020 2073  iteral.        s
-00001240: 6571 7565 6e63 6520 3d20 5275 6e6e 6162  equence = Runnab
-00001250: 6c65 4c61 6d62 6461 286c 616d 6264 6120  leLambda(lambda 
-00001260: 783a 2078 202b 2031 2920 7c20 7b0a 2020  x: x + 1) | {.  
-00001270: 2020 2020 2020 2020 2020 276d 756c 5f32            'mul_2
-00001280: 273a 2052 756e 6e61 626c 654c 616d 6264  ': RunnableLambd
-00001290: 6128 6c61 6d62 6461 2078 3a20 7820 2a20  a(lambda x: x * 
-000012a0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
-000012b0: 276d 756c 5f35 273a 2052 756e 6e61 626c  'mul_5': Runnabl
-000012c0: 654c 616d 6264 6128 6c61 6d62 6461 2078  eLambda(lambda x
-000012d0: 3a20 7820 2a20 3529 0a20 2020 2020 2020  : x * 5).       
-000012e0: 207d 0a20 2020 2020 2020 2073 6571 7565   }.        seque
-000012f0: 6e63 652e 696e 766f 6b65 2831 2920 2320  nce.invoke(1) # 
-00001300: 7b27 6d75 6c5f 3227 3a20 342c 2027 6d75  {'mul_2': 4, 'mu
-00001310: 6c5f 3527 3a20 3130 7d0a 0a20 2020 2053  l_5': 10}..    S
-00001320: 7461 6e64 6172 6420 4d65 7468 6f64 730a  tandard Methods.
-00001330: 2020 2020 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d      ============
-00001340: 3d3d 3d3d 0a0a 2020 2020 416c 6c20 5275  ====..    All Ru
-00001350: 6e6e 6162 6c65 7320 6578 706f 7365 2061  nnables expose a
-00001360: 6464 6974 696f 6e61 6c20 6d65 7468 6f64  dditional method
-00001370: 7320 7468 6174 2063 616e 2062 6520 7573  s that can be us
-00001380: 6564 2074 6f20 6d6f 6469 6679 2074 6865  ed to modify the
-00001390: 6972 2062 6568 6176 696f 720a 2020 2020  ir behavior.    
-000013a0: 2865 2e67 2e2c 2061 6464 2061 2072 6574  (e.g., add a ret
-000013b0: 7279 2070 6f6c 6963 792c 2061 6464 206c  ry policy, add l
-000013c0: 6966 6563 7963 6c65 206c 6973 7465 6e65  ifecycle listene
-000013d0: 7273 2c20 6d61 6b65 2074 6865 6d20 636f  rs, make them co
-000013e0: 6e66 6967 7572 6162 6c65 2c20 6574 632e  nfigurable, etc.
-000013f0: 292e 0a0a 2020 2020 5468 6573 6520 6d65  )...    These me
-00001400: 7468 6f64 7320 7769 6c6c 2077 6f72 6b20  thods will work 
-00001410: 6f6e 2061 6e79 2052 756e 6e61 626c 652c  on any Runnable,
-00001420: 2069 6e63 6c75 6469 6e67 2052 756e 6e61   including Runna
-00001430: 626c 6520 6368 6169 6e73 2063 6f6e 7374  ble chains const
-00001440: 7275 6374 6564 0a20 2020 2062 7920 636f  ructed.    by co
-00001450: 6d70 6f73 696e 6720 6f74 6865 7220 5275  mposing other Ru
-00001460: 6e6e 6162 6c65 732e 2053 6565 2074 6865  nnables. See the
-00001470: 2069 6e64 6976 6964 7561 6c20 6d65 7468   individual meth
-00001480: 6f64 7320 666f 7220 6465 7461 696c 732e  ods for details.
-00001490: 0a0a 2020 2020 466f 7220 6578 616d 706c  ..    For exampl
-000014a0: 652c 0a0a 2020 2020 2e2e 2063 6f64 652d  e,..    .. code-
-000014b0: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
-000014c0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-000014d0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
-000014e0: 6162 6c65 7320 696d 706f 7274 2052 756e  ables import Run
-000014f0: 6e61 626c 654c 616d 6264 610a 0a20 2020  nableLambda..   
-00001500: 2020 2020 2069 6d70 6f72 7420 7261 6e64       import rand
-00001510: 6f6d 0a0a 2020 2020 2020 2020 6465 6620  om..        def 
-00001520: 6164 645f 6f6e 6528 783a 2069 6e74 2920  add_one(x: int) 
-00001530: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-00001540: 2020 2020 7265 7475 726e 2078 202b 2031      return x + 1
-00001550: 0a0a 0a20 2020 2020 2020 2064 6566 2062  ...        def b
-00001560: 7567 6779 5f64 6f75 626c 6528 793a 2069  uggy_double(y: i
-00001570: 6e74 2920 2d3e 2069 6e74 3a0a 2020 2020  nt) -> int:.    
-00001580: 2020 2020 2020 2020 2727 2742 7567 6779          '''Buggy
-00001590: 2063 6f64 6520 7468 6174 2077 696c 6c20   code that will 
-000015a0: 6661 696c 2037 3025 206f 6620 7468 6520  fail 70% of the 
-000015b0: 7469 6d65 2727 270a 2020 2020 2020 2020  time'''.        
-000015c0: 2020 2020 6966 2072 616e 646f 6d2e 7261      if random.ra
-000015d0: 6e64 6f6d 2829 203e 2030 2e33 3a0a 2020  ndom() > 0.3:.  
-000015e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000015f0: 696e 7428 2754 6869 7320 636f 6465 2066  int('This code f
-00001600: 6169 6c65 642c 2061 6e64 2077 696c 6c20  ailed, and will 
-00001610: 7072 6f62 6162 6c79 2062 6520 7265 7472  probably be retr
-00001620: 6965 6421 2729 0a20 2020 2020 2020 2020  ied!').         
-00001630: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00001640: 7565 4572 726f 7228 2754 7269 6767 6572  ueError('Trigger
-00001650: 6564 2062 7567 6779 2063 6f64 6527 290a  ed buggy code').
-00001660: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00001670: 726e 2079 202a 2032 0a0a 2020 2020 2020  rn y * 2..      
-00001680: 2020 7365 7175 656e 6365 203d 2028 0a20    sequence = (. 
-00001690: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
-000016a0: 626c 654c 616d 6264 6128 6164 645f 6f6e  bleLambda(add_on
-000016b0: 6529 207c 0a20 2020 2020 2020 2020 2020  e) |.           
-000016c0: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
-000016d0: 6275 6767 795f 646f 7562 6c65 292e 7769  buggy_double).wi
-000016e0: 7468 5f72 6574 7279 2820 2320 5265 7472  th_retry( # Retr
-000016f0: 7920 6f6e 2066 6169 6c75 7265 0a20 2020  y on failure.   
-00001700: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00001710: 705f 6166 7465 725f 6174 7465 6d70 743d  p_after_attempt=
-00001720: 3130 2c0a 2020 2020 2020 2020 2020 2020  10,.            
-00001730: 2020 2020 7761 6974 5f65 7870 6f6e 656e      wait_exponen
-00001740: 7469 616c 5f6a 6974 7465 723d 4661 6c73  tial_jitter=Fals
-00001750: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
-00001760: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00001770: 2020 2070 7269 6e74 2873 6571 7565 6e63     print(sequenc
-00001780: 652e 696e 7075 745f 7363 6865 6d61 2e73  e.input_schema.s
-00001790: 6368 656d 6128 2929 2023 2053 686f 7720  chema()) # Show 
-000017a0: 696e 6665 7272 6564 2069 6e70 7574 2073  inferred input s
-000017b0: 6368 656d 610a 2020 2020 2020 2020 7072  chema.        pr
-000017c0: 696e 7428 7365 7175 656e 6365 2e6f 7574  int(sequence.out
-000017d0: 7075 745f 7363 6865 6d61 2e73 6368 656d  put_schema.schem
-000017e0: 6128 2929 2023 2053 686f 7720 696e 6665  a()) # Show infe
-000017f0: 7272 6564 206f 7574 7075 7420 7363 6865  rred output sche
-00001800: 6d61 0a20 2020 2020 2020 2070 7269 6e74  ma.        print
-00001810: 2873 6571 7565 6e63 652e 696e 766f 6b65  (sequence.invoke
-00001820: 2832 2929 2023 2069 6e76 6f6b 6520 7468  (2)) # invoke th
-00001830: 6520 7365 7175 656e 6365 2028 6e6f 7465  e sequence (note
-00001840: 2074 6865 2072 6574 7279 2061 626f 7665   the retry above
-00001850: 2121 290a 0a20 2020 2044 6562 7567 6769  !!)..    Debuggi
-00001860: 6e67 2061 6e64 2074 7261 6369 6e67 0a20  ng and tracing. 
-00001870: 2020 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d     =============
-00001880: 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020 4173  ========..    As
-00001890: 2074 6865 2063 6861 696e 7320 6765 7420   the chains get 
-000018a0: 6c6f 6e67 6572 2c20 6974 2063 616e 2062  longer, it can b
-000018b0: 6520 7573 6566 756c 2074 6f20 6265 2061  e useful to be a
-000018c0: 626c 6520 746f 2073 6565 2069 6e74 6572  ble to see inter
-000018d0: 6d65 6469 6174 6520 7265 7375 6c74 730a  mediate results.
-000018e0: 2020 2020 746f 2064 6562 7567 2061 6e64      to debug and
-000018f0: 2074 7261 6365 2074 6865 2063 6861 696e   trace the chain
-00001900: 2e0a 0a20 2020 2059 6f75 2063 616e 2073  ...    You can s
-00001910: 6574 2074 6865 2067 6c6f 6261 6c20 6465  et the global de
-00001920: 6275 6720 666c 6167 2074 6f20 5472 7565  bug flag to True
-00001930: 2074 6f20 656e 6162 6c65 2064 6562 7567   to enable debug
-00001940: 206f 7574 7075 7420 666f 7220 616c 6c20   output for all 
-00001950: 6368 6169 6e73 3a0a 0a20 2020 2020 2020  chains:..       
-00001960: 202e 2e20 636f 6465 2d62 6c6f 636b 3a3a   .. code-block::
-00001970: 2070 7974 686f 6e0a 0a20 2020 2020 2020   python..       
-00001980: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
-00001990: 6169 6e5f 636f 7265 2e67 6c6f 6261 6c73  ain_core.globals
-000019a0: 2069 6d70 6f72 7420 7365 745f 6465 6275   import set_debu
-000019b0: 670a 2020 2020 2020 2020 2020 2020 7365  g.            se
-000019c0: 745f 6465 6275 6728 5472 7565 290a 0a20  t_debug(True).. 
-000019d0: 2020 2041 6c74 6572 6e61 7469 7665 6c79     Alternatively
-000019e0: 2c20 796f 7520 6361 6e20 7061 7373 2065  , you can pass e
-000019f0: 7869 7374 696e 6720 6f72 2063 7573 746f  xisting or custo
-00001a00: 6d20 6361 6c6c 6261 636b 7320 746f 2061  m callbacks to a
-00001a10: 6e79 2067 6976 656e 2063 6861 696e 3a0a  ny given chain:.
-00001a20: 0a20 2020 2020 2020 202e 2e20 636f 6465  .        .. code
-00001a30: 2d62 6c6f 636b 3a3a 2070 7974 686f 6e0a  -block:: python.
-00001a40: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-00001a50: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
-00001a60: 2e74 7261 6365 7273 2069 6d70 6f72 7420  .tracers import 
-00001a70: 436f 6e73 6f6c 6543 616c 6c62 6163 6b48  ConsoleCallbackH
-00001a80: 616e 646c 6572 0a0a 2020 2020 2020 2020  andler..        
-00001a90: 2020 2020 6368 6169 6e2e 696e 766f 6b65      chain.invoke
-00001aa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00001ab0: 2020 2e2e 2e2c 0a20 2020 2020 2020 2020    ...,.         
-00001ac0: 2020 2020 2020 2063 6f6e 6669 673d 7b27         config={'
-00001ad0: 6361 6c6c 6261 636b 7327 3a20 5b43 6f6e  callbacks': [Con
-00001ae0: 736f 6c65 4361 6c6c 6261 636b 4861 6e64  soleCallbackHand
-00001af0: 6c65 7228 295d 7d0a 2020 2020 2020 2020  ler()]}.        
-00001b00: 2020 2020 290a 0a20 2020 2046 6f72 2061      )..    For a
-00001b10: 2055 4920 2861 6e64 206d 7563 6820 6d6f   UI (and much mo
-00001b20: 7265 2920 6368 6563 6b6f 7574 204c 616e  re) checkout Lan
-00001b30: 6753 6d69 7468 3a20 6874 7470 733a 2f2f  gSmith: https://
-00001b40: 646f 6373 2e73 6d69 7468 2e6c 616e 6763  docs.smith.langc
-00001b50: 6861 696e 2e63 6f6d 2f0a 2020 2020 2222  hain.com/.    ""
-00001b60: 220a 0a20 2020 206e 616d 653a 204f 7074  "..    name: Opt
-00001b70: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00001b80: 650a 2020 2020 2222 2254 6865 206e 616d  e.    """The nam
-00001b90: 6520 6f66 2074 6865 2072 756e 6e61 626c  e of the runnabl
-00001ba0: 652e 2055 7365 6420 666f 7220 6465 6275  e. Used for debu
-00001bb0: 6767 696e 6720 616e 6420 7472 6163 696e  gging and tracin
-00001bc0: 672e 2222 220a 0a20 2020 2064 6566 2067  g."""..    def g
-00001bd0: 6574 5f6e 616d 6528 0a20 2020 2020 2020  et_name(.       
-00001be0: 2073 656c 662c 2073 7566 6669 783a 204f   self, suffix: O
-00001bf0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00001c00: 6f6e 652c 202a 2c20 6e61 6d65 3a20 4f70  one, *, name: Op
-00001c10: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00001c20: 6e65 0a20 2020 2029 202d 3e20 7374 723a  ne.    ) -> str:
-00001c30: 0a20 2020 2020 2020 2022 2222 4765 7420  .        """Get 
-00001c40: 7468 6520 6e61 6d65 206f 6620 7468 6520  the name of the 
-00001c50: 7275 6e6e 6162 6c65 2e22 2222 0a20 2020  runnable.""".   
-00001c60: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
-00001c70: 206f 7220 7365 6c66 2e6e 616d 6520 6f72   or self.name or
-00001c80: 2073 656c 662e 5f5f 636c 6173 735f 5f2e   self.__class__.
-00001c90: 5f5f 6e61 6d65 5f5f 0a20 2020 2020 2020  __name__.       
-00001ca0: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
-00001cb0: 2020 2020 2020 2020 6966 206e 616d 655b          if name[
-00001cc0: 305d 2e69 7375 7070 6572 2829 3a0a 2020  0].isupper():.  
-00001cd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00001ce0: 7475 726e 206e 616d 6520 2b20 7375 6666  turn name + suff
-00001cf0: 6978 2e74 6974 6c65 2829 0a20 2020 2020  ix.title().     
-00001d00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00001d10: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00001d20: 7572 6e20 6e61 6d65 202b 2022 5f22 202b  urn name + "_" +
-00001d30: 2073 7566 6669 782e 6c6f 7765 7228 290a   suffix.lower().
-00001d40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00001d50: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00001d60: 206e 616d 650a 0a20 2020 2040 7072 6f70   name..    @prop
-00001d70: 6572 7479 0a20 2020 2064 6566 2049 6e70  erty.    def Inp
-00001d80: 7574 5479 7065 2873 656c 6629 202d 3e20  utType(self) -> 
-00001d90: 5479 7065 5b49 6e70 7574 5d3a 0a20 2020  Type[Input]:.   
-00001da0: 2020 2020 2022 2222 5468 6520 7479 7065       """The type
-00001db0: 206f 6620 696e 7075 7420 7468 6973 2072   of input this r
-00001dc0: 756e 6e61 626c 6520 6163 6365 7074 7320  unnable accepts 
-00001dd0: 7370 6563 6966 6965 6420 6173 2061 2074  specified as a t
-00001de0: 7970 6520 616e 6e6f 7461 7469 6f6e 2e22  ype annotation."
-00001df0: 2222 0a20 2020 2020 2020 2066 6f72 2063  "".        for c
-00001e00: 6c73 2069 6e20 7365 6c66 2e5f 5f63 6c61  ls in self.__cla
-00001e10: 7373 5f5f 2e5f 5f6f 7269 675f 6261 7365  ss__.__orig_base
-00001e20: 735f 5f3a 2020 2320 7479 7065 3a20 6967  s__:  # type: ig
-00001e30: 6e6f 7265 5b61 7474 722d 6465 6669 6e65  nore[attr-define
-00001e40: 645d 0a20 2020 2020 2020 2020 2020 2074  d].            t
-00001e50: 7970 655f 6172 6773 203d 2067 6574 5f61  ype_args = get_a
-00001e60: 7267 7328 636c 7329 0a20 2020 2020 2020  rgs(cls).       
-00001e70: 2020 2020 2069 6620 7479 7065 5f61 7267       if type_arg
-00001e80: 7320 616e 6420 6c65 6e28 7479 7065 5f61  s and len(type_a
-00001e90: 7267 7329 203d 3d20 323a 0a20 2020 2020  rgs) == 2:.     
-00001ea0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00001eb0: 6e20 7479 7065 5f61 7267 735b 305d 0a0a  n type_args[0]..
-00001ec0: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
-00001ed0: 7065 4572 726f 7228 0a20 2020 2020 2020  peError(.       
-00001ee0: 2020 2020 2066 2252 756e 6e61 626c 6520       f"Runnable 
-00001ef0: 7b73 656c 662e 6765 745f 6e61 6d65 2829  {self.get_name()
-00001f00: 7d20 646f 6573 6e27 7420 6861 7665 2061  } doesn't have a
-00001f10: 6e20 696e 6665 7261 626c 6520 496e 7075  n inferable Inpu
-00001f20: 7454 7970 652e 2022 0a20 2020 2020 2020  tType. ".       
-00001f30: 2020 2020 2022 4f76 6572 7269 6465 2074       "Override t
-00001f40: 6865 2049 6e70 7574 5479 7065 2070 726f  he InputType pro
-00001f50: 7065 7274 7920 746f 2073 7065 6369 6679  perty to specify
-00001f60: 2074 6865 2069 6e70 7574 2074 7970 652e   the input type.
-00001f70: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-00001f80: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00001f90: 6566 204f 7574 7075 7454 7970 6528 7365  ef OutputType(se
-00001fa0: 6c66 2920 2d3e 2054 7970 655b 4f75 7470  lf) -> Type[Outp
-00001fb0: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-00001fc0: 5468 6520 7479 7065 206f 6620 6f75 7470  The type of outp
-00001fd0: 7574 2074 6869 7320 7275 6e6e 6162 6c65  ut this runnable
-00001fe0: 2070 726f 6475 6365 7320 7370 6563 6966   produces specif
-00001ff0: 6965 6420 6173 2061 2074 7970 6520 616e  ied as a type an
-00002000: 6e6f 7461 7469 6f6e 2e22 2222 0a20 2020  notation.""".   
-00002010: 2020 2020 2066 6f72 2063 6c73 2069 6e20       for cls in 
-00002020: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
-00002030: 5f6f 7269 675f 6261 7365 735f 5f3a 2020  _orig_bases__:  
-00002040: 2320 7479 7065 3a20 6967 6e6f 7265 5b61  # type: ignore[a
-00002050: 7474 722d 6465 6669 6e65 645d 0a20 2020  ttr-defined].   
-00002060: 2020 2020 2020 2020 2074 7970 655f 6172           type_ar
-00002070: 6773 203d 2067 6574 5f61 7267 7328 636c  gs = get_args(cl
-00002080: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-00002090: 6620 7479 7065 5f61 7267 7320 616e 6420  f type_args and 
-000020a0: 6c65 6e28 7479 7065 5f61 7267 7329 203d  len(type_args) =
-000020b0: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
-000020c0: 2020 2020 2072 6574 7572 6e20 7479 7065       return type
-000020d0: 5f61 7267 735b 315d 0a0a 2020 2020 2020  _args[1]..      
-000020e0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-000020f0: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
-00002100: 2252 756e 6e61 626c 6520 7b73 656c 662e  "Runnable {self.
-00002110: 6765 745f 6e61 6d65 2829 7d20 646f 6573  get_name()} does
-00002120: 6e27 7420 6861 7665 2061 6e20 696e 6665  n't have an infe
-00002130: 7261 626c 6520 4f75 7470 7574 5479 7065  rable OutputType
-00002140: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00002150: 224f 7665 7272 6964 6520 7468 6520 4f75  "Override the Ou
-00002160: 7470 7574 5479 7065 2070 726f 7065 7274  tputType propert
-00002170: 7920 746f 2073 7065 6369 6679 2074 6865  y to specify the
-00002180: 206f 7574 7075 7420 7479 7065 2e22 0a20   output type.". 
-00002190: 2020 2020 2020 2029 0a0a 2020 2020 4070         )..    @p
-000021a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-000021b0: 696e 7075 745f 7363 6865 6d61 2873 656c  input_schema(sel
-000021c0: 6629 202d 3e20 5479 7065 5b42 6173 654d  f) -> Type[BaseM
-000021d0: 6f64 656c 5d3a 0a20 2020 2020 2020 2022  odel]:.        "
-000021e0: 2222 5468 6520 7479 7065 206f 6620 696e  ""The type of in
-000021f0: 7075 7420 7468 6973 2072 756e 6e61 626c  put this runnabl
-00002200: 6520 6163 6365 7074 7320 7370 6563 6966  e accepts specif
-00002210: 6965 6420 6173 2061 2070 7964 616e 7469  ied as a pydanti
-00002220: 6320 6d6f 6465 6c2e 2222 220a 2020 2020  c model.""".    
-00002230: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00002240: 6765 745f 696e 7075 745f 7363 6865 6d61  get_input_schema
-00002250: 2829 0a0a 2020 2020 6465 6620 6765 745f  ()..    def get_
-00002260: 696e 7075 745f 7363 6865 6d61 280a 2020  input_schema(.  
-00002270: 2020 2020 2020 7365 6c66 2c20 636f 6e66        self, conf
-00002280: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-00002290: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-000022a0: 6f6e 650a 2020 2020 2920 2d3e 2054 7970  one.    ) -> Typ
-000022b0: 655b 4261 7365 4d6f 6465 6c5d 3a0a 2020  e[BaseModel]:.  
-000022c0: 2020 2020 2020 2222 2247 6574 2061 2070        """Get a p
-000022d0: 7964 616e 7469 6320 6d6f 6465 6c20 7468  ydantic model th
-000022e0: 6174 2063 616e 2062 6520 7573 6564 2074  at can be used t
-000022f0: 6f20 7661 6c69 6461 7465 2069 6e70 7574  o validate input
-00002300: 2074 6f20 7468 6520 7275 6e6e 6162 6c65   to the runnable
-00002310: 2e0a 0a20 2020 2020 2020 2052 756e 6e61  ...        Runna
-00002320: 626c 6573 2074 6861 7420 6c65 7665 7261  bles that levera
-00002330: 6765 2074 6865 2063 6f6e 6669 6775 7261  ge the configura
-00002340: 626c 655f 6669 656c 6473 2061 6e64 2063  ble_fields and c
-00002350: 6f6e 6669 6775 7261 626c 655f 616c 7465  onfigurable_alte
-00002360: 726e 6174 6976 6573 0a20 2020 2020 2020  rnatives.       
-00002370: 206d 6574 686f 6473 2077 696c 6c20 6861   methods will ha
-00002380: 7665 2061 2064 796e 616d 6963 2069 6e70  ve a dynamic inp
-00002390: 7574 2073 6368 656d 6120 7468 6174 2064  ut schema that d
-000023a0: 6570 656e 6473 206f 6e20 7768 6963 680a  epends on which.
-000023b0: 2020 2020 2020 2020 636f 6e66 6967 7572          configur
-000023c0: 6174 696f 6e20 7468 6520 7275 6e6e 6162  ation the runnab
-000023d0: 6c65 2069 7320 696e 766f 6b65 6420 7769  le is invoked wi
-000023e0: 7468 2e0a 0a20 2020 2020 2020 2054 6869  th...        Thi
-000023f0: 7320 6d65 7468 6f64 2061 6c6c 6f77 7320  s method allows 
-00002400: 746f 2067 6574 2061 6e20 696e 7075 7420  to get an input 
-00002410: 7363 6865 6d61 2066 6f72 2061 2073 7065  schema for a spe
-00002420: 6369 6669 6320 636f 6e66 6967 7572 6174  cific configurat
-00002430: 696f 6e2e 0a0a 2020 2020 2020 2020 4172  ion...        Ar
-00002440: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00002450: 636f 6e66 6967 3a20 4120 636f 6e66 6967  config: A config
-00002460: 2074 6f20 7573 6520 7768 656e 2067 656e   to use when gen
-00002470: 6572 6174 696e 6720 7468 6520 7363 6865  erating the sche
-00002480: 6d61 2e0a 0a20 2020 2020 2020 2052 6574  ma...        Ret
-00002490: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-000024a0: 2020 4120 7079 6461 6e74 6963 206d 6f64    A pydantic mod
-000024b0: 656c 2074 6861 7420 6361 6e20 6265 2075  el that can be u
-000024c0: 7365 6420 746f 2076 616c 6964 6174 6520  sed to validate 
-000024d0: 696e 7075 742e 0a20 2020 2020 2020 2022  input..        "
-000024e0: 2222 0a20 2020 2020 2020 2072 6f6f 745f  "".        root_
-000024f0: 7479 7065 203d 2073 656c 662e 496e 7075  type = self.Inpu
-00002500: 7454 7970 650a 0a20 2020 2020 2020 2069  tType..        i
-00002510: 6620 696e 7370 6563 742e 6973 636c 6173  f inspect.isclas
-00002520: 7328 726f 6f74 5f74 7970 6529 2061 6e64  s(root_type) and
-00002530: 2069 7373 7562 636c 6173 7328 726f 6f74   issubclass(root
-00002540: 5f74 7970 652c 2042 6173 654d 6f64 656c  _type, BaseModel
-00002550: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00002560: 6574 7572 6e20 726f 6f74 5f74 7970 650a  eturn root_type.
-00002570: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00002580: 6372 6561 7465 5f6d 6f64 656c 280a 2020  create_model(.  
-00002590: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
-000025a0: 6574 5f6e 616d 6528 2249 6e70 7574 2229  et_name("Input")
-000025b0: 2c0a 2020 2020 2020 2020 2020 2020 5f5f  ,.            __
-000025c0: 726f 6f74 5f5f 3d28 726f 6f74 5f74 7970  root__=(root_typ
-000025d0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
-000025e0: 2020 2020 2020 5f5f 636f 6e66 6967 5f5f        __config__
-000025f0: 3d5f 5363 6865 6d61 436f 6e66 6967 2c0a  =_SchemaConfig,.
-00002600: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-00002610: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00002620: 206f 7574 7075 745f 7363 6865 6d61 2873   output_schema(s
-00002630: 656c 6629 202d 3e20 5479 7065 5b42 6173  elf) -> Type[Bas
-00002640: 654d 6f64 656c 5d3a 0a20 2020 2020 2020  eModel]:.       
-00002650: 2022 2222 5468 6520 7479 7065 206f 6620   """The type of 
-00002660: 6f75 7470 7574 2074 6869 7320 7275 6e6e  output this runn
-00002670: 6162 6c65 2070 726f 6475 6365 7320 7370  able produces sp
-00002680: 6563 6966 6965 6420 6173 2061 2070 7964  ecified as a pyd
-00002690: 616e 7469 6320 6d6f 6465 6c2e 2222 220a  antic model.""".
-000026a0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000026b0: 656c 662e 6765 745f 6f75 7470 7574 5f73  elf.get_output_s
-000026c0: 6368 656d 6128 290a 0a20 2020 2064 6566  chema()..    def
-000026d0: 2067 6574 5f6f 7574 7075 745f 7363 6865   get_output_sche
-000026e0: 6d61 280a 2020 2020 2020 2020 7365 6c66  ma(.        self
-000026f0: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
-00002700: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
-00002710: 675d 203d 204e 6f6e 650a 2020 2020 2920  g] = None.    ) 
-00002720: 2d3e 2054 7970 655b 4261 7365 4d6f 6465  -> Type[BaseMode
-00002730: 6c5d 3a0a 2020 2020 2020 2020 2222 2247  l]:.        """G
-00002740: 6574 2061 2070 7964 616e 7469 6320 6d6f  et a pydantic mo
-00002750: 6465 6c20 7468 6174 2063 616e 2062 6520  del that can be 
-00002760: 7573 6564 2074 6f20 7661 6c69 6461 7465  used to validate
-00002770: 206f 7574 7075 7420 746f 2074 6865 2072   output to the r
-00002780: 756e 6e61 626c 652e 0a0a 2020 2020 2020  unnable...      
-00002790: 2020 5275 6e6e 6162 6c65 7320 7468 6174    Runnables that
-000027a0: 206c 6576 6572 6167 6520 7468 6520 636f   leverage the co
-000027b0: 6e66 6967 7572 6162 6c65 5f66 6965 6c64  nfigurable_field
-000027c0: 7320 616e 6420 636f 6e66 6967 7572 6162  s and configurab
-000027d0: 6c65 5f61 6c74 6572 6e61 7469 7665 730a  le_alternatives.
-000027e0: 2020 2020 2020 2020 6d65 7468 6f64 7320          methods 
-000027f0: 7769 6c6c 2068 6176 6520 6120 6479 6e61  will have a dyna
-00002800: 6d69 6320 6f75 7470 7574 2073 6368 656d  mic output schem
-00002810: 6120 7468 6174 2064 6570 656e 6473 206f  a that depends o
-00002820: 6e20 7768 6963 680a 2020 2020 2020 2020  n which.        
-00002830: 636f 6e66 6967 7572 6174 696f 6e20 7468  configuration th
-00002840: 6520 7275 6e6e 6162 6c65 2069 7320 696e  e runnable is in
-00002850: 766f 6b65 6420 7769 7468 2e0a 0a20 2020  voked with...   
-00002860: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
-00002870: 2061 6c6c 6f77 7320 746f 2067 6574 2061   allows to get a
-00002880: 6e20 6f75 7470 7574 2073 6368 656d 6120  n output schema 
-00002890: 666f 7220 6120 7370 6563 6966 6963 2063  for a specific c
-000028a0: 6f6e 6669 6775 7261 7469 6f6e 2e0a 0a20  onfiguration... 
-000028b0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-000028c0: 2020 2020 2020 2020 2063 6f6e 6669 673a           config:
-000028d0: 2041 2063 6f6e 6669 6720 746f 2075 7365   A config to use
-000028e0: 2077 6865 6e20 6765 6e65 7261 7469 6e67   when generating
-000028f0: 2074 6865 2073 6368 656d 612e 0a0a 2020   the schema...  
-00002900: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-00002910: 2020 2020 2020 2020 2020 2041 2070 7964             A pyd
-00002920: 616e 7469 6320 6d6f 6465 6c20 7468 6174  antic model that
-00002930: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
-00002940: 7661 6c69 6461 7465 206f 7574 7075 742e  validate output.
-00002950: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00002960: 2020 2020 2072 6f6f 745f 7479 7065 203d       root_type =
-00002970: 2073 656c 662e 4f75 7470 7574 5479 7065   self.OutputType
-00002980: 0a0a 2020 2020 2020 2020 6966 2069 6e73  ..        if ins
-00002990: 7065 6374 2e69 7363 6c61 7373 2872 6f6f  pect.isclass(roo
-000029a0: 745f 7479 7065 2920 616e 6420 6973 7375  t_type) and issu
-000029b0: 6263 6c61 7373 2872 6f6f 745f 7479 7065  bclass(root_type
-000029c0: 2c20 4261 7365 4d6f 6465 6c29 3a0a 2020  , BaseModel):.  
-000029d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000029e0: 2072 6f6f 745f 7479 7065 0a0a 2020 2020   root_type..    
-000029f0: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
-00002a00: 655f 6d6f 6465 6c28 0a20 2020 2020 2020  e_model(.       
-00002a10: 2020 2020 2073 656c 662e 6765 745f 6e61       self.get_na
-00002a20: 6d65 2822 4f75 7470 7574 2229 2c0a 2020  me("Output"),.  
-00002a30: 2020 2020 2020 2020 2020 5f5f 726f 6f74            __root
-00002a40: 5f5f 3d28 726f 6f74 5f74 7970 652c 204e  __=(root_type, N
-00002a50: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
-00002a60: 2020 5f5f 636f 6e66 6967 5f5f 3d5f 5363    __config__=_Sc
-00002a70: 6865 6d61 436f 6e66 6967 2c0a 2020 2020  hemaConfig,.    
-00002a80: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
-00002a90: 6572 7479 0a20 2020 2064 6566 2063 6f6e  erty.    def con
-00002aa0: 6669 675f 7370 6563 7328 7365 6c66 2920  fig_specs(self) 
-00002ab0: 2d3e 204c 6973 745b 436f 6e66 6967 7572  -> List[Configur
-00002ac0: 6162 6c65 4669 656c 6453 7065 635d 3a0a  ableFieldSpec]:.
-00002ad0: 2020 2020 2020 2020 2222 224c 6973 7420          """List 
-00002ae0: 636f 6e66 6967 7572 6162 6c65 2066 6965  configurable fie
-00002af0: 6c64 7320 666f 7220 7468 6973 2072 756e  lds for this run
-00002b00: 6e61 626c 652e 2222 220a 2020 2020 2020  nable.""".      
-00002b10: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-00002b20: 2064 6566 2063 6f6e 6669 675f 7363 6865   def config_sche
-00002b30: 6d61 280a 2020 2020 2020 2020 7365 6c66  ma(.        self
-00002b40: 2c20 2a2c 2069 6e63 6c75 6465 3a20 4f70  , *, include: Op
-00002b50: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
-00002b60: 7374 725d 5d20 3d20 4e6f 6e65 0a20 2020  str]] = None.   
-00002b70: 2029 202d 3e20 5479 7065 5b42 6173 654d   ) -> Type[BaseM
-00002b80: 6f64 656c 5d3a 0a20 2020 2020 2020 2022  odel]:.        "
-00002b90: 2222 5468 6520 7479 7065 206f 6620 636f  ""The type of co
-00002ba0: 6e66 6967 2074 6869 7320 7275 6e6e 6162  nfig this runnab
-00002bb0: 6c65 2061 6363 6570 7473 2073 7065 6369  le accepts speci
-00002bc0: 6669 6564 2061 7320 6120 7079 6461 6e74  fied as a pydant
-00002bd0: 6963 206d 6f64 656c 2e0a 0a20 2020 2020  ic model...     
-00002be0: 2020 2054 6f20 6d61 726b 2061 2066 6965     To mark a fie
-00002bf0: 6c64 2061 7320 636f 6e66 6967 7572 6162  ld as configurab
-00002c00: 6c65 2c20 7365 6520 7468 6520 6063 6f6e  le, see the `con
-00002c10: 6669 6775 7261 626c 655f 6669 656c 6473  figurable_fields
-00002c20: 600a 2020 2020 2020 2020 616e 6420 6063  `.        and `c
-00002c30: 6f6e 6669 6775 7261 626c 655f 616c 7465  onfigurable_alte
-00002c40: 726e 6174 6976 6573 6020 6d65 7468 6f64  rnatives` method
-00002c50: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
-00002c60: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-00002c70: 636c 7564 653a 2041 206c 6973 7420 6f66  clude: A list of
-00002c80: 2066 6965 6c64 7320 746f 2069 6e63 6c75   fields to inclu
-00002c90: 6465 2069 6e20 7468 6520 636f 6e66 6967  de in the config
-00002ca0: 2073 6368 656d 612e 0a0a 2020 2020 2020   schema...      
-00002cb0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00002cc0: 2020 2020 2020 2041 2070 7964 616e 7469         A pydanti
-00002cd0: 6320 6d6f 6465 6c20 7468 6174 2063 616e  c model that can
-00002ce0: 2062 6520 7573 6564 2074 6f20 7661 6c69   be used to vali
-00002cf0: 6461 7465 2063 6f6e 6669 672e 0a20 2020  date config..   
-00002d00: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-00002d10: 2020 696e 636c 7564 6520 3d20 696e 636c    include = incl
-00002d20: 7564 6520 6f72 205b 5d0a 2020 2020 2020  ude or [].      
-00002d30: 2020 636f 6e66 6967 5f73 7065 6373 203d    config_specs =
-00002d40: 2073 656c 662e 636f 6e66 6967 5f73 7065   self.config_spe
-00002d50: 6373 0a20 2020 2020 2020 2063 6f6e 6669  cs.        confi
-00002d60: 6775 7261 626c 6520 3d20 280a 2020 2020  gurable = (.    
-00002d70: 2020 2020 2020 2020 6372 6561 7465 5f6d          create_m
-00002d80: 6f64 656c 2820 2023 2074 7970 653a 2069  odel(  # type: i
-00002d90: 676e 6f72 655b 6361 6c6c 2d6f 7665 726c  gnore[call-overl
-00002da0: 6f61 645d 0a20 2020 2020 2020 2020 2020  oad].           
-00002db0: 2020 2020 2022 436f 6e66 6967 7572 6162       "Configurab
-00002dc0: 6c65 222c 0a20 2020 2020 2020 2020 2020  le",.           
-00002dd0: 2020 2020 202a 2a7b 0a20 2020 2020 2020       **{.       
-00002de0: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-00002df0: 632e 6964 3a20 280a 2020 2020 2020 2020  c.id: (.        
-00002e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e10: 7370 6563 2e61 6e6e 6f74 6174 696f 6e2c  spec.annotation,
-00002e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002e30: 2020 2020 2020 2020 2046 6965 6c64 280a           Field(.
-00002e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e50: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-00002e60: 2e64 6566 6175 6c74 2c20 7469 746c 653d  .default, title=
-00002e70: 7370 6563 2e6e 616d 652c 2064 6573 6372  spec.name, descr
-00002e80: 6970 7469 6f6e 3d73 7065 632e 6465 7363  iption=spec.desc
-00002e90: 7269 7074 696f 6e0a 2020 2020 2020 2020  ription.        
+000000e0: 6578 740a 6672 6f6d 2066 756e 6374 6f6f  ext.from functoo
+000000f0: 6c73 2069 6d70 6f72 7420 7772 6170 730a  ls import wraps.
+00000100: 6672 6f6d 2069 7465 7274 6f6f 6c73 2069  from itertools i
+00000110: 6d70 6f72 7420 6772 6f75 7062 792c 2074  mport groupby, t
+00000120: 6565 0a66 726f 6d20 6f70 6572 6174 6f72  ee.from operator
+00000130: 2069 6d70 6f72 7420 6974 656d 6765 7474   import itemgett
+00000140: 6572 0a66 726f 6d20 7479 7069 6e67 2069  er.from typing i
+00000150: 6d70 6f72 7420 280a 2020 2020 5459 5045  mport (.    TYPE
+00000160: 5f43 4845 434b 494e 472c 0a20 2020 2041  _CHECKING,.    A
+00000170: 6e79 2c0a 2020 2020 4173 796e 6349 7465  ny,.    AsyncIte
+00000180: 7261 746f 722c 0a20 2020 2041 7761 6974  rator,.    Await
+00000190: 6162 6c65 2c0a 2020 2020 4361 6c6c 6162  able,.    Callab
+000001a0: 6c65 2c0a 2020 2020 436f 726f 7574 696e  le,.    Coroutin
+000001b0: 652c 0a20 2020 2044 6963 742c 0a20 2020  e,.    Dict,.   
+000001c0: 2047 656e 6572 6963 2c0a 2020 2020 4974   Generic,.    It
+000001d0: 6572 6174 6f72 2c0a 2020 2020 4c69 7374  erator,.    List
+000001e0: 2c0a 2020 2020 4d61 7070 696e 672c 0a20  ,.    Mapping,. 
+000001f0: 2020 204f 7074 696f 6e61 6c2c 0a20 2020     Optional,.   
+00000200: 2053 6571 7565 6e63 652c 0a20 2020 2053   Sequence,.    S
+00000210: 6574 2c0a 2020 2020 5475 706c 652c 0a20  et,.    Tuple,. 
+00000220: 2020 2054 7970 652c 0a20 2020 2054 7970     Type,.    Typ
+00000230: 6556 6172 2c0a 2020 2020 556e 696f 6e2c  eVar,.    Union,
+00000240: 0a20 2020 2063 6173 742c 0a20 2020 206f  .    cast,.    o
+00000250: 7665 726c 6f61 642c 0a29 0a0a 6672 6f6d  verload,.)..from
+00000260: 2074 7970 696e 675f 6578 7465 6e73 696f   typing_extensio
+00000270: 6e73 2069 6d70 6f72 7420 4c69 7465 7261  ns import Litera
+00000280: 6c2c 2067 6574 5f61 7267 730a 0a66 726f  l, get_args..fro
+00000290: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+000002a0: 2e5f 6170 6920 696d 706f 7274 2062 6574  ._api import bet
+000002b0: 615f 6465 636f 7261 746f 720a 6672 6f6d  a_decorator.from
+000002c0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+000002d0: 6c6f 6164 2e64 756d 7020 696d 706f 7274  load.dump import
+000002e0: 2064 756d 7064 0a66 726f 6d20 6c61 6e67   dumpd.from lang
+000002f0: 6368 6169 6e5f 636f 7265 2e6c 6f61 642e  chain_core.load.
+00000300: 7365 7269 616c 697a 6162 6c65 2069 6d70  serializable imp
+00000310: 6f72 7420 280a 2020 2020 5365 7269 616c  ort (.    Serial
+00000320: 697a 6162 6c65 2c0a 2020 2020 5365 7269  izable,.    Seri
+00000330: 616c 697a 6564 436f 6e73 7472 7563 746f  alizedConstructo
+00000340: 722c 0a20 2020 2053 6572 6961 6c69 7a65  r,.    Serialize
+00000350: 644e 6f74 496d 706c 656d 656e 7465 642c  dNotImplemented,
+00000360: 0a29 0a66 726f 6d20 6c61 6e67 6368 6169  .).from langchai
+00000370: 6e5f 636f 7265 2e70 7964 616e 7469 635f  n_core.pydantic_
+00000380: 7631 2069 6d70 6f72 7420 4261 7365 4d6f  v1 import BaseMo
+00000390: 6465 6c2c 2046 6965 6c64 0a66 726f 6d20  del, Field.from 
+000003a0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+000003b0: 756e 6e61 626c 6573 2e63 6f6e 6669 6720  unnables.config 
+000003c0: 696d 706f 7274 2028 0a20 2020 2052 756e  import (.    Run
+000003d0: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
+000003e0: 2061 6361 6c6c 5f66 756e 635f 7769 7468   acall_func_with
+000003f0: 5f76 6172 6961 626c 655f 6172 6773 2c0a  _variable_args,.
+00000400: 2020 2020 6361 6c6c 5f66 756e 635f 7769      call_func_wi
+00000410: 7468 5f76 6172 6961 626c 655f 6172 6773  th_variable_args
+00000420: 2c0a 2020 2020 656e 7375 7265 5f63 6f6e  ,.    ensure_con
+00000430: 6669 672c 0a20 2020 2067 6574 5f61 7379  fig,.    get_asy
+00000440: 6e63 5f63 616c 6c62 6163 6b5f 6d61 6e61  nc_callback_mana
+00000450: 6765 725f 666f 725f 636f 6e66 6967 2c0a  ger_for_config,.
+00000460: 2020 2020 6765 745f 6361 6c6c 6261 636b      get_callback
+00000470: 5f6d 616e 6167 6572 5f66 6f72 5f63 6f6e  _manager_for_con
+00000480: 6669 672c 0a20 2020 2067 6574 5f63 6f6e  fig,.    get_con
+00000490: 6669 675f 6c69 7374 2c0a 2020 2020 6765  fig_list,.    ge
+000004a0: 745f 6578 6563 7574 6f72 5f66 6f72 5f63  t_executor_for_c
+000004b0: 6f6e 6669 672c 0a20 2020 206d 6572 6765  onfig,.    merge
+000004c0: 5f63 6f6e 6669 6773 2c0a 2020 2020 7061  _configs,.    pa
+000004d0: 7463 685f 636f 6e66 6967 2c0a 2020 2020  tch_config,.    
+000004e0: 7275 6e5f 696e 5f65 7865 6375 746f 722c  run_in_executor,
+000004f0: 0a20 2020 2076 6172 5f63 6869 6c64 5f72  .    var_child_r
+00000500: 756e 6e61 626c 655f 636f 6e66 6967 2c0a  unnable_config,.
+00000510: 290a 6672 6f6d 206c 616e 6763 6861 696e  ).from langchain
+00000520: 5f63 6f72 652e 7275 6e6e 6162 6c65 732e  _core.runnables.
+00000530: 6772 6170 6820 696d 706f 7274 2047 7261  graph import Gra
+00000540: 7068 0a66 726f 6d20 6c61 6e67 6368 6169  ph.from langchai
+00000550: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+00000560: 2e73 6368 656d 6120 696d 706f 7274 2053  .schema import S
+00000570: 7472 6561 6d45 7665 6e74 0a66 726f 6d20  treamEvent.from 
+00000580: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+00000590: 756e 6e61 626c 6573 2e75 7469 6c73 2069  unnables.utils i
+000005a0: 6d70 6f72 7420 280a 2020 2020 4164 6461  mport (.    Adda
+000005b0: 626c 6544 6963 742c 0a20 2020 2041 6e79  bleDict,.    Any
+000005c0: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
+000005d0: 642c 0a20 2020 2043 6f6e 6669 6775 7261  d,.    Configura
+000005e0: 626c 6546 6965 6c64 2c0a 2020 2020 436f  bleField,.    Co
+000005f0: 6e66 6967 7572 6162 6c65 4669 656c 6453  nfigurableFieldS
+00000600: 7065 632c 0a20 2020 2049 6e70 7574 2c0a  pec,.    Input,.
+00000610: 2020 2020 4f75 7470 7574 2c0a 2020 2020      Output,.    
+00000620: 6163 6365 7074 735f 636f 6e66 6967 2c0a  accepts_config,.
+00000630: 2020 2020 6163 6365 7074 735f 636f 6e74      accepts_cont
+00000640: 6578 742c 0a20 2020 2061 6363 6570 7473  ext,.    accepts
+00000650: 5f72 756e 5f6d 616e 6167 6572 2c0a 2020  _run_manager,.  
+00000660: 2020 6372 6561 7465 5f6d 6f64 656c 2c0a    create_model,.
+00000670: 2020 2020 6761 7468 6572 5f77 6974 685f      gather_with_
+00000680: 636f 6e63 7572 7265 6e63 792c 0a20 2020  concurrency,.   
+00000690: 2067 6574 5f66 756e 6374 696f 6e5f 6669   get_function_fi
+000006a0: 7273 745f 6172 675f 6469 6374 5f6b 6579  rst_arg_dict_key
+000006b0: 732c 0a20 2020 2067 6574 5f66 756e 6374  s,.    get_funct
+000006c0: 696f 6e5f 6e6f 6e6c 6f63 616c 732c 0a20  ion_nonlocals,. 
+000006d0: 2020 2067 6574 5f6c 616d 6264 615f 736f     get_lambda_so
+000006e0: 7572 6365 2c0a 2020 2020 6765 745f 756e  urce,.    get_un
+000006f0: 6971 7565 5f63 6f6e 6669 675f 7370 6563  ique_config_spec
+00000700: 732c 0a20 2020 2069 6e64 656e 745f 6c69  s,.    indent_li
+00000710: 6e65 735f 6166 7465 725f 6669 7273 742c  nes_after_first,
+00000720: 0a20 2020 2069 735f 6173 796e 635f 6361  .    is_async_ca
+00000730: 6c6c 6162 6c65 2c0a 2020 2020 6973 5f61  llable,.    is_a
+00000740: 7379 6e63 5f67 656e 6572 6174 6f72 2c0a  sync_generator,.
+00000750: 290a 6672 6f6d 206c 616e 6763 6861 696e  ).from langchain
+00000760: 5f63 6f72 652e 7574 696c 732e 6169 7465  _core.utils.aite
+00000770: 7220 696d 706f 7274 2061 7465 652c 2070  r import atee, p
+00000780: 795f 616e 6578 740a 6672 6f6d 206c 616e  y_anext.from lan
+00000790: 6763 6861 696e 5f63 6f72 652e 7574 696c  gchain_core.util
+000007a0: 732e 6974 6572 2069 6d70 6f72 7420 7361  s.iter import sa
+000007b0: 6665 7465 650a 0a69 6620 5459 5045 5f43  fetee..if TYPE_C
+000007c0: 4845 434b 494e 473a 0a20 2020 2066 726f  HECKING:.    fro
+000007d0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+000007e0: 2e63 616c 6c62 6163 6b73 2e6d 616e 6167  .callbacks.manag
+000007f0: 6572 2069 6d70 6f72 7420 280a 2020 2020  er import (.    
+00000800: 2020 2020 4173 796e 6343 616c 6c62 6163      AsyncCallbac
+00000810: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00000820: 5275 6e2c 0a20 2020 2020 2020 2043 616c  Run,.        Cal
+00000830: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
+00000840: 6861 696e 5275 6e2c 0a20 2020 2029 0a20  hainRun,.    ). 
+00000850: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+00000860: 6e5f 636f 7265 2e70 726f 6d70 7473 2e62  n_core.prompts.b
+00000870: 6173 6520 696d 706f 7274 2042 6173 6550  ase import BaseP
+00000880: 726f 6d70 7454 656d 706c 6174 650a 2020  romptTemplate.  
+00000890: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+000008a0: 5f63 6f72 652e 7275 6e6e 6162 6c65 732e  _core.runnables.
+000008b0: 6661 6c6c 6261 636b 7320 696d 706f 7274  fallbacks import
+000008c0: 2028 0a20 2020 2020 2020 2052 756e 6e61   (.        Runna
+000008d0: 626c 6557 6974 6846 616c 6c62 6163 6b73  bleWithFallbacks
+000008e0: 2061 7320 5275 6e6e 6162 6c65 5769 7468   as RunnableWith
+000008f0: 4661 6c6c 6261 636b 7354 2c0a 2020 2020  FallbacksT,.    
+00000900: 290a 2020 2020 6672 6f6d 206c 616e 6763  ).    from langc
+00000910: 6861 696e 5f63 6f72 652e 7472 6163 6572  hain_core.tracer
+00000920: 732e 6c6f 675f 7374 7265 616d 2069 6d70  s.log_stream imp
+00000930: 6f72 7420 280a 2020 2020 2020 2020 5275  ort (.        Ru
+00000940: 6e4c 6f67 2c0a 2020 2020 2020 2020 5275  nLog,.        Ru
+00000950: 6e4c 6f67 5061 7463 682c 0a20 2020 2029  nLogPatch,.    )
+00000960: 0a20 2020 2066 726f 6d20 6c61 6e67 6368  .    from langch
+00000970: 6169 6e5f 636f 7265 2e74 7261 6365 7273  ain_core.tracers
+00000980: 2e73 6368 656d 6173 2069 6d70 6f72 7420  .schemas import 
+00000990: 5275 6e0a 0a0a 4f74 6865 7220 3d20 5479  Run...Other = Ty
+000009a0: 7065 5661 7228 224f 7468 6572 2229 0a0a  peVar("Other")..
+000009b0: 0a63 6c61 7373 2052 756e 6e61 626c 6528  .class Runnable(
+000009c0: 4765 6e65 7269 635b 496e 7075 742c 204f  Generic[Input, O
+000009d0: 7574 7075 745d 2c20 4142 4329 3a0a 2020  utput], ABC):.  
+000009e0: 2020 2222 2241 2075 6e69 7420 6f66 2077    """A unit of w
+000009f0: 6f72 6b20 7468 6174 2063 616e 2062 6520  ork that can be 
+00000a00: 696e 766f 6b65 642c 2062 6174 6368 6564  invoked, batched
+00000a10: 2c20 7374 7265 616d 6564 2c20 7472 616e  , streamed, tran
+00000a20: 7366 6f72 6d65 6420 616e 6420 636f 6d70  sformed and comp
+00000a30: 6f73 6564 2e0a 0a20 2020 2020 4b65 7920  osed...     Key 
+00000a40: 4d65 7468 6f64 730a 2020 2020 203d 3d3d  Methods.     ===
+00000a50: 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020 2d20  ========..    - 
+00000a60: 2a2a 696e 766f 6b65 2f61 696e 766f 6b65  **invoke/ainvoke
+00000a70: 2a2a 3a20 5472 616e 7366 6f72 6d73 2061  **: Transforms a
+00000a80: 2073 696e 676c 6520 696e 7075 7420 696e   single input in
+00000a90: 746f 2061 6e20 6f75 7470 7574 2e0a 2020  to an output..  
+00000aa0: 2020 2d20 2a2a 6261 7463 682f 6162 6174    - **batch/abat
+00000ab0: 6368 2a2a 3a20 4566 6669 6369 656e 746c  ch**: Efficientl
+00000ac0: 7920 7472 616e 7366 6f72 6d73 206d 756c  y transforms mul
+00000ad0: 7469 706c 6520 696e 7075 7473 2069 6e74  tiple inputs int
+00000ae0: 6f20 6f75 7470 7574 732e 0a20 2020 202d  o outputs..    -
+00000af0: 202a 2a73 7472 6561 6d2f 6173 7472 6561   **stream/astrea
+00000b00: 6d2a 2a3a 2053 7472 6561 6d73 206f 7574  m**: Streams out
+00000b10: 7075 7420 6672 6f6d 2061 2073 696e 676c  put from a singl
+00000b20: 6520 696e 7075 7420 6173 2069 7427 7320  e input as it's 
+00000b30: 7072 6f64 7563 6564 2e0a 2020 2020 2d20  produced..    - 
+00000b40: 2a2a 6173 7472 6561 6d5f 6c6f 672a 2a3a  **astream_log**:
+00000b50: 2053 7472 6561 6d73 206f 7574 7075 7420   Streams output 
+00000b60: 616e 6420 7365 6c65 6374 6564 2069 6e74  and selected int
+00000b70: 6572 6d65 6469 6174 6520 7265 7375 6c74  ermediate result
+00000b80: 7320 6672 6f6d 2061 6e20 696e 7075 742e  s from an input.
+00000b90: 0a0a 2020 2020 4275 696c 742d 696e 206f  ..    Built-in o
+00000ba0: 7074 696d 697a 6174 696f 6e73 3a0a 0a20  ptimizations:.. 
+00000bb0: 2020 202d 202a 2a42 6174 6368 2a2a 3a20     - **Batch**: 
+00000bc0: 4279 2064 6566 6175 6c74 2c20 6261 7463  By default, batc
+00000bd0: 6820 7275 6e73 2069 6e76 6f6b 6528 2920  h runs invoke() 
+00000be0: 696e 2070 6172 616c 6c65 6c20 7573 696e  in parallel usin
+00000bf0: 6720 6120 7468 7265 6164 2070 6f6f 6c20  g a thread pool 
+00000c00: 6578 6563 7574 6f72 2e0a 2020 2020 2020  executor..      
+00000c10: 2020 2020 2020 204f 7665 7272 6964 6520         Override 
+00000c20: 746f 206f 7074 696d 697a 6520 6261 7463  to optimize batc
+00000c30: 6869 6e67 2e0a 0a20 2020 202d 202a 2a41  hing...    - **A
+00000c40: 7379 6e63 2a2a 3a20 4d65 7468 6f64 7320  sync**: Methods 
+00000c50: 7769 7468 2022 6122 2073 7566 6669 7820  with "a" suffix 
+00000c60: 6172 6520 6173 796e 6368 726f 6e6f 7573  are asynchronous
+00000c70: 2e20 4279 2064 6566 6175 6c74 2c20 7468  . By default, th
+00000c80: 6579 2065 7865 6375 7465 0a20 2020 2020  ey execute.     
+00000c90: 2020 2020 2020 2020 7468 6520 7379 6e63          the sync
+00000ca0: 2063 6f75 6e74 6572 7061 7274 2075 7369   counterpart usi
+00000cb0: 6e67 2061 7379 6e63 696f 2773 2074 6872  ng asyncio's thr
+00000cc0: 6561 6420 706f 6f6c 2e0a 2020 2020 2020  ead pool..      
+00000cd0: 2020 2020 2020 204f 7665 7272 6964 6520         Override 
+00000ce0: 666f 7220 6e61 7469 7665 2061 7379 6e63  for native async
+00000cf0: 2e0a 0a20 2020 2041 6c6c 206d 6574 686f  ...    All metho
+00000d00: 6473 2061 6363 6570 7420 616e 206f 7074  ds accept an opt
+00000d10: 696f 6e61 6c20 636f 6e66 6967 2061 7267  ional config arg
+00000d20: 756d 656e 742c 2077 6869 6368 2063 616e  ument, which can
+00000d30: 2062 6520 7573 6564 2074 6f20 636f 6e66   be used to conf
+00000d40: 6967 7572 650a 2020 2020 6578 6563 7574  igure.    execut
+00000d50: 696f 6e2c 2061 6464 2074 6167 7320 616e  ion, add tags an
+00000d60: 6420 6d65 7461 6461 7461 2066 6f72 2074  d metadata for t
+00000d70: 7261 6369 6e67 2061 6e64 2064 6562 7567  racing and debug
+00000d80: 6769 6e67 2065 7463 2e0a 0a20 2020 2052  ging etc...    R
+00000d90: 756e 6e61 626c 6573 2065 7870 6f73 6520  unnables expose 
+00000da0: 7363 6865 6d61 7469 6320 696e 666f 726d  schematic inform
+00000db0: 6174 696f 6e20 6162 6f75 7420 7468 6569  ation about thei
+00000dc0: 7220 696e 7075 742c 206f 7574 7075 7420  r input, output 
+00000dd0: 616e 6420 636f 6e66 6967 2076 6961 0a20  and config via. 
+00000de0: 2020 2074 6865 2069 6e70 7574 5f73 6368     the input_sch
+00000df0: 656d 6120 7072 6f70 6572 7479 2c20 7468  ema property, th
+00000e00: 6520 6f75 7470 7574 5f73 6368 656d 6120  e output_schema 
+00000e10: 7072 6f70 6572 7479 2061 6e64 2063 6f6e  property and con
+00000e20: 6669 675f 7363 6865 6d61 206d 6574 686f  fig_schema metho
+00000e30: 642e 0a0a 2020 2020 4c43 454c 2061 6e64  d...    LCEL and
+00000e40: 2043 6f6d 706f 7369 7469 6f6e 0a20 2020   Composition.   
+00000e50: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00000e60: 3d3d 3d3d 3d0a 0a20 2020 2054 6865 204c  =====..    The L
+00000e70: 616e 6743 6861 696e 2045 7870 7265 7373  angChain Express
+00000e80: 696f 6e20 4c61 6e67 7561 6765 2028 4c43  ion Language (LC
+00000e90: 454c 2920 6973 2061 2064 6563 6c61 7261  EL) is a declara
+00000ea0: 7469 7665 2077 6179 2074 6f20 636f 6d70  tive way to comp
+00000eb0: 6f73 6520 5275 6e6e 6162 6c65 730a 2020  ose Runnables.  
+00000ec0: 2020 696e 746f 2063 6861 696e 732e 2041    into chains. A
+00000ed0: 6e79 2063 6861 696e 2063 6f6e 7374 7275  ny chain constru
+00000ee0: 6374 6564 2074 6869 7320 7761 7920 7769  cted this way wi
+00000ef0: 6c6c 2061 7574 6f6d 6174 6963 616c 6c79  ll automatically
+00000f00: 2068 6176 6520 7379 6e63 2c20 6173 796e   have sync, asyn
+00000f10: 632c 0a20 2020 2062 6174 6368 2c20 616e  c,.    batch, an
+00000f20: 6420 7374 7265 616d 696e 6720 7375 7070  d streaming supp
+00000f30: 6f72 742e 0a0a 2020 2020 5468 6520 6d61  ort...    The ma
+00000f40: 696e 2063 6f6d 706f 7369 7469 6f6e 2070  in composition p
+00000f50: 7269 6d69 7469 7665 7320 6172 6520 5275  rimitives are Ru
+00000f60: 6e6e 6162 6c65 5365 7175 656e 6365 2061  nnableSequence a
+00000f70: 6e64 2052 756e 6e61 626c 6550 6172 616c  nd RunnableParal
+00000f80: 6c65 6c2e 0a0a 2020 2020 5275 6e6e 6162  lel...    Runnab
+00000f90: 6c65 5365 7175 656e 6365 2069 6e76 6f6b  leSequence invok
+00000fa0: 6573 2061 2073 6572 6965 7320 6f66 2072  es a series of r
+00000fb0: 756e 6e61 626c 6573 2073 6571 7565 6e74  unnables sequent
+00000fc0: 6961 6c6c 792c 2077 6974 6820 6f6e 6520  ially, with one 
+00000fd0: 7275 6e6e 6162 6c65 2773 0a20 2020 206f  runnable's.    o
+00000fe0: 7574 7075 7420 7365 7276 696e 6720 6173  utput serving as
+00000ff0: 2074 6865 206e 6578 7427 7320 696e 7075   the next's inpu
+00001000: 742e 2043 6f6e 7374 7275 6374 2075 7369  t. Construct usi
+00001010: 6e67 2074 6865 2060 7c60 206f 7065 7261  ng the `|` opera
+00001020: 746f 7220 6f72 2062 790a 2020 2020 7061  tor or by.    pa
+00001030: 7373 696e 6720 6120 6c69 7374 206f 6620  ssing a list of 
+00001040: 7275 6e6e 6162 6c65 7320 746f 2052 756e  runnables to Run
+00001050: 6e61 626c 6553 6571 7565 6e63 652e 0a0a  nableSequence...
+00001060: 2020 2020 5275 6e6e 6162 6c65 5061 7261      RunnablePara
+00001070: 6c6c 656c 2069 6e76 6f6b 6573 2072 756e  llel invokes run
+00001080: 6e61 626c 6573 2063 6f6e 6375 7272 656e  nables concurren
+00001090: 746c 792c 2070 726f 7669 6469 6e67 2074  tly, providing t
+000010a0: 6865 2073 616d 6520 696e 7075 740a 2020  he same input.  
+000010b0: 2020 746f 2065 6163 682e 2043 6f6e 7374    to each. Const
+000010c0: 7275 6374 2069 7420 7573 696e 6720 6120  ruct it using a 
+000010d0: 6469 6374 206c 6974 6572 616c 2077 6974  dict literal wit
+000010e0: 6869 6e20 6120 7365 7175 656e 6365 206f  hin a sequence o
+000010f0: 7220 6279 2070 6173 7369 6e67 2061 0a20  r by passing a. 
+00001100: 2020 2064 6963 7420 746f 2052 756e 6e61     dict to Runna
+00001110: 626c 6550 6172 616c 6c65 6c2e 0a0a 0a20  bleParallel.... 
+00001120: 2020 2046 6f72 2065 7861 6d70 6c65 2c0a     For example,.
+00001130: 0a20 2020 202e 2e20 636f 6465 2d62 6c6f  .    .. code-blo
+00001140: 636b 3a3a 2070 7974 686f 6e0a 0a20 2020  ck:: python..   
+00001150: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00001160: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
+00001170: 6573 2069 6d70 6f72 7420 5275 6e6e 6162  es import Runnab
+00001180: 6c65 4c61 6d62 6461 0a0a 2020 2020 2020  leLambda..      
+00001190: 2020 2320 4120 5275 6e6e 6162 6c65 5365    # A RunnableSe
+000011a0: 7175 656e 6365 2063 6f6e 7374 7275 6374  quence construct
+000011b0: 6564 2075 7369 6e67 2074 6865 2060 7c60  ed using the `|`
+000011c0: 206f 7065 7261 746f 720a 2020 2020 2020   operator.      
+000011d0: 2020 7365 7175 656e 6365 203d 2052 756e    sequence = Run
+000011e0: 6e61 626c 654c 616d 6264 6128 6c61 6d62  nableLambda(lamb
+000011f0: 6461 2078 3a20 7820 2b20 3129 207c 2052  da x: x + 1) | R
+00001200: 756e 6e61 626c 654c 616d 6264 6128 6c61  unnableLambda(la
+00001210: 6d62 6461 2078 3a20 7820 2a20 3229 0a20  mbda x: x * 2). 
+00001220: 2020 2020 2020 2073 6571 7565 6e63 652e         sequence.
+00001230: 696e 766f 6b65 2831 2920 2320 340a 2020  invoke(1) # 4.  
+00001240: 2020 2020 2020 7365 7175 656e 6365 2e62        sequence.b
+00001250: 6174 6368 285b 312c 2032 2c20 335d 2920  atch([1, 2, 3]) 
+00001260: 2320 5b34 2c20 362c 2038 5d0a 0a0a 2020  # [4, 6, 8]...  
+00001270: 2020 2020 2020 2320 4120 7365 7175 656e        # A sequen
+00001280: 6365 2074 6861 7420 636f 6e74 6169 6e73  ce that contains
+00001290: 2061 2052 756e 6e61 626c 6550 6172 616c   a RunnableParal
+000012a0: 6c65 6c20 636f 6e73 7472 7563 7465 6420  lel constructed 
+000012b0: 7573 696e 6720 6120 6469 6374 206c 6974  using a dict lit
+000012c0: 6572 616c 0a20 2020 2020 2020 2073 6571  eral.        seq
+000012d0: 7565 6e63 6520 3d20 5275 6e6e 6162 6c65  uence = Runnable
+000012e0: 4c61 6d62 6461 286c 616d 6264 6120 783a  Lambda(lambda x:
+000012f0: 2078 202b 2031 2920 7c20 7b0a 2020 2020   x + 1) | {.    
+00001300: 2020 2020 2020 2020 276d 756c 5f32 273a          'mul_2':
+00001310: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
+00001320: 6c61 6d62 6461 2078 3a20 7820 2a20 3229  lambda x: x * 2)
+00001330: 2c0a 2020 2020 2020 2020 2020 2020 276d  ,.            'm
+00001340: 756c 5f35 273a 2052 756e 6e61 626c 654c  ul_5': RunnableL
+00001350: 616d 6264 6128 6c61 6d62 6461 2078 3a20  ambda(lambda x: 
+00001360: 7820 2a20 3529 0a20 2020 2020 2020 207d  x * 5).        }
+00001370: 0a20 2020 2020 2020 2073 6571 7565 6e63  .        sequenc
+00001380: 652e 696e 766f 6b65 2831 2920 2320 7b27  e.invoke(1) # {'
+00001390: 6d75 6c5f 3227 3a20 342c 2027 6d75 6c5f  mul_2': 4, 'mul_
+000013a0: 3527 3a20 3130 7d0a 0a20 2020 2053 7461  5': 10}..    Sta
+000013b0: 6e64 6172 6420 4d65 7468 6f64 730a 2020  ndard Methods.  
+000013c0: 2020 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d    ==============
+000013d0: 3d3d 0a0a 2020 2020 416c 6c20 5275 6e6e  ==..    All Runn
+000013e0: 6162 6c65 7320 6578 706f 7365 2061 6464  ables expose add
+000013f0: 6974 696f 6e61 6c20 6d65 7468 6f64 7320  itional methods 
+00001400: 7468 6174 2063 616e 2062 6520 7573 6564  that can be used
+00001410: 2074 6f20 6d6f 6469 6679 2074 6865 6972   to modify their
+00001420: 2062 6568 6176 696f 720a 2020 2020 2865   behavior.    (e
+00001430: 2e67 2e2c 2061 6464 2061 2072 6574 7279  .g., add a retry
+00001440: 2070 6f6c 6963 792c 2061 6464 206c 6966   policy, add lif
+00001450: 6563 7963 6c65 206c 6973 7465 6e65 7273  ecycle listeners
+00001460: 2c20 6d61 6b65 2074 6865 6d20 636f 6e66  , make them conf
+00001470: 6967 7572 6162 6c65 2c20 6574 632e 292e  igurable, etc.).
+00001480: 0a0a 2020 2020 5468 6573 6520 6d65 7468  ..    These meth
+00001490: 6f64 7320 7769 6c6c 2077 6f72 6b20 6f6e  ods will work on
+000014a0: 2061 6e79 2052 756e 6e61 626c 652c 2069   any Runnable, i
+000014b0: 6e63 6c75 6469 6e67 2052 756e 6e61 626c  ncluding Runnabl
+000014c0: 6520 6368 6169 6e73 2063 6f6e 7374 7275  e chains constru
+000014d0: 6374 6564 0a20 2020 2062 7920 636f 6d70  cted.    by comp
+000014e0: 6f73 696e 6720 6f74 6865 7220 5275 6e6e  osing other Runn
+000014f0: 6162 6c65 732e 2053 6565 2074 6865 2069  ables. See the i
+00001500: 6e64 6976 6964 7561 6c20 6d65 7468 6f64  ndividual method
+00001510: 7320 666f 7220 6465 7461 696c 732e 0a0a  s for details...
+00001520: 2020 2020 466f 7220 6578 616d 706c 652c      For example,
+00001530: 0a0a 2020 2020 2e2e 2063 6f64 652d 626c  ..    .. code-bl
+00001540: 6f63 6b3a 3a20 7079 7468 6f6e 0a0a 2020  ock:: python..  
+00001550: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+00001560: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
+00001570: 6c65 7320 696d 706f 7274 2052 756e 6e61  les import Runna
+00001580: 626c 654c 616d 6264 610a 0a20 2020 2020  bleLambda..     
+00001590: 2020 2069 6d70 6f72 7420 7261 6e64 6f6d     import random
+000015a0: 0a0a 2020 2020 2020 2020 6465 6620 6164  ..        def ad
+000015b0: 645f 6f6e 6528 783a 2069 6e74 2920 2d3e  d_one(x: int) ->
+000015c0: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
+000015d0: 2020 7265 7475 726e 2078 202b 2031 0a0a    return x + 1..
+000015e0: 0a20 2020 2020 2020 2064 6566 2062 7567  .        def bug
+000015f0: 6779 5f64 6f75 626c 6528 793a 2069 6e74  gy_double(y: int
+00001600: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+00001610: 2020 2020 2020 2727 2742 7567 6779 2063        '''Buggy c
+00001620: 6f64 6520 7468 6174 2077 696c 6c20 6661  ode that will fa
+00001630: 696c 2037 3025 206f 6620 7468 6520 7469  il 70% of the ti
+00001640: 6d65 2727 270a 2020 2020 2020 2020 2020  me'''.          
+00001650: 2020 6966 2072 616e 646f 6d2e 7261 6e64    if random.rand
+00001660: 6f6d 2829 203e 2030 2e33 3a0a 2020 2020  om() > 0.3:.    
+00001670: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00001680: 7428 2754 6869 7320 636f 6465 2066 6169  t('This code fai
+00001690: 6c65 642c 2061 6e64 2077 696c 6c20 7072  led, and will pr
+000016a0: 6f62 6162 6c79 2062 6520 7265 7472 6965  obably be retrie
+000016b0: 6421 2729 2020 2320 6e6f 7161 3a20 5432  d!')  # noqa: T2
+000016c0: 3031 0a20 2020 2020 2020 2020 2020 2020  01.             
+000016d0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000016e0: 726f 7228 2754 7269 6767 6572 6564 2062  ror('Triggered b
+000016f0: 7567 6779 2063 6f64 6527 290a 2020 2020  uggy code').    
+00001700: 2020 2020 2020 2020 7265 7475 726e 2079          return y
+00001710: 202a 2032 0a0a 2020 2020 2020 2020 7365   * 2..        se
+00001720: 7175 656e 6365 203d 2028 0a20 2020 2020  quence = (.     
+00001730: 2020 2020 2020 2052 756e 6e61 626c 654c         RunnableL
+00001740: 616d 6264 6128 6164 645f 6f6e 6529 207c  ambda(add_one) |
+00001750: 0a20 2020 2020 2020 2020 2020 2052 756e  .            Run
+00001760: 6e61 626c 654c 616d 6264 6128 6275 6767  nableLambda(bugg
+00001770: 795f 646f 7562 6c65 292e 7769 7468 5f72  y_double).with_r
+00001780: 6574 7279 2820 2320 5265 7472 7920 6f6e  etry( # Retry on
+00001790: 2066 6169 6c75 7265 0a20 2020 2020 2020   failure.       
+000017a0: 2020 2020 2020 2020 2073 746f 705f 6166           stop_af
+000017b0: 7465 725f 6174 7465 6d70 743d 3130 2c0a  ter_attempt=10,.
+000017c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000017d0: 7761 6974 5f65 7870 6f6e 656e 7469 616c  wait_exponential
+000017e0: 5f6a 6974 7465 723d 4661 6c73 650a 2020  _jitter=False.  
+000017f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00001800: 2020 2020 290a 0a20 2020 2020 2020 2070      )..        p
+00001810: 7269 6e74 2873 6571 7565 6e63 652e 696e  rint(sequence.in
+00001820: 7075 745f 7363 6865 6d61 2e73 6368 656d  put_schema.schem
+00001830: 6128 2929 2023 2053 686f 7720 696e 6665  a()) # Show infe
+00001840: 7272 6564 2069 6e70 7574 2073 6368 656d  rred input schem
+00001850: 610a 2020 2020 2020 2020 7072 696e 7428  a.        print(
+00001860: 7365 7175 656e 6365 2e6f 7574 7075 745f  sequence.output_
+00001870: 7363 6865 6d61 2e73 6368 656d 6128 2929  schema.schema())
+00001880: 2023 2053 686f 7720 696e 6665 7272 6564   # Show inferred
+00001890: 206f 7574 7075 7420 7363 6865 6d61 0a20   output schema. 
+000018a0: 2020 2020 2020 2070 7269 6e74 2873 6571         print(seq
+000018b0: 7565 6e63 652e 696e 766f 6b65 2832 2929  uence.invoke(2))
+000018c0: 2023 2069 6e76 6f6b 6520 7468 6520 7365   # invoke the se
+000018d0: 7175 656e 6365 2028 6e6f 7465 2074 6865  quence (note the
+000018e0: 2072 6574 7279 2061 626f 7665 2121 290a   retry above!!).
+000018f0: 0a20 2020 2044 6562 7567 6769 6e67 2061  .    Debugging a
+00001900: 6e64 2074 7261 6369 6e67 0a20 2020 203d  nd tracing.    =
+00001910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00001920: 3d3d 3d3d 0a0a 2020 2020 4173 2074 6865  ====..    As the
+00001930: 2063 6861 696e 7320 6765 7420 6c6f 6e67   chains get long
+00001940: 6572 2c20 6974 2063 616e 2062 6520 7573  er, it can be us
+00001950: 6566 756c 2074 6f20 6265 2061 626c 6520  eful to be able 
+00001960: 746f 2073 6565 2069 6e74 6572 6d65 6469  to see intermedi
+00001970: 6174 6520 7265 7375 6c74 730a 2020 2020  ate results.    
+00001980: 746f 2064 6562 7567 2061 6e64 2074 7261  to debug and tra
+00001990: 6365 2074 6865 2063 6861 696e 2e0a 0a20  ce the chain... 
+000019a0: 2020 2059 6f75 2063 616e 2073 6574 2074     You can set t
+000019b0: 6865 2067 6c6f 6261 6c20 6465 6275 6720  he global debug 
+000019c0: 666c 6167 2074 6f20 5472 7565 2074 6f20  flag to True to 
+000019d0: 656e 6162 6c65 2064 6562 7567 206f 7574  enable debug out
+000019e0: 7075 7420 666f 7220 616c 6c20 6368 6169  put for all chai
+000019f0: 6e73 3a0a 0a20 2020 2020 2020 202e 2e20  ns:..        .. 
+00001a00: 636f 6465 2d62 6c6f 636b 3a3a 2070 7974  code-block:: pyt
+00001a10: 686f 6e0a 0a20 2020 2020 2020 2020 2020  hon..           
+00001a20: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+00001a30: 636f 7265 2e67 6c6f 6261 6c73 2069 6d70  core.globals imp
+00001a40: 6f72 7420 7365 745f 6465 6275 670a 2020  ort set_debug.  
+00001a50: 2020 2020 2020 2020 2020 7365 745f 6465            set_de
+00001a60: 6275 6728 5472 7565 290a 0a20 2020 2041  bug(True)..    A
+00001a70: 6c74 6572 6e61 7469 7665 6c79 2c20 796f  lternatively, yo
+00001a80: 7520 6361 6e20 7061 7373 2065 7869 7374  u can pass exist
+00001a90: 696e 6720 6f72 2063 7573 746f 6d20 6361  ing or custom ca
+00001aa0: 6c6c 6261 636b 7320 746f 2061 6e79 2067  llbacks to any g
+00001ab0: 6976 656e 2063 6861 696e 3a0a 0a20 2020  iven chain:..   
+00001ac0: 2020 2020 202e 2e20 636f 6465 2d62 6c6f       .. code-blo
+00001ad0: 636b 3a3a 2070 7974 686f 6e0a 0a20 2020  ck:: python..   
+00001ae0: 2020 2020 2020 2020 2066 726f 6d20 6c61           from la
+00001af0: 6e67 6368 6169 6e5f 636f 7265 2e74 7261  ngchain_core.tra
+00001b00: 6365 7273 2069 6d70 6f72 7420 436f 6e73  cers import Cons
+00001b10: 6f6c 6543 616c 6c62 6163 6b48 616e 646c  oleCallbackHandl
+00001b20: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
+00001b30: 6368 6169 6e2e 696e 766f 6b65 280a 2020  chain.invoke(.  
+00001b40: 2020 2020 2020 2020 2020 2020 2020 2e2e                ..
+00001b50: 2e2c 0a20 2020 2020 2020 2020 2020 2020  .,.             
+00001b60: 2020 2063 6f6e 6669 673d 7b27 6361 6c6c     config={'call
+00001b70: 6261 636b 7327 3a20 5b43 6f6e 736f 6c65  backs': [Console
+00001b80: 4361 6c6c 6261 636b 4861 6e64 6c65 7228  CallbackHandler(
+00001b90: 295d 7d0a 2020 2020 2020 2020 2020 2020  )]}.            
+00001ba0: 290a 0a20 2020 2046 6f72 2061 2055 4920  )..    For a UI 
+00001bb0: 2861 6e64 206d 7563 6820 6d6f 7265 2920  (and much more) 
+00001bc0: 6368 6563 6b6f 7574 204c 616e 6753 6d69  checkout LangSmi
+00001bd0: 7468 3a20 6874 7470 733a 2f2f 646f 6373  th: https://docs
+00001be0: 2e73 6d69 7468 2e6c 616e 6763 6861 696e  .smith.langchain
+00001bf0: 2e63 6f6d 2f0a 2020 2020 2222 2220 2023  .com/.    """  #
+00001c00: 206e 6f71 613a 2045 3530 310a 0a20 2020   noqa: E501..   
+00001c10: 206e 616d 653a 204f 7074 696f 6e61 6c5b   name: Optional[
+00001c20: 7374 725d 203d 204e 6f6e 650a 2020 2020  str] = None.    
+00001c30: 2222 2254 6865 206e 616d 6520 6f66 2074  """The name of t
+00001c40: 6865 2072 756e 6e61 626c 652e 2055 7365  he runnable. Use
+00001c50: 6420 666f 7220 6465 6275 6767 696e 6720  d for debugging 
+00001c60: 616e 6420 7472 6163 696e 672e 2222 220a  and tracing.""".
+00001c70: 0a20 2020 2064 6566 2067 6574 5f6e 616d  .    def get_nam
+00001c80: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+00001c90: 2073 7566 6669 783a 204f 7074 696f 6e61   suffix: Optiona
+00001ca0: 6c5b 7374 725d 203d 204e 6f6e 652c 202a  l[str] = None, *
+00001cb0: 2c20 6e61 6d65 3a20 4f70 7469 6f6e 616c  , name: Optional
+00001cc0: 5b73 7472 5d20 3d20 4e6f 6e65 0a20 2020  [str] = None.   
+00001cd0: 2029 202d 3e20 7374 723a 0a20 2020 2020   ) -> str:.     
+00001ce0: 2020 2022 2222 4765 7420 7468 6520 6e61     """Get the na
+00001cf0: 6d65 206f 6620 7468 6520 7275 6e6e 6162  me of the runnab
+00001d00: 6c65 2e22 2222 0a20 2020 2020 2020 206e  le.""".        n
+00001d10: 616d 6520 3d20 6e61 6d65 206f 7220 7365  ame = name or se
+00001d20: 6c66 2e6e 616d 6520 6f72 2073 656c 662e  lf.name or self.
+00001d30: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
+00001d40: 5f5f 0a20 2020 2020 2020 2069 6620 7375  __.        if su
+00001d50: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
+00001d60: 2020 6966 206e 616d 655b 305d 2e69 7375    if name[0].isu
+00001d70: 7070 6572 2829 3a0a 2020 2020 2020 2020  pper():.        
+00001d80: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+00001d90: 616d 6520 2b20 7375 6666 6978 2e74 6974  ame + suffix.tit
+00001da0: 6c65 2829 0a20 2020 2020 2020 2020 2020  le().           
+00001db0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00001dc0: 2020 2020 2020 2072 6574 7572 6e20 6e61         return na
+00001dd0: 6d65 202b 2022 5f22 202b 2073 7566 6669  me + "_" + suffi
+00001de0: 782e 6c6f 7765 7228 290a 2020 2020 2020  x.lower().      
+00001df0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00001e00: 2020 2020 7265 7475 726e 206e 616d 650a      return name.
+00001e10: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00001e20: 2020 2064 6566 2049 6e70 7574 5479 7065     def InputType
+00001e30: 2873 656c 6629 202d 3e20 5479 7065 5b49  (self) -> Type[I
+00001e40: 6e70 7574 5d3a 0a20 2020 2020 2020 2022  nput]:.        "
+00001e50: 2222 5468 6520 7479 7065 206f 6620 696e  ""The type of in
+00001e60: 7075 7420 7468 6973 2072 756e 6e61 626c  put this runnabl
+00001e70: 6520 6163 6365 7074 7320 7370 6563 6966  e accepts specif
+00001e80: 6965 6420 6173 2061 2074 7970 6520 616e  ied as a type an
+00001e90: 6e6f 7461 7469 6f6e 2e22 2222 0a20 2020  notation.""".   
+00001ea0: 2020 2020 2066 6f72 2063 6c73 2069 6e20       for cls in 
+00001eb0: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
+00001ec0: 5f6f 7269 675f 6261 7365 735f 5f3a 2020  _orig_bases__:  
+00001ed0: 2320 7479 7065 3a20 6967 6e6f 7265 5b61  # type: ignore[a
+00001ee0: 7474 722d 6465 6669 6e65 645d 0a20 2020  ttr-defined].   
+00001ef0: 2020 2020 2020 2020 2074 7970 655f 6172           type_ar
+00001f00: 6773 203d 2067 6574 5f61 7267 7328 636c  gs = get_args(cl
+00001f10: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
+00001f20: 6620 7479 7065 5f61 7267 7320 616e 6420  f type_args and 
+00001f30: 6c65 6e28 7479 7065 5f61 7267 7329 203d  len(type_args) =
+00001f40: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
+00001f50: 2020 2020 2072 6574 7572 6e20 7479 7065       return type
+00001f60: 5f61 7267 735b 305d 0a0a 2020 2020 2020  _args[0]..      
+00001f70: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
+00001f80: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
+00001f90: 2252 756e 6e61 626c 6520 7b73 656c 662e  "Runnable {self.
+00001fa0: 6765 745f 6e61 6d65 2829 7d20 646f 6573  get_name()} does
+00001fb0: 6e27 7420 6861 7665 2061 6e20 696e 6665  n't have an infe
+00001fc0: 7261 626c 6520 496e 7075 7454 7970 652e  rable InputType.
+00001fd0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+00001fe0: 4f76 6572 7269 6465 2074 6865 2049 6e70  Override the Inp
+00001ff0: 7574 5479 7065 2070 726f 7065 7274 7920  utType property 
+00002000: 746f 2073 7065 6369 6679 2074 6865 2069  to specify the i
+00002010: 6e70 7574 2074 7970 652e 220a 2020 2020  nput type.".    
+00002020: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
+00002030: 6572 7479 0a20 2020 2064 6566 204f 7574  erty.    def Out
+00002040: 7075 7454 7970 6528 7365 6c66 2920 2d3e  putType(self) ->
+00002050: 2054 7970 655b 4f75 7470 7574 5d3a 0a20   Type[Output]:. 
+00002060: 2020 2020 2020 2022 2222 5468 6520 7479         """The ty
+00002070: 7065 206f 6620 6f75 7470 7574 2074 6869  pe of output thi
+00002080: 7320 7275 6e6e 6162 6c65 2070 726f 6475  s runnable produ
+00002090: 6365 7320 7370 6563 6966 6965 6420 6173  ces specified as
+000020a0: 2061 2074 7970 6520 616e 6e6f 7461 7469   a type annotati
+000020b0: 6f6e 2e22 2222 0a20 2020 2020 2020 2066  on.""".        f
+000020c0: 6f72 2063 6c73 2069 6e20 7365 6c66 2e5f  or cls in self._
+000020d0: 5f63 6c61 7373 5f5f 2e5f 5f6f 7269 675f  _class__.__orig_
+000020e0: 6261 7365 735f 5f3a 2020 2320 7479 7065  bases__:  # type
+000020f0: 3a20 6967 6e6f 7265 5b61 7474 722d 6465  : ignore[attr-de
+00002100: 6669 6e65 645d 0a20 2020 2020 2020 2020  fined].         
+00002110: 2020 2074 7970 655f 6172 6773 203d 2067     type_args = g
+00002120: 6574 5f61 7267 7328 636c 7329 0a20 2020  et_args(cls).   
+00002130: 2020 2020 2020 2020 2069 6620 7479 7065           if type
+00002140: 5f61 7267 7320 616e 6420 6c65 6e28 7479  _args and len(ty
+00002150: 7065 5f61 7267 7329 203d 3d20 323a 0a20  pe_args) == 2:. 
+00002160: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00002170: 6574 7572 6e20 7479 7065 5f61 7267 735b  eturn type_args[
+00002180: 315d 0a0a 2020 2020 2020 2020 7261 6973  1]..        rais
+00002190: 6520 5479 7065 4572 726f 7228 0a20 2020  e TypeError(.   
+000021a0: 2020 2020 2020 2020 2066 2252 756e 6e61           f"Runna
+000021b0: 626c 6520 7b73 656c 662e 6765 745f 6e61  ble {self.get_na
+000021c0: 6d65 2829 7d20 646f 6573 6e27 7420 6861  me()} doesn't ha
+000021d0: 7665 2061 6e20 696e 6665 7261 626c 6520  ve an inferable 
+000021e0: 4f75 7470 7574 5479 7065 2e20 220a 2020  OutputType. ".  
+000021f0: 2020 2020 2020 2020 2020 224f 7665 7272            "Overr
+00002200: 6964 6520 7468 6520 4f75 7470 7574 5479  ide the OutputTy
+00002210: 7065 2070 726f 7065 7274 7920 746f 2073  pe property to s
+00002220: 7065 6369 6679 2074 6865 206f 7574 7075  pecify the outpu
+00002230: 7420 7479 7065 2e22 0a20 2020 2020 2020  t type.".       
+00002240: 2029 0a0a 2020 2020 4070 726f 7065 7274   )..    @propert
+00002250: 790a 2020 2020 6465 6620 696e 7075 745f  y.    def input_
+00002260: 7363 6865 6d61 2873 656c 6629 202d 3e20  schema(self) -> 
+00002270: 5479 7065 5b42 6173 654d 6f64 656c 5d3a  Type[BaseModel]:
+00002280: 0a20 2020 2020 2020 2022 2222 5468 6520  .        """The 
+00002290: 7479 7065 206f 6620 696e 7075 7420 7468  type of input th
+000022a0: 6973 2072 756e 6e61 626c 6520 6163 6365  is runnable acce
+000022b0: 7074 7320 7370 6563 6966 6965 6420 6173  pts specified as
+000022c0: 2061 2070 7964 616e 7469 6320 6d6f 6465   a pydantic mode
+000022d0: 6c2e 2222 220a 2020 2020 2020 2020 7265  l.""".        re
+000022e0: 7475 726e 2073 656c 662e 6765 745f 696e  turn self.get_in
+000022f0: 7075 745f 7363 6865 6d61 2829 0a0a 2020  put_schema()..  
+00002300: 2020 6465 6620 6765 745f 696e 7075 745f    def get_input_
+00002310: 7363 6865 6d61 280a 2020 2020 2020 2020  schema(.        
+00002320: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
+00002330: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+00002340: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
+00002350: 2020 2920 2d3e 2054 7970 655b 4261 7365    ) -> Type[Base
+00002360: 4d6f 6465 6c5d 3a0a 2020 2020 2020 2020  Model]:.        
+00002370: 2222 2247 6574 2061 2070 7964 616e 7469  """Get a pydanti
+00002380: 6320 6d6f 6465 6c20 7468 6174 2063 616e  c model that can
+00002390: 2062 6520 7573 6564 2074 6f20 7661 6c69   be used to vali
+000023a0: 6461 7465 2069 6e70 7574 2074 6f20 7468  date input to th
+000023b0: 6520 7275 6e6e 6162 6c65 2e0a 0a20 2020  e runnable...   
+000023c0: 2020 2020 2052 756e 6e61 626c 6573 2074       Runnables t
+000023d0: 6861 7420 6c65 7665 7261 6765 2074 6865  hat leverage the
+000023e0: 2063 6f6e 6669 6775 7261 626c 655f 6669   configurable_fi
+000023f0: 656c 6473 2061 6e64 2063 6f6e 6669 6775  elds and configu
+00002400: 7261 626c 655f 616c 7465 726e 6174 6976  rable_alternativ
+00002410: 6573 0a20 2020 2020 2020 206d 6574 686f  es.        metho
+00002420: 6473 2077 696c 6c20 6861 7665 2061 2064  ds will have a d
+00002430: 796e 616d 6963 2069 6e70 7574 2073 6368  ynamic input sch
+00002440: 656d 6120 7468 6174 2064 6570 656e 6473  ema that depends
+00002450: 206f 6e20 7768 6963 680a 2020 2020 2020   on which.      
+00002460: 2020 636f 6e66 6967 7572 6174 696f 6e20    configuration 
+00002470: 7468 6520 7275 6e6e 6162 6c65 2069 7320  the runnable is 
+00002480: 696e 766f 6b65 6420 7769 7468 2e0a 0a20  invoked with... 
+00002490: 2020 2020 2020 2054 6869 7320 6d65 7468         This meth
+000024a0: 6f64 2061 6c6c 6f77 7320 746f 2067 6574  od allows to get
+000024b0: 2061 6e20 696e 7075 7420 7363 6865 6d61   an input schema
+000024c0: 2066 6f72 2061 2073 7065 6369 6669 6320   for a specific 
+000024d0: 636f 6e66 6967 7572 6174 696f 6e2e 0a0a  configuration...
+000024e0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+000024f0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00002500: 3a20 4120 636f 6e66 6967 2074 6f20 7573  : A config to us
+00002510: 6520 7768 656e 2067 656e 6572 6174 696e  e when generatin
+00002520: 6720 7468 6520 7363 6865 6d61 2e0a 0a20  g the schema... 
+00002530: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00002540: 2020 2020 2020 2020 2020 2020 4120 7079              A py
+00002550: 6461 6e74 6963 206d 6f64 656c 2074 6861  dantic model tha
+00002560: 7420 6361 6e20 6265 2075 7365 6420 746f  t can be used to
+00002570: 2076 616c 6964 6174 6520 696e 7075 742e   validate input.
+00002580: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00002590: 2020 2020 2072 6f6f 745f 7479 7065 203d       root_type =
+000025a0: 2073 656c 662e 496e 7075 7454 7970 650a   self.InputType.
+000025b0: 0a20 2020 2020 2020 2069 6620 696e 7370  .        if insp
+000025c0: 6563 742e 6973 636c 6173 7328 726f 6f74  ect.isclass(root
+000025d0: 5f74 7970 6529 2061 6e64 2069 7373 7562  _type) and issub
+000025e0: 636c 6173 7328 726f 6f74 5f74 7970 652c  class(root_type,
+000025f0: 2042 6173 654d 6f64 656c 293a 0a20 2020   BaseModel):.   
+00002600: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00002610: 726f 6f74 5f74 7970 650a 0a20 2020 2020  root_type..     
+00002620: 2020 2072 6574 7572 6e20 6372 6561 7465     return create
+00002630: 5f6d 6f64 656c 280a 2020 2020 2020 2020  _model(.        
+00002640: 2020 2020 7365 6c66 2e67 6574 5f6e 616d      self.get_nam
+00002650: 6528 2249 6e70 7574 2229 2c0a 2020 2020  e("Input"),.    
+00002660: 2020 2020 2020 2020 5f5f 726f 6f74 5f5f          __root__
+00002670: 3d28 726f 6f74 5f74 7970 652c 204e 6f6e  =(root_type, Non
+00002680: 6529 2c0a 2020 2020 2020 2020 290a 0a20  e),.        ).. 
+00002690: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+000026a0: 2064 6566 206f 7574 7075 745f 7363 6865   def output_sche
+000026b0: 6d61 2873 656c 6629 202d 3e20 5479 7065  ma(self) -> Type
+000026c0: 5b42 6173 654d 6f64 656c 5d3a 0a20 2020  [BaseModel]:.   
+000026d0: 2020 2020 2022 2222 5468 6520 7479 7065       """The type
+000026e0: 206f 6620 6f75 7470 7574 2074 6869 7320   of output this 
+000026f0: 7275 6e6e 6162 6c65 2070 726f 6475 6365  runnable produce
+00002700: 7320 7370 6563 6966 6965 6420 6173 2061  s specified as a
+00002710: 2070 7964 616e 7469 6320 6d6f 6465 6c2e   pydantic model.
+00002720: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00002730: 726e 2073 656c 662e 6765 745f 6f75 7470  rn self.get_outp
+00002740: 7574 5f73 6368 656d 6128 290a 0a20 2020  ut_schema()..   
+00002750: 2064 6566 2067 6574 5f6f 7574 7075 745f   def get_output_
+00002760: 7363 6865 6d61 280a 2020 2020 2020 2020  schema(.        
+00002770: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
+00002780: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+00002790: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
+000027a0: 2020 2920 2d3e 2054 7970 655b 4261 7365    ) -> Type[Base
+000027b0: 4d6f 6465 6c5d 3a0a 2020 2020 2020 2020  Model]:.        
+000027c0: 2222 2247 6574 2061 2070 7964 616e 7469  """Get a pydanti
+000027d0: 6320 6d6f 6465 6c20 7468 6174 2063 616e  c model that can
+000027e0: 2062 6520 7573 6564 2074 6f20 7661 6c69   be used to vali
+000027f0: 6461 7465 206f 7574 7075 7420 746f 2074  date output to t
+00002800: 6865 2072 756e 6e61 626c 652e 0a0a 2020  he runnable...  
+00002810: 2020 2020 2020 5275 6e6e 6162 6c65 7320        Runnables 
+00002820: 7468 6174 206c 6576 6572 6167 6520 7468  that leverage th
+00002830: 6520 636f 6e66 6967 7572 6162 6c65 5f66  e configurable_f
+00002840: 6965 6c64 7320 616e 6420 636f 6e66 6967  ields and config
+00002850: 7572 6162 6c65 5f61 6c74 6572 6e61 7469  urable_alternati
+00002860: 7665 730a 2020 2020 2020 2020 6d65 7468  ves.        meth
+00002870: 6f64 7320 7769 6c6c 2068 6176 6520 6120  ods will have a 
+00002880: 6479 6e61 6d69 6320 6f75 7470 7574 2073  dynamic output s
+00002890: 6368 656d 6120 7468 6174 2064 6570 656e  chema that depen
+000028a0: 6473 206f 6e20 7768 6963 680a 2020 2020  ds on which.    
+000028b0: 2020 2020 636f 6e66 6967 7572 6174 696f      configuratio
+000028c0: 6e20 7468 6520 7275 6e6e 6162 6c65 2069  n the runnable i
+000028d0: 7320 696e 766f 6b65 6420 7769 7468 2e0a  s invoked with..
+000028e0: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
+000028f0: 7468 6f64 2061 6c6c 6f77 7320 746f 2067  thod allows to g
+00002900: 6574 2061 6e20 6f75 7470 7574 2073 6368  et an output sch
+00002910: 656d 6120 666f 7220 6120 7370 6563 6966  ema for a specif
+00002920: 6963 2063 6f6e 6669 6775 7261 7469 6f6e  ic configuration
+00002930: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00002940: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00002950: 6669 673a 2041 2063 6f6e 6669 6720 746f  fig: A config to
+00002960: 2075 7365 2077 6865 6e20 6765 6e65 7261   use when genera
+00002970: 7469 6e67 2074 6865 2073 6368 656d 612e  ting the schema.
+00002980: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00002990: 733a 0a20 2020 2020 2020 2020 2020 2041  s:.            A
+000029a0: 2070 7964 616e 7469 6320 6d6f 6465 6c20   pydantic model 
+000029b0: 7468 6174 2063 616e 2062 6520 7573 6564  that can be used
+000029c0: 2074 6f20 7661 6c69 6461 7465 206f 7574   to validate out
+000029d0: 7075 742e 0a20 2020 2020 2020 2022 2222  put..        """
+000029e0: 0a20 2020 2020 2020 2072 6f6f 745f 7479  .        root_ty
+000029f0: 7065 203d 2073 656c 662e 4f75 7470 7574  pe = self.Output
+00002a00: 5479 7065 0a0a 2020 2020 2020 2020 6966  Type..        if
+00002a10: 2069 6e73 7065 6374 2e69 7363 6c61 7373   inspect.isclass
+00002a20: 2872 6f6f 745f 7479 7065 2920 616e 6420  (root_type) and 
+00002a30: 6973 7375 6263 6c61 7373 2872 6f6f 745f  issubclass(root_
+00002a40: 7479 7065 2c20 4261 7365 4d6f 6465 6c29  type, BaseModel)
+00002a50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00002a60: 7475 726e 2072 6f6f 745f 7479 7065 0a0a  turn root_type..
+00002a70: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00002a80: 7265 6174 655f 6d6f 6465 6c28 0a20 2020  reate_model(.   
+00002a90: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
+00002aa0: 745f 6e61 6d65 2822 4f75 7470 7574 2229  t_name("Output")
+00002ab0: 2c0a 2020 2020 2020 2020 2020 2020 5f5f  ,.            __
+00002ac0: 726f 6f74 5f5f 3d28 726f 6f74 5f74 7970  root__=(root_typ
+00002ad0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
+00002ae0: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
+00002af0: 7479 0a20 2020 2064 6566 2063 6f6e 6669  ty.    def confi
+00002b00: 675f 7370 6563 7328 7365 6c66 2920 2d3e  g_specs(self) ->
+00002b10: 204c 6973 745b 436f 6e66 6967 7572 6162   List[Configurab
+00002b20: 6c65 4669 656c 6453 7065 635d 3a0a 2020  leFieldSpec]:.  
+00002b30: 2020 2020 2020 2222 224c 6973 7420 636f        """List co
+00002b40: 6e66 6967 7572 6162 6c65 2066 6965 6c64  nfigurable field
+00002b50: 7320 666f 7220 7468 6973 2072 756e 6e61  s for this runna
+00002b60: 626c 652e 2222 220a 2020 2020 2020 2020  ble.""".        
+00002b70: 7265 7475 726e 205b 5d0a 0a20 2020 2064  return []..    d
+00002b80: 6566 2063 6f6e 6669 675f 7363 6865 6d61  ef config_schema
+00002b90: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00002ba0: 2a2c 2069 6e63 6c75 6465 3a20 4f70 7469  *, include: Opti
+00002bb0: 6f6e 616c 5b53 6571 7565 6e63 655b 7374  onal[Sequence[st
+00002bc0: 725d 5d20 3d20 4e6f 6e65 0a20 2020 2029  r]] = None.    )
+00002bd0: 202d 3e20 5479 7065 5b42 6173 654d 6f64   -> Type[BaseMod
+00002be0: 656c 5d3a 0a20 2020 2020 2020 2022 2222  el]:.        """
+00002bf0: 5468 6520 7479 7065 206f 6620 636f 6e66  The type of conf
+00002c00: 6967 2074 6869 7320 7275 6e6e 6162 6c65  ig this runnable
+00002c10: 2061 6363 6570 7473 2073 7065 6369 6669   accepts specifi
+00002c20: 6564 2061 7320 6120 7079 6461 6e74 6963  ed as a pydantic
+00002c30: 206d 6f64 656c 2e0a 0a20 2020 2020 2020   model...       
+00002c40: 2054 6f20 6d61 726b 2061 2066 6965 6c64   To mark a field
+00002c50: 2061 7320 636f 6e66 6967 7572 6162 6c65   as configurable
+00002c60: 2c20 7365 6520 7468 6520 6063 6f6e 6669  , see the `confi
+00002c70: 6775 7261 626c 655f 6669 656c 6473 600a  gurable_fields`.
+00002c80: 2020 2020 2020 2020 616e 6420 6063 6f6e          and `con
+00002c90: 6669 6775 7261 626c 655f 616c 7465 726e  figurable_altern
+00002ca0: 6174 6976 6573 6020 6d65 7468 6f64 732e  atives` methods.
+00002cb0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00002cc0: 2020 2020 2020 2020 2020 2020 696e 636c              incl
+00002cd0: 7564 653a 2041 206c 6973 7420 6f66 2066  ude: A list of f
+00002ce0: 6965 6c64 7320 746f 2069 6e63 6c75 6465  ields to include
+00002cf0: 2069 6e20 7468 6520 636f 6e66 6967 2073   in the config s
+00002d00: 6368 656d 612e 0a0a 2020 2020 2020 2020  chema...        
+00002d10: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00002d20: 2020 2020 2041 2070 7964 616e 7469 6320       A pydantic 
+00002d30: 6d6f 6465 6c20 7468 6174 2063 616e 2062  model that can b
+00002d40: 6520 7573 6564 2074 6f20 7661 6c69 6461  e used to valida
+00002d50: 7465 2063 6f6e 6669 672e 0a20 2020 2020  te config..     
+00002d60: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00002d70: 696e 636c 7564 6520 3d20 696e 636c 7564  include = includ
+00002d80: 6520 6f72 205b 5d0a 2020 2020 2020 2020  e or [].        
+00002d90: 636f 6e66 6967 5f73 7065 6373 203d 2073  config_specs = s
+00002da0: 656c 662e 636f 6e66 6967 5f73 7065 6373  elf.config_specs
+00002db0: 0a20 2020 2020 2020 2063 6f6e 6669 6775  .        configu
+00002dc0: 7261 626c 6520 3d20 280a 2020 2020 2020  rable = (.      
+00002dd0: 2020 2020 2020 6372 6561 7465 5f6d 6f64        create_mod
+00002de0: 656c 2820 2023 2074 7970 653a 2069 676e  el(  # type: ign
+00002df0: 6f72 655b 6361 6c6c 2d6f 7665 726c 6f61  ore[call-overloa
+00002e00: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+00002e10: 2020 2022 436f 6e66 6967 7572 6162 6c65     "Configurable
+00002e20: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00002e30: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
+00002e40: 2020 2020 2020 2020 2020 2073 7065 632e             spec.
+00002e50: 6964 3a20 280a 2020 2020 2020 2020 2020  id: (.          
+00002e60: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+00002e70: 6563 2e61 6e6e 6f74 6174 696f 6e2c 0a20  ec.annotation,. 
+00002e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e90: 2020 2020 2020 2046 6965 6c64 280a 2020         Field(.  
 00002ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002eb0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00002ec0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00002ed0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00002ee0: 2073 7065 6320 696e 2063 6f6e 6669 675f   spec in config_
-00002ef0: 7370 6563 730a 2020 2020 2020 2020 2020  specs.          
-00002f00: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00002f10: 2020 2020 2020 2020 205f 5f63 6f6e 6669           __confi
-00002f20: 675f 5f3d 5f53 6368 656d 6143 6f6e 6669  g__=_SchemaConfi
-00002f30: 672c 0a20 2020 2020 2020 2020 2020 2029  g,.            )
-00002f40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00002f50: 636f 6e66 6967 5f73 7065 6373 0a20 2020  config_specs.   
-00002f60: 2020 2020 2020 2020 2065 6c73 6520 4e6f           else No
-00002f70: 6e65 0a20 2020 2020 2020 2029 0a0a 2020  ne.        )..  
-00002f80: 2020 2020 2020 7265 7475 726e 2063 7265        return cre
-00002f90: 6174 655f 6d6f 6465 6c28 2020 2320 7479  ate_model(  # ty
-00002fa0: 7065 3a20 6967 6e6f 7265 5b63 616c 6c2d  pe: ignore[call-
-00002fb0: 6f76 6572 6c6f 6164 5d0a 2020 2020 2020  overload].      
-00002fc0: 2020 2020 2020 7365 6c66 2e67 6574 5f6e        self.get_n
-00002fd0: 616d 6528 2243 6f6e 6669 6722 292c 0a20  ame("Config"),. 
-00002fe0: 2020 2020 2020 2020 2020 205f 5f63 6f6e             __con
-00002ff0: 6669 675f 5f3d 5f53 6368 656d 6143 6f6e  fig__=_SchemaCon
-00003000: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
-00003010: 202a 2a28 7b22 636f 6e66 6967 7572 6162   **({"configurab
-00003020: 6c65 223a 2028 636f 6e66 6967 7572 6162  le": (configurab
-00003030: 6c65 2c20 4e6f 6e65 297d 2069 6620 636f  le, None)} if co
-00003040: 6e66 6967 7572 6162 6c65 2065 6c73 6520  nfigurable else 
-00003050: 7b7d 292c 0a20 2020 2020 2020 2020 2020  {}),.           
-00003060: 202a 2a7b 0a20 2020 2020 2020 2020 2020   **{.           
-00003070: 2020 2020 2066 6965 6c64 5f6e 616d 653a       field_name:
-00003080: 2028 6669 656c 645f 7479 7065 2c20 4e6f   (field_type, No
-00003090: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-000030a0: 2020 2020 666f 7220 6669 656c 645f 6e61      for field_na
-000030b0: 6d65 2c20 6669 656c 645f 7479 7065 2069  me, field_type i
-000030c0: 6e20 5275 6e6e 6162 6c65 436f 6e66 6967  n RunnableConfig
-000030d0: 2e5f 5f61 6e6e 6f74 6174 696f 6e73 5f5f  .__annotations__
-000030e0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-000030f0: 2020 2020 2020 2020 2069 6620 6669 656c           if fiel
-00003100: 645f 6e61 6d65 2069 6e20 5b69 2066 6f72  d_name in [i for
-00003110: 2069 2069 6e20 696e 636c 7564 6520 6966   i in include if
-00003120: 2069 2021 3d20 2263 6f6e 6669 6775 7261   i != "configura
-00003130: 626c 6522 5d0a 2020 2020 2020 2020 2020  ble"].          
-00003140: 2020 7d2c 0a20 2020 2020 2020 2029 0a0a    },.        )..
-00003150: 2020 2020 6465 6620 6765 745f 6772 6170      def get_grap
-00003160: 6828 7365 6c66 2c20 636f 6e66 6967 3a20  h(self, config: 
-00003170: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-00003180: 6543 6f6e 6669 675d 203d 204e 6f6e 6529  eConfig] = None)
-00003190: 202d 3e20 4772 6170 683a 0a20 2020 2020   -> Graph:.     
-000031a0: 2020 2022 2222 5265 7475 726e 2061 2067     """Return a g
-000031b0: 7261 7068 2072 6570 7265 7365 6e74 6174  raph representat
-000031c0: 696f 6e20 6f66 2074 6869 7320 7275 6e6e  ion of this runn
-000031d0: 6162 6c65 2e22 2222 0a20 2020 2020 2020  able.""".       
-000031e0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
-000031f0: 636f 7265 2e72 756e 6e61 626c 6573 2e67  core.runnables.g
-00003200: 7261 7068 2069 6d70 6f72 7420 4772 6170  raph import Grap
-00003210: 680a 0a20 2020 2020 2020 2067 7261 7068  h..        graph
-00003220: 203d 2047 7261 7068 2829 0a20 2020 2020   = Graph().     
-00003230: 2020 2069 6e70 7574 5f6e 6f64 6520 3d20     input_node = 
-00003240: 6772 6170 682e 6164 645f 6e6f 6465 2873  graph.add_node(s
-00003250: 656c 662e 6765 745f 696e 7075 745f 7363  elf.get_input_sc
-00003260: 6865 6d61 2863 6f6e 6669 6729 290a 2020  hema(config)).  
-00003270: 2020 2020 2020 7275 6e6e 6162 6c65 5f6e        runnable_n
-00003280: 6f64 6520 3d20 6772 6170 682e 6164 645f  ode = graph.add_
-00003290: 6e6f 6465 2873 656c 6629 0a20 2020 2020  node(self).     
-000032a0: 2020 206f 7574 7075 745f 6e6f 6465 203d     output_node =
-000032b0: 2067 7261 7068 2e61 6464 5f6e 6f64 6528   graph.add_node(
-000032c0: 7365 6c66 2e67 6574 5f6f 7574 7075 745f  self.get_output_
-000032d0: 7363 6865 6d61 2863 6f6e 6669 6729 290a  schema(config)).
-000032e0: 2020 2020 2020 2020 6772 6170 682e 6164          graph.ad
-000032f0: 645f 6564 6765 2869 6e70 7574 5f6e 6f64  d_edge(input_nod
-00003300: 652c 2072 756e 6e61 626c 655f 6e6f 6465  e, runnable_node
-00003310: 290a 2020 2020 2020 2020 6772 6170 682e  ).        graph.
-00003320: 6164 645f 6564 6765 2872 756e 6e61 626c  add_edge(runnabl
-00003330: 655f 6e6f 6465 2c20 6f75 7470 7574 5f6e  e_node, output_n
-00003340: 6f64 6529 0a20 2020 2020 2020 2072 6574  ode).        ret
-00003350: 7572 6e20 6772 6170 680a 0a20 2020 2064  urn graph..    d
-00003360: 6566 2067 6574 5f70 726f 6d70 7473 280a  ef get_prompts(.
-00003370: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
-00003380: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-00003390: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-000033a0: 204e 6f6e 650a 2020 2020 2920 2d3e 204c   None.    ) -> L
-000033b0: 6973 745b 4261 7365 5072 6f6d 7074 5465  ist[BasePromptTe
-000033c0: 6d70 6c61 7465 5d3a 0a20 2020 2020 2020  mplate]:.       
-000033d0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
-000033e0: 636f 7265 2e70 726f 6d70 7473 2e62 6173  core.prompts.bas
-000033f0: 6520 696d 706f 7274 2042 6173 6550 726f  e import BasePro
-00003400: 6d70 7454 656d 706c 6174 650a 0a20 2020  mptTemplate..   
-00003410: 2020 2020 2070 726f 6d70 7473 203d 205b       prompts = [
-00003420: 5d0a 2020 2020 2020 2020 666f 7220 5f2c  ].        for _,
-00003430: 206e 6f64 6520 696e 2073 656c 662e 6765   node in self.ge
-00003440: 745f 6772 6170 6828 636f 6e66 6967 3d63  t_graph(config=c
-00003450: 6f6e 6669 6729 2e6e 6f64 6573 2e69 7465  onfig).nodes.ite
-00003460: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00003470: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00003480: 6e6f 6465 2e64 6174 612c 2042 6173 6550  node.data, BaseP
-00003490: 726f 6d70 7454 656d 706c 6174 6529 3a0a  romptTemplate):.
-000034a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034b0: 7072 6f6d 7074 732e 6170 7065 6e64 286e  prompts.append(n
-000034c0: 6f64 652e 6461 7461 290a 2020 2020 2020  ode.data).      
-000034d0: 2020 7265 7475 726e 2070 726f 6d70 7473    return prompts
-000034e0: 0a0a 2020 2020 6465 6620 5f5f 6f72 5f5f  ..    def __or__
-000034f0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00003500: 2020 2020 2020 2020 6f74 6865 723a 2055          other: U
-00003510: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
-00003520: 2020 5275 6e6e 6162 6c65 5b41 6e79 2c20    Runnable[Any, 
-00003530: 4f74 6865 725d 2c0a 2020 2020 2020 2020  Other],.        
-00003540: 2020 2020 4361 6c6c 6162 6c65 5b5b 416e      Callable[[An
-00003550: 795d 2c20 4f74 6865 725d 2c0a 2020 2020  y], Other],.    
-00003560: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00003570: 5b5b 4974 6572 6174 6f72 5b41 6e79 5d5d  [[Iterator[Any]]
-00003580: 2c20 4974 6572 6174 6f72 5b4f 7468 6572  , Iterator[Other
-00003590: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-000035a0: 4d61 7070 696e 675b 7374 722c 2055 6e69  Mapping[str, Uni
-000035b0: 6f6e 5b52 756e 6e61 626c 655b 416e 792c  on[Runnable[Any,
-000035c0: 204f 7468 6572 5d2c 2043 616c 6c61 626c   Other], Callabl
-000035d0: 655b 5b41 6e79 5d2c 204f 7468 6572 5d2c  e[[Any], Other],
-000035e0: 2041 6e79 5d5d 2c0a 2020 2020 2020 2020   Any]],.        
-000035f0: 5d2c 0a20 2020 2029 202d 3e20 5275 6e6e  ],.    ) -> Runn
-00003600: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
-00003610: 5b49 6e70 7574 2c20 4f74 6865 725d 3a0a  [Input, Other]:.
-00003620: 2020 2020 2020 2020 2222 2243 6f6d 706f          """Compo
-00003630: 7365 2074 6869 7320 7275 6e6e 6162 6c65  se this runnable
-00003640: 2077 6974 6820 616e 6f74 6865 7220 6f62   with another ob
-00003650: 6a65 6374 2074 6f20 6372 6561 7465 2061  ject to create a
-00003660: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
-00003670: 652e 2222 220a 2020 2020 2020 2020 7265  e.""".        re
-00003680: 7475 726e 2052 756e 6e61 626c 6553 6571  turn RunnableSeq
-00003690: 7565 6e63 6528 7365 6c66 2c20 636f 6572  uence(self, coer
-000036a0: 6365 5f74 6f5f 7275 6e6e 6162 6c65 286f  ce_to_runnable(o
-000036b0: 7468 6572 2929 0a0a 2020 2020 6465 6620  ther))..    def 
-000036c0: 5f5f 726f 725f 5f28 0a20 2020 2020 2020  __ror__(.       
-000036d0: 2073 656c 662c 0a20 2020 2020 2020 206f   self,.        o
-000036e0: 7468 6572 3a20 556e 696f 6e5b 0a20 2020  ther: Union[.   
-000036f0: 2020 2020 2020 2020 2052 756e 6e61 626c           Runnabl
-00003700: 655b 4f74 6865 722c 2041 6e79 5d2c 0a20  e[Other, Any],. 
-00003710: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-00003720: 626c 655b 5b4f 7468 6572 5d2c 2041 6e79  ble[[Other], Any
-00003730: 5d2c 0a20 2020 2020 2020 2020 2020 2043  ],.            C
-00003740: 616c 6c61 626c 655b 5b49 7465 7261 746f  allable[[Iterato
-00003750: 725b 4f74 6865 725d 5d2c 2049 7465 7261  r[Other]], Itera
-00003760: 746f 725b 416e 795d 5d2c 0a20 2020 2020  tor[Any]],.     
-00003770: 2020 2020 2020 204d 6170 7069 6e67 5b73         Mapping[s
-00003780: 7472 2c20 556e 696f 6e5b 5275 6e6e 6162  tr, Union[Runnab
-00003790: 6c65 5b4f 7468 6572 2c20 416e 795d 2c20  le[Other, Any], 
-000037a0: 4361 6c6c 6162 6c65 5b5b 4f74 6865 725d  Callable[[Other]
-000037b0: 2c20 416e 795d 2c20 416e 795d 5d2c 0a20  , Any], Any]],. 
-000037c0: 2020 2020 2020 205d 2c0a 2020 2020 2920         ],.    ) 
-000037d0: 2d3e 2052 756e 6e61 626c 6553 6572 6961  -> RunnableSeria
-000037e0: 6c69 7a61 626c 655b 4f74 6865 722c 204f  lizable[Other, O
-000037f0: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
-00003800: 2222 2243 6f6d 706f 7365 2074 6869 7320  """Compose this 
-00003810: 7275 6e6e 6162 6c65 2077 6974 6820 616e  runnable with an
-00003820: 6f74 6865 7220 6f62 6a65 6374 2074 6f20  other object to 
-00003830: 6372 6561 7465 2061 2052 756e 6e61 626c  create a Runnabl
-00003840: 6553 6571 7565 6e63 652e 2222 220a 2020  eSequence.""".  
-00003850: 2020 2020 2020 7265 7475 726e 2052 756e        return Run
-00003860: 6e61 626c 6553 6571 7565 6e63 6528 636f  nableSequence(co
-00003870: 6572 6365 5f74 6f5f 7275 6e6e 6162 6c65  erce_to_runnable
-00003880: 286f 7468 6572 292c 2073 656c 6629 0a0a  (other), self)..
-00003890: 2020 2020 6465 6620 7069 7065 280a 2020      def pipe(.  
-000038a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000038b0: 2020 2020 2a6f 7468 6572 733a 2055 6e69      *others: Uni
-000038c0: 6f6e 5b52 756e 6e61 626c 655b 416e 792c  on[Runnable[Any,
-000038d0: 204f 7468 6572 5d2c 2043 616c 6c61 626c   Other], Callabl
-000038e0: 655b 5b41 6e79 5d2c 204f 7468 6572 5d5d  e[[Any], Other]]
-000038f0: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
-00003900: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00003910: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
-00003920: 756e 6e61 626c 6553 6572 6961 6c69 7a61  unnableSerializa
-00003930: 626c 655b 496e 7075 742c 204f 7468 6572  ble[Input, Other
-00003940: 5d3a 0a20 2020 2020 2020 2022 2222 436f  ]:.        """Co
-00003950: 6d70 6f73 6520 7468 6973 2072 756e 6e61  mpose this runna
-00003960: 626c 6520 7769 7468 2061 6e6f 7468 6572  ble with another
-00003970: 206f 626a 6563 7420 746f 2063 7265 6174   object to creat
-00003980: 6520 6120 5275 6e6e 6162 6c65 5365 7175  e a RunnableSequ
-00003990: 656e 6365 2e22 2222 0a20 2020 2020 2020  ence.""".       
-000039a0: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
-000039b0: 5365 7175 656e 6365 2873 656c 662c 202a  Sequence(self, *
-000039c0: 6f74 6865 7273 2c20 6e61 6d65 3d6e 616d  others, name=nam
-000039d0: 6529 0a0a 2020 2020 6465 6620 7069 636b  e)..    def pick
-000039e0: 2873 656c 662c 206b 6579 733a 2055 6e69  (self, keys: Uni
-000039f0: 6f6e 5b73 7472 2c20 4c69 7374 5b73 7472  on[str, List[str
-00003a00: 5d5d 2920 2d3e 2052 756e 6e61 626c 6553  ]]) -> RunnableS
-00003a10: 6572 6961 6c69 7a61 626c 655b 416e 792c  erializable[Any,
-00003a20: 2041 6e79 5d3a 0a20 2020 2020 2020 2022   Any]:.        "
-00003a30: 2222 5069 636b 206b 6579 7320 6672 6f6d  ""Pick keys from
-00003a40: 2074 6865 2064 6963 7420 6f75 7470 7574   the dict output
-00003a50: 206f 6620 7468 6973 2072 756e 6e61 626c   of this runnabl
-00003a60: 652e 0a20 2020 2020 2020 2052 6574 7572  e..        Retur
-00003a70: 6e73 2061 206e 6577 2072 756e 6e61 626c  ns a new runnabl
-00003a80: 652e 2222 220a 2020 2020 2020 2020 6672  e.""".        fr
-00003a90: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-00003aa0: 652e 7275 6e6e 6162 6c65 732e 7061 7373  e.runnables.pass
-00003ab0: 7468 726f 7567 6820 696d 706f 7274 2052  through import R
-00003ac0: 756e 6e61 626c 6550 6963 6b0a 0a20 2020  unnablePick..   
-00003ad0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00003ae0: 207c 2052 756e 6e61 626c 6550 6963 6b28   | RunnablePick(
-00003af0: 6b65 7973 290a 0a20 2020 2064 6566 2061  keys)..    def a
-00003b00: 7373 6967 6e28 0a20 2020 2020 2020 2073  ssign(.        s
-00003b10: 656c 662c 0a20 2020 2020 2020 202a 2a6b  elf,.        **k
-00003b20: 7761 7267 733a 2055 6e69 6f6e 5b0a 2020  wargs: Union[.  
-00003b30: 2020 2020 2020 2020 2020 5275 6e6e 6162            Runnab
-00003b40: 6c65 5b44 6963 745b 7374 722c 2041 6e79  le[Dict[str, Any
-00003b50: 5d2c 2041 6e79 5d2c 0a20 2020 2020 2020  ], Any],.       
-00003b60: 2020 2020 2043 616c 6c61 626c 655b 5b44       Callable[[D
-00003b70: 6963 745b 7374 722c 2041 6e79 5d5d 2c20  ict[str, Any]], 
-00003b80: 416e 795d 2c0a 2020 2020 2020 2020 2020  Any],.          
-00003b90: 2020 4d61 7070 696e 675b 0a20 2020 2020    Mapping[.     
-00003ba0: 2020 2020 2020 2020 2020 2073 7472 2c0a             str,.
-00003bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bc0: 556e 696f 6e5b 5275 6e6e 6162 6c65 5b44  Union[Runnable[D
-00003bd0: 6963 745b 7374 722c 2041 6e79 5d2c 2041  ict[str, Any], A
-00003be0: 6e79 5d2c 2043 616c 6c61 626c 655b 5b44  ny], Callable[[D
-00003bf0: 6963 745b 7374 722c 2041 6e79 5d5d 2c20  ict[str, Any]], 
-00003c00: 416e 795d 5d2c 0a20 2020 2020 2020 2020  Any]],.         
-00003c10: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
-00003c20: 0a20 2020 2029 202d 3e20 5275 6e6e 6162  .    ) -> Runnab
-00003c30: 6c65 5365 7269 616c 697a 6162 6c65 5b41  leSerializable[A
-00003c40: 6e79 2c20 416e 795d 3a0a 2020 2020 2020  ny, Any]:.      
-00003c50: 2020 2222 2241 7373 6967 6e73 206e 6577    """Assigns new
-00003c60: 2066 6965 6c64 7320 746f 2074 6865 2064   fields to the d
-00003c70: 6963 7420 6f75 7470 7574 206f 6620 7468  ict output of th
-00003c80: 6973 2072 756e 6e61 626c 652e 0a20 2020  is runnable..   
-00003c90: 2020 2020 2052 6574 7572 6e73 2061 206e       Returns a n
-00003ca0: 6577 2072 756e 6e61 626c 652e 2222 220a  ew runnable.""".
-00003cb0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00003cc0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
-00003cd0: 6162 6c65 732e 7061 7373 7468 726f 7567  ables.passthroug
-00003ce0: 6820 696d 706f 7274 2052 756e 6e61 626c  h import Runnabl
-00003cf0: 6541 7373 6967 6e0a 0a20 2020 2020 2020  eAssign..       
-00003d00: 2072 6574 7572 6e20 7365 6c66 207c 2052   return self | R
-00003d10: 756e 6e61 626c 6541 7373 6967 6e28 5275  unnableAssign(Ru
-00003d20: 6e6e 6162 6c65 5061 7261 6c6c 656c 286b  nnableParallel(k
-00003d30: 7761 7267 7329 290a 0a20 2020 2022 2222  wargs))..    """
-00003d40: 202d 2d2d 2050 7562 6c69 6320 4150 4920   --- Public API 
-00003d50: 2d2d 2d20 2222 220a 0a20 2020 2040 6162  --- """..    @ab
-00003d60: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
-00003d70: 2064 6566 2069 6e76 6f6b 6528 7365 6c66   def invoke(self
-00003d80: 2c20 696e 7075 743a 2049 6e70 7574 2c20  , input: Input, 
-00003d90: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00003da0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00003db0: 203d 204e 6f6e 6529 202d 3e20 4f75 7470   = None) -> Outp
-00003dc0: 7574 3a0a 2020 2020 2020 2020 2222 2254  ut:.        """T
-00003dd0: 7261 6e73 666f 726d 2061 2073 696e 676c  ransform a singl
-00003de0: 6520 696e 7075 7420 696e 746f 2061 6e20  e input into an 
-00003df0: 6f75 7470 7574 2e20 4f76 6572 7269 6465  output. Override
-00003e00: 2074 6f20 696d 706c 656d 656e 742e 0a0a   to implement...
-00003e10: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00003e20: 2020 2020 2020 2020 2020 696e 7075 743a            input:
-00003e30: 2054 6865 2069 6e70 7574 2074 6f20 7468   The input to th
-00003e40: 6520 7275 6e6e 6162 6c65 2e0a 2020 2020  e runnable..    
-00003e50: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-00003e60: 4120 636f 6e66 6967 2074 6f20 7573 6520  A config to use 
-00003e70: 7768 656e 2069 6e76 6f6b 696e 6720 7468  when invoking th
-00003e80: 6520 7275 6e6e 6162 6c65 2e0a 2020 2020  e runnable..    
-00003e90: 2020 2020 2020 2020 2020 2054 6865 2063             The c
-00003ea0: 6f6e 6669 6720 7375 7070 6f72 7473 2073  onfig supports s
-00003eb0: 7461 6e64 6172 6420 6b65 7973 206c 696b  tandard keys lik
-00003ec0: 6520 2774 6167 7327 2c20 276d 6574 6164  e 'tags', 'metad
-00003ed0: 6174 6127 2066 6f72 2074 7261 6369 6e67  ata' for tracing
-00003ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003ef0: 7075 7270 6f73 6573 2c20 276d 6178 5f63  purposes, 'max_c
-00003f00: 6f6e 6375 7272 656e 6379 2720 666f 7220  oncurrency' for 
-00003f10: 636f 6e74 726f 6c6c 696e 6720 686f 7720  controlling how 
-00003f20: 6d75 6368 2077 6f72 6b20 746f 2064 6f0a  much work to do.
-00003f30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003f40: 6e20 7061 7261 6c6c 656c 2c20 616e 6420  n parallel, and 
-00003f50: 6f74 6865 7220 6b65 7973 2e20 506c 6561  other keys. Plea
-00003f60: 7365 2072 6566 6572 2074 6f20 7468 6520  se refer to the 
-00003f70: 5275 6e6e 6162 6c65 436f 6e66 6967 0a20  RunnableConfig. 
-00003f80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00003f90: 7220 6d6f 7265 2064 6574 6169 6c73 2e0a  r more details..
-00003fa0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00003fb0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
-00003fc0: 6520 6f75 7470 7574 206f 6620 7468 6520  e output of the 
-00003fd0: 7275 6e6e 6162 6c65 2e0a 2020 2020 2020  runnable..      
-00003fe0: 2020 2222 220a 0a20 2020 2061 7379 6e63    """..    async
-00003ff0: 2064 6566 2061 696e 766f 6b65 280a 2020   def ainvoke(.  
-00004000: 2020 2020 2020 7365 6c66 2c20 696e 7075        self, inpu
-00004010: 743a 2049 6e70 7574 2c20 636f 6e66 6967  t: Input, config
-00004020: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00004030: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00004040: 652c 202a 2a6b 7761 7267 733a 2041 6e79  e, **kwargs: Any
-00004050: 0a20 2020 2029 202d 3e20 4f75 7470 7574  .    ) -> Output
-00004060: 3a0a 2020 2020 2020 2020 2222 2244 6566  :.        """Def
-00004070: 6175 6c74 2069 6d70 6c65 6d65 6e74 6174  ault implementat
-00004080: 696f 6e20 6f66 2061 696e 766f 6b65 2c20  ion of ainvoke, 
-00004090: 6361 6c6c 7320 696e 766f 6b65 2066 726f  calls invoke fro
-000040a0: 6d20 6120 7468 7265 6164 2e0a 0a20 2020  m a thread...   
-000040b0: 2020 2020 2054 6865 2064 6566 6175 6c74       The default
-000040c0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
-000040d0: 616c 6c6f 7773 2075 7361 6765 206f 6620  allows usage of 
-000040e0: 6173 796e 6320 636f 6465 2065 7665 6e20  async code even 
-000040f0: 6966 0a20 2020 2020 2020 2074 6865 2072  if.        the r
-00004100: 756e 6e61 626c 6520 6469 6420 6e6f 7420  unnable did not 
-00004110: 696d 706c 656d 656e 7420 6120 6e61 7469  implement a nati
-00004120: 7665 2061 7379 6e63 2076 6572 7369 6f6e  ve async version
-00004130: 206f 6620 696e 766f 6b65 2e0a 0a20 2020   of invoke...   
-00004140: 2020 2020 2053 7562 636c 6173 7365 7320       Subclasses 
-00004150: 7368 6f75 6c64 206f 7665 7272 6964 6520  should override 
-00004160: 7468 6973 206d 6574 686f 6420 6966 2074  this method if t
-00004170: 6865 7920 6361 6e20 7275 6e20 6173 796e  hey can run asyn
-00004180: 6368 726f 6e6f 7573 6c79 2e0a 2020 2020  chronously..    
-00004190: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000041a0: 7265 7475 726e 2061 7761 6974 2072 756e  return await run
-000041b0: 5f69 6e5f 6578 6563 7574 6f72 2863 6f6e  _in_executor(con
-000041c0: 6669 672c 2073 656c 662e 696e 766f 6b65  fig, self.invoke
-000041d0: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
-000041e0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
-000041f0: 6465 6620 6261 7463 6828 0a20 2020 2020  def batch(.     
-00004200: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00004210: 2069 6e70 7574 733a 204c 6973 745b 496e   inputs: List[In
-00004220: 7075 745d 2c0a 2020 2020 2020 2020 636f  put],.        co
-00004230: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b55  nfig: Optional[U
-00004240: 6e69 6f6e 5b52 756e 6e61 626c 6543 6f6e  nion[RunnableCon
-00004250: 6669 672c 204c 6973 745b 5275 6e6e 6162  fig, List[Runnab
-00004260: 6c65 436f 6e66 6967 5d5d 5d20 3d20 4e6f  leConfig]]] = No
-00004270: 6e65 2c0a 2020 2020 2020 2020 2a2c 0a20  ne,.        *,. 
-00004280: 2020 2020 2020 2072 6574 7572 6e5f 6578         return_ex
-00004290: 6365 7074 696f 6e73 3a20 626f 6f6c 203d  ceptions: bool =
-000042a0: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-000042b0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
-000042c0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
-000042d0: 3e20 4c69 7374 5b4f 7574 7075 745d 3a0a  > List[Output]:.
-000042e0: 2020 2020 2020 2020 2222 2244 6566 6175          """Defau
-000042f0: 6c74 2069 6d70 6c65 6d65 6e74 6174 696f  lt implementatio
-00004300: 6e20 7275 6e73 2069 6e76 6f6b 6520 696e  n runs invoke in
-00004310: 2070 6172 616c 6c65 6c20 7573 696e 6720   parallel using 
-00004320: 6120 7468 7265 6164 2070 6f6f 6c20 6578  a thread pool ex
-00004330: 6563 7574 6f72 2e0a 0a20 2020 2020 2020  ecutor...       
-00004340: 2054 6865 2064 6566 6175 6c74 2069 6d70   The default imp
-00004350: 6c65 6d65 6e74 6174 696f 6e20 6f66 2062  lementation of b
-00004360: 6174 6368 2077 6f72 6b73 2077 656c 6c20  atch works well 
-00004370: 666f 7220 494f 2062 6f75 6e64 2072 756e  for IO bound run
-00004380: 6e61 626c 6573 2e0a 0a20 2020 2020 2020  nables...       
-00004390: 2053 7562 636c 6173 7365 7320 7368 6f75   Subclasses shou
-000043a0: 6c64 206f 7665 7272 6964 6520 7468 6973  ld override this
-000043b0: 206d 6574 686f 6420 6966 2074 6865 7920   method if they 
-000043c0: 6361 6e20 6261 7463 6820 6d6f 7265 2065  can batch more e
-000043d0: 6666 6963 6965 6e74 6c79 3b0a 2020 2020  fficiently;.    
-000043e0: 2020 2020 652e 672e 2c20 6966 2074 6865      e.g., if the
-000043f0: 2075 6e64 6572 6c79 696e 6720 7275 6e6e   underlying runn
-00004400: 6162 6c65 2075 7365 7320 616e 2041 5049  able uses an API
-00004410: 2077 6869 6368 2073 7570 706f 7274 7320   which supports 
-00004420: 6120 6261 7463 6820 6d6f 6465 2e0a 2020  a batch mode..  
-00004430: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004440: 2020 6966 206e 6f74 2069 6e70 7574 733a    if not inputs:
-00004450: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00004460: 7572 6e20 5b5d 0a0a 2020 2020 2020 2020  urn []..        
-00004470: 636f 6e66 6967 7320 3d20 6765 745f 636f  configs = get_co
-00004480: 6e66 6967 5f6c 6973 7428 636f 6e66 6967  nfig_list(config
-00004490: 2c20 6c65 6e28 696e 7075 7473 2929 0a0a  , len(inputs))..
-000044a0: 2020 2020 2020 2020 6465 6620 696e 766f          def invo
-000044b0: 6b65 2869 6e70 7574 3a20 496e 7075 742c  ke(input: Input,
-000044c0: 2063 6f6e 6669 673a 2052 756e 6e61 626c   config: Runnabl
-000044d0: 6543 6f6e 6669 6729 202d 3e20 556e 696f  eConfig) -> Unio
-000044e0: 6e5b 4f75 7470 7574 2c20 4578 6365 7074  n[Output, Except
-000044f0: 696f 6e5d 3a0a 2020 2020 2020 2020 2020  ion]:.          
-00004500: 2020 6966 2072 6574 7572 6e5f 6578 6365    if return_exce
-00004510: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-00004520: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00004530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004540: 2072 6574 7572 6e20 7365 6c66 2e69 6e76   return self.inv
-00004550: 6f6b 6528 696e 7075 742c 2063 6f6e 6669  oke(input, confi
-00004560: 672c 202a 2a6b 7761 7267 7329 0a20 2020  g, **kwargs).   
-00004570: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00004580: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00004590: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-000045a0: 2020 2020 2020 2020 7265 7475 726e 2065          return e
-000045b0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000045c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000045d0: 2020 2072 6574 7572 6e20 7365 6c66 2e69     return self.i
-000045e0: 6e76 6f6b 6528 696e 7075 742c 2063 6f6e  nvoke(input, con
-000045f0: 6669 672c 202a 2a6b 7761 7267 7329 0a0a  fig, **kwargs)..
-00004600: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-00004610: 7265 2773 206f 6e6c 7920 6f6e 6520 696e  re's only one in
-00004620: 7075 742c 2064 6f6e 2774 2062 6f74 6865  put, don't bothe
-00004630: 7220 7769 7468 2074 6865 2065 7865 6375  r with the execu
-00004640: 746f 720a 2020 2020 2020 2020 6966 206c  tor.        if l
-00004650: 656e 2869 6e70 7574 7329 203d 3d20 313a  en(inputs) == 1:
-00004660: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00004670: 7572 6e20 6361 7374 284c 6973 745b 4f75  urn cast(List[Ou
-00004680: 7470 7574 5d2c 205b 696e 766f 6b65 2869  tput], [invoke(i
-00004690: 6e70 7574 735b 305d 2c20 636f 6e66 6967  nputs[0], config
-000046a0: 735b 305d 295d 290a 0a20 2020 2020 2020  s[0])])..       
-000046b0: 2077 6974 6820 6765 745f 6578 6563 7574   with get_execut
-000046c0: 6f72 5f66 6f72 5f63 6f6e 6669 6728 636f  or_for_config(co
-000046d0: 6e66 6967 735b 305d 2920 6173 2065 7865  nfigs[0]) as exe
-000046e0: 6375 746f 723a 0a20 2020 2020 2020 2020  cutor:.         
-000046f0: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
-00004700: 6973 745b 4f75 7470 7574 5d2c 206c 6973  ist[Output], lis
-00004710: 7428 6578 6563 7574 6f72 2e6d 6170 2869  t(executor.map(i
-00004720: 6e76 6f6b 652c 2069 6e70 7574 732c 2063  nvoke, inputs, c
-00004730: 6f6e 6669 6773 2929 290a 0a20 2020 2061  onfigs)))..    a
-00004740: 7379 6e63 2064 6566 2061 6261 7463 6828  sync def abatch(
-00004750: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00004760: 2020 2020 2020 2069 6e70 7574 733a 204c         inputs: L
-00004770: 6973 745b 496e 7075 745d 2c0a 2020 2020  ist[Input],.    
-00004780: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
-00004790: 6f6e 616c 5b55 6e69 6f6e 5b52 756e 6e61  onal[Union[Runna
-000047a0: 626c 6543 6f6e 6669 672c 204c 6973 745b  bleConfig, List[
-000047b0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d5d  RunnableConfig]]
-000047c0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000047d0: 2020 2a2c 0a20 2020 2020 2020 2072 6574    *,.        ret
-000047e0: 7572 6e5f 6578 6365 7074 696f 6e73 3a20  urn_exceptions: 
-000047f0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00004800: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-00004810: 4f70 7469 6f6e 616c 5b41 6e79 5d2c 0a20  Optional[Any],. 
-00004820: 2020 2029 202d 3e20 4c69 7374 5b4f 7574     ) -> List[Out
-00004830: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
-00004840: 2244 6566 6175 6c74 2069 6d70 6c65 6d65  "Default impleme
-00004850: 6e74 6174 696f 6e20 7275 6e73 2061 696e  ntation runs ain
-00004860: 766f 6b65 2069 6e20 7061 7261 6c6c 656c  voke in parallel
-00004870: 2075 7369 6e67 2061 7379 6e63 696f 2e67   using asyncio.g
-00004880: 6174 6865 722e 0a0a 2020 2020 2020 2020  ather...        
-00004890: 5468 6520 6465 6661 756c 7420 696d 706c  The default impl
-000048a0: 656d 656e 7461 7469 6f6e 206f 6620 6261  ementation of ba
-000048b0: 7463 6820 776f 726b 7320 7765 6c6c 2066  tch works well f
-000048c0: 6f72 2049 4f20 626f 756e 6420 7275 6e6e  or IO bound runn
-000048d0: 6162 6c65 732e 0a0a 2020 2020 2020 2020  ables...        
-000048e0: 5375 6263 6c61 7373 6573 2073 686f 756c  Subclasses shoul
-000048f0: 6420 6f76 6572 7269 6465 2074 6869 7320  d override this 
-00004900: 6d65 7468 6f64 2069 6620 7468 6579 2063  method if they c
-00004910: 616e 2062 6174 6368 206d 6f72 6520 6566  an batch more ef
-00004920: 6669 6369 656e 746c 793b 0a20 2020 2020  ficiently;.     
-00004930: 2020 2065 2e67 2e2c 2069 6620 7468 6520     e.g., if the 
-00004940: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
-00004950: 626c 6520 7573 6573 2061 6e20 4150 4920  ble uses an API 
-00004960: 7768 6963 6820 7375 7070 6f72 7473 2061  which supports a
-00004970: 2062 6174 6368 206d 6f64 652e 0a20 2020   batch mode..   
-00004980: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004990: 2069 6620 6e6f 7420 696e 7075 7473 3a0a   if not inputs:.
-000049a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000049b0: 726e 205b 5d0a 0a20 2020 2020 2020 2063  rn []..        c
-000049c0: 6f6e 6669 6773 203d 2067 6574 5f63 6f6e  onfigs = get_con
-000049d0: 6669 675f 6c69 7374 2863 6f6e 6669 672c  fig_list(config,
-000049e0: 206c 656e 2869 6e70 7574 7329 290a 0a20   len(inputs)).. 
-000049f0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-00004a00: 2061 696e 766f 6b65 280a 2020 2020 2020   ainvoke(.      
-00004a10: 2020 2020 2020 696e 7075 743a 2049 6e70        input: Inp
-00004a20: 7574 2c20 636f 6e66 6967 3a20 5275 6e6e  ut, config: Runn
-00004a30: 6162 6c65 436f 6e66 6967 0a20 2020 2020  ableConfig.     
-00004a40: 2020 2029 202d 3e20 556e 696f 6e5b 4f75     ) -> Union[Ou
-00004a50: 7470 7574 2c20 4578 6365 7074 696f 6e5d  tput, Exception]
-00004a60: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00004a70: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
-00004a80: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00004a90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00004aa0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00004ab0: 7572 6e20 6177 6169 7420 7365 6c66 2e61  urn await self.a
-00004ac0: 696e 766f 6b65 2869 6e70 7574 2c20 636f  invoke(input, co
-00004ad0: 6e66 6967 2c20 2a2a 6b77 6172 6773 290a  nfig, **kwargs).
-00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004af0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00004b00: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00004b10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00004b20: 6e20 650a 2020 2020 2020 2020 2020 2020  n e.            
-00004b30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00004b40: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
-00004b50: 6974 2073 656c 662e 6169 6e76 6f6b 6528  it self.ainvoke(
-00004b60: 696e 7075 742c 2063 6f6e 6669 672c 202a  input, config, *
-00004b70: 2a6b 7761 7267 7329 0a0a 2020 2020 2020  *kwargs)..      
-00004b80: 2020 636f 726f 7320 3d20 6d61 7028 6169    coros = map(ai
-00004b90: 6e76 6f6b 652c 2069 6e70 7574 732c 2063  nvoke, inputs, c
-00004ba0: 6f6e 6669 6773 290a 2020 2020 2020 2020  onfigs).        
-00004bb0: 7265 7475 726e 2061 7761 6974 2067 6174  return await gat
-00004bc0: 6865 725f 7769 7468 5f63 6f6e 6375 7272  her_with_concurr
-00004bd0: 656e 6379 2863 6f6e 6669 6773 5b30 5d2e  ency(configs[0].
-00004be0: 6765 7428 226d 6178 5f63 6f6e 6375 7272  get("max_concurr
-00004bf0: 656e 6379 2229 2c20 2a63 6f72 6f73 290a  ency"), *coros).
-00004c00: 0a20 2020 2064 6566 2073 7472 6561 6d28  .    def stream(
-00004c10: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00004c20: 2020 2020 2020 2069 6e70 7574 3a20 496e         input: In
-00004c30: 7075 742c 0a20 2020 2020 2020 2063 6f6e  put,.        con
-00004c40: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-00004c50: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
-00004c60: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-00004c70: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
-00004c80: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
-00004c90: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
-00004ca0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00004cb0: 2020 2020 2020 4465 6661 756c 7420 696d        Default im
-00004cc0: 706c 656d 656e 7461 7469 6f6e 206f 6620  plementation of 
-00004cd0: 7374 7265 616d 2c20 7768 6963 6820 6361  stream, which ca
-00004ce0: 6c6c 7320 696e 766f 6b65 2e0a 2020 2020  lls invoke..    
-00004cf0: 2020 2020 5375 6263 6c61 7373 6573 2073      Subclasses s
-00004d00: 686f 756c 6420 6f76 6572 7269 6465 2074  hould override t
-00004d10: 6869 7320 6d65 7468 6f64 2069 6620 7468  his method if th
-00004d20: 6579 2073 7570 706f 7274 2073 7472 6561  ey support strea
-00004d30: 6d69 6e67 206f 7574 7075 742e 0a20 2020  ming output..   
-00004d40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004d50: 2079 6965 6c64 2073 656c 662e 696e 766f   yield self.invo
-00004d60: 6b65 2869 6e70 7574 2c20 636f 6e66 6967  ke(input, config
-00004d70: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-00004d80: 2061 7379 6e63 2064 6566 2061 7374 7265   async def astre
-00004d90: 616d 280a 2020 2020 2020 2020 7365 6c66  am(.        self
-00004da0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00004db0: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
-00004dc0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00004dd0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00004de0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00004df0: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00004e00: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00004e10: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
-00004e20: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
-00004e30: 2020 2222 220a 2020 2020 2020 2020 4465    """.        De
-00004e40: 6661 756c 7420 696d 706c 656d 656e 7461  fault implementa
-00004e50: 7469 6f6e 206f 6620 6173 7472 6561 6d2c  tion of astream,
-00004e60: 2077 6869 6368 2063 616c 6c73 2061 696e   which calls ain
-00004e70: 766f 6b65 2e0a 2020 2020 2020 2020 5375  voke..        Su
-00004e80: 6263 6c61 7373 6573 2073 686f 756c 6420  bclasses should 
-00004e90: 6f76 6572 7269 6465 2074 6869 7320 6d65  override this me
-00004ea0: 7468 6f64 2069 6620 7468 6579 2073 7570  thod if they sup
-00004eb0: 706f 7274 2073 7472 6561 6d69 6e67 206f  port streaming o
-00004ec0: 7574 7075 742e 0a20 2020 2020 2020 2022  utput..        "
-00004ed0: 2222 0a20 2020 2020 2020 2079 6965 6c64  "".        yield
-00004ee0: 2061 7761 6974 2073 656c 662e 6169 6e76   await self.ainv
-00004ef0: 6f6b 6528 696e 7075 742c 2063 6f6e 6669  oke(input, confi
-00004f00: 672c 202a 2a6b 7761 7267 7329 0a0a 2020  g, **kwargs)..  
-00004f10: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
-00004f20: 6465 6620 6173 7472 6561 6d5f 6c6f 6728  def astream_log(
-00004f30: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00004f40: 2020 2020 2020 2069 6e70 7574 3a20 416e         input: An
-00004f50: 792c 0a20 2020 2020 2020 2063 6f6e 6669  y,.        confi
-00004f60: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-00004f70: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-00004f80: 6e65 2c0a 2020 2020 2020 2020 2a2c 0a20  ne,.        *,. 
-00004f90: 2020 2020 2020 2064 6966 663a 204c 6974         diff: Lit
-00004fa0: 6572 616c 5b54 7275 655d 203d 2054 7275  eral[True] = Tru
-00004fb0: 652c 0a20 2020 2020 2020 2077 6974 685f  e,.        with_
-00004fc0: 7374 7265 616d 6564 5f6f 7574 7075 745f  streamed_output_
-00004fd0: 6c69 7374 3a20 626f 6f6c 203d 2054 7275  list: bool = Tru
-00004fe0: 652c 0a20 2020 2020 2020 2069 6e63 6c75  e,.        inclu
-00004ff0: 6465 5f6e 616d 6573 3a20 4f70 7469 6f6e  de_names: Option
-00005000: 616c 5b53 6571 7565 6e63 655b 7374 725d  al[Sequence[str]
-00005010: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00005020: 2020 696e 636c 7564 655f 7479 7065 733a    include_types:
-00005030: 204f 7074 696f 6e61 6c5b 5365 7175 656e   Optional[Sequen
-00005040: 6365 5b73 7472 5d5d 203d 204e 6f6e 652c  ce[str]] = None,
-00005050: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
-00005060: 5f74 6167 733a 204f 7074 696f 6e61 6c5b  _tags: Optional[
-00005070: 5365 7175 656e 6365 5b73 7472 5d5d 203d  Sequence[str]] =
-00005080: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
-00005090: 7863 6c75 6465 5f6e 616d 6573 3a20 4f70  xclude_names: Op
-000050a0: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
-000050b0: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
-000050c0: 2020 2020 2020 6578 636c 7564 655f 7479        exclude_ty
-000050d0: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
-000050e0: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
-000050f0: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
-00005100: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
-00005110: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
-00005120: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-00005130: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
-00005140: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
-00005150: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
-00005160: 6f72 5b52 756e 4c6f 6750 6174 6368 5d3a  or[RunLogPatch]:
-00005170: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
-00005180: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
-00005190: 6465 6620 6173 7472 6561 6d5f 6c6f 6728  def astream_log(
-000051a0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000051b0: 2020 2020 2020 2069 6e70 7574 3a20 416e         input: An
-000051c0: 792c 0a20 2020 2020 2020 2063 6f6e 6669  y,.        confi
-000051d0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-000051e0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-000051f0: 6e65 2c0a 2020 2020 2020 2020 2a2c 0a20  ne,.        *,. 
-00005200: 2020 2020 2020 2064 6966 663a 204c 6974         diff: Lit
-00005210: 6572 616c 5b46 616c 7365 5d2c 0a20 2020  eral[False],.   
-00005220: 2020 2020 2077 6974 685f 7374 7265 616d       with_stream
-00005230: 6564 5f6f 7574 7075 745f 6c69 7374 3a20  ed_output_list: 
-00005240: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00005250: 2020 2020 2069 6e63 6c75 6465 5f6e 616d       include_nam
-00005260: 6573 3a20 4f70 7469 6f6e 616c 5b53 6571  es: Optional[Seq
-00005270: 7565 6e63 655b 7374 725d 5d20 3d20 4e6f  uence[str]] = No
-00005280: 6e65 2c0a 2020 2020 2020 2020 696e 636c  ne,.        incl
-00005290: 7564 655f 7479 7065 733a 204f 7074 696f  ude_types: Optio
-000052a0: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
-000052b0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-000052c0: 2020 2069 6e63 6c75 6465 5f74 6167 733a     include_tags:
-000052d0: 204f 7074 696f 6e61 6c5b 5365 7175 656e   Optional[Sequen
-000052e0: 6365 5b73 7472 5d5d 203d 204e 6f6e 652c  ce[str]] = None,
-000052f0: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
-00005300: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
-00005310: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
-00005320: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00005330: 6578 636c 7564 655f 7479 7065 733a 204f  exclude_types: O
-00005340: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
-00005350: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
-00005360: 2020 2020 2020 2065 7863 6c75 6465 5f74         exclude_t
-00005370: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
-00005380: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
-00005390: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-000053a0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
-000053b0: 416e 795d 2c0a 2020 2020 2920 2d3e 2041  Any],.    ) -> A
-000053c0: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
-000053d0: 4c6f 675d 3a0a 2020 2020 2020 2020 2e2e  Log]:.        ..
-000053e0: 2e0a 0a20 2020 2061 7379 6e63 2064 6566  ...    async def
-000053f0: 2061 7374 7265 616d 5f6c 6f67 280a 2020   astream_log(.  
-00005400: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00005410: 2020 2020 696e 7075 743a 2041 6e79 2c0a      input: Any,.
-00005420: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-00005430: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-00005440: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
-00005450: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00005460: 2020 2020 6469 6666 3a20 626f 6f6c 203d      diff: bool =
-00005470: 2054 7275 652c 0a20 2020 2020 2020 2077   True,.        w
-00005480: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
-00005490: 7075 745f 6c69 7374 3a20 626f 6f6c 203d  put_list: bool =
-000054a0: 2054 7275 652c 0a20 2020 2020 2020 2069   True,.        i
-000054b0: 6e63 6c75 6465 5f6e 616d 6573 3a20 4f70  nclude_names: Op
-000054c0: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
-000054d0: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
-000054e0: 2020 2020 2020 696e 636c 7564 655f 7479        include_ty
-000054f0: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
-00005500: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
-00005510: 6f6e 652c 0a20 2020 2020 2020 2069 6e63  one,.        inc
-00005520: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
-00005530: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
-00005540: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-00005550: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
-00005560: 3a20 4f70 7469 6f6e 616c 5b53 6571 7565  : Optional[Seque
-00005570: 6e63 655b 7374 725d 5d20 3d20 4e6f 6e65  nce[str]] = None
-00005580: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
-00005590: 655f 7479 7065 733a 204f 7074 696f 6e61  e_types: Optiona
-000055a0: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
-000055b0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000055c0: 2065 7863 6c75 6465 5f74 6167 733a 204f   exclude_tags: O
-000055d0: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
-000055e0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
-000055f0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-00005600: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
-00005610: 2020 2020 2920 2d3e 2055 6e69 6f6e 5b41      ) -> Union[A
-00005620: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
-00005630: 4c6f 6750 6174 6368 5d2c 2041 7379 6e63  LogPatch], Async
-00005640: 4974 6572 6174 6f72 5b52 756e 4c6f 675d  Iterator[RunLog]
-00005650: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00005660: 2020 2020 2020 2053 7472 6561 6d20 616c         Stream al
-00005670: 6c20 6f75 7470 7574 2066 726f 6d20 6120  l output from a 
-00005680: 7275 6e6e 6162 6c65 2c20 6173 2072 6570  runnable, as rep
-00005690: 6f72 7465 6420 746f 2074 6865 2063 616c  orted to the cal
-000056a0: 6c62 6163 6b20 7379 7374 656d 2e0a 2020  lback system..  
-000056b0: 2020 2020 2020 5468 6973 2069 6e63 6c75        This inclu
-000056c0: 6465 7320 616c 6c20 696e 6e65 7220 7275  des all inner ru
-000056d0: 6e73 206f 6620 4c4c 4d73 2c20 5265 7472  ns of LLMs, Retr
-000056e0: 6965 7665 7273 2c20 546f 6f6c 732c 2065  ievers, Tools, e
-000056f0: 7463 2e0a 0a20 2020 2020 2020 204f 7574  tc...        Out
-00005700: 7075 7420 6973 2073 7472 6561 6d65 6420  put is streamed 
-00005710: 6173 204c 6f67 206f 626a 6563 7473 2c20  as Log objects, 
-00005720: 7768 6963 6820 696e 636c 7564 6520 6120  which include a 
-00005730: 6c69 7374 206f 660a 2020 2020 2020 2020  list of.        
-00005740: 6a73 6f6e 7061 7463 6820 6f70 7320 7468  jsonpatch ops th
-00005750: 6174 2064 6573 6372 6962 6520 686f 7720  at describe how 
-00005760: 7468 6520 7374 6174 6520 6f66 2074 6865  the state of the
-00005770: 2072 756e 2068 6173 2063 6861 6e67 6564   run has changed
-00005780: 2069 6e20 6561 6368 0a20 2020 2020 2020   in each.       
-00005790: 2073 7465 702c 2061 6e64 2074 6865 2066   step, and the f
-000057a0: 696e 616c 2073 7461 7465 206f 6620 7468  inal state of th
-000057b0: 6520 7275 6e2e 0a0a 2020 2020 2020 2020  e run...        
-000057c0: 5468 6520 6a73 6f6e 7061 7463 6820 6f70  The jsonpatch op
-000057d0: 7320 6361 6e20 6265 2061 7070 6c69 6564  s can be applied
-000057e0: 2069 6e20 6f72 6465 7220 746f 2063 6f6e   in order to con
-000057f0: 7374 7275 6374 2073 7461 7465 2e0a 0a20  struct state... 
-00005800: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00005810: 2020 2020 2020 2020 2069 6e70 7574 3a20           input: 
-00005820: 5468 6520 696e 7075 7420 746f 2074 6865  The input to the
-00005830: 2072 756e 6e61 626c 652e 0a20 2020 2020   runnable..     
-00005840: 2020 2020 2020 2063 6f6e 6669 673a 2054         config: T
-00005850: 6865 2063 6f6e 6669 6720 746f 2075 7365  he config to use
-00005860: 2066 6f72 2074 6865 2072 756e 6e61 626c   for the runnabl
-00005870: 652e 0a20 2020 2020 2020 2020 2020 2064  e..            d
-00005880: 6966 663a 2057 6865 7468 6572 2074 6f20  iff: Whether to 
-00005890: 7969 656c 6420 6469 6666 7320 6265 7477  yield diffs betw
-000058a0: 6565 6e20 6561 6368 2073 7465 702c 206f  een each step, o
-000058b0: 7220 7468 6520 6375 7272 656e 7420 7374  r the current st
-000058c0: 6174 652e 0a20 2020 2020 2020 2020 2020  ate..           
-000058d0: 2077 6974 685f 7374 7265 616d 6564 5f6f   with_streamed_o
-000058e0: 7574 7075 745f 6c69 7374 3a20 5768 6574  utput_list: Whet
-000058f0: 6865 7220 746f 2079 6965 6c64 2074 6865  her to yield the
-00005900: 2073 7472 6561 6d65 645f 6f75 7470 7574   streamed_output
-00005910: 206c 6973 742e 0a20 2020 2020 2020 2020   list..         
-00005920: 2020 2069 6e63 6c75 6465 5f6e 616d 6573     include_names
-00005930: 3a20 4f6e 6c79 2069 6e63 6c75 6465 206c  : Only include l
-00005940: 6f67 7320 7769 7468 2074 6865 7365 206e  ogs with these n
-00005950: 616d 6573 2e0a 2020 2020 2020 2020 2020  ames..          
-00005960: 2020 696e 636c 7564 655f 7479 7065 733a    include_types:
-00005970: 204f 6e6c 7920 696e 636c 7564 6520 6c6f   Only include lo
-00005980: 6773 2077 6974 6820 7468 6573 6520 7479  gs with these ty
-00005990: 7065 732e 0a20 2020 2020 2020 2020 2020  pes..           
-000059a0: 2069 6e63 6c75 6465 5f74 6167 733a 204f   include_tags: O
-000059b0: 6e6c 7920 696e 636c 7564 6520 6c6f 6773  nly include logs
-000059c0: 2077 6974 6820 7468 6573 6520 7461 6773   with these tags
-000059d0: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-000059e0: 636c 7564 655f 6e61 6d65 733a 2045 7863  clude_names: Exc
-000059f0: 6c75 6465 206c 6f67 7320 7769 7468 2074  lude logs with t
-00005a00: 6865 7365 206e 616d 6573 2e0a 2020 2020  hese names..    
-00005a10: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
-00005a20: 7479 7065 733a 2045 7863 6c75 6465 206c  types: Exclude l
-00005a30: 6f67 7320 7769 7468 2074 6865 7365 2074  ogs with these t
-00005a40: 7970 6573 2e0a 2020 2020 2020 2020 2020  ypes..          
-00005a50: 2020 6578 636c 7564 655f 7461 6773 3a20    exclude_tags: 
-00005a60: 4578 636c 7564 6520 6c6f 6773 2077 6974  Exclude logs wit
-00005a70: 6820 7468 6573 6520 7461 6773 2e0a 2020  h these tags..  
-00005a80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00005a90: 2020 696d 706f 7274 206a 736f 6e70 6174    import jsonpat
-00005aa0: 6368 2020 2320 7479 7065 3a20 6967 6e6f  ch  # type: igno
-00005ab0: 7265 5b69 6d70 6f72 745d 0a0a 2020 2020  re[import]..    
-00005ac0: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
-00005ad0: 696e 5f63 6f72 652e 6361 6c6c 6261 636b  in_core.callback
-00005ae0: 732e 6261 7365 2069 6d70 6f72 7420 4261  s.base import Ba
-00005af0: 7365 4361 6c6c 6261 636b 4d61 6e61 6765  seCallbackManage
-00005b00: 720a 2020 2020 2020 2020 6672 6f6d 206c  r.        from l
-00005b10: 616e 6763 6861 696e 5f63 6f72 652e 7472  angchain_core.tr
-00005b20: 6163 6572 732e 6c6f 675f 7374 7265 616d  acers.log_stream
-00005b30: 2069 6d70 6f72 7420 280a 2020 2020 2020   import (.      
-00005b40: 2020 2020 2020 4c6f 6753 7472 6561 6d43        LogStreamC
-00005b50: 616c 6c62 6163 6b48 616e 646c 6572 2c0a  allbackHandler,.
-00005b60: 2020 2020 2020 2020 2020 2020 5275 6e4c              RunL
-00005b70: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
-00005b80: 5275 6e4c 6f67 5061 7463 682c 0a20 2020  RunLogPatch,.   
-00005b90: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00005ba0: 2320 4372 6561 7465 2061 2073 7472 6561  # Create a strea
-00005bb0: 6d20 6861 6e64 6c65 7220 7468 6174 2077  m handler that w
-00005bc0: 696c 6c20 656d 6974 204c 6f67 206f 626a  ill emit Log obj
-00005bd0: 6563 7473 0a20 2020 2020 2020 2073 7472  ects.        str
-00005be0: 6561 6d20 3d20 4c6f 6753 7472 6561 6d43  eam = LogStreamC
-00005bf0: 616c 6c62 6163 6b48 616e 646c 6572 280a  allbackHandler(.
-00005c00: 2020 2020 2020 2020 2020 2020 6175 746f              auto
-00005c10: 5f63 6c6f 7365 3d46 616c 7365 2c0a 2020  _close=False,.  
-00005c20: 2020 2020 2020 2020 2020 696e 636c 7564            includ
-00005c30: 655f 6e61 6d65 733d 696e 636c 7564 655f  e_names=include_
-00005c40: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
-00005c50: 2020 2069 6e63 6c75 6465 5f74 7970 6573     include_types
-00005c60: 3d69 6e63 6c75 6465 5f74 7970 6573 2c0a  =include_types,.
-00005c70: 2020 2020 2020 2020 2020 2020 696e 636c              incl
-00005c80: 7564 655f 7461 6773 3d69 6e63 6c75 6465  ude_tags=include
-00005c90: 5f74 6167 732c 0a20 2020 2020 2020 2020  _tags,.         
-00005ca0: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
-00005cb0: 3d65 7863 6c75 6465 5f6e 616d 6573 2c0a  =exclude_names,.
-00005cc0: 2020 2020 2020 2020 2020 2020 6578 636c              excl
-00005cd0: 7564 655f 7479 7065 733d 6578 636c 7564  ude_types=exclud
-00005ce0: 655f 7479 7065 732c 0a20 2020 2020 2020  e_types,.       
-00005cf0: 2020 2020 2065 7863 6c75 6465 5f74 6167       exclude_tag
-00005d00: 733d 6578 636c 7564 655f 7461 6773 2c0a  s=exclude_tags,.
-00005d10: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00005d20: 2020 2023 2041 7373 6967 6e20 7468 6520     # Assign the 
-00005d30: 7374 7265 616d 2068 616e 646c 6572 2074  stream handler t
-00005d40: 6f20 7468 6520 636f 6e66 6967 0a20 2020  o the config.   
-00005d50: 2020 2020 2063 6f6e 6669 6720 3d20 656e       config = en
-00005d60: 7375 7265 5f63 6f6e 6669 6728 636f 6e66  sure_config(conf
-00005d70: 6967 290a 2020 2020 2020 2020 6361 6c6c  ig).        call
-00005d80: 6261 636b 7320 3d20 636f 6e66 6967 2e67  backs = config.g
-00005d90: 6574 2822 6361 6c6c 6261 636b 7322 290a  et("callbacks").
-00005da0: 2020 2020 2020 2020 6966 2063 616c 6c62          if callb
-00005db0: 6163 6b73 2069 7320 4e6f 6e65 3a0a 2020  acks is None:.  
-00005dc0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00005dd0: 5b22 6361 6c6c 6261 636b 7322 5d20 3d20  ["callbacks"] = 
-00005de0: 5b73 7472 6561 6d5d 0a20 2020 2020 2020  [stream].       
-00005df0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00005e00: 2863 616c 6c62 6163 6b73 2c20 6c69 7374  (callbacks, list
-00005e10: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00005e20: 6f6e 6669 675b 2263 616c 6c62 6163 6b73  onfig["callbacks
-00005e30: 225d 203d 2063 616c 6c62 6163 6b73 202b  "] = callbacks +
-00005e40: 205b 7374 7265 616d 5d0a 2020 2020 2020   [stream].      
-00005e50: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00005e60: 6528 6361 6c6c 6261 636b 732c 2042 6173  e(callbacks, Bas
-00005e70: 6543 616c 6c62 6163 6b4d 616e 6167 6572  eCallbackManager
-00005e80: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00005e90: 616c 6c62 6163 6b73 203d 2063 616c 6c62  allbacks = callb
-00005ea0: 6163 6b73 2e63 6f70 7928 290a 2020 2020  acks.copy().    
-00005eb0: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
-00005ec0: 732e 6164 645f 6861 6e64 6c65 7228 7374  s.add_handler(st
-00005ed0: 7265 616d 2c20 696e 6865 7269 743d 5472  ream, inherit=Tr
-00005ee0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00005ef0: 636f 6e66 6967 5b22 6361 6c6c 6261 636b  config["callback
-00005f00: 7322 5d20 3d20 6361 6c6c 6261 636b 730a  s"] = callbacks.
-00005f10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00005f20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00005f30: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-00005f40: 2020 2020 2020 2020 2020 2020 6622 556e              f"Un
-00005f50: 6578 7065 6374 6564 2074 7970 6520 666f  expected type fo
-00005f60: 7220 6361 6c6c 6261 636b 733a 207b 6361  r callbacks: {ca
-00005f70: 6c6c 6261 636b 737d 2e22 0a20 2020 2020  llbacks}.".     
-00005f80: 2020 2020 2020 2020 2020 2022 4578 7065             "Expe
-00005f90: 6374 6564 204e 6f6e 652c 206c 6973 7420  cted None, list 
-00005fa0: 6f72 2041 7379 6e63 4361 6c6c 6261 636b  or AsyncCallback
-00005fb0: 4d61 6e61 6765 722e 220a 2020 2020 2020  Manager.".      
-00005fc0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00005fd0: 2023 2043 616c 6c20 7468 6520 7275 6e6e   # Call the runn
-00005fe0: 6162 6c65 2069 6e20 7374 7265 616d 696e  able in streamin
-00005ff0: 6720 6d6f 6465 2c0a 2020 2020 2020 2020  g mode,.        
-00006000: 2320 6164 6420 6561 6368 2063 6875 6e6b  # add each chunk
-00006010: 2074 6f20 7468 6520 6f75 7470 7574 2073   to the output s
-00006020: 7472 6561 6d0a 2020 2020 2020 2020 6173  tream.        as
-00006030: 796e 6320 6465 6620 636f 6e73 756d 655f  ync def consume_
-00006040: 6173 7472 6561 6d28 2920 2d3e 204e 6f6e  astream() -> Non
-00006050: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00006060: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00006070: 2020 2020 7072 6576 5f66 696e 616c 5f6f      prev_final_o
-00006080: 7574 7075 743a 204f 7074 696f 6e61 6c5b  utput: Optional[
-00006090: 4f75 7470 7574 5d20 3d20 4e6f 6e65 0a20  Output] = None. 
-000060a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000060b0: 696e 616c 5f6f 7574 7075 743a 204f 7074  inal_output: Opt
-000060c0: 696f 6e61 6c5b 4f75 7470 7574 5d20 3d20  ional[Output] = 
-000060d0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-000060e0: 2020 2020 2020 6173 796e 6320 666f 7220        async for 
-000060f0: 6368 756e 6b20 696e 2073 656c 662e 6173  chunk in self.as
-00006100: 7472 6561 6d28 696e 7075 742c 2063 6f6e  tream(input, con
-00006110: 6669 672c 202a 2a6b 7761 7267 7329 3a0a  fig, **kwargs):.
-00006120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006130: 2020 2020 7072 6576 5f66 696e 616c 5f6f      prev_final_o
-00006140: 7574 7075 7420 3d20 6669 6e61 6c5f 6f75  utput = final_ou
-00006150: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-00006160: 2020 2020 2020 2020 2069 6620 6669 6e61           if fina
-00006170: 6c5f 6f75 7470 7574 2069 7320 4e6f 6e65  l_output is None
-00006180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006190: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
-000061a0: 6f75 7470 7574 203d 2063 6875 6e6b 0a20  output = chunk. 
-000061b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000061d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006200: 2020 6669 6e61 6c5f 6f75 7470 7574 203d    final_output =
-00006210: 2066 696e 616c 5f6f 7574 7075 7420 2b20   final_output + 
-00006220: 6368 756e 6b20 2023 2074 7970 653a 2069  chunk  # type: i
-00006230: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
-00006240: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00006250: 6365 7074 2054 7970 6545 7272 6f72 3a0a  cept TypeError:.
-00006260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006270: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-00006280: 6c5f 6f75 7470 7574 203d 2063 6875 6e6b  l_output = chunk
-00006290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000062a0: 2020 2020 2070 6174 6368 6573 3a20 4c69       patches: Li
-000062b0: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
-000062c0: 5d5d 203d 205b 5d0a 2020 2020 2020 2020  ]] = [].        
-000062d0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000062e0: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
-000062f0: 7075 745f 6c69 7374 3a0a 2020 2020 2020  put_list:.      
-00006300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006310: 2020 7061 7463 6865 732e 6170 7065 6e64    patches.append
-00006320: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006330: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006360: 226f 7022 3a20 2261 6464 222c 0a20 2020  "op": "add",.   
-00006370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006380: 2020 2020 2020 2020 2020 2020 2022 7061               "pa
-00006390: 7468 223a 2022 2f73 7472 6561 6d65 645f  th": "/streamed_
-000063a0: 6f75 7470 7574 2f2d 222c 0a20 2020 2020  output/-",.     
-000063b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063c0: 2020 2020 2020 2020 2020 2023 2063 6875             # chu
-000063d0: 6e6b 2063 616e 6e6f 7420 6265 2073 6861  nk cannot be sha
-000063e0: 7265 6420 6265 7477 6565 6e0a 2020 2020  red between.    
-000063f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006400: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-00006410: 7265 616d 6564 5f6f 7574 7075 7420 616e  reamed_output an
-00006420: 6420 6669 6e61 6c5f 6f75 7470 7574 0a20  d final_output. 
-00006430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006440: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006450: 206f 7468 6572 7769 7365 206a 736f 6e70   otherwise jsonp
-00006460: 6174 6368 2e61 7070 6c79 2077 696c 6c0a  atch.apply will.
-00006470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006490: 2320 6d6f 6469 6679 2062 6f74 680a 2020  # modify both.  
-000064a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064b0: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-000064c0: 616c 7565 223a 2064 6565 7063 6f70 7928  alue": deepcopy(
-000064d0: 6368 756e 6b29 2c0a 2020 2020 2020 2020  chunk),.        
-000064e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064f0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00006500: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00006510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006520: 2020 2020 666f 7220 6f70 2069 6e20 6a73      for op in js
-00006530: 6f6e 7061 7463 682e 4a73 6f6e 5061 7463  onpatch.JsonPatc
-00006540: 682e 6672 6f6d 5f64 6966 6628 0a20 2020  h.from_diff(.   
-00006550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006560: 2020 2020 2070 7265 765f 6669 6e61 6c5f       prev_final_
-00006570: 6f75 7470 7574 2c20 6669 6e61 6c5f 6f75  output, final_ou
-00006580: 7470 7574 2c20 6475 6d70 733d 6475 6d70  tput, dumps=dump
-00006590: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000065a0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-000065b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065c0: 2070 6174 6368 6573 2e61 7070 656e 6428   patches.append(
-000065d0: 7b2a 2a6f 702c 2022 7061 7468 223a 2066  {**op, "path": f
-000065e0: 222f 6669 6e61 6c5f 6f75 7470 7574 7b6f  "/final_output{o
-000065f0: 705b 2770 6174 6827 5d7d 227d 290a 2020  p['path']}"}).  
-00006600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006610: 2020 6177 6169 7420 7374 7265 616d 2e73    await stream.s
-00006620: 656e 645f 7374 7265 616d 2e73 656e 6428  end_stream.send(
-00006630: 5275 6e4c 6f67 5061 7463 6828 2a70 6174  RunLogPatch(*pat
-00006640: 6368 6573 2929 0a20 2020 2020 2020 2020  ches)).         
-00006650: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00006660: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00006670: 7420 7374 7265 616d 2e73 656e 645f 7374  t stream.send_st
-00006680: 7265 616d 2e61 636c 6f73 6528 290a 0a20  ream.aclose().. 
-00006690: 2020 2020 2020 2023 2053 7461 7274 2074         # Start t
-000066a0: 6865 2072 756e 6e61 626c 6520 696e 2061  he runnable in a
-000066b0: 2074 6173 6b2c 2073 6f20 7765 2063 616e   task, so we can
-000066c0: 2073 7461 7274 2063 6f6e 7375 6d69 6e67   start consuming
-000066d0: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-000066e0: 7461 736b 203d 2061 7379 6e63 696f 2e63  task = asyncio.c
-000066f0: 7265 6174 655f 7461 736b 2863 6f6e 7375  reate_task(consu
-00006700: 6d65 5f61 7374 7265 616d 2829 290a 0a20  me_astream()).. 
-00006710: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00006720: 2020 2020 2020 2020 2320 5969 656c 6420          # Yield 
-00006730: 6561 6368 2063 6875 6e6b 2066 726f 6d20  each chunk from 
-00006740: 7468 6520 6f75 7470 7574 2073 7472 6561  the output strea
-00006750: 6d0a 2020 2020 2020 2020 2020 2020 6966  m.            if
-00006760: 2064 6966 663a 0a20 2020 2020 2020 2020   diff:.         
-00006770: 2020 2020 2020 2061 7379 6e63 2066 6f72         async for
-00006780: 206c 6f67 2069 6e20 7374 7265 616d 3a0a   log in stream:.
-00006790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067a0: 2020 2020 7969 656c 6420 6c6f 670a 2020      yield log.  
-000067b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000067c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067d0: 7374 6174 6520 3d20 5275 6e4c 6f67 2873  state = RunLog(s
-000067e0: 7461 7465 3d4e 6f6e 6529 2020 2320 7479  tate=None)  # ty
-000067f0: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
-00006800: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
-00006810: 2020 2020 2061 7379 6e63 2066 6f72 206c       async for l
-00006820: 6f67 2069 6e20 7374 7265 616d 3a0a 2020  og in stream:.  
-00006830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006840: 2020 7374 6174 6520 3d20 7374 6174 6520    state = state 
-00006850: 2b20 6c6f 670a 2020 2020 2020 2020 2020  + log.          
-00006860: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-00006870: 7374 6174 650a 2020 2020 2020 2020 6669  state.        fi
-00006880: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00006890: 2020 2023 2057 6169 7420 666f 7220 7468     # Wait for th
-000068a0: 6520 7275 6e6e 6162 6c65 2074 6f20 6669  e runnable to fi
-000068b0: 6e69 7368 2c20 6966 206e 6f74 2063 616e  nish, if not can
-000068c0: 6365 6c6c 6564 2028 6567 2e20 6279 2062  celled (eg. by b
-000068d0: 7265 616b 290a 2020 2020 2020 2020 2020  reak).          
-000068e0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000068f0: 2020 2020 2020 2061 7761 6974 2074 6173         await tas
-00006900: 6b0a 2020 2020 2020 2020 2020 2020 6578  k.            ex
-00006910: 6365 7074 2061 7379 6e63 696f 2e43 616e  cept asyncio.Can
-00006920: 6365 6c6c 6564 4572 726f 723a 0a20 2020  celledError:.   
-00006930: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00006940: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00006950: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
-00006960: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
-00006970: 743a 2049 7465 7261 746f 725b 496e 7075  t: Iterator[Inpu
-00006980: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00006990: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-000069a0: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-000069b0: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-000069c0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
-000069d0: 416e 795d 2c0a 2020 2020 2920 2d3e 2049  Any],.    ) -> I
-000069e0: 7465 7261 746f 725b 4f75 7470 7574 5d3a  terator[Output]:
-000069f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006a00: 2020 2020 2044 6566 6175 6c74 2069 6d70       Default imp
-00006a10: 6c65 6d65 6e74 6174 696f 6e20 6f66 2074  lementation of t
-00006a20: 7261 6e73 666f 726d 2c20 7768 6963 6820  ransform, which 
-00006a30: 6275 6666 6572 7320 696e 7075 7420 616e  buffers input an
-00006a40: 6420 7468 656e 2063 616c 6c73 2073 7472  d then calls str
-00006a50: 6561 6d2e 0a20 2020 2020 2020 2053 7562  eam..        Sub
-00006a60: 636c 6173 7365 7320 7368 6f75 6c64 206f  classes should o
-00006a70: 7665 7272 6964 6520 7468 6973 206d 6574  verride this met
-00006a80: 686f 6420 6966 2074 6865 7920 6361 6e20  hod if they can 
-00006a90: 7374 6172 7420 7072 6f64 7563 696e 6720  start producing 
-00006aa0: 6f75 7470 7574 2077 6869 6c65 0a20 2020  output while.   
-00006ab0: 2020 2020 2069 6e70 7574 2069 7320 7374       input is st
-00006ac0: 696c 6c20 6265 696e 6720 6765 6e65 7261  ill being genera
-00006ad0: 7465 642e 0a20 2020 2020 2020 2022 2222  ted..        """
-00006ae0: 0a20 2020 2020 2020 2066 696e 616c 3a20  .        final: 
-00006af0: 496e 7075 740a 2020 2020 2020 2020 676f  Input.        go
-00006b00: 745f 6669 7273 745f 7661 6c20 3d20 4661  t_first_val = Fa
-00006b10: 6c73 650a 0a20 2020 2020 2020 2066 6f72  lse..        for
-00006b20: 2063 6875 6e6b 2069 6e20 696e 7075 743a   chunk in input:
-00006b30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00006b40: 6e6f 7420 676f 745f 6669 7273 745f 7661  not got_first_va
-00006b50: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-00006b60: 2020 2066 696e 616c 203d 2063 6875 6e6b     final = chunk
-00006b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b80: 2067 6f74 5f66 6972 7374 5f76 616c 203d   got_first_val =
-00006b90: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00006ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006bb0: 2020 2020 2020 2020 2320 4d61 6b65 2061          # Make a
-00006bc0: 2062 6573 7420 6566 666f 7274 2074 6f20   best effort to 
-00006bd0: 6761 7468 6572 2c20 666f 7220 616e 7920  gather, for any 
-00006be0: 7479 7065 2074 6861 7420 7375 7070 6f72  type that suppor
-00006bf0: 7473 2060 2b60 0a20 2020 2020 2020 2020  ts `+`.         
-00006c00: 2020 2020 2020 2023 2054 6869 7320 6d65         # This me
-00006c10: 7468 6f64 2073 686f 756c 6420 7468 726f  thod should thro
-00006c20: 7720 616e 2065 7272 6f72 2069 6620 6761  w an error if ga
-00006c30: 7468 6572 696e 6720 6661 696c 732e 0a20  thering fails.. 
-00006c40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00006c50: 696e 616c 203d 2066 696e 616c 202b 2063  inal = final + c
-00006c60: 6875 6e6b 2020 2320 7479 7065 3a20 6967  hunk  # type: ig
-00006c70: 6e6f 7265 5b6f 7065 7261 746f 725d 0a0a  nore[operator]..
-00006c80: 2020 2020 2020 2020 6966 2067 6f74 5f66          if got_f
-00006c90: 6972 7374 5f76 616c 3a0a 2020 2020 2020  irst_val:.      
-00006ca0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
-00006cb0: 2073 656c 662e 7374 7265 616d 2866 696e   self.stream(fin
-00006cc0: 616c 2c20 636f 6e66 6967 2c20 2a2a 6b77  al, config, **kw
-00006cd0: 6172 6773 290a 0a20 2020 2061 7379 6e63  args)..    async
-00006ce0: 2064 6566 2061 7472 616e 7366 6f72 6d28   def atransform(
-00006cf0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00006d00: 2020 2020 2020 2069 6e70 7574 3a20 4173         input: As
-00006d10: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
-00006d20: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00006d30: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-00006d40: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-00006d50: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-00006d60: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
-00006d70: 416e 795d 2c0a 2020 2020 2920 2d3e 2041  Any],.    ) -> A
-00006d80: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
-00006d90: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
-00006da0: 220a 2020 2020 2020 2020 4465 6661 756c  ".        Defaul
-00006db0: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
-00006dc0: 206f 6620 6174 7261 6e73 666f 726d 2c20   of atransform, 
-00006dd0: 7768 6963 6820 6275 6666 6572 7320 696e  which buffers in
-00006de0: 7075 7420 616e 6420 6361 6c6c 7320 6173  put and calls as
-00006df0: 7472 6561 6d2e 0a20 2020 2020 2020 2053  tream..        S
-00006e00: 7562 636c 6173 7365 7320 7368 6f75 6c64  ubclasses should
-00006e10: 206f 7665 7272 6964 6520 7468 6973 206d   override this m
-00006e20: 6574 686f 6420 6966 2074 6865 7920 6361  ethod if they ca
-00006e30: 6e20 7374 6172 7420 7072 6f64 7563 696e  n start producin
-00006e40: 6720 6f75 7470 7574 2077 6869 6c65 0a20  g output while. 
-00006e50: 2020 2020 2020 2069 6e70 7574 2069 7320         input is 
-00006e60: 7374 696c 6c20 6265 696e 6720 6765 6e65  still being gene
-00006e70: 7261 7465 642e 0a20 2020 2020 2020 2022  rated..        "
-00006e80: 2222 0a20 2020 2020 2020 2066 696e 616c  "".        final
-00006e90: 3a20 496e 7075 740a 2020 2020 2020 2020  : Input.        
-00006ea0: 676f 745f 6669 7273 745f 7661 6c20 3d20  got_first_val = 
-00006eb0: 4661 6c73 650a 0a20 2020 2020 2020 2061  False..        a
-00006ec0: 7379 6e63 2066 6f72 2063 6875 6e6b 2069  sync for chunk i
-00006ed0: 6e20 696e 7075 743a 0a20 2020 2020 2020  n input:.       
-00006ee0: 2020 2020 2069 6620 6e6f 7420 676f 745f       if not got_
-00006ef0: 6669 7273 745f 7661 6c3a 0a20 2020 2020  first_val:.     
-00006f00: 2020 2020 2020 2020 2020 2066 696e 616c             final
-00006f10: 203d 2063 6875 6e6b 0a20 2020 2020 2020   = chunk.       
-00006f20: 2020 2020 2020 2020 2067 6f74 5f66 6972           got_fir
-00006f30: 7374 5f76 616c 203d 2054 7275 650a 2020  st_val = True.  
-00006f40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00006f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f60: 2320 4d61 6b65 2061 2062 6573 7420 6566  # Make a best ef
-00006f70: 666f 7274 2074 6f20 6761 7468 6572 2c20  fort to gather, 
-00006f80: 666f 7220 616e 7920 7479 7065 2074 6861  for any type tha
-00006f90: 7420 7375 7070 6f72 7473 2060 2b60 0a20  t supports `+`. 
-00006fa0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006fb0: 2054 6869 7320 6d65 7468 6f64 2073 686f   This method sho
-00006fc0: 756c 6420 7468 726f 7720 616e 2065 7272  uld throw an err
-00006fd0: 6f72 2069 6620 6761 7468 6572 696e 6720  or if gathering 
-00006fe0: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
-00006ff0: 2020 2020 2020 2066 696e 616c 203d 2066         final = f
-00007000: 696e 616c 202b 2063 6875 6e6b 2020 2320  inal + chunk  # 
-00007010: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
-00007020: 7261 746f 725d 0a0a 2020 2020 2020 2020  rator]..        
-00007030: 6966 2067 6f74 5f66 6972 7374 5f76 616c  if got_first_val
-00007040: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00007050: 796e 6320 666f 7220 6f75 7470 7574 2069  ync for output i
-00007060: 6e20 7365 6c66 2e61 7374 7265 616d 2866  n self.astream(f
-00007070: 696e 616c 2c20 636f 6e66 6967 2c20 2a2a  inal, config, **
-00007080: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00007090: 2020 2020 2020 2020 2079 6965 6c64 206f           yield o
-000070a0: 7574 7075 740a 0a20 2020 2064 6566 2062  utput..    def b
-000070b0: 696e 6428 7365 6c66 2c20 2a2a 6b77 6172  ind(self, **kwar
-000070c0: 6773 3a20 416e 7929 202d 3e20 5275 6e6e  gs: Any) -> Runn
-000070d0: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
-000070e0: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-000070f0: 0a20 2020 2020 2020 2042 696e 6420 6172  .        Bind ar
-00007100: 6775 6d65 6e74 7320 746f 2061 2052 756e  guments to a Run
-00007110: 6e61 626c 652c 2072 6574 7572 6e69 6e67  nable, returning
-00007120: 2061 206e 6577 2052 756e 6e61 626c 652e   a new Runnable.
-00007130: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007140: 2020 2020 2072 6574 7572 6e20 5275 6e6e       return Runn
-00007150: 6162 6c65 4269 6e64 696e 6728 626f 756e  ableBinding(boun
-00007160: 643d 7365 6c66 2c20 6b77 6172 6773 3d6b  d=self, kwargs=k
-00007170: 7761 7267 732c 2063 6f6e 6669 673d 7b7d  wargs, config={}
-00007180: 290a 0a20 2020 2064 6566 2077 6974 685f  )..    def with_
-00007190: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
-000071a0: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
-000071b0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-000071c0: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-000071d0: 204e 6f6e 652c 0a20 2020 2020 2020 2023   None,.        #
-000071e0: 2053 6164 6c79 2055 6e70 6163 6b20 6973   Sadly Unpack is
-000071f0: 206e 6f74 2077 656c 6c20 7375 7070 6f72   not well suppor
-00007200: 7465 6420 6279 206d 7970 7920 736f 2074  ted by mypy so t
-00007210: 6869 7320 7769 6c6c 2068 6176 6520 746f  his will have to
-00007220: 2062 6520 756e 7479 7065 640a 2020 2020   be untyped.    
-00007230: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00007240: 792c 0a20 2020 2029 202d 3e20 5275 6e6e  y,.    ) -> Runn
-00007250: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
-00007260: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-00007270: 0a20 2020 2020 2020 2042 696e 6420 636f  .        Bind co
-00007280: 6e66 6967 2074 6f20 6120 5275 6e6e 6162  nfig to a Runnab
-00007290: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
-000072a0: 6e65 7720 5275 6e6e 6162 6c65 2e0a 2020  new Runnable..  
-000072b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000072c0: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
-000072d0: 6542 696e 6469 6e67 280a 2020 2020 2020  eBinding(.      
-000072e0: 2020 2020 2020 626f 756e 643d 7365 6c66        bound=self
-000072f0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-00007300: 6e66 6967 3d63 6173 7428 0a20 2020 2020  nfig=cast(.     
-00007310: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
-00007320: 626c 6543 6f6e 6669 672c 0a20 2020 2020  bleConfig,.     
-00007330: 2020 2020 2020 2020 2020 207b 2a2a 2863             {**(c
-00007340: 6f6e 6669 6720 6f72 207b 7d29 2c20 2a2a  onfig or {}), **
-00007350: 6b77 6172 6773 7d2c 0a20 2020 2020 2020  kwargs},.       
-00007360: 2020 2020 2029 2c20 2023 2074 7970 653a       ),  # type:
-00007370: 2069 676e 6f72 655b 6d69 7363 5d0a 2020   ignore[misc].  
-00007380: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
-00007390: 3d7b 7d2c 0a20 2020 2020 2020 2029 0a0a  ={},.        )..
-000073a0: 2020 2020 6465 6620 7769 7468 5f6c 6973      def with_lis
-000073b0: 7465 6e65 7273 280a 2020 2020 2020 2020  teners(.        
-000073c0: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-000073d0: 0a20 2020 2020 2020 206f 6e5f 7374 6172  .        on_star
-000073e0: 743a 204f 7074 696f 6e61 6c5b 4c69 7374  t: Optional[List
-000073f0: 656e 6572 5d20 3d20 4e6f 6e65 2c0a 2020  ener] = None,.  
-00007400: 2020 2020 2020 6f6e 5f65 6e64 3a20 4f70        on_end: Op
-00007410: 7469 6f6e 616c 5b4c 6973 7465 6e65 725d  tional[Listener]
-00007420: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00007430: 206f 6e5f 6572 726f 723a 204f 7074 696f   on_error: Optio
-00007440: 6e61 6c5b 4c69 7374 656e 6572 5d20 3d20  nal[Listener] = 
-00007450: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
-00007460: 756e 6e61 626c 655b 496e 7075 742c 204f  unnable[Input, O
-00007470: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
-00007480: 2222 220a 2020 2020 2020 2020 4269 6e64  """.        Bind
-00007490: 206c 6966 6563 7963 6c65 206c 6973 7465   lifecycle liste
-000074a0: 6e65 7273 2074 6f20 6120 5275 6e6e 6162  ners to a Runnab
-000074b0: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
-000074c0: 6e65 7720 5275 6e6e 6162 6c65 2e0a 0a20  new Runnable... 
-000074d0: 2020 2020 2020 206f 6e5f 7374 6172 743a         on_start:
-000074e0: 2043 616c 6c65 6420 6265 666f 7265 2074   Called before t
-000074f0: 6865 2072 756e 6e61 626c 6520 7374 6172  he runnable star
-00007500: 7473 2072 756e 6e69 6e67 2c20 7769 7468  ts running, with
-00007510: 2074 6865 2052 756e 206f 626a 6563 742e   the Run object.
-00007520: 0a20 2020 2020 2020 206f 6e5f 656e 643a  .        on_end:
-00007530: 2043 616c 6c65 6420 6166 7465 7220 7468   Called after th
-00007540: 6520 7275 6e6e 6162 6c65 2066 696e 6973  e runnable finis
-00007550: 6865 7320 7275 6e6e 696e 672c 2077 6974  hes running, wit
-00007560: 6820 7468 6520 5275 6e20 6f62 6a65 6374  h the Run object
-00007570: 2e0a 2020 2020 2020 2020 6f6e 5f65 7272  ..        on_err
-00007580: 6f72 3a20 4361 6c6c 6564 2069 6620 7468  or: Called if th
-00007590: 6520 7275 6e6e 6162 6c65 2074 6872 6f77  e runnable throw
-000075a0: 7320 616e 2065 7272 6f72 2c20 7769 7468  s an error, with
-000075b0: 2074 6865 2052 756e 206f 626a 6563 742e   the Run object.
-000075c0: 0a0a 2020 2020 2020 2020 5468 6520 5275  ..        The Ru
-000075d0: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
-000075e0: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
-000075f0: 6f75 7420 7468 6520 7275 6e2c 2069 6e63  out the run, inc
-00007600: 6c75 6469 6e67 2069 7473 2069 642c 0a20  luding its id,. 
-00007610: 2020 2020 2020 2074 7970 652c 2069 6e70         type, inp
-00007620: 7574 2c20 6f75 7470 7574 2c20 6572 726f  ut, output, erro
-00007630: 722c 2073 7461 7274 5f74 696d 652c 2065  r, start_time, e
-00007640: 6e64 5f74 696d 652c 2061 6e64 2061 6e79  nd_time, and any
-00007650: 2074 6167 7320 6f72 206d 6574 6164 6174   tags or metadat
-00007660: 610a 2020 2020 2020 2020 6164 6465 6420  a.        added 
-00007670: 746f 2074 6865 2072 756e 2e0a 2020 2020  to the run..    
-00007680: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00007690: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
-000076a0: 6f72 652e 7472 6163 6572 732e 726f 6f74  ore.tracers.root
-000076b0: 5f6c 6973 7465 6e65 7273 2069 6d70 6f72  _listeners impor
-000076c0: 7420 526f 6f74 4c69 7374 656e 6572 7354  t RootListenersT
-000076d0: 7261 6365 720a 0a20 2020 2020 2020 2072  racer..        r
-000076e0: 6574 7572 6e20 5275 6e6e 6162 6c65 4269  eturn RunnableBi
-000076f0: 6e64 696e 6728 0a20 2020 2020 2020 2020  nding(.         
-00007700: 2020 2062 6f75 6e64 3d73 656c 662c 0a20     bound=self,. 
-00007710: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00007720: 675f 6661 6374 6f72 6965 733d 5b0a 2020  g_factories=[.  
-00007730: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00007740: 6d62 6461 2063 6f6e 6669 673a 207b 0a20  mbda config: {. 
-00007750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007760: 2020 2022 6361 6c6c 6261 636b 7322 3a20     "callbacks": 
-00007770: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00007780: 2020 2020 2020 2020 2020 526f 6f74 4c69            RootLi
-00007790: 7374 656e 6572 7354 7261 6365 7228 0a20  stenersTracer(. 
-000077a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077b0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-000077c0: 673d 636f 6e66 6967 2c0a 2020 2020 2020  g=config,.      
-000077d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077e0: 2020 2020 2020 6f6e 5f73 7461 7274 3d6f        on_start=o
-000077f0: 6e5f 7374 6172 742c 0a20 2020 2020 2020  n_start,.       
-00007800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007810: 2020 2020 206f 6e5f 656e 643d 6f6e 5f65       on_end=on_e
-00007820: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-00007830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007840: 6f6e 5f65 7272 6f72 3d6f 6e5f 6572 726f  on_error=on_erro
-00007850: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00007860: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007880: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-00007890: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000078a0: 2020 5d2c 0a20 2020 2020 2020 2029 0a0a    ],.        )..
-000078b0: 2020 2020 6465 6620 7769 7468 5f74 7970      def with_typ
-000078c0: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-000078d0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-000078e0: 2020 2020 2069 6e70 7574 5f74 7970 653a       input_type:
-000078f0: 204f 7074 696f 6e61 6c5b 5479 7065 5b49   Optional[Type[I
-00007900: 6e70 7574 5d5d 203d 204e 6f6e 652c 0a20  nput]] = None,. 
-00007910: 2020 2020 2020 206f 7574 7075 745f 7479         output_ty
-00007920: 7065 3a20 4f70 7469 6f6e 616c 5b54 7970  pe: Optional[Typ
-00007930: 655b 4f75 7470 7574 5d5d 203d 204e 6f6e  e[Output]] = Non
-00007940: 652c 0a20 2020 2029 202d 3e20 5275 6e6e  e,.    ) -> Runn
-00007950: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
-00007960: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-00007970: 0a20 2020 2020 2020 2042 696e 6420 696e  .        Bind in
-00007980: 7075 7420 616e 6420 6f75 7470 7574 2074  put and output t
-00007990: 7970 6573 2074 6f20 6120 5275 6e6e 6162  ypes to a Runnab
-000079a0: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
-000079b0: 6e65 7720 5275 6e6e 6162 6c65 2e0a 2020  new Runnable..  
-000079c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000079d0: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
-000079e0: 6542 696e 6469 6e67 280a 2020 2020 2020  eBinding(.      
-000079f0: 2020 2020 2020 626f 756e 643d 7365 6c66        bound=self
-00007a00: 2c0a 2020 2020 2020 2020 2020 2020 6375  ,.            cu
-00007a10: 7374 6f6d 5f69 6e70 7574 5f74 7970 653d  stom_input_type=
-00007a20: 696e 7075 745f 7479 7065 2c0a 2020 2020  input_type,.    
-00007a30: 2020 2020 2020 2020 6375 7374 6f6d 5f6f          custom_o
-00007a40: 7574 7075 745f 7479 7065 3d6f 7574 7075  utput_type=outpu
-00007a50: 745f 7479 7065 2c0a 2020 2020 2020 2020  t_type,.        
-00007a60: 2020 2020 6b77 6172 6773 3d7b 7d2c 0a20      kwargs={},. 
-00007a70: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00007a80: 6620 7769 7468 5f72 6574 7279 280a 2020  f with_retry(.  
-00007a90: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00007aa0: 2020 2020 2a2c 0a20 2020 2020 2020 2072      *,.        r
-00007ab0: 6574 7279 5f69 665f 6578 6365 7074 696f  etry_if_exceptio
-00007ac0: 6e5f 7479 7065 3a20 5475 706c 655b 5479  n_type: Tuple[Ty
-00007ad0: 7065 5b42 6173 6545 7863 6570 7469 6f6e  pe[BaseException
-00007ae0: 5d2c 202e 2e2e 5d20 3d20 2845 7863 6570  ], ...] = (Excep
-00007af0: 7469 6f6e 2c29 2c0a 2020 2020 2020 2020  tion,),.        
-00007b00: 7761 6974 5f65 7870 6f6e 656e 7469 616c  wait_exponential
-00007b10: 5f6a 6974 7465 723a 2062 6f6f 6c20 3d20  _jitter: bool = 
-00007b20: 5472 7565 2c0a 2020 2020 2020 2020 7374  True,.        st
-00007b30: 6f70 5f61 6674 6572 5f61 7474 656d 7074  op_after_attempt
-00007b40: 3a20 696e 7420 3d20 332c 0a20 2020 2029  : int = 3,.    )
-00007b50: 202d 3e20 5275 6e6e 6162 6c65 5b49 6e70   -> Runnable[Inp
-00007b60: 7574 2c20 4f75 7470 7574 5d3a 0a20 2020  ut, Output]:.   
-00007b70: 2020 2020 2022 2222 4372 6561 7465 2061       """Create a
-00007b80: 206e 6577 2052 756e 6e61 626c 6520 7468   new Runnable th
-00007b90: 6174 2072 6574 7269 6573 2074 6865 206f  at retries the o
-00007ba0: 7269 6769 6e61 6c20 7275 6e6e 6162 6c65  riginal runnable
-00007bb0: 206f 6e20 6578 6365 7074 696f 6e73 2e0a   on exceptions..
-00007bc0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00007bd0: 2020 2020 2020 2020 2020 2072 6574 7279             retry
-00007be0: 5f69 665f 6578 6365 7074 696f 6e5f 7479  _if_exception_ty
-00007bf0: 7065 3a20 4120 7475 706c 6520 6f66 2065  pe: A tuple of e
-00007c00: 7863 6570 7469 6f6e 2074 7970 6573 2074  xception types t
-00007c10: 6f20 7265 7472 7920 6f6e 0a20 2020 2020  o retry on.     
-00007c20: 2020 2020 2020 2077 6169 745f 6578 706f         wait_expo
-00007c30: 6e65 6e74 6961 6c5f 6a69 7474 6572 3a20  nential_jitter: 
-00007c40: 5768 6574 6865 7220 746f 2061 6464 206a  Whether to add j
-00007c50: 6974 7465 7220 746f 2074 6865 2077 6169  itter to the wai
-00007c60: 7420 7469 6d65 0a20 2020 2020 2020 2020  t time.         
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c80: 2020 2020 2020 2020 2020 2020 6265 7477              betw
-00007c90: 6565 6e20 7265 7472 6965 730a 2020 2020  een retries.    
-00007ca0: 2020 2020 2020 2020 7374 6f70 5f61 6674          stop_aft
-00007cb0: 6572 5f61 7474 656d 7074 3a20 5468 6520  er_attempt: The 
-00007cc0: 6d61 7869 6d75 6d20 6e75 6d62 6572 206f  maximum number o
-00007cd0: 6620 6174 7465 6d70 7473 2074 6f20 6d61  f attempts to ma
-00007ce0: 6b65 2062 6566 6f72 6520 6769 7669 6e67  ke before giving
-00007cf0: 2075 700a 0a20 2020 2020 2020 2052 6574   up..        Ret
-00007d00: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00007d10: 2020 4120 6e65 7720 5275 6e6e 6162 6c65    A new Runnable
-00007d20: 2074 6861 7420 7265 7472 6965 7320 7468   that retries th
-00007d30: 6520 6f72 6967 696e 616c 2072 756e 6e61  e original runna
-00007d40: 626c 6520 6f6e 2065 7863 6570 7469 6f6e  ble on exception
-00007d50: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00007d60: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
-00007d70: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
-00007d80: 626c 6573 2e72 6574 7279 2069 6d70 6f72  bles.retry impor
-00007d90: 7420 5275 6e6e 6162 6c65 5265 7472 790a  t RunnableRetry.
-00007da0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007db0: 5275 6e6e 6162 6c65 5265 7472 7928 0a20  RunnableRetry(. 
-00007dc0: 2020 2020 2020 2020 2020 2062 6f75 6e64             bound
-00007dd0: 3d73 656c 662c 0a20 2020 2020 2020 2020  =self,.         
-00007de0: 2020 206b 7761 7267 733d 7b7d 2c0a 2020     kwargs={},.  
-00007df0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00007e00: 3d7b 7d2c 0a20 2020 2020 2020 2020 2020  ={},.           
-00007e10: 2072 6574 7279 5f65 7863 6570 7469 6f6e   retry_exception
-00007e20: 5f74 7970 6573 3d72 6574 7279 5f69 665f  _types=retry_if_
-00007e30: 6578 6365 7074 696f 6e5f 7479 7065 2c0a  exception_type,.
-00007e40: 2020 2020 2020 2020 2020 2020 7761 6974              wait
-00007e50: 5f65 7870 6f6e 656e 7469 616c 5f6a 6974  _exponential_jit
-00007e60: 7465 723d 7761 6974 5f65 7870 6f6e 656e  ter=wait_exponen
-00007e70: 7469 616c 5f6a 6974 7465 722c 0a20 2020  tial_jitter,.   
-00007e80: 2020 2020 2020 2020 206d 6178 5f61 7474           max_att
-00007e90: 656d 7074 5f6e 756d 6265 723d 7374 6f70  empt_number=stop
-00007ea0: 5f61 6674 6572 5f61 7474 656d 7074 2c0a  _after_attempt,.
-00007eb0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00007ec0: 6566 206d 6170 2873 656c 6629 202d 3e20  ef map(self) -> 
-00007ed0: 5275 6e6e 6162 6c65 5b4c 6973 745b 496e  Runnable[List[In
-00007ee0: 7075 745d 2c20 4c69 7374 5b4f 7574 7075  put], List[Outpu
-00007ef0: 745d 5d3a 0a20 2020 2020 2020 2022 2222  t]]:.        """
-00007f00: 0a20 2020 2020 2020 2052 6574 7572 6e20  .        Return 
-00007f10: 6120 6e65 7720 5275 6e6e 6162 6c65 2074  a new Runnable t
-00007f20: 6861 7420 6d61 7073 2061 206c 6973 7420  hat maps a list 
-00007f30: 6f66 2069 6e70 7574 7320 746f 2061 206c  of inputs to a l
-00007f40: 6973 7420 6f66 206f 7574 7075 7473 2c0a  ist of outputs,.
-00007f50: 2020 2020 2020 2020 6279 2063 616c 6c69          by calli
-00007f60: 6e67 2069 6e76 6f6b 6528 2920 7769 7468  ng invoke() with
-00007f70: 2065 6163 6820 696e 7075 742e 0a20 2020   each input..   
-00007f80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00007f90: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
-00007fa0: 4561 6368 2862 6f75 6e64 3d73 656c 6629  Each(bound=self)
-00007fb0: 0a0a 2020 2020 6465 6620 7769 7468 5f66  ..    def with_f
-00007fc0: 616c 6c62 6163 6b73 280a 2020 2020 2020  allbacks(.      
-00007fd0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00007fe0: 6661 6c6c 6261 636b 733a 2053 6571 7565  fallbacks: Seque
-00007ff0: 6e63 655b 5275 6e6e 6162 6c65 5b49 6e70  nce[Runnable[Inp
-00008000: 7574 2c20 4f75 7470 7574 5d5d 2c0a 2020  ut, Output]],.  
-00008010: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00008020: 2065 7863 6570 7469 6f6e 735f 746f 5f68   exceptions_to_h
-00008030: 616e 646c 653a 2054 7570 6c65 5b54 7970  andle: Tuple[Typ
-00008040: 655b 4261 7365 4578 6365 7074 696f 6e5d  e[BaseException]
-00008050: 2c20 2e2e 2e5d 203d 2028 4578 6365 7074  , ...] = (Except
-00008060: 696f 6e2c 292c 0a20 2020 2029 202d 3e20  ion,),.    ) -> 
-00008070: 5275 6e6e 6162 6c65 5769 7468 4661 6c6c  RunnableWithFall
-00008080: 6261 636b 7354 5b49 6e70 7574 2c20 4f75  backsT[Input, Ou
-00008090: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
-000080a0: 2222 4164 6420 6661 6c6c 6261 636b 7320  ""Add fallbacks 
-000080b0: 746f 2061 2072 756e 6e61 626c 652c 2072  to a runnable, r
-000080c0: 6574 7572 6e69 6e67 2061 206e 6577 2052  eturning a new R
-000080d0: 756e 6e61 626c 652e 0a0a 2020 2020 2020  unnable...      
-000080e0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-000080f0: 2020 2020 6661 6c6c 6261 636b 733a 2041      fallbacks: A
-00008100: 2073 6571 7565 6e63 6520 6f66 2072 756e   sequence of run
-00008110: 6e61 626c 6573 2074 6f20 7472 7920 6966  nables to try if
-00008120: 2074 6865 206f 7269 6769 6e61 6c20 7275   the original ru
-00008130: 6e6e 6162 6c65 2066 6169 6c73 2e0a 2020  nnable fails..  
-00008140: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00008150: 696f 6e73 5f74 6f5f 6861 6e64 6c65 3a20  ions_to_handle: 
-00008160: 4120 7475 706c 6520 6f66 2065 7863 6570  A tuple of excep
-00008170: 7469 6f6e 2074 7970 6573 2074 6f20 6861  tion types to ha
-00008180: 6e64 6c65 2e0a 0a20 2020 2020 2020 2052  ndle...        R
-00008190: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-000081a0: 2020 2020 4120 6e65 7720 5275 6e6e 6162      A new Runnab
-000081b0: 6c65 2074 6861 7420 7769 6c6c 2074 7279  le that will try
-000081c0: 2074 6865 206f 7269 6769 6e61 6c20 7275   the original ru
-000081d0: 6e6e 6162 6c65 2c20 616e 6420 7468 656e  nnable, and then
-000081e0: 2065 6163 680a 2020 2020 2020 2020 2020   each.          
-000081f0: 2020 6661 6c6c 6261 636b 2069 6e20 6f72    fallback in or
-00008200: 6465 722c 2075 706f 6e20 6661 696c 7572  der, upon failur
-00008210: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
-00008220: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00008230: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
-00008240: 6162 6c65 732e 6661 6c6c 6261 636b 7320  ables.fallbacks 
-00008250: 696d 706f 7274 2052 756e 6e61 626c 6557  import RunnableW
-00008260: 6974 6846 616c 6c62 6163 6b73 0a0a 2020  ithFallbacks..  
-00008270: 2020 2020 2020 7265 7475 726e 2052 756e        return Run
-00008280: 6e61 626c 6557 6974 6846 616c 6c62 6163  nableWithFallbac
-00008290: 6b73 280a 2020 2020 2020 2020 2020 2020  ks(.            
-000082a0: 7275 6e6e 6162 6c65 3d73 656c 662c 0a20  runnable=self,. 
-000082b0: 2020 2020 2020 2020 2020 2066 616c 6c62             fallb
-000082c0: 6163 6b73 3d66 616c 6c62 6163 6b73 2c0a  acks=fallbacks,.
-000082d0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000082e0: 7074 696f 6e73 5f74 6f5f 6861 6e64 6c65  ptions_to_handle
-000082f0: 3d65 7863 6570 7469 6f6e 735f 746f 5f68  =exceptions_to_h
-00008300: 616e 646c 652c 0a20 2020 2020 2020 2029  andle,.        )
-00008310: 0a0a 2020 2020 2222 2220 2d2d 2d20 4865  ..    """ --- He
-00008320: 6c70 6572 206d 6574 686f 6473 2066 6f72  lper methods for
-00008330: 2053 7562 636c 6173 7365 7320 2d2d 2d20   Subclasses --- 
-00008340: 2222 220a 0a20 2020 2064 6566 205f 6361  """..    def _ca
-00008350: 6c6c 5f77 6974 685f 636f 6e66 6967 280a  ll_with_config(.
-00008360: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00008370: 2020 2020 2020 6675 6e63 3a20 556e 696f        func: Unio
-00008380: 6e5b 0a20 2020 2020 2020 2020 2020 2043  n[.            C
-00008390: 616c 6c61 626c 655b 5b49 6e70 7574 5d2c  allable[[Input],
-000083a0: 204f 7574 7075 745d 2c0a 2020 2020 2020   Output],.      
-000083b0: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
-000083c0: 496e 7075 742c 2043 616c 6c62 6163 6b4d  Input, CallbackM
-000083d0: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-000083e0: 6e5d 2c20 4f75 7470 7574 5d2c 0a20 2020  n], Output],.   
-000083f0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00008400: 655b 5b49 6e70 7574 2c20 4361 6c6c 6261  e[[Input, Callba
-00008410: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-00008420: 6e52 756e 2c20 5275 6e6e 6162 6c65 436f  nRun, RunnableCo
-00008430: 6e66 6967 5d2c 204f 7574 7075 745d 2c0a  nfig], Output],.
-00008440: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00008450: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00008460: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00008470: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00008480: 6c65 436f 6e66 6967 5d2c 0a20 2020 2020  leConfig],.     
-00008490: 2020 2072 756e 5f74 7970 653a 204f 7074     run_type: Opt
-000084a0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-000084b0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-000084c0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
-000084d0: 795d 2c0a 2020 2020 2920 2d3e 204f 7574  y],.    ) -> Out
-000084e0: 7075 743a 0a20 2020 2020 2020 2022 2222  put:.        """
-000084f0: 4865 6c70 6572 206d 6574 686f 6420 746f  Helper method to
-00008500: 2074 7261 6e73 666f 726d 2061 6e20 496e   transform an In
-00008510: 7075 7420 7661 6c75 6520 746f 2061 6e20  put value to an 
-00008520: 4f75 7470 7574 2076 616c 7565 2c0a 2020  Output value,.  
-00008530: 2020 2020 2020 7769 7468 2063 616c 6c62        with callb
-00008540: 6163 6b73 2e20 5573 6520 7468 6973 206d  acks. Use this m
-00008550: 6574 686f 6420 746f 2069 6d70 6c65 6d65  ethod to impleme
-00008560: 6e74 2069 6e76 6f6b 6528 2920 696e 2073  nt invoke() in s
-00008570: 7562 636c 6173 7365 732e 2222 220a 2020  ubclasses.""".  
-00008580: 2020 2020 2020 636f 6e66 6967 203d 2065        config = e
-00008590: 6e73 7572 655f 636f 6e66 6967 2863 6f6e  nsure_config(con
-000085a0: 6669 6729 0a20 2020 2020 2020 2063 616c  fig).        cal
-000085b0: 6c62 6163 6b5f 6d61 6e61 6765 7220 3d20  lback_manager = 
-000085c0: 6765 745f 6361 6c6c 6261 636b 5f6d 616e  get_callback_man
-000085d0: 6167 6572 5f66 6f72 5f63 6f6e 6669 6728  ager_for_config(
-000085e0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-000085f0: 7275 6e5f 6d61 6e61 6765 7220 3d20 6361  run_manager = ca
-00008600: 6c6c 6261 636b 5f6d 616e 6167 6572 2e6f  llback_manager.o
-00008610: 6e5f 6368 6169 6e5f 7374 6172 7428 0a20  n_chain_start(. 
-00008620: 2020 2020 2020 2020 2020 2064 756d 7064             dumpd
-00008630: 2873 656c 6629 2c0a 2020 2020 2020 2020  (self),.        
-00008640: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
-00008650: 2020 2020 2020 2072 756e 5f74 7970 653d         run_type=
-00008660: 7275 6e5f 7479 7065 2c0a 2020 2020 2020  run_type,.      
-00008670: 2020 2020 2020 6e61 6d65 3d63 6f6e 6669        name=confi
-00008680: 672e 6765 7428 2272 756e 5f6e 616d 6522  g.get("run_name"
-00008690: 2920 6f72 2073 656c 662e 6765 745f 6e61  ) or self.get_na
-000086a0: 6d65 2829 2c0a 2020 2020 2020 2020 290a  me(),.        ).
-000086b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000086c0: 2020 2020 2020 2020 2063 6869 6c64 5f63           child_c
-000086d0: 6f6e 6669 6720 3d20 7061 7463 685f 636f  onfig = patch_co
-000086e0: 6e66 6967 2863 6f6e 6669 672c 2063 616c  nfig(config, cal
-000086f0: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
-00008700: 6572 2e67 6574 5f63 6869 6c64 2829 290a  er.get_child()).
-00008710: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00008720: 6578 7420 3d20 636f 7079 5f63 6f6e 7465  ext = copy_conte
-00008730: 7874 2829 0a20 2020 2020 2020 2020 2020  xt().           
-00008740: 2063 6f6e 7465 7874 2e72 756e 2876 6172   context.run(var
-00008750: 5f63 6869 6c64 5f72 756e 6e61 626c 655f  _child_runnable_
-00008760: 636f 6e66 6967 2e73 6574 2c20 6368 696c  config.set, chil
-00008770: 645f 636f 6e66 6967 290a 2020 2020 2020  d_config).      
-00008780: 2020 2020 2020 6f75 7470 7574 203d 2063        output = c
-00008790: 6173 7428 0a20 2020 2020 2020 2020 2020  ast(.           
-000087a0: 2020 2020 204f 7574 7075 742c 0a20 2020       Output,.   
-000087b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000087c0: 7465 7874 2e72 756e 280a 2020 2020 2020  text.run(.      
-000087d0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-000087e0: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
-000087f0: 6961 626c 655f 6172 6773 2c0a 2020 2020  iable_args,.    
-00008800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008810: 6675 6e63 2c20 2023 2074 7970 653a 2069  func,  # type: i
-00008820: 676e 6f72 655b 6172 672d 7479 7065 5d0a  gnore[arg-type].
-00008830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008840: 2020 2020 696e 7075 742c 2020 2320 7479      input,  # ty
-00008850: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
-00008860: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
-00008870: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
-00008880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008890: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-000088a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000088b0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-000088c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088d0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-000088e0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-000088f0: 4261 7365 4578 6365 7074 696f 6e20 6173  BaseException as
-00008900: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00008910: 7275 6e5f 6d61 6e61 6765 722e 6f6e 5f63  run_manager.on_c
-00008920: 6861 696e 5f65 7272 6f72 2865 290a 2020  hain_error(e).  
-00008930: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-00008940: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00008950: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
-00008960: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
-00008970: 6e64 2864 756d 7064 286f 7574 7075 7429  nd(dumpd(output)
-00008980: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00008990: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
-000089a0: 2061 7379 6e63 2064 6566 205f 6163 616c   async def _acal
-000089b0: 6c5f 7769 7468 5f63 6f6e 6669 6728 0a20  l_with_config(. 
-000089c0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-000089d0: 2020 2020 2066 756e 633a 2055 6e69 6f6e       func: Union
-000089e0: 5b0a 2020 2020 2020 2020 2020 2020 4361  [.            Ca
-000089f0: 6c6c 6162 6c65 5b5b 496e 7075 745d 2c20  llable[[Input], 
-00008a00: 4177 6169 7461 626c 655b 4f75 7470 7574  Awaitable[Output
-00008a10: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-00008a20: 4361 6c6c 6162 6c65 5b5b 496e 7075 742c  Callable[[Input,
-00008a30: 2041 7379 6e63 4361 6c6c 6261 636b 4d61   AsyncCallbackMa
-00008a40: 6e61 6765 7246 6f72 4368 6169 6e52 756e  nagerForChainRun
-00008a50: 5d2c 2041 7761 6974 6162 6c65 5b4f 7574  ], Awaitable[Out
-00008a60: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
-00008a70: 2020 2043 616c 6c61 626c 655b 0a20 2020     Callable[.   
-00008a80: 2020 2020 2020 2020 2020 2020 205b 496e               [In
-00008a90: 7075 742c 2041 7379 6e63 4361 6c6c 6261  put, AsyncCallba
-00008aa0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-00008ab0: 6e52 756e 2c20 5275 6e6e 6162 6c65 436f  nRun, RunnableCo
-00008ac0: 6e66 6967 5d2c 0a20 2020 2020 2020 2020  nfig],.         
-00008ad0: 2020 2020 2020 2041 7761 6974 6162 6c65         Awaitable
-00008ae0: 5b4f 7574 7075 745d 2c0a 2020 2020 2020  [Output],.      
-00008af0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00008b00: 205d 2c0a 2020 2020 2020 2020 696e 7075   ],.        inpu
-00008b10: 743a 2049 6e70 7574 2c0a 2020 2020 2020  t: Input,.      
-00008b20: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
-00008b30: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
-00008b40: 675d 2c0a 2020 2020 2020 2020 7275 6e5f  g],.        run_
-00008b50: 7479 7065 3a20 4f70 7469 6f6e 616c 5b73  type: Optional[s
-00008b60: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00008b70: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-00008b80: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-00008b90: 2029 202d 3e20 4f75 7470 7574 3a0a 2020   ) -> Output:.  
-00008ba0: 2020 2020 2020 2222 2248 656c 7065 7220        """Helper 
-00008bb0: 6d65 7468 6f64 2074 6f20 7472 616e 7366  method to transf
-00008bc0: 6f72 6d20 616e 2049 6e70 7574 2076 616c  orm an Input val
-00008bd0: 7565 2074 6f20 616e 204f 7574 7075 7420  ue to an Output 
-00008be0: 7661 6c75 652c 0a20 2020 2020 2020 2077  value,.        w
-00008bf0: 6974 6820 6361 6c6c 6261 636b 732e 2055  ith callbacks. U
-00008c00: 7365 2074 6869 7320 6d65 7468 6f64 2074  se this method t
-00008c10: 6f20 696d 706c 656d 656e 7420 6169 6e76  o implement ainv
-00008c20: 6f6b 6528 2920 696e 2073 7562 636c 6173  oke() in subclas
-00008c30: 7365 732e 2222 220a 2020 2020 2020 2020  ses.""".        
-00008c40: 636f 6e66 6967 203d 2065 6e73 7572 655f  config = ensure_
-00008c50: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
-00008c60: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
-00008c70: 6d61 6e61 6765 7220 3d20 6765 745f 6173  manager = get_as
-00008c80: 796e 635f 6361 6c6c 6261 636b 5f6d 616e  ync_callback_man
-00008c90: 6167 6572 5f66 6f72 5f63 6f6e 6669 6728  ager_for_config(
-00008ca0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-00008cb0: 7275 6e5f 6d61 6e61 6765 7220 3d20 6177  run_manager = aw
-00008cc0: 6169 7420 6361 6c6c 6261 636b 5f6d 616e  ait callback_man
-00008cd0: 6167 6572 2e6f 6e5f 6368 6169 6e5f 7374  ager.on_chain_st
-00008ce0: 6172 7428 0a20 2020 2020 2020 2020 2020  art(.           
-00008cf0: 2064 756d 7064 2873 656c 6629 2c0a 2020   dumpd(self),.  
-00008d00: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-00008d10: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
-00008d20: 5f74 7970 653d 7275 6e5f 7479 7065 2c0a  _type=run_type,.
-00008d30: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00008d40: 3d63 6f6e 6669 672e 6765 7428 2272 756e  =config.get("run
-00008d50: 5f6e 616d 6522 2920 6f72 2073 656c 662e  _name") or self.
-00008d60: 6765 745f 6e61 6d65 2829 2c0a 2020 2020  get_name(),.    
-00008d70: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
-00008d80: 793a 0a20 2020 2020 2020 2020 2020 2063  y:.            c
-00008d90: 6869 6c64 5f63 6f6e 6669 6720 3d20 7061  hild_config = pa
-00008da0: 7463 685f 636f 6e66 6967 2863 6f6e 6669  tch_config(confi
-00008db0: 672c 2063 616c 6c62 6163 6b73 3d72 756e  g, callbacks=run
-00008dc0: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
-00008dd0: 6c64 2829 290a 2020 2020 2020 2020 2020  ld()).          
-00008de0: 2020 636f 6e74 6578 7420 3d20 636f 7079    context = copy
-00008df0: 5f63 6f6e 7465 7874 2829 0a20 2020 2020  _context().     
-00008e00: 2020 2020 2020 2063 6f6e 7465 7874 2e72         context.r
-00008e10: 756e 2876 6172 5f63 6869 6c64 5f72 756e  un(var_child_run
-00008e20: 6e61 626c 655f 636f 6e66 6967 2e73 6574  nable_config.set
-00008e30: 2c20 6368 696c 645f 636f 6e66 6967 290a  , child_config).
-00008e40: 2020 2020 2020 2020 2020 2020 636f 726f              coro
-00008e50: 203d 2061 6361 6c6c 5f66 756e 635f 7769   = acall_func_wi
-00008e60: 7468 5f76 6172 6961 626c 655f 6172 6773  th_variable_args
-00008e70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008e80: 2020 6675 6e63 2c20 696e 7075 742c 2063    func, input, c
-00008e90: 6f6e 6669 672c 2072 756e 5f6d 616e 6167  onfig, run_manag
-00008ea0: 6572 2c20 2a2a 6b77 6172 6773 0a20 2020  er, **kwargs.   
-00008eb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00008ec0: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
-00008ed0: 735f 636f 6e74 6578 7428 6173 796e 6369  s_context(asynci
-00008ee0: 6f2e 6372 6561 7465 5f74 6173 6b29 3a0a  o.create_task):.
-00008ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f00: 6f75 7470 7574 3a20 4f75 7470 7574 203d  output: Output =
-00008f10: 2061 7761 6974 2061 7379 6e63 696f 2e63   await asyncio.c
-00008f20: 7265 6174 655f 7461 736b 2863 6f72 6f2c  reate_task(coro,
-00008f30: 2063 6f6e 7465 7874 3d63 6f6e 7465 7874   context=context
-00008f40: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-00008f50: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-00008f60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008f70: 2020 2020 6f75 7470 7574 203d 2061 7761      output = awa
-00008f80: 6974 2063 6f72 6f0a 2020 2020 2020 2020  it coro.        
-00008f90: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
-00008fa0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00008fb0: 2020 2020 2020 2061 7761 6974 2072 756e         await run
-00008fc0: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
-00008fd0: 6e5f 6572 726f 7228 6529 0a20 2020 2020  n_error(e).     
-00008fe0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00008ff0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00009000: 2020 2020 2020 2061 7761 6974 2072 756e         await run
-00009010: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
-00009020: 6e5f 656e 6428 6475 6d70 6428 6f75 7470  n_end(dumpd(outp
-00009030: 7574 2929 0a20 2020 2020 2020 2020 2020  ut)).           
-00009040: 2072 6574 7572 6e20 6f75 7470 7574 0a0a   return output..
-00009050: 2020 2020 6465 6620 5f62 6174 6368 5f77      def _batch_w
-00009060: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
-00009070: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00009080: 2020 6675 6e63 3a20 556e 696f 6e5b 0a20    func: Union[. 
-00009090: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-000090a0: 626c 655b 5b4c 6973 745b 496e 7075 745d  ble[[List[Input]
-000090b0: 5d2c 204c 6973 745b 556e 696f 6e5b 4578  ], List[Union[Ex
-000090c0: 6365 7074 696f 6e2c 204f 7574 7075 745d  ception, Output]
-000090d0: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-000090e0: 4361 6c6c 6162 6c65 5b0a 2020 2020 2020  Callable[.      
-000090f0: 2020 2020 2020 2020 2020 5b4c 6973 745b            [List[
-00009100: 496e 7075 745d 2c20 4c69 7374 5b43 616c  Input], List[Cal
-00009110: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
-00009120: 6861 696e 5275 6e5d 5d2c 0a20 2020 2020  hainRun]],.     
-00009130: 2020 2020 2020 2020 2020 204c 6973 745b             List[
-00009140: 556e 696f 6e5b 4578 6365 7074 696f 6e2c  Union[Exception,
-00009150: 204f 7574 7075 745d 5d2c 0a20 2020 2020   Output]],.     
-00009160: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00009170: 2020 2020 2020 4361 6c6c 6162 6c65 5b0a        Callable[.
-00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009190: 5b4c 6973 745b 496e 7075 745d 2c20 4c69  [List[Input], Li
-000091a0: 7374 5b43 616c 6c62 6163 6b4d 616e 6167  st[CallbackManag
-000091b0: 6572 466f 7243 6861 696e 5275 6e5d 2c20  erForChainRun], 
-000091c0: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
-000091d0: 6669 675d 5d2c 0a20 2020 2020 2020 2020  fig]],.         
-000091e0: 2020 2020 2020 204c 6973 745b 556e 696f         List[Unio
-000091f0: 6e5b 4578 6365 7074 696f 6e2c 204f 7574  n[Exception, Out
-00009200: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
-00009210: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
-00009220: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
-00009230: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
-00009240: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
-00009250: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
-00009260: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
-00009270: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00009280: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-00009290: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
-000092a0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
-000092b0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-000092c0: 2020 2020 2020 2072 756e 5f74 7970 653a         run_type:
-000092d0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-000092e0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-000092f0: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
-00009300: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
-00009310: 204c 6973 745b 4f75 7470 7574 5d3a 0a20   List[Output]:. 
-00009320: 2020 2020 2020 2022 2222 4865 6c70 6572         """Helper
-00009330: 206d 6574 686f 6420 746f 2074 7261 6e73   method to trans
-00009340: 666f 726d 2061 6e20 496e 7075 7420 7661  form an Input va
-00009350: 6c75 6520 746f 2061 6e20 4f75 7470 7574  lue to an Output
-00009360: 2076 616c 7565 2c0a 2020 2020 2020 2020   value,.        
-00009370: 7769 7468 2063 616c 6c62 6163 6b73 2e20  with callbacks. 
-00009380: 5573 6520 7468 6973 206d 6574 686f 6420  Use this method 
-00009390: 746f 2069 6d70 6c65 6d65 6e74 2069 6e76  to implement inv
-000093a0: 6f6b 6528 2920 696e 2073 7562 636c 6173  oke() in subclas
-000093b0: 7365 732e 2222 220a 2020 2020 2020 2020  ses.""".        
-000093c0: 6966 206e 6f74 2069 6e70 7574 3a0a 2020  if not input:.  
-000093d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000093e0: 205b 5d0a 0a20 2020 2020 2020 2063 6f6e   []..        con
-000093f0: 6669 6773 203d 2067 6574 5f63 6f6e 6669  figs = get_confi
-00009400: 675f 6c69 7374 2863 6f6e 6669 672c 206c  g_list(config, l
-00009410: 656e 2869 6e70 7574 2929 0a20 2020 2020  en(input)).     
-00009420: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
-00009430: 6765 7273 203d 205b 6765 745f 6361 6c6c  gers = [get_call
-00009440: 6261 636b 5f6d 616e 6167 6572 5f66 6f72  back_manager_for
-00009450: 5f63 6f6e 6669 6728 6329 2066 6f72 2063  _config(c) for c
-00009460: 2069 6e20 636f 6e66 6967 735d 0a20 2020   in configs].   
-00009470: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-00009480: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00009490: 2020 6361 6c6c 6261 636b 5f6d 616e 6167    callback_manag
-000094a0: 6572 2e6f 6e5f 6368 6169 6e5f 7374 6172  er.on_chain_star
-000094b0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-000094c0: 2020 2064 756d 7064 2873 656c 6629 2c0a     dumpd(self),.
+00002eb0: 2020 2020 2020 2020 2020 7370 6563 2e64            spec.d
+00002ec0: 6566 6175 6c74 2c20 7469 746c 653d 7370  efault, title=sp
+00002ed0: 6563 2e6e 616d 652c 2064 6573 6372 6970  ec.name, descrip
+00002ee0: 7469 6f6e 3d73 7065 632e 6465 7363 7269  tion=spec.descri
+00002ef0: 7074 696f 6e0a 2020 2020 2020 2020 2020  ption.          
+00002f00: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+00002f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002f20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00002f30: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
+00002f40: 7065 6320 696e 2063 6f6e 6669 675f 7370  pec in config_sp
+00002f50: 6563 730a 2020 2020 2020 2020 2020 2020  ecs.            
+00002f60: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00002f70: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00002f80: 2069 6620 636f 6e66 6967 5f73 7065 6373   if config_specs
+00002f90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00002fa0: 6520 4e6f 6e65 0a20 2020 2020 2020 2029  e None.        )
+00002fb0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00002fc0: 2063 7265 6174 655f 6d6f 6465 6c28 2020   create_model(  
+00002fd0: 2320 7479 7065 3a20 6967 6e6f 7265 5b63  # type: ignore[c
+00002fe0: 616c 6c2d 6f76 6572 6c6f 6164 5d0a 2020  all-overload].  
+00002ff0: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
+00003000: 6574 5f6e 616d 6528 2243 6f6e 6669 6722  et_name("Config"
+00003010: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+00003020: 2a28 7b22 636f 6e66 6967 7572 6162 6c65  *({"configurable
+00003030: 223a 2028 636f 6e66 6967 7572 6162 6c65  ": (configurable
+00003040: 2c20 4e6f 6e65 297d 2069 6620 636f 6e66  , None)} if conf
+00003050: 6967 7572 6162 6c65 2065 6c73 6520 7b7d  igurable else {}
+00003060: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+00003070: 2a7b 0a20 2020 2020 2020 2020 2020 2020  *{.             
+00003080: 2020 2066 6965 6c64 5f6e 616d 653a 2028     field_name: (
+00003090: 6669 656c 645f 7479 7065 2c20 4e6f 6e65  field_type, None
+000030a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000030b0: 2020 666f 7220 6669 656c 645f 6e61 6d65    for field_name
+000030c0: 2c20 6669 656c 645f 7479 7065 2069 6e20  , field_type in 
+000030d0: 5275 6e6e 6162 6c65 436f 6e66 6967 2e5f  RunnableConfig._
+000030e0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 2e69  _annotations__.i
+000030f0: 7465 6d73 2829 0a20 2020 2020 2020 2020  tems().         
+00003100: 2020 2020 2020 2069 6620 6669 656c 645f         if field_
+00003110: 6e61 6d65 2069 6e20 5b69 2066 6f72 2069  name in [i for i
+00003120: 2069 6e20 696e 636c 7564 6520 6966 2069   in include if i
+00003130: 2021 3d20 2263 6f6e 6669 6775 7261 626c   != "configurabl
+00003140: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+00003150: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
+00003160: 2020 6465 6620 6765 745f 6772 6170 6828    def get_graph(
+00003170: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
+00003180: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+00003190: 6f6e 6669 675d 203d 204e 6f6e 6529 202d  onfig] = None) -
+000031a0: 3e20 4772 6170 683a 0a20 2020 2020 2020  > Graph:.       
+000031b0: 2022 2222 5265 7475 726e 2061 2067 7261   """Return a gra
+000031c0: 7068 2072 6570 7265 7365 6e74 6174 696f  ph representatio
+000031d0: 6e20 6f66 2074 6869 7320 7275 6e6e 6162  n of this runnab
+000031e0: 6c65 2e22 2222 0a20 2020 2020 2020 2066  le.""".        f
+000031f0: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00003200: 7265 2e72 756e 6e61 626c 6573 2e67 7261  re.runnables.gra
+00003210: 7068 2069 6d70 6f72 7420 4772 6170 680a  ph import Graph.
+00003220: 0a20 2020 2020 2020 2067 7261 7068 203d  .        graph =
+00003230: 2047 7261 7068 2829 0a20 2020 2020 2020   Graph().       
+00003240: 2069 6e70 7574 5f6e 6f64 6520 3d20 6772   input_node = gr
+00003250: 6170 682e 6164 645f 6e6f 6465 2873 656c  aph.add_node(sel
+00003260: 662e 6765 745f 696e 7075 745f 7363 6865  f.get_input_sche
+00003270: 6d61 2863 6f6e 6669 6729 290a 2020 2020  ma(config)).    
+00003280: 2020 2020 7275 6e6e 6162 6c65 5f6e 6f64      runnable_nod
+00003290: 6520 3d20 6772 6170 682e 6164 645f 6e6f  e = graph.add_no
+000032a0: 6465 2873 656c 6629 0a20 2020 2020 2020  de(self).       
+000032b0: 206f 7574 7075 745f 6e6f 6465 203d 2067   output_node = g
+000032c0: 7261 7068 2e61 6464 5f6e 6f64 6528 7365  raph.add_node(se
+000032d0: 6c66 2e67 6574 5f6f 7574 7075 745f 7363  lf.get_output_sc
+000032e0: 6865 6d61 2863 6f6e 6669 6729 290a 2020  hema(config)).  
+000032f0: 2020 2020 2020 6772 6170 682e 6164 645f        graph.add_
+00003300: 6564 6765 2869 6e70 7574 5f6e 6f64 652c  edge(input_node,
+00003310: 2072 756e 6e61 626c 655f 6e6f 6465 290a   runnable_node).
+00003320: 2020 2020 2020 2020 6772 6170 682e 6164          graph.ad
+00003330: 645f 6564 6765 2872 756e 6e61 626c 655f  d_edge(runnable_
+00003340: 6e6f 6465 2c20 6f75 7470 7574 5f6e 6f64  node, output_nod
+00003350: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+00003360: 6e20 6772 6170 680a 0a20 2020 2064 6566  n graph..    def
+00003370: 2067 6574 5f70 726f 6d70 7473 280a 2020   get_prompts(.  
+00003380: 2020 2020 2020 7365 6c66 2c20 636f 6e66        self, conf
+00003390: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+000033a0: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+000033b0: 6f6e 650a 2020 2020 2920 2d3e 204c 6973  one.    ) -> Lis
+000033c0: 745b 4261 7365 5072 6f6d 7074 5465 6d70  t[BasePromptTemp
+000033d0: 6c61 7465 5d3a 0a20 2020 2020 2020 2066  late]:.        f
+000033e0: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+000033f0: 7265 2e70 726f 6d70 7473 2e62 6173 6520  re.prompts.base 
+00003400: 696d 706f 7274 2042 6173 6550 726f 6d70  import BasePromp
+00003410: 7454 656d 706c 6174 650a 0a20 2020 2020  tTemplate..     
+00003420: 2020 2070 726f 6d70 7473 203d 205b 5d0a     prompts = [].
+00003430: 2020 2020 2020 2020 666f 7220 5f2c 206e          for _, n
+00003440: 6f64 6520 696e 2073 656c 662e 6765 745f  ode in self.get_
+00003450: 6772 6170 6828 636f 6e66 6967 3d63 6f6e  graph(config=con
+00003460: 6669 6729 2e6e 6f64 6573 2e69 7465 6d73  fig).nodes.items
+00003470: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00003480: 6966 2069 7369 6e73 7461 6e63 6528 6e6f  if isinstance(no
+00003490: 6465 2e64 6174 612c 2042 6173 6550 726f  de.data, BasePro
+000034a0: 6d70 7454 656d 706c 6174 6529 3a0a 2020  mptTemplate):.  
+000034b0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000034c0: 6f6d 7074 732e 6170 7065 6e64 286e 6f64  ompts.append(nod
+000034d0: 652e 6461 7461 290a 2020 2020 2020 2020  e.data).        
+000034e0: 7265 7475 726e 2070 726f 6d70 7473 0a0a  return prompts..
+000034f0: 2020 2020 6465 6620 5f5f 6f72 5f5f 280a      def __or__(.
+00003500: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00003510: 2020 2020 2020 6f74 6865 723a 2055 6e69        other: Uni
+00003520: 6f6e 5b0a 2020 2020 2020 2020 2020 2020  on[.            
+00003530: 5275 6e6e 6162 6c65 5b41 6e79 2c20 4f74  Runnable[Any, Ot
+00003540: 6865 725d 2c0a 2020 2020 2020 2020 2020  her],.          
+00003550: 2020 4361 6c6c 6162 6c65 5b5b 416e 795d    Callable[[Any]
+00003560: 2c20 4f74 6865 725d 2c0a 2020 2020 2020  , Other],.      
+00003570: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
+00003580: 4974 6572 6174 6f72 5b41 6e79 5d5d 2c20  Iterator[Any]], 
+00003590: 4974 6572 6174 6f72 5b4f 7468 6572 5d5d  Iterator[Other]]
+000035a0: 2c0a 2020 2020 2020 2020 2020 2020 4d61  ,.            Ma
+000035b0: 7070 696e 675b 7374 722c 2055 6e69 6f6e  pping[str, Union
+000035c0: 5b52 756e 6e61 626c 655b 416e 792c 204f  [Runnable[Any, O
+000035d0: 7468 6572 5d2c 2043 616c 6c61 626c 655b  ther], Callable[
+000035e0: 5b41 6e79 5d2c 204f 7468 6572 5d2c 2041  [Any], Other], A
+000035f0: 6e79 5d5d 2c0a 2020 2020 2020 2020 5d2c  ny]],.        ],
+00003600: 0a20 2020 2029 202d 3e20 5275 6e6e 6162  .    ) -> Runnab
+00003610: 6c65 5365 7269 616c 697a 6162 6c65 5b49  leSerializable[I
+00003620: 6e70 7574 2c20 4f74 6865 725d 3a0a 2020  nput, Other]:.  
+00003630: 2020 2020 2020 2222 2243 6f6d 706f 7365        """Compose
+00003640: 2074 6869 7320 7275 6e6e 6162 6c65 2077   this runnable w
+00003650: 6974 6820 616e 6f74 6865 7220 6f62 6a65  ith another obje
+00003660: 6374 2074 6f20 6372 6561 7465 2061 2052  ct to create a R
+00003670: 756e 6e61 626c 6553 6571 7565 6e63 652e  unnableSequence.
+00003680: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00003690: 726e 2052 756e 6e61 626c 6553 6571 7565  rn RunnableSeque
+000036a0: 6e63 6528 7365 6c66 2c20 636f 6572 6365  nce(self, coerce
+000036b0: 5f74 6f5f 7275 6e6e 6162 6c65 286f 7468  _to_runnable(oth
+000036c0: 6572 2929 0a0a 2020 2020 6465 6620 5f5f  er))..    def __
+000036d0: 726f 725f 5f28 0a20 2020 2020 2020 2073  ror__(.        s
+000036e0: 656c 662c 0a20 2020 2020 2020 206f 7468  elf,.        oth
+000036f0: 6572 3a20 556e 696f 6e5b 0a20 2020 2020  er: Union[.     
+00003700: 2020 2020 2020 2052 756e 6e61 626c 655b         Runnable[
+00003710: 4f74 6865 722c 2041 6e79 5d2c 0a20 2020  Other, Any],.   
+00003720: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
+00003730: 655b 5b4f 7468 6572 5d2c 2041 6e79 5d2c  e[[Other], Any],
+00003740: 0a20 2020 2020 2020 2020 2020 2043 616c  .            Cal
+00003750: 6c61 626c 655b 5b49 7465 7261 746f 725b  lable[[Iterator[
+00003760: 4f74 6865 725d 5d2c 2049 7465 7261 746f  Other]], Iterato
+00003770: 725b 416e 795d 5d2c 0a20 2020 2020 2020  r[Any]],.       
+00003780: 2020 2020 204d 6170 7069 6e67 5b73 7472       Mapping[str
+00003790: 2c20 556e 696f 6e5b 5275 6e6e 6162 6c65  , Union[Runnable
+000037a0: 5b4f 7468 6572 2c20 416e 795d 2c20 4361  [Other, Any], Ca
+000037b0: 6c6c 6162 6c65 5b5b 4f74 6865 725d 2c20  llable[[Other], 
+000037c0: 416e 795d 2c20 416e 795d 5d2c 0a20 2020  Any], Any]],.   
+000037d0: 2020 2020 205d 2c0a 2020 2020 2920 2d3e       ],.    ) ->
+000037e0: 2052 756e 6e61 626c 6553 6572 6961 6c69   RunnableSeriali
+000037f0: 7a61 626c 655b 4f74 6865 722c 204f 7574  zable[Other, Out
+00003800: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
+00003810: 2243 6f6d 706f 7365 2074 6869 7320 7275  "Compose this ru
+00003820: 6e6e 6162 6c65 2077 6974 6820 616e 6f74  nnable with anot
+00003830: 6865 7220 6f62 6a65 6374 2074 6f20 6372  her object to cr
+00003840: 6561 7465 2061 2052 756e 6e61 626c 6553  eate a RunnableS
+00003850: 6571 7565 6e63 652e 2222 220a 2020 2020  equence.""".    
+00003860: 2020 2020 7265 7475 726e 2052 756e 6e61      return Runna
+00003870: 626c 6553 6571 7565 6e63 6528 636f 6572  bleSequence(coer
+00003880: 6365 5f74 6f5f 7275 6e6e 6162 6c65 286f  ce_to_runnable(o
+00003890: 7468 6572 292c 2073 656c 6629 0a0a 2020  ther), self)..  
+000038a0: 2020 6465 6620 7069 7065 280a 2020 2020    def pipe(.    
+000038b0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000038c0: 2020 2a6f 7468 6572 733a 2055 6e69 6f6e    *others: Union
+000038d0: 5b52 756e 6e61 626c 655b 416e 792c 204f  [Runnable[Any, O
+000038e0: 7468 6572 5d2c 2043 616c 6c61 626c 655b  ther], Callable[
+000038f0: 5b41 6e79 5d2c 204f 7468 6572 5d5d 2c0a  [Any], Other]],.
+00003900: 2020 2020 2020 2020 6e61 6d65 3a20 4f70          name: Op
+00003910: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00003920: 6e65 2c0a 2020 2020 2920 2d3e 2052 756e  ne,.    ) -> Run
+00003930: 6e61 626c 6553 6572 6961 6c69 7a61 626c  nableSerializabl
+00003940: 655b 496e 7075 742c 204f 7468 6572 5d3a  e[Input, Other]:
+00003950: 0a20 2020 2020 2020 2022 2222 436f 6d70  .        """Comp
+00003960: 6f73 6520 7468 6973 2052 756e 6e61 626c  ose this Runnabl
+00003970: 6520 7769 7468 2052 756e 6e61 626c 652d  e with Runnable-
+00003980: 6c69 6b65 206f 626a 6563 7473 2074 6f20  like objects to 
+00003990: 6d61 6b65 2061 2052 756e 6e61 626c 6553  make a RunnableS
+000039a0: 6571 7565 6e63 652e 0a0a 2020 2020 2020  equence...      
+000039b0: 2020 4571 7569 7661 6c65 6e74 2074 6f20    Equivalent to 
+000039c0: 6052 756e 6e61 626c 6553 6571 7565 6e63  `RunnableSequenc
+000039d0: 6528 7365 6c66 2c20 2a6f 7468 6572 7329  e(self, *others)
+000039e0: 6020 6f72 2060 7365 6c66 207c 206f 7468  ` or `self | oth
+000039f0: 6572 735b 305d 207c 202e 2e2e 600a 0a20  ers[0] | ...`.. 
+00003a00: 2020 2020 2020 2045 7861 6d70 6c65 3a0a         Example:.
+00003a10: 2020 2020 2020 2020 2020 2020 2e2e 2063              .. c
+00003a20: 6f64 652d 626c 6f63 6b3a 3a20 7079 7468  ode-block:: pyth
+00003a30: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+00003a40: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
+00003a50: 696e 5f63 6f72 652e 7275 6e6e 6162 6c65  in_core.runnable
+00003a60: 7320 696d 706f 7274 2052 756e 6e61 626c  s import Runnabl
+00003a70: 654c 616d 6264 610a 0a20 2020 2020 2020  eLambda..       
+00003a80: 2020 2020 2020 2020 2064 6566 2061 6464           def add
+00003a90: 5f6f 6e65 2878 3a20 696e 7429 202d 3e20  _one(x: int) -> 
+00003aa0: 696e 743a 0a20 2020 2020 2020 2020 2020  int:.           
+00003ab0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00003ac0: 7820 2b20 310a 0a20 2020 2020 2020 2020  x + 1..         
+00003ad0: 2020 2020 2020 2064 6566 206d 756c 5f74         def mul_t
+00003ae0: 776f 2878 3a20 696e 7429 202d 3e20 696e  wo(x: int) -> in
+00003af0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00003b00: 2020 2020 2020 2072 6574 7572 6e20 7820         return x 
+00003b10: 2a20 320a 0a20 2020 2020 2020 2020 2020  * 2..           
+00003b20: 2020 2020 2072 756e 6e61 626c 655f 3120       runnable_1 
+00003b30: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
+00003b40: 2861 6464 5f6f 6e65 290a 2020 2020 2020  (add_one).      
+00003b50: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
+00003b60: 6c65 5f32 203d 2052 756e 6e61 626c 654c  le_2 = RunnableL
+00003b70: 616d 6264 6128 6d75 6c5f 7477 6f29 0a20  ambda(mul_two). 
+00003b80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003b90: 6571 7565 6e63 6520 3d20 7275 6e6e 6162  equence = runnab
+00003ba0: 6c65 5f31 2e70 6970 6528 7275 6e6e 6162  le_1.pipe(runnab
+00003bb0: 6c65 5f32 290a 2020 2020 2020 2020 2020  le_2).          
+00003bc0: 2020 2020 2020 2320 4f72 2065 7175 6976        # Or equiv
+00003bd0: 616c 656e 746c 793a 0a20 2020 2020 2020  alently:.       
+00003be0: 2020 2020 2020 2020 2023 2073 6571 7565           # seque
+00003bf0: 6e63 6520 3d20 7275 6e6e 6162 6c65 5f31  nce = runnable_1
+00003c00: 207c 2072 756e 6e61 626c 655f 320a 2020   | runnable_2.  
+00003c10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00003c20: 7365 7175 656e 6365 203d 2052 756e 6e61  sequence = Runna
+00003c30: 626c 6553 6571 7565 6e63 6528 6669 7273  bleSequence(firs
+00003c40: 743d 7275 6e6e 6162 6c65 5f31 2c20 6c61  t=runnable_1, la
+00003c50: 7374 3d72 756e 6e61 626c 655f 3229 0a20  st=runnable_2). 
+00003c60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003c70: 6571 7565 6e63 652e 696e 766f 6b65 2831  equence.invoke(1
+00003c80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00003c90: 2020 6177 6169 7420 7365 7175 656e 6365    await sequence
+00003ca0: 2e61 696e 766f 6b65 2831 290a 2020 2020  .ainvoke(1).    
+00003cb0: 2020 2020 2020 2020 2020 2020 2320 2d3e              # ->
+00003cc0: 2034 0a0a 2020 2020 2020 2020 2020 2020   4..            
+00003cd0: 2020 2020 7365 7175 656e 6365 2e62 6174      sequence.bat
+00003ce0: 6368 285b 312c 2032 2c20 335d 290a 2020  ch([1, 2, 3]).  
+00003cf0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00003d00: 6169 7420 7365 7175 656e 6365 2e61 6261  ait sequence.aba
+00003d10: 7463 6828 5b31 2c20 322c 2033 5d29 0a20  tch([1, 2, 3]). 
+00003d20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00003d30: 202d 3e20 5b34 2c20 362c 2038 5d0a 2020   -> [4, 6, 8].  
+00003d40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00003d50: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
+00003d60: 6553 6571 7565 6e63 6528 7365 6c66 2c20  eSequence(self, 
+00003d70: 2a6f 7468 6572 732c 206e 616d 653d 6e61  *others, name=na
+00003d80: 6d65 290a 0a20 2020 2064 6566 2070 6963  me)..    def pic
+00003d90: 6b28 7365 6c66 2c20 6b65 7973 3a20 556e  k(self, keys: Un
+00003da0: 696f 6e5b 7374 722c 204c 6973 745b 7374  ion[str, List[st
+00003db0: 725d 5d29 202d 3e20 5275 6e6e 6162 6c65  r]]) -> Runnable
+00003dc0: 5365 7269 616c 697a 6162 6c65 5b41 6e79  Serializable[Any
+00003dd0: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+00003de0: 2222 2250 6963 6b20 6b65 7973 2066 726f  """Pick keys fro
+00003df0: 6d20 7468 6520 6469 6374 206f 7574 7075  m the dict outpu
+00003e00: 7420 6f66 2074 6869 7320 7275 6e6e 6162  t of this runnab
+00003e10: 6c65 2e0a 0a20 2020 2020 2020 2050 6963  le...        Pic
+00003e20: 6b20 7369 6e67 6c65 206b 6579 3a0a 2020  k single key:.  
+00003e30: 2020 2020 2020 2020 2020 2e2e 2063 6f64            .. cod
+00003e40: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
+00003e50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00003e60: 2020 696d 706f 7274 206a 736f 6e0a 0a20    import json.. 
+00003e70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00003e80: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00003e90: 7265 2e72 756e 6e61 626c 6573 2069 6d70  re.runnables imp
+00003ea0: 6f72 7420 5275 6e6e 6162 6c65 4c61 6d62  ort RunnableLamb
+00003eb0: 6461 2c20 5275 6e6e 6162 6c65 4d61 700a  da, RunnableMap.
+00003ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ed0: 2061 735f 7374 7220 3d20 5275 6e6e 6162   as_str = Runnab
+00003ee0: 6c65 4c61 6d62 6461 2873 7472 290a 2020  leLambda(str).  
+00003ef0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00003f00: 5f6a 736f 6e20 3d20 5275 6e6e 6162 6c65  _json = Runnable
+00003f10: 4c61 6d62 6461 286a 736f 6e2e 6c6f 6164  Lambda(json.load
+00003f20: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00003f30: 2020 2063 6861 696e 203d 2052 756e 6e61     chain = Runna
+00003f40: 626c 654d 6170 2873 7472 3d61 735f 7374  bleMap(str=as_st
+00003f50: 722c 206a 736f 6e3d 6173 5f6a 736f 6e29  r, json=as_json)
+00003f60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00003f70: 2020 6368 6169 6e2e 696e 766f 6b65 2822    chain.invoke("
+00003f80: 5b31 2c20 322c 2033 5d22 290a 2020 2020  [1, 2, 3]").    
+00003f90: 2020 2020 2020 2020 2020 2020 2320 2d3e              # ->
+00003fa0: 207b 2273 7472 223a 2022 5b31 2c20 322c   {"str": "[1, 2,
+00003fb0: 2033 5d22 2c20 226a 736f 6e22 3a20 5b31   3]", "json": [1
+00003fc0: 2c20 322c 2033 5d7d 0a0a 2020 2020 2020  , 2, 3]}..      
+00003fd0: 2020 2020 2020 2020 2020 6a73 6f6e 5f6f            json_o
+00003fe0: 6e6c 795f 6368 6169 6e20 3d20 6368 6169  nly_chain = chai
+00003ff0: 6e2e 7069 636b 2822 6a73 6f6e 2229 0a20  n.pick("json"). 
+00004000: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00004010: 736f 6e5f 6f6e 6c79 5f63 6861 696e 2e69  son_only_chain.i
+00004020: 6e76 6f6b 6528 225b 312c 2032 2c20 335d  nvoke("[1, 2, 3]
+00004030: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00004040: 2020 2023 202d 3e20 5b31 2c20 322c 2033     # -> [1, 2, 3
+00004050: 5d0a 0a20 2020 2020 2020 2050 6963 6b20  ]..        Pick 
+00004060: 6c69 7374 206f 6620 6b65 7973 3a0a 2020  list of keys:.  
+00004070: 2020 2020 2020 2020 2020 2e2e 2063 6f64            .. cod
+00004080: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
+00004090: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000040a0: 2020 6672 6f6d 2074 7970 696e 6720 696d    from typing im
+000040b0: 706f 7274 2041 6e79 0a0a 2020 2020 2020  port Any..      
+000040c0: 2020 2020 2020 2020 2020 696d 706f 7274            import
+000040d0: 206a 736f 6e0a 0a20 2020 2020 2020 2020   json..         
+000040e0: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
+000040f0: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
+00004100: 626c 6573 2069 6d70 6f72 7420 5275 6e6e  bles import Runn
+00004110: 6162 6c65 4c61 6d62 6461 2c20 5275 6e6e  ableLambda, Runn
+00004120: 6162 6c65 4d61 700a 0a20 2020 2020 2020  ableMap..       
+00004130: 2020 2020 2020 2020 2061 735f 7374 7220           as_str 
+00004140: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
+00004150: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
+00004160: 2020 2020 2020 6173 5f6a 736f 6e20 3d20        as_json = 
+00004170: 5275 6e6e 6162 6c65 4c61 6d62 6461 286a  RunnableLambda(j
+00004180: 736f 6e2e 6c6f 6164 7329 0a20 2020 2020  son.loads).     
+00004190: 2020 2020 2020 2020 2020 2064 6566 2061             def a
+000041a0: 735f 6279 7465 7328 783a 2041 6e79 2920  s_bytes(x: Any) 
+000041b0: 2d3e 2062 7974 6573 3a0a 2020 2020 2020  -> bytes:.      
+000041c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000041d0: 7475 726e 2062 7974 6573 2878 2c20 2275  turn bytes(x, "u
+000041e0: 7466 2d38 2229 0a0a 2020 2020 2020 2020  tf-8")..        
+000041f0: 2020 2020 2020 2020 6368 6169 6e20 3d20          chain = 
+00004200: 5275 6e6e 6162 6c65 4d61 7028 0a20 2020  RunnableMap(.   
+00004210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004220: 2073 7472 3d61 735f 7374 722c 0a20 2020   str=as_str,.   
+00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004240: 206a 736f 6e3d 6173 5f6a 736f 6e2c 0a20   json=as_json,. 
+00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004260: 2020 2062 7974 6573 3d52 756e 6e61 626c     bytes=Runnabl
+00004270: 654c 616d 6264 6128 6173 5f62 7974 6573  eLambda(as_bytes
+00004280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004290: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000042a0: 2020 2020 2063 6861 696e 2e69 6e76 6f6b       chain.invok
+000042b0: 6528 225b 312c 2032 2c20 335d 2229 0a20  e("[1, 2, 3]"). 
+000042c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000042d0: 202d 3e20 7b22 7374 7222 3a20 225b 312c   -> {"str": "[1,
+000042e0: 2032 2c20 335d 222c 2022 6a73 6f6e 223a   2, 3]", "json":
+000042f0: 205b 312c 2032 2c20 335d 2c20 2262 7974   [1, 2, 3], "byt
+00004300: 6573 223a 2062 225b 312c 2032 2c20 335d  es": b"[1, 2, 3]
+00004310: 227d 0a0a 2020 2020 2020 2020 2020 2020  "}..            
+00004320: 2020 2020 6a73 6f6e 5f61 6e64 5f62 7974      json_and_byt
+00004330: 6573 5f63 6861 696e 203d 2063 6861 696e  es_chain = chain
+00004340: 2e70 6963 6b28 5b22 6a73 6f6e 222c 2022  .pick(["json", "
+00004350: 6279 7465 7322 5d29 0a20 2020 2020 2020  bytes"]).       
+00004360: 2020 2020 2020 2020 206a 736f 6e5f 616e           json_an
+00004370: 645f 6279 7465 735f 6368 6169 6e2e 696e  d_bytes_chain.in
+00004380: 766f 6b65 2822 5b31 2c20 322c 2033 5d22  voke("[1, 2, 3]"
+00004390: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000043a0: 2020 2320 2d3e 207b 226a 736f 6e22 3a20    # -> {"json": 
+000043b0: 5b31 2c20 322c 2033 5d2c 2022 6279 7465  [1, 2, 3], "byte
+000043c0: 7322 3a20 6222 5b31 2c20 322c 2033 5d22  s": b"[1, 2, 3]"
+000043d0: 7d0a 0a20 2020 2020 2020 2022 2222 2020  }..        """  
+000043e0: 2320 6e6f 7161 3a20 4535 3031 0a20 2020  # noqa: E501.   
+000043f0: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00004400: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
+00004410: 6573 2e70 6173 7374 6872 6f75 6768 2069  es.passthrough i
+00004420: 6d70 6f72 7420 5275 6e6e 6162 6c65 5069  mport RunnablePi
+00004430: 636b 0a0a 2020 2020 2020 2020 7265 7475  ck..        retu
+00004440: 726e 2073 656c 6620 7c20 5275 6e6e 6162  rn self | Runnab
+00004450: 6c65 5069 636b 286b 6579 7329 0a0a 2020  lePick(keys)..  
+00004460: 2020 6465 6620 6173 7369 676e 280a 2020    def assign(.  
+00004470: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00004480: 2020 2020 2a2a 6b77 6172 6773 3a20 556e      **kwargs: Un
+00004490: 696f 6e5b 0a20 2020 2020 2020 2020 2020  ion[.           
+000044a0: 2052 756e 6e61 626c 655b 4469 6374 5b73   Runnable[Dict[s
+000044b0: 7472 2c20 416e 795d 2c20 416e 795d 2c0a  tr, Any], Any],.
+000044c0: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+000044d0: 6162 6c65 5b5b 4469 6374 5b73 7472 2c20  able[[Dict[str, 
+000044e0: 416e 795d 5d2c 2041 6e79 5d2c 0a20 2020  Any]], Any],.   
+000044f0: 2020 2020 2020 2020 204d 6170 7069 6e67           Mapping
+00004500: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00004510: 2020 7374 722c 0a20 2020 2020 2020 2020    str,.         
+00004520: 2020 2020 2020 2055 6e69 6f6e 5b52 756e         Union[Run
+00004530: 6e61 626c 655b 4469 6374 5b73 7472 2c20  nable[Dict[str, 
+00004540: 416e 795d 2c20 416e 795d 2c20 4361 6c6c  Any], Any], Call
+00004550: 6162 6c65 5b5b 4469 6374 5b73 7472 2c20  able[[Dict[str, 
+00004560: 416e 795d 5d2c 2041 6e79 5d5d 2c0a 2020  Any]], Any]],.  
+00004570: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00004580: 2020 2020 205d 2c0a 2020 2020 2920 2d3e       ],.    ) ->
+00004590: 2052 756e 6e61 626c 6553 6572 6961 6c69   RunnableSeriali
+000045a0: 7a61 626c 655b 416e 792c 2041 6e79 5d3a  zable[Any, Any]:
+000045b0: 0a20 2020 2020 2020 2022 2222 4173 7369  .        """Assi
+000045c0: 676e 7320 6e65 7720 6669 656c 6473 2074  gns new fields t
+000045d0: 6f20 7468 6520 6469 6374 206f 7574 7075  o the dict outpu
+000045e0: 7420 6f66 2074 6869 7320 7275 6e6e 6162  t of this runnab
+000045f0: 6c65 2e0a 2020 2020 2020 2020 5265 7475  le..        Retu
+00004600: 726e 7320 6120 6e65 7720 7275 6e6e 6162  rns a new runnab
+00004610: 6c65 2e0a 0a20 2020 2020 2020 202e 2e20  le...        .. 
+00004620: 636f 6465 2d62 6c6f 636b 3a3a 2070 7974  code-block:: pyt
+00004630: 686f 6e0a 0a20 2020 2020 2020 2020 2020  hon..           
+00004640: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+00004650: 636f 6d6d 756e 6974 792e 6c6c 6d73 2e66  community.llms.f
+00004660: 616b 6520 696d 706f 7274 2046 616b 6553  ake import FakeS
+00004670: 7472 6561 6d69 6e67 4c69 7374 4c4c 4d0a  treamingListLLM.
+00004680: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00004690: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+000046a0: 6f75 7470 7574 5f70 6172 7365 7273 2069  output_parsers i
+000046b0: 6d70 6f72 7420 5374 724f 7574 7075 7450  mport StrOutputP
+000046c0: 6172 7365 720a 2020 2020 2020 2020 2020  arser.          
+000046d0: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+000046e0: 5f63 6f72 652e 7072 6f6d 7074 7320 696d  _core.prompts im
+000046f0: 706f 7274 2053 7973 7465 6d4d 6573 7361  port SystemMessa
+00004700: 6765 5072 6f6d 7074 5465 6d70 6c61 7465  gePromptTemplate
+00004710: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+00004720: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+00004730: 2e72 756e 6e61 626c 6573 2069 6d70 6f72  .runnables impor
+00004740: 7420 5275 6e6e 6162 6c65 0a20 2020 2020  t Runnable.     
+00004750: 2020 2020 2020 2066 726f 6d20 6f70 6572         from oper
+00004760: 6174 6f72 2069 6d70 6f72 7420 6974 656d  ator import item
+00004770: 6765 7474 6572 0a0a 2020 2020 2020 2020  getter..        
+00004780: 2020 2020 7072 6f6d 7074 203d 2028 0a20      prompt = (. 
+00004790: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+000047a0: 7973 7465 6d4d 6573 7361 6765 5072 6f6d  ystemMessageProm
+000047b0: 7074 5465 6d70 6c61 7465 2e66 726f 6d5f  ptTemplate.from_
+000047c0: 7465 6d70 6c61 7465 2822 596f 7520 6172  template("You ar
+000047d0: 6520 6120 6e69 6365 2061 7373 6973 7461  e a nice assista
+000047e0: 6e74 2e22 290a 2020 2020 2020 2020 2020  nt.").          
+000047f0: 2020 2020 2020 2b20 227b 7175 6573 7469        + "{questi
+00004800: 6f6e 7d22 0a20 2020 2020 2020 2020 2020  on}".           
+00004810: 2029 0a20 2020 2020 2020 2020 2020 206c   ).            l
+00004820: 6c6d 203d 2046 616b 6553 7472 6561 6d69  lm = FakeStreami
+00004830: 6e67 4c69 7374 4c4c 4d28 7265 7370 6f6e  ngListLLM(respon
+00004840: 7365 733d 5b22 666f 6f2d 6c69 7368 225d  ses=["foo-lish"]
+00004850: 290a 0a20 2020 2020 2020 2020 2020 2063  )..            c
+00004860: 6861 696e 3a20 5275 6e6e 6162 6c65 203d  hain: Runnable =
+00004870: 2070 726f 6d70 7420 7c20 6c6c 6d20 7c20   prompt | llm | 
+00004880: 7b22 7374 7222 3a20 5374 724f 7574 7075  {"str": StrOutpu
+00004890: 7450 6172 7365 7228 297d 0a0a 2020 2020  tParser()}..    
+000048a0: 2020 2020 2020 2020 6368 6169 6e5f 7769          chain_wi
+000048b0: 7468 5f61 7373 6967 6e20 3d20 6368 6169  th_assign = chai
+000048c0: 6e2e 6173 7369 676e 2868 656c 6c6f 3d69  n.assign(hello=i
+000048d0: 7465 6d67 6574 7465 7228 2273 7472 2229  temgetter("str")
+000048e0: 207c 206c 6c6d 290a 0a20 2020 2020 2020   | llm)..       
+000048f0: 2020 2020 2070 7269 6e74 2863 6861 696e       print(chain
+00004900: 5f77 6974 685f 6173 7369 676e 2e69 6e70  _with_assign.inp
+00004910: 7574 5f73 6368 656d 612e 7363 6865 6d61  ut_schema.schema
+00004920: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00004930: 2320 7b27 7469 746c 6527 3a20 2750 726f  # {'title': 'Pro
+00004940: 6d70 7449 6e70 7574 272c 2027 7479 7065  mptInput', 'type
+00004950: 273a 2027 6f62 6a65 6374 272c 2027 7072  ': 'object', 'pr
+00004960: 6f70 6572 7469 6573 273a 0a20 2020 2020  operties':.     
+00004970: 2020 2020 2020 207b 2771 7565 7374 696f         {'questio
+00004980: 6e27 3a20 7b27 7469 746c 6527 3a20 2751  n': {'title': 'Q
+00004990: 7565 7374 696f 6e27 2c20 2774 7970 6527  uestion', 'type'
+000049a0: 3a20 2773 7472 696e 6727 7d7d 7d0a 2020  : 'string'}}}.  
+000049b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000049c0: 6368 6169 6e5f 7769 7468 5f61 7373 6967  chain_with_assig
+000049d0: 6e2e 6f75 7470 7574 5f73 6368 656d 612e  n.output_schema.
+000049e0: 7363 6865 6d61 2829 2920 230a 2020 2020  schema()) #.    
+000049f0: 2020 2020 2020 2020 7b27 7469 746c 6527          {'title'
+00004a00: 3a20 2752 756e 6e61 626c 6553 6571 7565  : 'RunnableSeque
+00004a10: 6e63 654f 7574 7075 7427 2c20 2774 7970  nceOutput', 'typ
+00004a20: 6527 3a20 276f 626a 6563 7427 2c20 2770  e': 'object', 'p
+00004a30: 726f 7065 7274 6965 7327 3a0a 2020 2020  roperties':.    
+00004a40: 2020 2020 2020 2020 7b27 7374 7227 3a20          {'str': 
+00004a50: 7b27 7469 746c 6527 3a20 2753 7472 272c  {'title': 'Str',
+00004a60: 0a20 2020 2020 2020 2020 2020 2027 7479  .            'ty
+00004a70: 7065 273a 2027 7374 7269 6e67 277d 2c20  pe': 'string'}, 
+00004a80: 2768 656c 6c6f 273a 207b 2774 6974 6c65  'hello': {'title
+00004a90: 273a 2027 4865 6c6c 6f27 2c20 2774 7970  ': 'Hello', 'typ
+00004aa0: 6527 3a20 2773 7472 696e 6727 7d7d 7d0a  e': 'string'}}}.
+00004ab0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00004ac0: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00004ad0: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
+00004ae0: 6573 2e70 6173 7374 6872 6f75 6768 2069  es.passthrough i
+00004af0: 6d70 6f72 7420 5275 6e6e 6162 6c65 4173  mport RunnableAs
+00004b00: 7369 676e 0a0a 2020 2020 2020 2020 7265  sign..        re
+00004b10: 7475 726e 2073 656c 6620 7c20 5275 6e6e  turn self | Runn
+00004b20: 6162 6c65 4173 7369 676e 2852 756e 6e61  ableAssign(Runna
+00004b30: 626c 6550 6172 616c 6c65 6c28 6b77 6172  bleParallel(kwar
+00004b40: 6773 2929 0a0a 2020 2020 2222 2220 2d2d  gs))..    """ --
+00004b50: 2d20 5075 626c 6963 2041 5049 202d 2d2d  - Public API ---
+00004b60: 2022 2222 0a0a 2020 2020 4061 6273 7472   """..    @abstr
+00004b70: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
+00004b80: 6620 696e 766f 6b65 2873 656c 662c 2069  f invoke(self, i
+00004b90: 6e70 7574 3a20 496e 7075 742c 2063 6f6e  nput: Input, con
+00004ba0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
+00004bb0: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
+00004bc0: 4e6f 6e65 2920 2d3e 204f 7574 7075 743a  None) -> Output:
+00004bd0: 0a20 2020 2020 2020 2022 2222 5472 616e  .        """Tran
+00004be0: 7366 6f72 6d20 6120 7369 6e67 6c65 2069  sform a single i
+00004bf0: 6e70 7574 2069 6e74 6f20 616e 206f 7574  nput into an out
+00004c00: 7075 742e 204f 7665 7272 6964 6520 746f  put. Override to
+00004c10: 2069 6d70 6c65 6d65 6e74 2e0a 0a20 2020   implement...   
+00004c20: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+00004c30: 2020 2020 2020 2069 6e70 7574 3a20 5468         input: Th
+00004c40: 6520 696e 7075 7420 746f 2074 6865 2072  e input to the r
+00004c50: 756e 6e61 626c 652e 0a20 2020 2020 2020  unnable..       
+00004c60: 2020 2020 2063 6f6e 6669 673a 2041 2063       config: A c
+00004c70: 6f6e 6669 6720 746f 2075 7365 2077 6865  onfig to use whe
+00004c80: 6e20 696e 766f 6b69 6e67 2074 6865 2072  n invoking the r
+00004c90: 756e 6e61 626c 652e 0a20 2020 2020 2020  unnable..       
+00004ca0: 2020 2020 2020 2020 5468 6520 636f 6e66          The conf
+00004cb0: 6967 2073 7570 706f 7274 7320 7374 616e  ig supports stan
+00004cc0: 6461 7264 206b 6579 7320 6c69 6b65 2027  dard keys like '
+00004cd0: 7461 6773 272c 2027 6d65 7461 6461 7461  tags', 'metadata
+00004ce0: 2720 666f 7220 7472 6163 696e 670a 2020  ' for tracing.  
+00004cf0: 2020 2020 2020 2020 2020 2020 2070 7572               pur
+00004d00: 706f 7365 732c 2027 6d61 785f 636f 6e63  poses, 'max_conc
+00004d10: 7572 7265 6e63 7927 2066 6f72 2063 6f6e  urrency' for con
+00004d20: 7472 6f6c 6c69 6e67 2068 6f77 206d 7563  trolling how muc
+00004d30: 6820 776f 726b 2074 6f20 646f 0a20 2020  h work to do.   
+00004d40: 2020 2020 2020 2020 2020 2020 696e 2070              in p
+00004d50: 6172 616c 6c65 6c2c 2061 6e64 206f 7468  arallel, and oth
+00004d60: 6572 206b 6579 732e 2050 6c65 6173 6520  er keys. Please 
+00004d70: 7265 6665 7220 746f 2074 6865 2052 756e  refer to the Run
+00004d80: 6e61 626c 6543 6f6e 6669 670a 2020 2020  nableConfig.    
+00004d90: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+00004da0: 6f72 6520 6465 7461 696c 732e 0a0a 2020  ore details...  
+00004db0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+00004dc0: 2020 2020 2020 2020 2020 2054 6865 206f             The o
+00004dd0: 7574 7075 7420 6f66 2074 6865 2072 756e  utput of the run
+00004de0: 6e61 626c 652e 0a20 2020 2020 2020 2022  nable..        "
+00004df0: 2222 0a0a 2020 2020 6173 796e 6320 6465  ""..    async de
+00004e00: 6620 6169 6e76 6f6b 6528 0a20 2020 2020  f ainvoke(.     
+00004e10: 2020 2073 656c 662c 2069 6e70 7574 3a20     self, input: 
+00004e20: 496e 7075 742c 2063 6f6e 6669 673a 204f  Input, config: O
+00004e30: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+00004e40: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c20  Config] = None, 
+00004e50: 2a2a 6b77 6172 6773 3a20 416e 790a 2020  **kwargs: Any.  
+00004e60: 2020 2920 2d3e 204f 7574 7075 743a 0a20    ) -> Output:. 
+00004e70: 2020 2020 2020 2022 2222 4465 6661 756c         """Defaul
+00004e80: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
+00004e90: 206f 6620 6169 6e76 6f6b 652c 2063 616c   of ainvoke, cal
+00004ea0: 6c73 2069 6e76 6f6b 6520 6672 6f6d 2061  ls invoke from a
+00004eb0: 2074 6872 6561 642e 0a0a 2020 2020 2020   thread...      
+00004ec0: 2020 5468 6520 6465 6661 756c 7420 696d    The default im
+00004ed0: 706c 656d 656e 7461 7469 6f6e 2061 6c6c  plementation all
+00004ee0: 6f77 7320 7573 6167 6520 6f66 2061 7379  ows usage of asy
+00004ef0: 6e63 2063 6f64 6520 6576 656e 2069 660a  nc code even if.
+00004f00: 2020 2020 2020 2020 7468 6520 7275 6e6e          the runn
+00004f10: 6162 6c65 2064 6964 206e 6f74 2069 6d70  able did not imp
+00004f20: 6c65 6d65 6e74 2061 206e 6174 6976 6520  lement a native 
+00004f30: 6173 796e 6320 7665 7273 696f 6e20 6f66  async version of
+00004f40: 2069 6e76 6f6b 652e 0a0a 2020 2020 2020   invoke...      
+00004f50: 2020 5375 6263 6c61 7373 6573 2073 686f    Subclasses sho
+00004f60: 756c 6420 6f76 6572 7269 6465 2074 6869  uld override thi
+00004f70: 7320 6d65 7468 6f64 2069 6620 7468 6579  s method if they
+00004f80: 2063 616e 2072 756e 2061 7379 6e63 6872   can run asynchr
+00004f90: 6f6e 6f75 736c 792e 0a20 2020 2020 2020  onously..       
+00004fa0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00004fb0: 7572 6e20 6177 6169 7420 7275 6e5f 696e  urn await run_in
+00004fc0: 5f65 7865 6375 746f 7228 636f 6e66 6967  _executor(config
+00004fd0: 2c20 7365 6c66 2e69 6e76 6f6b 652c 2069  , self.invoke, i
+00004fe0: 6e70 7574 2c20 636f 6e66 6967 2c20 2a2a  nput, config, **
+00004ff0: 6b77 6172 6773 290a 0a20 2020 2064 6566  kwargs)..    def
+00005000: 2062 6174 6368 280a 2020 2020 2020 2020   batch(.        
+00005010: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00005020: 7075 7473 3a20 4c69 7374 5b49 6e70 7574  puts: List[Input
+00005030: 5d2c 0a20 2020 2020 2020 2063 6f6e 6669  ],.        confi
+00005040: 673a 204f 7074 696f 6e61 6c5b 556e 696f  g: Optional[Unio
+00005050: 6e5b 5275 6e6e 6162 6c65 436f 6e66 6967  n[RunnableConfig
+00005060: 2c20 4c69 7374 5b52 756e 6e61 626c 6543  , List[RunnableC
+00005070: 6f6e 6669 675d 5d5d 203d 204e 6f6e 652c  onfig]]] = None,
+00005080: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00005090: 2020 2020 7265 7475 726e 5f65 7863 6570      return_excep
+000050a0: 7469 6f6e 733a 2062 6f6f 6c20 3d20 4661  tions: bool = Fa
+000050b0: 6c73 652c 0a20 2020 2020 2020 202a 2a6b  lse,.        **k
+000050c0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
+000050d0: 416e 795d 2c0a 2020 2020 2920 2d3e 204c  Any],.    ) -> L
+000050e0: 6973 745b 4f75 7470 7574 5d3a 0a20 2020  ist[Output]:.   
+000050f0: 2020 2020 2022 2222 4465 6661 756c 7420       """Default 
+00005100: 696d 706c 656d 656e 7461 7469 6f6e 2072  implementation r
+00005110: 756e 7320 696e 766f 6b65 2069 6e20 7061  uns invoke in pa
+00005120: 7261 6c6c 656c 2075 7369 6e67 2061 2074  rallel using a t
+00005130: 6872 6561 6420 706f 6f6c 2065 7865 6375  hread pool execu
+00005140: 746f 722e 0a0a 2020 2020 2020 2020 5468  tor...        Th
+00005150: 6520 6465 6661 756c 7420 696d 706c 656d  e default implem
+00005160: 656e 7461 7469 6f6e 206f 6620 6261 7463  entation of batc
+00005170: 6820 776f 726b 7320 7765 6c6c 2066 6f72  h works well for
+00005180: 2049 4f20 626f 756e 6420 7275 6e6e 6162   IO bound runnab
+00005190: 6c65 732e 0a0a 2020 2020 2020 2020 5375  les...        Su
+000051a0: 6263 6c61 7373 6573 2073 686f 756c 6420  bclasses should 
+000051b0: 6f76 6572 7269 6465 2074 6869 7320 6d65  override this me
+000051c0: 7468 6f64 2069 6620 7468 6579 2063 616e  thod if they can
+000051d0: 2062 6174 6368 206d 6f72 6520 6566 6669   batch more effi
+000051e0: 6369 656e 746c 793b 0a20 2020 2020 2020  ciently;.       
+000051f0: 2065 2e67 2e2c 2069 6620 7468 6520 756e   e.g., if the un
+00005200: 6465 726c 7969 6e67 2072 756e 6e61 626c  derlying runnabl
+00005210: 6520 7573 6573 2061 6e20 4150 4920 7768  e uses an API wh
+00005220: 6963 6820 7375 7070 6f72 7473 2061 2062  ich supports a b
+00005230: 6174 6368 206d 6f64 652e 0a20 2020 2020  atch mode..     
+00005240: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+00005250: 6620 6e6f 7420 696e 7075 7473 3a0a 2020  f not inputs:.  
+00005260: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00005270: 205b 5d0a 0a20 2020 2020 2020 2063 6f6e   []..        con
+00005280: 6669 6773 203d 2067 6574 5f63 6f6e 6669  figs = get_confi
+00005290: 675f 6c69 7374 2863 6f6e 6669 672c 206c  g_list(config, l
+000052a0: 656e 2869 6e70 7574 7329 290a 0a20 2020  en(inputs))..   
+000052b0: 2020 2020 2064 6566 2069 6e76 6f6b 6528       def invoke(
+000052c0: 696e 7075 743a 2049 6e70 7574 2c20 636f  input: Input, co
+000052d0: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
+000052e0: 6e66 6967 2920 2d3e 2055 6e69 6f6e 5b4f  nfig) -> Union[O
+000052f0: 7574 7075 742c 2045 7863 6570 7469 6f6e  utput, Exception
+00005300: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
+00005310: 6620 7265 7475 726e 5f65 7863 6570 7469  f return_excepti
+00005320: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00005330: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00005340: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00005350: 7475 726e 2073 656c 662e 696e 766f 6b65  turn self.invoke
+00005360: 2869 6e70 7574 2c20 636f 6e66 6967 2c20  (input, config, 
+00005370: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+00005380: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00005390: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+000053a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000053b0: 2020 2020 2072 6574 7572 6e20 650a 2020       return e.  
+000053c0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000053d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053e0: 7265 7475 726e 2073 656c 662e 696e 766f  return self.invo
+000053f0: 6b65 2869 6e70 7574 2c20 636f 6e66 6967  ke(input, config
+00005400: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
+00005410: 2020 2020 2023 2049 6620 7468 6572 6527       # If there'
+00005420: 7320 6f6e 6c79 206f 6e65 2069 6e70 7574  s only one input
+00005430: 2c20 646f 6e27 7420 626f 7468 6572 2077  , don't bother w
+00005440: 6974 6820 7468 6520 6578 6563 7574 6f72  ith the executor
+00005450: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00005460: 696e 7075 7473 2920 3d3d 2031 3a0a 2020  inputs) == 1:.  
+00005470: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00005480: 2063 6173 7428 4c69 7374 5b4f 7574 7075   cast(List[Outpu
+00005490: 745d 2c20 5b69 6e76 6f6b 6528 696e 7075  t], [invoke(inpu
+000054a0: 7473 5b30 5d2c 2063 6f6e 6669 6773 5b30  ts[0], configs[0
+000054b0: 5d29 5d29 0a0a 2020 2020 2020 2020 7769  ])])..        wi
+000054c0: 7468 2067 6574 5f65 7865 6375 746f 725f  th get_executor_
+000054d0: 666f 725f 636f 6e66 6967 2863 6f6e 6669  for_config(confi
+000054e0: 6773 5b30 5d29 2061 7320 6578 6563 7574  gs[0]) as execut
+000054f0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00005500: 7265 7475 726e 2063 6173 7428 4c69 7374  return cast(List
+00005510: 5b4f 7574 7075 745d 2c20 6c69 7374 2865  [Output], list(e
+00005520: 7865 6375 746f 722e 6d61 7028 696e 766f  xecutor.map(invo
+00005530: 6b65 2c20 696e 7075 7473 2c20 636f 6e66  ke, inputs, conf
+00005540: 6967 7329 2929 0a0a 2020 2020 406f 7665  igs)))..    @ove
+00005550: 726c 6f61 640a 2020 2020 6465 6620 6261  rload.    def ba
+00005560: 7463 685f 6173 5f63 6f6d 706c 6574 6564  tch_as_completed
+00005570: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00005580: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00005590: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+000055a0: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+000055b0: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+000055c0: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+000055d0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+000055e0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+000055f0: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+00005600: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+00005610: 204c 6974 6572 616c 5b46 616c 7365 5d20   Literal[False] 
+00005620: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00005630: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00005640: 2020 2020 2920 2d3e 2049 7465 7261 746f      ) -> Iterato
+00005650: 725b 5475 706c 655b 696e 742c 204f 7574  r[Tuple[int, Out
+00005660: 7075 745d 5d3a 0a20 2020 2020 2020 202e  put]]:.        .
+00005670: 2e2e 0a0a 2020 2020 406f 7665 726c 6f61  ....    @overloa
+00005680: 640a 2020 2020 6465 6620 6261 7463 685f  d.    def batch_
+00005690: 6173 5f63 6f6d 706c 6574 6564 280a 2020  as_completed(.  
+000056a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000056b0: 2020 2020 696e 7075 7473 3a20 4c69 7374      inputs: List
+000056c0: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+000056d0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+000056e0: 6c5b 556e 696f 6e5b 5275 6e6e 6162 6c65  l[Union[Runnable
+000056f0: 436f 6e66 6967 2c20 4c69 7374 5b52 756e  Config, List[Run
+00005700: 6e61 626c 6543 6f6e 6669 675d 5d5d 203d  nableConfig]]] =
+00005710: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00005720: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+00005730: 5f65 7863 6570 7469 6f6e 733a 204c 6974  _exceptions: Lit
+00005740: 6572 616c 5b54 7275 655d 2c0a 2020 2020  eral[True],.    
+00005750: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+00005760: 792c 0a20 2020 2029 202d 3e20 4974 6572  y,.    ) -> Iter
+00005770: 6174 6f72 5b54 7570 6c65 5b69 6e74 2c20  ator[Tuple[int, 
+00005780: 556e 696f 6e5b 4f75 7470 7574 2c20 4578  Union[Output, Ex
+00005790: 6365 7074 696f 6e5d 5d5d 3a0a 2020 2020  ception]]]:.    
+000057a0: 2020 2020 2e2e 2e0a 0a20 2020 2064 6566      .....    def
+000057b0: 2062 6174 6368 5f61 735f 636f 6d70 6c65   batch_as_comple
+000057c0: 7465 6428 0a20 2020 2020 2020 2073 656c  ted(.        sel
+000057d0: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+000057e0: 733a 204c 6973 745b 496e 7075 745d 2c0a  s: List[Input],.
+000057f0: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+00005800: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b52  Optional[Union[R
+00005810: 756e 6e61 626c 6543 6f6e 6669 672c 204c  unnableConfig, L
+00005820: 6973 745b 5275 6e6e 6162 6c65 436f 6e66  ist[RunnableConf
+00005830: 6967 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  ig]]] = None,.  
+00005840: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00005850: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+00005860: 6e73 3a20 626f 6f6c 203d 2046 616c 7365  ns: bool = False
+00005870: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00005880: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
+00005890: 5d2c 0a20 2020 2029 202d 3e20 4974 6572  ],.    ) -> Iter
+000058a0: 6174 6f72 5b54 7570 6c65 5b69 6e74 2c20  ator[Tuple[int, 
+000058b0: 556e 696f 6e5b 4f75 7470 7574 2c20 4578  Union[Output, Ex
+000058c0: 6365 7074 696f 6e5d 5d5d 3a0a 2020 2020  ception]]]:.    
+000058d0: 2020 2020 2222 2252 756e 2069 6e76 6f6b      """Run invok
+000058e0: 6520 696e 2070 6172 616c 6c65 6c20 6f6e  e in parallel on
+000058f0: 2061 206c 6973 7420 6f66 2069 6e70 7574   a list of input
+00005900: 732c 0a20 2020 2020 2020 2079 6965 6c64  s,.        yield
+00005910: 696e 6720 7265 7375 6c74 7320 6173 2074  ing results as t
+00005920: 6865 7920 636f 6d70 6c65 7465 2e22 2222  hey complete."""
+00005930: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00005940: 2069 6e70 7574 733a 0a20 2020 2020 2020   inputs:.       
+00005950: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00005960: 2020 2020 2063 6f6e 6669 6773 203d 2067       configs = g
+00005970: 6574 5f63 6f6e 6669 675f 6c69 7374 2863  et_config_list(c
+00005980: 6f6e 6669 672c 206c 656e 2869 6e70 7574  onfig, len(input
+00005990: 7329 290a 0a20 2020 2020 2020 2064 6566  s))..        def
+000059a0: 2069 6e76 6f6b 6528 0a20 2020 2020 2020   invoke(.       
+000059b0: 2020 2020 2069 3a20 696e 742c 2069 6e70       i: int, inp
+000059c0: 7574 3a20 496e 7075 742c 2063 6f6e 6669  ut: Input, confi
+000059d0: 673a 2052 756e 6e61 626c 6543 6f6e 6669  g: RunnableConfi
+000059e0: 670a 2020 2020 2020 2020 2920 2d3e 2054  g.        ) -> T
+000059f0: 7570 6c65 5b69 6e74 2c20 556e 696f 6e5b  uple[int, Union[
+00005a00: 4f75 7470 7574 2c20 4578 6365 7074 696f  Output, Exceptio
+00005a10: 6e5d 5d3a 0a20 2020 2020 2020 2020 2020  n]]:.           
+00005a20: 2069 6620 7265 7475 726e 5f65 7863 6570   if return_excep
+00005a30: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00005a40: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00005a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a60: 6f75 743a 2055 6e69 6f6e 5b4f 7574 7075  out: Union[Outpu
+00005a70: 742c 2045 7863 6570 7469 6f6e 5d20 3d20  t, Exception] = 
+00005a80: 7365 6c66 2e69 6e76 6f6b 6528 696e 7075  self.invoke(inpu
+00005a90: 742c 2063 6f6e 6669 672c 202a 2a6b 7761  t, config, **kwa
+00005aa0: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+00005ab0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00005ac0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00005ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ae0: 6f75 7420 3d20 650a 2020 2020 2020 2020  out = e.        
+00005af0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00005b00: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+00005b10: 7365 6c66 2e69 6e76 6f6b 6528 696e 7075  self.invoke(inpu
+00005b20: 742c 2063 6f6e 6669 672c 202a 2a6b 7761  t, config, **kwa
+00005b30: 7267 7329 0a0a 2020 2020 2020 2020 2020  rgs)..          
+00005b40: 2020 7265 7475 726e 2028 692c 206f 7574    return (i, out
+00005b50: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+00005b60: 6e28 696e 7075 7473 2920 3d3d 2031 3a0a  n(inputs) == 1:.
+00005b70: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+00005b80: 6420 696e 766f 6b65 2830 2c20 696e 7075  d invoke(0, inpu
+00005b90: 7473 5b30 5d2c 2063 6f6e 6669 6773 5b30  ts[0], configs[0
+00005ba0: 5d29 0a20 2020 2020 2020 2020 2020 2072  ]).            r
+00005bb0: 6574 7572 6e0a 0a20 2020 2020 2020 2077  eturn..        w
+00005bc0: 6974 6820 6765 745f 6578 6563 7574 6f72  ith get_executor
+00005bd0: 5f66 6f72 5f63 6f6e 6669 6728 636f 6e66  _for_config(conf
+00005be0: 6967 735b 305d 2920 6173 2065 7865 6375  igs[0]) as execu
+00005bf0: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
+00005c00: 2066 7574 7572 6573 203d 207b 0a20 2020   futures = {.   
+00005c10: 2020 2020 2020 2020 2020 2020 2065 7865               exe
+00005c20: 6375 746f 722e 7375 626d 6974 2869 6e76  cutor.submit(inv
+00005c30: 6f6b 652c 2069 2c20 696e 7075 742c 2063  oke, i, input, c
+00005c40: 6f6e 6669 6729 0a20 2020 2020 2020 2020  onfig).         
+00005c50: 2020 2020 2020 2066 6f72 2069 2c20 2869         for i, (i
+00005c60: 6e70 7574 2c20 636f 6e66 6967 2920 696e  nput, config) in
+00005c70: 2065 6e75 6d65 7261 7465 287a 6970 2869   enumerate(zip(i
+00005c80: 6e70 7574 732c 2063 6f6e 6669 6773 2929  nputs, configs))
+00005c90: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00005ca0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00005cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005cc0: 2077 6869 6c65 2066 7574 7572 6573 3a0a   while futures:.
+00005cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ce0: 2020 2020 646f 6e65 2c20 6675 7475 7265      done, future
+00005cf0: 7320 3d20 7761 6974 2866 7574 7572 6573  s = wait(futures
+00005d00: 2c20 7265 7475 726e 5f77 6865 6e3d 4649  , return_when=FI
+00005d10: 5253 545f 434f 4d50 4c45 5445 4429 0a20  RST_COMPLETED). 
+00005d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d30: 2020 2077 6869 6c65 2064 6f6e 653a 0a20     while done:. 
+00005d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d50: 2020 2020 2020 2079 6965 6c64 2064 6f6e         yield don
+00005d60: 652e 706f 7028 292e 7265 7375 6c74 2829  e.pop().result()
+00005d70: 0a20 2020 2020 2020 2020 2020 2066 696e  .            fin
+00005d80: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
+00005d90: 2020 2020 2020 666f 7220 6675 7475 7265        for future
+00005da0: 2069 6e20 6675 7475 7265 733a 0a20 2020   in futures:.   
+00005db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005dc0: 2066 7574 7572 652e 6361 6e63 656c 2829   future.cancel()
+00005dd0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00005de0: 6162 6174 6368 280a 2020 2020 2020 2020  abatch(.        
+00005df0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00005e00: 7075 7473 3a20 4c69 7374 5b49 6e70 7574  puts: List[Input
+00005e10: 5d2c 0a20 2020 2020 2020 2063 6f6e 6669  ],.        confi
+00005e20: 673a 204f 7074 696f 6e61 6c5b 556e 696f  g: Optional[Unio
+00005e30: 6e5b 5275 6e6e 6162 6c65 436f 6e66 6967  n[RunnableConfig
+00005e40: 2c20 4c69 7374 5b52 756e 6e61 626c 6543  , List[RunnableC
+00005e50: 6f6e 6669 675d 5d5d 203d 204e 6f6e 652c  onfig]]] = None,
+00005e60: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00005e70: 2020 2020 7265 7475 726e 5f65 7863 6570      return_excep
+00005e80: 7469 6f6e 733a 2062 6f6f 6c20 3d20 4661  tions: bool = Fa
+00005e90: 6c73 652c 0a20 2020 2020 2020 202a 2a6b  lse,.        **k
+00005ea0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
+00005eb0: 416e 795d 2c0a 2020 2020 2920 2d3e 204c  Any],.    ) -> L
+00005ec0: 6973 745b 4f75 7470 7574 5d3a 0a20 2020  ist[Output]:.   
+00005ed0: 2020 2020 2022 2222 4465 6661 756c 7420       """Default 
+00005ee0: 696d 706c 656d 656e 7461 7469 6f6e 2072  implementation r
+00005ef0: 756e 7320 6169 6e76 6f6b 6520 696e 2070  uns ainvoke in p
+00005f00: 6172 616c 6c65 6c20 7573 696e 6720 6173  arallel using as
+00005f10: 796e 6369 6f2e 6761 7468 6572 2e0a 0a20  yncio.gather... 
+00005f20: 2020 2020 2020 2054 6865 2064 6566 6175         The defau
+00005f30: 6c74 2069 6d70 6c65 6d65 6e74 6174 696f  lt implementatio
+00005f40: 6e20 6f66 2062 6174 6368 2077 6f72 6b73  n of batch works
+00005f50: 2077 656c 6c20 666f 7220 494f 2062 6f75   well for IO bou
+00005f60: 6e64 2072 756e 6e61 626c 6573 2e0a 0a20  nd runnables... 
+00005f70: 2020 2020 2020 2053 7562 636c 6173 7365         Subclasse
+00005f80: 7320 7368 6f75 6c64 206f 7665 7272 6964  s should overrid
+00005f90: 6520 7468 6973 206d 6574 686f 6420 6966  e this method if
+00005fa0: 2074 6865 7920 6361 6e20 6261 7463 6820   they can batch 
+00005fb0: 6d6f 7265 2065 6666 6963 6965 6e74 6c79  more efficiently
+00005fc0: 3b0a 2020 2020 2020 2020 652e 672e 2c20  ;.        e.g., 
+00005fd0: 6966 2074 6865 2075 6e64 6572 6c79 696e  if the underlyin
+00005fe0: 6720 7275 6e6e 6162 6c65 2075 7365 7320  g runnable uses 
+00005ff0: 616e 2041 5049 2077 6869 6368 2073 7570  an API which sup
+00006000: 706f 7274 7320 6120 6261 7463 6820 6d6f  ports a batch mo
+00006010: 6465 2e0a 2020 2020 2020 2020 2222 220a  de..        """.
+00006020: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00006030: 6e70 7574 733a 0a20 2020 2020 2020 2020  nputs:.         
+00006040: 2020 2072 6574 7572 6e20 5b5d 0a0a 2020     return []..  
+00006050: 2020 2020 2020 636f 6e66 6967 7320 3d20        configs = 
+00006060: 6765 745f 636f 6e66 6967 5f6c 6973 7428  get_config_list(
+00006070: 636f 6e66 6967 2c20 6c65 6e28 696e 7075  config, len(inpu
+00006080: 7473 2929 0a0a 2020 2020 2020 2020 6173  ts))..        as
+00006090: 796e 6320 6465 6620 6169 6e76 6f6b 6528  ync def ainvoke(
+000060a0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+000060b0: 7574 3a20 496e 7075 742c 2063 6f6e 6669  ut: Input, confi
+000060c0: 673a 2052 756e 6e61 626c 6543 6f6e 6669  g: RunnableConfi
+000060d0: 670a 2020 2020 2020 2020 2920 2d3e 2055  g.        ) -> U
+000060e0: 6e69 6f6e 5b4f 7574 7075 742c 2045 7863  nion[Output, Exc
+000060f0: 6570 7469 6f6e 5d3a 0a20 2020 2020 2020  eption]:.       
+00006100: 2020 2020 2069 6620 7265 7475 726e 5f65       if return_e
+00006110: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
+00006120: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00006130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006140: 2020 2020 7265 7475 726e 2061 7761 6974      return await
+00006150: 2073 656c 662e 6169 6e76 6f6b 6528 696e   self.ainvoke(in
+00006160: 7075 742c 2063 6f6e 6669 672c 202a 2a6b  put, config, **k
+00006170: 7761 7267 7329 0a20 2020 2020 2020 2020  wargs).         
+00006180: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00006190: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+000061a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061b0: 2020 7265 7475 726e 2065 0a20 2020 2020    return e.     
+000061c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000061d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000061e0: 7572 6e20 6177 6169 7420 7365 6c66 2e61  urn await self.a
+000061f0: 696e 766f 6b65 2869 6e70 7574 2c20 636f  invoke(input, co
+00006200: 6e66 6967 2c20 2a2a 6b77 6172 6773 290a  nfig, **kwargs).
+00006210: 0a20 2020 2020 2020 2063 6f72 6f73 203d  .        coros =
+00006220: 206d 6170 2861 696e 766f 6b65 2c20 696e   map(ainvoke, in
+00006230: 7075 7473 2c20 636f 6e66 6967 7329 0a20  puts, configs). 
+00006240: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+00006250: 6169 7420 6761 7468 6572 5f77 6974 685f  ait gather_with_
+00006260: 636f 6e63 7572 7265 6e63 7928 636f 6e66  concurrency(conf
+00006270: 6967 735b 305d 2e67 6574 2822 6d61 785f  igs[0].get("max_
+00006280: 636f 6e63 7572 7265 6e63 7922 292c 202a  concurrency"), *
+00006290: 636f 726f 7329 0a0a 2020 2020 406f 7665  coros)..    @ove
+000062a0: 726c 6f61 640a 2020 2020 6465 6620 6162  rload.    def ab
+000062b0: 6174 6368 5f61 735f 636f 6d70 6c65 7465  atch_as_complete
+000062c0: 6428 0a20 2020 2020 2020 2073 656c 662c  d(.        self,
+000062d0: 0a20 2020 2020 2020 2069 6e70 7574 733a  .        inputs:
+000062e0: 204c 6973 745b 496e 7075 745d 2c0a 2020   List[Input],.  
+000062f0: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+00006300: 7469 6f6e 616c 5b55 6e69 6f6e 5b52 756e  tional[Union[Run
+00006310: 6e61 626c 6543 6f6e 6669 672c 204c 6973  nableConfig, Lis
+00006320: 745b 5275 6e6e 6162 6c65 436f 6e66 6967  t[RunnableConfig
+00006330: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00006340: 2020 2020 2a2c 0a20 2020 2020 2020 2072      *,.        r
+00006350: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00006360: 3a20 4c69 7465 7261 6c5b 4661 6c73 655d  : Literal[False]
+00006370: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00006380: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+00006390: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+000063a0: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
+000063b0: 725b 5475 706c 655b 696e 742c 204f 7574  r[Tuple[int, Out
+000063c0: 7075 745d 5d3a 0a20 2020 2020 2020 202e  put]]:.        .
+000063d0: 2e2e 0a0a 2020 2020 406f 7665 726c 6f61  ....    @overloa
+000063e0: 640a 2020 2020 6465 6620 6162 6174 6368  d.    def abatch
+000063f0: 5f61 735f 636f 6d70 6c65 7465 6428 0a20  _as_completed(. 
+00006400: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00006410: 2020 2020 2069 6e70 7574 733a 204c 6973       inputs: Lis
+00006420: 745b 496e 7075 745d 2c0a 2020 2020 2020  t[Input],.      
+00006430: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+00006440: 616c 5b55 6e69 6f6e 5b52 756e 6e61 626c  al[Union[Runnabl
+00006450: 6543 6f6e 6669 672c 204c 6973 745b 5275  eConfig, List[Ru
+00006460: 6e6e 6162 6c65 436f 6e66 6967 5d5d 5d20  nnableConfig]]] 
+00006470: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00006480: 2a2c 0a20 2020 2020 2020 2072 6574 7572  *,.        retur
+00006490: 6e5f 6578 6365 7074 696f 6e73 3a20 4c69  n_exceptions: Li
+000064a0: 7465 7261 6c5b 5472 7565 5d2c 0a20 2020  teral[True],.   
+000064b0: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+000064c0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+000064d0: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
+000064e0: 6174 6f72 5b54 7570 6c65 5b69 6e74 2c20  ator[Tuple[int, 
+000064f0: 556e 696f 6e5b 4f75 7470 7574 2c20 4578  Union[Output, Ex
+00006500: 6365 7074 696f 6e5d 5d5d 3a0a 2020 2020  ception]]]:.    
+00006510: 2020 2020 2e2e 2e0a 0a20 2020 2061 7379      .....    asy
+00006520: 6e63 2064 6566 2061 6261 7463 685f 6173  nc def abatch_as
+00006530: 5f63 6f6d 706c 6574 6564 280a 2020 2020  _completed(.    
+00006540: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00006550: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
+00006560: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
+00006570: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+00006580: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
+00006590: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
+000065a0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
+000065b0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
+000065c0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
+000065d0: 7863 6570 7469 6f6e 733a 2062 6f6f 6c20  xceptions: bool 
+000065e0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+000065f0: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
+00006600: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
+00006610: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
+00006620: 5b54 7570 6c65 5b69 6e74 2c20 556e 696f  [Tuple[int, Unio
+00006630: 6e5b 4f75 7470 7574 2c20 4578 6365 7074  n[Output, Except
+00006640: 696f 6e5d 5d5d 3a0a 2020 2020 2020 2020  ion]]]:.        
+00006650: 2222 2252 756e 2061 696e 766f 6b65 2069  """Run ainvoke i
+00006660: 6e20 7061 7261 6c6c 656c 206f 6e20 6120  n parallel on a 
+00006670: 6c69 7374 206f 6620 696e 7075 7473 2c0a  list of inputs,.
+00006680: 2020 2020 2020 2020 7969 656c 6469 6e67          yielding
+00006690: 2072 6573 756c 7473 2061 7320 7468 6579   results as they
+000066a0: 2063 6f6d 706c 6574 652e 2222 220a 0a20   complete.""".. 
+000066b0: 2020 2020 2020 2069 6620 6e6f 7420 696e         if not in
+000066c0: 7075 7473 3a0a 2020 2020 2020 2020 2020  puts:.          
+000066d0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+000066e0: 2020 636f 6e66 6967 7320 3d20 6765 745f    configs = get_
+000066f0: 636f 6e66 6967 5f6c 6973 7428 636f 6e66  config_list(conf
+00006700: 6967 2c20 6c65 6e28 696e 7075 7473 2929  ig, len(inputs))
+00006710: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+00006720: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
+00006730: 2020 2020 2020 2020 2069 3a20 696e 742c           i: int,
+00006740: 2069 6e70 7574 3a20 496e 7075 742c 2063   input: Input, c
+00006750: 6f6e 6669 673a 2052 756e 6e61 626c 6543  onfig: RunnableC
+00006760: 6f6e 6669 670a 2020 2020 2020 2020 2920  onfig.        ) 
+00006770: 2d3e 2054 7570 6c65 5b69 6e74 2c20 556e  -> Tuple[int, Un
+00006780: 696f 6e5b 4f75 7470 7574 2c20 4578 6365  ion[Output, Exce
+00006790: 7074 696f 6e5d 5d3a 0a20 2020 2020 2020  ption]]:.       
+000067a0: 2020 2020 2069 6620 7265 7475 726e 5f65       if return_e
+000067b0: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
+000067c0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+000067d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000067e0: 2020 2020 6f75 743a 2055 6e69 6f6e 5b4f      out: Union[O
+000067f0: 7574 7075 742c 2045 7863 6570 7469 6f6e  utput, Exception
+00006800: 5d20 3d20 6177 6169 7420 7365 6c66 2e61  ] = await self.a
+00006810: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00006820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006830: 696e 7075 742c 2063 6f6e 6669 672c 202a  input, config, *
+00006840: 2a6b 7761 7267 730a 2020 2020 2020 2020  *kwargs.        
+00006850: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00006860: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00006870: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00006880: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00006890: 2020 2020 2020 2020 206f 7574 203d 2065           out = e
+000068a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000068b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000068c0: 2020 206f 7574 203d 2061 7761 6974 2073     out = await s
+000068d0: 656c 662e 6169 6e76 6f6b 6528 696e 7075  elf.ainvoke(inpu
+000068e0: 742c 2063 6f6e 6669 672c 202a 2a6b 7761  t, config, **kwa
+000068f0: 7267 7329 0a0a 2020 2020 2020 2020 2020  rgs)..          
+00006900: 2020 7265 7475 726e 2028 692c 206f 7574    return (i, out
+00006910: 290a 0a20 2020 2020 2020 2063 6f72 6f73  )..        coros
+00006920: 203d 206d 6170 2861 696e 766f 6b65 2c20   = map(ainvoke, 
+00006930: 7261 6e67 6528 6c65 6e28 696e 7075 7473  range(len(inputs
+00006940: 2929 2c20 696e 7075 7473 2c20 636f 6e66  )), inputs, conf
+00006950: 6967 7329 0a0a 2020 2020 2020 2020 666f  igs)..        fo
+00006960: 7220 636f 726f 2069 6e20 6173 796e 6369  r coro in asynci
+00006970: 6f2e 6173 5f63 6f6d 706c 6574 6564 2863  o.as_completed(c
+00006980: 6f72 6f73 293a 0a20 2020 2020 2020 2020  oros):.         
+00006990: 2020 2079 6965 6c64 2061 7761 6974 2063     yield await c
+000069a0: 6f72 6f0a 0a20 2020 2064 6566 2073 7472  oro..    def str
+000069b0: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
+000069c0: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+000069d0: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
+000069e0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+000069f0: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+00006a00: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00006a10: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+00006a20: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+00006a30: 202d 3e20 4974 6572 6174 6f72 5b4f 7574   -> Iterator[Out
+00006a40: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
+00006a50: 220a 2020 2020 2020 2020 4465 6661 756c  ".        Defaul
+00006a60: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
+00006a70: 206f 6620 7374 7265 616d 2c20 7768 6963   of stream, whic
+00006a80: 6820 6361 6c6c 7320 696e 766f 6b65 2e0a  h calls invoke..
+00006a90: 2020 2020 2020 2020 5375 6263 6c61 7373          Subclass
+00006aa0: 6573 2073 686f 756c 6420 6f76 6572 7269  es should overri
+00006ab0: 6465 2074 6869 7320 6d65 7468 6f64 2069  de this method i
+00006ac0: 6620 7468 6579 2073 7570 706f 7274 2073  f they support s
+00006ad0: 7472 6561 6d69 6e67 206f 7574 7075 742e  treaming output.
+00006ae0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00006af0: 2020 2020 2079 6965 6c64 2073 656c 662e       yield self.
+00006b00: 696e 766f 6b65 2869 6e70 7574 2c20 636f  invoke(input, co
+00006b10: 6e66 6967 2c20 2a2a 6b77 6172 6773 290a  nfig, **kwargs).
+00006b20: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
+00006b30: 7374 7265 616d 280a 2020 2020 2020 2020  stream(.        
+00006b40: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00006b50: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+00006b60: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+00006b70: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00006b80: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+00006b90: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+00006ba0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+00006bb0: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
+00006bc0: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
+00006bd0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00006be0: 2020 4465 6661 756c 7420 696d 706c 656d    Default implem
+00006bf0: 656e 7461 7469 6f6e 206f 6620 6173 7472  entation of astr
+00006c00: 6561 6d2c 2077 6869 6368 2063 616c 6c73  eam, which calls
+00006c10: 2061 696e 766f 6b65 2e0a 2020 2020 2020   ainvoke..      
+00006c20: 2020 5375 6263 6c61 7373 6573 2073 686f    Subclasses sho
+00006c30: 756c 6420 6f76 6572 7269 6465 2074 6869  uld override thi
+00006c40: 7320 6d65 7468 6f64 2069 6620 7468 6579  s method if they
+00006c50: 2073 7570 706f 7274 2073 7472 6561 6d69   support streami
+00006c60: 6e67 206f 7574 7075 742e 0a20 2020 2020  ng output..     
+00006c70: 2020 2022 2222 0a20 2020 2020 2020 2079     """.        y
+00006c80: 6965 6c64 2061 7761 6974 2073 656c 662e  ield await self.
+00006c90: 6169 6e76 6f6b 6528 696e 7075 742c 2063  ainvoke(input, c
+00006ca0: 6f6e 6669 672c 202a 2a6b 7761 7267 7329  onfig, **kwargs)
+00006cb0: 0a0a 2020 2020 406f 7665 726c 6f61 640a  ..    @overload.
+00006cc0: 2020 2020 6465 6620 6173 7472 6561 6d5f      def astream_
+00006cd0: 6c6f 6728 0a20 2020 2020 2020 2073 656c  log(.        sel
+00006ce0: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+00006cf0: 3a20 416e 792c 0a20 2020 2020 2020 2063  : Any,.        c
+00006d00: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+00006d10: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+00006d20: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00006d30: 2a2c 0a20 2020 2020 2020 2064 6966 663a  *,.        diff:
+00006d40: 204c 6974 6572 616c 5b54 7275 655d 203d   Literal[True] =
+00006d50: 2054 7275 652c 0a20 2020 2020 2020 2077   True,.        w
+00006d60: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
+00006d70: 7075 745f 6c69 7374 3a20 626f 6f6c 203d  put_list: bool =
+00006d80: 2054 7275 652c 0a20 2020 2020 2020 2069   True,.        i
+00006d90: 6e63 6c75 6465 5f6e 616d 6573 3a20 4f70  nclude_names: Op
+00006da0: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
+00006db0: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
+00006dc0: 2020 2020 2020 696e 636c 7564 655f 7479        include_ty
+00006dd0: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
+00006de0: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+00006df0: 6f6e 652c 0a20 2020 2020 2020 2069 6e63  one,.        inc
+00006e00: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
+00006e10: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
+00006e20: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00006e30: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
+00006e40: 3a20 4f70 7469 6f6e 616c 5b53 6571 7565  : Optional[Seque
+00006e50: 6e63 655b 7374 725d 5d20 3d20 4e6f 6e65  nce[str]] = None
+00006e60: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
+00006e70: 655f 7479 7065 733a 204f 7074 696f 6e61  e_types: Optiona
+00006e80: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+00006e90: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00006ea0: 2065 7863 6c75 6465 5f74 6167 733a 204f   exclude_tags: O
+00006eb0: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00006ec0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00006ed0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00006ee0: 2041 6e79 2c0a 2020 2020 2920 2d3e 2041   Any,.    ) -> A
+00006ef0: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
+00006f00: 4c6f 6750 6174 6368 5d3a 0a20 2020 2020  LogPatch]:.     
+00006f10: 2020 202e 2e2e 0a0a 2020 2020 406f 7665     .....    @ove
+00006f20: 726c 6f61 640a 2020 2020 6465 6620 6173  rload.    def as
+00006f30: 7472 6561 6d5f 6c6f 6728 0a20 2020 2020  tream_log(.     
+00006f40: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00006f50: 2069 6e70 7574 3a20 416e 792c 0a20 2020   input: Any,.   
+00006f60: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00006f70: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
+00006f80: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2020  nfig] = None,.  
+00006f90: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00006fa0: 2064 6966 663a 204c 6974 6572 616c 5b46   diff: Literal[F
+00006fb0: 616c 7365 5d2c 0a20 2020 2020 2020 2077  alse],.        w
+00006fc0: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
+00006fd0: 7075 745f 6c69 7374 3a20 626f 6f6c 203d  put_list: bool =
+00006fe0: 2054 7275 652c 0a20 2020 2020 2020 2069   True,.        i
+00006ff0: 6e63 6c75 6465 5f6e 616d 6573 3a20 4f70  nclude_names: Op
+00007000: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
+00007010: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
+00007020: 2020 2020 2020 696e 636c 7564 655f 7479        include_ty
+00007030: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
+00007040: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+00007050: 6f6e 652c 0a20 2020 2020 2020 2069 6e63  one,.        inc
+00007060: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
+00007070: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
+00007080: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00007090: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
+000070a0: 3a20 4f70 7469 6f6e 616c 5b53 6571 7565  : Optional[Seque
+000070b0: 6e63 655b 7374 725d 5d20 3d20 4e6f 6e65  nce[str]] = None
+000070c0: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
+000070d0: 655f 7479 7065 733a 204f 7074 696f 6e61  e_types: Optiona
+000070e0: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+000070f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00007100: 2065 7863 6c75 6465 5f74 6167 733a 204f   exclude_tags: O
+00007110: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00007120: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00007130: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00007140: 2041 6e79 2c0a 2020 2020 2920 2d3e 2041   Any,.    ) -> A
+00007150: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
+00007160: 4c6f 675d 3a0a 2020 2020 2020 2020 2e2e  Log]:.        ..
+00007170: 2e0a 0a20 2020 2061 7379 6e63 2064 6566  ...    async def
+00007180: 2061 7374 7265 616d 5f6c 6f67 280a 2020   astream_log(.  
+00007190: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000071a0: 2020 2020 696e 7075 743a 2041 6e79 2c0a      input: Any,.
+000071b0: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+000071c0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+000071d0: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
+000071e0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+000071f0: 2020 2020 6469 6666 3a20 626f 6f6c 203d      diff: bool =
+00007200: 2054 7275 652c 0a20 2020 2020 2020 2077   True,.        w
+00007210: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
+00007220: 7075 745f 6c69 7374 3a20 626f 6f6c 203d  put_list: bool =
+00007230: 2054 7275 652c 0a20 2020 2020 2020 2069   True,.        i
+00007240: 6e63 6c75 6465 5f6e 616d 6573 3a20 4f70  nclude_names: Op
+00007250: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
+00007260: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
+00007270: 2020 2020 2020 696e 636c 7564 655f 7479        include_ty
+00007280: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
+00007290: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+000072a0: 6f6e 652c 0a20 2020 2020 2020 2069 6e63  one,.        inc
+000072b0: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
+000072c0: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
+000072d0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+000072e0: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
+000072f0: 3a20 4f70 7469 6f6e 616c 5b53 6571 7565  : Optional[Seque
+00007300: 6e63 655b 7374 725d 5d20 3d20 4e6f 6e65  nce[str]] = None
+00007310: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
+00007320: 655f 7479 7065 733a 204f 7074 696f 6e61  e_types: Optiona
+00007330: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+00007340: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00007350: 2065 7863 6c75 6465 5f74 6167 733a 204f   exclude_tags: O
+00007360: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00007370: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00007380: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00007390: 2041 6e79 2c0a 2020 2020 2920 2d3e 2055   Any,.    ) -> U
+000073a0: 6e69 6f6e 5b41 7379 6e63 4974 6572 6174  nion[AsyncIterat
+000073b0: 6f72 5b52 756e 4c6f 6750 6174 6368 5d2c  or[RunLogPatch],
+000073c0: 2041 7379 6e63 4974 6572 6174 6f72 5b52   AsyncIterator[R
+000073d0: 756e 4c6f 675d 5d3a 0a20 2020 2020 2020  unLog]]:.       
+000073e0: 2022 2222 0a20 2020 2020 2020 2053 7472   """.        Str
+000073f0: 6561 6d20 616c 6c20 6f75 7470 7574 2066  eam all output f
+00007400: 726f 6d20 6120 7275 6e6e 6162 6c65 2c20  rom a runnable, 
+00007410: 6173 2072 6570 6f72 7465 6420 746f 2074  as reported to t
+00007420: 6865 2063 616c 6c62 6163 6b20 7379 7374  he callback syst
+00007430: 656d 2e0a 2020 2020 2020 2020 5468 6973  em..        This
+00007440: 2069 6e63 6c75 6465 7320 616c 6c20 696e   includes all in
+00007450: 6e65 7220 7275 6e73 206f 6620 4c4c 4d73  ner runs of LLMs
+00007460: 2c20 5265 7472 6965 7665 7273 2c20 546f  , Retrievers, To
+00007470: 6f6c 732c 2065 7463 2e0a 0a20 2020 2020  ols, etc...     
+00007480: 2020 204f 7574 7075 7420 6973 2073 7472     Output is str
+00007490: 6561 6d65 6420 6173 204c 6f67 206f 626a  eamed as Log obj
+000074a0: 6563 7473 2c20 7768 6963 6820 696e 636c  ects, which incl
+000074b0: 7564 6520 6120 6c69 7374 206f 660a 2020  ude a list of.  
+000074c0: 2020 2020 2020 6a73 6f6e 7061 7463 6820        jsonpatch 
+000074d0: 6f70 7320 7468 6174 2064 6573 6372 6962  ops that describ
+000074e0: 6520 686f 7720 7468 6520 7374 6174 6520  e how the state 
+000074f0: 6f66 2074 6865 2072 756e 2068 6173 2063  of the run has c
+00007500: 6861 6e67 6564 2069 6e20 6561 6368 0a20  hanged in each. 
+00007510: 2020 2020 2020 2073 7465 702c 2061 6e64         step, and
+00007520: 2074 6865 2066 696e 616c 2073 7461 7465   the final state
+00007530: 206f 6620 7468 6520 7275 6e2e 0a0a 2020   of the run...  
+00007540: 2020 2020 2020 5468 6520 6a73 6f6e 7061        The jsonpa
+00007550: 7463 6820 6f70 7320 6361 6e20 6265 2061  tch ops can be a
+00007560: 7070 6c69 6564 2069 6e20 6f72 6465 7220  pplied in order 
+00007570: 746f 2063 6f6e 7374 7275 6374 2073 7461  to construct sta
+00007580: 7465 2e0a 0a20 2020 2020 2020 2041 7267  te...        Arg
+00007590: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+000075a0: 6e70 7574 3a20 5468 6520 696e 7075 7420  nput: The input 
+000075b0: 746f 2074 6865 2072 756e 6e61 626c 652e  to the runnable.
+000075c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000075d0: 6669 673a 2054 6865 2063 6f6e 6669 6720  fig: The config 
+000075e0: 746f 2075 7365 2066 6f72 2074 6865 2072  to use for the r
+000075f0: 756e 6e61 626c 652e 0a20 2020 2020 2020  unnable..       
+00007600: 2020 2020 2064 6966 663a 2057 6865 7468       diff: Wheth
+00007610: 6572 2074 6f20 7969 656c 6420 6469 6666  er to yield diff
+00007620: 7320 6265 7477 6565 6e20 6561 6368 2073  s between each s
+00007630: 7465 702c 206f 7220 7468 6520 6375 7272  tep, or the curr
+00007640: 656e 7420 7374 6174 652e 0a20 2020 2020  ent state..     
+00007650: 2020 2020 2020 2077 6974 685f 7374 7265         with_stre
+00007660: 616d 6564 5f6f 7574 7075 745f 6c69 7374  amed_output_list
+00007670: 3a20 5768 6574 6865 7220 746f 2079 6965  : Whether to yie
+00007680: 6c64 2074 6865 2073 7472 6561 6d65 645f  ld the streamed_
+00007690: 6f75 7470 7574 206c 6973 742e 0a20 2020  output list..   
+000076a0: 2020 2020 2020 2020 2069 6e63 6c75 6465           include
+000076b0: 5f6e 616d 6573 3a20 4f6e 6c79 2069 6e63  _names: Only inc
+000076c0: 6c75 6465 206c 6f67 7320 7769 7468 2074  lude logs with t
+000076d0: 6865 7365 206e 616d 6573 2e0a 2020 2020  hese names..    
+000076e0: 2020 2020 2020 2020 696e 636c 7564 655f          include_
+000076f0: 7479 7065 733a 204f 6e6c 7920 696e 636c  types: Only incl
+00007700: 7564 6520 6c6f 6773 2077 6974 6820 7468  ude logs with th
+00007710: 6573 6520 7479 7065 732e 0a20 2020 2020  ese types..     
+00007720: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+00007730: 6167 733a 204f 6e6c 7920 696e 636c 7564  ags: Only includ
+00007740: 6520 6c6f 6773 2077 6974 6820 7468 6573  e logs with thes
+00007750: 6520 7461 6773 2e0a 2020 2020 2020 2020  e tags..        
+00007760: 2020 2020 6578 636c 7564 655f 6e61 6d65      exclude_name
+00007770: 733a 2045 7863 6c75 6465 206c 6f67 7320  s: Exclude logs 
+00007780: 7769 7468 2074 6865 7365 206e 616d 6573  with these names
+00007790: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+000077a0: 636c 7564 655f 7479 7065 733a 2045 7863  clude_types: Exc
+000077b0: 6c75 6465 206c 6f67 7320 7769 7468 2074  lude logs with t
+000077c0: 6865 7365 2074 7970 6573 2e0a 2020 2020  hese types..    
+000077d0: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+000077e0: 7461 6773 3a20 4578 636c 7564 6520 6c6f  tags: Exclude lo
+000077f0: 6773 2077 6974 6820 7468 6573 6520 7461  gs with these ta
+00007800: 6773 2e0a 2020 2020 2020 2020 2222 220a  gs..        """.
+00007810: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+00007820: 6763 6861 696e 5f63 6f72 652e 7472 6163  gchain_core.trac
+00007830: 6572 732e 6c6f 675f 7374 7265 616d 2069  ers.log_stream i
+00007840: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
+00007850: 2020 2020 4c6f 6753 7472 6561 6d43 616c      LogStreamCal
+00007860: 6c62 6163 6b48 616e 646c 6572 2c0a 2020  lbackHandler,.  
+00007870: 2020 2020 2020 2020 2020 5f61 7374 7265            _astre
+00007880: 616d 5f6c 6f67 5f69 6d70 6c65 6d65 6e74  am_log_implement
+00007890: 6174 696f 6e2c 0a20 2020 2020 2020 2029  ation,.        )
+000078a0: 0a0a 2020 2020 2020 2020 7374 7265 616d  ..        stream
+000078b0: 203d 204c 6f67 5374 7265 616d 4361 6c6c   = LogStreamCall
+000078c0: 6261 636b 4861 6e64 6c65 7228 0a20 2020  backHandler(.   
+000078d0: 2020 2020 2020 2020 2061 7574 6f5f 636c           auto_cl
+000078e0: 6f73 653d 4661 6c73 652c 0a20 2020 2020  ose=False,.     
+000078f0: 2020 2020 2020 2069 6e63 6c75 6465 5f6e         include_n
+00007900: 616d 6573 3d69 6e63 6c75 6465 5f6e 616d  ames=include_nam
+00007910: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00007920: 696e 636c 7564 655f 7479 7065 733d 696e  include_types=in
+00007930: 636c 7564 655f 7479 7065 732c 0a20 2020  clude_types,.   
+00007940: 2020 2020 2020 2020 2069 6e63 6c75 6465           include
+00007950: 5f74 6167 733d 696e 636c 7564 655f 7461  _tags=include_ta
+00007960: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00007970: 6578 636c 7564 655f 6e61 6d65 733d 6578  exclude_names=ex
+00007980: 636c 7564 655f 6e61 6d65 732c 0a20 2020  clude_names,.   
+00007990: 2020 2020 2020 2020 2065 7863 6c75 6465           exclude
+000079a0: 5f74 7970 6573 3d65 7863 6c75 6465 5f74  _types=exclude_t
+000079b0: 7970 6573 2c0a 2020 2020 2020 2020 2020  ypes,.          
+000079c0: 2020 6578 636c 7564 655f 7461 6773 3d65    exclude_tags=e
+000079d0: 7863 6c75 6465 5f74 6167 732c 0a20 2020  xclude_tags,.   
+000079e0: 2020 2020 2020 2020 205f 7363 6865 6d61           _schema
+000079f0: 5f66 6f72 6d61 743d 226f 7269 6769 6e61  _format="origina
+00007a00: 6c22 2c0a 2020 2020 2020 2020 290a 0a20  l",.        ).. 
+00007a10: 2020 2020 2020 2023 204d 7970 7920 6973         # Mypy is
+00007a20: 6e27 7420 7265 736f 6c76 696e 6720 7468  n't resolving th
+00007a30: 6520 6f76 6572 6c6f 6164 7320 6865 7265  e overloads here
+00007a40: 0a20 2020 2020 2020 2023 204c 696b 656c  .        # Likel
+00007a50: 7920 616e 2069 7373 7565 2062 2f63 2060  y an issue b/c `
+00007a60: 7365 6c66 6020 6973 2062 6569 6e67 2070  self` is being p
+00007a70: 6173 7365 6420 7468 726f 7567 680a 2020  assed through.  
+00007a80: 2020 2020 2020 2320 616e 6420 6974 2773        # and it's
+00007a90: 2063 616e 2774 206d 6170 2069 7420 746f   can't map it to
+00007aa0: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
+00007ab0: 4f75 7470 7574 5d3f 0a20 2020 2020 2020  Output]?.       
+00007ac0: 2061 7379 6e63 2066 6f72 2069 7465 6d20   async for item 
+00007ad0: 696e 205f 6173 7472 6561 6d5f 6c6f 675f  in _astream_log_
+00007ae0: 696d 706c 656d 656e 7461 7469 6f6e 2820  implementation( 
+00007af0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+00007b00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00007b10: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00007b20: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+00007b30: 2063 6f6e 6669 672c 0a20 2020 2020 2020   config,.       
+00007b40: 2020 2020 2064 6966 663d 6469 6666 2c0a       diff=diff,.
+00007b50: 2020 2020 2020 2020 2020 2020 7374 7265              stre
+00007b60: 616d 3d73 7472 6561 6d2c 0a20 2020 2020  am=stream,.     
+00007b70: 2020 2020 2020 2077 6974 685f 7374 7265         with_stre
+00007b80: 616d 6564 5f6f 7574 7075 745f 6c69 7374  amed_output_list
+00007b90: 3d77 6974 685f 7374 7265 616d 6564 5f6f  =with_streamed_o
+00007ba0: 7574 7075 745f 6c69 7374 2c0a 2020 2020  utput_list,.    
+00007bb0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00007bc0: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
+00007bd0: 2020 2020 2020 2020 2079 6965 6c64 2069           yield i
+00007be0: 7465 6d0a 0a20 2020 2040 6265 7461 5f64  tem..    @beta_d
+00007bf0: 6563 6f72 6174 6f72 2e62 6574 6128 6d65  ecorator.beta(me
+00007c00: 7373 6167 653d 2254 6869 7320 4150 4920  ssage="This API 
+00007c10: 6973 2069 6e20 6265 7461 2061 6e64 206d  is in beta and m
+00007c20: 6179 2063 6861 6e67 6520 696e 2074 6865  ay change in the
+00007c30: 2066 7574 7572 652e 2229 0a20 2020 2061   future.").    a
+00007c40: 7379 6e63 2064 6566 2061 7374 7265 616d  sync def astream
+00007c50: 5f65 7665 6e74 7328 0a20 2020 2020 2020  _events(.       
+00007c60: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00007c70: 6e70 7574 3a20 416e 792c 0a20 2020 2020  nput: Any,.     
+00007c80: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+00007c90: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
+00007ca0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
+00007cb0: 2020 2020 2a2c 0a20 2020 2020 2020 2076      *,.        v
+00007cc0: 6572 7369 6f6e 3a20 4c69 7465 7261 6c5b  ersion: Literal[
+00007cd0: 2276 3122 2c20 2276 3222 5d2c 0a20 2020  "v1", "v2"],.   
+00007ce0: 2020 2020 2069 6e63 6c75 6465 5f6e 616d       include_nam
+00007cf0: 6573 3a20 4f70 7469 6f6e 616c 5b53 6571  es: Optional[Seq
+00007d00: 7565 6e63 655b 7374 725d 5d20 3d20 4e6f  uence[str]] = No
+00007d10: 6e65 2c0a 2020 2020 2020 2020 696e 636c  ne,.        incl
+00007d20: 7564 655f 7479 7065 733a 204f 7074 696f  ude_types: Optio
+00007d30: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
+00007d40: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00007d50: 2020 2069 6e63 6c75 6465 5f74 6167 733a     include_tags:
+00007d60: 204f 7074 696f 6e61 6c5b 5365 7175 656e   Optional[Sequen
+00007d70: 6365 5b73 7472 5d5d 203d 204e 6f6e 652c  ce[str]] = None,
+00007d80: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
+00007d90: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
+00007da0: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
+00007db0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007dc0: 6578 636c 7564 655f 7479 7065 733a 204f  exclude_types: O
+00007dd0: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00007de0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00007df0: 2020 2020 2020 2065 7863 6c75 6465 5f74         exclude_t
+00007e00: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
+00007e10: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+00007e20: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
+00007e30: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+00007e40: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
+00007e50: 6f72 5b53 7472 6561 6d45 7665 6e74 5d3a  or[StreamEvent]:
+00007e60: 0a20 2020 2020 2020 2022 2222 4765 6e65  .        """Gene
+00007e70: 7261 7465 2061 2073 7472 6561 6d20 6f66  rate a stream of
+00007e80: 2065 7665 6e74 732e 0a0a 2020 2020 2020   events...      
+00007e90: 2020 5573 6520 746f 2063 7265 6174 6520    Use to create 
+00007ea0: 616e 2069 7465 7261 746f 7220 6f76 6572  an iterator over
+00007eb0: 2053 7472 6561 6d45 7665 6e74 7320 7468   StreamEvents th
+00007ec0: 6174 2070 726f 7669 6465 2072 6561 6c2d  at provide real-
+00007ed0: 7469 6d65 2069 6e66 6f72 6d61 7469 6f6e  time information
+00007ee0: 0a20 2020 2020 2020 2061 626f 7574 2074  .        about t
+00007ef0: 6865 2070 726f 6772 6573 7320 6f66 2074  he progress of t
+00007f00: 6865 2072 756e 6e61 626c 652c 2069 6e63  he runnable, inc
+00007f10: 6c75 6469 6e67 2053 7472 6561 6d45 7665  luding StreamEve
+00007f20: 6e74 7320 6672 6f6d 2069 6e74 6572 6d65  nts from interme
+00007f30: 6469 6174 650a 2020 2020 2020 2020 7265  diate.        re
+00007f40: 7375 6c74 732e 0a0a 2020 2020 2020 2020  sults...        
+00007f50: 4120 5374 7265 616d 4576 656e 7420 6973  A StreamEvent is
+00007f60: 2061 2064 6963 7469 6f6e 6172 7920 7769   a dictionary wi
+00007f70: 7468 2074 6865 2066 6f6c 6c6f 7769 6e67  th the following
+00007f80: 2073 6368 656d 613a 0a0a 2020 2020 2020   schema:..      
+00007f90: 2020 2d20 6060 6576 656e 7460 603a 202a    - ``event``: *
+00007fa0: 2a73 7472 2a2a 202d 2045 7665 6e74 206e  *str** - Event n
+00007fb0: 616d 6573 2061 7265 206f 6620 7468 650a  ames are of the.
+00007fc0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00007fd0: 6174 3a20 6f6e 5f5b 7275 6e6e 6162 6c65  at: on_[runnable
+00007fe0: 5f74 7970 655d 5f28 7374 6172 747c 7374  _type]_(start|st
+00007ff0: 7265 616d 7c65 6e64 292e 0a20 2020 2020  ream|end)..     
+00008000: 2020 202d 2060 606e 616d 6560 603a 202a     - ``name``: *
+00008010: 2a73 7472 2a2a 202d 2054 6865 206e 616d  *str** - The nam
+00008020: 6520 6f66 2074 6865 2072 756e 6e61 626c  e of the runnabl
+00008030: 6520 7468 6174 2067 656e 6572 6174 6564  e that generated
+00008040: 2074 6865 2065 7665 6e74 2e0a 2020 2020   the event..    
+00008050: 2020 2020 2d20 6060 7275 6e5f 6964 6060      - ``run_id``
+00008060: 3a20 2a2a 7374 722a 2a20 2d20 7261 6e64  : **str** - rand
+00008070: 6f6d 6c79 2067 656e 6572 6174 6564 2049  omly generated I
+00008080: 4420 6173 736f 6369 6174 6564 2077 6974  D associated wit
+00008090: 6820 7468 6520 6769 7665 6e20 6578 6563  h the given exec
+000080a0: 7574 696f 6e20 6f66 0a20 2020 2020 2020  ution of.       
+000080b0: 2020 2020 2074 6865 2072 756e 6e61 626c       the runnabl
+000080c0: 6520 7468 6174 2065 6d69 7474 6564 2074  e that emitted t
+000080d0: 6865 2065 7665 6e74 2e0a 2020 2020 2020  he event..      
+000080e0: 2020 2020 2020 4120 6368 696c 6420 7275        A child ru
+000080f0: 6e6e 6162 6c65 2074 6861 7420 6765 7473  nnable that gets
+00008100: 2069 6e76 6f6b 6564 2061 7320 7061 7274   invoked as part
+00008110: 206f 6620 7468 6520 6578 6563 7574 696f   of the executio
+00008120: 6e20 6f66 2061 0a20 2020 2020 2020 2020  n of a.         
+00008130: 2020 2070 6172 656e 7420 7275 6e6e 6162     parent runnab
+00008140: 6c65 2069 7320 6173 7369 676e 6564 2069  le is assigned i
+00008150: 7473 206f 776e 2075 6e69 7175 6520 4944  ts own unique ID
+00008160: 2e0a 2020 2020 2020 2020 2d20 6060 7461  ..        - ``ta
+00008170: 6773 6060 3a20 2a2a 4f70 7469 6f6e 616c  gs``: **Optional
+00008180: 5b4c 6973 745b 7374 725d 5d2a 2a20 2d20  [List[str]]** - 
+00008190: 5468 6520 7461 6773 206f 6620 7468 6520  The tags of the 
+000081a0: 7275 6e6e 6162 6c65 2074 6861 7420 6765  runnable that ge
+000081b0: 6e65 7261 7465 640a 2020 2020 2020 2020  nerated.        
+000081c0: 2020 2020 7468 6520 6576 656e 742e 0a20      the event.. 
+000081d0: 2020 2020 2020 202d 2060 606d 6574 6164         - ``metad
+000081e0: 6174 6160 603a 202a 2a4f 7074 696f 6e61  ata``: **Optiona
+000081f0: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
+00008200: 5d2a 2a20 2d20 5468 6520 6d65 7461 6461  ]** - The metada
+00008210: 7461 206f 6620 7468 6520 7275 6e6e 6162  ta of the runnab
+00008220: 6c65 0a20 2020 2020 2020 2020 2020 2074  le.            t
+00008230: 6861 7420 6765 6e65 7261 7465 6420 7468  hat generated th
+00008240: 6520 6576 656e 742e 0a20 2020 2020 2020  e event..       
+00008250: 202d 2060 6064 6174 6160 603a 202a 2a44   - ``data``: **D
+00008260: 6963 745b 7374 722c 2041 6e79 5d2a 2a0a  ict[str, Any]**.
+00008270: 0a0a 2020 2020 2020 2020 4265 6c6f 7720  ..        Below 
+00008280: 6973 2061 2074 6162 6c65 2074 6861 7420  is a table that 
+00008290: 696c 6c75 7374 7261 7465 7320 736f 6d65  illustrates some
+000082a0: 2065 7665 6e73 2074 6861 7420 6d69 6768   evens that migh
+000082b0: 7420 6265 2065 6d69 7474 6564 2062 7920  t be emitted by 
+000082c0: 7661 7269 6f75 730a 2020 2020 2020 2020  various.        
+000082d0: 6368 6169 6e73 2e20 4d65 7461 6461 7461  chains. Metadata
+000082e0: 2066 6965 6c64 7320 6861 7665 2062 6565   fields have bee
+000082f0: 6e20 6f6d 6974 7465 6420 6672 6f6d 2074  n omitted from t
+00008300: 6865 2074 6162 6c65 2066 6f72 2062 7265  he table for bre
+00008310: 7669 7479 2e0a 2020 2020 2020 2020 4368  vity..        Ch
+00008320: 6169 6e20 6465 6669 6e69 7469 6f6e 7320  ain definitions 
+00008330: 6861 7665 2062 6565 6e20 696e 636c 7564  have been includ
+00008340: 6564 2061 6674 6572 2074 6865 2074 6162  ed after the tab
+00008350: 6c65 2e0a 0a20 2020 2020 2020 202a 2a41  le...        **A
+00008360: 5454 454e 5449 4f4e 2a2a 2054 6869 7320  TTENTION** This 
+00008370: 7265 6665 7265 6e63 6520 7461 626c 6520  reference table 
+00008380: 6973 2066 6f72 2074 6865 2056 3220 7665  is for the V2 ve
+00008390: 7273 696f 6e20 6f66 2074 6865 2073 6368  rsion of the sch
+000083a0: 656d 612e 0a0a 2020 2020 2020 2020 2b2d  ema...        +-
+000083b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000083c0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000083d0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000083e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000083f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008400: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008410: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008420: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008440: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008450: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008460: 2020 2020 2020 7c20 6576 656e 7420 2020        | event   
+00008470: 2020 2020 2020 2020 2020 2020 207c 206e               | n
+00008480: 616d 6520 2020 2020 2020 2020 2020 2020  ame             
+00008490: 7c20 6368 756e 6b20 2020 2020 2020 2020  | chunk         
+000084a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084b0: 2020 7c20 696e 7075 7420 2020 2020 2020    | input       
+000084c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084e0: 2020 7c20 6f75 7470 7574 2020 2020 2020    | output      
+000084f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008510: 2020 2020 7c0a 2020 2020 2020 2020 2b3d      |.        +=
+00008520: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008530: 3d3d 3d3d 3d2b 3d3d 3d3d 3d3d 3d3d 3d3d  =====+==========
+00008540: 3d3d 3d3d 3d3d 3d3d 2b3d 3d3d 3d3d 3d3d  ========+=======
+00008550: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008560: 3d3d 3d3d 3d3d 3d3d 3d3d 2b3d 3d3d 3d3d  ==========+=====
+00008570: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008580: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008590: 3d3d 3d3d 3d3d 3d3d 3d3d 2b3d 3d3d 3d3d  ==========+=====
+000085a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000085b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000085c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 2b0a 2020  ============+.  
+000085d0: 2020 2020 2020 7c20 6f6e 5f63 6861 745f        | on_chat_
+000085e0: 6d6f 6465 6c5f 7374 6172 7420 207c 205b  model_start  | [
+000085f0: 6d6f 6465 6c20 6e61 6d65 5d20 2020 2020  model name]     
+00008600: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00008610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008620: 2020 7c20 7b22 6d65 7373 6167 6573 223a    | {"messages":
+00008630: 205b 5b53 7973 7465 6d4d 6573 7361 6765   [[SystemMessage
+00008640: 2c20 4875 6d61 6e4d 6573 7361 6765 5d5d  , HumanMessage]]
+00008650: 7d20 7c20 2020 2020 2020 2020 2020 2020  } |             
+00008660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008680: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008690: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000086a0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000086b0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000086c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000086d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000086e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000086f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008700: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008710: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008720: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008730: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008740: 2020 2020 2020 7c20 6f6e 5f63 6861 745f        | on_chat_
+00008750: 6d6f 6465 6c5f 7374 7265 616d 207c 205b  model_stream | [
+00008760: 6d6f 6465 6c20 6e61 6d65 5d20 2020 2020  model name]     
+00008770: 7c20 4149 4d65 7373 6167 6543 6875 6e6b  | AIMessageChunk
+00008780: 2863 6f6e 7465 6e74 3d22 6865 6c6c 6f22  (content="hello"
+00008790: 2920 7c20 2020 2020 2020 2020 2020 2020  ) |             
+000087a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087c0: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+000087d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087f0: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008810: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00008820: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008830: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008840: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008850: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008860: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008870: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008880: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008890: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000088a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+000088b0: 2020 2020 2020 7c20 6f6e 5f63 6861 745f        | on_chat_
+000088c0: 6d6f 6465 6c5f 656e 6420 2020 207c 205b  model_end    | [
+000088d0: 6d6f 6465 6c20 6e61 6d65 5d20 2020 2020  model name]     
+000088e0: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+000088f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008900: 2020 7c20 7b22 6d65 7373 6167 6573 223a    | {"messages":
+00008910: 205b 5b53 7973 7465 6d4d 6573 7361 6765   [[SystemMessage
+00008920: 2c20 4875 6d61 6e4d 6573 7361 6765 5d5d  , HumanMessage]]
+00008930: 7d20 7c20 4149 4d65 7373 6167 6543 6875  } | AIMessageChu
+00008940: 6e6b 2863 6f6e 7465 6e74 3d22 6865 6c6c  nk(content="hell
+00008950: 6f20 776f 726c 6422 2920 2020 2020 2020  o world")       
+00008960: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008980: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00008990: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000089a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000089b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000089c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000089d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000089e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000089f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008a00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008a10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008a20: 2020 2020 2020 7c20 6f6e 5f6c 6c6d 5f73        | on_llm_s
+00008a30: 7461 7274 2020 2020 2020 2020 207c 205b  tart         | [
+00008a40: 6d6f 6465 6c20 6e61 6d65 5d20 2020 2020  model name]     
+00008a50: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a70: 2020 7c20 7b27 696e 7075 7427 3a20 2768    | {'input': 'h
+00008a80: 656c 6c6f 277d 2020 2020 2020 2020 2020  ello'}          
+00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008aa0: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00008ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ad0: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008ae0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008af0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00008b00: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008b10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b20: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008b30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b50: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008b60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008b90: 2020 2020 2020 7c20 6f6e 5f6c 6c6d 5f73        | on_llm_s
+00008ba0: 7472 6561 6d20 2020 2020 2020 207c 205b  tream        | [
+00008bb0: 6d6f 6465 6c20 6e61 6d65 5d20 2020 2020  model name]     
+00008bc0: 7c20 2748 656c 6c6f 2720 2020 2020 2020  | 'Hello'       
+00008bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008be0: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00008bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c10: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00008c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c40: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c60: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00008c70: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008c80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c90: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008ca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008cb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008cd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008ce0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008cf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008d00: 2020 2020 2020 7c20 6f6e 5f6c 6c6d 5f65        | on_llm_e
+00008d10: 6e64 2020 2020 2020 2020 2020 207c 205b  nd           | [
+00008d20: 6d6f 6465 6c20 6e61 6d65 5d20 2020 2020  model name]     
+00008d30: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00008d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d50: 2020 7c20 2748 656c 6c6f 2068 756d 616e    | 'Hello human
+00008d60: 2127 2020 2020 2020 2020 2020 2020 2020  !'              
+00008d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d80: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00008d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008db0: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008dd0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00008de0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008df0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e00: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008e10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e30: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008e40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008e70: 2020 2020 2020 7c20 6f6e 5f63 6861 696e        | on_chain
+00008e80: 5f73 7461 7274 2020 2020 2020 207c 2066  _start       | f
+00008e90: 6f72 6d61 745f 646f 6373 2020 2020 2020  ormat_docs      
+00008ea0: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00008eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ec0: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00008ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ef0: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00008f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f20: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00008f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f40: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00008f50: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008f60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f70: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008f80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00008fb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008fc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008fd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00008fe0: 2020 2020 2020 7c20 6f6e 5f63 6861 696e        | on_chain
+00008ff0: 5f73 7472 6561 6d20 2020 2020 207c 2066  _stream      | f
+00009000: 6f72 6d61 745f 646f 6373 2020 2020 2020  ormat_docs      
+00009010: 7c20 2268 656c 6c6f 2077 6f72 6c64 212c  | "hello world!,
+00009020: 2067 6f6f 6462 7965 2077 6f72 6c64 2122   goodbye world!"
+00009030: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00009040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009060: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00009070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009090: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+000090a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000090b0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000090c0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000090d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000090e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000090f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009100: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009110: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009120: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009130: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009140: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00009150: 2020 2020 2020 7c20 6f6e 5f63 6861 696e        | on_chain
+00009160: 5f65 6e64 2020 2020 2020 2020 207c 2066  _end         | f
+00009170: 6f72 6d61 745f 646f 6373 2020 2020 2020  ormat_docs      
+00009180: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00009190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091a0: 2020 7c20 5b44 6f63 756d 656e 7428 2e2e    | [Document(..
+000091b0: 2e29 5d20 2020 2020 2020 2020 2020 2020  .)]             
+000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091d0: 2020 7c20 2268 656c 6c6f 2077 6f72 6c64    | "hello world
+000091e0: 212c 2067 6f6f 6462 7965 2077 6f72 6c64  !, goodbye world
+000091f0: 2122 2020 2020 2020 2020 2020 2020 2020  !"              
+00009200: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00009210: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009220: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00009230: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009250: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009260: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009270: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009280: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000092a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000092b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+000092c0: 2020 2020 2020 7c20 6f6e 5f74 6f6f 6c5f        | on_tool_
+000092d0: 7374 6172 7420 2020 2020 2020 207c 2073  start        | s
+000092e0: 6f6d 655f 746f 6f6c 2020 2020 2020 2020  ome_tool        
+000092f0: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00009300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009310: 2020 7c20 7b22 7822 3a20 312c 2022 7922    | {"x": 1, "y"
+00009320: 3a20 2232 227d 2020 2020 2020 2020 2020  : "2"}          
+00009330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009340: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00009350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009370: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00009380: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009390: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000093a0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000093b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000093c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000093d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000093e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000093f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009400: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009410: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009420: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00009430: 2020 2020 2020 7c20 6f6e 5f74 6f6f 6c5f        | on_tool_
+00009440: 656e 6420 2020 2020 2020 2020 207c 2073  end          | s
+00009450: 6f6d 655f 746f 6f6c 2020 2020 2020 2020  ome_tool        
+00009460: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00009470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009480: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00009490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094b0: 2020 7c20 7b22 7822 3a20 312c 2022 7922    | {"x": 1, "y"
+000094c0: 3a20 2232 227d 2020 2020 2020 2020 2020  : "2"}          
 000094d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094e0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-000094f0: 2020 2020 2020 2072 756e 5f74 7970 653d         run_type=
-00009500: 7275 6e5f 7479 7065 2c0a 2020 2020 2020  run_type,.      
-00009510: 2020 2020 2020 2020 2020 6e61 6d65 3d63            name=c
-00009520: 6f6e 6669 672e 6765 7428 2272 756e 5f6e  onfig.get("run_n
-00009530: 616d 6522 2920 6f72 2073 656c 662e 6765  ame") or self.ge
-00009540: 745f 6e61 6d65 2829 2c0a 2020 2020 2020  t_name(),.      
-00009550: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00009560: 2020 2020 666f 7220 6361 6c6c 6261 636b      for callback
-00009570: 5f6d 616e 6167 6572 2c20 696e 7075 742c  _manager, input,
-00009580: 2063 6f6e 6669 6720 696e 207a 6970 280a   config in zip(.
-00009590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095a0: 6361 6c6c 6261 636b 5f6d 616e 6167 6572  callback_manager
-000095b0: 732c 2069 6e70 7574 2c20 636f 6e66 6967  s, input, config
-000095c0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-000095d0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000095e0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000095f0: 2020 2069 6620 6163 6365 7074 735f 636f     if accepts_co
-00009600: 6e66 6967 2866 756e 6329 3a0a 2020 2020  nfig(func):.    
-00009610: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
-00009620: 6773 5b22 636f 6e66 6967 225d 203d 205b  gs["config"] = [
-00009630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009640: 2020 2020 2070 6174 6368 5f63 6f6e 6669       patch_confi
-00009650: 6728 632c 2063 616c 6c62 6163 6b73 3d72  g(c, callbacks=r
-00009660: 6d2e 6765 745f 6368 696c 6428 2929 0a20  m.get_child()). 
-00009670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009680: 2020 2066 6f72 2063 2c20 726d 2069 6e20     for c, rm in 
-00009690: 7a69 7028 636f 6e66 6967 732c 2072 756e  zip(configs, run
-000096a0: 5f6d 616e 6167 6572 7329 0a20 2020 2020  _managers).     
-000096b0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-000096c0: 2020 2020 2020 2020 2069 6620 6163 6365           if acce
-000096d0: 7074 735f 7275 6e5f 6d61 6e61 6765 7228  pts_run_manager(
-000096e0: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
-000096f0: 2020 2020 2020 206b 7761 7267 735b 2272         kwargs["r
-00009700: 756e 5f6d 616e 6167 6572 225d 203d 2072  un_manager"] = r
-00009710: 756e 5f6d 616e 6167 6572 730a 2020 2020  un_managers.    
-00009720: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-00009730: 2066 756e 6328 696e 7075 742c 202a 2a6b   func(input, **k
-00009740: 7761 7267 7329 2020 2320 7479 7065 3a20  wargs)  # type: 
-00009750: 6967 6e6f 7265 5b63 616c 6c2d 6172 675d  ignore[call-arg]
-00009760: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00009770: 4261 7365 4578 6365 7074 696f 6e20 6173  BaseException as
-00009780: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00009790: 666f 7220 7275 6e5f 6d61 6e61 6765 7220  for run_manager 
-000097a0: 696e 2072 756e 5f6d 616e 6167 6572 733a  in run_managers:
-000097b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000097c0: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
-000097d0: 6368 6169 6e5f 6572 726f 7228 6529 0a20  chain_error(e). 
-000097e0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-000097f0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
-00009800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009810: 2072 6574 7572 6e20 6361 7374 284c 6973   return cast(Lis
-00009820: 745b 4f75 7470 7574 5d2c 205b 6520 666f  t[Output], [e fo
-00009830: 7220 5f20 696e 2069 6e70 7574 5d29 0a20  r _ in input]). 
-00009840: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00009850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009860: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
-00009870: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00009880: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-00009890: 3a20 4f70 7469 6f6e 616c 5b45 7863 6570  : Optional[Excep
-000098a0: 7469 6f6e 5d20 3d20 4e6f 6e65 0a20 2020  tion] = None.   
-000098b0: 2020 2020 2020 2020 2066 6f72 2072 756e           for run
-000098c0: 5f6d 616e 6167 6572 2c20 6f75 7420 696e  _manager, out in
-000098d0: 207a 6970 2872 756e 5f6d 616e 6167 6572   zip(run_manager
-000098e0: 732c 206f 7574 7075 7429 3a0a 2020 2020  s, output):.    
-000098f0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00009900: 7369 6e73 7461 6e63 6528 6f75 742c 2045  sinstance(out, E
-00009910: 7863 6570 7469 6f6e 293a 0a20 2020 2020  xception):.     
-00009920: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009930: 6972 7374 5f65 7863 6570 7469 6f6e 203d  irst_exception =
-00009940: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-00009950: 206f 7220 6f75 740a 2020 2020 2020 2020   or out.        
-00009960: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
-00009970: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
-00009980: 5f65 7272 6f72 286f 7574 290a 2020 2020  _error(out).    
-00009990: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000099a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000099b0: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
-000099c0: 722e 6f6e 5f63 6861 696e 5f65 6e64 2864  r.on_chain_end(d
-000099d0: 756d 7064 286f 7574 2929 0a20 2020 2020  umpd(out)).     
-000099e0: 2020 2020 2020 2069 6620 7265 7475 726e         if return
-000099f0: 5f65 7863 6570 7469 6f6e 7320 6f72 2066  _exceptions or f
-00009a00: 6972 7374 5f65 7863 6570 7469 6f6e 2069  irst_exception i
-00009a10: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00009a20: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00009a30: 6173 7428 4c69 7374 5b4f 7574 7075 745d  ast(List[Output]
-00009a40: 2c20 6f75 7470 7574 290a 2020 2020 2020  , output).      
-00009a50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00009a60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00009a70: 6520 6669 7273 745f 6578 6365 7074 696f  e first_exceptio
-00009a80: 6e0a 0a20 2020 2061 7379 6e63 2064 6566  n..    async def
-00009a90: 205f 6162 6174 6368 5f77 6974 685f 636f   _abatch_with_co
-00009aa0: 6e66 6967 280a 2020 2020 2020 2020 7365  nfig(.        se
-00009ab0: 6c66 2c0a 2020 2020 2020 2020 6675 6e63  lf,.        func
-00009ac0: 3a20 556e 696f 6e5b 0a20 2020 2020 2020  : Union[.       
-00009ad0: 2020 2020 2043 616c 6c61 626c 655b 5b4c       Callable[[L
-00009ae0: 6973 745b 496e 7075 745d 5d2c 2041 7761  ist[Input]], Awa
-00009af0: 6974 6162 6c65 5b4c 6973 745b 556e 696f  itable[List[Unio
-00009b00: 6e5b 4578 6365 7074 696f 6e2c 204f 7574  n[Exception, Out
-00009b10: 7075 745d 5d5d 5d2c 0a20 2020 2020 2020  put]]]],.       
-00009b20: 2020 2020 2043 616c 6c61 626c 655b 0a20       Callable[. 
-00009b30: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00009b40: 4c69 7374 5b49 6e70 7574 5d2c 204c 6973  List[Input], Lis
-00009b50: 745b 4173 796e 6343 616c 6c62 6163 6b4d  t[AsyncCallbackM
-00009b60: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-00009b70: 6e5d 5d2c 0a20 2020 2020 2020 2020 2020  n]],.           
-00009b80: 2020 2020 2041 7761 6974 6162 6c65 5b4c       Awaitable[L
-00009b90: 6973 745b 556e 696f 6e5b 4578 6365 7074  ist[Union[Except
-00009ba0: 696f 6e2c 204f 7574 7075 745d 5d5d 2c0a  ion, Output]]],.
-00009bb0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-00009bc0: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-00009bd0: 626c 655b 0a20 2020 2020 2020 2020 2020  ble[.           
-00009be0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00009bf0: 2020 2020 2020 2020 2020 204c 6973 745b             List[
-00009c00: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-00009c10: 2020 2020 2020 2020 2020 2020 4c69 7374              List
-00009c20: 5b41 7379 6e63 4361 6c6c 6261 636b 4d61  [AsyncCallbackMa
-00009c30: 6e61 6765 7246 6f72 4368 6169 6e52 756e  nagerForChainRun
-00009c40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00009c50: 2020 2020 2020 204c 6973 745b 5275 6e6e         List[Runn
-00009c60: 6162 6c65 436f 6e66 6967 5d2c 0a20 2020  ableConfig],.   
-00009c70: 2020 2020 2020 2020 2020 2020 205d 2c0a               ],.
-00009c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c90: 4177 6169 7461 626c 655b 4c69 7374 5b55  Awaitable[List[U
-00009ca0: 6e69 6f6e 5b45 7863 6570 7469 6f6e 2c20  nion[Exception, 
-00009cb0: 4f75 7470 7574 5d5d 5d2c 0a20 2020 2020  Output]]],.     
-00009cc0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00009cd0: 2020 5d2c 0a20 2020 2020 2020 2069 6e70    ],.        inp
-00009ce0: 7574 3a20 4c69 7374 5b49 6e70 7574 5d2c  ut: List[Input],
-00009cf0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00009d00: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00009d10: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
-00009d20: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
-00009d30: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
-00009d40: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00009d50: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
-00009d60: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-00009d70: 652c 0a20 2020 2020 2020 2072 756e 5f74  e,.        run_t
-00009d80: 7970 653a 204f 7074 696f 6e61 6c5b 7374  ype: Optional[st
-00009d90: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
-00009da0: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
-00009db0: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
-00009dc0: 2920 2d3e 204c 6973 745b 4f75 7470 7574  ) -> List[Output
-00009dd0: 5d3a 0a20 2020 2020 2020 2022 2222 4865  ]:.        """He
-00009de0: 6c70 6572 206d 6574 686f 6420 746f 2074  lper method to t
-00009df0: 7261 6e73 666f 726d 2061 6e20 496e 7075  ransform an Inpu
-00009e00: 7420 7661 6c75 6520 746f 2061 6e20 4f75  t value to an Ou
-00009e10: 7470 7574 2076 616c 7565 2c0a 2020 2020  tput value,.    
-00009e20: 2020 2020 7769 7468 2063 616c 6c62 6163      with callbac
-00009e30: 6b73 2e20 5573 6520 7468 6973 206d 6574  ks. Use this met
-00009e40: 686f 6420 746f 2069 6d70 6c65 6d65 6e74  hod to implement
-00009e50: 2069 6e76 6f6b 6528 2920 696e 2073 7562   invoke() in sub
-00009e60: 636c 6173 7365 732e 2222 220a 2020 2020  classes.""".    
-00009e70: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
-00009e80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00009e90: 7475 726e 205b 5d0a 0a20 2020 2020 2020  turn []..       
-00009ea0: 2063 6f6e 6669 6773 203d 2067 6574 5f63   configs = get_c
-00009eb0: 6f6e 6669 675f 6c69 7374 2863 6f6e 6669  onfig_list(confi
-00009ec0: 672c 206c 656e 2869 6e70 7574 2929 0a20  g, len(input)). 
-00009ed0: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
-00009ee0: 6d61 6e61 6765 7273 203d 205b 6765 745f  managers = [get_
-00009ef0: 6173 796e 635f 6361 6c6c 6261 636b 5f6d  async_callback_m
-00009f00: 616e 6167 6572 5f66 6f72 5f63 6f6e 6669  anager_for_confi
-00009f10: 6728 6329 2066 6f72 2063 2069 6e20 636f  g(c) for c in co
-00009f20: 6e66 6967 735d 0a20 2020 2020 2020 2072  nfigs].        r
-00009f30: 756e 5f6d 616e 6167 6572 733a 204c 6973  un_managers: Lis
-00009f40: 745b 4173 796e 6343 616c 6c62 6163 6b4d  t[AsyncCallbackM
-00009f50: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-00009f60: 6e5d 203d 2061 7761 6974 2061 7379 6e63  n] = await async
-00009f70: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00009f80: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
-00009f90: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
-00009fa0: 636b 5f6d 616e 6167 6572 2e6f 6e5f 6368  ck_manager.on_ch
-00009fb0: 6169 6e5f 7374 6172 7428 0a20 2020 2020  ain_start(.     
-00009fc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00009fd0: 756d 7064 2873 656c 6629 2c0a 2020 2020  umpd(self),.    
-00009fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ff0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-0000a000: 2020 2020 2020 2020 2020 2072 756e 5f74             run_t
-0000a010: 7970 653d 7275 6e5f 7479 7065 2c0a 2020  ype=run_type,.  
-0000a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a030: 2020 6e61 6d65 3d63 6f6e 6669 672e 6765    name=config.ge
-0000a040: 7428 2272 756e 5f6e 616d 6522 2920 6f72  t("run_name") or
-0000a050: 2073 656c 662e 6765 745f 6e61 6d65 2829   self.get_name()
-0000a060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a070: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000a080: 2020 2020 666f 7220 6361 6c6c 6261 636b      for callback
-0000a090: 5f6d 616e 6167 6572 2c20 696e 7075 742c  _manager, input,
-0000a0a0: 2063 6f6e 6669 6720 696e 207a 6970 280a   config in zip(.
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0c0: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
-0000a0d0: 6167 6572 732c 2069 6e70 7574 2c20 636f  agers, input, co
-0000a0e0: 6e66 6967 730a 2020 2020 2020 2020 2020  nfigs.          
-0000a0f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a100: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-0000a110: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000a120: 2020 2020 2020 2020 2069 6620 6163 6365           if acce
-0000a130: 7074 735f 636f 6e66 6967 2866 756e 6329  pts_config(func)
-0000a140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a150: 2020 6b77 6172 6773 5b22 636f 6e66 6967    kwargs["config
-0000a160: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
-0000a170: 2020 2020 2020 2020 2020 2070 6174 6368             patch
-0000a180: 5f63 6f6e 6669 6728 632c 2063 616c 6c62  _config(c, callb
-0000a190: 6163 6b73 3d72 6d2e 6765 745f 6368 696c  acks=rm.get_chil
-0000a1a0: 6428 2929 0a20 2020 2020 2020 2020 2020  d()).           
-0000a1b0: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
-0000a1c0: 726d 2069 6e20 7a69 7028 636f 6e66 6967  rm in zip(config
-0000a1d0: 732c 2072 756e 5f6d 616e 6167 6572 7329  s, run_managers)
-0000a1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a1f0: 205d 0a20 2020 2020 2020 2020 2020 2069   ].            i
-0000a200: 6620 6163 6365 7074 735f 7275 6e5f 6d61  f accepts_run_ma
-0000a210: 6e61 6765 7228 6675 6e63 293a 0a20 2020  nager(func):.   
-0000a220: 2020 2020 2020 2020 2020 2020 206b 7761               kwa
-0000a230: 7267 735b 2272 756e 5f6d 616e 6167 6572  rgs["run_manager
-0000a240: 225d 203d 2072 756e 5f6d 616e 6167 6572  "] = run_manager
-0000a250: 730a 2020 2020 2020 2020 2020 2020 6f75  s.            ou
-0000a260: 7470 7574 203d 2061 7761 6974 2066 756e  tput = await fun
-0000a270: 6328 696e 7075 742c 202a 2a6b 7761 7267  c(input, **kwarg
-0000a280: 7329 2020 2320 7479 7065 3a20 6967 6e6f  s)  # type: igno
-0000a290: 7265 5b63 616c 6c2d 6172 675d 0a20 2020  re[call-arg].   
-0000a2a0: 2020 2020 2065 7863 6570 7420 4261 7365       except Base
-0000a2b0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-0000a2c0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0000a2d0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0000a2e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a2f0: 2020 2a28 7275 6e5f 6d61 6e61 6765 722e    *(run_manager.
-0000a300: 6f6e 5f63 6861 696e 5f65 7272 6f72 2865  on_chain_error(e
-0000a310: 2920 666f 7220 7275 6e5f 6d61 6e61 6765  ) for run_manage
-0000a320: 7220 696e 2072 756e 5f6d 616e 6167 6572  r in run_manager
-0000a330: 7329 0a20 2020 2020 2020 2020 2020 2029  s).            )
-0000a340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000a350: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-0000a360: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000a370: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
-0000a380: 6973 745b 4f75 7470 7574 5d2c 205b 6520  ist[Output], [e 
-0000a390: 666f 7220 5f20 696e 2069 6e70 7574 5d29  for _ in input])
-0000a3a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000a3b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000a3c0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
-0000a3d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000a3e0: 2020 2066 6972 7374 5f65 7863 6570 7469     first_excepti
-0000a3f0: 6f6e 3a20 4f70 7469 6f6e 616c 5b45 7863  on: Optional[Exc
-0000a400: 6570 7469 6f6e 5d20 3d20 4e6f 6e65 0a20  eption] = None. 
-0000a410: 2020 2020 2020 2020 2020 2063 6f72 6f73             coros
-0000a420: 3a20 4c69 7374 5b41 7761 6974 6162 6c65  : List[Awaitable
-0000a430: 5b4e 6f6e 655d 5d20 3d20 5b5d 0a20 2020  [None]] = [].   
-0000a440: 2020 2020 2020 2020 2066 6f72 2072 756e           for run
-0000a450: 5f6d 616e 6167 6572 2c20 6f75 7420 696e  _manager, out in
-0000a460: 207a 6970 2872 756e 5f6d 616e 6167 6572   zip(run_manager
-0000a470: 732c 206f 7574 7075 7429 3a0a 2020 2020  s, output):.    
-0000a480: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000a490: 7369 6e73 7461 6e63 6528 6f75 742c 2045  sinstance(out, E
-0000a4a0: 7863 6570 7469 6f6e 293a 0a20 2020 2020  xception):.     
-0000a4b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000a4c0: 6972 7374 5f65 7863 6570 7469 6f6e 203d  irst_exception =
-0000a4d0: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-0000a4e0: 206f 7220 6f75 740a 2020 2020 2020 2020   or out.        
-0000a4f0: 2020 2020 2020 2020 2020 2020 636f 726f              coro
-0000a500: 732e 6170 7065 6e64 2872 756e 5f6d 616e  s.append(run_man
-0000a510: 6167 6572 2e6f 6e5f 6368 6169 6e5f 6572  ager.on_chain_er
-0000a520: 726f 7228 6f75 7429 290a 2020 2020 2020  ror(out)).      
-0000a530: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a550: 2020 2020 636f 726f 732e 6170 7065 6e64      coros.append
-0000a560: 2872 756e 5f6d 616e 6167 6572 2e6f 6e5f  (run_manager.on_
-0000a570: 6368 6169 6e5f 656e 6428 6475 6d70 6428  chain_end(dumpd(
-0000a580: 6f75 7429 2929 0a20 2020 2020 2020 2020  out))).         
-0000a590: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-0000a5a0: 2e67 6174 6865 7228 2a63 6f72 6f73 290a  .gather(*coros).
-0000a5b0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0000a5c0: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
-0000a5d0: 206f 7220 6669 7273 745f 6578 6365 7074   or first_except
-0000a5e0: 696f 6e20 6973 204e 6f6e 653a 0a20 2020  ion is None:.   
-0000a5f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000a600: 7572 6e20 6361 7374 284c 6973 745b 4f75  urn cast(List[Ou
-0000a610: 7470 7574 5d2c 206f 7574 7075 7429 0a20  tput], output). 
-0000a620: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a640: 2072 6169 7365 2066 6972 7374 5f65 7863   raise first_exc
-0000a650: 6570 7469 6f6e 0a0a 2020 2020 6465 6620  eption..    def 
-0000a660: 5f74 7261 6e73 666f 726d 5f73 7472 6561  _transform_strea
-0000a670: 6d5f 7769 7468 5f63 6f6e 6669 6728 0a20  m_with_config(. 
-0000a680: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000a690: 2020 2020 2069 6e70 7574 3a20 4974 6572       input: Iter
-0000a6a0: 6174 6f72 5b49 6e70 7574 5d2c 0a20 2020  ator[Input],.   
-0000a6b0: 2020 2020 2074 7261 6e73 666f 726d 6572       transformer
-0000a6c0: 3a20 556e 696f 6e5b 0a20 2020 2020 2020  : Union[.       
-0000a6d0: 2020 2020 2043 616c 6c61 626c 655b 5b49       Callable[[I
-0000a6e0: 7465 7261 746f 725b 496e 7075 745d 5d2c  terator[Input]],
-0000a6f0: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
-0000a700: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0000a710: 4361 6c6c 6162 6c65 5b5b 4974 6572 6174  Callable[[Iterat
-0000a720: 6f72 5b49 6e70 7574 5d2c 2043 616c 6c62  or[Input], Callb
-0000a730: 6163 6b4d 616e 6167 6572 466f 7243 6861  ackManagerForCha
-0000a740: 696e 5275 6e5d 2c20 4974 6572 6174 6f72  inRun], Iterator
-0000a750: 5b4f 7574 7075 745d 5d2c 0a20 2020 2020  [Output]],.     
-0000a760: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
-0000a770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a780: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0000a790: 2020 2020 2020 2049 7465 7261 746f 725b         Iterator[
-0000a7a0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-0000a7b0: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
-0000a7c0: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
-0000a7d0: 6169 6e52 756e 2c0a 2020 2020 2020 2020  ainRun,.        
-0000a7e0: 2020 2020 2020 2020 2020 2020 5275 6e6e              Runn
-0000a7f0: 6162 6c65 436f 6e66 6967 2c0a 2020 2020  ableConfig,.    
-0000a800: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-0000a820: 7465 7261 746f 725b 4f75 7470 7574 5d2c  terator[Output],
-0000a830: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-0000a840: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000a850: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-0000a860: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0000a870: 6967 5d2c 0a20 2020 2020 2020 2072 756e  ig],.        run
-0000a880: 5f74 7970 653a 204f 7074 696f 6e61 6c5b  _type: Optional[
-0000a890: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-0000a8a0: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
-0000a8b0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
-0000a8c0: 2020 2920 2d3e 2049 7465 7261 746f 725b    ) -> Iterator[
-0000a8d0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
-0000a8e0: 2022 2222 4865 6c70 6572 206d 6574 686f   """Helper metho
-0000a8f0: 6420 746f 2074 7261 6e73 666f 726d 2061  d to transform a
-0000a900: 6e20 4974 6572 6174 6f72 206f 6620 496e  n Iterator of In
-0000a910: 7075 7420 7661 6c75 6573 2069 6e74 6f20  put values into 
-0000a920: 616e 2049 7465 7261 746f 7220 6f66 0a20  an Iterator of. 
-0000a930: 2020 2020 2020 204f 7574 7075 7420 7661         Output va
-0000a940: 6c75 6573 2c20 7769 7468 2063 616c 6c62  lues, with callb
-0000a950: 6163 6b73 2e0a 2020 2020 2020 2020 5573  acks..        Us
-0000a960: 6520 7468 6973 2074 6f20 696d 706c 656d  e this to implem
-0000a970: 656e 7420 6073 7472 6561 6d28 2960 206f  ent `stream()` o
-0000a980: 7220 6074 7261 6e73 666f 726d 2829 6020  r `transform()` 
-0000a990: 696e 2052 756e 6e61 626c 6520 7375 6263  in Runnable subc
-0000a9a0: 6c61 7373 6573 2e22 2222 0a20 2020 2020  lasses.""".     
-0000a9b0: 2020 2023 2074 6565 2074 6865 2069 6e70     # tee the inp
-0000a9c0: 7574 2073 6f20 7765 2063 616e 2069 7465  ut so we can ite
-0000a9d0: 7261 7465 206f 7665 7220 6974 2074 7769  rate over it twi
-0000a9e0: 6365 0a20 2020 2020 2020 2069 6e70 7574  ce.        input
-0000a9f0: 5f66 6f72 5f74 7261 6369 6e67 2c20 696e  _for_tracing, in
-0000aa00: 7075 745f 666f 725f 7472 616e 7366 6f72  put_for_transfor
-0000aa10: 6d20 3d20 7465 6528 696e 7075 742c 2032  m = tee(input, 2
-0000aa20: 290a 2020 2020 2020 2020 2320 5374 6172  ).        # Star
-0000aa30: 7420 7468 6520 696e 7075 7420 6974 6572  t the input iter
-0000aa40: 6174 6f72 2074 6f20 656e 7375 7265 2074  ator to ensure t
-0000aa50: 6865 2069 6e70 7574 2072 756e 6e61 626c  he input runnabl
-0000aa60: 6520 7374 6172 7473 2062 6566 6f72 6520  e starts before 
-0000aa70: 7468 6973 206f 6e65 0a20 2020 2020 2020  this one.       
-0000aa80: 2066 696e 616c 5f69 6e70 7574 3a20 4f70   final_input: Op
-0000aa90: 7469 6f6e 616c 5b49 6e70 7574 5d20 3d20  tional[Input] = 
-0000aaa0: 6e65 7874 2869 6e70 7574 5f66 6f72 5f74  next(input_for_t
-0000aab0: 7261 6369 6e67 2c20 4e6f 6e65 290a 2020  racing, None).  
-0000aac0: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
-0000aad0: 745f 7375 7070 6f72 7465 6420 3d20 5472  t_supported = Tr
-0000aae0: 7565 0a20 2020 2020 2020 2066 696e 616c  ue.        final
-0000aaf0: 5f6f 7574 7075 743a 204f 7074 696f 6e61  _output: Optiona
-0000ab00: 6c5b 4f75 7470 7574 5d20 3d20 4e6f 6e65  l[Output] = None
-0000ab10: 0a20 2020 2020 2020 2066 696e 616c 5f6f  .        final_o
-0000ab20: 7574 7075 745f 7375 7070 6f72 7465 6420  utput_supported 
-0000ab30: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-0000ab40: 636f 6e66 6967 203d 2065 6e73 7572 655f  config = ensure_
-0000ab50: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
-0000ab60: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
-0000ab70: 6d61 6e61 6765 7220 3d20 6765 745f 6361  manager = get_ca
-0000ab80: 6c6c 6261 636b 5f6d 616e 6167 6572 5f66  llback_manager_f
-0000ab90: 6f72 5f63 6f6e 6669 6728 636f 6e66 6967  or_config(config
-0000aba0: 290a 2020 2020 2020 2020 7275 6e5f 6d61  ).        run_ma
-0000abb0: 6e61 6765 7220 3d20 6361 6c6c 6261 636b  nager = callback
-0000abc0: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
-0000abd0: 6e5f 7374 6172 7428 0a20 2020 2020 2020  n_start(.       
-0000abe0: 2020 2020 2064 756d 7064 2873 656c 6629       dumpd(self)
-0000abf0: 2c0a 2020 2020 2020 2020 2020 2020 7b22  ,.            {"
-0000ac00: 696e 7075 7422 3a20 2222 7d2c 0a20 2020  input": ""},.   
-0000ac10: 2020 2020 2020 2020 2072 756e 5f74 7970           run_typ
-0000ac20: 653d 7275 6e5f 7479 7065 2c0a 2020 2020  e=run_type,.    
-0000ac30: 2020 2020 2020 2020 6e61 6d65 3d63 6f6e          name=con
-0000ac40: 6669 672e 6765 7428 2272 756e 5f6e 616d  fig.get("run_nam
-0000ac50: 6522 2920 6f72 2073 656c 662e 6765 745f  e") or self.get_
-0000ac60: 6e61 6d65 2829 2c0a 2020 2020 2020 2020  name(),.        
-0000ac70: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-0000ac80: 2020 2020 2020 2020 2020 2063 6869 6c64             child
-0000ac90: 5f63 6f6e 6669 6720 3d20 7061 7463 685f  _config = patch_
-0000aca0: 636f 6e66 6967 2863 6f6e 6669 672c 2063  config(config, c
-0000acb0: 616c 6c62 6163 6b73 3d72 756e 5f6d 616e  allbacks=run_man
-0000acc0: 6167 6572 2e67 6574 5f63 6869 6c64 2829  ager.get_child()
-0000acd0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000ace0: 2061 6363 6570 7473 5f63 6f6e 6669 6728   accepts_config(
-0000acf0: 7472 616e 7366 6f72 6d65 7229 3a0a 2020  transformer):.  
-0000ad00: 2020 2020 2020 2020 2020 2020 2020 6b77                kw
-0000ad10: 6172 6773 5b22 636f 6e66 6967 225d 203d  args["config"] =
-0000ad20: 2063 6869 6c64 5f63 6f6e 6669 670a 2020   child_config.  
-0000ad30: 2020 2020 2020 2020 2020 6966 2061 6363            if acc
-0000ad40: 6570 7473 5f72 756e 5f6d 616e 6167 6572  epts_run_manager
-0000ad50: 2874 7261 6e73 666f 726d 6572 293a 0a20  (transformer):. 
-0000ad60: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0000ad70: 7761 7267 735b 2272 756e 5f6d 616e 6167  wargs["run_manag
-0000ad80: 6572 225d 203d 2072 756e 5f6d 616e 6167  er"] = run_manag
-0000ad90: 6572 0a20 2020 2020 2020 2020 2020 2063  er.            c
-0000ada0: 6f6e 7465 7874 203d 2063 6f70 795f 636f  ontext = copy_co
-0000adb0: 6e74 6578 7428 290a 2020 2020 2020 2020  ntext().        
-0000adc0: 2020 2020 636f 6e74 6578 742e 7275 6e28      context.run(
-0000add0: 7661 725f 6368 696c 645f 7275 6e6e 6162  var_child_runnab
-0000ade0: 6c65 5f63 6f6e 6669 672e 7365 742c 2063  le_config.set, c
-0000adf0: 6869 6c64 5f63 6f6e 6669 6729 0a20 2020  hild_config).   
-0000ae00: 2020 2020 2020 2020 2069 7465 7261 746f           iterato
-0000ae10: 7220 3d20 636f 6e74 6578 742e 7275 6e28  r = context.run(
-0000ae20: 7472 616e 7366 6f72 6d65 722c 2069 6e70  transformer, inp
-0000ae30: 7574 5f66 6f72 5f74 7261 6e73 666f 726d  ut_for_transform
-0000ae40: 2c20 2a2a 6b77 6172 6773 2920 2023 2074  , **kwargs)  # t
-0000ae50: 7970 653a 2069 676e 6f72 655b 6172 672d  ype: ignore[arg-
-0000ae60: 7479 7065 5d0a 2020 2020 2020 2020 2020  type].          
-0000ae70: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000ae80: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
-0000ae90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000aea0: 2020 2020 2020 2063 6875 6e6b 3a20 4f75         chunk: Ou
-0000aeb0: 7470 7574 203d 2063 6f6e 7465 7874 2e72  tput = context.r
-0000aec0: 756e 286e 6578 742c 2069 7465 7261 746f  un(next, iterato
-0000aed0: 7229 2020 2320 7479 7065 3a20 6967 6e6f  r)  # type: igno
-0000aee0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
-0000aef0: 2020 2020 2020 2079 6965 6c64 2063 6875         yield chu
-0000af00: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
-0000af10: 2020 2020 2020 2069 6620 6669 6e61 6c5f         if final_
-0000af20: 6f75 7470 7574 5f73 7570 706f 7274 6564  output_supported
-0000af30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000af40: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
-0000af50: 616c 5f6f 7574 7075 7420 6973 204e 6f6e  al_output is Non
-0000af60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000af70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000af80: 696e 616c 5f6f 7574 7075 7420 3d20 6368  inal_output = ch
-0000af90: 756e 6b0a 2020 2020 2020 2020 2020 2020  unk.            
-0000afa0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000afb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000afc0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0000afd0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aff0: 2020 2066 696e 616c 5f6f 7574 7075 7420     final_output 
-0000b000: 3d20 6669 6e61 6c5f 6f75 7470 7574 202b  = final_output +
-0000b010: 2063 6875 6e6b 2020 2320 7479 7065 3a20   chunk  # type: 
-0000b020: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
-0000b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b040: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
-0000b050: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0000b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b070: 2020 2020 2066 696e 616c 5f6f 7574 7075       final_outpu
-0000b080: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0000b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0a0: 2020 2020 2020 2020 2066 696e 616c 5f6f           final_o
-0000b0b0: 7574 7075 745f 7375 7070 6f72 7465 6420  utput_supported 
-0000b0c0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000b0d0: 2020 2020 6578 6365 7074 2053 746f 7049      except StopI
-0000b0e0: 7465 7261 7469 6f6e 3a0a 2020 2020 2020  teration:.      
-0000b0f0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-0000b100: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0000b110: 6368 756e 6b20 696e 2069 6e70 7574 5f66  chunk in input_f
-0000b120: 6f72 5f74 7261 6369 6e67 3a0a 2020 2020  or_tracing:.    
-0000b130: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-0000b140: 696e 616c 5f69 6e70 7574 5f73 7570 706f  inal_input_suppo
-0000b150: 7274 6564 3a0a 2020 2020 2020 2020 2020  rted:.          
-0000b160: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
-0000b170: 616c 5f69 6e70 7574 2069 7320 4e6f 6e65  al_input is None
-0000b180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b190: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
-0000b1a0: 696e 7075 7420 3d20 6963 6875 6e6b 0a20  input = ichunk. 
-0000b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b200: 2020 6669 6e61 6c5f 696e 7075 7420 3d20    final_input = 
-0000b210: 6669 6e61 6c5f 696e 7075 7420 2b20 6963  final_input + ic
-0000b220: 6875 6e6b 2020 2320 7479 7065 3a20 6967  hunk  # type: ig
-0000b230: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-0000b240: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0000b250: 6570 7420 5479 7065 4572 726f 723a 0a20  ept TypeError:. 
-0000b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b270: 2020 2020 2020 2020 2020 2066 696e 616c             final
-0000b280: 5f69 6e70 7574 203d 204e 6f6e 650a 2020  _input = None.  
-0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2a0: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
-0000b2b0: 696e 7075 745f 7375 7070 6f72 7465 6420  input_supported 
-0000b2c0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000b2d0: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
-0000b2e0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0000b2f0: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
-0000b300: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
-0000b310: 7228 652c 2069 6e70 7574 733d 6669 6e61  r(e, inputs=fina
-0000b320: 6c5f 696e 7075 7429 0a20 2020 2020 2020  l_input).       
-0000b330: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
-0000b340: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b350: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-0000b360: 2e6f 6e5f 6368 6169 6e5f 656e 6428 6669  .on_chain_end(fi
-0000b370: 6e61 6c5f 6f75 7470 7574 2c20 696e 7075  nal_output, inpu
-0000b380: 7473 3d66 696e 616c 5f69 6e70 7574 290a  ts=final_input).
-0000b390: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
-0000b3a0: 6174 7261 6e73 666f 726d 5f73 7472 6561  atransform_strea
-0000b3b0: 6d5f 7769 7468 5f63 6f6e 6669 6728 0a20  m_with_config(. 
-0000b3c0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000b3d0: 2020 2020 2069 6e70 7574 3a20 4173 796e       input: Asyn
-0000b3e0: 6349 7465 7261 746f 725b 496e 7075 745d  cIterator[Input]
-0000b3f0: 2c0a 2020 2020 2020 2020 7472 616e 7366  ,.        transf
-0000b400: 6f72 6d65 723a 2055 6e69 6f6e 5b0a 2020  ormer: Union[.  
-0000b410: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-0000b420: 6c65 5b5b 4173 796e 6349 7465 7261 746f  le[[AsyncIterato
-0000b430: 725b 496e 7075 745d 5d2c 2041 7379 6e63  r[Input]], Async
-0000b440: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
-0000b450: 5d2c 0a20 2020 2020 2020 2020 2020 2043  ],.            C
-0000b460: 616c 6c61 626c 655b 0a20 2020 2020 2020  allable[.       
-0000b470: 2020 2020 2020 2020 205b 4173 796e 6349           [AsyncI
-0000b480: 7465 7261 746f 725b 496e 7075 745d 2c20  terator[Input], 
-0000b490: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
-0000b4a0: 6167 6572 466f 7243 6861 696e 5275 6e5d  agerForChainRun]
-0000b4b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b4c0: 2020 4173 796e 6349 7465 7261 746f 725b    AsyncIterator[
-0000b4d0: 4f75 7470 7574 5d2c 0a20 2020 2020 2020  Output],.       
-0000b4e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000b4f0: 2020 2020 4361 6c6c 6162 6c65 5b0a 2020      Callable[.  
-0000b500: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
-0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b520: 2020 2020 4173 796e 6349 7465 7261 746f      AsyncIterato
-0000b530: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
-0000b540: 2020 2020 2020 2020 2020 2020 2020 4173                As
-0000b550: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
-0000b560: 6572 466f 7243 6861 696e 5275 6e2c 0a20  erForChainRun,. 
-0000b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b580: 2020 2052 756e 6e61 626c 6543 6f6e 6669     RunnableConfi
-0000b590: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-0000b5a0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0000b5b0: 2020 2020 2020 4173 796e 6349 7465 7261        AsyncItera
-0000b5c0: 746f 725b 4f75 7470 7574 5d2c 0a20 2020  tor[Output],.   
-0000b5d0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0000b5e0: 2020 2020 5d2c 0a20 2020 2020 2020 2063      ],.        c
-0000b5f0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-0000b600: 5275 6e6e 6162 6c65 436f 6e66 6967 5d2c  RunnableConfig],
-0000b610: 0a20 2020 2020 2020 2072 756e 5f74 7970  .        run_typ
-0000b620: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
-0000b630: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0000b640: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-0000b650: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-0000b660: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
-0000b670: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
-0000b680: 2020 2222 2248 656c 7065 7220 6d65 7468    """Helper meth
-0000b690: 6f64 2074 6f20 7472 616e 7366 6f72 6d20  od to transform 
-0000b6a0: 616e 2041 7379 6e63 2049 7465 7261 746f  an Async Iterato
-0000b6b0: 7220 6f66 2049 6e70 7574 2076 616c 7565  r of Input value
-0000b6c0: 7320 696e 746f 2061 6e20 4173 796e 630a  s into an Async.
-0000b6d0: 2020 2020 2020 2020 4974 6572 6174 6f72          Iterator
-0000b6e0: 206f 6620 4f75 7470 7574 2076 616c 7565   of Output value
-0000b6f0: 732c 2077 6974 6820 6361 6c6c 6261 636b  s, with callback
-0000b700: 732e 0a20 2020 2020 2020 2055 7365 2074  s..        Use t
-0000b710: 6869 7320 746f 2069 6d70 6c65 6d65 6e74  his to implement
-0000b720: 2060 6173 7472 6561 6d28 2960 206f 7220   `astream()` or 
-0000b730: 6061 7472 616e 7366 6f72 6d28 2960 2069  `atransform()` i
-0000b740: 6e20 5275 6e6e 6162 6c65 2073 7562 636c  n Runnable subcl
-0000b750: 6173 7365 732e 2222 220a 2020 2020 2020  asses.""".      
-0000b760: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
-0000b770: 5f63 6f72 652e 7472 6163 6572 732e 6c6f  _core.tracers.lo
-0000b780: 675f 7374 7265 616d 2069 6d70 6f72 7420  g_stream import 
-0000b790: 4c6f 6753 7472 6561 6d43 616c 6c62 6163  LogStreamCallbac
-0000b7a0: 6b48 616e 646c 6572 0a0a 2020 2020 2020  kHandler..      
-0000b7b0: 2020 2320 7465 6520 7468 6520 696e 7075    # tee the inpu
-0000b7c0: 7420 736f 2077 6520 6361 6e20 6974 6572  t so we can iter
-0000b7d0: 6174 6520 6f76 6572 2069 7420 7477 6963  ate over it twic
-0000b7e0: 650a 2020 2020 2020 2020 696e 7075 745f  e.        input_
-0000b7f0: 666f 725f 7472 6163 696e 672c 2069 6e70  for_tracing, inp
-0000b800: 7574 5f66 6f72 5f74 7261 6e73 666f 726d  ut_for_transform
-0000b810: 203d 2061 7465 6528 696e 7075 742c 2032   = atee(input, 2
-0000b820: 290a 2020 2020 2020 2020 2320 5374 6172  ).        # Star
-0000b830: 7420 7468 6520 696e 7075 7420 6974 6572  t the input iter
-0000b840: 6174 6f72 2074 6f20 656e 7375 7265 2074  ator to ensure t
-0000b850: 6865 2069 6e70 7574 2072 756e 6e61 626c  he input runnabl
-0000b860: 6520 7374 6172 7473 2062 6566 6f72 6520  e starts before 
-0000b870: 7468 6973 206f 6e65 0a20 2020 2020 2020  this one.       
-0000b880: 2066 696e 616c 5f69 6e70 7574 3a20 4f70   final_input: Op
-0000b890: 7469 6f6e 616c 5b49 6e70 7574 5d20 3d20  tional[Input] = 
-0000b8a0: 6177 6169 7420 7079 5f61 6e65 7874 2869  await py_anext(i
-0000b8b0: 6e70 7574 5f66 6f72 5f74 7261 6369 6e67  nput_for_tracing
-0000b8c0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0000b8d0: 6669 6e61 6c5f 696e 7075 745f 7375 7070  final_input_supp
-0000b8e0: 6f72 7465 6420 3d20 5472 7565 0a20 2020  orted = True.   
-0000b8f0: 2020 2020 2066 696e 616c 5f6f 7574 7075       final_outpu
-0000b900: 743a 204f 7074 696f 6e61 6c5b 4f75 7470  t: Optional[Outp
-0000b910: 7574 5d20 3d20 4e6f 6e65 0a20 2020 2020  ut] = None.     
-0000b920: 2020 2066 696e 616c 5f6f 7574 7075 745f     final_output_
-0000b930: 7375 7070 6f72 7465 6420 3d20 5472 7565  supported = True
-0000b940: 0a0a 2020 2020 2020 2020 636f 6e66 6967  ..        config
-0000b950: 203d 2065 6e73 7572 655f 636f 6e66 6967   = ensure_config
-0000b960: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
-0000b970: 2063 616c 6c62 6163 6b5f 6d61 6e61 6765   callback_manage
-0000b980: 7220 3d20 6765 745f 6173 796e 635f 6361  r = get_async_ca
-0000b990: 6c6c 6261 636b 5f6d 616e 6167 6572 5f66  llback_manager_f
-0000b9a0: 6f72 5f63 6f6e 6669 6728 636f 6e66 6967  or_config(config
-0000b9b0: 290a 2020 2020 2020 2020 7275 6e5f 6d61  ).        run_ma
-0000b9c0: 6e61 6765 7220 3d20 6177 6169 7420 6361  nager = await ca
-0000b9d0: 6c6c 6261 636b 5f6d 616e 6167 6572 2e6f  llback_manager.o
-0000b9e0: 6e5f 6368 6169 6e5f 7374 6172 7428 0a20  n_chain_start(. 
-0000b9f0: 2020 2020 2020 2020 2020 2064 756d 7064             dumpd
-0000ba00: 2873 656c 6629 2c0a 2020 2020 2020 2020  (self),.        
-0000ba10: 2020 2020 7b22 696e 7075 7422 3a20 2222      {"input": ""
-0000ba20: 7d2c 0a20 2020 2020 2020 2020 2020 2072  },.            r
-0000ba30: 756e 5f74 7970 653d 7275 6e5f 7479 7065  un_type=run_type
-0000ba40: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-0000ba50: 6d65 3d63 6f6e 6669 672e 6765 7428 2272  me=config.get("r
-0000ba60: 756e 5f6e 616d 6522 2920 6f72 2073 656c  un_name") or sel
-0000ba70: 662e 6765 745f 6e61 6d65 2829 2c0a 2020  f.get_name(),.  
-0000ba80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000ba90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000baa0: 2063 6869 6c64 5f63 6f6e 6669 6720 3d20   child_config = 
-0000bab0: 7061 7463 685f 636f 6e66 6967 2863 6f6e  patch_config(con
-0000bac0: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
-0000bad0: 756e 5f6d 616e 6167 6572 2e67 6574 5f63  un_manager.get_c
-0000bae0: 6869 6c64 2829 290a 2020 2020 2020 2020  hild()).        
-0000baf0: 2020 2020 6966 2061 6363 6570 7473 5f63      if accepts_c
-0000bb00: 6f6e 6669 6728 7472 616e 7366 6f72 6d65  onfig(transforme
-0000bb10: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000bb20: 2020 2020 6b77 6172 6773 5b22 636f 6e66      kwargs["conf
-0000bb30: 6967 225d 203d 2063 6869 6c64 5f63 6f6e  ig"] = child_con
-0000bb40: 6669 670a 2020 2020 2020 2020 2020 2020  fig.            
-0000bb50: 6966 2061 6363 6570 7473 5f72 756e 5f6d  if accepts_run_m
-0000bb60: 616e 6167 6572 2874 7261 6e73 666f 726d  anager(transform
-0000bb70: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
-0000bb80: 2020 2020 206b 7761 7267 735b 2272 756e       kwargs["run
-0000bb90: 5f6d 616e 6167 6572 225d 203d 2072 756e  _manager"] = run
-0000bba0: 5f6d 616e 6167 6572 0a20 2020 2020 2020  _manager.       
-0000bbb0: 2020 2020 2063 6f6e 7465 7874 203d 2063       context = c
-0000bbc0: 6f70 795f 636f 6e74 6578 7428 290a 2020  opy_context().  
-0000bbd0: 2020 2020 2020 2020 2020 636f 6e74 6578            contex
-0000bbe0: 742e 7275 6e28 7661 725f 6368 696c 645f  t.run(var_child_
-0000bbf0: 7275 6e6e 6162 6c65 5f63 6f6e 6669 672e  runnable_config.
-0000bc00: 7365 742c 2063 6869 6c64 5f63 6f6e 6669  set, child_confi
-0000bc10: 6729 0a20 2020 2020 2020 2020 2020 2069  g).            i
-0000bc20: 7465 7261 746f 7220 3d20 636f 6e74 6578  terator = contex
-0000bc30: 742e 7275 6e28 7472 616e 7366 6f72 6d65  t.run(transforme
-0000bc40: 722c 2069 6e70 7574 5f66 6f72 5f74 7261  r, input_for_tra
-0000bc50: 6e73 666f 726d 2c20 2a2a 6b77 6172 6773  nsform, **kwargs
-0000bc60: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-0000bc70: 655b 6172 672d 7479 7065 5d0a 2020 2020  e[arg-type].    
-0000bc80: 2020 2020 2020 2020 6966 2073 7472 6561          if strea
-0000bc90: 6d5f 6c6f 6720 3a3d 206e 6578 7428 0a20  m_log := next(. 
-0000bca0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0000bcb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bcc0: 2020 2020 2068 0a20 2020 2020 2020 2020       h.         
-0000bcd0: 2020 2020 2020 2020 2020 2066 6f72 2068             for h
-0000bce0: 2069 6e20 7275 6e5f 6d61 6e61 6765 722e   in run_manager.
-0000bcf0: 6861 6e64 6c65 7273 0a20 2020 2020 2020  handlers.       
-0000bd00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000bd10: 6973 696e 7374 616e 6365 2868 2c20 4c6f  isinstance(h, Lo
-0000bd20: 6753 7472 6561 6d43 616c 6c62 6163 6b48  gStreamCallbackH
-0000bd30: 616e 646c 6572 290a 2020 2020 2020 2020  andler).        
-0000bd40: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0000bd50: 2020 2020 2020 2020 2020 204e 6f6e 652c             None,
-0000bd60: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-0000bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd80: 2320 706f 7075 6c61 7465 7320 7374 7265  # populates stre
-0000bd90: 616d 6564 5f6f 7574 7075 7420 696e 2061  amed_output in a
-0000bda0: 7374 7265 616d 5f6c 6f67 2829 206f 7574  stream_log() out
-0000bdb0: 7075 7420 6966 206e 6565 6465 640a 2020  put if needed.  
-0000bdc0: 2020 2020 2020 2020 2020 2020 2020 6974                it
-0000bdd0: 6572 6174 6f72 203d 2073 7472 6561 6d5f  erator = stream_
-0000bde0: 6c6f 672e 7461 705f 6f75 7470 7574 5f61  log.tap_output_a
-0000bdf0: 6974 6572 2872 756e 5f6d 616e 6167 6572  iter(run_manager
-0000be00: 2e72 756e 5f69 642c 2069 7465 7261 746f  .run_id, iterato
-0000be10: 7229 0a20 2020 2020 2020 2020 2020 2074  r).            t
-0000be20: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000be30: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
-0000be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be50: 2020 2020 6966 2061 6363 6570 7473 5f63      if accepts_c
-0000be60: 6f6e 7465 7874 2861 7379 6e63 696f 2e63  ontext(asyncio.c
-0000be70: 7265 6174 655f 7461 736b 293a 0a20 2020  reate_task):.   
-0000be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be90: 2020 2020 2063 6875 6e6b 3a20 4f75 7470       chunk: Outp
-0000bea0: 7574 203d 2061 7761 6974 2061 7379 6e63  ut = await async
-0000beb0: 696f 2e63 7265 6174 655f 7461 736b 2820  io.create_task( 
-0000bec0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-0000bed0: 6361 6c6c 2d61 7267 5d0a 2020 2020 2020  call-arg].      
-0000bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bef0: 2020 2020 2020 7079 5f61 6e65 7874 2869        py_anext(i
-0000bf00: 7465 7261 746f 7229 2c20 2023 2074 7970  terator),  # typ
-0000bf10: 653a 2069 676e 6f72 655b 6172 672d 7479  e: ignore[arg-ty
-0000bf20: 7065 5d0a 2020 2020 2020 2020 2020 2020  pe].            
-0000bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf40: 636f 6e74 6578 743d 636f 6e74 6578 742c  context=context,
-0000bf50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bf60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000bf70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000bf80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000bf90: 2020 2020 2020 2020 2020 2020 2063 6875               chu
-0000bfa0: 6e6b 203d 2063 6173 7428 4f75 7470 7574  nk = cast(Output
-0000bfb0: 2c20 6177 6169 7420 7079 5f61 6e65 7874  , await py_anext
-0000bfc0: 2869 7465 7261 746f 7229 290a 2020 2020  (iterator)).    
-0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfe0: 7969 656c 6420 6368 756e 6b0a 2020 2020  yield chunk.    
-0000bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c000: 6966 2066 696e 616c 5f6f 7574 7075 745f  if final_output_
-0000c010: 7375 7070 6f72 7465 643a 0a20 2020 2020  supported:.     
-0000c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c030: 2020 2069 6620 6669 6e61 6c5f 6f75 7470     if final_outp
-0000c040: 7574 2069 7320 4e6f 6e65 3a0a 2020 2020  ut is None:.    
-0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2020 2020 2020 2020 6669 6e61 6c5f 6f75          final_ou
-0000c070: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
-0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c090: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0d0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0000c0e0: 6c5f 6f75 7470 7574 203d 2066 696e 616c  l_output = final
-0000c0f0: 5f6f 7574 7075 7420 2b20 6368 756e 6b20  _output + chunk 
-0000c100: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0000c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c120: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000c130: 7074 2054 7970 6545 7272 6f72 3a0a 2020  pt TypeError:.  
-0000c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c150: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000c160: 6e61 6c5f 6f75 7470 7574 203d 204e 6f6e  nal_output = Non
-0000c170: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c190: 2020 6669 6e61 6c5f 6f75 7470 7574 5f73    final_output_s
-0000c1a0: 7570 706f 7274 6564 203d 2046 616c 7365  upported = False
-0000c1b0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000c1c0: 6570 7420 5374 6f70 4173 796e 6349 7465  ept StopAsyncIte
-0000c1d0: 7261 7469 6f6e 3a0a 2020 2020 2020 2020  ration:.        
-0000c1e0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0000c1f0: 2020 2020 2020 2020 2061 7379 6e63 2066           async f
-0000c200: 6f72 2069 6368 756e 6b20 696e 2069 6e70  or ichunk in inp
-0000c210: 7574 5f66 6f72 5f74 7261 6369 6e67 3a0a  ut_for_tracing:.
-0000c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c230: 6966 2066 696e 616c 5f69 6e70 7574 5f73  if final_input_s
-0000c240: 7570 706f 7274 6564 3a0a 2020 2020 2020  upported:.      
-0000c250: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000c260: 2066 696e 616c 5f69 6e70 7574 2069 7320   final_input is 
-0000c270: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000c280: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000c290: 6e61 6c5f 696e 7075 7420 3d20 6963 6875  nal_input = ichu
-0000c2a0: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
-0000c2b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2f0: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
-0000c300: 7420 3d20 6669 6e61 6c5f 696e 7075 7420  t = final_input 
-0000c310: 2b20 6963 6875 6e6b 2020 2320 7479 7065  + ichunk  # type
-0000c320: 3a20 6967 6e6f 7265 5b6f 7065 7261 746f  : ignore[operato
-0000c330: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
-0000c340: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000c350: 7420 5479 7065 4572 726f 723a 0a20 2020  t TypeError:.   
-0000c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c370: 2020 2020 2020 2020 2066 696e 616c 5f69           final_i
-0000c380: 6e70 7574 203d 204e 6f6e 650a 2020 2020  nput = None.    
-0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3a0: 2020 2020 2020 2020 6669 6e61 6c5f 696e          final_in
-0000c3b0: 7075 745f 7375 7070 6f72 7465 6420 3d20  put_supported = 
-0000c3c0: 4661 6c73 650a 2020 2020 2020 2020 6578  False.        ex
-0000c3d0: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
-0000c3e0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-0000c3f0: 2020 2020 2061 7761 6974 2072 756e 5f6d       await run_m
-0000c400: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-0000c410: 6572 726f 7228 652c 2069 6e70 7574 733d  error(e, inputs=
-0000c420: 6669 6e61 6c5f 696e 7075 7429 0a20 2020  final_input).   
-0000c430: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
-0000c440: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000c450: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-0000c460: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-0000c470: 6169 6e5f 656e 6428 6669 6e61 6c5f 6f75  ain_end(final_ou
-0000c480: 7470 7574 2c20 696e 7075 7473 3d66 696e  tput, inputs=fin
-0000c490: 616c 5f69 6e70 7574 290a 0a0a 636c 6173  al_input)...clas
-0000c4a0: 7320 5275 6e6e 6162 6c65 5365 7269 616c  s RunnableSerial
-0000c4b0: 697a 6162 6c65 2853 6572 6961 6c69 7a61  izable(Serializa
-0000c4c0: 626c 652c 2052 756e 6e61 626c 655b 496e  ble, Runnable[In
-0000c4d0: 7075 742c 204f 7574 7075 745d 293a 0a20  put, Output]):. 
-0000c4e0: 2020 2022 2222 4120 5275 6e6e 6162 6c65     """A Runnable
-0000c4f0: 2074 6861 7420 6361 6e20 6265 2073 6572   that can be ser
-0000c500: 6961 6c69 7a65 6420 746f 204a 534f 4e2e  ialized to JSON.
-0000c510: 2222 220a 0a20 2020 206e 616d 653a 204f  """..    name: O
-0000c520: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-0000c530: 6f6e 650a 2020 2020 2222 2254 6865 206e  one.    """The n
-0000c540: 616d 6520 6f66 2074 6865 2072 756e 6e61  ame of the runna
-0000c550: 626c 652e 2055 7365 6420 666f 7220 6465  ble. Used for de
-0000c560: 6275 6767 696e 6720 616e 6420 7472 6163  bugging and trac
-0000c570: 696e 672e 2222 220a 0a20 2020 2064 6566  ing."""..    def
-0000c580: 2063 6f6e 6669 6775 7261 626c 655f 6669   configurable_fi
-0000c590: 656c 6473 280a 2020 2020 2020 2020 7365  elds(.        se
-0000c5a0: 6c66 2c20 2a2a 6b77 6172 6773 3a20 416e  lf, **kwargs: An
-0000c5b0: 7943 6f6e 6669 6775 7261 626c 6546 6965  yConfigurableFie
-0000c5c0: 6c64 0a20 2020 2029 202d 3e20 5275 6e6e  ld.    ) -> Runn
-0000c5d0: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
-0000c5e0: 5b49 6e70 7574 2c20 4f75 7470 7574 5d3a  [Input, Output]:
-0000c5f0: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-0000c600: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
-0000c610: 6e61 626c 6573 2e63 6f6e 6669 6775 7261  nables.configura
-0000c620: 626c 6520 696d 706f 7274 2052 756e 6e61  ble import Runna
-0000c630: 626c 6543 6f6e 6669 6775 7261 626c 6546  bleConfigurableF
-0000c640: 6965 6c64 730a 0a20 2020 2020 2020 2066  ields..        f
-0000c650: 6f72 206b 6579 2069 6e20 6b77 6172 6773  or key in kwargs
-0000c660: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000c670: 206b 6579 206e 6f74 2069 6e20 7365 6c66   key not in self
-0000c680: 2e5f 5f66 6965 6c64 735f 5f3a 0a20 2020  .__fields__:.   
-0000c690: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000c6a0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-0000c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6c0: 2020 2066 2243 6f6e 6669 6775 7261 7469     f"Configurati
-0000c6d0: 6f6e 206b 6579 207b 6b65 797d 206e 6f74  on key {key} not
-0000c6e0: 2066 6f75 6e64 2069 6e20 7b73 656c 667d   found in {self}
-0000c6f0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0000c700: 2020 2020 2020 2020 2261 7661 696c 6162          "availab
-0000c710: 6c65 206b 6579 7320 6172 6520 7b73 656c  le keys are {sel
-0000c720: 662e 5f5f 6669 656c 6473 5f5f 2e6b 6579  f.__fields__.key
-0000c730: 7328 297d 220a 2020 2020 2020 2020 2020  s()}".          
-0000c740: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000c750: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
-0000c760: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
-0000c770: 6473 2864 6566 6175 6c74 3d73 656c 662c  ds(default=self,
-0000c780: 2066 6965 6c64 733d 6b77 6172 6773 290a   fields=kwargs).
-0000c790: 0a20 2020 2064 6566 2063 6f6e 6669 6775  .    def configu
-0000c7a0: 7261 626c 655f 616c 7465 726e 6174 6976  rable_alternativ
-0000c7b0: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-0000c7c0: 2c0a 2020 2020 2020 2020 7768 6963 683a  ,.        which:
-0000c7d0: 2043 6f6e 6669 6775 7261 626c 6546 6965   ConfigurableFie
-0000c7e0: 6c64 2c0a 2020 2020 2020 2020 2a2c 0a20  ld,.        *,. 
-0000c7f0: 2020 2020 2020 2064 6566 6175 6c74 5f6b         default_k
-0000c800: 6579 3a20 7374 7220 3d20 2264 6566 6175  ey: str = "defau
-0000c810: 6c74 222c 0a20 2020 2020 2020 2070 7265  lt",.        pre
-0000c820: 6669 785f 6b65 7973 3a20 626f 6f6c 203d  fix_keys: bool =
-0000c830: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-0000c840: 2a2a 6b77 6172 6773 3a20 556e 696f 6e5b  **kwargs: Union[
-0000c850: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-0000c860: 4f75 7470 7574 5d2c 2043 616c 6c61 626c  Output], Callabl
-0000c870: 655b 5b5d 2c20 5275 6e6e 6162 6c65 5b49  e[[], Runnable[I
-0000c880: 6e70 7574 2c20 4f75 7470 7574 5d5d 5d2c  nput, Output]]],
-0000c890: 0a20 2020 2029 202d 3e20 5275 6e6e 6162  .    ) -> Runnab
-0000c8a0: 6c65 5365 7269 616c 697a 6162 6c65 5b49  leSerializable[I
-0000c8b0: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
-0000c8c0: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
-0000c8d0: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
-0000c8e0: 626c 6573 2e63 6f6e 6669 6775 7261 626c  bles.configurabl
-0000c8f0: 6520 696d 706f 7274 2028 0a20 2020 2020  e import (.     
-0000c900: 2020 2020 2020 2052 756e 6e61 626c 6543         RunnableC
-0000c910: 6f6e 6669 6775 7261 626c 6541 6c74 6572  onfigurableAlter
-0000c920: 6e61 7469 7665 732c 0a20 2020 2020 2020  natives,.       
-0000c930: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-0000c940: 726e 2052 756e 6e61 626c 6543 6f6e 6669  rn RunnableConfi
-0000c950: 6775 7261 626c 6541 6c74 6572 6e61 7469  gurableAlternati
-0000c960: 7665 7328 0a20 2020 2020 2020 2020 2020  ves(.           
-0000c970: 2077 6869 6368 3d77 6869 6368 2c0a 2020   which=which,.  
-0000c980: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
-0000c990: 743d 7365 6c66 2c0a 2020 2020 2020 2020  t=self,.        
-0000c9a0: 2020 2020 616c 7465 726e 6174 6976 6573      alternatives
-0000c9b0: 3d6b 7761 7267 732c 0a20 2020 2020 2020  =kwargs,.       
-0000c9c0: 2020 2020 2064 6566 6175 6c74 5f6b 6579       default_key
-0000c9d0: 3d64 6566 6175 6c74 5f6b 6579 2c0a 2020  =default_key,.  
-0000c9e0: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
-0000c9f0: 5f6b 6579 733d 7072 6566 6978 5f6b 6579  _keys=prefix_key
-0000ca00: 732c 0a20 2020 2020 2020 2029 0a0a 0a64  s,.        )...d
-0000ca10: 6566 205f 7365 715f 696e 7075 745f 7363  ef _seq_input_sc
-0000ca20: 6865 6d61 280a 2020 2020 7374 6570 733a  hema(.    steps:
-0000ca30: 204c 6973 745b 5275 6e6e 6162 6c65 5b41   List[Runnable[A
-0000ca40: 6e79 2c20 416e 795d 5d2c 2063 6f6e 6669  ny, Any]], confi
-0000ca50: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-0000ca60: 6162 6c65 436f 6e66 6967 5d0a 2920 2d3e  ableConfig].) ->
-0000ca70: 2054 7970 655b 4261 7365 4d6f 6465 6c5d   Type[BaseModel]
-0000ca80: 3a0a 2020 2020 6672 6f6d 206c 616e 6763  :.    from langc
-0000ca90: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
-0000caa0: 6c65 732e 7061 7373 7468 726f 7567 6820  les.passthrough 
-0000cab0: 696d 706f 7274 2052 756e 6e61 626c 6541  import RunnableA
-0000cac0: 7373 6967 6e2c 2052 756e 6e61 626c 6550  ssign, RunnableP
-0000cad0: 6963 6b0a 0a20 2020 2066 6972 7374 203d  ick..    first =
-0000cae0: 2073 7465 7073 5b30 5d0a 2020 2020 6966   steps[0].    if
-0000caf0: 206c 656e 2873 7465 7073 2920 3d3d 2031   len(steps) == 1
-0000cb00: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000cb10: 2066 6972 7374 2e67 6574 5f69 6e70 7574   first.get_input
-0000cb20: 5f73 6368 656d 6128 636f 6e66 6967 290a  _schema(config).
-0000cb30: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000cb40: 6e63 6528 6669 7273 742c 2052 756e 6e61  nce(first, Runna
-0000cb50: 626c 6541 7373 6967 6e29 3a0a 2020 2020  bleAssign):.    
-0000cb60: 2020 2020 6e65 7874 5f69 6e70 7574 5f73      next_input_s
-0000cb70: 6368 656d 6120 3d20 5f73 6571 5f69 6e70  chema = _seq_inp
-0000cb80: 7574 5f73 6368 656d 6128 7374 6570 735b  ut_schema(steps[
-0000cb90: 313a 5d2c 2063 6f6e 6669 6729 0a20 2020  1:], config).   
-0000cba0: 2020 2020 2069 6620 6e6f 7420 6e65 7874       if not next
-0000cbb0: 5f69 6e70 7574 5f73 6368 656d 612e 5f5f  _input_schema.__
-0000cbc0: 6375 7374 6f6d 5f72 6f6f 745f 7479 7065  custom_root_type
-0000cbd0: 5f5f 3a0a 2020 2020 2020 2020 2020 2020  __:.            
-0000cbe0: 2320 6974 2773 2061 2064 6963 7420 6173  # it's a dict as
-0000cbf0: 2065 7870 6563 7465 640a 2020 2020 2020   expected.      
-0000cc00: 2020 2020 2020 7265 7475 726e 2063 7265        return cre
-0000cc10: 6174 655f 6d6f 6465 6c28 2020 2320 7479  ate_model(  # ty
-0000cc20: 7065 3a20 6967 6e6f 7265 5b63 616c 6c2d  pe: ignore[call-
-0000cc30: 6f76 6572 6c6f 6164 5d0a 2020 2020 2020  overload].      
-0000cc40: 2020 2020 2020 2020 2020 2252 756e 6e61            "Runna
-0000cc50: 626c 6553 6571 7565 6e63 6549 6e70 7574  bleSequenceInput
-0000cc60: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000cc70: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
-0000cc80: 2020 2020 2020 2020 2020 206b 3a20 2876             k: (v
-0000cc90: 2e61 6e6e 6f74 6174 696f 6e2c 2076 2e64  .annotation, v.d
-0000cca0: 6566 6175 6c74 290a 2020 2020 2020 2020  efault).        
-0000ccb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ccc0: 6b2c 2076 2069 6e20 6e65 7874 5f69 6e70  k, v in next_inp
-0000ccd0: 7574 5f73 6368 656d 612e 5f5f 6669 656c  ut_schema.__fiel
-0000cce0: 6473 5f5f 2e69 7465 6d73 2829 0a20 2020  ds__.items().   
-0000ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd00: 2069 6620 6b20 6e6f 7420 696e 2066 6972   if k not in fir
-0000cd10: 7374 2e6d 6170 7065 722e 7374 6570 730a  st.mapper.steps.
-0000cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd30: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0000cd40: 2020 205f 5f63 6f6e 6669 675f 5f3d 5f53     __config__=_S
-0000cd50: 6368 656d 6143 6f6e 6669 672c 0a20 2020  chemaConfig,.   
-0000cd60: 2020 2020 2020 2020 2029 0a20 2020 2065           ).    e
-0000cd70: 6c69 6620 6973 696e 7374 616e 6365 2866  lif isinstance(f
-0000cd80: 6972 7374 2c20 5275 6e6e 6162 6c65 5069  irst, RunnablePi
-0000cd90: 636b 293a 0a20 2020 2020 2020 2072 6574  ck):.        ret
-0000cda0: 7572 6e20 5f73 6571 5f69 6e70 7574 5f73  urn _seq_input_s
-0000cdb0: 6368 656d 6128 7374 6570 735b 313a 5d2c  chema(steps[1:],
-0000cdc0: 2063 6f6e 6669 6729 0a0a 2020 2020 7265   config)..    re
-0000cdd0: 7475 726e 2066 6972 7374 2e67 6574 5f69  turn first.get_i
-0000cde0: 6e70 7574 5f73 6368 656d 6128 636f 6e66  nput_schema(conf
-0000cdf0: 6967 290a 0a0a 6465 6620 5f73 6571 5f6f  ig)...def _seq_o
-0000ce00: 7574 7075 745f 7363 6865 6d61 280a 2020  utput_schema(.  
-0000ce10: 2020 7374 6570 733a 204c 6973 745b 5275    steps: List[Ru
-0000ce20: 6e6e 6162 6c65 5b41 6e79 2c20 416e 795d  nnable[Any, Any]
-0000ce30: 5d2c 2063 6f6e 6669 673a 204f 7074 696f  ], config: Optio
-0000ce40: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0000ce50: 6967 5d0a 2920 2d3e 2054 7970 655b 4261  ig].) -> Type[Ba
-0000ce60: 7365 4d6f 6465 6c5d 3a0a 2020 2020 6672  seModel]:.    fr
-0000ce70: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-0000ce80: 652e 7275 6e6e 6162 6c65 732e 7061 7373  e.runnables.pass
-0000ce90: 7468 726f 7567 6820 696d 706f 7274 2052  through import R
-0000cea0: 756e 6e61 626c 6541 7373 6967 6e2c 2052  unnableAssign, R
-0000ceb0: 756e 6e61 626c 6550 6963 6b0a 0a20 2020  unnablePick..   
-0000cec0: 206c 6173 7420 3d20 7374 6570 735b 2d31   last = steps[-1
-0000ced0: 5d0a 2020 2020 6966 206c 656e 2873 7465  ].    if len(ste
-0000cee0: 7073 2920 3d3d 2031 3a0a 2020 2020 2020  ps) == 1:.      
-0000cef0: 2020 7265 7475 726e 206c 6173 742e 6765    return last.ge
-0000cf00: 745f 696e 7075 745f 7363 6865 6d61 2863  t_input_schema(c
-0000cf10: 6f6e 6669 6729 0a20 2020 2065 6c69 6620  onfig).    elif 
-0000cf20: 6973 696e 7374 616e 6365 286c 6173 742c  isinstance(last,
-0000cf30: 2052 756e 6e61 626c 6541 7373 6967 6e29   RunnableAssign)
-0000cf40: 3a0a 2020 2020 2020 2020 6d61 7070 6572  :.        mapper
-0000cf50: 5f6f 7574 7075 745f 7363 6865 6d61 203d  _output_schema =
-0000cf60: 206c 6173 742e 6d61 7070 6572 2e67 6574   last.mapper.get
-0000cf70: 5f6f 7574 7075 745f 7363 6865 6d61 2863  _output_schema(c
-0000cf80: 6f6e 6669 6729 0a20 2020 2020 2020 2070  onfig).        p
-0000cf90: 7265 765f 6f75 7470 7574 5f73 6368 656d  rev_output_schem
-0000cfa0: 6120 3d20 5f73 6571 5f6f 7574 7075 745f  a = _seq_output_
-0000cfb0: 7363 6865 6d61 2873 7465 7073 5b3a 2d31  schema(steps[:-1
-0000cfc0: 5d2c 2063 6f6e 6669 6729 0a20 2020 2020  ], config).     
-0000cfd0: 2020 2069 6620 6e6f 7420 7072 6576 5f6f     if not prev_o
-0000cfe0: 7574 7075 745f 7363 6865 6d61 2e5f 5f63  utput_schema.__c
-0000cff0: 7573 746f 6d5f 726f 6f74 5f74 7970 655f  ustom_root_type_
-0000d000: 5f3a 0a20 2020 2020 2020 2020 2020 2023  _:.            #
-0000d010: 2069 7427 7320 6120 6469 6374 2061 7320   it's a dict as 
-0000d020: 6578 7065 6374 6564 0a20 2020 2020 2020  expected.       
-0000d030: 2020 2020 2072 6574 7572 6e20 6372 6561       return crea
-0000d040: 7465 5f6d 6f64 656c 2820 2023 2074 7970  te_model(  # typ
-0000d050: 653a 2069 676e 6f72 655b 6361 6c6c 2d6f  e: ignore[call-o
-0000d060: 7665 726c 6f61 645d 0a20 2020 2020 2020  verload].       
-0000d070: 2020 2020 2020 2020 2022 5275 6e6e 6162           "Runnab
-0000d080: 6c65 5365 7175 656e 6365 4f75 7470 7574  leSequenceOutput
-0000d090: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000d0a0: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
-0000d0b0: 2020 2020 2020 2020 2020 202a 2a7b 0a20             **{. 
-0000d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0d0: 2020 2020 2020 206b 3a20 2876 2e61 6e6e         k: (v.ann
-0000d0e0: 6f74 6174 696f 6e2c 2076 2e64 6566 6175  otation, v.defau
-0000d0f0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-0000d100: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000d110: 6b2c 2076 2069 6e20 7072 6576 5f6f 7574  k, v in prev_out
-0000d120: 7075 745f 7363 6865 6d61 2e5f 5f66 6965  put_schema.__fie
-0000d130: 6c64 735f 5f2e 6974 656d 7328 290a 2020  lds__.items().  
-0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d150: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000d160: 2020 2020 2020 2020 202a 2a7b 0a20 2020           **{.   
-0000d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d180: 2020 2020 206b 3a20 2876 2e61 6e6e 6f74       k: (v.annot
-0000d190: 6174 696f 6e2c 2076 2e64 6566 6175 6c74  ation, v.default
-0000d1a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000d1b0: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-0000d1c0: 2076 2069 6e20 6d61 7070 6572 5f6f 7574   v in mapper_out
-0000d1d0: 7075 745f 7363 6865 6d61 2e5f 5f66 6965  put_schema.__fie
-0000d1e0: 6c64 735f 5f2e 6974 656d 7328 290a 2020  lds__.items().  
-0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d200: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000d210: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0000d220: 2020 2020 2020 2020 5f5f 636f 6e66 6967          __config
-0000d230: 5f5f 3d5f 5363 6865 6d61 436f 6e66 6967  __=_SchemaConfig
-0000d240: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000d250: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000d260: 6e63 6528 6c61 7374 2c20 5275 6e6e 6162  nce(last, Runnab
-0000d270: 6c65 5069 636b 293a 0a20 2020 2020 2020  lePick):.       
-0000d280: 2070 7265 765f 6f75 7470 7574 5f73 6368   prev_output_sch
-0000d290: 656d 6120 3d20 5f73 6571 5f6f 7574 7075  ema = _seq_outpu
-0000d2a0: 745f 7363 6865 6d61 2873 7465 7073 5b3a  t_schema(steps[:
-0000d2b0: 2d31 5d2c 2063 6f6e 6669 6729 0a20 2020  -1], config).   
-0000d2c0: 2020 2020 2069 6620 6e6f 7420 7072 6576       if not prev
-0000d2d0: 5f6f 7574 7075 745f 7363 6865 6d61 2e5f  _output_schema._
-0000d2e0: 5f63 7573 746f 6d5f 726f 6f74 5f74 7970  _custom_root_typ
-0000d2f0: 655f 5f3a 0a20 2020 2020 2020 2020 2020  e__:.           
-0000d300: 2023 2069 7427 7320 6120 6469 6374 2061   # it's a dict a
-0000d310: 7320 6578 7065 6374 6564 0a20 2020 2020  s expected.     
-0000d320: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000d330: 616e 6365 286c 6173 742e 6b65 7973 2c20  ance(last.keys, 
-0000d340: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-0000d350: 2020 2020 2020 2072 6574 7572 6e20 6372         return cr
-0000d360: 6561 7465 5f6d 6f64 656c 2820 2023 2074  eate_model(  # t
-0000d370: 7970 653a 2069 676e 6f72 655b 6361 6c6c  ype: ignore[call
-0000d380: 2d6f 7665 726c 6f61 645d 0a20 2020 2020  -overload].     
-0000d390: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000d3a0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
-0000d3b0: 4f75 7470 7574 222c 0a20 2020 2020 2020  Output",.       
-0000d3c0: 2020 2020 2020 2020 2020 2020 202a 2a7b               **{
-0000d3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d3e0: 2020 2020 2020 2020 206b 3a20 2876 2e61           k: (v.a
-0000d3f0: 6e6e 6f74 6174 696f 6e2c 2076 2e64 6566  nnotation, v.def
-0000d400: 6175 6c74 290a 2020 2020 2020 2020 2020  ault).          
-0000d410: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000d420: 7220 6b2c 2076 2069 6e20 7072 6576 5f6f  r k, v in prev_o
-0000d430: 7574 7075 745f 7363 6865 6d61 2e5f 5f66  utput_schema.__f
-0000d440: 6965 6c64 735f 5f2e 6974 656d 7328 290a  ields__.items().
+000094e0: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+000094f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009500: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00009510: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009530: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009540: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009550: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009560: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009570: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009580: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009590: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+000095a0: 2020 2020 2020 7c20 6f6e 5f72 6574 7269        | on_retri
+000095b0: 6576 6572 5f73 7461 7274 2020 207c 205b  ever_start   | [
+000095c0: 7265 7472 6965 7665 7220 6e61 6d65 5d20  retriever name] 
+000095d0: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+000095e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095f0: 2020 7c20 7b22 7175 6572 7922 3a20 2268    | {"query": "h
+00009600: 656c 6c6f 227d 2020 2020 2020 2020 2020  ello"}          
+00009610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009620: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00009630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009650: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00009660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009670: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00009680: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009690: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000096a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000096b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000096c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000096d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000096e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000096f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009700: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00009710: 2020 2020 2020 7c20 6f6e 5f72 6574 7269        | on_retri
+00009720: 6576 6572 5f65 6e64 2020 2020 207c 205b  ever_end     | [
+00009730: 7265 7472 6965 7665 7220 6e61 6d65 5d20  retriever name] 
+00009740: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009760: 2020 7c20 7b22 7175 6572 7922 3a20 2268    | {"query": "h
+00009770: 656c 6c6f 227d 2020 2020 2020 2020 2020  ello"}          
+00009780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009790: 2020 7c20 5b44 6f63 756d 656e 7428 2e2e    | [Document(..
+000097a0: 2e29 2c20 2e2e 5d20 2020 2020 2020 2020  .), ..]         
+000097b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097c0: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+000097d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000097e0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+000097f0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009810: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009830: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009840: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009850: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009860: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009870: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+00009880: 2020 2020 2020 7c20 6f6e 5f70 726f 6d70        | on_promp
+00009890: 745f 7374 6172 7420 2020 2020 207c 205b  t_start      | [
+000098a0: 7465 6d70 6c61 7465 5f6e 616d 655d 2020  template_name]  
+000098b0: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+000098c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098d0: 2020 7c20 7b22 7175 6573 7469 6f6e 223a    | {"question":
+000098e0: 2022 6865 6c6c 6f22 7d20 2020 2020 2020   "hello"}       
+000098f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009900: 2020 7c20 2020 2020 2020 2020 2020 2020    |             
+00009910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009930: 2020 2020 7c0a 2020 2020 2020 2020 2b2d      |.        +-
+00009940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009950: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00009960: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009980: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009990: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000099a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000099b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+000099c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000099d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000099e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 2020  ------------+.  
+000099f0: 2020 2020 2020 7c20 6f6e 5f70 726f 6d70        | on_promp
+00009a00: 745f 656e 6420 2020 2020 2020 207c 205b  t_end        | [
+00009a10: 7465 6d70 6c61 7465 5f6e 616d 655d 2020  template_name]  
+00009a20: 7c20 2020 2020 2020 2020 2020 2020 2020  |               
+00009a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a40: 2020 7c20 7b22 7175 6573 7469 6f6e 223a    | {"question":
+00009a50: 2022 6865 6c6c 6f22 7d20 2020 2020 2020   "hello"}       
+00009a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a70: 2020 7c20 4368 6174 5072 6f6d 7074 5661    | ChatPromptVa
+00009a80: 6c75 6528 6d65 7373 6167 6573 3a20 5b53  lue(messages: [S
+00009a90: 7973 7465 6d4d 6573 7361 6765 2c20 2e2e  ystemMessage, ..
+00009aa0: 2e5d 2920 7c0a 2020 2020 2020 2020 2b2d  .]) |.        +-
+00009ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009ac0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
+00009ad0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009ae0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009b10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009b20: 2d2d 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d  ----------+-----
+00009b30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009b40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009b50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2b0a 0a20  ------------+.. 
+00009b60: 2020 2020 2020 2048 6572 6520 6172 6520         Here are 
+00009b70: 6465 636c 6172 6174 696f 6e73 2061 7373  declarations ass
+00009b80: 6f63 6961 7465 6420 7769 7468 2074 6865  ociated with the
+00009b90: 2065 7665 6e74 7320 7368 6f77 6e20 6162   events shown ab
+00009ba0: 6f76 653a 0a0a 2020 2020 2020 2020 6066  ove:..        `f
+00009bb0: 6f72 6d61 745f 646f 6373 603a 0a0a 2020  ormat_docs`:..  
+00009bc0: 2020 2020 2020 2e2e 2063 6f64 652d 626c        .. code-bl
+00009bd0: 6f63 6b3a 3a20 7079 7468 6f6e 0a0a 2020  ock:: python..  
+00009be0: 2020 2020 2020 2020 2020 6465 6620 666f            def fo
+00009bf0: 726d 6174 5f64 6f63 7328 646f 6373 3a20  rmat_docs(docs: 
+00009c00: 4c69 7374 5b44 6f63 756d 656e 745d 2920  List[Document]) 
+00009c10: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+00009c20: 2020 2020 2020 2020 2727 2746 6f72 6d61          '''Forma
+00009c30: 7420 7468 6520 646f 6373 2e27 2727 0a20  t the docs.'''. 
+00009c40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00009c50: 6574 7572 6e20 222c 2022 2e6a 6f69 6e28  eturn ", ".join(
+00009c60: 5b64 6f63 2e70 6167 655f 636f 6e74 656e  [doc.page_conten
+00009c70: 7420 666f 7220 646f 6320 696e 2064 6f63  t for doc in doc
+00009c80: 735d 290a 0a20 2020 2020 2020 2020 2020  s])..           
+00009c90: 2066 6f72 6d61 745f 646f 6373 203d 2052   format_docs = R
+00009ca0: 756e 6e61 626c 654c 616d 6264 6128 666f  unnableLambda(fo
+00009cb0: 726d 6174 5f64 6f63 7329 0a0a 2020 2020  rmat_docs)..    
+00009cc0: 2020 2020 6073 6f6d 655f 746f 6f6c 603a      `some_tool`:
+00009cd0: 0a0a 2020 2020 2020 2020 2e2e 2063 6f64  ..        .. cod
+00009ce0: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
+00009cf0: 0a0a 2020 2020 2020 2020 2020 2020 4074  ..            @t
+00009d00: 6f6f 6c0a 2020 2020 2020 2020 2020 2020  ool.            
+00009d10: 6465 6620 736f 6d65 5f74 6f6f 6c28 783a  def some_tool(x:
+00009d20: 2069 6e74 2c20 793a 2073 7472 2920 2d3e   int, y: str) ->
+00009d30: 2064 6963 743a 0a20 2020 2020 2020 2020   dict:.         
+00009d40: 2020 2020 2020 2027 2727 536f 6d65 5f74         '''Some_t
+00009d50: 6f6f 6c2e 2727 270a 2020 2020 2020 2020  ool.'''.        
+00009d60: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00009d70: 2278 223a 2078 2c20 2279 223a 2079 7d0a  "x": x, "y": y}.
+00009d80: 0a20 2020 2020 2020 2060 7072 6f6d 7074  .        `prompt
+00009d90: 603a 0a0a 2020 2020 2020 2020 2e2e 2063  `:..        .. c
+00009da0: 6f64 652d 626c 6f63 6b3a 3a20 7079 7468  ode-block:: pyth
+00009db0: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+00009dc0: 7465 6d70 6c61 7465 203d 2043 6861 7450  template = ChatP
+00009dd0: 726f 6d70 7454 656d 706c 6174 652e 6672  romptTemplate.fr
+00009de0: 6f6d 5f6d 6573 7361 6765 7328 0a20 2020  om_messages(.   
+00009df0: 2020 2020 2020 2020 2020 2020 205b 2822               [("
+00009e00: 7379 7374 656d 222c 2022 596f 7520 6172  system", "You ar
+00009e10: 6520 4361 7420 4167 656e 7420 3030 3722  e Cat Agent 007"
+00009e20: 292c 2028 2268 756d 616e 222c 2022 7b71  ), ("human", "{q
+00009e30: 7565 7374 696f 6e7d 2229 5d0a 2020 2020  uestion}")].    
+00009e40: 2020 2020 2020 2020 292e 7769 7468 5f63          ).with_c
+00009e50: 6f6e 6669 6728 7b22 7275 6e5f 6e61 6d65  onfig({"run_name
+00009e60: 223a 2022 6d79 5f74 656d 706c 6174 6522  ": "my_template"
+00009e70: 2c20 2274 6167 7322 3a20 5b22 6d79 5f74  , "tags": ["my_t
+00009e80: 656d 706c 6174 6522 5d7d 290a 0a0a 2020  emplate"]})...  
+00009e90: 2020 2020 2020 4578 616d 706c 653a 0a0a        Example:..
+00009ea0: 2020 2020 2020 2020 2e2e 2063 6f64 652d          .. code-
+00009eb0: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
+00009ec0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00009ed0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+00009ee0: 7275 6e6e 6162 6c65 7320 696d 706f 7274  runnables import
+00009ef0: 2052 756e 6e61 626c 654c 616d 6264 610a   RunnableLambda.
+00009f00: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
+00009f10: 6e63 2064 6566 2072 6576 6572 7365 2873  nc def reverse(s
+00009f20: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
+00009f30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00009f40: 6574 7572 6e20 735b 3a3a 2d31 5d0a 0a20  eturn s[::-1].. 
+00009f50: 2020 2020 2020 2020 2020 2063 6861 696e             chain
+00009f60: 203d 2052 756e 6e61 626c 654c 616d 6264   = RunnableLambd
+00009f70: 6128 6675 6e63 3d72 6576 6572 7365 290a  a(func=reverse).
+00009f80: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+00009f90: 6e74 7320 3d20 5b0a 2020 2020 2020 2020  nts = [.        
+00009fa0: 2020 2020 2020 2020 6576 656e 7420 6173          event as
+00009fb0: 796e 6320 666f 7220 6576 656e 7420 696e  ync for event in
+00009fc0: 2063 6861 696e 2e61 7374 7265 616d 5f65   chain.astream_e
+00009fd0: 7665 6e74 7328 2268 656c 6c6f 222c 2076  vents("hello", v
+00009fe0: 6572 7369 6f6e 3d22 7632 2229 0a20 2020  ersion="v2").   
+00009ff0: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+0000a000: 2020 2020 2020 2020 2320 7769 6c6c 2070          # will p
+0000a010: 726f 6475 6365 2074 6865 2066 6f6c 6c6f  roduce the follo
+0000a020: 7769 6e67 2065 7665 6e74 7320 2872 756e  wing events (run
+0000a030: 5f69 6420 6861 7320 6265 656e 206f 6d69  _id has been omi
+0000a040: 7474 6564 2066 6f72 2062 7265 7669 7479  tted for brevity
+0000a050: 293a 0a20 2020 2020 2020 2020 2020 205b  ):.            [
+0000a060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a070: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000a080: 2020 2020 2020 2022 6461 7461 223a 207b         "data": {
+0000a090: 2269 6e70 7574 223a 2022 6865 6c6c 6f22  "input": "hello"
+0000a0a0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000a0b0: 2020 2020 2020 2022 6576 656e 7422 3a20         "event": 
+0000a0c0: 226f 6e5f 6368 6169 6e5f 7374 6172 7422  "on_chain_start"
+0000a0d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a0e0: 2020 2020 2020 226d 6574 6164 6174 6122        "metadata"
+0000a0f0: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
+0000a100: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+0000a110: 3a20 2272 6576 6572 7365 222c 0a20 2020  : "reverse",.   
+0000a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a130: 2022 7461 6773 223a 205b 5d2c 0a20 2020   "tags": [],.   
+0000a140: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+0000a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a160: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000a170: 2020 2020 2020 2264 6174 6122 3a20 7b22        "data": {"
+0000a180: 6368 756e 6b22 3a20 226f 6c6c 6568 227d  chunk": "olleh"}
+0000a190: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a1a0: 2020 2020 2020 2265 7665 6e74 223a 2022        "event": "
+0000a1b0: 6f6e 5f63 6861 696e 5f73 7472 6561 6d22  on_chain_stream"
+0000a1c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a1d0: 2020 2020 2020 226d 6574 6164 6174 6122        "metadata"
+0000a1e0: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
+0000a1f0: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+0000a200: 3a20 2272 6576 6572 7365 222c 0a20 2020  : "reverse",.   
+0000a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a220: 2022 7461 6773 223a 205b 5d2c 0a20 2020   "tags": [],.   
+0000a230: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a250: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000a260: 2020 2020 2020 2264 6174 6122 3a20 7b22        "data": {"
+0000a270: 6f75 7470 7574 223a 2022 6f6c 6c65 6822  output": "olleh"
+0000a280: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000a290: 2020 2020 2020 2022 6576 656e 7422 3a20         "event": 
+0000a2a0: 226f 6e5f 6368 6169 6e5f 656e 6422 2c0a  "on_chain_end",.
+0000a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2c0: 2020 2020 226d 6574 6164 6174 6122 3a20      "metadata": 
+0000a2d0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
+0000a2e0: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+0000a2f0: 2272 6576 6572 7365 222c 0a20 2020 2020  "reverse",.     
+0000a300: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000a310: 7461 6773 223a 205b 5d2c 0a20 2020 2020  tags": [],.     
+0000a320: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+0000a330: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
+0000a340: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+0000a350: 2020 2020 2020 2069 6e70 7574 3a20 5468         input: Th
+0000a360: 6520 696e 7075 7420 746f 2074 6865 2072  e input to the r
+0000a370: 756e 6e61 626c 652e 0a20 2020 2020 2020  unnable..       
+0000a380: 2020 2020 2063 6f6e 6669 673a 2054 6865       config: The
+0000a390: 2063 6f6e 6669 6720 746f 2075 7365 2066   config to use f
+0000a3a0: 6f72 2074 6865 2072 756e 6e61 626c 652e  or the runnable.
+0000a3b0: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
+0000a3c0: 7369 6f6e 3a20 5468 6520 7665 7273 696f  sion: The versio
+0000a3d0: 6e20 6f66 2074 6865 2073 6368 656d 6120  n of the schema 
+0000a3e0: 746f 2075 7365 2065 6974 6865 7220 6076  to use either `v
+0000a3f0: 3260 206f 7220 6076 3160 2e0a 2020 2020  2` or `v1`..    
+0000a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a410: 2055 7365 7273 2073 686f 756c 6420 7573   Users should us
+0000a420: 6520 6076 3260 2e0a 2020 2020 2020 2020  e `v2`..        
+0000a430: 2020 2020 2020 2020 2020 2020 2060 7631               `v1
+0000a440: 6020 6973 2066 6f72 2062 6163 6b77 6172  ` is for backwar
+0000a450: 6473 2063 6f6d 7061 7469 6269 6c69 7479  ds compatibility
+0000a460: 2061 6e64 2077 696c 6c20 6265 2064 6570   and will be dep
+0000a470: 7265 6361 7465 640a 2020 2020 2020 2020  recated.        
+0000a480: 2020 2020 2020 2020 2020 2020 2069 6e20               in 
+0000a490: 302e 342e 302e 0a20 2020 2020 2020 2020  0.4.0..         
+0000a4a0: 2020 2020 2020 2020 2020 2020 4e6f 2064              No d
+0000a4b0: 6566 6175 6c74 2077 696c 6c20 6265 2061  efault will be a
+0000a4c0: 7373 6967 6e65 6420 756e 7469 6c20 7468  ssigned until th
+0000a4d0: 6520 4150 4920 6973 2073 7461 6269 6c69  e API is stabili
+0000a4e0: 7a65 642e 0a20 2020 2020 2020 2020 2020  zed..           
+0000a4f0: 2069 6e63 6c75 6465 5f6e 616d 6573 3a20   include_names: 
+0000a500: 4f6e 6c79 2069 6e63 6c75 6465 2065 7665  Only include eve
+0000a510: 6e74 7320 6672 6f6d 2072 756e 6e61 626c  nts from runnabl
+0000a520: 6573 2077 6974 6820 6d61 7463 6869 6e67  es with matching
+0000a530: 206e 616d 6573 2e0a 2020 2020 2020 2020   names..        
+0000a540: 2020 2020 696e 636c 7564 655f 7479 7065      include_type
+0000a550: 733a 204f 6e6c 7920 696e 636c 7564 6520  s: Only include 
+0000a560: 6576 656e 7473 2066 726f 6d20 7275 6e6e  events from runn
+0000a570: 6162 6c65 7320 7769 7468 206d 6174 6368  ables with match
+0000a580: 696e 6720 7479 7065 732e 0a20 2020 2020  ing types..     
+0000a590: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+0000a5a0: 6167 733a 204f 6e6c 7920 696e 636c 7564  ags: Only includ
+0000a5b0: 6520 6576 656e 7473 2066 726f 6d20 7275  e events from ru
+0000a5c0: 6e6e 6162 6c65 7320 7769 7468 206d 6174  nnables with mat
+0000a5d0: 6368 696e 6720 7461 6773 2e0a 2020 2020  ching tags..    
+0000a5e0: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+0000a5f0: 6e61 6d65 733a 2045 7863 6c75 6465 2065  names: Exclude e
+0000a600: 7665 6e74 7320 6672 6f6d 2072 756e 6e61  vents from runna
+0000a610: 626c 6573 2077 6974 6820 6d61 7463 6869  bles with matchi
+0000a620: 6e67 206e 616d 6573 2e0a 2020 2020 2020  ng names..      
+0000a630: 2020 2020 2020 6578 636c 7564 655f 7479        exclude_ty
+0000a640: 7065 733a 2045 7863 6c75 6465 2065 7665  pes: Exclude eve
+0000a650: 6e74 7320 6672 6f6d 2072 756e 6e61 626c  nts from runnabl
+0000a660: 6573 2077 6974 6820 6d61 7463 6869 6e67  es with matching
+0000a670: 2074 7970 6573 2e0a 2020 2020 2020 2020   types..        
+0000a680: 2020 2020 6578 636c 7564 655f 7461 6773      exclude_tags
+0000a690: 3a20 4578 636c 7564 6520 6576 656e 7473  : Exclude events
+0000a6a0: 2066 726f 6d20 7275 6e6e 6162 6c65 7320   from runnables 
+0000a6b0: 7769 7468 206d 6174 6368 696e 6720 7461  with matching ta
+0000a6c0: 6773 2e0a 2020 2020 2020 2020 2020 2020  gs..            
+0000a6d0: 6b77 6172 6773 3a20 4164 6469 7469 6f6e  kwargs: Addition
+0000a6e0: 616c 206b 6579 776f 7264 2061 7267 756d  al keyword argum
+0000a6f0: 656e 7473 2074 6f20 7061 7373 2074 6f20  ents to pass to 
+0000a700: 7468 6520 7275 6e6e 6162 6c65 2e0a 2020  the runnable..  
+0000a710: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+0000a720: 6573 6520 7769 6c6c 2062 6520 7061 7373  ese will be pass
+0000a730: 6564 2074 6f20 6173 7472 6561 6d5f 6c6f  ed to astream_lo
+0000a740: 6720 6173 2074 6869 7320 696d 706c 656d  g as this implem
+0000a750: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
+0000a760: 2020 2020 2020 2020 206f 6620 6173 7472           of astr
+0000a770: 6561 6d5f 6576 656e 7473 2069 7320 6275  eam_events is bu
+0000a780: 696c 7420 6f6e 2074 6f70 206f 6620 6173  ilt on top of as
+0000a790: 7472 6561 6d5f 6c6f 672e 0a0a 2020 2020  tream_log...    
+0000a7a0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0000a7b0: 2020 2020 2020 2020 2041 6e20 6173 796e           An asyn
+0000a7c0: 6320 7374 7265 616d 206f 6620 5374 7265  c stream of Stre
+0000a7d0: 616d 4576 656e 7473 2e0a 2020 2020 2020  amEvents..      
+0000a7e0: 2020 2222 2220 2023 206e 6f71 613a 2045    """  # noqa: E
+0000a7f0: 3530 310a 2020 2020 2020 2020 6672 6f6d  501.        from
+0000a800: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+0000a810: 7472 6163 6572 732e 6576 656e 745f 7374  tracers.event_st
+0000a820: 7265 616d 2069 6d70 6f72 7420 280a 2020  ream import (.  
+0000a830: 2020 2020 2020 2020 2020 5f61 7374 7265            _astre
+0000a840: 616d 5f65 7665 6e74 735f 696d 706c 656d  am_events_implem
+0000a850: 656e 7461 7469 6f6e 5f76 312c 0a20 2020  entation_v1,.   
+0000a860: 2020 2020 2020 2020 205f 6173 7472 6561           _astrea
+0000a870: 6d5f 6576 656e 7473 5f69 6d70 6c65 6d65  m_events_impleme
+0000a880: 6e74 6174 696f 6e5f 7632 2c0a 2020 2020  ntation_v2,.    
+0000a890: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+0000a8a0: 6620 7665 7273 696f 6e20 3d3d 2022 7632  f version == "v2
+0000a8b0: 223a 0a20 2020 2020 2020 2020 2020 2065  ":.            e
+0000a8c0: 7665 6e74 5f73 7472 6561 6d20 3d20 5f61  vent_stream = _a
+0000a8d0: 7374 7265 616d 5f65 7665 6e74 735f 696d  stream_events_im
+0000a8e0: 706c 656d 656e 7461 7469 6f6e 5f76 3228  plementation_v2(
+0000a8f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a900: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
+0000a910: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+0000a920: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000a930: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
+0000a940: 2020 2020 2020 2020 2020 2020 2069 6e63               inc
+0000a950: 6c75 6465 5f6e 616d 6573 3d69 6e63 6c75  lude_names=inclu
+0000a960: 6465 5f6e 616d 6573 2c0a 2020 2020 2020  de_names,.      
+0000a970: 2020 2020 2020 2020 2020 696e 636c 7564            includ
+0000a980: 655f 7479 7065 733d 696e 636c 7564 655f  e_types=include_
+0000a990: 7479 7065 732c 0a20 2020 2020 2020 2020  types,.         
+0000a9a0: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+0000a9b0: 6167 733d 696e 636c 7564 655f 7461 6773  ags=include_tags
+0000a9c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a9d0: 2020 6578 636c 7564 655f 6e61 6d65 733d    exclude_names=
+0000a9e0: 6578 636c 7564 655f 6e61 6d65 732c 0a20  exclude_names,. 
+0000a9f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000aa00: 7863 6c75 6465 5f74 7970 6573 3d65 7863  xclude_types=exc
+0000aa10: 6c75 6465 5f74 7970 6573 2c0a 2020 2020  lude_types,.    
+0000aa20: 2020 2020 2020 2020 2020 2020 6578 636c              excl
+0000aa30: 7564 655f 7461 6773 3d65 7863 6c75 6465  ude_tags=exclude
+0000aa40: 5f74 6167 732c 0a20 2020 2020 2020 2020  _tags,.         
+0000aa50: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0000aa60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000aa70: 2020 2020 2020 2065 6c69 6620 7665 7273         elif vers
+0000aa80: 696f 6e20 3d3d 2022 7631 223a 0a20 2020  ion == "v1":.   
+0000aa90: 2020 2020 2020 2020 2023 2046 6972 7374           # First
+0000aaa0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e2c   implementation,
+0000aab0: 2062 7569 6c74 206f 6e20 746f 7020 6f66   built on top of
+0000aac0: 2061 7374 7265 616d 5f6c 6f67 2041 5049   astream_log API
+0000aad0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000aae0: 6869 7320 696d 706c 656d 656e 7461 7469  his implementati
+0000aaf0: 6f6e 2077 696c 6c20 6265 2064 6570 7265  on will be depre
+0000ab00: 6361 7465 6420 6173 206f 6620 302e 322e  cated as of 0.2.
+0000ab10: 300a 2020 2020 2020 2020 2020 2020 6576  0.            ev
+0000ab20: 656e 745f 7374 7265 616d 203d 205f 6173  ent_stream = _as
+0000ab30: 7472 6561 6d5f 6576 656e 7473 5f69 6d70  tream_events_imp
+0000ab40: 6c65 6d65 6e74 6174 696f 6e5f 7631 280a  lementation_v1(.
+0000ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab60: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+0000ab70: 2020 2020 2020 696e 7075 742c 0a20 2020        input,.   
+0000ab80: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000ab90: 6669 673d 636f 6e66 6967 2c0a 2020 2020  fig=config,.    
+0000aba0: 2020 2020 2020 2020 2020 2020 696e 636c              incl
+0000abb0: 7564 655f 6e61 6d65 733d 696e 636c 7564  ude_names=includ
+0000abc0: 655f 6e61 6d65 732c 0a20 2020 2020 2020  e_names,.       
+0000abd0: 2020 2020 2020 2020 2069 6e63 6c75 6465           include
+0000abe0: 5f74 7970 6573 3d69 6e63 6c75 6465 5f74  _types=include_t
+0000abf0: 7970 6573 2c0a 2020 2020 2020 2020 2020  ypes,.          
+0000ac00: 2020 2020 2020 696e 636c 7564 655f 7461        include_ta
+0000ac10: 6773 3d69 6e63 6c75 6465 5f74 6167 732c  gs=include_tags,
+0000ac20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ac30: 2065 7863 6c75 6465 5f6e 616d 6573 3d65   exclude_names=e
+0000ac40: 7863 6c75 6465 5f6e 616d 6573 2c0a 2020  xclude_names,.  
+0000ac50: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000ac60: 636c 7564 655f 7479 7065 733d 6578 636c  clude_types=excl
+0000ac70: 7564 655f 7479 7065 732c 0a20 2020 2020  ude_types,.     
+0000ac80: 2020 2020 2020 2020 2020 2065 7863 6c75             exclu
+0000ac90: 6465 5f74 6167 733d 6578 636c 7564 655f  de_tags=exclude_
+0000aca0: 7461 6773 2c0a 2020 2020 2020 2020 2020  tags,.          
+0000acb0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+0000acc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000acd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000ace0: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
+0000acf0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
+0000ad00: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000ad10: 2020 2027 4f6e 6c79 2076 6572 7369 6f6e     'Only version
+0000ad20: 7320 2276 3122 2061 6e64 2022 7632 2220  s "v1" and "v2" 
+0000ad30: 6f66 2074 6865 2073 6368 656d 6120 6973  of the schema is
+0000ad40: 2063 7572 7265 6e74 6c79 2073 7570 706f   currently suppo
+0000ad50: 7274 6564 2e27 0a20 2020 2020 2020 2020  rted.'.         
+0000ad60: 2020 2029 0a0a 2020 2020 2020 2020 6173     )..        as
+0000ad70: 796e 6320 666f 7220 6576 656e 7420 696e  ync for event in
+0000ad80: 2065 7665 6e74 5f73 7472 6561 6d3a 0a20   event_stream:. 
+0000ad90: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+0000ada0: 2065 7665 6e74 0a0a 2020 2020 6465 6620   event..    def 
+0000adb0: 7472 616e 7366 6f72 6d28 0a20 2020 2020  transform(.     
+0000adc0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0000add0: 2069 6e70 7574 3a20 4974 6572 6174 6f72   input: Iterator
+0000ade0: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+0000adf0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+0000ae00: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+0000ae10: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000ae20: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+0000ae30: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+0000ae40: 202d 3e20 4974 6572 6174 6f72 5b4f 7574   -> Iterator[Out
+0000ae50: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
+0000ae60: 220a 2020 2020 2020 2020 4465 6661 756c  ".        Defaul
+0000ae70: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
+0000ae80: 206f 6620 7472 616e 7366 6f72 6d2c 2077   of transform, w
+0000ae90: 6869 6368 2062 7566 6665 7273 2069 6e70  hich buffers inp
+0000aea0: 7574 2061 6e64 2074 6865 6e20 6361 6c6c  ut and then call
+0000aeb0: 7320 7374 7265 616d 2e0a 2020 2020 2020  s stream..      
+0000aec0: 2020 5375 6263 6c61 7373 6573 2073 686f    Subclasses sho
+0000aed0: 756c 6420 6f76 6572 7269 6465 2074 6869  uld override thi
+0000aee0: 7320 6d65 7468 6f64 2069 6620 7468 6579  s method if they
+0000aef0: 2063 616e 2073 7461 7274 2070 726f 6475   can start produ
+0000af00: 6369 6e67 206f 7574 7075 7420 7768 696c  cing output whil
+0000af10: 650a 2020 2020 2020 2020 696e 7075 7420  e.        input 
+0000af20: 6973 2073 7469 6c6c 2062 6569 6e67 2067  is still being g
+0000af30: 656e 6572 6174 6564 2e0a 2020 2020 2020  enerated..      
+0000af40: 2020 2222 220a 2020 2020 2020 2020 6669    """.        fi
+0000af50: 6e61 6c3a 2049 6e70 7574 0a20 2020 2020  nal: Input.     
+0000af60: 2020 2067 6f74 5f66 6972 7374 5f76 616c     got_first_val
+0000af70: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000af80: 2020 666f 7220 6963 6875 6e6b 2069 6e20    for ichunk in 
+0000af90: 696e 7075 743a 0a20 2020 2020 2020 2020  input:.         
+0000afa0: 2020 2023 2054 6865 2064 6566 6175 6c74     # The default
+0000afb0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
+0000afc0: 6f66 2074 7261 6e73 666f 726d 2069 7320  of transform is 
+0000afd0: 746f 2062 7566 6665 7220 696e 7075 7420  to buffer input 
+0000afe0: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
+0000aff0: 2320 7468 656e 2063 616c 6c20 7374 7265  # then call stre
+0000b000: 616d 2e0a 2020 2020 2020 2020 2020 2020  am..            
+0000b010: 2320 4974 276c 6c20 6174 7465 6d70 7420  # It'll attempt 
+0000b020: 746f 2067 6174 6865 7220 616c 6c20 696e  to gather all in
+0000b030: 7075 7420 696e 746f 2061 2073 696e 676c  put into a singl
+0000b040: 6520 6368 756e 6b20 7573 696e 670a 2020  e chunk using.  
+0000b050: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
+0000b060: 602b 6020 6f70 6572 6174 6f72 2e0a 2020  `+` operator..  
+0000b070: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+0000b080: 6865 2069 6e70 7574 2069 7320 6e6f 7420  he input is not 
+0000b090: 6164 6461 626c 652c 2074 6865 6e20 7765  addable, then we
+0000b0a0: 276c 6c20 6173 7375 6d65 2074 6861 7420  'll assume that 
+0000b0b0: 7765 2063 616e 0a20 2020 2020 2020 2020  we can.         
+0000b0c0: 2020 2023 206f 6e6c 7920 6f70 6572 6174     # only operat
+0000b0d0: 6520 6f6e 2074 6865 206c 6173 7420 6368  e on the last ch
+0000b0e0: 756e 6b2c 0a20 2020 2020 2020 2020 2020  unk,.           
+0000b0f0: 2023 2061 6e64 2077 6527 6c6c 2069 7465   # and we'll ite
+0000b100: 7261 7465 2075 6e74 696c 2077 6520 6765  rate until we ge
+0000b110: 7420 746f 2074 6865 206c 6173 7420 6368  t to the last ch
+0000b120: 756e 6b2e 0a20 2020 2020 2020 2020 2020  unk..           
+0000b130: 2069 6620 6e6f 7420 676f 745f 6669 7273   if not got_firs
+0000b140: 745f 7661 6c3a 0a20 2020 2020 2020 2020  t_val:.         
+0000b150: 2020 2020 2020 2066 696e 616c 203d 2069         final = i
+0000b160: 6368 756e 6b0a 2020 2020 2020 2020 2020  chunk.          
+0000b170: 2020 2020 2020 676f 745f 6669 7273 745f        got_first_
+0000b180: 7661 6c20 3d20 5472 7565 0a20 2020 2020  val = True.     
+0000b190: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000b1a0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000b1b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b1c0: 2020 2020 2020 6669 6e61 6c20 3d20 6669        final = fi
+0000b1d0: 6e61 6c20 2b20 6963 6875 6e6b 2020 2320  nal + ichunk  # 
+0000b1e0: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
+0000b1f0: 7261 746f 725d 0a20 2020 2020 2020 2020  rator].         
+0000b200: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+0000b210: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+0000b220: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+0000b230: 616c 203d 2069 6368 756e 6b0a 0a20 2020  al = ichunk..   
+0000b240: 2020 2020 2069 6620 676f 745f 6669 7273       if got_firs
+0000b250: 745f 7661 6c3a 0a20 2020 2020 2020 2020  t_val:.         
+0000b260: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
+0000b270: 6c66 2e73 7472 6561 6d28 6669 6e61 6c2c  lf.stream(final,
+0000b280: 2063 6f6e 6669 672c 202a 2a6b 7761 7267   config, **kwarg
+0000b290: 7329 0a0a 2020 2020 6173 796e 6320 6465  s)..    async de
+0000b2a0: 6620 6174 7261 6e73 666f 726d 280a 2020  f atransform(.  
+0000b2b0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0000b2c0: 2020 2020 696e 7075 743a 2041 7379 6e63      input: Async
+0000b2d0: 4974 6572 6174 6f72 5b49 6e70 7574 5d2c  Iterator[Input],
+0000b2e0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+0000b2f0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
+0000b300: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
+0000b310: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+0000b320: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
+0000b330: 5d2c 0a20 2020 2029 202d 3e20 4173 796e  ],.    ) -> Asyn
+0000b340: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
+0000b350: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0000b360: 2020 2020 2020 2044 6566 6175 6c74 2069         Default i
+0000b370: 6d70 6c65 6d65 6e74 6174 696f 6e20 6f66  mplementation of
+0000b380: 2061 7472 616e 7366 6f72 6d2c 2077 6869   atransform, whi
+0000b390: 6368 2062 7566 6665 7273 2069 6e70 7574  ch buffers input
+0000b3a0: 2061 6e64 2063 616c 6c73 2061 7374 7265   and calls astre
+0000b3b0: 616d 2e0a 2020 2020 2020 2020 5375 6263  am..        Subc
+0000b3c0: 6c61 7373 6573 2073 686f 756c 6420 6f76  lasses should ov
+0000b3d0: 6572 7269 6465 2074 6869 7320 6d65 7468  erride this meth
+0000b3e0: 6f64 2069 6620 7468 6579 2063 616e 2073  od if they can s
+0000b3f0: 7461 7274 2070 726f 6475 6369 6e67 206f  tart producing o
+0000b400: 7574 7075 7420 7768 696c 650a 2020 2020  utput while.    
+0000b410: 2020 2020 696e 7075 7420 6973 2073 7469      input is sti
+0000b420: 6c6c 2062 6569 6e67 2067 656e 6572 6174  ll being generat
+0000b430: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+0000b440: 2020 2020 2020 2020 6669 6e61 6c3a 2049          final: I
+0000b450: 6e70 7574 0a20 2020 2020 2020 2067 6f74  nput.        got
+0000b460: 5f66 6972 7374 5f76 616c 203d 2046 616c  _first_val = Fal
+0000b470: 7365 0a0a 2020 2020 2020 2020 6173 796e  se..        asyn
+0000b480: 6320 666f 7220 6963 6875 6e6b 2069 6e20  c for ichunk in 
+0000b490: 696e 7075 743a 0a20 2020 2020 2020 2020  input:.         
+0000b4a0: 2020 2023 2054 6865 2064 6566 6175 6c74     # The default
+0000b4b0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
+0000b4c0: 6f66 2074 7261 6e73 666f 726d 2069 7320  of transform is 
+0000b4d0: 746f 2062 7566 6665 7220 696e 7075 7420  to buffer input 
+0000b4e0: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
+0000b4f0: 2320 7468 656e 2063 616c 6c20 7374 7265  # then call stre
+0000b500: 616d 2e0a 2020 2020 2020 2020 2020 2020  am..            
+0000b510: 2320 4974 276c 6c20 6174 7465 6d70 7420  # It'll attempt 
+0000b520: 746f 2067 6174 6865 7220 616c 6c20 696e  to gather all in
+0000b530: 7075 7420 696e 746f 2061 2073 696e 676c  put into a singl
+0000b540: 6520 6368 756e 6b20 7573 696e 670a 2020  e chunk using.  
+0000b550: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
+0000b560: 602b 6020 6f70 6572 6174 6f72 2e0a 2020  `+` operator..  
+0000b570: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+0000b580: 6865 2069 6e70 7574 2069 7320 6e6f 7420  he input is not 
+0000b590: 6164 6461 626c 652c 2074 6865 6e20 7765  addable, then we
+0000b5a0: 276c 6c20 6173 7375 6d65 2074 6861 7420  'll assume that 
+0000b5b0: 7765 2063 616e 0a20 2020 2020 2020 2020  we can.         
+0000b5c0: 2020 2023 206f 6e6c 7920 6f70 6572 6174     # only operat
+0000b5d0: 6520 6f6e 2074 6865 206c 6173 7420 6368  e on the last ch
+0000b5e0: 756e 6b2c 0a20 2020 2020 2020 2020 2020  unk,.           
+0000b5f0: 2023 2061 6e64 2077 6527 6c6c 2069 7465   # and we'll ite
+0000b600: 7261 7465 2075 6e74 696c 2077 6520 6765  rate until we ge
+0000b610: 7420 746f 2074 6865 206c 6173 7420 6368  t to the last ch
+0000b620: 756e 6b2e 0a20 2020 2020 2020 2020 2020  unk..           
+0000b630: 2069 6620 6e6f 7420 676f 745f 6669 7273   if not got_firs
+0000b640: 745f 7661 6c3a 0a20 2020 2020 2020 2020  t_val:.         
+0000b650: 2020 2020 2020 2066 696e 616c 203d 2069         final = i
+0000b660: 6368 756e 6b0a 2020 2020 2020 2020 2020  chunk.          
+0000b670: 2020 2020 2020 676f 745f 6669 7273 745f        got_first_
+0000b680: 7661 6c20 3d20 5472 7565 0a20 2020 2020  val = True.     
+0000b690: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000b6a0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000b6b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b6c0: 2020 2020 2020 6669 6e61 6c20 3d20 6669        final = fi
+0000b6d0: 6e61 6c20 2b20 6963 6875 6e6b 2020 2320  nal + ichunk  # 
+0000b6e0: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
+0000b6f0: 7261 746f 725d 0a20 2020 2020 2020 2020  rator].         
+0000b700: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+0000b710: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+0000b720: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+0000b730: 616c 203d 2069 6368 756e 6b0a 0a20 2020  al = ichunk..   
+0000b740: 2020 2020 2069 6620 676f 745f 6669 7273       if got_firs
+0000b750: 745f 7661 6c3a 0a20 2020 2020 2020 2020  t_val:.         
+0000b760: 2020 2061 7379 6e63 2066 6f72 206f 7574     async for out
+0000b770: 7075 7420 696e 2073 656c 662e 6173 7472  put in self.astr
+0000b780: 6561 6d28 6669 6e61 6c2c 2063 6f6e 6669  eam(final, confi
+0000b790: 672c 202a 2a6b 7761 7267 7329 3a0a 2020  g, **kwargs):.  
+0000b7a0: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0000b7b0: 656c 6420 6f75 7470 7574 0a0a 2020 2020  eld output..    
+0000b7c0: 6465 6620 6269 6e64 2873 656c 662c 202a  def bind(self, *
+0000b7d0: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
+0000b7e0: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
+0000b7f0: 204f 7574 7075 745d 3a0a 2020 2020 2020   Output]:.      
+0000b800: 2020 2222 220a 2020 2020 2020 2020 4269    """.        Bi
+0000b810: 6e64 2061 7267 756d 656e 7473 2074 6f20  nd arguments to 
+0000b820: 6120 5275 6e6e 6162 6c65 2c20 7265 7475  a Runnable, retu
+0000b830: 726e 696e 6720 6120 6e65 7720 5275 6e6e  rning a new Runn
+0000b840: 6162 6c65 2e0a 0a20 2020 2020 2020 2055  able...        U
+0000b850: 7365 6675 6c20 7768 656e 2061 2072 756e  seful when a run
+0000b860: 6e61 626c 6520 696e 2061 2063 6861 696e  nable in a chain
+0000b870: 2072 6571 7569 7265 7320 616e 2061 7267   requires an arg
+0000b880: 756d 656e 7420 7468 6174 2069 7320 6e6f  ument that is no
+0000b890: 740a 2020 2020 2020 2020 696e 2074 6865  t.        in the
+0000b8a0: 206f 7574 7075 7420 6f66 2074 6865 2070   output of the p
+0000b8b0: 7265 7669 6f75 7320 7275 6e6e 6162 6c65  revious runnable
+0000b8c0: 206f 7220 696e 636c 7564 6564 2069 6e20   or included in 
+0000b8d0: 7468 6520 7573 6572 2069 6e70 7574 2e0a  the user input..
+0000b8e0: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
+0000b8f0: 3a0a 0a20 2020 2020 2020 202e 2e20 636f  :..        .. co
+0000b900: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
+0000b910: 6e0a 0a20 2020 2020 2020 2020 2020 2066  n..            f
+0000b920: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+0000b930: 6d6d 756e 6974 792e 6368 6174 5f6d 6f64  mmunity.chat_mod
+0000b940: 656c 7320 696d 706f 7274 2043 6861 744f  els import ChatO
+0000b950: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
+0000b960: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+0000b970: 5f63 6f72 652e 6f75 7470 7574 5f70 6172  _core.output_par
+0000b980: 7365 7273 2069 6d70 6f72 7420 5374 724f  sers import StrO
+0000b990: 7574 7075 7450 6172 7365 720a 0a20 2020  utputParser..   
+0000b9a0: 2020 2020 2020 2020 206c 6c6d 203d 2043           llm = C
+0000b9b0: 6861 744f 6c6c 616d 6128 6d6f 6465 6c3d  hatOllama(model=
+0000b9c0: 276c 6c61 6d61 3227 290a 0a20 2020 2020  'llama2')..     
+0000b9d0: 2020 2020 2020 2023 2057 6974 686f 7574         # Without
+0000b9e0: 2062 696e 642e 0a20 2020 2020 2020 2020   bind..         
+0000b9f0: 2020 2063 6861 696e 203d 2028 0a20 2020     chain = (.   
+0000ba00: 2020 2020 2020 2020 2020 2020 206c 6c6d               llm
+0000ba10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ba20: 207c 2053 7472 4f75 7470 7574 5061 7273   | StrOutputPars
+0000ba30: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+0000ba40: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000ba50: 6368 6169 6e2e 696e 766f 6b65 2822 5265  chain.invoke("Re
+0000ba60: 7065 6174 2071 756f 7465 6420 776f 7264  peat quoted word
+0000ba70: 7320 6578 6163 746c 793a 2027 4f6e 6520  s exactly: 'One 
+0000ba80: 7477 6f20 7468 7265 6520 666f 7572 2066  two three four f
+0000ba90: 6976 652e 2722 290a 2020 2020 2020 2020  ive.'").        
+0000baa0: 2020 2020 2320 4f75 7470 7574 2069 7320      # Output is 
+0000bab0: 274f 6e65 2074 776f 2074 6872 6565 2066  'One two three f
+0000bac0: 6f75 7220 6669 7665 2e27 0a0a 2020 2020  our five.'..    
+0000bad0: 2020 2020 2020 2020 2320 5769 7468 2062          # With b
+0000bae0: 696e 642e 0a20 2020 2020 2020 2020 2020  ind..           
+0000baf0: 2063 6861 696e 203d 2028 0a20 2020 2020   chain = (.     
+0000bb00: 2020 2020 2020 2020 2020 206c 6c6d 2e62             llm.b
+0000bb10: 696e 6428 7374 6f70 3d5b 2274 6872 6565  ind(stop=["three
+0000bb20: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+0000bb30: 2020 2020 7c20 5374 724f 7574 7075 7450      | StrOutputP
+0000bb40: 6172 7365 7228 290a 2020 2020 2020 2020  arser().        
+0000bb50: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000bb60: 2020 2063 6861 696e 2e69 6e76 6f6b 6528     chain.invoke(
+0000bb70: 2252 6570 6561 7420 7175 6f74 6564 2077  "Repeat quoted w
+0000bb80: 6f72 6473 2065 7861 6374 6c79 3a20 274f  ords exactly: 'O
+0000bb90: 6e65 2074 776f 2074 6872 6565 2066 6f75  ne two three fou
+0000bba0: 7220 6669 7665 2e27 2229 0a20 2020 2020  r five.'").     
+0000bbb0: 2020 2020 2020 2023 204f 7574 7075 7420         # Output 
+0000bbc0: 6973 2027 4f6e 6520 7477 6f27 0a0a 2020  is 'One two'..  
+0000bbd0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000bbe0: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
+0000bbf0: 6542 696e 6469 6e67 2862 6f75 6e64 3d73  eBinding(bound=s
+0000bc00: 656c 662c 206b 7761 7267 733d 6b77 6172  elf, kwargs=kwar
+0000bc10: 6773 2c20 636f 6e66 6967 3d7b 7d29 0a0a  gs, config={})..
+0000bc20: 2020 2020 6465 6620 7769 7468 5f63 6f6e      def with_con
+0000bc30: 6669 6728 0a20 2020 2020 2020 2073 656c  fig(.        sel
+0000bc40: 662c 0a20 2020 2020 2020 2063 6f6e 6669  f,.        confi
+0000bc50: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+0000bc60: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+0000bc70: 6e65 2c0a 2020 2020 2020 2020 2320 5361  ne,.        # Sa
+0000bc80: 646c 7920 556e 7061 636b 2069 7320 6e6f  dly Unpack is no
+0000bc90: 7420 7765 6c6c 2073 7570 706f 7274 6564  t well supported
+0000bca0: 2062 7920 6d79 7079 2073 6f20 7468 6973   by mypy so this
+0000bcb0: 2077 696c 6c20 6861 7665 2074 6f20 6265   will have to be
+0000bcc0: 2075 6e74 7970 6564 0a20 2020 2020 2020   untyped.       
+0000bcd0: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+0000bce0: 2020 2020 2920 2d3e 2052 756e 6e61 626c      ) -> Runnabl
+0000bcf0: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
+0000bd00: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000bd10: 2020 2020 2020 4269 6e64 2063 6f6e 6669        Bind confi
+0000bd20: 6720 746f 2061 2052 756e 6e61 626c 652c  g to a Runnable,
+0000bd30: 2072 6574 7572 6e69 6e67 2061 206e 6577   returning a new
+0000bd40: 2052 756e 6e61 626c 652e 0a20 2020 2020   Runnable..     
+0000bd50: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0000bd60: 6574 7572 6e20 5275 6e6e 6162 6c65 4269  eturn RunnableBi
+0000bd70: 6e64 696e 6728 0a20 2020 2020 2020 2020  nding(.         
+0000bd80: 2020 2062 6f75 6e64 3d73 656c 662c 0a20     bound=self,. 
+0000bd90: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+0000bda0: 673d 6361 7374 280a 2020 2020 2020 2020  g=cast(.        
+0000bdb0: 2020 2020 2020 2020 5275 6e6e 6162 6c65          Runnable
+0000bdc0: 436f 6e66 6967 2c0a 2020 2020 2020 2020  Config,.        
+0000bdd0: 2020 2020 2020 2020 7b2a 2a28 636f 6e66          {**(conf
+0000bde0: 6967 206f 7220 7b7d 292c 202a 2a6b 7761  ig or {}), **kwa
+0000bdf0: 7267 737d 2c0a 2020 2020 2020 2020 2020  rgs},.          
+0000be00: 2020 292c 2020 2320 7479 7065 3a20 6967    ),  # type: ig
+0000be10: 6e6f 7265 5b6d 6973 635d 0a20 2020 2020  nore[misc].     
+0000be20: 2020 2020 2020 206b 7761 7267 733d 7b7d         kwargs={}
+0000be30: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000be40: 2064 6566 2077 6974 685f 6c69 7374 656e   def with_listen
+0000be50: 6572 7328 0a20 2020 2020 2020 2073 656c  ers(.        sel
+0000be60: 662c 0a20 2020 2020 2020 202a 2c0a 2020  f,.        *,.  
+0000be70: 2020 2020 2020 6f6e 5f73 7461 7274 3a20        on_start: 
+0000be80: 4f70 7469 6f6e 616c 5b0a 2020 2020 2020  Optional[.      
+0000be90: 2020 2020 2020 556e 696f 6e5b 4361 6c6c        Union[Call
+0000bea0: 6162 6c65 5b5b 5275 6e5d 2c20 4e6f 6e65  able[[Run], None
+0000beb0: 5d2c 2043 616c 6c61 626c 655b 5b52 756e  ], Callable[[Run
+0000bec0: 2c20 5275 6e6e 6162 6c65 436f 6e66 6967  , RunnableConfig
+0000bed0: 5d2c 204e 6f6e 655d 5d0a 2020 2020 2020  ], None]].      
+0000bee0: 2020 5d20 3d20 4e6f 6e65 2c0a 2020 2020    ] = None,.    
+0000bef0: 2020 2020 6f6e 5f65 6e64 3a20 4f70 7469      on_end: Opti
+0000bf00: 6f6e 616c 5b0a 2020 2020 2020 2020 2020  onal[.          
+0000bf10: 2020 556e 696f 6e5b 4361 6c6c 6162 6c65    Union[Callable
+0000bf20: 5b5b 5275 6e5d 2c20 4e6f 6e65 5d2c 2043  [[Run], None], C
+0000bf30: 616c 6c61 626c 655b 5b52 756e 2c20 5275  allable[[Run, Ru
+0000bf40: 6e6e 6162 6c65 436f 6e66 6967 5d2c 204e  nnableConfig], N
+0000bf50: 6f6e 655d 5d0a 2020 2020 2020 2020 5d20  one]].        ] 
+0000bf60: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000bf70: 6f6e 5f65 7272 6f72 3a20 4f70 7469 6f6e  on_error: Option
+0000bf80: 616c 5b0a 2020 2020 2020 2020 2020 2020  al[.            
+0000bf90: 556e 696f 6e5b 4361 6c6c 6162 6c65 5b5b  Union[Callable[[
+0000bfa0: 5275 6e5d 2c20 4e6f 6e65 5d2c 2043 616c  Run], None], Cal
+0000bfb0: 6c61 626c 655b 5b52 756e 2c20 5275 6e6e  lable[[Run, Runn
+0000bfc0: 6162 6c65 436f 6e66 6967 5d2c 204e 6f6e  ableConfig], Non
+0000bfd0: 655d 5d0a 2020 2020 2020 2020 5d20 3d20  e]].        ] = 
+0000bfe0: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
+0000bff0: 756e 6e61 626c 655b 496e 7075 742c 204f  unnable[Input, O
+0000c000: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+0000c010: 2222 220a 2020 2020 2020 2020 4269 6e64  """.        Bind
+0000c020: 206c 6966 6563 7963 6c65 206c 6973 7465   lifecycle liste
+0000c030: 6e65 7273 2074 6f20 6120 5275 6e6e 6162  ners to a Runnab
+0000c040: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
+0000c050: 6e65 7720 5275 6e6e 6162 6c65 2e0a 0a20  new Runnable... 
+0000c060: 2020 2020 2020 206f 6e5f 7374 6172 743a         on_start:
+0000c070: 2043 616c 6c65 6420 6265 666f 7265 2074   Called before t
+0000c080: 6865 2072 756e 6e61 626c 6520 7374 6172  he runnable star
+0000c090: 7473 2072 756e 6e69 6e67 2c20 7769 7468  ts running, with
+0000c0a0: 2074 6865 2052 756e 206f 626a 6563 742e   the Run object.
+0000c0b0: 0a20 2020 2020 2020 206f 6e5f 656e 643a  .        on_end:
+0000c0c0: 2043 616c 6c65 6420 6166 7465 7220 7468   Called after th
+0000c0d0: 6520 7275 6e6e 6162 6c65 2066 696e 6973  e runnable finis
+0000c0e0: 6865 7320 7275 6e6e 696e 672c 2077 6974  hes running, wit
+0000c0f0: 6820 7468 6520 5275 6e20 6f62 6a65 6374  h the Run object
+0000c100: 2e0a 2020 2020 2020 2020 6f6e 5f65 7272  ..        on_err
+0000c110: 6f72 3a20 4361 6c6c 6564 2069 6620 7468  or: Called if th
+0000c120: 6520 7275 6e6e 6162 6c65 2074 6872 6f77  e runnable throw
+0000c130: 7320 616e 2065 7272 6f72 2c20 7769 7468  s an error, with
+0000c140: 2074 6865 2052 756e 206f 626a 6563 742e   the Run object.
+0000c150: 0a0a 2020 2020 2020 2020 5468 6520 5275  ..        The Ru
+0000c160: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
+0000c170: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
+0000c180: 6f75 7420 7468 6520 7275 6e2c 2069 6e63  out the run, inc
+0000c190: 6c75 6469 6e67 2069 7473 2069 642c 0a20  luding its id,. 
+0000c1a0: 2020 2020 2020 2074 7970 652c 2069 6e70         type, inp
+0000c1b0: 7574 2c20 6f75 7470 7574 2c20 6572 726f  ut, output, erro
+0000c1c0: 722c 2073 7461 7274 5f74 696d 652c 2065  r, start_time, e
+0000c1d0: 6e64 5f74 696d 652c 2061 6e64 2061 6e79  nd_time, and any
+0000c1e0: 2074 6167 7320 6f72 206d 6574 6164 6174   tags or metadat
+0000c1f0: 610a 2020 2020 2020 2020 6164 6465 6420  a.        added 
+0000c200: 746f 2074 6865 2072 756e 2e0a 0a20 2020  to the run...   
+0000c210: 2020 2020 2045 7861 6d70 6c65 3a0a 0a20       Example:.. 
+0000c220: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
+0000c230: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
+0000c240: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0000c250: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+0000c260: 756e 6e61 626c 6573 2069 6d70 6f72 7420  unnables import 
+0000c270: 5275 6e6e 6162 6c65 4c61 6d62 6461 0a20  RunnableLambda. 
+0000c280: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0000c290: 6c61 6e67 6368 6169 6e5f 636f 7265 2e74  langchain_core.t
+0000c2a0: 7261 6365 7273 2e73 6368 656d 6173 2069  racers.schemas i
+0000c2b0: 6d70 6f72 7420 5275 6e0a 0a20 2020 2020  mport Run..     
+0000c2c0: 2020 2020 2020 2069 6d70 6f72 7420 7469         import ti
+0000c2d0: 6d65 0a0a 2020 2020 2020 2020 2020 2020  me..            
+0000c2e0: 6465 6620 7465 7374 5f72 756e 6e61 626c  def test_runnabl
+0000c2f0: 6528 7469 6d65 5f74 6f5f 736c 6565 7020  e(time_to_sleep 
+0000c300: 3a20 696e 7429 3a0a 2020 2020 2020 2020  : int):.        
+0000c310: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+0000c320: 6570 2874 696d 655f 746f 5f73 6c65 6570  ep(time_to_sleep
+0000c330: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+0000c340: 6566 2066 6e5f 7374 6172 7428 7275 6e5f  ef fn_start(run_
+0000c350: 6f62 6a3a 2052 756e 293a 0a20 2020 2020  obj: Run):.     
+0000c360: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000c370: 2822 7374 6172 745f 7469 6d65 3a22 2c20  ("start_time:", 
+0000c380: 7275 6e5f 6f62 6a2e 7374 6172 745f 7469  run_obj.start_ti
+0000c390: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
+0000c3a0: 2064 6566 2066 6e5f 656e 6428 7275 6e5f   def fn_end(run_
+0000c3b0: 6f62 6a3a 2052 756e 293a 0a20 2020 2020  obj: Run):.     
+0000c3c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000c3d0: 2822 656e 645f 7469 6d65 3a22 2c20 7275  ("end_time:", ru
+0000c3e0: 6e5f 6f62 6a2e 656e 645f 7469 6d65 290a  n_obj.end_time).
+0000c3f0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
+0000c400: 696e 203d 2052 756e 6e61 626c 654c 616d  in = RunnableLam
+0000c410: 6264 6128 7465 7374 5f72 756e 6e61 626c  bda(test_runnabl
+0000c420: 6529 2e77 6974 685f 6c69 7374 656e 6572  e).with_listener
+0000c430: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+0000c440: 2020 206f 6e5f 7374 6172 743d 666e 5f73     on_start=fn_s
+0000c450: 7461 7274 2c0a 2020 2020 2020 2020 2020  tart,.          
+0000c460: 2020 2020 2020 6f6e 5f65 6e64 3d66 6e5f        on_end=fn_
+0000c470: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
+0000c480: 290a 2020 2020 2020 2020 2020 2020 6368  ).            ch
+0000c490: 6169 6e2e 696e 766f 6b65 2832 290a 2020  ain.invoke(2).  
+0000c4a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000c4b0: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+0000c4c0: 5f63 6f72 652e 7472 6163 6572 732e 726f  _core.tracers.ro
+0000c4d0: 6f74 5f6c 6973 7465 6e65 7273 2069 6d70  ot_listeners imp
+0000c4e0: 6f72 7420 526f 6f74 4c69 7374 656e 6572  ort RootListener
+0000c4f0: 7354 7261 6365 720a 0a20 2020 2020 2020  sTracer..       
+0000c500: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
+0000c510: 4269 6e64 696e 6728 0a20 2020 2020 2020  Binding(.       
+0000c520: 2020 2020 2062 6f75 6e64 3d73 656c 662c       bound=self,
+0000c530: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000c540: 6669 675f 6661 6374 6f72 6965 733d 5b0a  fig_factories=[.
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c560: 6c61 6d62 6461 2063 6f6e 6669 673a 207b  lambda config: {
+0000c570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c580: 2020 2020 2022 6361 6c6c 6261 636b 7322       "callbacks"
+0000c590: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
+0000c5a0: 2020 2020 2020 2020 2020 2020 526f 6f74              Root
+0000c5b0: 4c69 7374 656e 6572 7354 7261 6365 7228  ListenersTracer(
+0000c5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c5d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000c5e0: 6669 673d 636f 6e66 6967 2c0a 2020 2020  fig=config,.    
+0000c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c600: 2020 2020 2020 2020 6f6e 5f73 7461 7274          on_start
+0000c610: 3d6f 6e5f 7374 6172 742c 0a20 2020 2020  =on_start,.     
+0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c630: 2020 2020 2020 206f 6e5f 656e 643d 6f6e         on_end=on
+0000c640: 5f65 6e64 2c0a 2020 2020 2020 2020 2020  _end,.          
+0000c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c660: 2020 6f6e 5f65 7272 6f72 3d6f 6e5f 6572    on_error=on_er
+0000c670: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
+0000c680: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000c690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6a0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+0000c6b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000c6c0: 2020 2020 5d2c 0a20 2020 2020 2020 2029      ],.        )
+0000c6d0: 0a0a 2020 2020 6465 6620 7769 7468 5f74  ..    def with_t
+0000c6e0: 7970 6573 280a 2020 2020 2020 2020 7365  ypes(.        se
+0000c6f0: 6c66 2c0a 2020 2020 2020 2020 2a2c 0a20  lf,.        *,. 
+0000c700: 2020 2020 2020 2069 6e70 7574 5f74 7970         input_typ
+0000c710: 653a 204f 7074 696f 6e61 6c5b 5479 7065  e: Optional[Type
+0000c720: 5b49 6e70 7574 5d5d 203d 204e 6f6e 652c  [Input]] = None,
+0000c730: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+0000c740: 7479 7065 3a20 4f70 7469 6f6e 616c 5b54  type: Optional[T
+0000c750: 7970 655b 4f75 7470 7574 5d5d 203d 204e  ype[Output]] = N
+0000c760: 6f6e 652c 0a20 2020 2029 202d 3e20 5275  one,.    ) -> Ru
+0000c770: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
+0000c780: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
+0000c790: 2222 0a20 2020 2020 2020 2042 696e 6420  "".        Bind 
+0000c7a0: 696e 7075 7420 616e 6420 6f75 7470 7574  input and output
+0000c7b0: 2074 7970 6573 2074 6f20 6120 5275 6e6e   types to a Runn
+0000c7c0: 6162 6c65 2c20 7265 7475 726e 696e 6720  able, returning 
+0000c7d0: 6120 6e65 7720 5275 6e6e 6162 6c65 2e0a  a new Runnable..
+0000c7e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000c7f0: 2020 2020 7265 7475 726e 2052 756e 6e61      return Runna
+0000c800: 626c 6542 696e 6469 6e67 280a 2020 2020  bleBinding(.    
+0000c810: 2020 2020 2020 2020 626f 756e 643d 7365          bound=se
+0000c820: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+0000c830: 6375 7374 6f6d 5f69 6e70 7574 5f74 7970  custom_input_typ
+0000c840: 653d 696e 7075 745f 7479 7065 2c0a 2020  e=input_type,.  
+0000c850: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
+0000c860: 5f6f 7574 7075 745f 7479 7065 3d6f 7574  _output_type=out
+0000c870: 7075 745f 7479 7065 2c0a 2020 2020 2020  put_type,.      
+0000c880: 2020 2020 2020 6b77 6172 6773 3d7b 7d2c        kwargs={},
+0000c890: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000c8a0: 6465 6620 7769 7468 5f72 6574 7279 280a  def with_retry(.
+0000c8b0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000c8c0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+0000c8d0: 2072 6574 7279 5f69 665f 6578 6365 7074   retry_if_except
+0000c8e0: 696f 6e5f 7479 7065 3a20 5475 706c 655b  ion_type: Tuple[
+0000c8f0: 5479 7065 5b42 6173 6545 7863 6570 7469  Type[BaseExcepti
+0000c900: 6f6e 5d2c 202e 2e2e 5d20 3d20 2845 7863  on], ...] = (Exc
+0000c910: 6570 7469 6f6e 2c29 2c0a 2020 2020 2020  eption,),.      
+0000c920: 2020 7761 6974 5f65 7870 6f6e 656e 7469    wait_exponenti
+0000c930: 616c 5f6a 6974 7465 723a 2062 6f6f 6c20  al_jitter: bool 
+0000c940: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+0000c950: 7374 6f70 5f61 6674 6572 5f61 7474 656d  stop_after_attem
+0000c960: 7074 3a20 696e 7420 3d20 332c 0a20 2020  pt: int = 3,.   
+0000c970: 2029 202d 3e20 5275 6e6e 6162 6c65 5b49   ) -> Runnable[I
+0000c980: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
+0000c990: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
+0000c9a0: 2061 206e 6577 2052 756e 6e61 626c 6520   a new Runnable 
+0000c9b0: 7468 6174 2072 6574 7269 6573 2074 6865  that retries the
+0000c9c0: 206f 7269 6769 6e61 6c20 7275 6e6e 6162   original runnab
+0000c9d0: 6c65 206f 6e20 6578 6365 7074 696f 6e73  le on exceptions
+0000c9e0: 2e0a 0a20 2020 2020 2020 2045 7861 6d70  ...        Examp
+0000c9f0: 6c65 3a0a 0a20 2020 2020 2020 202e 2e20  le:..        .. 
+0000ca00: 636f 6465 2d62 6c6f 636b 3a3a 2070 7974  code-block:: pyt
+0000ca10: 686f 6e0a 0a20 2020 2020 2020 2020 2020  hon..           
+0000ca20: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+0000ca30: 636f 7265 2e72 756e 6e61 626c 6573 2069  core.runnables i
+0000ca40: 6d70 6f72 7420 5275 6e6e 6162 6c65 4c61  mport RunnableLa
+0000ca50: 6d62 6461 0a0a 2020 2020 2020 2020 2020  mbda..          
+0000ca60: 2020 636f 756e 7420 3d20 300a 0a0a 2020    count = 0...  
+0000ca70: 2020 2020 2020 2020 2020 6465 6620 5f6c            def _l
+0000ca80: 616d 6264 6128 783a 2069 6e74 2920 2d3e  ambda(x: int) ->
+0000ca90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000caa0: 2020 2020 2020 2067 6c6f 6261 6c20 636f         global co
+0000cab0: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
+0000cac0: 2020 2020 636f 756e 7420 3d20 636f 756e      count = coun
+0000cad0: 7420 2b20 310a 2020 2020 2020 2020 2020  t + 1.          
+0000cae0: 2020 2020 2020 6966 2078 203d 3d20 313a        if x == 1:
+0000caf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cb00: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000cb10: 4572 726f 7228 2278 2069 7320 3122 290a  Error("x is 1").
+0000cb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000cb40: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0000cb50: 0a0a 2020 2020 2020 2020 2020 2020 7275  ..            ru
+0000cb60: 6e6e 6162 6c65 203d 2052 756e 6e61 626c  nnable = Runnabl
+0000cb70: 654c 616d 6264 6128 5f6c 616d 6264 6129  eLambda(_lambda)
+0000cb80: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0000cb90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cba0: 2020 7275 6e6e 6162 6c65 2e77 6974 685f    runnable.with_
+0000cbb0: 7265 7472 7928 0a20 2020 2020 2020 2020  retry(.         
+0000cbc0: 2020 2020 2020 2020 2020 2073 746f 705f             stop_
+0000cbd0: 6166 7465 725f 6174 7465 6d70 743d 322c  after_attempt=2,
+0000cbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cbf0: 2020 2020 2072 6574 7279 5f69 665f 6578       retry_if_ex
+0000cc00: 6365 7074 696f 6e5f 7479 7065 3d28 5661  ception_type=(Va
+0000cc10: 6c75 6545 7272 6f72 2c29 2c0a 2020 2020  lueError,),.    
+0000cc20: 2020 2020 2020 2020 2020 2020 292e 696e              ).in
+0000cc30: 766f 6b65 2831 290a 2020 2020 2020 2020  voke(1).        
+0000cc40: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
+0000cc50: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0000cc60: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0000cc70: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000cc80: 2863 6f75 6e74 203d 3d20 3229 0a0a 0a20  (count == 2)... 
+0000cc90: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+0000cca0: 2020 2020 2020 2020 2072 6574 7279 5f69           retry_i
+0000ccb0: 665f 6578 6365 7074 696f 6e5f 7479 7065  f_exception_type
+0000ccc0: 3a20 4120 7475 706c 6520 6f66 2065 7863  : A tuple of exc
+0000ccd0: 6570 7469 6f6e 2074 7970 6573 2074 6f20  eption types to 
+0000cce0: 7265 7472 7920 6f6e 0a20 2020 2020 2020  retry on.       
+0000ccf0: 2020 2020 2077 6169 745f 6578 706f 6e65       wait_expone
+0000cd00: 6e74 6961 6c5f 6a69 7474 6572 3a20 5768  ntial_jitter: Wh
+0000cd10: 6574 6865 7220 746f 2061 6464 206a 6974  ether to add jit
+0000cd20: 7465 7220 746f 2074 6865 2077 6169 7420  ter to the wait 
+0000cd30: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+0000cd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd50: 2020 2020 2020 2020 2020 6265 7477 6565            betwee
+0000cd60: 6e20 7265 7472 6965 730a 2020 2020 2020  n retries.      
+0000cd70: 2020 2020 2020 7374 6f70 5f61 6674 6572        stop_after
+0000cd80: 5f61 7474 656d 7074 3a20 5468 6520 6d61  _attempt: The ma
+0000cd90: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
+0000cda0: 6174 7465 6d70 7473 2074 6f20 6d61 6b65  attempts to make
+0000cdb0: 2062 6566 6f72 6520 6769 7669 6e67 2075   before giving u
+0000cdc0: 700a 0a20 2020 2020 2020 2052 6574 7572  p..        Retur
+0000cdd0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0000cde0: 4120 6e65 7720 5275 6e6e 6162 6c65 2074  A new Runnable t
+0000cdf0: 6861 7420 7265 7472 6965 7320 7468 6520  hat retries the 
+0000ce00: 6f72 6967 696e 616c 2072 756e 6e61 626c  original runnabl
+0000ce10: 6520 6f6e 2065 7863 6570 7469 6f6e 732e  e on exceptions.
+0000ce20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000ce30: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+0000ce40: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
+0000ce50: 6573 2e72 6574 7279 2069 6d70 6f72 7420  es.retry import 
+0000ce60: 5275 6e6e 6162 6c65 5265 7472 790a 0a20  RunnableRetry.. 
+0000ce70: 2020 2020 2020 2072 6574 7572 6e20 5275         return Ru
+0000ce80: 6e6e 6162 6c65 5265 7472 7928 0a20 2020  nnableRetry(.   
+0000ce90: 2020 2020 2020 2020 2062 6f75 6e64 3d73           bound=s
+0000cea0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+0000ceb0: 206b 7761 7267 733d 7b7d 2c0a 2020 2020   kwargs={},.    
+0000cec0: 2020 2020 2020 2020 636f 6e66 6967 3d7b          config={
+0000ced0: 7d2c 0a20 2020 2020 2020 2020 2020 2072  },.            r
+0000cee0: 6574 7279 5f65 7863 6570 7469 6f6e 5f74  etry_exception_t
+0000cef0: 7970 6573 3d72 6574 7279 5f69 665f 6578  ypes=retry_if_ex
+0000cf00: 6365 7074 696f 6e5f 7479 7065 2c0a 2020  ception_type,.  
+0000cf10: 2020 2020 2020 2020 2020 7761 6974 5f65            wait_e
+0000cf20: 7870 6f6e 656e 7469 616c 5f6a 6974 7465  xponential_jitte
+0000cf30: 723d 7761 6974 5f65 7870 6f6e 656e 7469  r=wait_exponenti
+0000cf40: 616c 5f6a 6974 7465 722c 0a20 2020 2020  al_jitter,.     
+0000cf50: 2020 2020 2020 206d 6178 5f61 7474 656d         max_attem
+0000cf60: 7074 5f6e 756d 6265 723d 7374 6f70 5f61  pt_number=stop_a
+0000cf70: 6674 6572 5f61 7474 656d 7074 2c0a 2020  fter_attempt,.  
+0000cf80: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+0000cf90: 206d 6170 2873 656c 6629 202d 3e20 5275   map(self) -> Ru
+0000cfa0: 6e6e 6162 6c65 5b4c 6973 745b 496e 7075  nnable[List[Inpu
+0000cfb0: 745d 2c20 4c69 7374 5b4f 7574 7075 745d  t], List[Output]
+0000cfc0: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0000cfd0: 2020 2020 2020 2052 6574 7572 6e20 6120         Return a 
+0000cfe0: 6e65 7720 5275 6e6e 6162 6c65 2074 6861  new Runnable tha
+0000cff0: 7420 6d61 7073 2061 206c 6973 7420 6f66  t maps a list of
+0000d000: 2069 6e70 7574 7320 746f 2061 206c 6973   inputs to a lis
+0000d010: 7420 6f66 206f 7574 7075 7473 2c0a 2020  t of outputs,.  
+0000d020: 2020 2020 2020 6279 2063 616c 6c69 6e67        by calling
+0000d030: 2069 6e76 6f6b 6528 2920 7769 7468 2065   invoke() with e
+0000d040: 6163 6820 696e 7075 742e 0a0a 2020 2020  ach input...    
+0000d050: 2020 2020 4578 616d 706c 653a 0a0a 2020      Example:..  
+0000d060: 2020 2020 2020 2020 2020 2e2e 2063 6f64            .. cod
+0000d070: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
+0000d080: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d090: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+0000d0a0: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
+0000d0b0: 6c65 7320 696d 706f 7274 2052 756e 6e61  les import Runna
+0000d0c0: 626c 654c 616d 6264 610a 0a20 2020 2020  bleLambda..     
+0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000d0e0: 6566 205f 6c61 6d62 6461 2878 3a20 696e  ef _lambda(x: in
+0000d0f0: 7429 202d 3e20 696e 743a 0a20 2020 2020  t) -> int:.     
+0000d100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d110: 2020 2072 6574 7572 6e20 7820 2b20 310a     return x + 1.
+0000d120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d130: 2020 2020 2072 756e 6e61 626c 6520 3d20       runnable = 
+0000d140: 5275 6e6e 6162 6c65 4c61 6d62 6461 285f  RunnableLambda(_
+0000d150: 6c61 6d62 6461 290a 2020 2020 2020 2020  lambda).        
+0000d160: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000d170: 7428 7275 6e6e 6162 6c65 2e6d 6170 2829  t(runnable.map()
+0000d180: 2e69 6e76 6f6b 6528 5b31 2c20 322c 2033  .invoke([1, 2, 3
+0000d190: 5d29 2920 2320 5b32 2c20 332c 2034 5d0a  ])) # [2, 3, 4].
+0000d1a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000d1b0: 2020 2020 7265 7475 726e 2052 756e 6e61      return Runna
+0000d1c0: 626c 6545 6163 6828 626f 756e 643d 7365  bleEach(bound=se
+0000d1d0: 6c66 290a 0a20 2020 2064 6566 2077 6974  lf)..    def wit
+0000d1e0: 685f 6661 6c6c 6261 636b 7328 0a20 2020  h_fallbacks(.   
+0000d1f0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000d200: 2020 2066 616c 6c62 6163 6b73 3a20 5365     fallbacks: Se
+0000d210: 7175 656e 6365 5b52 756e 6e61 626c 655b  quence[Runnable[
+0000d220: 496e 7075 742c 204f 7574 7075 745d 5d2c  Input, Output]],
+0000d230: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+0000d240: 2020 2020 6578 6365 7074 696f 6e73 5f74      exceptions_t
+0000d250: 6f5f 6861 6e64 6c65 3a20 5475 706c 655b  o_handle: Tuple[
+0000d260: 5479 7065 5b42 6173 6545 7863 6570 7469  Type[BaseExcepti
+0000d270: 6f6e 5d2c 202e 2e2e 5d20 3d20 2845 7863  on], ...] = (Exc
+0000d280: 6570 7469 6f6e 2c29 2c0a 2020 2020 2020  eption,),.      
+0000d290: 2020 6578 6365 7074 696f 6e5f 6b65 793a    exception_key:
+0000d2a0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+0000d2b0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+0000d2c0: 5275 6e6e 6162 6c65 5769 7468 4661 6c6c  RunnableWithFall
+0000d2d0: 6261 636b 7354 5b49 6e70 7574 2c20 4f75  backsT[Input, Ou
+0000d2e0: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
+0000d2f0: 2222 4164 6420 6661 6c6c 6261 636b 7320  ""Add fallbacks 
+0000d300: 746f 2061 2072 756e 6e61 626c 652c 2072  to a runnable, r
+0000d310: 6574 7572 6e69 6e67 2061 206e 6577 2052  eturning a new R
+0000d320: 756e 6e61 626c 652e 0a0a 2020 2020 2020  unnable...      
+0000d330: 2020 4578 616d 706c 653a 0a0a 2020 2020    Example:..    
+0000d340: 2020 2020 2020 2020 2e2e 2063 6f64 652d          .. code-
+0000d350: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
+0000d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d370: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
+0000d380: 7274 2049 7465 7261 746f 720a 0a20 2020  rt Iterator..   
+0000d390: 2020 2020 2020 2020 2020 2020 2066 726f               fro
+0000d3a0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+0000d3b0: 2e72 756e 6e61 626c 6573 2069 6d70 6f72  .runnables impor
+0000d3c0: 7420 5275 6e6e 6162 6c65 4765 6e65 7261  t RunnableGenera
+0000d3d0: 746f 720a 0a0a 2020 2020 2020 2020 2020  tor...          
+0000d3e0: 2020 2020 2020 6465 6620 5f67 656e 6572        def _gener
+0000d3f0: 6174 655f 696d 6d65 6469 6174 655f 6572  ate_immediate_er
+0000d400: 726f 7228 696e 7075 743a 2049 7465 7261  ror(input: Itera
+0000d410: 746f 7229 202d 3e20 4974 6572 6174 6f72  tor) -> Iterator
+0000d420: 5b73 7472 5d3a 0a20 2020 2020 2020 2020  [str]:.         
+0000d430: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000d440: 2056 616c 7565 4572 726f 7228 290a 2020   ValueError().  
 0000d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d460: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
-0000d470: 6c61 7374 2e6b 6579 730a 2020 2020 2020  last.keys.      
-0000d480: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-0000d490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d4a0: 2020 2020 205f 5f63 6f6e 6669 675f 5f3d       __config__=
-0000d4b0: 5f53 6368 656d 6143 6f6e 6669 672c 0a20  _SchemaConfig,. 
-0000d4c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000d4d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000d4e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000d4f0: 2020 2066 6965 6c64 203d 2070 7265 765f     field = prev_
-0000d500: 6f75 7470 7574 5f73 6368 656d 612e 5f5f  output_schema.__
-0000d510: 6669 656c 6473 5f5f 5b6c 6173 742e 6b65  fields__[last.ke
-0000d520: 7973 5d0a 2020 2020 2020 2020 2020 2020  ys].            
-0000d530: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
-0000d540: 655f 6d6f 6465 6c28 2020 2320 7479 7065  e_model(  # type
-0000d550: 3a20 6967 6e6f 7265 5b63 616c 6c2d 6f76  : ignore[call-ov
-0000d560: 6572 6c6f 6164 5d0a 2020 2020 2020 2020  erload].        
-0000d570: 2020 2020 2020 2020 2020 2020 2252 756e              "Run
-0000d580: 6e61 626c 6553 6571 7565 6e63 654f 7574  nableSequenceOut
-0000d590: 7075 7422 2c0a 2020 2020 2020 2020 2020  put",.          
-0000d5a0: 2020 2020 2020 2020 2020 5f5f 726f 6f74            __root
-0000d5b0: 5f5f 3d28 6669 656c 642e 616e 6e6f 7461  __=(field.annota
-0000d5c0: 7469 6f6e 2c20 6669 656c 642e 6465 6661  tion, field.defa
-0000d5d0: 756c 7429 2c0a 2020 2020 2020 2020 2020  ult),.          
-0000d5e0: 2020 2020 2020 2020 2020 5f5f 636f 6e66            __conf
-0000d5f0: 6967 5f5f 3d5f 5363 6865 6d61 436f 6e66  ig__=_SchemaConf
-0000d600: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
-0000d610: 2020 2020 290a 0a20 2020 2072 6574 7572      )..    retur
-0000d620: 6e20 6c61 7374 2e67 6574 5f6f 7574 7075  n last.get_outpu
-0000d630: 745f 7363 6865 6d61 2863 6f6e 6669 6729  t_schema(config)
-0000d640: 0a0a 0a63 6c61 7373 2052 756e 6e61 626c  ...class Runnabl
-0000d650: 6553 6571 7565 6e63 6528 5275 6e6e 6162  eSequence(Runnab
-0000d660: 6c65 5365 7269 616c 697a 6162 6c65 5b49  leSerializable[I
-0000d670: 6e70 7574 2c20 4f75 7470 7574 5d29 3a0a  nput, Output]):.
-0000d680: 2020 2020 2222 2241 2073 6571 7565 6e63      """A sequenc
-0000d690: 6520 6f66 2072 756e 6e61 626c 6573 2c20  e of runnables, 
-0000d6a0: 7768 6572 6520 7468 6520 6f75 7470 7574  where the output
-0000d6b0: 206f 6620 6561 6368 2069 7320 7468 6520   of each is the 
-0000d6c0: 696e 7075 7420 6f66 2074 6865 206e 6578  input of the nex
-0000d6d0: 742e 0a0a 2020 2020 5275 6e6e 6162 6c65  t...    Runnable
-0000d6e0: 5365 7175 656e 6365 2069 7320 7468 6520  Sequence is the 
-0000d6f0: 6d6f 7374 2069 6d70 6f72 7461 6e74 2063  most important c
-0000d700: 6f6d 706f 7369 7469 6f6e 206f 7065 7261  omposition opera
-0000d710: 746f 7220 696e 204c 616e 6743 6861 696e  tor in LangChain
-0000d720: 2061 7320 6974 2069 730a 2020 2020 7573   as it is.    us
-0000d730: 6564 2069 6e20 7669 7274 7561 6c6c 7920  ed in virtually 
-0000d740: 6576 6572 7920 6368 6169 6e2e 0a0a 2020  every chain...  
-0000d750: 2020 4120 5275 6e6e 6162 6c65 5365 7175    A RunnableSequ
-0000d760: 656e 6365 2063 616e 2062 6520 696e 7374  ence can be inst
-0000d770: 616e 7469 6174 6564 2064 6972 6563 746c  antiated directl
-0000d780: 7920 6f72 206d 6f72 6520 636f 6d6d 6f6e  y or more common
-0000d790: 6c79 2062 7920 7573 696e 6720 7468 6520  ly by using the 
-0000d7a0: 607c 600a 2020 2020 6f70 6572 6174 6f72  `|`.    operator
-0000d7b0: 2077 6865 7265 2065 6974 6865 7220 7468   where either th
-0000d7c0: 6520 6c65 6674 206f 7220 7269 6768 7420  e left or right 
-0000d7d0: 6f70 6572 616e 6473 2028 6f72 2062 6f74  operands (or bot
-0000d7e0: 6829 206d 7573 7420 6265 2061 2052 756e  h) must be a Run
-0000d7f0: 6e61 626c 652e 0a0a 2020 2020 416e 7920  nable...    Any 
-0000d800: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
-0000d810: 2061 7574 6f6d 6174 6963 616c 6c79 2073   automatically s
-0000d820: 7570 706f 7274 7320 7379 6e63 2c20 6173  upports sync, as
-0000d830: 796e 632c 2062 6174 6368 2e0a 0a20 2020  ync, batch...   
-0000d840: 2054 6865 2064 6566 6175 6c74 2069 6d70   The default imp
-0000d850: 6c65 6d65 6e74 6174 696f 6e73 206f 6620  lementations of 
-0000d860: 6062 6174 6368 6020 616e 6420 6061 6261  `batch` and `aba
-0000d870: 7463 6860 2075 7469 6c69 7a65 2074 6872  tch` utilize thr
-0000d880: 6561 6470 6f6f 6c73 2061 6e64 0a20 2020  eadpools and.   
-0000d890: 2061 7379 6e63 696f 2067 6174 6865 7220   asyncio gather 
-0000d8a0: 616e 6420 7769 6c6c 2062 6520 6661 7374  and will be fast
-0000d8b0: 6572 2074 6861 6e20 6e61 6976 6520 696e  er than naive in
-0000d8c0: 766f 6361 7469 6f6e 206f 6620 696e 766f  vocation of invo
-0000d8d0: 6b65 206f 7220 6169 6e76 6f6b 650a 2020  ke or ainvoke.  
-0000d8e0: 2020 666f 7220 494f 2062 6f75 6e64 2072    for IO bound r
-0000d8f0: 756e 6e61 626c 6573 2e0a 0a20 2020 2042  unnables...    B
-0000d900: 6174 6368 696e 6720 6973 2069 6d70 6c65  atching is imple
-0000d910: 6d65 6e74 6564 2062 7920 696e 766f 6b69  mented by invoki
-0000d920: 6e67 2074 6865 2062 6174 6368 206d 6574  ng the batch met
-0000d930: 686f 6420 6f6e 2065 6163 6820 636f 6d70  hod on each comp
-0000d940: 6f6e 656e 7420 6f66 2074 6865 0a20 2020  onent of the.   
-0000d950: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
-0000d960: 6520 696e 206f 7264 6572 2e0a 0a20 2020  e in order...   
-0000d970: 2041 2052 756e 6e61 626c 6553 6571 7565   A RunnableSeque
-0000d980: 6e63 6520 7072 6573 6572 7665 7320 7468  nce preserves th
-0000d990: 6520 7374 7265 616d 696e 6720 7072 6f70  e streaming prop
-0000d9a0: 6572 7469 6573 206f 6620 6974 7320 636f  erties of its co
-0000d9b0: 6d70 6f6e 656e 7473 2c20 736f 2069 6620  mponents, so if 
-0000d9c0: 616c 6c0a 2020 2020 636f 6d70 6f6e 656e  all.    componen
-0000d9d0: 7473 206f 6620 7468 6520 7365 7175 656e  ts of the sequen
-0000d9e0: 6365 2069 6d70 6c65 6d65 6e74 2061 2060  ce implement a `
-0000d9f0: 7472 616e 7366 6f72 6d60 206d 6574 686f  transform` metho
-0000da00: 6420 2d2d 2077 6869 6368 0a20 2020 2069  d -- which.    i
-0000da10: 7320 7468 6520 6d65 7468 6f64 2074 6861  s the method tha
-0000da20: 7420 696d 706c 656d 656e 7473 2074 6865  t implements the
-0000da30: 206c 6f67 6963 2074 6f20 6d61 7020 6120   logic to map a 
-0000da40: 7374 7265 616d 696e 6720 696e 7075 7420  streaming input 
-0000da50: 746f 2061 2073 7472 6561 6d69 6e67 0a20  to a streaming. 
-0000da60: 2020 206f 7574 7075 7420 2d2d 2074 6865     output -- the
-0000da70: 6e20 7468 6520 7365 7175 656e 6365 2077  n the sequence w
-0000da80: 696c 6c20 6265 2061 626c 6520 746f 2073  ill be able to s
-0000da90: 7472 6561 6d20 696e 7075 7420 746f 206f  tream input to o
-0000daa0: 7574 7075 7421 0a0a 2020 2020 4966 2061  utput!..    If a
-0000dab0: 6e79 2063 6f6d 706f 6e65 6e74 206f 6620  ny component of 
-0000dac0: 7468 6520 7365 7175 656e 6365 2064 6f65  the sequence doe
-0000dad0: 7320 6e6f 7420 696d 706c 656d 656e 7420  s not implement 
-0000dae0: 7472 616e 7366 6f72 6d20 7468 656e 2074  transform then t
-0000daf0: 6865 0a20 2020 2073 7472 6561 6d69 6e67  he.    streaming
-0000db00: 2077 696c 6c20 6f6e 6c79 2062 6567 696e   will only begin
-0000db10: 2061 6674 6572 2074 6869 7320 636f 6d70   after this comp
-0000db20: 6f6e 656e 7420 6973 2072 756e 2e20 4966  onent is run. If
-0000db30: 2074 6865 7265 2061 7265 0a20 2020 206d   there are.    m
-0000db40: 756c 7469 706c 6520 626c 6f63 6b69 6e67  ultiple blocking
-0000db50: 2063 6f6d 706f 6e65 6e74 732c 2073 7472   components, str
-0000db60: 6561 6d69 6e67 2062 6567 696e 7320 6166  eaming begins af
-0000db70: 7465 7220 7468 6520 6c61 7374 206f 6e65  ter the last one
-0000db80: 2e0a 0a20 2020 2050 6c65 6173 6520 6e6f  ...    Please no
-0000db90: 7465 3a20 5275 6e6e 6162 6c65 4c61 6d62  te: RunnableLamb
-0000dba0: 6461 7320 646f 206e 6f74 2073 7570 706f  das do not suppo
-0000dbb0: 7274 2060 7472 616e 7366 6f72 6d60 2062  rt `transform` b
-0000dbc0: 7920 6465 6661 756c 7421 2053 6f20 6966  y default! So if
-0000dbd0: 0a20 2020 2020 2020 2079 6f75 206e 6565  .        you nee
-0000dbe0: 6420 746f 2075 7365 2061 2052 756e 6e61  d to use a Runna
-0000dbf0: 626c 654c 616d 6264 6173 2062 6520 6361  bleLambdas be ca
-0000dc00: 7265 6675 6c20 6162 6f75 7420 7768 6572  reful about wher
-0000dc10: 6520 796f 7520 706c 6163 6520 7468 656d  e you place them
-0000dc20: 2069 6e20 610a 2020 2020 2020 2020 5275   in a.        Ru
-0000dc30: 6e6e 6162 6c65 5365 7175 656e 6365 2028  nnableSequence (
-0000dc40: 6966 2079 6f75 206e 6565 6420 746f 2075  if you need to u
-0000dc50: 7365 2074 6865 202e 7374 7265 616d 2829  se the .stream()
-0000dc60: 2f2e 6173 7472 6561 6d28 2920 6d65 7468  /.astream() meth
-0000dc70: 6f64 7329 2e0a 0a20 2020 2020 2020 2049  ods)...        I
-0000dc80: 6620 796f 7520 6e65 6564 2061 7262 6974  f you need arbit
-0000dc90: 7261 7279 206c 6f67 6963 2061 6e64 206e  rary logic and n
-0000dca0: 6565 6420 7374 7265 616d 696e 672c 2079  eed streaming, y
-0000dcb0: 6f75 2063 616e 2073 7562 636c 6173 730a  ou can subclass.
-0000dcc0: 2020 2020 2020 2020 5275 6e6e 6162 6c65          Runnable
-0000dcd0: 2c20 616e 6420 696d 706c 656d 656e 7420  , and implement 
-0000dce0: 6074 7261 6e73 666f 726d 6020 666f 7220  `transform` for 
-0000dcf0: 7768 6174 6576 6572 206c 6f67 6963 2079  whatever logic y
-0000dd00: 6f75 206e 6565 642e 0a0a 2020 2020 4865  ou need...    He
-0000dd10: 7265 2069 7320 6120 7369 6d70 6c65 2065  re is a simple e
-0000dd20: 7861 6d70 6c65 2074 6861 7420 7573 6573  xample that uses
-0000dd30: 2073 696d 706c 6520 6675 6e63 7469 6f6e   simple function
-0000dd40: 7320 746f 2069 6c6c 7573 7472 6174 6520  s to illustrate 
-0000dd50: 7468 6520 7573 6520 6f66 0a20 2020 2052  the use of.    R
-0000dd60: 756e 6e61 626c 6553 6571 7565 6e63 653a  unnableSequence:
-0000dd70: 0a0a 2020 2020 2020 2020 2e2e 2063 6f64  ..        .. cod
-0000dd80: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
-0000dd90: 0a0a 2020 2020 2020 2020 2020 2020 6672  ..            fr
-0000dda0: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-0000ddb0: 652e 7275 6e6e 6162 6c65 7320 696d 706f  e.runnables impo
-0000ddc0: 7274 2052 756e 6e61 626c 654c 616d 6264  rt RunnableLambd
-0000ddd0: 610a 0a20 2020 2020 2020 2020 2020 2064  a..            d
-0000dde0: 6566 2061 6464 5f6f 6e65 2878 3a20 696e  ef add_one(x: in
-0000ddf0: 7429 202d 3e20 696e 743a 0a20 2020 2020  t) -> int:.     
-0000de00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000de10: 6e20 7820 2b20 310a 0a20 2020 2020 2020  n x + 1..       
-0000de20: 2020 2020 2064 6566 206d 756c 5f74 776f       def mul_two
-0000de30: 2878 3a20 696e 7429 202d 3e20 696e 743a  (x: int) -> int:
-0000de40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000de50: 2072 6574 7572 6e20 7820 2a20 320a 0a20   return x * 2.. 
-0000de60: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-0000de70: 626c 655f 3120 3d20 5275 6e6e 6162 6c65  ble_1 = Runnable
-0000de80: 4c61 6d62 6461 2861 6464 5f6f 6e65 290a  Lambda(add_one).
-0000de90: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
-0000dea0: 6162 6c65 5f32 203d 2052 756e 6e61 626c  able_2 = Runnabl
-0000deb0: 654c 616d 6264 6128 6d75 6c5f 7477 6f29  eLambda(mul_two)
-0000dec0: 0a20 2020 2020 2020 2020 2020 2073 6571  .            seq
-0000ded0: 7565 6e63 6520 3d20 7275 6e6e 6162 6c65  uence = runnable
-0000dee0: 5f31 207c 2072 756e 6e61 626c 655f 320a  _1 | runnable_2.
-0000def0: 2020 2020 2020 2020 2020 2020 2320 4f72              # Or
-0000df00: 2065 7175 6976 616c 656e 746c 793a 0a20   equivalently:. 
-0000df10: 2020 2020 2020 2020 2020 2023 2073 6571             # seq
-0000df20: 7565 6e63 6520 3d20 5275 6e6e 6162 6c65  uence = Runnable
-0000df30: 5365 7175 656e 6365 2866 6972 7374 3d72  Sequence(first=r
-0000df40: 756e 6e61 626c 655f 312c 206c 6173 743d  unnable_1, last=
-0000df50: 7275 6e6e 6162 6c65 5f32 290a 2020 2020  runnable_2).    
-0000df60: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
-0000df70: 2e69 6e76 6f6b 6528 3129 0a20 2020 2020  .invoke(1).     
-0000df80: 2020 2020 2020 2061 7761 6974 2072 756e         await run
-0000df90: 6e61 626c 652e 6169 6e76 6f6b 6528 3129  nable.ainvoke(1)
-0000dfa0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0000dfb0: 7175 656e 6365 2e62 6174 6368 285b 312c  quence.batch([1,
-0000dfc0: 2032 2c20 335d 290a 2020 2020 2020 2020   2, 3]).        
-0000dfd0: 2020 2020 6177 6169 7420 7365 7175 656e      await sequen
-0000dfe0: 6365 2e61 6261 7463 6828 5b31 2c20 322c  ce.abatch([1, 2,
-0000dff0: 2033 5d29 0a0a 2020 2020 4865 7265 2773   3])..    Here's
-0000e000: 2061 6e20 6578 616d 706c 6520 7468 6174   an example that
-0000e010: 2075 7365 7320 7374 7265 616d 7320 4a53   uses streams JS
-0000e020: 4f4e 206f 7574 7075 7420 6765 6e65 7261  ON output genera
-0000e030: 7465 6420 6279 2061 6e20 4c4c 4d3a 0a0a  ted by an LLM:..
-0000e040: 2020 2020 2020 2020 2e2e 2063 6f64 652d          .. code-
-0000e050: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
-0000e060: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
-0000e070: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
-0000e080: 6f75 7470 7574 5f70 6172 7365 7273 2e6a  output_parsers.j
-0000e090: 736f 6e20 696d 706f 7274 2053 696d 706c  son import Simpl
-0000e0a0: 654a 736f 6e4f 7574 7075 7450 6172 7365  eJsonOutputParse
-0000e0b0: 720a 2020 2020 2020 2020 2020 2020 6672  r.            fr
-0000e0c0: 6f6d 206c 616e 6763 6861 696e 5f6f 7065  om langchain_ope
-0000e0d0: 6e61 6920 696d 706f 7274 2043 6861 744f  nai import ChatO
-0000e0e0: 7065 6e41 490a 0a20 2020 2020 2020 2020  penAI..         
-0000e0f0: 2020 2070 726f 6d70 7420 3d20 5072 6f6d     prompt = Prom
-0000e100: 7074 5465 6d70 6c61 7465 2e66 726f 6d5f  ptTemplate.from_
-0000e110: 7465 6d70 6c61 7465 280a 2020 2020 2020  template(.      
-0000e120: 2020 2020 2020 2020 2020 2749 6e20 4a53            'In JS
-0000e130: 4f4e 2066 6f72 6d61 742c 2067 6976 6520  ON format, give 
-0000e140: 6d65 2061 206c 6973 7420 6f66 207b 746f  me a list of {to
-0000e150: 7069 637d 2061 6e64 2074 6865 6972 2027  pic} and their '
-0000e160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e170: 2027 636f 7272 6573 706f 6e64 696e 6720   'corresponding 
-0000e180: 6e61 6d65 7320 696e 2046 7265 6e63 682c  names in French,
-0000e190: 2053 7061 6e69 7368 2061 6e64 2069 6e20   Spanish and in 
-0000e1a0: 6120 270a 2020 2020 2020 2020 2020 2020  a '.            
-0000e1b0: 2020 2020 2743 6174 204c 616e 6775 6167      'Cat Languag
-0000e1c0: 652e 270a 2020 2020 2020 2020 2020 2020  e.'.            
-0000e1d0: 290a 0a20 2020 2020 2020 2020 2020 206d  )..            m
-0000e1e0: 6f64 656c 203d 2043 6861 744f 7065 6e41  odel = ChatOpenA
-0000e1f0: 4928 290a 2020 2020 2020 2020 2020 2020  I().            
-0000e200: 6368 6169 6e20 3d20 7072 6f6d 7074 207c  chain = prompt |
-0000e210: 206d 6f64 656c 207c 2053 696d 706c 654a   model | SimpleJ
-0000e220: 736f 6e4f 7574 7075 7450 6172 7365 7228  sonOutputParser(
-0000e230: 290a 0a20 2020 2020 2020 2020 2020 2061  )..            a
-0000e240: 7379 6e63 2066 6f72 2063 6875 6e6b 2069  sync for chunk i
-0000e250: 6e20 6368 6169 6e2e 6173 7472 6561 6d28  n chain.astream(
-0000e260: 7b27 746f 7069 6327 3a20 2763 6f6c 6f72  {'topic': 'color
-0000e270: 7327 7d29 3a0a 2020 2020 2020 2020 2020  s'}):.          
-0000e280: 2020 2020 2020 7072 696e 7428 272d 2729        print('-')
-0000e290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e2a0: 2070 7269 6e74 2863 6875 6e6b 2c20 7365   print(chunk, se
-0000e2b0: 703d 2727 2c20 666c 7573 683d 5472 7565  p='', flush=True
-0000e2c0: 290a 2020 2020 2222 220a 0a20 2020 2023  ).    """..    #
-0000e2d0: 2054 6865 2073 7465 7073 2061 7265 2062   The steps are b
-0000e2e0: 726f 6b65 6e20 696e 746f 2066 6972 7374  roken into first
-0000e2f0: 2c20 6d69 6464 6c65 2061 6e64 206c 6173  , middle and las
-0000e300: 742c 2073 6f6c 656c 7920 666f 7220 7479  t, solely for ty
-0000e310: 7065 2063 6865 636b 696e 670a 2020 2020  pe checking.    
-0000e320: 2320 7075 7270 6f73 6573 2e20 4974 2061  # purposes. It a
-0000e330: 6c6c 6f77 7320 7370 6563 6966 7969 6e67  llows specifying
-0000e340: 2074 6865 2060 496e 7075 7460 206f 6e20   the `Input` on 
-0000e350: 7468 6520 6669 7273 7420 7479 7065 2c20  the first type, 
-0000e360: 7468 6520 604f 7574 7075 7460 206f 660a  the `Output` of.
-0000e370: 2020 2020 2320 7468 6520 6c61 7374 2074      # the last t
-0000e380: 7970 652e 0a20 2020 2066 6972 7374 3a20  ype..    first: 
-0000e390: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-0000e3a0: 416e 795d 0a20 2020 2022 2222 5468 6520  Any].    """The 
-0000e3b0: 6669 7273 7420 7275 6e6e 6162 6c65 2069  first runnable i
-0000e3c0: 6e20 7468 6520 7365 7175 656e 6365 2e22  n the sequence."
-0000e3d0: 2222 0a20 2020 206d 6964 646c 653a 204c  "".    middle: L
-0000e3e0: 6973 745b 5275 6e6e 6162 6c65 5b41 6e79  ist[Runnable[Any
-0000e3f0: 2c20 416e 795d 5d20 3d20 4669 656c 6428  , Any]] = Field(
-0000e400: 6465 6661 756c 745f 6661 6374 6f72 793d  default_factory=
-0000e410: 6c69 7374 290a 2020 2020 2222 2254 6865  list).    """The
-0000e420: 206d 6964 646c 6520 7275 6e6e 6162 6c65   middle runnable
-0000e430: 7320 696e 2074 6865 2073 6571 7565 6e63  s in the sequenc
-0000e440: 652e 2222 220a 2020 2020 6c61 7374 3a20  e.""".    last: 
-0000e450: 5275 6e6e 6162 6c65 5b41 6e79 2c20 4f75  Runnable[Any, Ou
-0000e460: 7470 7574 5d0a 2020 2020 2222 2254 6865  tput].    """The
-0000e470: 206c 6173 7420 7275 6e6e 6162 6c65 2069   last runnable i
-0000e480: 6e20 7468 6520 7365 7175 656e 6365 2e22  n the sequence."
-0000e490: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-0000e4a0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-0000e4b0: 6c66 2c0a 2020 2020 2020 2020 2a73 7465  lf,.        *ste
-0000e4c0: 7073 3a20 5275 6e6e 6162 6c65 4c69 6b65  ps: RunnableLike
-0000e4d0: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
-0000e4e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0000e4f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6669  None,.        fi
-0000e500: 7273 743a 204f 7074 696f 6e61 6c5b 5275  rst: Optional[Ru
-0000e510: 6e6e 6162 6c65 5b41 6e79 2c20 416e 795d  nnable[Any, Any]
-0000e520: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-0000e530: 2020 6d69 6464 6c65 3a20 4f70 7469 6f6e    middle: Option
-0000e540: 616c 5b4c 6973 745b 5275 6e6e 6162 6c65  al[List[Runnable
-0000e550: 5b41 6e79 2c20 416e 795d 5d5d 203d 204e  [Any, Any]]] = N
-0000e560: 6f6e 652c 0a20 2020 2020 2020 206c 6173  one,.        las
-0000e570: 743a 204f 7074 696f 6e61 6c5b 5275 6e6e  t: Optional[Runn
-0000e580: 6162 6c65 5b41 6e79 2c20 416e 795d 5d20  able[Any, Any]] 
-0000e590: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-0000e5a0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0000e5b0: 2222 4372 6561 7465 2061 206e 6577 2052  ""Create a new R
-0000e5c0: 756e 6e61 626c 6553 6571 7565 6e63 652e  unnableSequence.
-0000e5d0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-0000e5e0: 2020 2020 2020 2020 2020 2020 7374 6570              step
-0000e5f0: 733a 2054 6865 2073 7465 7073 2074 6f20  s: The steps to 
-0000e600: 696e 636c 7564 6520 696e 2074 6865 2073  include in the s
-0000e610: 6571 7565 6e63 652e 0a20 2020 2020 2020  equence..       
-0000e620: 2022 2222 0a20 2020 2020 2020 2073 7465   """.        ste
-0000e630: 7073 5f66 6c61 743a 204c 6973 745b 5275  ps_flat: List[Ru
-0000e640: 6e6e 6162 6c65 5d20 3d20 5b5d 0a20 2020  nnable] = [].   
-0000e650: 2020 2020 2069 6620 6e6f 7420 7374 6570       if not step
-0000e660: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0000e670: 6620 6669 7273 7420 6973 206e 6f74 204e  f first is not N
-0000e680: 6f6e 6520 616e 6420 6c61 7374 2069 7320  one and last is 
-0000e690: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000e6a0: 2020 2020 2020 2020 2020 7374 6570 735f            steps_
-0000e6b0: 666c 6174 203d 205b 6669 7273 745d 202b  flat = [first] +
-0000e6c0: 2028 6d69 6464 6c65 206f 7220 5b5d 2920   (middle or []) 
-0000e6d0: 2b20 5b6c 6173 745d 0a20 2020 2020 2020  + [last].       
-0000e6e0: 2066 6f72 2073 7465 7020 696e 2073 7465   for step in ste
-0000e6f0: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
-0000e700: 6966 2069 7369 6e73 7461 6e63 6528 7374  if isinstance(st
-0000e710: 6570 2c20 5275 6e6e 6162 6c65 5365 7175  ep, RunnableSequ
-0000e720: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000e730: 2020 2020 2020 2073 7465 7073 5f66 6c61         steps_fla
-0000e740: 742e 6578 7465 6e64 2873 7465 702e 7374  t.extend(step.st
-0000e750: 6570 7329 0a20 2020 2020 2020 2020 2020  eps).           
-0000e760: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000e770: 2020 2020 2020 2073 7465 7073 5f66 6c61         steps_fla
-0000e780: 742e 6170 7065 6e64 2863 6f65 7263 655f  t.append(coerce_
-0000e790: 746f 5f72 756e 6e61 626c 6528 7374 6570  to_runnable(step
-0000e7a0: 2929 0a20 2020 2020 2020 2069 6620 6c65  )).        if le
-0000e7b0: 6e28 7374 6570 735f 666c 6174 2920 3c20  n(steps_flat) < 
-0000e7c0: 323a 0a20 2020 2020 2020 2020 2020 2072  2:.            r
-0000e7d0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0000e7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e7f0: 2066 2252 756e 6e61 626c 6553 6571 7565   f"RunnableSeque
-0000e800: 6e63 6520 6d75 7374 2068 6176 6520 6174  nce must have at
-0000e810: 206c 6561 7374 2032 2073 7465 7073 2c20   least 2 steps, 
-0000e820: 676f 7420 7b6c 656e 2873 7465 7073 5f66  got {len(steps_f
-0000e830: 6c61 7429 7d22 0a20 2020 2020 2020 2020  lat)}".         
-0000e840: 2020 2029 0a20 2020 2020 2020 2073 7570     ).        sup
-0000e850: 6572 2829 2e5f 5f69 6e69 745f 5f28 0a20  er().__init__(. 
-0000e860: 2020 2020 2020 2020 2020 2066 6972 7374             first
-0000e870: 3d73 7465 7073 5f66 6c61 745b 305d 2c0a  =steps_flat[0],.
-0000e880: 2020 2020 2020 2020 2020 2020 6d69 6464              midd
-0000e890: 6c65 3d6c 6973 7428 7374 6570 735f 666c  le=list(steps_fl
-0000e8a0: 6174 5b31 3a2d 315d 292c 0a20 2020 2020  at[1:-1]),.     
-0000e8b0: 2020 2020 2020 206c 6173 743d 7374 6570         last=step
-0000e8c0: 735f 666c 6174 5b2d 315d 2c0a 2020 2020  s_flat[-1],.    
-0000e8d0: 2020 2020 2020 2020 6e61 6d65 3d6e 616d          name=nam
-0000e8e0: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-0000e8f0: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
-0000e900: 2020 2064 6566 2067 6574 5f6c 635f 6e61     def get_lc_na
-0000e910: 6d65 7370 6163 6528 636c 7329 202d 3e20  mespace(cls) -> 
-0000e920: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
-0000e930: 2020 2022 2222 4765 7420 7468 6520 6e61     """Get the na
-0000e940: 6d65 7370 6163 6520 6f66 2074 6865 206c  mespace of the l
-0000e950: 616e 6763 6861 696e 206f 626a 6563 742e  angchain object.
-0000e960: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-0000e970: 726e 205b 226c 616e 6763 6861 696e 222c  rn ["langchain",
-0000e980: 2022 7363 6865 6d61 222c 2022 7275 6e6e   "schema", "runn
-0000e990: 6162 6c65 225d 0a0a 2020 2020 4070 726f  able"]..    @pro
-0000e9a0: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
-0000e9b0: 6570 7328 7365 6c66 2920 2d3e 204c 6973  eps(self) -> Lis
-0000e9c0: 745b 5275 6e6e 6162 6c65 5b41 6e79 2c20  t[Runnable[Any, 
-0000e9d0: 416e 795d 5d3a 0a20 2020 2020 2020 2022  Any]]:.        "
-0000e9e0: 2222 416c 6c20 7468 6520 7275 6e6e 6162  ""All the runnab
-0000e9f0: 6c65 7320 7468 6174 206d 616b 6520 7570  les that make up
-0000ea00: 2074 6865 2073 6571 7565 6e63 6520 696e   the sequence in
-0000ea10: 206f 7264 6572 2e22 2222 0a20 2020 2020   order.""".     
-0000ea20: 2020 2072 6574 7572 6e20 5b73 656c 662e     return [self.
-0000ea30: 6669 7273 745d 202b 2073 656c 662e 6d69  first] + self.mi
-0000ea40: 6464 6c65 202b 205b 7365 6c66 2e6c 6173  ddle + [self.las
-0000ea50: 745d 0a0a 2020 2020 4063 6c61 7373 6d65  t]..    @classme
-0000ea60: 7468 6f64 0a20 2020 2064 6566 2069 735f  thod.    def is_
-0000ea70: 6c63 5f73 6572 6961 6c69 7a61 626c 6528  lc_serializable(
-0000ea80: 636c 7329 202d 3e20 626f 6f6c 3a0a 2020  cls) -> bool:.  
-0000ea90: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0000eaa0: 650a 0a20 2020 2063 6c61 7373 2043 6f6e  e..    class Con
-0000eab0: 6669 673a 0a20 2020 2020 2020 2061 7262  fig:.        arb
-0000eac0: 6974 7261 7279 5f74 7970 6573 5f61 6c6c  itrary_types_all
-0000ead0: 6f77 6564 203d 2054 7275 650a 0a20 2020  owed = True..   
-0000eae0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0000eaf0: 6566 2049 6e70 7574 5479 7065 2873 656c  ef InputType(sel
-0000eb00: 6629 202d 3e20 5479 7065 5b49 6e70 7574  f) -> Type[Input
-0000eb10: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-0000eb20: 6e20 7365 6c66 2e66 6972 7374 2e49 6e70  n self.first.Inp
-0000eb30: 7574 5479 7065 0a0a 2020 2020 4070 726f  utType..    @pro
-0000eb40: 7065 7274 790a 2020 2020 6465 6620 4f75  perty.    def Ou
-0000eb50: 7470 7574 5479 7065 2873 656c 6629 202d  tputType(self) -
-0000eb60: 3e20 5479 7065 5b4f 7574 7075 745d 3a0a  > Type[Output]:.
-0000eb70: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000eb80: 656c 662e 6c61 7374 2e4f 7574 7075 7454  elf.last.OutputT
-0000eb90: 7970 650a 0a20 2020 2064 6566 2067 6574  ype..    def get
-0000eba0: 5f69 6e70 7574 5f73 6368 656d 6128 0a20  _input_schema(. 
-0000ebb0: 2020 2020 2020 2073 656c 662c 2063 6f6e         self, con
-0000ebc0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-0000ebd0: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
-0000ebe0: 4e6f 6e65 0a20 2020 2029 202d 3e20 5479  None.    ) -> Ty
-0000ebf0: 7065 5b42 6173 654d 6f64 656c 5d3a 0a20  pe[BaseModel]:. 
-0000ec00: 2020 2020 2020 2072 6574 7572 6e20 5f73         return _s
-0000ec10: 6571 5f69 6e70 7574 5f73 6368 656d 6128  eq_input_schema(
-0000ec20: 7365 6c66 2e73 7465 7073 2c20 636f 6e66  self.steps, conf
-0000ec30: 6967 290a 0a20 2020 2064 6566 2067 6574  ig)..    def get
-0000ec40: 5f6f 7574 7075 745f 7363 6865 6d61 280a  _output_schema(.
-0000ec50: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
-0000ec60: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-0000ec70: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-0000ec80: 204e 6f6e 650a 2020 2020 2920 2d3e 2054   None.    ) -> T
-0000ec90: 7970 655b 4261 7365 4d6f 6465 6c5d 3a0a  ype[BaseModel]:.
-0000eca0: 2020 2020 2020 2020 7265 7475 726e 205f          return _
-0000ecb0: 7365 715f 6f75 7470 7574 5f73 6368 656d  seq_output_schem
-0000ecc0: 6128 7365 6c66 2e73 7465 7073 2c20 636f  a(self.steps, co
-0000ecd0: 6e66 6967 290a 0a20 2020 2040 7072 6f70  nfig)..    @prop
-0000ece0: 6572 7479 0a20 2020 2064 6566 2063 6f6e  erty.    def con
-0000ecf0: 6669 675f 7370 6563 7328 7365 6c66 2920  fig_specs(self) 
-0000ed00: 2d3e 204c 6973 745b 436f 6e66 6967 7572  -> List[Configur
-0000ed10: 6162 6c65 4669 656c 6453 7065 635d 3a0a  ableFieldSpec]:.
-0000ed20: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-0000ed30: 6763 6861 696e 5f63 6f72 652e 6265 7461  gchain_core.beta
-0000ed40: 2e72 756e 6e61 626c 6573 2e63 6f6e 7465  .runnables.conte
-0000ed50: 7874 2069 6d70 6f72 7420 280a 2020 2020  xt import (.    
-0000ed60: 2020 2020 2020 2020 434f 4e54 4558 545f          CONTEXT_
-0000ed70: 434f 4e46 4947 5f50 5245 4649 582c 0a20  CONFIG_PREFIX,. 
-0000ed80: 2020 2020 2020 2020 2020 205f 6b65 795f             _key_
-0000ed90: 6672 6f6d 5f69 642c 0a20 2020 2020 2020  from_id,.       
-0000eda0: 2029 0a0a 2020 2020 2020 2020 2320 6765   )..        # ge
-0000edb0: 7420 616c 6c20 7370 6563 730a 2020 2020  t all specs.    
-0000edc0: 2020 2020 616c 6c5f 7370 6563 7320 3d20      all_specs = 
-0000edd0: 5b0a 2020 2020 2020 2020 2020 2020 2873  [.            (s
-0000ede0: 7065 632c 2069 6478 290a 2020 2020 2020  pec, idx).      
-0000edf0: 2020 2020 2020 666f 7220 6964 782c 2073        for idx, s
-0000ee00: 7465 7020 696e 2065 6e75 6d65 7261 7465  tep in enumerate
-0000ee10: 2873 656c 662e 7374 6570 7329 0a20 2020  (self.steps).   
-0000ee20: 2020 2020 2020 2020 2066 6f72 2073 7065           for spe
-0000ee30: 6320 696e 2073 7465 702e 636f 6e66 6967  c in step.config
-0000ee40: 5f73 7065 6373 0a20 2020 2020 2020 205d  _specs.        ]
-0000ee50: 0a20 2020 2020 2020 2023 2063 616c 6375  .        # calcu
-0000ee60: 6c61 7465 2063 6f6e 7465 7874 2064 6570  late context dep
-0000ee70: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
-0000ee80: 2020 7370 6563 735f 6279 5f70 6f73 203d    specs_by_pos =
-0000ee90: 2067 726f 7570 6279 280a 2020 2020 2020   groupby(.      
-0000eea0: 2020 2020 2020 5b74 7570 2066 6f72 2074        [tup for t
-0000eeb0: 7570 2069 6e20 616c 6c5f 7370 6563 7320  up in all_specs 
-0000eec0: 6966 2074 7570 5b30 5d2e 6964 2e73 7461  if tup[0].id.sta
-0000eed0: 7274 7377 6974 6828 434f 4e54 4558 545f  rtswith(CONTEXT_
-0000eee0: 434f 4e46 4947 5f50 5245 4649 5829 5d2c  CONFIG_PREFIX)],
-0000eef0: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-0000ef00: 6264 6120 783a 2078 5b31 5d2c 0a20 2020  bda x: x[1],.   
-0000ef10: 2020 2020 2029 0a20 2020 2020 2020 206e       ).        n
-0000ef20: 6578 745f 6465 7073 3a20 5365 745b 7374  ext_deps: Set[st
-0000ef30: 725d 203d 2073 6574 2829 0a20 2020 2020  r] = set().     
-0000ef40: 2020 2064 6570 735f 6279 5f70 6f73 3a20     deps_by_pos: 
-0000ef50: 4469 6374 5b69 6e74 2c20 5365 745b 7374  Dict[int, Set[st
-0000ef60: 725d 5d20 3d20 7b7d 0a20 2020 2020 2020  r]] = {}.       
-0000ef70: 2066 6f72 2070 6f73 2c20 7370 6563 7320   for pos, specs 
-0000ef80: 696e 2073 7065 6373 5f62 795f 706f 733a  in specs_by_pos:
-0000ef90: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
-0000efa0: 735f 6279 5f70 6f73 5b70 6f73 5d20 3d20  s_by_pos[pos] = 
-0000efb0: 6e65 7874 5f64 6570 730a 2020 2020 2020  next_deps.      
-0000efc0: 2020 2020 2020 6e65 7874 5f64 6570 7320        next_deps 
-0000efd0: 3d20 6e65 7874 5f64 6570 7320 7c20 7b73  = next_deps | {s
-0000efe0: 7065 635b 305d 2e69 6420 666f 7220 7370  pec[0].id for sp
-0000eff0: 6563 2069 6e20 7370 6563 737d 0a20 2020  ec in specs}.   
-0000f000: 2020 2020 2023 2061 7373 6967 6e20 636f       # assign co
-0000f010: 6e74 6578 7420 6465 7065 6e64 656e 6369  ntext dependenci
-0000f020: 6573 0a20 2020 2020 2020 2066 6f72 2070  es.        for p
-0000f030: 6f73 2c20 2873 7065 632c 2069 6478 2920  os, (spec, idx) 
-0000f040: 696e 2065 6e75 6d65 7261 7465 2861 6c6c  in enumerate(all
-0000f050: 5f73 7065 6373 293a 0a20 2020 2020 2020  _specs):.       
-0000f060: 2020 2020 2069 6620 7370 6563 2e69 642e       if spec.id.
-0000f070: 7374 6172 7473 7769 7468 2843 4f4e 5445  startswith(CONTE
-0000f080: 5854 5f43 4f4e 4649 475f 5052 4546 4958  XT_CONFIG_PREFIX
-0000f090: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000f0a0: 2020 2061 6c6c 5f73 7065 6373 5b70 6f73     all_specs[pos
-0000f0b0: 5d20 3d20 280a 2020 2020 2020 2020 2020  ] = (.          
-0000f0c0: 2020 2020 2020 2020 2020 436f 6e66 6967            Config
-0000f0d0: 7572 6162 6c65 4669 656c 6453 7065 6328  urableFieldSpec(
-0000f0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f0f0: 2020 2020 2020 2020 2069 643d 7370 6563           id=spec
-0000f100: 2e69 642c 0a20 2020 2020 2020 2020 2020  .id,.           
-0000f110: 2020 2020 2020 2020 2020 2020 2061 6e6e               ann
-0000f120: 6f74 6174 696f 6e3d 7370 6563 2e61 6e6e  otation=spec.ann
-0000f130: 6f74 6174 696f 6e2c 0a20 2020 2020 2020  otation,.       
-0000f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f150: 206e 616d 653d 7370 6563 2e6e 616d 652c   name=spec.name,
-0000f160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f170: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-0000f180: 3d73 7065 632e 6465 6661 756c 742c 0a20  =spec.default,. 
-0000f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1a0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-0000f1b0: 6f6e 3d73 7065 632e 6465 7363 7269 7074  on=spec.descript
-0000f1c0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0000f1d0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-0000f1e0: 7368 6172 6564 3d73 7065 632e 6973 5f73  shared=spec.is_s
-0000f1f0: 6861 7265 642c 0a20 2020 2020 2020 2020  hared,.         
-0000f200: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000f210: 6570 656e 6465 6e63 6965 733d 5b0a 2020  ependencies=[.  
-0000f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f230: 2020 2020 2020 2020 2020 640a 2020 2020            d.    
-0000f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f250: 2020 2020 2020 2020 666f 7220 6420 696e          for d in
-0000f260: 2064 6570 735f 6279 5f70 6f73 5b69 6478   deps_by_pos[idx
-0000f270: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000f280: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000f290: 205f 6b65 795f 6672 6f6d 5f69 6428 6429   _key_from_id(d)
-0000f2a0: 2021 3d20 5f6b 6579 5f66 726f 6d5f 6964   != _key_from_id
-0000f2b0: 2873 7065 632e 6964 290a 2020 2020 2020  (spec.id).      
-0000f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2d0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-0000f2e0: 2020 2020 2020 2020 2020 2020 2b20 2873              + (s
-0000f2f0: 7065 632e 6465 7065 6e64 656e 6369 6573  pec.dependencies
-0000f300: 206f 7220 5b5d 292c 0a20 2020 2020 2020   or []),.       
-0000f310: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-0000f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f330: 2020 2020 6964 782c 0a20 2020 2020 2020      idx,.       
-0000f340: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000f350: 2020 2020 7265 7475 726e 2067 6574 5f75      return get_u
-0000f360: 6e69 7175 655f 636f 6e66 6967 5f73 7065  nique_config_spe
-0000f370: 6373 2873 7065 6320 666f 7220 7370 6563  cs(spec for spec
-0000f380: 2c20 5f20 696e 2061 6c6c 5f73 7065 6373  , _ in all_specs
-0000f390: 290a 0a20 2020 2064 6566 2067 6574 5f67  )..    def get_g
-0000f3a0: 7261 7068 2873 656c 662c 2063 6f6e 6669  raph(self, confi
-0000f3b0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-0000f3c0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-0000f3d0: 6e65 2920 2d3e 2047 7261 7068 3a0a 2020  ne) -> Graph:.  
-0000f3e0: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
-0000f3f0: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
-0000f400: 6c65 732e 6772 6170 6820 696d 706f 7274  les.graph import
-0000f410: 2047 7261 7068 0a0a 2020 2020 2020 2020   Graph..        
-0000f420: 6772 6170 6820 3d20 4772 6170 6828 290a  graph = Graph().
-0000f430: 2020 2020 2020 2020 666f 7220 7374 6570          for step
-0000f440: 2069 6e20 7365 6c66 2e73 7465 7073 3a0a   in self.steps:.
-0000f450: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-0000f460: 656e 745f 6c61 7374 5f6e 6f64 6520 3d20  ent_last_node = 
-0000f470: 6772 6170 682e 6c61 7374 5f6e 6f64 6528  graph.last_node(
-0000f480: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-0000f490: 6570 5f67 7261 7068 203d 2073 7465 702e  ep_graph = step.
-0000f4a0: 6765 745f 6772 6170 6828 636f 6e66 6967  get_graph(config
-0000f4b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000f4c0: 2073 7465 7020 6973 206e 6f74 2073 656c   step is not sel
-0000f4d0: 662e 6669 7273 743a 0a20 2020 2020 2020  f.first:.       
-0000f4e0: 2020 2020 2020 2020 2073 7465 705f 6772           step_gr
-0000f4f0: 6170 682e 7472 696d 5f66 6972 7374 5f6e  aph.trim_first_n
-0000f500: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
-0000f510: 2020 6966 2073 7465 7020 6973 206e 6f74    if step is not
-0000f520: 2073 656c 662e 6c61 7374 3a0a 2020 2020   self.last:.    
-0000f530: 2020 2020 2020 2020 2020 2020 7374 6570              step
-0000f540: 5f67 7261 7068 2e74 7269 6d5f 6c61 7374  _graph.trim_last
-0000f550: 5f6e 6f64 6528 290a 2020 2020 2020 2020  _node().        
-0000f560: 2020 2020 6772 6170 682e 6578 7465 6e64      graph.extend
-0000f570: 2873 7465 705f 6772 6170 6829 0a20 2020  (step_graph).   
-0000f580: 2020 2020 2020 2020 2073 7465 705f 6669           step_fi
-0000f590: 7273 745f 6e6f 6465 203d 2073 7465 705f  rst_node = step_
-0000f5a0: 6772 6170 682e 6669 7273 745f 6e6f 6465  graph.first_node
-0000f5b0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-0000f5c0: 6620 6e6f 7420 7374 6570 5f66 6972 7374  f not step_first
-0000f5d0: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
-0000f5e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0000f5f0: 7565 4572 726f 7228 6622 5275 6e6e 6162  ueError(f"Runnab
-0000f600: 6c65 207b 7374 6570 7d20 6861 7320 6e6f  le {step} has no
-0000f610: 2066 6972 7374 206e 6f64 6522 290a 2020   first node").  
-0000f620: 2020 2020 2020 2020 2020 6966 2063 7572            if cur
-0000f630: 7265 6e74 5f6c 6173 745f 6e6f 6465 3a0a  rent_last_node:.
-0000f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f650: 6772 6170 682e 6164 645f 6564 6765 2863  graph.add_edge(c
-0000f660: 7572 7265 6e74 5f6c 6173 745f 6e6f 6465  urrent_last_node
-0000f670: 2c20 7374 6570 5f66 6972 7374 5f6e 6f64  , step_first_nod
-0000f680: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
-0000f690: 726e 2067 7261 7068 0a0a 2020 2020 6465  rn graph..    de
-0000f6a0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-0000f6b0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0000f6c0: 2072 6574 7572 6e20 225c 6e7c 2022 2e6a   return "\n| ".j
-0000f6d0: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
-0000f6e0: 2072 6570 7228 7329 2069 6620 6920 3d3d   repr(s) if i ==
-0000f6f0: 2030 2065 6c73 6520 696e 6465 6e74 5f6c   0 else indent_l
-0000f700: 696e 6573 5f61 6674 6572 5f66 6972 7374  ines_after_first
-0000f710: 2872 6570 7228 7329 2c20 227c 2022 290a  (repr(s), "| ").
-0000f720: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000f730: 692c 2073 2069 6e20 656e 756d 6572 6174  i, s in enumerat
-0000f740: 6528 7365 6c66 2e73 7465 7073 290a 2020  e(self.steps).  
-0000f750: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0000f760: 205f 5f6f 725f 5f28 0a20 2020 2020 2020   __or__(.       
-0000f770: 2073 656c 662c 0a20 2020 2020 2020 206f   self,.        o
-0000f780: 7468 6572 3a20 556e 696f 6e5b 0a20 2020  ther: Union[.   
-0000f790: 2020 2020 2020 2020 2052 756e 6e61 626c           Runnabl
-0000f7a0: 655b 416e 792c 204f 7468 6572 5d2c 0a20  e[Any, Other],. 
-0000f7b0: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-0000f7c0: 626c 655b 5b41 6e79 5d2c 204f 7468 6572  ble[[Any], Other
-0000f7d0: 5d2c 0a20 2020 2020 2020 2020 2020 2043  ],.            C
-0000f7e0: 616c 6c61 626c 655b 5b49 7465 7261 746f  allable[[Iterato
-0000f7f0: 725b 416e 795d 5d2c 2049 7465 7261 746f  r[Any]], Iterato
-0000f800: 725b 4f74 6865 725d 5d2c 0a20 2020 2020  r[Other]],.     
-0000f810: 2020 2020 2020 204d 6170 7069 6e67 5b73         Mapping[s
-0000f820: 7472 2c20 556e 696f 6e5b 5275 6e6e 6162  tr, Union[Runnab
-0000f830: 6c65 5b41 6e79 2c20 4f74 6865 725d 2c20  le[Any, Other], 
-0000f840: 4361 6c6c 6162 6c65 5b5b 416e 795d 2c20  Callable[[Any], 
-0000f850: 4f74 6865 725d 2c20 416e 795d 5d2c 0a20  Other], Any]],. 
-0000f860: 2020 2020 2020 205d 2c0a 2020 2020 2920         ],.    ) 
-0000f870: 2d3e 2052 756e 6e61 626c 6553 6572 6961  -> RunnableSeria
-0000f880: 6c69 7a61 626c 655b 496e 7075 742c 204f  lizable[Input, O
-0000f890: 7468 6572 5d3a 0a20 2020 2020 2020 2069  ther]:.        i
-0000f8a0: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000f8b0: 6572 2c20 5275 6e6e 6162 6c65 5365 7175  er, RunnableSequ
-0000f8c0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000f8d0: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
-0000f8e0: 6c65 5365 7175 656e 6365 280a 2020 2020  leSequence(.    
-0000f8f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f900: 2e66 6972 7374 2c0a 2020 2020 2020 2020  .first,.        
-0000f910: 2020 2020 2020 2020 2a73 656c 662e 6d69          *self.mi
-0000f920: 6464 6c65 2c0a 2020 2020 2020 2020 2020  ddle,.          
-0000f930: 2020 2020 2020 7365 6c66 2e6c 6173 742c        self.last,
-0000f940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f950: 206f 7468 6572 2e66 6972 7374 2c0a 2020   other.first,.  
-0000f960: 2020 2020 2020 2020 2020 2020 2020 2a6f                *o
-0000f970: 7468 6572 2e6d 6964 646c 652c 0a20 2020  ther.middle,.   
-0000f980: 2020 2020 2020 2020 2020 2020 206f 7468               oth
-0000f990: 6572 2e6c 6173 742c 0a20 2020 2020 2020  er.last,.       
-0000f9a0: 2020 2020 2020 2020 206e 616d 653d 7365           name=se
-0000f9b0: 6c66 2e6e 616d 6520 6f72 206f 7468 6572  lf.name or other
-0000f9c0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-0000f9d0: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-0000f9e0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000f9f0: 6574 7572 6e20 5275 6e6e 6162 6c65 5365  eturn RunnableSe
-0000fa00: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
-0000fa10: 2020 2020 2020 2020 7365 6c66 2e66 6972          self.fir
-0000fa20: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
-0000fa30: 2020 2020 2a73 656c 662e 6d69 6464 6c65      *self.middle
-0000fa40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa50: 2020 7365 6c66 2e6c 6173 742c 0a20 2020    self.last,.   
-0000fa60: 2020 2020 2020 2020 2020 2020 2063 6f65               coe
-0000fa70: 7263 655f 746f 5f72 756e 6e61 626c 6528  rce_to_runnable(
-0000fa80: 6f74 6865 7229 2c0a 2020 2020 2020 2020  other),.        
-0000fa90: 2020 2020 2020 2020 6e61 6d65 3d73 656c          name=sel
-0000faa0: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
-0000fab0: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
-0000fac0: 5f72 6f72 5f5f 280a 2020 2020 2020 2020  _ror__(.        
-0000fad0: 7365 6c66 2c0a 2020 2020 2020 2020 6f74  self,.        ot
-0000fae0: 6865 723a 2055 6e69 6f6e 5b0a 2020 2020  her: Union[.    
-0000faf0: 2020 2020 2020 2020 5275 6e6e 6162 6c65          Runnable
-0000fb00: 5b4f 7468 6572 2c20 416e 795d 2c0a 2020  [Other, Any],.  
-0000fb10: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-0000fb20: 6c65 5b5b 4f74 6865 725d 2c20 416e 795d  le[[Other], Any]
-0000fb30: 2c0a 2020 2020 2020 2020 2020 2020 4361  ,.            Ca
-0000fb40: 6c6c 6162 6c65 5b5b 4974 6572 6174 6f72  llable[[Iterator
-0000fb50: 5b4f 7468 6572 5d5d 2c20 4974 6572 6174  [Other]], Iterat
-0000fb60: 6f72 5b41 6e79 5d5d 2c0a 2020 2020 2020  or[Any]],.      
-0000fb70: 2020 2020 2020 4d61 7070 696e 675b 7374        Mapping[st
-0000fb80: 722c 2055 6e69 6f6e 5b52 756e 6e61 626c  r, Union[Runnabl
-0000fb90: 655b 4f74 6865 722c 2041 6e79 5d2c 2043  e[Other, Any], C
-0000fba0: 616c 6c61 626c 655b 5b4f 7468 6572 5d2c  allable[[Other],
-0000fbb0: 2041 6e79 5d2c 2041 6e79 5d5d 2c0a 2020   Any], Any]],.  
-0000fbc0: 2020 2020 2020 5d2c 0a20 2020 2029 202d        ],.    ) -
-0000fbd0: 3e20 5275 6e6e 6162 6c65 5365 7269 616c  > RunnableSerial
-0000fbe0: 697a 6162 6c65 5b4f 7468 6572 2c20 4f75  izable[Other, Ou
-0000fbf0: 7470 7574 5d3a 0a20 2020 2020 2020 2069  tput]:.        i
-0000fc00: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000fc10: 6572 2c20 5275 6e6e 6162 6c65 5365 7175  er, RunnableSequ
-0000fc20: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000fc30: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
-0000fc40: 6c65 5365 7175 656e 6365 280a 2020 2020  leSequence(.    
-0000fc50: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
-0000fc60: 722e 6669 7273 742c 0a20 2020 2020 2020  r.first,.       
-0000fc70: 2020 2020 2020 2020 202a 6f74 6865 722e           *other.
-0000fc80: 6d69 6464 6c65 2c0a 2020 2020 2020 2020  middle,.        
-0000fc90: 2020 2020 2020 2020 6f74 6865 722e 6c61          other.la
-0000fca0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
-0000fcb0: 2020 2020 7365 6c66 2e66 6972 7374 2c0a      self.first,.
-0000fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcd0: 2a73 656c 662e 6d69 6464 6c65 2c0a 2020  *self.middle,.  
-0000fce0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000fcf0: 6c66 2e6c 6173 742c 0a20 2020 2020 2020  lf.last,.       
-0000fd00: 2020 2020 2020 2020 206e 616d 653d 6f74           name=ot
-0000fd10: 6865 722e 6e61 6d65 206f 7220 7365 6c66  her.name or self
-0000fd20: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-0000fd30: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-0000fd40: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000fd50: 6574 7572 6e20 5275 6e6e 6162 6c65 5365  eturn RunnableSe
-0000fd60: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
-0000fd70: 2020 2020 2020 2020 636f 6572 6365 5f74          coerce_t
-0000fd80: 6f5f 7275 6e6e 6162 6c65 286f 7468 6572  o_runnable(other
-0000fd90: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0000fda0: 2020 2073 656c 662e 6669 7273 742c 0a20     self.first,. 
-0000fdb0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-0000fdc0: 7365 6c66 2e6d 6964 646c 652c 0a20 2020  self.middle,.   
-0000fdd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000fde0: 662e 6c61 7374 2c0a 2020 2020 2020 2020  f.last,.        
-0000fdf0: 2020 2020 2020 2020 6e61 6d65 3d73 656c          name=sel
-0000fe00: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
-0000fe10: 2020 2020 290a 0a20 2020 2064 6566 2069      )..    def i
-0000fe20: 6e76 6f6b 6528 7365 6c66 2c20 696e 7075  nvoke(self, inpu
-0000fe30: 743a 2049 6e70 7574 2c20 636f 6e66 6967  t: Input, config
-0000fe40: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-0000fe50: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-0000fe60: 6529 202d 3e20 4f75 7470 7574 3a0a 2020  e) -> Output:.  
-0000fe70: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
-0000fe80: 6861 696e 5f63 6f72 652e 6265 7461 2e72  hain_core.beta.r
-0000fe90: 756e 6e61 626c 6573 2e63 6f6e 7465 7874  unnables.context
-0000fea0: 2069 6d70 6f72 7420 636f 6e66 6967 5f77   import config_w
-0000feb0: 6974 685f 636f 6e74 6578 740a 0a20 2020  ith_context..   
-0000fec0: 2020 2020 2023 2073 6574 7570 2063 616c       # setup cal
-0000fed0: 6c62 6163 6b73 2061 6e64 2063 6f6e 7465  lbacks and conte
-0000fee0: 7874 0a20 2020 2020 2020 2063 6f6e 6669  xt.        confi
-0000fef0: 6720 3d20 636f 6e66 6967 5f77 6974 685f  g = config_with_
-0000ff00: 636f 6e74 6578 7428 656e 7375 7265 5f63  context(ensure_c
-0000ff10: 6f6e 6669 6728 636f 6e66 6967 292c 2073  onfig(config), s
-0000ff20: 656c 662e 7374 6570 7329 0a20 2020 2020  elf.steps).     
-0000ff30: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
-0000ff40: 6765 7220 3d20 6765 745f 6361 6c6c 6261  ger = get_callba
-0000ff50: 636b 5f6d 616e 6167 6572 5f66 6f72 5f63  ck_manager_for_c
-0000ff60: 6f6e 6669 6728 636f 6e66 6967 290a 2020  onfig(config).  
-0000ff70: 2020 2020 2020 2320 7374 6172 7420 7468        # start th
-0000ff80: 6520 726f 6f74 2072 756e 0a20 2020 2020  e root run.     
-0000ff90: 2020 2072 756e 5f6d 616e 6167 6572 203d     run_manager =
-0000ffa0: 2063 616c 6c62 6163 6b5f 6d61 6e61 6765   callback_manage
-0000ffb0: 722e 6f6e 5f63 6861 696e 5f73 7461 7274  r.on_chain_start
-0000ffc0: 280a 2020 2020 2020 2020 2020 2020 6475  (.            du
-0000ffd0: 6d70 6428 7365 6c66 292c 2069 6e70 7574  mpd(self), input
-0000ffe0: 2c20 6e61 6d65 3d63 6f6e 6669 672e 6765  , name=config.ge
-0000fff0: 7428 2272 756e 5f6e 616d 6522 2920 6f72  t("run_name") or
-00010000: 2073 656c 662e 6765 745f 6e61 6d65 2829   self.get_name()
-00010010: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00010020: 2020 2020 2320 696e 766f 6b65 2061 6c6c      # invoke all
-00010030: 2073 7465 7073 2069 6e20 7365 7175 656e   steps in sequen
-00010040: 6365 0a20 2020 2020 2020 2074 7279 3a0a  ce.        try:.
-00010050: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00010060: 692c 2073 7465 7020 696e 2065 6e75 6d65  i, step in enume
-00010070: 7261 7465 2873 656c 662e 7374 6570 7329  rate(self.steps)
-00010080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010090: 2020 696e 7075 7420 3d20 7374 6570 2e69    input = step.i
-000100a0: 6e76 6f6b 6528 0a20 2020 2020 2020 2020  nvoke(.         
-000100b0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-000100c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000100d0: 2020 2020 2020 2320 6d61 726b 2065 6163        # mark eac
-000100e0: 6820 7374 6570 2061 7320 6120 6368 696c  h step as a chil
-000100f0: 6420 7275 6e0a 2020 2020 2020 2020 2020  d run.          
-00010100: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
-00010110: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
-00010120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010130: 636f 6e66 6967 2c20 6361 6c6c 6261 636b  config, callback
-00010140: 733d 7275 6e5f 6d61 6e61 6765 722e 6765  s=run_manager.ge
-00010150: 745f 6368 696c 6428 6622 7365 713a 7374  t_child(f"seq:st
-00010160: 6570 3a7b 692b 317d 2229 0a20 2020 2020  ep:{i+1}").     
-00010170: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00010180: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010190: 2020 290a 2020 2020 2020 2020 2320 6669    ).        # fi
-000101a0: 6e69 7368 2074 6865 2072 6f6f 7420 7275  nish the root ru
-000101b0: 6e0a 2020 2020 2020 2020 6578 6365 7074  n.        except
-000101c0: 2042 6173 6545 7863 6570 7469 6f6e 2061   BaseException a
-000101d0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-000101e0: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
-000101f0: 6368 6169 6e5f 6572 726f 7228 6529 0a20  chain_error(e). 
-00010200: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00010210: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00010220: 2020 2020 2020 2020 2020 2072 756e 5f6d             run_m
-00010230: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-00010240: 656e 6428 696e 7075 7429 0a20 2020 2020  end(input).     
-00010250: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-00010260: 7374 284f 7574 7075 742c 2069 6e70 7574  st(Output, input
-00010270: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-00010280: 2061 696e 766f 6b65 280a 2020 2020 2020   ainvoke(.      
-00010290: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000102a0: 696e 7075 743a 2049 6e70 7574 2c0a 2020  input: Input,.  
-000102b0: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
-000102c0: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-000102d0: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
-000102e0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-000102f0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
-00010300: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
-00010310: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-00010320: 6e67 6368 6169 6e5f 636f 7265 2e62 6574  ngchain_core.bet
-00010330: 612e 7275 6e6e 6162 6c65 732e 636f 6e74  a.runnables.cont
-00010340: 6578 7420 696d 706f 7274 2061 636f 6e66  ext import aconf
-00010350: 6967 5f77 6974 685f 636f 6e74 6578 740a  ig_with_context.
-00010360: 0a20 2020 2020 2020 2023 2073 6574 7570  .        # setup
-00010370: 2063 616c 6c62 6163 6b73 2061 6e64 2063   callbacks and c
-00010380: 6f6e 7465 7874 0a20 2020 2020 2020 2063  ontext.        c
-00010390: 6f6e 6669 6720 3d20 6163 6f6e 6669 675f  onfig = aconfig_
-000103a0: 7769 7468 5f63 6f6e 7465 7874 2865 6e73  with_context(ens
-000103b0: 7572 655f 636f 6e66 6967 2863 6f6e 6669  ure_config(confi
-000103c0: 6729 2c20 7365 6c66 2e73 7465 7073 290a  g), self.steps).
-000103d0: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
-000103e0: 5f6d 616e 6167 6572 203d 2067 6574 5f61  _manager = get_a
-000103f0: 7379 6e63 5f63 616c 6c62 6163 6b5f 6d61  sync_callback_ma
-00010400: 6e61 6765 725f 666f 725f 636f 6e66 6967  nager_for_config
-00010410: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
-00010420: 2023 2073 7461 7274 2074 6865 2072 6f6f   # start the roo
-00010430: 7420 7275 6e0a 2020 2020 2020 2020 7275  t run.        ru
-00010440: 6e5f 6d61 6e61 6765 7220 3d20 6177 6169  n_manager = awai
-00010450: 7420 6361 6c6c 6261 636b 5f6d 616e 6167  t callback_manag
-00010460: 6572 2e6f 6e5f 6368 6169 6e5f 7374 6172  er.on_chain_star
-00010470: 7428 0a20 2020 2020 2020 2020 2020 2064  t(.            d
-00010480: 756d 7064 2873 656c 6629 2c20 696e 7075  umpd(self), inpu
-00010490: 742c 206e 616d 653d 636f 6e66 6967 2e67  t, name=config.g
-000104a0: 6574 2822 7275 6e5f 6e61 6d65 2229 206f  et("run_name") o
-000104b0: 7220 7365 6c66 2e67 6574 5f6e 616d 6528  r self.get_name(
-000104c0: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-000104d0: 2020 2020 2023 2069 6e76 6f6b 6520 616c       # invoke al
-000104e0: 6c20 7374 6570 7320 696e 2073 6571 7565  l steps in seque
-000104f0: 6e63 650a 2020 2020 2020 2020 7472 793a  nce.        try:
-00010500: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00010510: 2069 2c20 7374 6570 2069 6e20 656e 756d   i, step in enum
-00010520: 6572 6174 6528 7365 6c66 2e73 7465 7073  erate(self.steps
-00010530: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010540: 2020 2069 6e70 7574 203d 2061 7761 6974     input = await
-00010550: 2073 7465 702e 6169 6e76 6f6b 6528 0a20   step.ainvoke(. 
-00010560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010570: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-00010580: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010590: 6d61 726b 2065 6163 6820 7374 6570 2061  mark each step a
-000105a0: 7320 6120 6368 696c 6420 7275 6e0a 2020  s a child run.  
-000105b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105c0: 2020 7061 7463 685f 636f 6e66 6967 280a    patch_config(.
-000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105e0: 2020 2020 2020 2020 636f 6e66 6967 2c20          config, 
-000105f0: 6361 6c6c 6261 636b 733d 7275 6e5f 6d61  callbacks=run_ma
-00010600: 6e61 6765 722e 6765 745f 6368 696c 6428  nager.get_child(
-00010610: 6622 7365 713a 7374 6570 3a7b 692b 317d  f"seq:step:{i+1}
-00010620: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00010630: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00010640: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010650: 2020 2020 2320 6669 6e69 7368 2074 6865      # finish the
-00010660: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
-00010670: 2020 6578 6365 7074 2042 6173 6545 7863    except BaseExc
-00010680: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00010690: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-000106a0: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-000106b0: 6169 6e5f 6572 726f 7228 6529 0a20 2020  ain_error(e).   
-000106c0: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
-000106d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000106e0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-000106f0: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-00010700: 6169 6e5f 656e 6428 696e 7075 7429 0a20  ain_end(input). 
-00010710: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00010720: 6e20 6361 7374 284f 7574 7075 742c 2069  n cast(Output, i
-00010730: 6e70 7574 290a 0a20 2020 2064 6566 2062  nput)..    def b
-00010740: 6174 6368 280a 2020 2020 2020 2020 7365  atch(.        se
-00010750: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
-00010760: 7473 3a20 4c69 7374 5b49 6e70 7574 5d2c  ts: List[Input],
-00010770: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00010780: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00010790: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
-000107a0: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
-000107b0: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
-000107c0: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-000107d0: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
-000107e0: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-000107f0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00010800: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
-00010810: 795d 2c0a 2020 2020 2920 2d3e 204c 6973  y],.    ) -> Lis
-00010820: 745b 4f75 7470 7574 5d3a 0a20 2020 2020  t[Output]:.     
-00010830: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
-00010840: 6e5f 636f 7265 2e62 6574 612e 7275 6e6e  n_core.beta.runn
-00010850: 6162 6c65 732e 636f 6e74 6578 7420 696d  ables.context im
-00010860: 706f 7274 2063 6f6e 6669 675f 7769 7468  port config_with
-00010870: 5f63 6f6e 7465 7874 0a20 2020 2020 2020  _context.       
-00010880: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
-00010890: 636f 7265 2e63 616c 6c62 6163 6b73 2e6d  core.callbacks.m
-000108a0: 616e 6167 6572 2069 6d70 6f72 7420 4361  anager import Ca
-000108b0: 6c6c 6261 636b 4d61 6e61 6765 720a 0a20  llbackManager.. 
-000108c0: 2020 2020 2020 2069 6620 6e6f 7420 696e         if not in
-000108d0: 7075 7473 3a0a 2020 2020 2020 2020 2020  puts:.          
-000108e0: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-000108f0: 2020 2020 2023 2073 6574 7570 2063 616c       # setup cal
-00010900: 6c62 6163 6b73 2061 6e64 2063 6f6e 7465  lbacks and conte
-00010910: 7874 0a20 2020 2020 2020 2063 6f6e 6669  xt.        confi
-00010920: 6773 203d 205b 0a20 2020 2020 2020 2020  gs = [.         
-00010930: 2020 2063 6f6e 6669 675f 7769 7468 5f63     config_with_c
-00010940: 6f6e 7465 7874 2863 2c20 7365 6c66 2e73  ontext(c, self.s
-00010950: 7465 7073 290a 2020 2020 2020 2020 2020  teps).          
-00010960: 2020 666f 7220 6320 696e 2067 6574 5f63    for c in get_c
-00010970: 6f6e 6669 675f 6c69 7374 2863 6f6e 6669  onfig_list(confi
-00010980: 672c 206c 656e 2869 6e70 7574 7329 290a  g, len(inputs)).
-00010990: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000109a0: 2020 6361 6c6c 6261 636b 5f6d 616e 6167    callback_manag
-000109b0: 6572 7320 3d20 5b0a 2020 2020 2020 2020  ers = [.        
-000109c0: 2020 2020 4361 6c6c 6261 636b 4d61 6e61      CallbackMana
-000109d0: 6765 722e 636f 6e66 6967 7572 6528 0a20  ger.configure(. 
-000109e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000109f0: 6e68 6572 6974 6162 6c65 5f63 616c 6c62  nheritable_callb
-00010a00: 6163 6b73 3d63 6f6e 6669 672e 6765 7428  acks=config.get(
-00010a10: 2263 616c 6c62 6163 6b73 2229 2c0a 2020  "callbacks"),.  
-00010a20: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00010a30: 6361 6c5f 6361 6c6c 6261 636b 733d 4e6f  cal_callbacks=No
-00010a40: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00010a50: 2020 2020 7665 7262 6f73 653d 4661 6c73      verbose=Fals
-00010a60: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00010a70: 2020 2069 6e68 6572 6974 6162 6c65 5f74     inheritable_t
-00010a80: 6167 733d 636f 6e66 6967 2e67 6574 2822  ags=config.get("
-00010a90: 7461 6773 2229 2c0a 2020 2020 2020 2020  tags"),.        
-00010aa0: 2020 2020 2020 2020 6c6f 6361 6c5f 7461          local_ta
-00010ab0: 6773 3d4e 6f6e 652c 0a20 2020 2020 2020  gs=None,.       
-00010ac0: 2020 2020 2020 2020 2069 6e68 6572 6974           inherit
-00010ad0: 6162 6c65 5f6d 6574 6164 6174 613d 636f  able_metadata=co
-00010ae0: 6e66 6967 2e67 6574 2822 6d65 7461 6461  nfig.get("metada
-00010af0: 7461 2229 2c0a 2020 2020 2020 2020 2020  ta"),.          
-00010b00: 2020 2020 2020 6c6f 6361 6c5f 6d65 7461        local_meta
-00010b10: 6461 7461 3d4e 6f6e 652c 0a20 2020 2020  data=None,.     
-00010b20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010b30: 2020 2020 2066 6f72 2063 6f6e 6669 6720       for config 
-00010b40: 696e 2063 6f6e 6669 6773 0a20 2020 2020  in configs.     
-00010b50: 2020 205d 0a20 2020 2020 2020 2023 2073     ].        # s
-00010b60: 7461 7274 2074 6865 2072 6f6f 7420 7275  tart the root ru
-00010b70: 6e73 2c20 6f6e 6520 7065 7220 696e 7075  ns, one per inpu
-00010b80: 740a 2020 2020 2020 2020 7275 6e5f 6d61  t.        run_ma
-00010b90: 6e61 6765 7273 203d 205b 0a20 2020 2020  nagers = [.     
-00010ba0: 2020 2020 2020 2063 6d2e 6f6e 5f63 6861         cm.on_cha
-00010bb0: 696e 5f73 7461 7274 280a 2020 2020 2020  in_start(.      
-00010bc0: 2020 2020 2020 2020 2020 6475 6d70 6428            dumpd(
-00010bd0: 7365 6c66 292c 0a20 2020 2020 2020 2020  self),.         
-00010be0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
-00010bf0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00010c00: 6d65 3d63 6f6e 6669 672e 6765 7428 2272  me=config.get("r
-00010c10: 756e 5f6e 616d 6522 2920 6f72 2073 656c  un_name") or sel
-00010c20: 662e 6765 745f 6e61 6d65 2829 2c0a 2020  f.get_name(),.  
-00010c30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010c40: 2020 2020 2020 2020 666f 7220 636d 2c20          for cm, 
-00010c50: 696e 7075 742c 2063 6f6e 6669 6720 696e  input, config in
-00010c60: 207a 6970 2863 616c 6c62 6163 6b5f 6d61   zip(callback_ma
-00010c70: 6e61 6765 7273 2c20 696e 7075 7473 2c20  nagers, inputs, 
-00010c80: 636f 6e66 6967 7329 0a20 2020 2020 2020  configs).       
-00010c90: 205d 0a0a 2020 2020 2020 2020 2320 696e   ]..        # in
-00010ca0: 766f 6b65 0a20 2020 2020 2020 2074 7279  voke.        try
-00010cb0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00010cc0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
-00010cd0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00010ce0: 2020 2020 2320 5472 6163 6b20 7768 6963      # Track whic
-00010cf0: 6820 696e 7075 7473 2028 6279 2069 6e64  h inputs (by ind
-00010d00: 6578 2920 6661 696c 6564 2073 6f20 6661  ex) failed so fa
-00010d10: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00010d20: 2020 2320 4966 2061 6e20 696e 7075 7420    # If an input 
-00010d30: 6861 7320 6661 696c 6564 2069 7420 7769  has failed it wi
-00010d40: 6c6c 2062 6520 7072 6573 656e 7420 696e  ll be present in
-00010d50: 2074 6869 7320 6d61 702c 0a20 2020 2020   this map,.     
-00010d60: 2020 2020 2020 2020 2020 2023 2061 6e64             # and
-00010d70: 2074 6865 2076 616c 7565 2077 696c 6c20   the value will 
-00010d80: 6265 2074 6865 2065 7863 6570 7469 6f6e  be the exception
-00010d90: 2074 6861 7420 7761 7320 7261 6973 6564   that was raised
-00010da0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00010db0: 2020 6661 696c 6564 5f69 6e70 7574 735f    failed_inputs_
-00010dc0: 6d61 703a 2044 6963 745b 696e 742c 2045  map: Dict[int, E
-00010dd0: 7863 6570 7469 6f6e 5d20 3d20 7b7d 0a20  xception] = {}. 
-00010de0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010df0: 6f72 2073 7465 7069 6478 2c20 7374 6570  or stepidx, step
-00010e00: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
-00010e10: 6c66 2e73 7465 7073 293a 0a20 2020 2020  lf.steps):.     
-00010e20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00010e30: 2041 7373 656d 626c 6520 7468 6520 6f72   Assemble the or
-00010e40: 6967 696e 616c 2069 6e64 6578 6573 206f  iginal indexes o
-00010e50: 6620 7468 6520 7265 6d61 696e 696e 6720  f the remaining 
-00010e60: 696e 7075 7473 0a20 2020 2020 2020 2020  inputs.         
-00010e70: 2020 2020 2020 2020 2020 2023 2028 692e             # (i.
-00010e80: 652e 2074 6865 206f 6e65 7320 7468 6174  e. the ones that
-00010e90: 2068 6176 656e 2774 2066 6169 6c65 6420   haven't failed 
-00010ea0: 7965 7429 0a20 2020 2020 2020 2020 2020  yet).           
-00010eb0: 2020 2020 2020 2020 2072 656d 6169 6e69           remaini
-00010ec0: 6e67 5f69 6478 7320 3d20 5b0a 2020 2020  ng_idxs = [.    
-00010ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ee0: 2020 2020 6920 666f 7220 6920 696e 2072      i for i in r
-00010ef0: 616e 6765 286c 656e 2863 6f6e 6669 6773  ange(len(configs
-00010f00: 2929 2069 6620 6920 6e6f 7420 696e 2066  )) if i not in f
-00010f10: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
-00010f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010f30: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-00010f40: 2020 2020 2020 2020 2020 2023 2049 6e76             # Inv
-00010f50: 6f6b 6520 7468 6520 7374 6570 206f 6e20  oke the step on 
-00010f60: 7468 6520 7265 6d61 696e 696e 6720 696e  the remaining in
-00010f70: 7075 7473 0a20 2020 2020 2020 2020 2020  puts.           
-00010f80: 2020 2020 2020 2020 2069 6e70 7574 7320           inputs 
-00010f90: 3d20 7374 6570 2e62 6174 6368 280a 2020  = step.batch(.  
-00010fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fb0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000d460: 2020 7969 656c 6420 2222 0a0a 0a20 2020    yield ""...   
+0000d470: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0000d480: 205f 6765 6e65 7261 7465 2869 6e70 7574   _generate(input
+0000d490: 3a20 4974 6572 6174 6f72 2920 2d3e 2049  : Iterator) -> I
+0000d4a0: 7465 7261 746f 725b 7374 725d 3a0a 2020  terator[str]:.  
+0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4c0: 2020 7969 656c 6420 6672 6f6d 2022 666f    yield from "fo
+0000d4d0: 6f20 6261 7222 0a0a 0a20 2020 2020 2020  o bar"...       
+0000d4e0: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
+0000d4f0: 6520 3d20 5275 6e6e 6162 6c65 4765 6e65  e = RunnableGene
+0000d500: 7261 746f 7228 5f67 656e 6572 6174 655f  rator(_generate_
+0000d510: 696d 6d65 6469 6174 655f 6572 726f 7229  immediate_error)
+0000d520: 2e77 6974 685f 6661 6c6c 6261 636b 7328  .with_fallbacks(
+0000d530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d540: 2020 2020 205b 5275 6e6e 6162 6c65 4765       [RunnableGe
+0000d550: 6e65 7261 746f 7228 5f67 656e 6572 6174  nerator(_generat
+0000d560: 6529 5d0a 2020 2020 2020 2020 2020 2020  e)].            
+0000d570: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000d580: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000d590: 2727 2e6a 6f69 6e28 7275 6e6e 6162 6c65  ''.join(runnable
+0000d5a0: 2e73 7472 6561 6d28 7b7d 2929 2920 2366  .stream({}))) #f
+0000d5b0: 6f6f 2062 6172 0a0a 2020 2020 2020 2020  oo bar..        
+0000d5c0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+0000d5d0: 2020 6661 6c6c 6261 636b 733a 2041 2073    fallbacks: A s
+0000d5e0: 6571 7565 6e63 6520 6f66 2072 756e 6e61  equence of runna
+0000d5f0: 626c 6573 2074 6f20 7472 7920 6966 2074  bles to try if t
+0000d600: 6865 206f 7269 6769 6e61 6c20 7275 6e6e  he original runn
+0000d610: 6162 6c65 2066 6169 6c73 2e0a 2020 2020  able fails..    
+0000d620: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0000d630: 6e73 5f74 6f5f 6861 6e64 6c65 3a20 4120  ns_to_handle: A 
+0000d640: 7475 706c 6520 6f66 2065 7863 6570 7469  tuple of excepti
+0000d650: 6f6e 2074 7970 6573 2074 6f20 6861 6e64  on types to hand
+0000d660: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
+0000d670: 6578 6365 7074 696f 6e5f 6b65 793a 2049  exception_key: I
+0000d680: 6620 7374 7269 6e67 2069 7320 7370 6563  f string is spec
+0000d690: 6966 6965 6420 7468 656e 2068 616e 646c  ified then handl
+0000d6a0: 6564 2065 7863 6570 7469 6f6e 7320 7769  ed exceptions wi
+0000d6b0: 6c6c 2062 6520 7061 7373 6564 0a20 2020  ll be passed.   
+0000d6c0: 2020 2020 2020 2020 2020 2020 2074 6f20               to 
+0000d6d0: 6661 6c6c 6261 636b 7320 6173 2070 6172  fallbacks as par
+0000d6e0: 7420 6f66 2074 6865 2069 6e70 7574 2075  t of the input u
+0000d6f0: 6e64 6572 2074 6865 2073 7065 6369 6669  nder the specifi
+0000d700: 6564 206b 6579 2e20 4966 204e 6f6e 652c  ed key. If None,
+0000d710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d720: 2065 7863 6570 7469 6f6e 7320 7769 6c6c   exceptions will
+0000d730: 206e 6f74 2062 6520 7061 7373 6564 2074   not be passed t
+0000d740: 6f20 6661 6c6c 6261 636b 732e 2049 6620  o fallbacks. If 
+0000d750: 7573 6564 2c20 7468 6520 6261 7365 2072  used, the base r
+0000d760: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
+0000d770: 2020 2020 2020 2020 616e 6420 6974 7320          and its 
+0000d780: 6661 6c6c 6261 636b 7320 6d75 7374 2061  fallbacks must a
+0000d790: 6363 6570 7420 6120 6469 6374 696f 6e61  ccept a dictiona
+0000d7a0: 7279 2061 7320 696e 7075 742e 0a0a 2020  ry as input...  
+0000d7b0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+0000d7c0: 2020 2020 2020 2020 2020 2041 206e 6577             A new
+0000d7d0: 2052 756e 6e61 626c 6520 7468 6174 2077   Runnable that w
+0000d7e0: 696c 6c20 7472 7920 7468 6520 6f72 6967  ill try the orig
+0000d7f0: 696e 616c 2072 756e 6e61 626c 652c 2061  inal runnable, a
+0000d800: 6e64 2074 6865 6e20 6561 6368 0a20 2020  nd then each.   
+0000d810: 2020 2020 2020 2020 2066 616c 6c62 6163           fallbac
+0000d820: 6b20 696e 206f 7264 6572 2c20 7570 6f6e  k in order, upon
+0000d830: 2066 6169 6c75 7265 732e 0a0a 2020 2020   failures...    
+0000d840: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000d850: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+0000d860: 6f72 652e 7275 6e6e 6162 6c65 732e 6661  ore.runnables.fa
+0000d870: 6c6c 6261 636b 7320 696d 706f 7274 2052  llbacks import R
+0000d880: 756e 6e61 626c 6557 6974 6846 616c 6c62  unnableWithFallb
+0000d890: 6163 6b73 0a0a 2020 2020 2020 2020 7265  acks..        re
+0000d8a0: 7475 726e 2052 756e 6e61 626c 6557 6974  turn RunnableWit
+0000d8b0: 6846 616c 6c62 6163 6b73 280a 2020 2020  hFallbacks(.    
+0000d8c0: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+0000d8d0: 3d73 656c 662c 0a20 2020 2020 2020 2020  =self,.         
+0000d8e0: 2020 2066 616c 6c62 6163 6b73 3d66 616c     fallbacks=fal
+0000d8f0: 6c62 6163 6b73 2c0a 2020 2020 2020 2020  lbacks,.        
+0000d900: 2020 2020 6578 6365 7074 696f 6e73 5f74      exceptions_t
+0000d910: 6f5f 6861 6e64 6c65 3d65 7863 6570 7469  o_handle=excepti
+0000d920: 6f6e 735f 746f 5f68 616e 646c 652c 0a20  ons_to_handle,. 
+0000d930: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000d940: 7469 6f6e 5f6b 6579 3d65 7863 6570 7469  tion_key=excepti
+0000d950: 6f6e 5f6b 6579 2c0a 2020 2020 2020 2020  on_key,.        
+0000d960: 290a 0a20 2020 2022 2222 202d 2d2d 2048  )..    """ --- H
+0000d970: 656c 7065 7220 6d65 7468 6f64 7320 666f  elper methods fo
+0000d980: 7220 5375 6263 6c61 7373 6573 202d 2d2d  r Subclasses ---
+0000d990: 2022 2222 0a0a 2020 2020 6465 6620 5f63   """..    def _c
+0000d9a0: 616c 6c5f 7769 7468 5f63 6f6e 6669 6728  all_with_config(
+0000d9b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0000d9c0: 2020 2020 2020 2066 756e 633a 2055 6e69         func: Uni
+0000d9d0: 6f6e 5b0a 2020 2020 2020 2020 2020 2020  on[.            
+0000d9e0: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
+0000d9f0: 2c20 4f75 7470 7574 5d2c 0a20 2020 2020  , Output],.     
+0000da00: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+0000da10: 5b49 6e70 7574 2c20 4361 6c6c 6261 636b  [Input, Callback
+0000da20: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
+0000da30: 756e 5d2c 204f 7574 7075 745d 2c0a 2020  un], Output],.  
+0000da40: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
+0000da50: 6c65 5b5b 496e 7075 742c 2043 616c 6c62  le[[Input, Callb
+0000da60: 6163 6b4d 616e 6167 6572 466f 7243 6861  ackManagerForCha
+0000da70: 696e 5275 6e2c 2052 756e 6e61 626c 6543  inRun, RunnableC
+0000da80: 6f6e 6669 675d 2c20 4f75 7470 7574 5d2c  onfig], Output],
+0000da90: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000daa0: 2020 2020 696e 7075 743a 2049 6e70 7574      input: Input
+0000dab0: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+0000dac0: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+0000dad0: 626c 6543 6f6e 6669 675d 2c0a 2020 2020  bleConfig],.    
+0000dae0: 2020 2020 7275 6e5f 7479 7065 3a20 4f70      run_type: Op
+0000daf0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000db00: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+0000db10: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+0000db20: 6e79 5d2c 0a20 2020 2029 202d 3e20 4f75  ny],.    ) -> Ou
+0000db30: 7470 7574 3a0a 2020 2020 2020 2020 2222  tput:.        ""
+0000db40: 2248 656c 7065 7220 6d65 7468 6f64 2074  "Helper method t
+0000db50: 6f20 7472 616e 7366 6f72 6d20 616e 2049  o transform an I
+0000db60: 6e70 7574 2076 616c 7565 2074 6f20 616e  nput value to an
+0000db70: 204f 7574 7075 7420 7661 6c75 652c 0a20   Output value,. 
+0000db80: 2020 2020 2020 2077 6974 6820 6361 6c6c         with call
+0000db90: 6261 636b 732e 2055 7365 2074 6869 7320  backs. Use this 
+0000dba0: 6d65 7468 6f64 2074 6f20 696d 706c 656d  method to implem
+0000dbb0: 656e 7420 696e 766f 6b65 2829 2069 6e20  ent invoke() in 
+0000dbc0: 7375 6263 6c61 7373 6573 2e22 2222 0a20  subclasses.""". 
+0000dbd0: 2020 2020 2020 2063 6f6e 6669 6720 3d20         config = 
+0000dbe0: 656e 7375 7265 5f63 6f6e 6669 6728 636f  ensure_config(co
+0000dbf0: 6e66 6967 290a 2020 2020 2020 2020 6361  nfig).        ca
+0000dc00: 6c6c 6261 636b 5f6d 616e 6167 6572 203d  llback_manager =
+0000dc10: 2067 6574 5f63 616c 6c62 6163 6b5f 6d61   get_callback_ma
+0000dc20: 6e61 6765 725f 666f 725f 636f 6e66 6967  nager_for_config
+0000dc30: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
+0000dc40: 2072 756e 5f6d 616e 6167 6572 203d 2063   run_manager = c
+0000dc50: 616c 6c62 6163 6b5f 6d61 6e61 6765 722e  allback_manager.
+0000dc60: 6f6e 5f63 6861 696e 5f73 7461 7274 280a  on_chain_start(.
+0000dc70: 2020 2020 2020 2020 2020 2020 6475 6d70              dump
+0000dc80: 6428 7365 6c66 292c 0a20 2020 2020 2020  d(self),.       
+0000dc90: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+0000dca0: 2020 2020 2020 2020 7275 6e5f 7479 7065          run_type
+0000dcb0: 3d72 756e 5f74 7970 652c 0a20 2020 2020  =run_type,.     
+0000dcc0: 2020 2020 2020 206e 616d 653d 636f 6e66         name=conf
+0000dcd0: 6967 2e67 6574 2822 7275 6e5f 6e61 6d65  ig.get("run_name
+0000dce0: 2229 206f 7220 7365 6c66 2e67 6574 5f6e  ") or self.get_n
+0000dcf0: 616d 6528 292c 0a20 2020 2020 2020 2020  ame(),.         
+0000dd00: 2020 2072 756e 5f69 643d 636f 6e66 6967     run_id=config
+0000dd10: 2e70 6f70 2822 7275 6e5f 6964 222c 204e  .pop("run_id", N
+0000dd20: 6f6e 6529 2c0a 2020 2020 2020 2020 290a  one),.        ).
+0000dd30: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000dd40: 2020 2020 2020 2020 2063 6869 6c64 5f63           child_c
+0000dd50: 6f6e 6669 6720 3d20 7061 7463 685f 636f  onfig = patch_co
+0000dd60: 6e66 6967 2863 6f6e 6669 672c 2063 616c  nfig(config, cal
+0000dd70: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
+0000dd80: 6572 2e67 6574 5f63 6869 6c64 2829 290a  er.get_child()).
+0000dd90: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0000dda0: 6578 7420 3d20 636f 7079 5f63 6f6e 7465  ext = copy_conte
+0000ddb0: 7874 2829 0a20 2020 2020 2020 2020 2020  xt().           
+0000ddc0: 2063 6f6e 7465 7874 2e72 756e 2876 6172   context.run(var
+0000ddd0: 5f63 6869 6c64 5f72 756e 6e61 626c 655f  _child_runnable_
+0000dde0: 636f 6e66 6967 2e73 6574 2c20 6368 696c  config.set, chil
+0000ddf0: 645f 636f 6e66 6967 290a 2020 2020 2020  d_config).      
+0000de00: 2020 2020 2020 6f75 7470 7574 203d 2063        output = c
+0000de10: 6173 7428 0a20 2020 2020 2020 2020 2020  ast(.           
+0000de20: 2020 2020 204f 7574 7075 742c 0a20 2020       Output,.   
+0000de30: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000de40: 7465 7874 2e72 756e 280a 2020 2020 2020  text.run(.      
+0000de50: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0000de60: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
+0000de70: 6961 626c 655f 6172 6773 2c20 2023 2074  iable_args,  # t
+0000de80: 7970 653a 2069 676e 6f72 655b 6172 672d  ype: ignore[arg-
+0000de90: 7479 7065 5d0a 2020 2020 2020 2020 2020  type].          
+0000dea0: 2020 2020 2020 2020 2020 6675 6e63 2c20            func, 
+0000deb0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+0000dec0: 6172 672d 7479 7065 5d0a 2020 2020 2020  arg-type].      
+0000ded0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000dee0: 7075 742c 2020 2320 7479 7065 3a20 6967  put,  # type: ig
+0000def0: 6e6f 7265 5b61 7267 2d74 7970 655d 0a20  nore[arg-type]. 
+0000df00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df10: 2020 2063 6f6e 6669 672c 0a20 2020 2020     config,.     
+0000df20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000df30: 756e 5f6d 616e 6167 6572 2c0a 2020 2020  un_manager,.    
+0000df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df50: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+0000df60: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+0000df70: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000df80: 2020 2065 7863 6570 7420 4261 7365 4578     except BaseEx
+0000df90: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0000dfa0: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
+0000dfb0: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
+0000dfc0: 7272 6f72 2865 290a 2020 2020 2020 2020  rror(e).        
+0000dfd0: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
+0000dfe0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000dff0: 2020 2020 7275 6e5f 6d61 6e61 6765 722e      run_manager.
+0000e000: 6f6e 5f63 6861 696e 5f65 6e64 286f 7574  on_chain_end(out
+0000e010: 7075 7429 0a20 2020 2020 2020 2020 2020  put).           
+0000e020: 2072 6574 7572 6e20 6f75 7470 7574 0a0a   return output..
+0000e030: 2020 2020 6173 796e 6320 6465 6620 5f61      async def _a
+0000e040: 6361 6c6c 5f77 6974 685f 636f 6e66 6967  call_with_config
+0000e050: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0000e060: 2020 2020 2020 2020 6675 6e63 3a20 556e          func: Un
+0000e070: 696f 6e5b 0a20 2020 2020 2020 2020 2020  ion[.           
+0000e080: 2043 616c 6c61 626c 655b 5b49 6e70 7574   Callable[[Input
+0000e090: 5d2c 2041 7761 6974 6162 6c65 5b4f 7574  ], Awaitable[Out
+0000e0a0: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
+0000e0b0: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
+0000e0c0: 7574 2c20 4173 796e 6343 616c 6c62 6163  ut, AsyncCallbac
+0000e0d0: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+0000e0e0: 5275 6e5d 2c20 4177 6169 7461 626c 655b  Run], Awaitable[
+0000e0f0: 4f75 7470 7574 5d5d 2c0a 2020 2020 2020  Output]],.      
+0000e100: 2020 2020 2020 4361 6c6c 6162 6c65 5b0a        Callable[.
+0000e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e120: 5b49 6e70 7574 2c20 4173 796e 6343 616c  [Input, AsyncCal
+0000e130: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
+0000e140: 6861 696e 5275 6e2c 2052 756e 6e61 626c  hainRun, Runnabl
+0000e150: 6543 6f6e 6669 675d 2c0a 2020 2020 2020  eConfig],.      
+0000e160: 2020 2020 2020 2020 2020 4177 6169 7461            Awaita
+0000e170: 626c 655b 4f75 7470 7574 5d2c 0a20 2020  ble[Output],.   
+0000e180: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+0000e190: 2020 2020 5d2c 0a20 2020 2020 2020 2069      ],.        i
+0000e1a0: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
+0000e1b0: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+0000e1c0: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
+0000e1d0: 6e66 6967 5d2c 0a20 2020 2020 2020 2072  nfig],.        r
+0000e1e0: 756e 5f74 7970 653a 204f 7074 696f 6e61  un_type: Optiona
+0000e1f0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+0000e200: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+0000e210: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+0000e220: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
+0000e230: 0a20 2020 2020 2020 2022 2222 4865 6c70  .        """Help
+0000e240: 6572 206d 6574 686f 6420 746f 2074 7261  er method to tra
+0000e250: 6e73 666f 726d 2061 6e20 496e 7075 7420  nsform an Input 
+0000e260: 7661 6c75 6520 746f 2061 6e20 4f75 7470  value to an Outp
+0000e270: 7574 2076 616c 7565 2c0a 2020 2020 2020  ut value,.      
+0000e280: 2020 7769 7468 2063 616c 6c62 6163 6b73    with callbacks
+0000e290: 2e20 5573 6520 7468 6973 206d 6574 686f  . Use this metho
+0000e2a0: 6420 746f 2069 6d70 6c65 6d65 6e74 2061  d to implement a
+0000e2b0: 696e 766f 6b65 2829 2069 6e20 7375 6263  invoke() in subc
+0000e2c0: 6c61 7373 6573 2e22 2222 0a20 2020 2020  lasses.""".     
+0000e2d0: 2020 2063 6f6e 6669 6720 3d20 656e 7375     config = ensu
+0000e2e0: 7265 5f63 6f6e 6669 6728 636f 6e66 6967  re_config(config
+0000e2f0: 290a 2020 2020 2020 2020 6361 6c6c 6261  ).        callba
+0000e300: 636b 5f6d 616e 6167 6572 203d 2067 6574  ck_manager = get
+0000e310: 5f61 7379 6e63 5f63 616c 6c62 6163 6b5f  _async_callback_
+0000e320: 6d61 6e61 6765 725f 666f 725f 636f 6e66  manager_for_conf
+0000e330: 6967 2863 6f6e 6669 6729 0a20 2020 2020  ig(config).     
+0000e340: 2020 2072 756e 5f6d 616e 6167 6572 203d     run_manager =
+0000e350: 2061 7761 6974 2063 616c 6c62 6163 6b5f   await callback_
+0000e360: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+0000e370: 5f73 7461 7274 280a 2020 2020 2020 2020  _start(.        
+0000e380: 2020 2020 6475 6d70 6428 7365 6c66 292c      dumpd(self),
+0000e390: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+0000e3a0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+0000e3b0: 7275 6e5f 7479 7065 3d72 756e 5f74 7970  run_type=run_typ
+0000e3c0: 652c 0a20 2020 2020 2020 2020 2020 206e  e,.            n
+0000e3d0: 616d 653d 636f 6e66 6967 2e67 6574 2822  ame=config.get("
+0000e3e0: 7275 6e5f 6e61 6d65 2229 206f 7220 7365  run_name") or se
+0000e3f0: 6c66 2e67 6574 5f6e 616d 6528 292c 0a20  lf.get_name(),. 
+0000e400: 2020 2020 2020 2020 2020 2072 756e 5f69             run_i
+0000e410: 643d 636f 6e66 6967 2e70 6f70 2822 7275  d=config.pop("ru
+0000e420: 6e5f 6964 222c 204e 6f6e 6529 2c0a 2020  n_id", None),.  
+0000e430: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000e440: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000e450: 2063 6869 6c64 5f63 6f6e 6669 6720 3d20   child_config = 
+0000e460: 7061 7463 685f 636f 6e66 6967 2863 6f6e  patch_config(con
+0000e470: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
+0000e480: 756e 5f6d 616e 6167 6572 2e67 6574 5f63  un_manager.get_c
+0000e490: 6869 6c64 2829 290a 2020 2020 2020 2020  hild()).        
+0000e4a0: 2020 2020 636f 6e74 6578 7420 3d20 636f      context = co
+0000e4b0: 7079 5f63 6f6e 7465 7874 2829 0a20 2020  py_context().   
+0000e4c0: 2020 2020 2020 2020 2063 6f6e 7465 7874           context
+0000e4d0: 2e72 756e 2876 6172 5f63 6869 6c64 5f72  .run(var_child_r
+0000e4e0: 756e 6e61 626c 655f 636f 6e66 6967 2e73  unnable_config.s
+0000e4f0: 6574 2c20 6368 696c 645f 636f 6e66 6967  et, child_config
+0000e500: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+0000e510: 726f 203d 2061 6361 6c6c 5f66 756e 635f  ro = acall_func_
+0000e520: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
+0000e530: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+0000e540: 2020 2020 6675 6e63 2c20 696e 7075 742c      func, input,
+0000e550: 2063 6f6e 6669 672c 2072 756e 5f6d 616e   config, run_man
+0000e560: 6167 6572 2c20 2a2a 6b77 6172 6773 0a20  ager, **kwargs. 
+0000e570: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000e580: 2020 2020 2020 2020 2069 6620 6163 6365           if acce
+0000e590: 7074 735f 636f 6e74 6578 7428 6173 796e  pts_context(asyn
+0000e5a0: 6369 6f2e 6372 6561 7465 5f74 6173 6b29  cio.create_task)
+0000e5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e5c0: 2020 6f75 7470 7574 3a20 4f75 7470 7574    output: Output
+0000e5d0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
+0000e5e0: 2e63 7265 6174 655f 7461 736b 2863 6f72  .create_task(cor
+0000e5f0: 6f2c 2063 6f6e 7465 7874 3d63 6f6e 7465  o, context=conte
+0000e600: 7874 2920 2023 2074 7970 653a 2069 676e  xt)  # type: ign
+0000e610: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+0000e620: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000e630: 2020 2020 2020 6f75 7470 7574 203d 2061        output = a
+0000e640: 7761 6974 2063 6f72 6f0a 2020 2020 2020  wait coro.      
+0000e650: 2020 6578 6365 7074 2042 6173 6545 7863    except BaseExc
+0000e660: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+0000e670: 2020 2020 2020 2020 2061 7761 6974 2072           await r
+0000e680: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
+0000e690: 6169 6e5f 6572 726f 7228 6529 0a20 2020  ain_error(e).   
+0000e6a0: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
+0000e6b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000e6c0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
+0000e6d0: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
+0000e6e0: 6169 6e5f 656e 6428 6f75 7470 7574 290a  ain_end(output).
+0000e6f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000e700: 726e 206f 7574 7075 740a 0a20 2020 2064  rn output..    d
+0000e710: 6566 205f 6261 7463 685f 7769 7468 5f63  ef _batch_with_c
+0000e720: 6f6e 6669 6728 0a20 2020 2020 2020 2073  onfig(.        s
+0000e730: 656c 662c 0a20 2020 2020 2020 2066 756e  elf,.        fun
+0000e740: 633a 2055 6e69 6f6e 5b0a 2020 2020 2020  c: Union[.      
+0000e750: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
+0000e760: 4c69 7374 5b49 6e70 7574 5d5d 2c20 4c69  List[Input]], Li
+0000e770: 7374 5b55 6e69 6f6e 5b45 7863 6570 7469  st[Union[Excepti
+0000e780: 6f6e 2c20 4f75 7470 7574 5d5d 5d2c 0a20  on, Output]]],. 
+0000e790: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
+0000e7a0: 626c 655b 0a20 2020 2020 2020 2020 2020  ble[.           
+0000e7b0: 2020 2020 205b 4c69 7374 5b49 6e70 7574       [List[Input
+0000e7c0: 5d2c 204c 6973 745b 4361 6c6c 6261 636b  ], List[Callback
+0000e7d0: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
+0000e7e0: 756e 5d5d 2c0a 2020 2020 2020 2020 2020  un]],.          
+0000e7f0: 2020 2020 2020 4c69 7374 5b55 6e69 6f6e        List[Union
+0000e800: 5b45 7863 6570 7469 6f6e 2c20 4f75 7470  [Exception, Outp
+0000e810: 7574 5d5d 2c0a 2020 2020 2020 2020 2020  ut]],.          
+0000e820: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+0000e830: 2043 616c 6c61 626c 655b 0a20 2020 2020   Callable[.     
+0000e840: 2020 2020 2020 2020 2020 205b 4c69 7374             [List
+0000e850: 5b49 6e70 7574 5d2c 204c 6973 745b 4361  [Input], List[Ca
+0000e860: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+0000e870: 4368 6169 6e52 756e 5d2c 204c 6973 745b  ChainRun], List[
+0000e880: 5275 6e6e 6162 6c65 436f 6e66 6967 5d5d  RunnableConfig]]
+0000e890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e8a0: 2020 4c69 7374 5b55 6e69 6f6e 5b45 7863    List[Union[Exc
+0000e8b0: 6570 7469 6f6e 2c20 4f75 7470 7574 5d5d  eption, Output]]
+0000e8c0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+0000e8d0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000e8e0: 2020 2020 696e 7075 743a 204c 6973 745b      input: List[
+0000e8f0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
+0000e900: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0000e910: 5b55 6e69 6f6e 5b52 756e 6e61 626c 6543  [Union[RunnableC
+0000e920: 6f6e 6669 672c 204c 6973 745b 5275 6e6e  onfig, List[Runn
+0000e930: 6162 6c65 436f 6e66 6967 5d5d 5d20 3d20  ableConfig]]] = 
+0000e940: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2c  None,.        *,
+0000e950: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0000e960: 6578 6365 7074 696f 6e73 3a20 626f 6f6c  exceptions: bool
+0000e970: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+0000e980: 2020 7275 6e5f 7479 7065 3a20 4f70 7469    run_type: Opti
+0000e990: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+0000e9a0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+0000e9b0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
+0000e9c0: 5d2c 0a20 2020 2029 202d 3e20 4c69 7374  ],.    ) -> List
+0000e9d0: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
+0000e9e0: 2020 2222 2248 656c 7065 7220 6d65 7468    """Helper meth
+0000e9f0: 6f64 2074 6f20 7472 616e 7366 6f72 6d20  od to transform 
+0000ea00: 616e 2049 6e70 7574 2076 616c 7565 2074  an Input value t
+0000ea10: 6f20 616e 204f 7574 7075 7420 7661 6c75  o an Output valu
+0000ea20: 652c 0a20 2020 2020 2020 2077 6974 6820  e,.        with 
+0000ea30: 6361 6c6c 6261 636b 732e 2055 7365 2074  callbacks. Use t
+0000ea40: 6869 7320 6d65 7468 6f64 2074 6f20 696d  his method to im
+0000ea50: 706c 656d 656e 7420 696e 766f 6b65 2829  plement invoke()
+0000ea60: 2069 6e20 7375 6263 6c61 7373 6573 2e22   in subclasses."
+0000ea70: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0000ea80: 7420 696e 7075 743a 0a20 2020 2020 2020  t input:.       
+0000ea90: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
+0000eaa0: 2020 2020 2020 2020 636f 6e66 6967 7320          configs 
+0000eab0: 3d20 6765 745f 636f 6e66 6967 5f6c 6973  = get_config_lis
+0000eac0: 7428 636f 6e66 6967 2c20 6c65 6e28 696e  t(config, len(in
+0000ead0: 7075 7429 290a 2020 2020 2020 2020 6361  put)).        ca
+0000eae0: 6c6c 6261 636b 5f6d 616e 6167 6572 7320  llback_managers 
+0000eaf0: 3d20 5b67 6574 5f63 616c 6c62 6163 6b5f  = [get_callback_
+0000eb00: 6d61 6e61 6765 725f 666f 725f 636f 6e66  manager_for_conf
+0000eb10: 6967 2863 2920 666f 7220 6320 696e 2063  ig(c) for c in c
+0000eb20: 6f6e 6669 6773 5d0a 2020 2020 2020 2020  onfigs].        
+0000eb30: 7275 6e5f 6d61 6e61 6765 7273 203d 205b  run_managers = [
+0000eb40: 0a20 2020 2020 2020 2020 2020 2063 616c  .            cal
+0000eb50: 6c62 6163 6b5f 6d61 6e61 6765 722e 6f6e  lback_manager.on
+0000eb60: 5f63 6861 696e 5f73 7461 7274 280a 2020  _chain_start(.  
+0000eb70: 2020 2020 2020 2020 2020 2020 2020 6475                du
+0000eb80: 6d70 6428 7365 6c66 292c 0a20 2020 2020  mpd(self),.     
+0000eb90: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0000eba0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ebb0: 2020 7275 6e5f 7479 7065 3d72 756e 5f74    run_type=run_t
+0000ebc0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0000ebd0: 2020 2020 206e 616d 653d 636f 6e66 6967       name=config
+0000ebe0: 2e67 6574 2822 7275 6e5f 6e61 6d65 2229  .get("run_name")
+0000ebf0: 206f 7220 7365 6c66 2e67 6574 5f6e 616d   or self.get_nam
+0000ec00: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
+0000ec10: 2020 2020 2072 756e 5f69 643d 636f 6e66       run_id=conf
+0000ec20: 6967 2e70 6f70 2822 7275 6e5f 6964 222c  ig.pop("run_id",
+0000ec30: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000ec40: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000ec50: 2020 666f 7220 6361 6c6c 6261 636b 5f6d    for callback_m
+0000ec60: 616e 6167 6572 2c20 696e 7075 742c 2063  anager, input, c
+0000ec70: 6f6e 6669 6720 696e 207a 6970 280a 2020  onfig in zip(.  
+0000ec80: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0000ec90: 6c6c 6261 636b 5f6d 616e 6167 6572 732c  llback_managers,
+0000eca0: 2069 6e70 7574 2c20 636f 6e66 6967 730a   input, configs.
+0000ecb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000ecc0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0000ecd0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000ece0: 2069 6620 6163 6365 7074 735f 636f 6e66   if accepts_conf
+0000ecf0: 6967 2866 756e 6329 3a0a 2020 2020 2020  ig(func):.      
+0000ed00: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
+0000ed10: 5b22 636f 6e66 6967 225d 203d 205b 0a20  ["config"] = [. 
+0000ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed30: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
+0000ed40: 632c 2063 616c 6c62 6163 6b73 3d72 6d2e  c, callbacks=rm.
+0000ed50: 6765 745f 6368 696c 6428 2929 0a20 2020  get_child()).   
+0000ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed70: 2066 6f72 2063 2c20 726d 2069 6e20 7a69   for c, rm in zi
+0000ed80: 7028 636f 6e66 6967 732c 2072 756e 5f6d  p(configs, run_m
+0000ed90: 616e 6167 6572 7329 0a20 2020 2020 2020  anagers).       
+0000eda0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0000edb0: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
+0000edc0: 735f 7275 6e5f 6d61 6e61 6765 7228 6675  s_run_manager(fu
+0000edd0: 6e63 293a 0a20 2020 2020 2020 2020 2020  nc):.           
+0000ede0: 2020 2020 206b 7761 7267 735b 2272 756e       kwargs["run
+0000edf0: 5f6d 616e 6167 6572 225d 203d 2072 756e  _manager"] = run
+0000ee00: 5f6d 616e 6167 6572 730a 2020 2020 2020  _managers.      
+0000ee10: 2020 2020 2020 6f75 7470 7574 203d 2066        output = f
+0000ee20: 756e 6328 696e 7075 742c 202a 2a6b 7761  unc(input, **kwa
+0000ee30: 7267 7329 2020 2320 7479 7065 3a20 6967  rgs)  # type: ig
+0000ee40: 6e6f 7265 5b63 616c 6c2d 6172 675d 0a20  nore[call-arg]. 
+0000ee50: 2020 2020 2020 2065 7863 6570 7420 4261         except Ba
+0000ee60: 7365 4578 6365 7074 696f 6e20 6173 2065  seException as e
+0000ee70: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0000ee80: 7220 7275 6e5f 6d61 6e61 6765 7220 696e  r run_manager in
+0000ee90: 2072 756e 5f6d 616e 6167 6572 733a 0a20   run_managers:. 
+0000eea0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000eeb0: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
+0000eec0: 6169 6e5f 6572 726f 7228 6529 0a20 2020  ain_error(e).   
+0000eed0: 2020 2020 2020 2020 2069 6620 7265 7475           if retu
+0000eee0: 726e 5f65 7863 6570 7469 6f6e 733a 0a20  rn_exceptions:. 
+0000eef0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000ef00: 6574 7572 6e20 6361 7374 284c 6973 745b  eturn cast(List[
+0000ef10: 4f75 7470 7574 5d2c 205b 6520 666f 7220  Output], [e for 
+0000ef20: 5f20 696e 2069 6e70 7574 5d29 0a20 2020  _ in input]).   
+0000ef30: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000ef40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000ef50: 6169 7365 0a20 2020 2020 2020 2065 6c73  aise.        els
+0000ef60: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+0000ef70: 6972 7374 5f65 7863 6570 7469 6f6e 3a20  irst_exception: 
+0000ef80: 4f70 7469 6f6e 616c 5b45 7863 6570 7469  Optional[Excepti
+0000ef90: 6f6e 5d20 3d20 4e6f 6e65 0a20 2020 2020  on] = None.     
+0000efa0: 2020 2020 2020 2066 6f72 2072 756e 5f6d         for run_m
+0000efb0: 616e 6167 6572 2c20 6f75 7420 696e 207a  anager, out in z
+0000efc0: 6970 2872 756e 5f6d 616e 6167 6572 732c  ip(run_managers,
+0000efd0: 206f 7574 7075 7429 3a0a 2020 2020 2020   output):.      
+0000efe0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+0000eff0: 6e73 7461 6e63 6528 6f75 742c 2045 7863  nstance(out, Exc
+0000f000: 6570 7469 6f6e 293a 0a20 2020 2020 2020  eption):.       
+0000f010: 2020 2020 2020 2020 2020 2020 2066 6972               fir
+0000f020: 7374 5f65 7863 6570 7469 6f6e 203d 2066  st_exception = f
+0000f030: 6972 7374 5f65 7863 6570 7469 6f6e 206f  irst_exception o
+0000f040: 7220 6f75 740a 2020 2020 2020 2020 2020  r out.          
+0000f050: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
+0000f060: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
+0000f070: 7272 6f72 286f 7574 290a 2020 2020 2020  rror(out).      
+0000f080: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0a0: 2020 2020 7275 6e5f 6d61 6e61 6765 722e      run_manager.
+0000f0b0: 6f6e 5f63 6861 696e 5f65 6e64 286f 7574  on_chain_end(out
+0000f0c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000f0d0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+0000f0e0: 6e73 206f 7220 6669 7273 745f 6578 6365  ns or first_exce
+0000f0f0: 7074 696f 6e20 6973 204e 6f6e 653a 0a20  ption is None:. 
+0000f100: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000f110: 6574 7572 6e20 6361 7374 284c 6973 745b  eturn cast(List[
+0000f120: 4f75 7470 7574 5d2c 206f 7574 7075 7429  Output], output)
+0000f130: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000f140: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000f150: 2020 2072 6169 7365 2066 6972 7374 5f65     raise first_e
+0000f160: 7863 6570 7469 6f6e 0a0a 2020 2020 6173  xception..    as
+0000f170: 796e 6320 6465 6620 5f61 6261 7463 685f  ync def _abatch_
+0000f180: 7769 7468 5f63 6f6e 6669 6728 0a20 2020  with_config(.   
+0000f190: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000f1a0: 2020 2066 756e 633a 2055 6e69 6f6e 5b0a     func: Union[.
+0000f1b0: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0000f1c0: 6162 6c65 5b5b 4c69 7374 5b49 6e70 7574  able[[List[Input
+0000f1d0: 5d5d 2c20 4177 6169 7461 626c 655b 4c69  ]], Awaitable[Li
+0000f1e0: 7374 5b55 6e69 6f6e 5b45 7863 6570 7469  st[Union[Excepti
+0000f1f0: 6f6e 2c20 4f75 7470 7574 5d5d 5d5d 2c0a  on, Output]]]],.
+0000f200: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0000f210: 6162 6c65 5b0a 2020 2020 2020 2020 2020  able[.          
+0000f220: 2020 2020 2020 5b4c 6973 745b 496e 7075        [List[Inpu
+0000f230: 745d 2c20 4c69 7374 5b41 7379 6e63 4361  t], List[AsyncCa
+0000f240: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+0000f250: 4368 6169 6e52 756e 5d5d 2c0a 2020 2020  ChainRun]],.    
+0000f260: 2020 2020 2020 2020 2020 2020 4177 6169              Awai
+0000f270: 7461 626c 655b 4c69 7374 5b55 6e69 6f6e  table[List[Union
+0000f280: 5b45 7863 6570 7469 6f6e 2c20 4f75 7470  [Exception, Outp
+0000f290: 7574 5d5d 5d2c 0a20 2020 2020 2020 2020  ut]]],.         
+0000f2a0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+0000f2b0: 2020 4361 6c6c 6162 6c65 5b0a 2020 2020    Callable[.    
+0000f2c0: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+0000f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2e0: 2020 4c69 7374 5b49 6e70 7574 5d2c 0a20    List[Input],. 
+0000f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f300: 2020 204c 6973 745b 4173 796e 6343 616c     List[AsyncCal
+0000f310: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
+0000f320: 6861 696e 5275 6e5d 2c0a 2020 2020 2020  hainRun],.      
+0000f330: 2020 2020 2020 2020 2020 2020 2020 4c69                Li
+0000f340: 7374 5b52 756e 6e61 626c 6543 6f6e 6669  st[RunnableConfi
+0000f350: 675d 2c0a 2020 2020 2020 2020 2020 2020  g],.            
+0000f360: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+0000f370: 2020 2020 2020 2041 7761 6974 6162 6c65         Awaitable
+0000f380: 5b4c 6973 745b 556e 696f 6e5b 4578 6365  [List[Union[Exce
+0000f390: 7074 696f 6e2c 204f 7574 7075 745d 5d5d  ption, Output]]]
+0000f3a0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+0000f3b0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000f3c0: 2020 2020 696e 7075 743a 204c 6973 745b      input: List[
+0000f3d0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
+0000f3e0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0000f3f0: 5b55 6e69 6f6e 5b52 756e 6e61 626c 6543  [Union[RunnableC
+0000f400: 6f6e 6669 672c 204c 6973 745b 5275 6e6e  onfig, List[Runn
+0000f410: 6162 6c65 436f 6e66 6967 5d5d 5d20 3d20  ableConfig]]] = 
+0000f420: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2c  None,.        *,
+0000f430: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0000f440: 6578 6365 7074 696f 6e73 3a20 626f 6f6c  exceptions: bool
+0000f450: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+0000f460: 2020 7275 6e5f 7479 7065 3a20 4f70 7469    run_type: Opti
+0000f470: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+0000f480: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+0000f490: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
+0000f4a0: 5d2c 0a20 2020 2029 202d 3e20 4c69 7374  ],.    ) -> List
+0000f4b0: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
+0000f4c0: 2020 2222 2248 656c 7065 7220 6d65 7468    """Helper meth
+0000f4d0: 6f64 2074 6f20 7472 616e 7366 6f72 6d20  od to transform 
+0000f4e0: 616e 2049 6e70 7574 2076 616c 7565 2074  an Input value t
+0000f4f0: 6f20 616e 204f 7574 7075 7420 7661 6c75  o an Output valu
+0000f500: 652c 0a20 2020 2020 2020 2077 6974 6820  e,.        with 
+0000f510: 6361 6c6c 6261 636b 732e 2055 7365 2074  callbacks. Use t
+0000f520: 6869 7320 6d65 7468 6f64 2074 6f20 696d  his method to im
+0000f530: 706c 656d 656e 7420 696e 766f 6b65 2829  plement invoke()
+0000f540: 2069 6e20 7375 6263 6c61 7373 6573 2e22   in subclasses."
+0000f550: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0000f560: 7420 696e 7075 743a 0a20 2020 2020 2020  t input:.       
+0000f570: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
+0000f580: 2020 2020 2020 2020 636f 6e66 6967 7320          configs 
+0000f590: 3d20 6765 745f 636f 6e66 6967 5f6c 6973  = get_config_lis
+0000f5a0: 7428 636f 6e66 6967 2c20 6c65 6e28 696e  t(config, len(in
+0000f5b0: 7075 7429 290a 2020 2020 2020 2020 6361  put)).        ca
+0000f5c0: 6c6c 6261 636b 5f6d 616e 6167 6572 7320  llback_managers 
+0000f5d0: 3d20 5b67 6574 5f61 7379 6e63 5f63 616c  = [get_async_cal
+0000f5e0: 6c62 6163 6b5f 6d61 6e61 6765 725f 666f  lback_manager_fo
+0000f5f0: 725f 636f 6e66 6967 2863 2920 666f 7220  r_config(c) for 
+0000f600: 6320 696e 2063 6f6e 6669 6773 5d0a 2020  c in configs].  
+0000f610: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
+0000f620: 7273 3a20 4c69 7374 5b41 7379 6e63 4361  rs: List[AsyncCa
+0000f630: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+0000f640: 4368 6169 6e52 756e 5d20 3d20 6177 6169  ChainRun] = awai
+0000f650: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0000f660: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
+0000f670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f680: 2063 616c 6c62 6163 6b5f 6d61 6e61 6765   callback_manage
+0000f690: 722e 6f6e 5f63 6861 696e 5f73 7461 7274  r.on_chain_start
+0000f6a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000f6b0: 2020 2020 2020 6475 6d70 6428 7365 6c66        dumpd(self
+0000f6c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000f6d0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6f0: 2020 7275 6e5f 7479 7065 3d72 756e 5f74    run_type=run_t
+0000f700: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0000f710: 2020 2020 2020 2020 206e 616d 653d 636f           name=co
+0000f720: 6e66 6967 2e67 6574 2822 7275 6e5f 6e61  nfig.get("run_na
+0000f730: 6d65 2229 206f 7220 7365 6c66 2e67 6574  me") or self.get
+0000f740: 5f6e 616d 6528 292c 0a20 2020 2020 2020  _name(),.       
+0000f750: 2020 2020 2020 2020 2020 2020 2072 756e               run
+0000f760: 5f69 643d 636f 6e66 6967 2e70 6f70 2822  _id=config.pop("
+0000f770: 7275 6e5f 6964 222c 204e 6f6e 6529 2c0a  run_id", None),.
+0000f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f7a0: 2020 666f 7220 6361 6c6c 6261 636b 5f6d    for callback_m
+0000f7b0: 616e 6167 6572 2c20 696e 7075 742c 2063  anager, input, c
+0000f7c0: 6f6e 6669 6720 696e 207a 6970 280a 2020  onfig in zip(.  
+0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7e0: 2020 6361 6c6c 6261 636b 5f6d 616e 6167    callback_manag
+0000f7f0: 6572 732c 2069 6e70 7574 2c20 636f 6e66  ers, input, conf
+0000f800: 6967 730a 2020 2020 2020 2020 2020 2020  igs.            
+0000f810: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000f820: 2020 290a 2020 2020 2020 2020 290a 2020    ).        ).  
+0000f830: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000f840: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
+0000f850: 735f 636f 6e66 6967 2866 756e 6329 3a0a  s_config(func):.
+0000f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f870: 6b77 6172 6773 5b22 636f 6e66 6967 225d  kwargs["config"]
+0000f880: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0000f890: 2020 2020 2020 2020 2070 6174 6368 5f63           patch_c
+0000f8a0: 6f6e 6669 6728 632c 2063 616c 6c62 6163  onfig(c, callbac
+0000f8b0: 6b73 3d72 6d2e 6765 745f 6368 696c 6428  ks=rm.get_child(
+0000f8c0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000f8d0: 2020 2020 2020 2066 6f72 2063 2c20 726d         for c, rm
+0000f8e0: 2069 6e20 7a69 7028 636f 6e66 6967 732c   in zip(configs,
+0000f8f0: 2072 756e 5f6d 616e 6167 6572 7329 0a20   run_managers). 
+0000f900: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+0000f910: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000f920: 6163 6365 7074 735f 7275 6e5f 6d61 6e61  accepts_run_mana
+0000f930: 6765 7228 6675 6e63 293a 0a20 2020 2020  ger(func):.     
+0000f940: 2020 2020 2020 2020 2020 206b 7761 7267             kwarg
+0000f950: 735b 2272 756e 5f6d 616e 6167 6572 225d  s["run_manager"]
+0000f960: 203d 2072 756e 5f6d 616e 6167 6572 730a   = run_managers.
+0000f970: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000f980: 7574 203d 2061 7761 6974 2066 756e 6328  ut = await func(
+0000f990: 696e 7075 742c 202a 2a6b 7761 7267 7329  input, **kwargs)
+0000f9a0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0000f9b0: 5b63 616c 6c2d 6172 675d 0a20 2020 2020  [call-arg].     
+0000f9c0: 2020 2065 7863 6570 7420 4261 7365 4578     except BaseEx
+0000f9d0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0000f9e0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0000f9f0: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+0000fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa10: 2a28 7275 6e5f 6d61 6e61 6765 722e 6f6e  *(run_manager.on
+0000fa20: 5f63 6861 696e 5f65 7272 6f72 2865 2920  _chain_error(e) 
+0000fa30: 666f 7220 7275 6e5f 6d61 6e61 6765 7220  for run_manager 
+0000fa40: 696e 2072 756e 5f6d 616e 6167 6572 7329  in run_managers)
+0000fa50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000fa60: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+0000fa70: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+0000fa80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fa90: 2072 6574 7572 6e20 6361 7374 284c 6973   return cast(Lis
+0000faa0: 745b 4f75 7470 7574 5d2c 205b 6520 666f  t[Output], [e fo
+0000fab0: 7220 5f20 696e 2069 6e70 7574 5d29 0a20  r _ in input]). 
+0000fac0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000fad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fae0: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
+0000faf0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000fb00: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
+0000fb10: 3a20 4f70 7469 6f6e 616c 5b45 7863 6570  : Optional[Excep
+0000fb20: 7469 6f6e 5d20 3d20 4e6f 6e65 0a20 2020  tion] = None.   
+0000fb30: 2020 2020 2020 2020 2063 6f72 6f73 3a20           coros: 
+0000fb40: 4c69 7374 5b41 7761 6974 6162 6c65 5b4e  List[Awaitable[N
+0000fb50: 6f6e 655d 5d20 3d20 5b5d 0a20 2020 2020  one]] = [].     
+0000fb60: 2020 2020 2020 2066 6f72 2072 756e 5f6d         for run_m
+0000fb70: 616e 6167 6572 2c20 6f75 7420 696e 207a  anager, out in z
+0000fb80: 6970 2872 756e 5f6d 616e 6167 6572 732c  ip(run_managers,
+0000fb90: 206f 7574 7075 7429 3a0a 2020 2020 2020   output):.      
+0000fba0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+0000fbb0: 6e73 7461 6e63 6528 6f75 742c 2045 7863  nstance(out, Exc
+0000fbc0: 6570 7469 6f6e 293a 0a20 2020 2020 2020  eption):.       
+0000fbd0: 2020 2020 2020 2020 2020 2020 2066 6972               fir
+0000fbe0: 7374 5f65 7863 6570 7469 6f6e 203d 2066  st_exception = f
+0000fbf0: 6972 7374 5f65 7863 6570 7469 6f6e 206f  irst_exception o
+0000fc00: 7220 6f75 740a 2020 2020 2020 2020 2020  r out.          
+0000fc10: 2020 2020 2020 2020 2020 636f 726f 732e            coros.
+0000fc20: 6170 7065 6e64 2872 756e 5f6d 616e 6167  append(run_manag
+0000fc30: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
+0000fc40: 7228 6f75 7429 290a 2020 2020 2020 2020  r(out)).        
+0000fc50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc70: 2020 636f 726f 732e 6170 7065 6e64 2872    coros.append(r
+0000fc80: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
+0000fc90: 6169 6e5f 656e 6428 6f75 7429 290a 2020  ain_end(out)).  
+0000fca0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0000fcb0: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
+0000fcc0: 636f 726f 7329 0a20 2020 2020 2020 2020  coros).         
+0000fcd0: 2020 2069 6620 7265 7475 726e 5f65 7863     if return_exc
+0000fce0: 6570 7469 6f6e 7320 6f72 2066 6972 7374  eptions or first
+0000fcf0: 5f65 7863 6570 7469 6f6e 2069 7320 4e6f  _exception is No
+0000fd00: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000fd10: 2020 2020 7265 7475 726e 2063 6173 7428      return cast(
+0000fd20: 4c69 7374 5b4f 7574 7075 745d 2c20 6f75  List[Output], ou
+0000fd30: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
+0000fd40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000fd50: 2020 2020 2020 2020 7261 6973 6520 6669          raise fi
+0000fd60: 7273 745f 6578 6365 7074 696f 6e0a 0a20  rst_exception.. 
+0000fd70: 2020 2064 6566 205f 7472 616e 7366 6f72     def _transfor
+0000fd80: 6d5f 7374 7265 616d 5f77 6974 685f 636f  m_stream_with_co
+0000fd90: 6e66 6967 280a 2020 2020 2020 2020 7365  nfig(.        se
+0000fda0: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0000fdb0: 743a 2049 7465 7261 746f 725b 496e 7075  t: Iterator[Inpu
+0000fdc0: 745d 2c0a 2020 2020 2020 2020 7472 616e  t],.        tran
+0000fdd0: 7366 6f72 6d65 723a 2055 6e69 6f6e 5b0a  sformer: Union[.
+0000fde0: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0000fdf0: 6162 6c65 5b5b 4974 6572 6174 6f72 5b49  able[[Iterator[I
+0000fe00: 6e70 7574 5d5d 2c20 4974 6572 6174 6f72  nput]], Iterator
+0000fe10: 5b4f 7574 7075 745d 5d2c 0a20 2020 2020  [Output]],.     
+0000fe20: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+0000fe30: 5b49 7465 7261 746f 725b 496e 7075 745d  [Iterator[Input]
+0000fe40: 2c20 4361 6c6c 6261 636b 4d61 6e61 6765  , CallbackManage
+0000fe50: 7246 6f72 4368 6169 6e52 756e 5d2c 2049  rForChainRun], I
+0000fe60: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
+0000fe70: 2c0a 2020 2020 2020 2020 2020 2020 4361  ,.            Ca
+0000fe80: 6c6c 6162 6c65 5b0a 2020 2020 2020 2020  llable[.        
+0000fe90: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0000fea0: 2020 2020 2020 2020 2020 2020 2020 4974                It
+0000feb0: 6572 6174 6f72 5b49 6e70 7574 5d2c 0a20  erator[Input],. 
+0000fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fed0: 2020 2043 616c 6c62 6163 6b4d 616e 6167     CallbackManag
+0000fee0: 6572 466f 7243 6861 696e 5275 6e2c 0a20  erForChainRun,. 
+0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff00: 2020 2052 756e 6e61 626c 6543 6f6e 6669     RunnableConfi
+0000ff10: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+0000ff20: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+0000ff30: 2020 2020 2020 4974 6572 6174 6f72 5b4f        Iterator[O
+0000ff40: 7574 7075 745d 2c0a 2020 2020 2020 2020  utput],.        
+0000ff50: 2020 2020 5d2c 0a20 2020 2020 2020 205d      ],.        ]
+0000ff60: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+0000ff70: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+0000ff80: 626c 6543 6f6e 6669 675d 2c0a 2020 2020  bleConfig],.    
+0000ff90: 2020 2020 7275 6e5f 7479 7065 3a20 4f70      run_type: Op
+0000ffa0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000ffb0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+0000ffc0: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+0000ffd0: 6e79 5d2c 0a20 2020 2029 202d 3e20 4974  ny],.    ) -> It
+0000ffe0: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
+0000fff0: 2020 2020 2020 2020 2222 2248 656c 7065          """Helpe
+00010000: 7220 6d65 7468 6f64 2074 6f20 7472 616e  r method to tran
+00010010: 7366 6f72 6d20 616e 2049 7465 7261 746f  sform an Iterato
+00010020: 7220 6f66 2049 6e70 7574 2076 616c 7565  r of Input value
+00010030: 7320 696e 746f 2061 6e20 4974 6572 6174  s into an Iterat
+00010040: 6f72 206f 660a 2020 2020 2020 2020 4f75  or of.        Ou
+00010050: 7470 7574 2076 616c 7565 732c 2077 6974  tput values, wit
+00010060: 6820 6361 6c6c 6261 636b 732e 0a20 2020  h callbacks..   
+00010070: 2020 2020 2055 7365 2074 6869 7320 746f       Use this to
+00010080: 2069 6d70 6c65 6d65 6e74 2060 7374 7265   implement `stre
+00010090: 616d 2829 6020 6f72 2060 7472 616e 7366  am()` or `transf
+000100a0: 6f72 6d28 2960 2069 6e20 5275 6e6e 6162  orm()` in Runnab
+000100b0: 6c65 2073 7562 636c 6173 7365 732e 2222  le subclasses.""
+000100c0: 220a 2020 2020 2020 2020 2320 4d69 7869  ".        # Mixi
+000100d0: 6e20 7468 6174 2069 7320 7573 6564 2062  n that is used b
+000100e0: 7920 626f 7468 2061 7374 7265 616d 206c  y both astream l
+000100f0: 6f67 2061 6e64 2061 7374 7265 616d 2065  og and astream e
+00010100: 7665 6e74 7320 696d 706c 656d 656e 7461  vents implementa
+00010110: 7469 6f6e 0a20 2020 2020 2020 2066 726f  tion.        fro
+00010120: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+00010130: 2e74 7261 6365 7273 2e5f 7374 7265 616d  .tracers._stream
+00010140: 696e 6720 696d 706f 7274 205f 5374 7265  ing import _Stre
+00010150: 616d 696e 6743 616c 6c62 6163 6b48 616e  amingCallbackHan
+00010160: 646c 6572 0a0a 2020 2020 2020 2020 2320  dler..        # 
+00010170: 7465 6520 7468 6520 696e 7075 7420 736f  tee the input so
+00010180: 2077 6520 6361 6e20 6974 6572 6174 6520   we can iterate 
+00010190: 6f76 6572 2069 7420 7477 6963 650a 2020  over it twice.  
+000101a0: 2020 2020 2020 696e 7075 745f 666f 725f        input_for_
+000101b0: 7472 6163 696e 672c 2069 6e70 7574 5f66  tracing, input_f
+000101c0: 6f72 5f74 7261 6e73 666f 726d 203d 2074  or_transform = t
+000101d0: 6565 2869 6e70 7574 2c20 3229 0a20 2020  ee(input, 2).   
+000101e0: 2020 2020 2023 2053 7461 7274 2074 6865       # Start the
+000101f0: 2069 6e70 7574 2069 7465 7261 746f 7220   input iterator 
+00010200: 746f 2065 6e73 7572 6520 7468 6520 696e  to ensure the in
+00010210: 7075 7420 7275 6e6e 6162 6c65 2073 7461  put runnable sta
+00010220: 7274 7320 6265 666f 7265 2074 6869 7320  rts before this 
+00010230: 6f6e 650a 2020 2020 2020 2020 6669 6e61  one.        fina
+00010240: 6c5f 696e 7075 743a 204f 7074 696f 6e61  l_input: Optiona
+00010250: 6c5b 496e 7075 745d 203d 206e 6578 7428  l[Input] = next(
+00010260: 696e 7075 745f 666f 725f 7472 6163 696e  input_for_tracin
+00010270: 672c 204e 6f6e 6529 0a20 2020 2020 2020  g, None).       
+00010280: 2066 696e 616c 5f69 6e70 7574 5f73 7570   final_input_sup
+00010290: 706f 7274 6564 203d 2054 7275 650a 2020  ported = True.  
+000102a0: 2020 2020 2020 6669 6e61 6c5f 6f75 7470        final_outp
+000102b0: 7574 3a20 4f70 7469 6f6e 616c 5b4f 7574  ut: Optional[Out
+000102c0: 7075 745d 203d 204e 6f6e 650a 2020 2020  put] = None.    
+000102d0: 2020 2020 6669 6e61 6c5f 6f75 7470 7574      final_output
+000102e0: 5f73 7570 706f 7274 6564 203d 2054 7275  _supported = Tru
+000102f0: 650a 0a20 2020 2020 2020 2063 6f6e 6669  e..        confi
+00010300: 6720 3d20 656e 7375 7265 5f63 6f6e 6669  g = ensure_confi
+00010310: 6728 636f 6e66 6967 290a 2020 2020 2020  g(config).      
+00010320: 2020 6361 6c6c 6261 636b 5f6d 616e 6167    callback_manag
+00010330: 6572 203d 2067 6574 5f63 616c 6c62 6163  er = get_callbac
+00010340: 6b5f 6d61 6e61 6765 725f 666f 725f 636f  k_manager_for_co
+00010350: 6e66 6967 2863 6f6e 6669 6729 0a20 2020  nfig(config).   
+00010360: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+00010370: 203d 2063 616c 6c62 6163 6b5f 6d61 6e61   = callback_mana
+00010380: 6765 722e 6f6e 5f63 6861 696e 5f73 7461  ger.on_chain_sta
+00010390: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
+000103a0: 6475 6d70 6428 7365 6c66 292c 0a20 2020  dumpd(self),.   
+000103b0: 2020 2020 2020 2020 207b 2269 6e70 7574           {"input
+000103c0: 223a 2022 227d 2c0a 2020 2020 2020 2020  ": ""},.        
+000103d0: 2020 2020 7275 6e5f 7479 7065 3d72 756e      run_type=run
+000103e0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+000103f0: 2020 206e 616d 653d 636f 6e66 6967 2e67     name=config.g
+00010400: 6574 2822 7275 6e5f 6e61 6d65 2229 206f  et("run_name") o
+00010410: 7220 7365 6c66 2e67 6574 5f6e 616d 6528  r self.get_name(
+00010420: 292c 0a20 2020 2020 2020 2020 2020 2072  ),.            r
+00010430: 756e 5f69 643d 636f 6e66 6967 2e70 6f70  un_id=config.pop
+00010440: 2822 7275 6e5f 6964 222c 204e 6f6e 6529  ("run_id", None)
+00010450: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00010460: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00010470: 2020 2020 2063 6869 6c64 5f63 6f6e 6669       child_confi
+00010480: 6720 3d20 7061 7463 685f 636f 6e66 6967  g = patch_config
+00010490: 2863 6f6e 6669 672c 2063 616c 6c62 6163  (config, callbac
+000104a0: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
+000104b0: 6574 5f63 6869 6c64 2829 290a 2020 2020  et_child()).    
+000104c0: 2020 2020 2020 2020 6966 2061 6363 6570          if accep
+000104d0: 7473 5f63 6f6e 6669 6728 7472 616e 7366  ts_config(transf
+000104e0: 6f72 6d65 7229 3a0a 2020 2020 2020 2020  ormer):.        
+000104f0: 2020 2020 2020 2020 6b77 6172 6773 5b22          kwargs["
+00010500: 636f 6e66 6967 225d 203d 2063 6869 6c64  config"] = child
+00010510: 5f63 6f6e 6669 670a 2020 2020 2020 2020  _config.        
+00010520: 2020 2020 6966 2061 6363 6570 7473 5f72      if accepts_r
+00010530: 756e 5f6d 616e 6167 6572 2874 7261 6e73  un_manager(trans
+00010540: 666f 726d 6572 293a 0a20 2020 2020 2020  former):.       
+00010550: 2020 2020 2020 2020 206b 7761 7267 735b           kwargs[
+00010560: 2272 756e 5f6d 616e 6167 6572 225d 203d  "run_manager"] =
+00010570: 2072 756e 5f6d 616e 6167 6572 0a20 2020   run_manager.   
+00010580: 2020 2020 2020 2020 2063 6f6e 7465 7874           context
+00010590: 203d 2063 6f70 795f 636f 6e74 6578 7428   = copy_context(
+000105a0: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+000105b0: 6e74 6578 742e 7275 6e28 7661 725f 6368  ntext.run(var_ch
+000105c0: 696c 645f 7275 6e6e 6162 6c65 5f63 6f6e  ild_runnable_con
+000105d0: 6669 672e 7365 742c 2063 6869 6c64 5f63  fig.set, child_c
+000105e0: 6f6e 6669 6729 0a20 2020 2020 2020 2020  onfig).         
+000105f0: 2020 2069 7465 7261 746f 7220 3d20 636f     iterator = co
+00010600: 6e74 6578 742e 7275 6e28 7472 616e 7366  ntext.run(transf
+00010610: 6f72 6d65 722c 2069 6e70 7574 5f66 6f72  ormer, input_for
+00010620: 5f74 7261 6e73 666f 726d 2c20 2a2a 6b77  _transform, **kw
+00010630: 6172 6773 2920 2023 2074 7970 653a 2069  args)  # type: i
+00010640: 676e 6f72 655b 6172 672d 7479 7065 5d0a  gnore[arg-type].
+00010650: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00010660: 7472 6561 6d5f 6861 6e64 6c65 7220 3a3d  tream_handler :=
+00010670: 206e 6578 7428 0a20 2020 2020 2020 2020   next(.         
+00010680: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
+00010690: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+000106a0: 7428 5f53 7472 6561 6d69 6e67 4361 6c6c  t(_StreamingCall
+000106b0: 6261 636b 4861 6e64 6c65 722c 2068 290a  backHandler, h).
+000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106d0: 2020 2020 666f 7220 6820 696e 2072 756e      for h in run
+000106e0: 5f6d 616e 6167 6572 2e68 616e 646c 6572  _manager.handler
+000106f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00010700: 2020 2020 2020 2320 696e 7374 616e 6365        # instance
+00010710: 2063 6865 636b 204f 4b20 6865 7265 2c20   check OK here, 
+00010720: 6974 2773 2061 206d 6978 696e 0a20 2020  it's a mixin.   
+00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010740: 2069 6620 6973 696e 7374 616e 6365 2868   if isinstance(h
+00010750: 2c20 5f53 7472 6561 6d69 6e67 4361 6c6c  , _StreamingCall
+00010760: 6261 636b 4861 6e64 6c65 7229 2020 2320  backHandler)  # 
+00010770: 7479 7065 3a20 6967 6e6f 7265 5b6d 6973  type: ignore[mis
+00010780: 635d 0a20 2020 2020 2020 2020 2020 2020  c].             
+00010790: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+000107a0: 2020 2020 2020 4e6f 6e65 2c0a 2020 2020        None,.    
+000107b0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+000107c0: 2020 2020 2020 2020 2020 2023 2070 6f70             # pop
+000107d0: 756c 6174 6573 2073 7472 6561 6d65 645f  ulates streamed_
+000107e0: 6f75 7470 7574 2069 6e20 6173 7472 6561  output in astrea
+000107f0: 6d5f 6c6f 6728 2920 6f75 7470 7574 2069  m_log() output i
+00010800: 6620 6e65 6564 6564 0a20 2020 2020 2020  f needed.       
+00010810: 2020 2020 2020 2020 2069 7465 7261 746f           iterato
+00010820: 7220 3d20 7374 7265 616d 5f68 616e 646c  r = stream_handl
+00010830: 6572 2e74 6170 5f6f 7574 7075 745f 6974  er.tap_output_it
+00010840: 6572 2872 756e 5f6d 616e 6167 6572 2e72  er(run_manager.r
+00010850: 756e 5f69 642c 2069 7465 7261 746f 7229  un_id, iterator)
+00010860: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00010870: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010880: 2020 7768 696c 6520 5472 7565 3a0a 2020    while True:.  
+00010890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108a0: 2020 6368 756e 6b3a 204f 7574 7075 7420    chunk: Output 
+000108b0: 3d20 636f 6e74 6578 742e 7275 6e28 6e65  = context.run(ne
+000108c0: 7874 2c20 6974 6572 6174 6f72 2920 2023  xt, iterator)  #
+000108d0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+000108e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108f0: 2020 7969 656c 6420 6368 756e 6b0a 2020    yield chunk.  
+00010900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010910: 2020 6966 2066 696e 616c 5f6f 7574 7075    if final_outpu
+00010920: 745f 7375 7070 6f72 7465 643a 0a20 2020  t_supported:.   
+00010930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010940: 2020 2020 2069 6620 6669 6e61 6c5f 6f75       if final_ou
+00010950: 7470 7574 2069 7320 4e6f 6e65 3a0a 2020  tput is None:.  
+00010960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010970: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
+00010980: 6f75 7470 7574 203d 2063 6875 6e6b 0a20  output = chunk. 
+00010990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109c0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+000109d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109e0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+000109f0: 6e61 6c5f 6f75 7470 7574 203d 2066 696e  nal_output = fin
+00010a00: 616c 5f6f 7574 7075 7420 2b20 6368 756e  al_output + chun
+00010a10: 6b20 2023 2074 7970 653a 2069 676e 6f72  k  # type: ignor
+00010a20: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00010a30: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00010a40: 6365 7074 2054 7970 6545 7272 6f72 3a0a  cept TypeError:.
+00010a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a70: 6669 6e61 6c5f 6f75 7470 7574 203d 2063  final_output = c
+00010a80: 6875 6e6b 0a20 2020 2020 2020 2020 2020  hunk.           
+00010a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010aa0: 2020 2020 2066 696e 616c 5f6f 7574 7075       final_outpu
+00010ab0: 745f 7375 7070 6f72 7465 6420 3d20 4661  t_supported = Fa
+00010ac0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00010ad0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00010ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010af0: 2020 2020 2020 6669 6e61 6c5f 6f75 7470        final_outp
+00010b00: 7574 203d 2063 6875 6e6b 0a20 2020 2020  ut = chunk.     
+00010b10: 2020 2020 2020 2065 7863 6570 7420 5374         except St
+00010b20: 6f70 4974 6572 6174 696f 6e3a 0a20 2020  opIteration:.   
+00010b30: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+00010b40: 730a 2020 2020 2020 2020 2020 2020 666f  s.            fo
+00010b50: 7220 6963 6875 6e6b 2069 6e20 696e 7075  r ichunk in inpu
+00010b60: 745f 666f 725f 7472 6163 696e 673a 0a20  t_for_tracing:. 
+00010b70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010b80: 6620 6669 6e61 6c5f 696e 7075 745f 7375  f final_input_su
+00010b90: 7070 6f72 7465 643a 0a20 2020 2020 2020  pported:.       
+00010ba0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00010bb0: 6669 6e61 6c5f 696e 7075 7420 6973 204e  final_input is N
+00010bc0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00010bd0: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+00010be0: 616c 5f69 6e70 7574 203d 2069 6368 756e  al_input = ichun
+00010bf0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+00010c00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00010c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c20: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c40: 2020 2020 2066 696e 616c 5f69 6e70 7574       final_input
+00010c50: 203d 2066 696e 616c 5f69 6e70 7574 202b   = final_input +
+00010c60: 2069 6368 756e 6b20 2023 2074 7970 653a   ichunk  # type:
+00010c70: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+00010c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c90: 6578 6365 7074 2054 7970 6545 7272 6f72  except TypeError
+00010ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010cb0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00010cc0: 6e61 6c5f 696e 7075 7420 3d20 6963 6875  nal_input = ichu
+00010cd0: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
+00010ce0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010cf0: 696e 616c 5f69 6e70 7574 5f73 7570 706f  inal_input_suppo
+00010d00: 7274 6564 203d 2046 616c 7365 0a20 2020  rted = False.   
+00010d10: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00010d20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00010d30: 2020 2020 2020 2066 696e 616c 5f69 6e70         final_inp
+00010d40: 7574 203d 2069 6368 756e 6b0a 2020 2020  ut = ichunk.    
+00010d50: 2020 2020 6578 6365 7074 2042 6173 6545      except BaseE
+00010d60: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+00010d70: 2020 2020 2020 2020 2020 2072 756e 5f6d             run_m
+00010d80: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+00010d90: 6572 726f 7228 652c 2069 6e70 7574 733d  error(e, inputs=
+00010da0: 6669 6e61 6c5f 696e 7075 7429 0a20 2020  final_input).   
+00010db0: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
+00010dc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010dd0: 2020 2020 2020 2020 2072 756e 5f6d 616e           run_man
+00010de0: 6167 6572 2e6f 6e5f 6368 6169 6e5f 656e  ager.on_chain_en
+00010df0: 6428 6669 6e61 6c5f 6f75 7470 7574 2c20  d(final_output, 
+00010e00: 696e 7075 7473 3d66 696e 616c 5f69 6e70  inputs=final_inp
+00010e10: 7574 290a 0a20 2020 2061 7379 6e63 2064  ut)..    async d
+00010e20: 6566 205f 6174 7261 6e73 666f 726d 5f73  ef _atransform_s
+00010e30: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
+00010e40: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
+00010e50: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+00010e60: 4173 796e 6349 7465 7261 746f 725b 496e  AsyncIterator[In
+00010e70: 7075 745d 2c0a 2020 2020 2020 2020 7472  put],.        tr
+00010e80: 616e 7366 6f72 6d65 723a 2055 6e69 6f6e  ansformer: Union
+00010e90: 5b0a 2020 2020 2020 2020 2020 2020 4361  [.            Ca
+00010ea0: 6c6c 6162 6c65 5b5b 4173 796e 6349 7465  llable[[AsyncIte
+00010eb0: 7261 746f 725b 496e 7075 745d 5d2c 2041  rator[Input]], A
+00010ec0: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
+00010ed0: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
+00010ee0: 2020 2043 616c 6c61 626c 655b 0a20 2020     Callable[.   
+00010ef0: 2020 2020 2020 2020 2020 2020 205b 4173               [As
+00010f00: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
+00010f10: 745d 2c20 4173 796e 6343 616c 6c62 6163  t], AsyncCallbac
+00010f20: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00010f30: 5275 6e5d 2c0a 2020 2020 2020 2020 2020  Run],.          
+00010f40: 2020 2020 2020 4173 796e 6349 7465 7261        AsyncItera
+00010f50: 746f 725b 4f75 7470 7574 5d2c 0a20 2020  tor[Output],.   
+00010f60: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00010f70: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00010f80: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00010f90: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00010fa0: 2020 2020 2020 2020 4173 796e 6349 7465          AsyncIte
+00010fb0: 7261 746f 725b 496e 7075 745d 2c0a 2020  rator[Input],.  
 00010fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fd0: 2020 2020 696e 700a 2020 2020 2020 2020      inp.        
-00010fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ff0: 2020 2020 666f 7220 692c 2069 6e70 2069      for i, inp i
-00011000: 6e20 7a69 7028 7265 6d61 696e 696e 675f  n zip(remaining_
-00011010: 6964 7873 2c20 696e 7075 7473 290a 2020  idxs, inputs).  
-00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011030: 2020 2020 2020 2020 2020 6966 2069 206e            if i n
-00011040: 6f74 2069 6e20 6661 696c 6564 5f69 6e70  ot in failed_inp
-00011050: 7574 735f 6d61 700a 2020 2020 2020 2020  uts_map.        
-00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011070: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00011080: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110a0: 2020 2020 2020 2020 2023 2065 6163 6820           # each 
-000110b0: 7374 6570 2061 2063 6869 6c64 2072 756e  step a child run
-000110c0: 206f 6620 7468 6520 636f 7272 6573 706f   of the correspo
-000110d0: 6e64 696e 6720 726f 6f74 2072 756e 0a20  nding root run. 
-000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110f0: 2020 2020 2020 2020 2020 2070 6174 6368             patch
-00011100: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
-00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
-00011130: 2063 616c 6c62 6163 6b73 3d72 6d2e 6765   callbacks=rm.ge
-00011140: 745f 6368 696c 6428 6622 7365 713a 7374  t_child(f"seq:st
-00011150: 6570 3a7b 7374 6570 6964 782b 317d 2229  ep:{stepidx+1}")
-00011160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011170: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011190: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-000111a0: 2c20 2872 6d2c 2063 6f6e 6669 6729 2069  , (rm, config) i
-000111b0: 6e20 656e 756d 6572 6174 6528 7a69 7028  n enumerate(zip(
-000111c0: 7275 6e5f 6d61 6e61 6765 7273 2c20 636f  run_managers, co
-000111d0: 6e66 6967 7329 290a 2020 2020 2020 2020  nfigs)).        
-000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111f0: 2020 2020 6966 2069 206e 6f74 2069 6e20      if i not in 
-00011200: 6661 696c 6564 5f69 6e70 7574 735f 6d61  failed_inputs_ma
-00011210: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-00011220: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00011230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011240: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
-00011250: 7074 696f 6e73 3d72 6574 7572 6e5f 6578  ptions=return_ex
-00011260: 6365 7074 696f 6e73 2c0a 2020 2020 2020  ceptions,.      
-00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011280: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-00011290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000112b0: 2020 2020 2020 2320 4966 2061 6e20 696e        # If an in
-000112c0: 7075 7420 6661 696c 6564 2c20 6164 6420  put failed, add 
-000112d0: 6974 2074 6f20 7468 6520 6d61 700a 2020  it to the map.  
-000112e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112f0: 2020 666f 7220 692c 2069 6e70 2069 6e20    for i, inp in 
-00011300: 7a69 7028 7265 6d61 696e 696e 675f 6964  zip(remaining_id
-00011310: 7873 2c20 696e 7075 7473 293a 0a20 2020  xs, inputs):.   
-00011320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011330: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00011340: 6365 2869 6e70 2c20 4578 6365 7074 696f  ce(inp, Exceptio
-00011350: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-00011360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011370: 6661 696c 6564 5f69 6e70 7574 735f 6d61  failed_inputs_ma
-00011380: 705b 695d 203d 2069 6e70 0a20 2020 2020  p[i] = inp.     
-00011390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000113a0: 6e70 7574 7320 3d20 5b69 6e70 2066 6f72  nputs = [inp for
-000113b0: 2069 6e70 2069 6e20 696e 7075 7473 2069   inp in inputs i
-000113c0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-000113d0: 2869 6e70 2c20 4578 6365 7074 696f 6e29  (inp, Exception)
-000113e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000113f0: 2020 2020 2020 2320 4966 2061 6c6c 2069        # If all i
-00011400: 6e70 7574 7320 6861 7665 2066 6169 6c65  nputs have faile
-00011410: 642c 2073 746f 7020 7072 6f63 6573 7369  d, stop processi
-00011420: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-00011430: 2020 2020 2020 2069 6620 6c65 6e28 6661         if len(fa
-00011440: 696c 6564 5f69 6e70 7574 735f 6d61 7029  iled_inputs_map)
-00011450: 203d 3d20 6c65 6e28 636f 6e66 6967 7329   == len(configs)
-00011460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011470: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00011480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011490: 2023 2052 6561 7373 656d 626c 6520 7468   # Reassemble th
-000114a0: 6520 6f75 7470 7574 732c 2069 6e73 6572  e outputs, inser
-000114b0: 7469 6e67 2045 7863 6570 7469 6f6e 7320  ting Exceptions 
-000114c0: 666f 7220 6661 696c 6564 2069 6e70 7574  for failed input
-000114d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000114e0: 2020 696e 7075 7473 5f63 6f70 7920 3d20    inputs_copy = 
-000114f0: 696e 7075 7473 2e63 6f70 7928 290a 2020  inputs.copy().  
-00011500: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00011510: 7075 7473 203d 205b 5d0a 2020 2020 2020  puts = [].      
-00011520: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-00011530: 696e 2072 616e 6765 286c 656e 2863 6f6e  in range(len(con
-00011540: 6669 6773 2929 3a0a 2020 2020 2020 2020  figs)):.        
-00011550: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00011560: 2069 6e20 6661 696c 6564 5f69 6e70 7574   in failed_input
-00011570: 735f 6d61 703a 0a20 2020 2020 2020 2020  s_map:.         
-00011580: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00011590: 6e70 7574 732e 6170 7065 6e64 2863 6173  nputs.append(cas
-000115a0: 7428 496e 7075 742c 2066 6169 6c65 645f  t(Input, failed_
-000115b0: 696e 7075 7473 5f6d 6170 5b69 5d29 290a  inputs_map[i])).
-000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000115e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115f0: 2020 696e 7075 7473 2e61 7070 656e 6428    inputs.append(
-00011600: 696e 7075 7473 5f63 6f70 792e 706f 7028  inputs_copy.pop(
-00011610: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
-00011620: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00011630: 2020 2020 2020 666f 7220 692c 2073 7465        for i, ste
-00011640: 7020 696e 2065 6e75 6d65 7261 7465 2873  p in enumerate(s
-00011650: 656c 662e 7374 6570 7329 3a0a 2020 2020  elf.steps):.    
-00011660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011670: 696e 7075 7473 203d 2073 7465 702e 6261  inputs = step.ba
-00011680: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
-00011690: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000116a0: 7574 732c 0a20 2020 2020 2020 2020 2020  uts,.           
-000116b0: 2020 2020 2020 2020 2020 2020 205b 0a20               [. 
-000116c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116d0: 2020 2020 2020 2020 2020 2023 2065 6163             # eac
-000116e0: 6820 7374 6570 2061 2063 6869 6c64 2072  h step a child r
-000116f0: 756e 206f 6620 7468 6520 636f 7272 6573  un of the corres
-00011700: 706f 6e64 696e 6720 726f 6f74 2072 756e  ponding root run
-00011710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011720: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-00011730: 6368 5f63 6f6e 6669 6728 0a20 2020 2020  ch_config(.     
-00011740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011750: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00011760: 672c 2063 616c 6c62 6163 6b73 3d72 6d2e  g, callbacks=rm.
-00011770: 6765 745f 6368 696c 6428 6622 7365 713a  get_child(f"seq:
-00011780: 7374 6570 3a7b 692b 317d 2229 0a20 2020  step:{i+1}").   
-00011790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000117b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117c0: 2020 2020 2020 2066 6f72 2072 6d2c 2063         for rm, c
-000117d0: 6f6e 6669 6720 696e 207a 6970 2872 756e  onfig in zip(run
-000117e0: 5f6d 616e 6167 6572 732c 2063 6f6e 6669  _managers, confi
-000117f0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00011800: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-00011810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011820: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00011830: 6669 6e69 7368 2074 6865 2072 6f6f 7420  finish the root 
-00011840: 7275 6e73 0a20 2020 2020 2020 2065 7863  runs.        exc
-00011850: 6570 7420 4261 7365 4578 6365 7074 696f  ept BaseExceptio
-00011860: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00011870: 2020 2020 666f 7220 726d 2069 6e20 7275      for rm in ru
-00011880: 6e5f 6d61 6e61 6765 7273 3a0a 2020 2020  n_managers:.    
-00011890: 2020 2020 2020 2020 2020 2020 726d 2e6f              rm.o
-000118a0: 6e5f 6368 6169 6e5f 6572 726f 7228 6529  n_chain_error(e)
-000118b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000118c0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-000118d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000118e0: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
-000118f0: 6973 745b 4f75 7470 7574 5d2c 205b 6520  ist[Output], [e 
-00011900: 666f 7220 5f20 696e 2069 6e70 7574 735d  for _ in inputs]
-00011910: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00011920: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011930: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
-00011940: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011950: 2020 2020 6669 7273 745f 6578 6365 7074      first_except
-00011960: 696f 6e3a 204f 7074 696f 6e61 6c5b 4578  ion: Optional[Ex
-00011970: 6365 7074 696f 6e5d 203d 204e 6f6e 650a  ception] = None.
-00011980: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011990: 7275 6e5f 6d61 6e61 6765 722c 206f 7574  run_manager, out
-000119a0: 2069 6e20 7a69 7028 7275 6e5f 6d61 6e61   in zip(run_mana
-000119b0: 6765 7273 2c20 696e 7075 7473 293a 0a20  gers, inputs):. 
-000119c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000119d0: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
-000119e0: 2c20 4578 6365 7074 696f 6e29 3a0a 2020  , Exception):.  
-000119f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a00: 2020 6669 7273 745f 6578 6365 7074 696f    first_exceptio
-00011a10: 6e20 3d20 6669 7273 745f 6578 6365 7074  n = first_except
-00011a20: 696f 6e20 6f72 206f 7574 0a20 2020 2020  ion or out.     
-00011a30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011a40: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-00011a50: 6169 6e5f 6572 726f 7228 6f75 7429 0a20  ain_error(out). 
-00011a60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011a70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00011a80: 2020 2020 2020 2020 2072 756e 5f6d 616e           run_man
-00011a90: 6167 6572 2e6f 6e5f 6368 6169 6e5f 656e  ager.on_chain_en
-00011aa0: 6428 6475 6d70 6428 6f75 7429 290a 2020  d(dumpd(out)).  
-00011ab0: 2020 2020 2020 2020 2020 6966 2072 6574            if ret
-00011ac0: 7572 6e5f 6578 6365 7074 696f 6e73 206f  urn_exceptions o
-00011ad0: 7220 6669 7273 745f 6578 6365 7074 696f  r first_exceptio
-00011ae0: 6e20 6973 204e 6f6e 653a 0a20 2020 2020  n is None:.     
-00011af0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00011b00: 6e20 6361 7374 284c 6973 745b 4f75 7470  n cast(List[Outp
-00011b10: 7574 5d2c 2069 6e70 7574 7329 0a20 2020  ut], inputs).   
-00011b20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00011b30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011b40: 6169 7365 2066 6972 7374 5f65 7863 6570  aise first_excep
-00011b50: 7469 6f6e 0a0a 2020 2020 6173 796e 6320  tion..    async 
-00011b60: 6465 6620 6162 6174 6368 280a 2020 2020  def abatch(.    
-00011b70: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00011b80: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
-00011b90: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
-00011ba0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-00011bb0: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
-00011bc0: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
-00011bd0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
-00011be0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
-00011bf0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
-00011c00: 7863 6570 7469 6f6e 733a 2062 6f6f 6c20  xceptions: bool 
-00011c10: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-00011c20: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00011c30: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00011c40: 2d3e 204c 6973 745b 4f75 7470 7574 5d3a  -> List[Output]:
-00011c50: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-00011c60: 6e67 6368 6169 6e5f 636f 7265 2e62 6574  ngchain_core.bet
-00011c70: 612e 7275 6e6e 6162 6c65 732e 636f 6e74  a.runnables.cont
-00011c80: 6578 7420 696d 706f 7274 2061 636f 6e66  ext import aconf
-00011c90: 6967 5f77 6974 685f 636f 6e74 6578 740a  ig_with_context.
-00011ca0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00011cb0: 6763 6861 696e 5f63 6f72 652e 6361 6c6c  gchain_core.call
-00011cc0: 6261 636b 732e 6d61 6e61 6765 7220 696d  backs.manager im
-00011cd0: 706f 7274 2041 7379 6e63 4361 6c6c 6261  port AsyncCallba
-00011ce0: 636b 4d61 6e61 6765 720a 0a20 2020 2020  ckManager..     
-00011cf0: 2020 2069 6620 6e6f 7420 696e 7075 7473     if not inputs
-00011d00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00011d10: 7475 726e 205b 5d0a 0a20 2020 2020 2020  turn []..       
-00011d20: 2023 2073 6574 7570 2063 616c 6c62 6163   # setup callbac
-00011d30: 6b73 2061 6e64 2063 6f6e 7465 7874 0a20  ks and context. 
-00011d40: 2020 2020 2020 2063 6f6e 6669 6773 203d         configs =
-00011d50: 205b 0a20 2020 2020 2020 2020 2020 2061   [.            a
-00011d60: 636f 6e66 6967 5f77 6974 685f 636f 6e74  config_with_cont
-00011d70: 6578 7428 632c 2073 656c 662e 7374 6570  ext(c, self.step
-00011d80: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-00011d90: 6f72 2063 2069 6e20 6765 745f 636f 6e66  or c in get_conf
-00011da0: 6967 5f6c 6973 7428 636f 6e66 6967 2c20  ig_list(config, 
-00011db0: 6c65 6e28 696e 7075 7473 2929 0a20 2020  len(inputs)).   
-00011dc0: 2020 2020 205d 0a20 2020 2020 2020 2063       ].        c
-00011dd0: 616c 6c62 6163 6b5f 6d61 6e61 6765 7273  allback_managers
-00011de0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00011df0: 2041 7379 6e63 4361 6c6c 6261 636b 4d61   AsyncCallbackMa
-00011e00: 6e61 6765 722e 636f 6e66 6967 7572 6528  nager.configure(
-00011e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011e20: 2069 6e68 6572 6974 6162 6c65 5f63 616c   inheritable_cal
-00011e30: 6c62 6163 6b73 3d63 6f6e 6669 672e 6765  lbacks=config.ge
-00011e40: 7428 2263 616c 6c62 6163 6b73 2229 2c0a  t("callbacks"),.
-00011e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e60: 6c6f 6361 6c5f 6361 6c6c 6261 636b 733d  local_callbacks=
-00011e70: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00011e80: 2020 2020 2020 7665 7262 6f73 653d 4661        verbose=Fa
-00011e90: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00011ea0: 2020 2020 2069 6e68 6572 6974 6162 6c65       inheritable
-00011eb0: 5f74 6167 733d 636f 6e66 6967 2e67 6574  _tags=config.get
-00011ec0: 2822 7461 6773 2229 2c0a 2020 2020 2020  ("tags"),.      
-00011ed0: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
-00011ee0: 7461 6773 3d4e 6f6e 652c 0a20 2020 2020  tags=None,.     
-00011ef0: 2020 2020 2020 2020 2020 2069 6e68 6572             inher
-00011f00: 6974 6162 6c65 5f6d 6574 6164 6174 613d  itable_metadata=
-00011f10: 636f 6e66 6967 2e67 6574 2822 6d65 7461  config.get("meta
-00011f20: 6461 7461 2229 2c0a 2020 2020 2020 2020  data"),.        
-00011f30: 2020 2020 2020 2020 6c6f 6361 6c5f 6d65          local_me
-00011f40: 7461 6461 7461 3d4e 6f6e 652c 0a20 2020  tadata=None,.   
-00011f50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00011f60: 2020 2020 2020 2066 6f72 2063 6f6e 6669         for confi
-00011f70: 6720 696e 2063 6f6e 6669 6773 0a20 2020  g in configs.   
-00011f80: 2020 2020 205d 0a20 2020 2020 2020 2023       ].        #
-00011f90: 2073 7461 7274 2074 6865 2072 6f6f 7420   start the root 
-00011fa0: 7275 6e73 2c20 6f6e 6520 7065 7220 696e  runs, one per in
-00011fb0: 7075 740a 2020 2020 2020 2020 7275 6e5f  put.        run_
-00011fc0: 6d61 6e61 6765 7273 3a20 4c69 7374 5b41  managers: List[A
-00011fd0: 7379 6e63 4361 6c6c 6261 636b 4d61 6e61  syncCallbackMana
-00011fe0: 6765 7246 6f72 4368 6169 6e52 756e 5d20  gerForChainRun] 
-00011ff0: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-00012000: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00012010: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
-00012020: 2020 2020 2020 2063 6d2e 6f6e 5f63 6861         cm.on_cha
-00012030: 696e 5f73 7461 7274 280a 2020 2020 2020  in_start(.      
-00012040: 2020 2020 2020 2020 2020 2020 2020 6475                du
-00012050: 6d70 6428 7365 6c66 292c 0a20 2020 2020  mpd(self),.     
-00012060: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012070: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
-00012080: 2020 2020 2020 2020 2020 6e61 6d65 3d63            name=c
-00012090: 6f6e 6669 672e 6765 7428 2272 756e 5f6e  onfig.get("run_n
-000120a0: 616d 6522 2920 6f72 2073 656c 662e 6765  ame") or self.ge
-000120b0: 745f 6e61 6d65 2829 2c0a 2020 2020 2020  t_name(),.      
-000120c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000120d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000120e0: 636d 2c20 696e 7075 742c 2063 6f6e 6669  cm, input, confi
-000120f0: 6720 696e 207a 6970 2863 616c 6c62 6163  g in zip(callbac
-00012100: 6b5f 6d61 6e61 6765 7273 2c20 696e 7075  k_managers, inpu
-00012110: 7473 2c20 636f 6e66 6967 7329 0a20 2020  ts, configs).   
-00012120: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012130: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00012140: 696e 766f 6b65 202e 6261 7463 6828 2920  invoke .batch() 
-00012150: 6f6e 2065 6163 6820 7374 6570 0a20 2020  on each step.   
-00012160: 2020 2020 2023 2074 6869 7320 7573 6573       # this uses
-00012170: 2062 6174 6368 696e 6720 6f70 7469 6d69   batching optimi
-00012180: 7a61 7469 6f6e 7320 696e 2052 756e 6e61  zations in Runna
-00012190: 626c 6520 7375 6263 6c61 7373 6573 2c20  ble subclasses, 
-000121a0: 6c69 6b65 204c 4c4d 0a20 2020 2020 2020  like LLM.       
-000121b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000121c0: 2020 6966 2072 6574 7572 6e5f 6578 6365    if return_exce
-000121d0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-000121e0: 2020 2020 2020 2020 2320 5472 6163 6b20          # Track 
-000121f0: 7768 6963 6820 696e 7075 7473 2028 6279  which inputs (by
-00012200: 2069 6e64 6578 2920 6661 696c 6564 2073   index) failed s
-00012210: 6f20 6661 720a 2020 2020 2020 2020 2020  o far.          
-00012220: 2020 2020 2020 2320 4966 2061 6e20 696e        # If an in
-00012230: 7075 7420 6861 7320 6661 696c 6564 2069  put has failed i
-00012240: 7420 7769 6c6c 2062 6520 7072 6573 656e  t will be presen
-00012250: 7420 696e 2074 6869 7320 6d61 702c 0a20  t in this map,. 
-00012260: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012270: 2061 6e64 2074 6865 2076 616c 7565 2077   and the value w
-00012280: 696c 6c20 6265 2074 6865 2065 7863 6570  ill be the excep
-00012290: 7469 6f6e 2074 6861 7420 7761 7320 7261  tion that was ra
-000122a0: 6973 6564 2e0a 2020 2020 2020 2020 2020  ised..          
-000122b0: 2020 2020 2020 6661 696c 6564 5f69 6e70        failed_inp
-000122c0: 7574 735f 6d61 703a 2044 6963 745b 696e  uts_map: Dict[in
-000122d0: 742c 2045 7863 6570 7469 6f6e 5d20 3d20  t, Exception] = 
-000122e0: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
-000122f0: 2020 2066 6f72 2073 7465 7069 6478 2c20     for stepidx, 
-00012300: 7374 6570 2069 6e20 656e 756d 6572 6174  step in enumerat
-00012310: 6528 7365 6c66 2e73 7465 7073 293a 0a20  e(self.steps):. 
-00012320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012330: 2020 2023 2041 7373 656d 626c 6520 7468     # Assemble th
-00012340: 6520 6f72 6967 696e 616c 2069 6e64 6578  e original index
-00012350: 6573 206f 6620 7468 6520 7265 6d61 696e  es of the remain
-00012360: 696e 6720 696e 7075 7473 0a20 2020 2020  ing inputs.     
-00012370: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012380: 2028 692e 652e 2074 6865 206f 6e65 7320   (i.e. the ones 
-00012390: 7468 6174 2068 6176 656e 2774 2066 6169  that haven't fai
-000123a0: 6c65 6420 7965 7429 0a20 2020 2020 2020  led yet).       
-000123b0: 2020 2020 2020 2020 2020 2020 2072 656d               rem
-000123c0: 6169 6e69 6e67 5f69 6478 7320 3d20 5b0a  aining_idxs = [.
-000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123e0: 2020 2020 2020 2020 6920 666f 7220 6920          i for i 
-000123f0: 696e 2072 616e 6765 286c 656e 2863 6f6e  in range(len(con
-00012400: 6669 6773 2929 2069 6620 6920 6e6f 7420  figs)) if i not 
-00012410: 696e 2066 6169 6c65 645f 696e 7075 7473  in failed_inputs
-00012420: 5f6d 6170 0a20 2020 2020 2020 2020 2020  _map.           
-00012430: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00012440: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012450: 2049 6e76 6f6b 6520 7468 6520 7374 6570   Invoke the step
-00012460: 206f 6e20 7468 6520 7265 6d61 696e 696e   on the remainin
-00012470: 6720 696e 7075 7473 0a20 2020 2020 2020  g inputs.       
-00012480: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00012490: 7574 7320 3d20 6177 6169 7420 7374 6570  uts = await step
-000124a0: 2e61 6261 7463 6828 0a20 2020 2020 2020  .abatch(.       
-000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124c0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-000124d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000124e0: 6e70 0a20 2020 2020 2020 2020 2020 2020  np.             
-000124f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012500: 6f72 2069 2c20 696e 7020 696e 207a 6970  or i, inp in zip
-00012510: 2872 656d 6169 6e69 6e67 5f69 6478 732c  (remaining_idxs,
-00012520: 2069 6e70 7574 7329 0a20 2020 2020 2020   inputs).       
-00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012540: 2020 2020 2069 6620 6920 6e6f 7420 696e       if i not in
-00012550: 2066 6169 6c65 645f 696e 7075 7473 5f6d   failed_inputs_m
-00012560: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
-00012570: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012590: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125b0: 2020 2020 2320 6561 6368 2073 7465 7020      # each step 
-000125c0: 6120 6368 696c 6420 7275 6e20 6f66 2074  a child run of t
-000125d0: 6865 2063 6f72 7265 7370 6f6e 6469 6e67  he corresponding
-000125e0: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
-000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012600: 2020 2020 2020 7061 7463 685f 636f 6e66        patch_conf
-00012610: 6967 280a 2020 2020 2020 2020 2020 2020  ig(.            
-00012620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012630: 2020 2020 636f 6e66 6967 2c20 6361 6c6c      config, call
-00012640: 6261 636b 733d 726d 2e67 6574 5f63 6869  backs=rm.get_chi
-00012650: 6c64 2866 2273 6571 3a73 7465 703a 7b73  ld(f"seq:step:{s
-00012660: 7465 7069 6478 2b31 7d22 290a 2020 2020  tepidx+1}").    
-00012670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012680: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00012690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126a0: 2020 2020 2020 666f 7220 692c 2028 726d        for i, (rm
-000126b0: 2c20 636f 6e66 6967 2920 696e 2065 6e75  , config) in enu
-000126c0: 6d65 7261 7465 287a 6970 2872 756e 5f6d  merate(zip(run_m
-000126d0: 616e 6167 6572 732c 2063 6f6e 6669 6773  anagers, configs
-000126e0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000126f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012700: 6620 6920 6e6f 7420 696e 2066 6169 6c65  f i not in faile
-00012710: 645f 696e 7075 7473 5f6d 6170 0a20 2020  d_inputs_map.   
-00012720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012730: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00012740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012750: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00012760: 733d 7265 7475 726e 5f65 7863 6570 7469  s=return_excepti
-00012770: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-00012780: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
-00012790: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
-000127a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 2023 2049 6620 616e 2069 6e70 7574 2066   # If an input f
-000127d0: 6169 6c65 642c 2061 6464 2069 7420 746f  ailed, add it to
-000127e0: 2074 6865 206d 6170 0a20 2020 2020 2020   the map.       
-000127f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00012800: 2069 2c20 696e 7020 696e 207a 6970 2872   i, inp in zip(r
-00012810: 656d 6169 6e69 6e67 5f69 6478 732c 2069  emaining_idxs, i
-00012820: 6e70 7574 7329 3a0a 2020 2020 2020 2020  nputs):.        
-00012830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012840: 6966 2069 7369 6e73 7461 6e63 6528 696e  if isinstance(in
-00012850: 702c 2045 7863 6570 7469 6f6e 293a 0a20  p, Exception):. 
-00012860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012870: 2020 2020 2020 2020 2020 2066 6169 6c65             faile
-00012880: 645f 696e 7075 7473 5f6d 6170 5b69 5d20  d_inputs_map[i] 
-00012890: 3d20 696e 700a 2020 2020 2020 2020 2020  = inp.          
-000128a0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
-000128b0: 203d 205b 696e 7020 666f 7220 696e 7020   = [inp for inp 
-000128c0: 696e 2069 6e70 7574 7320 6966 206e 6f74  in inputs if not
-000128d0: 2069 7369 6e73 7461 6e63 6528 696e 702c   isinstance(inp,
-000128e0: 2045 7863 6570 7469 6f6e 295d 0a20 2020   Exception)].   
-000128f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012900: 2023 2049 6620 616c 6c20 696e 7075 7473   # If all inputs
-00012910: 2068 6176 6520 6661 696c 6564 2c20 7374   have failed, st
-00012920: 6f70 2070 726f 6365 7373 696e 670a 2020  op processing.  
-00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012940: 2020 6966 206c 656e 2866 6169 6c65 645f    if len(failed_
-00012950: 696e 7075 7473 5f6d 6170 2920 3d3d 206c  inputs_map) == l
-00012960: 656e 2863 6f6e 6669 6773 293a 0a20 2020  en(configs):.   
-00012970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012980: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-00012990: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-000129a0: 6173 7365 6d62 6c65 2074 6865 206f 7574  assemble the out
-000129b0: 7075 7473 2c20 696e 7365 7274 696e 6720  puts, inserting 
-000129c0: 4578 6365 7074 696f 6e73 2066 6f72 2066  Exceptions for f
-000129d0: 6169 6c65 6420 696e 7075 7473 0a20 2020  ailed inputs.   
-000129e0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000129f0: 7574 735f 636f 7079 203d 2069 6e70 7574  uts_copy = input
-00012a00: 732e 636f 7079 2829 0a20 2020 2020 2020  s.copy().       
-00012a10: 2020 2020 2020 2020 2069 6e70 7574 7320           inputs 
-00012a20: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00012a30: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00012a40: 6e67 6528 6c65 6e28 636f 6e66 6967 7329  nge(len(configs)
-00012a50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012a60: 2020 2020 2020 2069 6620 6920 696e 2066         if i in f
-00012a70: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
-00012a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012a90: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
-00012aa0: 2e61 7070 656e 6428 6361 7374 2849 6e70  .append(cast(Inp
-00012ab0: 7574 2c20 6661 696c 6564 5f69 6e70 7574  ut, failed_input
-00012ac0: 735f 6d61 705b 695d 2929 0a20 2020 2020  s_map[i])).     
-00012ad0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012ae0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012af0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00012b00: 7574 732e 6170 7065 6e64 2869 6e70 7574  uts.append(input
-00012b10: 735f 636f 7079 2e70 6f70 2830 2929 0a20  s_copy.pop(0)). 
-00012b20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00012b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012b40: 2066 6f72 2069 2c20 7374 6570 2069 6e20   for i, step in 
-00012b50: 656e 756d 6572 6174 6528 7365 6c66 2e73  enumerate(self.s
-00012b60: 7465 7073 293a 0a20 2020 2020 2020 2020  teps):.         
-00012b70: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-00012b80: 7320 3d20 6177 6169 7420 7374 6570 2e61  s = await step.a
-00012b90: 6261 7463 6828 0a20 2020 2020 2020 2020  batch(.         
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012bb0: 6e70 7574 732c 0a20 2020 2020 2020 2020  nputs,.         
-00012bc0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00012bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012be0: 2020 2020 2020 2020 2020 2020 2023 2065               # e
-00012bf0: 6163 6820 7374 6570 2061 2063 6869 6c64  ach step a child
-00012c00: 2072 756e 206f 6620 7468 6520 636f 7272   run of the corr
-00012c10: 6573 706f 6e64 696e 6720 726f 6f74 2072  esponding root r
-00012c20: 756e 0a20 2020 2020 2020 2020 2020 2020  un.             
-00012c30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00012c40: 6174 6368 5f63 6f6e 6669 6728 0a20 2020  atch_config(.   
-00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c60: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00012c70: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
-00012c80: 6d2e 6765 745f 6368 696c 6428 6622 7365  m.get_child(f"se
-00012c90: 713a 7374 6570 3a7b 692b 317d 2229 0a20  q:step:{i+1}"). 
-00012ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00012cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cd0: 2020 2020 2020 2020 2066 6f72 2072 6d2c           for rm,
-00012ce0: 2063 6f6e 6669 6720 696e 207a 6970 2872   config in zip(r
-00012cf0: 756e 5f6d 616e 6167 6572 732c 2063 6f6e  un_managers, con
-00012d00: 6669 6773 290a 2020 2020 2020 2020 2020  figs).          
-00012d10: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00012d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d30: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
-00012d40: 2066 696e 6973 6820 7468 6520 726f 6f74   finish the root
-00012d50: 2072 756e 730a 2020 2020 2020 2020 6578   runs.        ex
-00012d60: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
-00012d70: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00012d80: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00012d90: 696f 2e67 6174 6865 7228 2a28 726d 2e6f  io.gather(*(rm.o
-00012da0: 6e5f 6368 6169 6e5f 6572 726f 7228 6529  n_chain_error(e)
-00012db0: 2066 6f72 2072 6d20 696e 2072 756e 5f6d   for rm in run_m
-00012dc0: 616e 6167 6572 7329 290a 2020 2020 2020  anagers)).      
-00012dd0: 2020 2020 2020 6966 2072 6574 7572 6e5f        if return_
-00012de0: 6578 6365 7074 696f 6e73 3a0a 2020 2020  exceptions:.    
-00012df0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012e00: 726e 2063 6173 7428 4c69 7374 5b4f 7574  rn cast(List[Out
-00012e10: 7075 745d 2c20 5b65 2066 6f72 205f 2069  put], [e for _ i
-00012e20: 6e20 696e 7075 7473 5d29 0a20 2020 2020  n inputs]).     
-00012e30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012e40: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00012e50: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-00012e60: 0a20 2020 2020 2020 2020 2020 2066 6972  .            fir
-00012e70: 7374 5f65 7863 6570 7469 6f6e 3a20 4f70  st_exception: Op
-00012e80: 7469 6f6e 616c 5b45 7863 6570 7469 6f6e  tional[Exception
-00012e90: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-00012ea0: 2020 2020 2063 6f72 6f73 3a20 4c69 7374       coros: List
-00012eb0: 5b41 7761 6974 6162 6c65 5b4e 6f6e 655d  [Awaitable[None]
-00012ec0: 5d20 3d20 5b5d 0a20 2020 2020 2020 2020  ] = [].         
-00012ed0: 2020 2066 6f72 2072 756e 5f6d 616e 6167     for run_manag
-00012ee0: 6572 2c20 6f75 7420 696e 207a 6970 2872  er, out in zip(r
-00012ef0: 756e 5f6d 616e 6167 6572 732c 2069 6e70  un_managers, inp
-00012f00: 7574 7329 3a0a 2020 2020 2020 2020 2020  uts):.          
-00012f10: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00012f20: 6e63 6528 6f75 742c 2045 7863 6570 7469  nce(out, Excepti
-00012f30: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00012f40: 2020 2020 2020 2020 2066 6972 7374 5f65           first_e
-00012f50: 7863 6570 7469 6f6e 203d 2066 6972 7374  xception = first
-00012f60: 5f65 7863 6570 7469 6f6e 206f 7220 6f75  _exception or ou
-00012f70: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00012f80: 2020 2020 2020 636f 726f 732e 6170 7065        coros.appe
-00012f90: 6e64 2872 756e 5f6d 616e 6167 6572 2e6f  nd(run_manager.o
-00012fa0: 6e5f 6368 6169 6e5f 6572 726f 7228 6f75  n_chain_error(ou
-00012fb0: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-00012fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012fd0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00012fe0: 726f 732e 6170 7065 6e64 2872 756e 5f6d  ros.append(run_m
-00012ff0: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-00013000: 656e 6428 6475 6d70 6428 6f75 7429 2929  end(dumpd(out)))
-00013010: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00013020: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
-00013030: 7228 2a63 6f72 6f73 290a 2020 2020 2020  r(*coros).      
-00013040: 2020 2020 2020 6966 2072 6574 7572 6e5f        if return_
-00013050: 6578 6365 7074 696f 6e73 206f 7220 6669  exceptions or fi
-00013060: 7273 745f 6578 6365 7074 696f 6e20 6973  rst_exception is
-00013070: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00013080: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-00013090: 7374 284c 6973 745b 4f75 7470 7574 5d2c  st(List[Output],
-000130a0: 2069 6e70 7574 7329 0a20 2020 2020 2020   inputs).       
-000130b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000130c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000130d0: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-000130e0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
-000130f0: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
-00013100: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
-00013110: 743a 2049 7465 7261 746f 725b 496e 7075  t: Iterator[Inpu
-00013120: 745d 2c0a 2020 2020 2020 2020 7275 6e5f  t],.        run_
-00013130: 6d61 6e61 6765 723a 2043 616c 6c62 6163  manager: Callbac
-00013140: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
-00013150: 5275 6e2c 0a20 2020 2020 2020 2063 6f6e  Run,.        con
-00013160: 6669 673a 2052 756e 6e61 626c 6543 6f6e  fig: RunnableCon
-00013170: 6669 672c 0a20 2020 2029 202d 3e20 4974  fig,.    ) -> It
-00013180: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
-00013190: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-000131a0: 6763 6861 696e 5f63 6f72 652e 6265 7461  gchain_core.beta
-000131b0: 2e72 756e 6e61 626c 6573 2e63 6f6e 7465  .runnables.conte
-000131c0: 7874 2069 6d70 6f72 7420 636f 6e66 6967  xt import config
-000131d0: 5f77 6974 685f 636f 6e74 6578 740a 0a20  _with_context.. 
-000131e0: 2020 2020 2020 2073 7465 7073 203d 205b         steps = [
-000131f0: 7365 6c66 2e66 6972 7374 5d20 2b20 7365  self.first] + se
-00013200: 6c66 2e6d 6964 646c 6520 2b20 5b73 656c  lf.middle + [sel
-00013210: 662e 6c61 7374 5d0a 2020 2020 2020 2020  f.last].        
-00013220: 636f 6e66 6967 203d 2063 6f6e 6669 675f  config = config_
-00013230: 7769 7468 5f63 6f6e 7465 7874 2863 6f6e  with_context(con
-00013240: 6669 672c 2073 656c 662e 7374 6570 7329  fig, self.steps)
-00013250: 0a0a 2020 2020 2020 2020 2320 7472 616e  ..        # tran
-00013260: 7366 6f72 6d20 7468 6520 696e 7075 7420  sform the input 
-00013270: 7374 7265 616d 206f 6620 6561 6368 2073  stream of each s
-00013280: 7465 7020 7769 7468 2074 6865 206e 6578  tep with the nex
-00013290: 740a 2020 2020 2020 2020 2320 7374 6570  t.        # step
-000132a0: 7320 7468 6174 2064 6f6e 2774 206e 6174  s that don't nat
-000132b0: 6976 656c 7920 7375 7070 6f72 7420 7472  ively support tr
-000132c0: 616e 7366 6f72 6d69 6e67 2061 6e20 696e  ansforming an in
-000132d0: 7075 7420 7374 7265 616d 2077 696c 6c0a  put stream will.
-000132e0: 2020 2020 2020 2020 2320 6275 6666 6572          # buffer
-000132f0: 2069 6e70 7574 2069 6e20 6d65 6d6f 7279   input in memory
-00013300: 2075 6e74 696c 2061 6c6c 2061 7661 696c   until all avail
-00013310: 6162 6c65 2c20 616e 6420 7468 656e 2073  able, and then s
-00013320: 7461 7274 2065 6d69 7474 696e 6720 6f75  tart emitting ou
-00013330: 7470 7574 0a20 2020 2020 2020 2066 696e  tput.        fin
-00013340: 616c 5f70 6970 656c 696e 6520 3d20 6361  al_pipeline = ca
-00013350: 7374 2849 7465 7261 746f 725b 4f75 7470  st(Iterator[Outp
-00013360: 7574 5d2c 2069 6e70 7574 290a 2020 2020  ut], input).    
-00013370: 2020 2020 666f 7220 7374 6570 2069 6e20      for step in 
-00013380: 7374 6570 733a 0a20 2020 2020 2020 2020  steps:.         
-00013390: 2020 2066 696e 616c 5f70 6970 656c 696e     final_pipelin
-000133a0: 6520 3d20 7374 6570 2e74 7261 6e73 666f  e = step.transfo
-000133b0: 726d 280a 2020 2020 2020 2020 2020 2020  rm(.            
-000133c0: 2020 2020 6669 6e61 6c5f 7069 7065 6c69      final_pipeli
-000133d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000133e0: 2020 2020 7061 7463 685f 636f 6e66 6967      patch_config
-000133f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00013400: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-00013410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013420: 2020 6361 6c6c 6261 636b 733d 7275 6e5f    callbacks=run_
-00013430: 6d61 6e61 6765 722e 6765 745f 6368 696c  manager.get_chil
-00013440: 6428 6622 7365 713a 7374 6570 3a7b 7374  d(f"seq:step:{st
-00013450: 6570 732e 696e 6465 7828 7374 6570 292b  eps.index(step)+
-00013460: 317d 2229 2c0a 2020 2020 2020 2020 2020  1}"),.          
-00013470: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-00013480: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00013490: 666f 7220 6f75 7470 7574 2069 6e20 6669  for output in fi
-000134a0: 6e61 6c5f 7069 7065 6c69 6e65 3a0a 2020  nal_pipeline:.  
-000134b0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-000134c0: 6f75 7470 7574 0a0a 2020 2020 6173 796e  output..    asyn
-000134d0: 6320 6465 6620 5f61 7472 616e 7366 6f72  c def _atransfor
-000134e0: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
-000134f0: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
-00013500: 4173 796e 6349 7465 7261 746f 725b 496e  AsyncIterator[In
-00013510: 7075 745d 2c0a 2020 2020 2020 2020 7275  put],.        ru
-00013520: 6e5f 6d61 6e61 6765 723a 2041 7379 6e63  n_manager: Async
-00013530: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
-00013540: 6f72 4368 6169 6e52 756e 2c0a 2020 2020  orChainRun,.    
-00013550: 2020 2020 636f 6e66 6967 3a20 5275 6e6e      config: Runn
-00013560: 6162 6c65 436f 6e66 6967 2c0a 2020 2020  ableConfig,.    
-00013570: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
-00013580: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
-00013590: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
-000135a0: 696e 5f63 6f72 652e 6265 7461 2e72 756e  in_core.beta.run
-000135b0: 6e61 626c 6573 2e63 6f6e 7465 7874 2069  nables.context i
-000135c0: 6d70 6f72 7420 6163 6f6e 6669 675f 7769  mport aconfig_wi
-000135d0: 7468 5f63 6f6e 7465 7874 0a0a 2020 2020  th_context..    
-000135e0: 2020 2020 7374 6570 7320 3d20 5b73 656c      steps = [sel
-000135f0: 662e 6669 7273 745d 202b 2073 656c 662e  f.first] + self.
-00013600: 6d69 6464 6c65 202b 205b 7365 6c66 2e6c  middle + [self.l
-00013610: 6173 745d 0a20 2020 2020 2020 2063 6f6e  ast].        con
-00013620: 6669 6720 3d20 6163 6f6e 6669 675f 7769  fig = aconfig_wi
-00013630: 7468 5f63 6f6e 7465 7874 2863 6f6e 6669  th_context(confi
-00013640: 672c 2073 656c 662e 7374 6570 7329 0a0a  g, self.steps)..
-00013650: 2020 2020 2020 2020 2320 7374 7265 616d          # stream
-00013660: 2074 6865 206c 6173 7420 7374 6570 730a   the last steps.
-00013670: 2020 2020 2020 2020 2320 7472 616e 7366          # transf
-00013680: 6f72 6d20 7468 6520 696e 7075 7420 7374  orm the input st
-00013690: 7265 616d 206f 6620 6561 6368 2073 7465  ream of each ste
-000136a0: 7020 7769 7468 2074 6865 206e 6578 740a  p with the next.
-000136b0: 2020 2020 2020 2020 2320 7374 6570 7320          # steps 
-000136c0: 7468 6174 2064 6f6e 2774 206e 6174 6976  that don't nativ
-000136d0: 656c 7920 7375 7070 6f72 7420 7472 616e  ely support tran
-000136e0: 7366 6f72 6d69 6e67 2061 6e20 696e 7075  sforming an inpu
-000136f0: 7420 7374 7265 616d 2077 696c 6c0a 2020  t stream will.  
-00013700: 2020 2020 2020 2320 6275 6666 6572 2069        # buffer i
-00013710: 6e70 7574 2069 6e20 6d65 6d6f 7279 2075  nput in memory u
-00013720: 6e74 696c 2061 6c6c 2061 7661 696c 6162  ntil all availab
-00013730: 6c65 2c20 616e 6420 7468 656e 2073 7461  le, and then sta
-00013740: 7274 2065 6d69 7474 696e 6720 6f75 7470  rt emitting outp
-00013750: 7574 0a20 2020 2020 2020 2066 696e 616c  ut.        final
-00013760: 5f70 6970 656c 696e 6520 3d20 6361 7374  _pipeline = cast
-00013770: 2841 7379 6e63 4974 6572 6174 6f72 5b4f  (AsyncIterator[O
-00013780: 7574 7075 745d 2c20 696e 7075 7429 0a20  utput], input). 
-00013790: 2020 2020 2020 2066 6f72 2073 7465 7020         for step 
-000137a0: 696e 2073 7465 7073 3a0a 2020 2020 2020  in steps:.      
-000137b0: 2020 2020 2020 6669 6e61 6c5f 7069 7065        final_pipe
-000137c0: 6c69 6e65 203d 2073 7465 702e 6174 7261  line = step.atra
-000137d0: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-000137e0: 2020 2020 2020 2020 6669 6e61 6c5f 7069          final_pi
-000137f0: 7065 6c69 6e65 2c0a 2020 2020 2020 2020  peline,.        
-00013800: 2020 2020 2020 2020 7061 7463 685f 636f          patch_co
-00013810: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
-00013820: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00013830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013840: 2020 2020 2020 6361 6c6c 6261 636b 733d        callbacks=
-00013850: 7275 6e5f 6d61 6e61 6765 722e 6765 745f  run_manager.get_
-00013860: 6368 696c 6428 6622 7365 713a 7374 6570  child(f"seq:step
-00013870: 3a7b 7374 6570 732e 696e 6465 7828 7374  :{steps.index(st
-00013880: 6570 292b 317d 2229 2c0a 2020 2020 2020  ep)+1}"),.      
-00013890: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-000138a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000138b0: 2020 2061 7379 6e63 2066 6f72 206f 7574     async for out
-000138c0: 7075 7420 696e 2066 696e 616c 5f70 6970  put in final_pip
-000138d0: 656c 696e 653a 0a20 2020 2020 2020 2020  eline:.         
-000138e0: 2020 2079 6965 6c64 206f 7574 7075 740a     yield output.
-000138f0: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-00013900: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
-00013910: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00013920: 2049 7465 7261 746f 725b 496e 7075 745d   Iterator[Input]
-00013930: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
-00013940: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00013950: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00013960: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00013970: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
-00013980: 795d 2c0a 2020 2020 2920 2d3e 2049 7465  y],.    ) -> Ite
-00013990: 7261 746f 725b 4f75 7470 7574 5d3a 0a20  rator[Output]:. 
-000139a0: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
-000139b0: 6d20 7365 6c66 2e5f 7472 616e 7366 6f72  m self._transfor
-000139c0: 6d5f 7374 7265 616d 5f77 6974 685f 636f  m_stream_with_co
-000139d0: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
-000139e0: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-000139f0: 2020 2020 2073 656c 662e 5f74 7261 6e73       self._trans
-00013a00: 666f 726d 2c0a 2020 2020 2020 2020 2020  form,.          
-00013a10: 2020 7061 7463 685f 636f 6e66 6967 2863    patch_config(c
-00013a20: 6f6e 6669 672c 2072 756e 5f6e 616d 653d  onfig, run_name=
-00013a30: 2863 6f6e 6669 6720 6f72 207b 7d29 2e67  (config or {}).g
-00013a40: 6574 2822 7275 6e5f 6e61 6d65 2229 206f  et("run_name") o
-00013a50: 7220 7365 6c66 2e6e 616d 6529 2c0a 2020  r self.name),.  
-00013a60: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-00013a70: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-00013a80: 2020 2064 6566 2073 7472 6561 6d28 0a20     def stream(. 
-00013a90: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00013aa0: 2020 2020 2069 6e70 7574 3a20 496e 7075       input: Inpu
-00013ab0: 742c 0a20 2020 2020 2020 2063 6f6e 6669  t,.        confi
-00013ac0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-00013ad0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-00013ae0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
-00013af0: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
-00013b00: 6e79 5d2c 0a20 2020 2029 202d 3e20 4974  ny],.    ) -> It
-00013b10: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
-00013b20: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-00013b30: 6f6d 2073 656c 662e 7472 616e 7366 6f72  om self.transfor
-00013b40: 6d28 6974 6572 285b 696e 7075 745d 292c  m(iter([input]),
-00013b50: 2063 6f6e 6669 672c 202a 2a6b 7761 7267   config, **kwarg
-00013b60: 7329 0a0a 2020 2020 6173 796e 6320 6465  s)..    async de
-00013b70: 6620 6174 7261 6e73 666f 726d 280a 2020  f atransform(.  
-00013b80: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00013b90: 2020 2020 696e 7075 743a 2041 7379 6e63      input: Async
-00013ba0: 4974 6572 6174 6f72 5b49 6e70 7574 5d2c  Iterator[Input],
-00013bb0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00013bc0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00013bd0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00013be0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00013bf0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00013c00: 5d2c 0a20 2020 2029 202d 3e20 4173 796e  ],.    ) -> Asyn
-00013c10: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00013c20: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00013c30: 2066 6f72 2063 6875 6e6b 2069 6e20 7365   for chunk in se
-00013c40: 6c66 2e5f 6174 7261 6e73 666f 726d 5f73  lf._atransform_s
-00013c50: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
-00013c60: 6728 0a20 2020 2020 2020 2020 2020 2069  g(.            i
-00013c70: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
-00013c80: 2020 7365 6c66 2e5f 6174 7261 6e73 666f    self._atransfo
-00013c90: 726d 2c0a 2020 2020 2020 2020 2020 2020  rm,.            
-00013ca0: 7061 7463 685f 636f 6e66 6967 2863 6f6e  patch_config(con
-00013cb0: 6669 672c 2072 756e 5f6e 616d 653d 2863  fig, run_name=(c
-00013cc0: 6f6e 6669 6720 6f72 207b 7d29 2e67 6574  onfig or {}).get
-00013cd0: 2822 7275 6e5f 6e61 6d65 2229 206f 7220  ("run_name") or 
-00013ce0: 7365 6c66 2e6e 616d 6529 2c0a 2020 2020  self.name),.    
-00013cf0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-00013d00: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
-00013d10: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-00013d20: 6875 6e6b 0a0a 2020 2020 6173 796e 6320  hunk..    async 
-00013d30: 6465 6620 6173 7472 6561 6d28 0a20 2020  def astream(.   
-00013d40: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00013d50: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00013d60: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00013d70: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00013d80: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00013d90: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00013da0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00013db0: 5d2c 0a20 2020 2029 202d 3e20 4173 796e  ],.    ) -> Asyn
-00013dc0: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00013dd0: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00013de0: 2064 6566 2069 6e70 7574 5f61 6974 6572   def input_aiter
-00013df0: 2829 202d 3e20 4173 796e 6349 7465 7261  () -> AsyncItera
-00013e00: 746f 725b 496e 7075 745d 3a0a 2020 2020  tor[Input]:.    
-00013e10: 2020 2020 2020 2020 7969 656c 6420 696e          yield in
-00013e20: 7075 740a 0a20 2020 2020 2020 2061 7379  put..        asy
-00013e30: 6e63 2066 6f72 2063 6875 6e6b 2069 6e20  nc for chunk in 
-00013e40: 7365 6c66 2e61 7472 616e 7366 6f72 6d28  self.atransform(
-00013e50: 696e 7075 745f 6169 7465 7228 292c 2063  input_aiter(), c
-00013e60: 6f6e 6669 672c 202a 2a6b 7761 7267 7329  onfig, **kwargs)
-00013e70: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
-00013e80: 656c 6420 6368 756e 6b0a 0a0a 636c 6173  eld chunk...clas
-00013e90: 7320 5275 6e6e 6162 6c65 5061 7261 6c6c  s RunnableParall
-00013ea0: 656c 2852 756e 6e61 626c 6553 6572 6961  el(RunnableSeria
-00013eb0: 6c69 7a61 626c 655b 496e 7075 742c 2044  lizable[Input, D
-00013ec0: 6963 745b 7374 722c 2041 6e79 5d5d 293a  ict[str, Any]]):
-00013ed0: 0a20 2020 2022 2222 0a20 2020 2041 2072  .    """.    A r
-00013ee0: 756e 6e61 626c 6520 7468 6174 2072 756e  unnable that run
-00013ef0: 7320 6120 6d61 7070 696e 6720 6f66 2072  s a mapping of r
-00013f00: 756e 6e61 626c 6573 2069 6e20 7061 7261  unnables in para
-00013f10: 6c6c 656c 2c0a 2020 2020 616e 6420 7265  llel,.    and re
-00013f20: 7475 726e 7320 6120 6d61 7070 696e 6720  turns a mapping 
-00013f30: 6f66 2074 6865 6972 206f 7574 7075 7473  of their outputs
-00013f40: 2e0a 2020 2020 2222 220a 0a20 2020 2073  ..    """..    s
-00013f50: 7465 7073 3a20 4d61 7070 696e 675b 7374  teps: Mapping[st
-00013f60: 722c 2052 756e 6e61 626c 655b 496e 7075  r, Runnable[Inpu
-00013f70: 742c 2041 6e79 5d5d 0a0a 2020 2020 6465  t, Any]]..    de
-00013f80: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
-00013f90: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00013fa0: 2020 5f5f 7374 6570 733a 204f 7074 696f    __steps: Optio
-00013fb0: 6e61 6c5b 0a20 2020 2020 2020 2020 2020  nal[.           
-00013fc0: 204d 6170 7069 6e67 5b0a 2020 2020 2020   Mapping[.      
-00013fd0: 2020 2020 2020 2020 2020 7374 722c 0a20            str,. 
-00013fe0: 2020 2020 2020 2020 2020 2020 2020 2055                 U
-00013ff0: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
-00014000: 2020 2020 2020 2020 2020 5275 6e6e 6162            Runnab
-00014010: 6c65 5b49 6e70 7574 2c20 416e 795d 2c0a  le[Input, Any],.
-00014020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014030: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00014040: 7075 745d 2c20 416e 795d 2c0a 2020 2020  put], Any],.    
-00014050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014060: 4d61 7070 696e 675b 7374 722c 2055 6e69  Mapping[str, Uni
-00014070: 6f6e 5b52 756e 6e61 626c 655b 496e 7075  on[Runnable[Inpu
-00014080: 742c 2041 6e79 5d2c 2043 616c 6c61 626c  t, Any], Callabl
-00014090: 655b 5b49 6e70 7574 5d2c 2041 6e79 5d5d  e[[Input], Any]]
-000140a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000140b0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-000140c0: 2020 5d0a 2020 2020 2020 2020 5d20 3d20    ].        ] = 
-000140d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-000140e0: 6b77 6172 6773 3a20 556e 696f 6e5b 0a20  kwargs: Union[. 
-000140f0: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
-00014100: 626c 655b 496e 7075 742c 2041 6e79 5d2c  ble[Input, Any],
-00014110: 0a20 2020 2020 2020 2020 2020 2043 616c  .            Cal
-00014120: 6c61 626c 655b 5b49 6e70 7574 5d2c 2041  lable[[Input], A
-00014130: 6e79 5d2c 0a20 2020 2020 2020 2020 2020  ny],.           
-00014140: 204d 6170 7069 6e67 5b73 7472 2c20 556e   Mapping[str, Un
-00014150: 696f 6e5b 5275 6e6e 6162 6c65 5b49 6e70  ion[Runnable[Inp
-00014160: 7574 2c20 416e 795d 2c20 4361 6c6c 6162  ut, Any], Callab
-00014170: 6c65 5b5b 496e 7075 745d 2c20 416e 795d  le[[Input], Any]
-00014180: 5d5d 2c0a 2020 2020 2020 2020 5d2c 0a20  ]],.        ],. 
-00014190: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-000141a0: 2020 2020 2020 6d65 7267 6564 203d 207b        merged = {
-000141b0: 2a2a 5f5f 7374 6570 737d 2069 6620 5f5f  **__steps} if __
-000141c0: 7374 6570 7320 6973 206e 6f74 204e 6f6e  steps is not Non
-000141d0: 6520 656c 7365 207b 7d0a 2020 2020 2020  e else {}.      
-000141e0: 2020 6d65 7267 6564 2e75 7064 6174 6528    merged.update(
-000141f0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00014200: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-00014210: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-00014220: 6570 733d 7b6b 6579 3a20 636f 6572 6365  eps={key: coerce
-00014230: 5f74 6f5f 7275 6e6e 6162 6c65 2872 2920  _to_runnable(r) 
-00014240: 666f 7220 6b65 792c 2072 2069 6e20 6d65  for key, r in me
-00014250: 7267 6564 2e69 7465 6d73 2829 7d0a 2020  rged.items()}.  
-00014260: 2020 2020 2020 290a 0a20 2020 2040 636c        )..    @cl
-00014270: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
-00014280: 6620 6973 5f6c 635f 7365 7269 616c 697a  f is_lc_serializ
-00014290: 6162 6c65 2863 6c73 2920 2d3e 2062 6f6f  able(cls) -> boo
-000142a0: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
-000142b0: 6e20 5472 7565 0a0a 2020 2020 4063 6c61  n True..    @cla
-000142c0: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
-000142d0: 2067 6574 5f6c 635f 6e61 6d65 7370 6163   get_lc_namespac
-000142e0: 6528 636c 7329 202d 3e20 4c69 7374 5b73  e(cls) -> List[s
-000142f0: 7472 5d3a 0a20 2020 2020 2020 2022 2222  tr]:.        """
-00014300: 4765 7420 7468 6520 6e61 6d65 7370 6163  Get the namespac
-00014310: 6520 6f66 2074 6865 206c 616e 6763 6861  e of the langcha
-00014320: 696e 206f 626a 6563 742e 2222 220a 2020  in object.""".  
-00014330: 2020 2020 2020 7265 7475 726e 205b 226c        return ["l
-00014340: 616e 6763 6861 696e 222c 2022 7363 6865  angchain", "sche
-00014350: 6d61 222c 2022 7275 6e6e 6162 6c65 225d  ma", "runnable"]
-00014360: 0a0a 2020 2020 636c 6173 7320 436f 6e66  ..    class Conf
-00014370: 6967 3a0a 2020 2020 2020 2020 6172 6269  ig:.        arbi
-00014380: 7472 6172 795f 7479 7065 735f 616c 6c6f  trary_types_allo
-00014390: 7765 6420 3d20 5472 7565 0a0a 2020 2020  wed = True..    
-000143a0: 6465 6620 6765 745f 6e61 6d65 280a 2020  def get_name(.  
-000143b0: 2020 2020 2020 7365 6c66 2c20 7375 6666        self, suff
-000143c0: 6978 3a20 4f70 7469 6f6e 616c 5b73 7472  ix: Optional[str
-000143d0: 5d20 3d20 4e6f 6e65 2c20 2a2c 206e 616d  ] = None, *, nam
-000143e0: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
-000143f0: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-00014400: 2073 7472 3a0a 2020 2020 2020 2020 6e61   str:.        na
-00014410: 6d65 203d 206e 616d 6520 6f72 2073 656c  me = name or sel
-00014420: 662e 6e61 6d65 206f 7220 6622 5275 6e6e  f.name or f"Runn
-00014430: 6162 6c65 5061 7261 6c6c 656c 3c7b 272c  ableParallel<{',
-00014440: 272e 6a6f 696e 2873 656c 662e 7374 6570  '.join(self.step
-00014450: 732e 6b65 7973 2829 297d 3e22 0a20 2020  s.keys())}>".   
-00014460: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-00014470: 7228 292e 6765 745f 6e61 6d65 2873 7566  r().get_name(suf
-00014480: 6669 782c 206e 616d 653d 6e61 6d65 290a  fix, name=name).
-00014490: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-000144a0: 2020 2064 6566 2049 6e70 7574 5479 7065     def InputType
-000144b0: 2873 656c 6629 202d 3e20 416e 793a 0a20  (self) -> Any:. 
-000144c0: 2020 2020 2020 2066 6f72 2073 7465 7020         for step 
-000144d0: 696e 2073 656c 662e 7374 6570 732e 7661  in self.steps.va
-000144e0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-000144f0: 2020 2020 6966 2073 7465 702e 496e 7075      if step.Inpu
-00014500: 7454 7970 653a 0a20 2020 2020 2020 2020  tType:.         
-00014510: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
-00014520: 6570 2e49 6e70 7574 5479 7065 0a0a 2020  ep.InputType..  
-00014530: 2020 2020 2020 7265 7475 726e 2041 6e79        return Any
-00014540: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
-00014550: 7075 745f 7363 6865 6d61 280a 2020 2020  put_schema(.    
-00014560: 2020 2020 7365 6c66 2c20 636f 6e66 6967      self, config
-00014570: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00014580: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00014590: 650a 2020 2020 2920 2d3e 2054 7970 655b  e.    ) -> Type[
-000145a0: 4261 7365 4d6f 6465 6c5d 3a0a 2020 2020  BaseModel]:.    
-000145b0: 2020 2020 6966 2061 6c6c 280a 2020 2020      if all(.    
-000145c0: 2020 2020 2020 2020 732e 6765 745f 696e          s.get_in
-000145d0: 7075 745f 7363 6865 6d61 2863 6f6e 6669  put_schema(confi
-000145e0: 6729 2e73 6368 656d 6128 292e 6765 7428  g).schema().get(
-000145f0: 2274 7970 6522 2c20 226f 626a 6563 7422  "type", "object"
-00014600: 2920 3d3d 2022 6f62 6a65 6374 220a 2020  ) == "object".  
-00014610: 2020 2020 2020 2020 2020 666f 7220 7320            for s 
-00014620: 696e 2073 656c 662e 7374 6570 732e 7661  in self.steps.va
-00014630: 6c75 6573 2829 0a20 2020 2020 2020 2029  lues().        )
-00014640: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00014650: 5468 6973 2069 7320 636f 7272 6563 742c  This is correct,
-00014660: 2062 7574 2070 7964 616e 7469 6320 7479   but pydantic ty
-00014670: 7069 6e67 732f 6d79 7079 2064 6f6e 2774  pings/mypy don't
-00014680: 2074 6869 6e6b 2073 6f2e 0a20 2020 2020   think so..     
-00014690: 2020 2020 2020 2072 6574 7572 6e20 6372         return cr
-000146a0: 6561 7465 5f6d 6f64 656c 2820 2023 2074  eate_model(  # t
-000146b0: 7970 653a 2069 676e 6f72 655b 6361 6c6c  ype: ignore[call
-000146c0: 2d6f 7665 726c 6f61 645d 0a20 2020 2020  -overload].     
-000146d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000146e0: 6765 745f 6e61 6d65 2822 496e 7075 7422  get_name("Input"
-000146f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00014700: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
-00014710: 2020 2020 2020 2020 2020 206b 3a20 2876             k: (v
-00014720: 2e61 6e6e 6f74 6174 696f 6e2c 2076 2e64  .annotation, v.d
-00014730: 6566 6175 6c74 290a 2020 2020 2020 2020  efault).        
-00014740: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00014750: 7374 6570 2069 6e20 7365 6c66 2e73 7465  step in self.ste
-00014760: 7073 2e76 616c 7565 7328 290a 2020 2020  ps.values().    
-00014770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014780: 666f 7220 6b2c 2076 2069 6e20 7374 6570  for k, v in step
-00014790: 2e67 6574 5f69 6e70 7574 5f73 6368 656d  .get_input_schem
-000147a0: 6128 636f 6e66 6967 292e 5f5f 6669 656c  a(config).__fiel
-000147b0: 6473 5f5f 2e69 7465 6d73 2829 0a20 2020  ds__.items().   
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147d0: 2069 6620 6b20 213d 2022 5f5f 726f 6f74   if k != "__root
-000147e0: 5f5f 220a 2020 2020 2020 2020 2020 2020  __".            
-000147f0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00014800: 2020 2020 2020 205f 5f63 6f6e 6669 675f         __config_
-00014810: 5f3d 5f53 6368 656d 6143 6f6e 6669 672c  _=_SchemaConfig,
-00014820: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00014830: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00014840: 7570 6572 2829 2e67 6574 5f69 6e70 7574  uper().get_input
-00014850: 5f73 6368 656d 6128 636f 6e66 6967 290a  _schema(config).
-00014860: 0a20 2020 2064 6566 2067 6574 5f6f 7574  .    def get_out
-00014870: 7075 745f 7363 6865 6d61 280a 2020 2020  put_schema(.    
-00014880: 2020 2020 7365 6c66 2c20 636f 6e66 6967      self, config
-00014890: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-000148a0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-000148b0: 650a 2020 2020 2920 2d3e 2054 7970 655b  e.    ) -> Type[
-000148c0: 4261 7365 4d6f 6465 6c5d 3a0a 2020 2020  BaseModel]:.    
-000148d0: 2020 2020 2320 5468 6973 2069 7320 636f      # This is co
-000148e0: 7272 6563 742c 2062 7574 2070 7964 616e  rrect, but pydan
-000148f0: 7469 6320 7479 7069 6e67 732f 6d79 7079  tic typings/mypy
-00014900: 2064 6f6e 2774 2074 6869 6e6b 2073 6f2e   don't think so.
-00014910: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00014920: 6372 6561 7465 5f6d 6f64 656c 2820 2023  create_model(  #
-00014930: 2074 7970 653a 2069 676e 6f72 655b 6361   type: ignore[ca
-00014940: 6c6c 2d6f 7665 726c 6f61 645d 0a20 2020  ll-overload].   
-00014950: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00014960: 745f 6e61 6d65 2822 4f75 7470 7574 2229  t_name("Output")
-00014970: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00014980: 7b6b 3a20 2876 2e4f 7574 7075 7454 7970  {k: (v.OutputTyp
-00014990: 652c 204e 6f6e 6529 2066 6f72 206b 2c20  e, None) for k, 
-000149a0: 7620 696e 2073 656c 662e 7374 6570 732e  v in self.steps.
-000149b0: 6974 656d 7328 297d 2c0a 2020 2020 2020  items()},.      
-000149c0: 2020 2020 2020 5f5f 636f 6e66 6967 5f5f        __config__
-000149d0: 3d5f 5363 6865 6d61 436f 6e66 6967 2c0a  =_SchemaConfig,.
-000149e0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-000149f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00014a00: 2063 6f6e 6669 675f 7370 6563 7328 7365   config_specs(se
-00014a10: 6c66 2920 2d3e 204c 6973 745b 436f 6e66  lf) -> List[Conf
-00014a20: 6967 7572 6162 6c65 4669 656c 6453 7065  igurableFieldSpe
-00014a30: 635d 3a0a 2020 2020 2020 2020 7265 7475  c]:.        retu
-00014a40: 726e 2067 6574 5f75 6e69 7175 655f 636f  rn get_unique_co
-00014a50: 6e66 6967 5f73 7065 6373 280a 2020 2020  nfig_specs(.    
-00014a60: 2020 2020 2020 2020 7370 6563 2066 6f72          spec for
-00014a70: 2073 7465 7020 696e 2073 656c 662e 7374   step in self.st
-00014a80: 6570 732e 7661 6c75 6573 2829 2066 6f72  eps.values() for
-00014a90: 2073 7065 6320 696e 2073 7465 702e 636f   spec in step.co
-00014aa0: 6e66 6967 5f73 7065 6373 0a20 2020 2020  nfig_specs.     
-00014ab0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
-00014ac0: 745f 6772 6170 6828 7365 6c66 2c20 636f  t_graph(self, co
-00014ad0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-00014ae0: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-00014af0: 204e 6f6e 6529 202d 3e20 4772 6170 683a   None) -> Graph:
-00014b00: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-00014b10: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
-00014b20: 6e61 626c 6573 2e67 7261 7068 2069 6d70  nables.graph imp
-00014b30: 6f72 7420 4772 6170 680a 0a20 2020 2020  ort Graph..     
-00014b40: 2020 2067 7261 7068 203d 2047 7261 7068     graph = Graph
-00014b50: 2829 0a20 2020 2020 2020 2069 6e70 7574  ().        input
-00014b60: 5f6e 6f64 6520 3d20 6772 6170 682e 6164  _node = graph.ad
-00014b70: 645f 6e6f 6465 2873 656c 662e 6765 745f  d_node(self.get_
-00014b80: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
-00014b90: 6669 6729 290a 2020 2020 2020 2020 6f75  fig)).        ou
-00014ba0: 7470 7574 5f6e 6f64 6520 3d20 6772 6170  tput_node = grap
-00014bb0: 682e 6164 645f 6e6f 6465 2873 656c 662e  h.add_node(self.
-00014bc0: 6765 745f 6f75 7470 7574 5f73 6368 656d  get_output_schem
-00014bd0: 6128 636f 6e66 6967 2929 0a20 2020 2020  a(config)).     
-00014be0: 2020 2066 6f72 2073 7465 7020 696e 2073     for step in s
-00014bf0: 656c 662e 7374 6570 732e 7661 6c75 6573  elf.steps.values
-00014c00: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00014c10: 7374 6570 5f67 7261 7068 203d 2073 7465  step_graph = ste
-00014c20: 702e 6765 745f 6772 6170 6828 290a 2020  p.get_graph().  
-00014c30: 2020 2020 2020 2020 2020 7374 6570 5f67            step_g
-00014c40: 7261 7068 2e74 7269 6d5f 6669 7273 745f  raph.trim_first_
-00014c50: 6e6f 6465 2829 0a20 2020 2020 2020 2020  node().         
-00014c60: 2020 2073 7465 705f 6772 6170 682e 7472     step_graph.tr
-00014c70: 696d 5f6c 6173 745f 6e6f 6465 2829 0a20  im_last_node(). 
-00014c80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014c90: 7420 7374 6570 5f67 7261 7068 3a0a 2020  t step_graph:.  
-00014ca0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00014cb0: 6170 682e 6164 645f 6564 6765 2869 6e70  aph.add_edge(inp
-00014cc0: 7574 5f6e 6f64 652c 206f 7574 7075 745f  ut_node, output_
-00014cd0: 6e6f 6465 290a 2020 2020 2020 2020 2020  node).          
-00014ce0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014cf0: 2020 2020 2020 2020 6772 6170 682e 6578          graph.ex
-00014d00: 7465 6e64 2873 7465 705f 6772 6170 6829  tend(step_graph)
-00014d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014d20: 2073 7465 705f 6669 7273 745f 6e6f 6465   step_first_node
-00014d30: 203d 2073 7465 705f 6772 6170 682e 6669   = step_graph.fi
-00014d40: 7273 745f 6e6f 6465 2829 0a20 2020 2020  rst_node().     
-00014d50: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014d60: 7420 7374 6570 5f66 6972 7374 5f6e 6f64  t step_first_nod
-00014d70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00014d80: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00014d90: 7565 4572 726f 7228 6622 5275 6e6e 6162  ueError(f"Runnab
-00014da0: 6c65 207b 7374 6570 7d20 6861 7320 6e6f  le {step} has no
-00014db0: 2066 6972 7374 206e 6f64 6522 290a 2020   first node").  
-00014dc0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00014dd0: 6570 5f6c 6173 745f 6e6f 6465 203d 2073  ep_last_node = s
-00014de0: 7465 705f 6772 6170 682e 6c61 7374 5f6e  tep_graph.last_n
-00014df0: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
-00014e00: 2020 2020 2020 6966 206e 6f74 2073 7465        if not ste
-00014e10: 705f 6c61 7374 5f6e 6f64 653a 0a20 2020  p_last_node:.   
-00014e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e30: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00014e40: 7228 6622 5275 6e6e 6162 6c65 207b 7374  r(f"Runnable {st
-00014e50: 6570 7d20 6861 7320 6e6f 206c 6173 7420  ep} has no last 
-00014e60: 6e6f 6465 2229 0a20 2020 2020 2020 2020  node").         
-00014e70: 2020 2020 2020 2067 7261 7068 2e61 6464         graph.add
-00014e80: 5f65 6467 6528 696e 7075 745f 6e6f 6465  _edge(input_node
-00014e90: 2c20 7374 6570 5f66 6972 7374 5f6e 6f64  , step_first_nod
-00014ea0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00014eb0: 2020 2067 7261 7068 2e61 6464 5f65 6467     graph.add_edg
-00014ec0: 6528 7374 6570 5f6c 6173 745f 6e6f 6465  e(step_last_node
-00014ed0: 2c20 6f75 7470 7574 5f6e 6f64 6529 0a0a  , output_node)..
-00014ee0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-00014ef0: 7261 7068 0a0a 2020 2020 6465 6620 5f5f  raph..    def __
-00014f00: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
-00014f10: 7374 723a 0a20 2020 2020 2020 206d 6170  str:.        map
-00014f20: 5f66 6f72 5f72 6570 7220 3d20 222c 5c6e  _for_repr = ",\n
-00014f30: 2020 222e 6a6f 696e 280a 2020 2020 2020    ".join(.      
-00014f40: 2020 2020 2020 6622 7b6b 7d3a 207b 696e        f"{k}: {in
-00014f50: 6465 6e74 5f6c 696e 6573 5f61 6674 6572  dent_lines_after
-00014f60: 5f66 6972 7374 2872 6570 7228 7629 2c20  _first(repr(v), 
-00014f70: 2720 2027 202b 206b 202b 2027 3a20 2729  '  ' + k + ': ')
-00014f80: 7d22 0a20 2020 2020 2020 2020 2020 2066  }".            f
-00014f90: 6f72 206b 2c20 7620 696e 2073 656c 662e  or k, v in self.
-00014fa0: 7374 6570 732e 6974 656d 7328 290a 2020  steps.items().  
-00014fb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014fc0: 7265 7475 726e 2022 7b5c 6e20 2022 202b  return "{\n  " +
-00014fd0: 206d 6170 5f66 6f72 5f72 6570 7220 2b20   map_for_repr + 
-00014fe0: 225c 6e7d 220a 0a20 2020 2064 6566 2069  "\n}"..    def i
-00014ff0: 6e76 6f6b 6528 0a20 2020 2020 2020 2073  nvoke(.        s
-00015000: 656c 662c 2069 6e70 7574 3a20 496e 7075  elf, input: Inpu
-00015010: 742c 2063 6f6e 6669 673a 204f 7074 696f  t, config: Optio
-00015020: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00015030: 6967 5d20 3d20 4e6f 6e65 0a20 2020 2029  ig] = None.    )
-00015040: 202d 3e20 4469 6374 5b73 7472 2c20 416e   -> Dict[str, An
-00015050: 795d 3a0a 2020 2020 2020 2020 6672 6f6d  y]:.        from
-00015060: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
-00015070: 6361 6c6c 6261 636b 732e 6d61 6e61 6765  callbacks.manage
-00015080: 7220 696d 706f 7274 2043 616c 6c62 6163  r import Callbac
-00015090: 6b4d 616e 6167 6572 0a0a 2020 2020 2020  kManager..      
-000150a0: 2020 2320 7365 7475 7020 6361 6c6c 6261    # setup callba
-000150b0: 636b 730a 2020 2020 2020 2020 636f 6e66  cks.        conf
-000150c0: 6967 203d 2065 6e73 7572 655f 636f 6e66  ig = ensure_conf
-000150d0: 6967 2863 6f6e 6669 6729 0a20 2020 2020  ig(config).     
-000150e0: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
-000150f0: 6765 7220 3d20 4361 6c6c 6261 636b 4d61  ger = CallbackMa
-00015100: 6e61 6765 722e 636f 6e66 6967 7572 6528  nager.configure(
-00015110: 0a20 2020 2020 2020 2020 2020 2069 6e68  .            inh
-00015120: 6572 6974 6162 6c65 5f63 616c 6c62 6163  eritable_callbac
-00015130: 6b73 3d63 6f6e 6669 672e 6765 7428 2263  ks=config.get("c
-00015140: 616c 6c62 6163 6b73 2229 2c0a 2020 2020  allbacks"),.    
-00015150: 2020 2020 2020 2020 6c6f 6361 6c5f 6361          local_ca
-00015160: 6c6c 6261 636b 733d 4e6f 6e65 2c0a 2020  llbacks=None,.  
-00015170: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-00015180: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
-00015190: 2020 2020 2069 6e68 6572 6974 6162 6c65       inheritable
-000151a0: 5f74 6167 733d 636f 6e66 6967 2e67 6574  _tags=config.get
-000151b0: 2822 7461 6773 2229 2c0a 2020 2020 2020  ("tags"),.      
-000151c0: 2020 2020 2020 6c6f 6361 6c5f 7461 6773        local_tags
-000151d0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-000151e0: 2020 2069 6e68 6572 6974 6162 6c65 5f6d     inheritable_m
-000151f0: 6574 6164 6174 613d 636f 6e66 6967 2e67  etadata=config.g
-00015200: 6574 2822 6d65 7461 6461 7461 2229 2c0a  et("metadata"),.
-00015210: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
-00015220: 6c5f 6d65 7461 6461 7461 3d4e 6f6e 652c  l_metadata=None,
-00015230: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00015240: 2020 2023 2073 7461 7274 2074 6865 2072     # start the r
-00015250: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
-00015260: 7275 6e5f 6d61 6e61 6765 7220 3d20 6361  run_manager = ca
-00015270: 6c6c 6261 636b 5f6d 616e 6167 6572 2e6f  llback_manager.o
-00015280: 6e5f 6368 6169 6e5f 7374 6172 7428 0a20  n_chain_start(. 
-00015290: 2020 2020 2020 2020 2020 2064 756d 7064             dumpd
-000152a0: 2873 656c 6629 2c20 696e 7075 742c 206e  (self), input, n
-000152b0: 616d 653d 636f 6e66 6967 2e67 6574 2822  ame=config.get("
-000152c0: 7275 6e5f 6e61 6d65 2229 206f 7220 7365  run_name") or se
-000152d0: 6c66 2e67 6574 5f6e 616d 6528 290a 2020  lf.get_name().  
-000152e0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000152f0: 2023 2067 6174 6865 7220 7265 7375 6c74   # gather result
-00015300: 7320 6672 6f6d 2061 6c6c 2073 7465 7073  s from all steps
-00015310: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00015320: 2020 2020 2020 2020 2020 2320 636f 7079            # copy
-00015330: 2074 6f20 6176 6f69 6420 6973 7375 6573   to avoid issues
-00015340: 2066 726f 6d20 7468 6520 6361 6c6c 6572   from the caller
-00015350: 206d 7574 6174 696e 6720 7468 6520 7374   mutating the st
-00015360: 6570 7320 6475 7269 6e67 2069 6e76 6f6b  eps during invok
-00015370: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00015380: 7374 6570 7320 3d20 6469 6374 2873 656c  steps = dict(sel
-00015390: 662e 7374 6570 7329 0a20 2020 2020 2020  f.steps).       
-000153a0: 2020 2020 2077 6974 6820 6765 745f 6578       with get_ex
-000153b0: 6563 7574 6f72 5f66 6f72 5f63 6f6e 6669  ecutor_for_confi
-000153c0: 6728 636f 6e66 6967 2920 6173 2065 7865  g(config) as exe
-000153d0: 6375 746f 723a 0a20 2020 2020 2020 2020  cutor:.         
-000153e0: 2020 2020 2020 2066 7574 7572 6573 203d         futures =
-000153f0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00015400: 2020 2020 2020 2065 7865 6375 746f 722e         executor.
-00015410: 7375 626d 6974 280a 2020 2020 2020 2020  submit(.        
-00015420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015430: 7374 6570 2e69 6e76 6f6b 652c 0a20 2020  step.invoke,.   
-00015440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015450: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
-00015460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015470: 2020 2020 2320 6d61 726b 2065 6163 6820      # mark each 
-00015480: 7374 6570 2061 7320 6120 6368 696c 6420  step as a child 
-00015490: 7275 6e0a 2020 2020 2020 2020 2020 2020  run.            
-000154a0: 2020 2020 2020 2020 2020 2020 7061 7463              patc
-000154b0: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
-000154c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154d0: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154f0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
-00015500: 636b 733d 7275 6e5f 6d61 6e61 6765 722e  cks=run_manager.
-00015510: 6765 745f 6368 696c 6428 6622 6d61 703a  get_child(f"map:
-00015520: 6b65 793a 7b6b 6579 7d22 292c 0a20 2020  key:{key}"),.   
+00010fd0: 2020 4173 796e 6343 616c 6c62 6163 6b4d    AsyncCallbackM
+00010fe0: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
+00010ff0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00011000: 2020 2020 2020 2052 756e 6e61 626c 6543         RunnableC
+00011010: 6f6e 6669 672c 0a20 2020 2020 2020 2020  onfig,.         
+00011020: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00011030: 2020 2020 2020 2020 2020 4173 796e 6349            AsyncI
+00011040: 7465 7261 746f 725b 4f75 7470 7574 5d2c  terator[Output],
+00011050: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+00011060: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00011070: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+00011080: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
+00011090: 6967 5d2c 0a20 2020 2020 2020 2072 756e  ig],.        run
+000110a0: 5f74 7970 653a 204f 7074 696f 6e61 6c5b  _type: Optional[
+000110b0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+000110c0: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+000110d0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+000110e0: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
+000110f0: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
+00011100: 2020 2020 2020 2222 2248 656c 7065 7220        """Helper 
+00011110: 6d65 7468 6f64 2074 6f20 7472 616e 7366  method to transf
+00011120: 6f72 6d20 616e 2041 7379 6e63 2049 7465  orm an Async Ite
+00011130: 7261 746f 7220 6f66 2049 6e70 7574 2076  rator of Input v
+00011140: 616c 7565 7320 696e 746f 2061 6e20 4173  alues into an As
+00011150: 796e 630a 2020 2020 2020 2020 4974 6572  ync.        Iter
+00011160: 6174 6f72 206f 6620 4f75 7470 7574 2076  ator of Output v
+00011170: 616c 7565 732c 2077 6974 6820 6361 6c6c  alues, with call
+00011180: 6261 636b 732e 0a20 2020 2020 2020 2055  backs..        U
+00011190: 7365 2074 6869 7320 746f 2069 6d70 6c65  se this to imple
+000111a0: 6d65 6e74 2060 6173 7472 6561 6d28 2960  ment `astream()`
+000111b0: 206f 7220 6061 7472 616e 7366 6f72 6d28   or `atransform(
+000111c0: 2960 2069 6e20 5275 6e6e 6162 6c65 2073  )` in Runnable s
+000111d0: 7562 636c 6173 7365 732e 2222 220a 2020  ubclasses.""".  
+000111e0: 2020 2020 2020 2320 4d69 7869 6e20 7468        # Mixin th
+000111f0: 6174 2069 7320 7573 6564 2062 7920 626f  at is used by bo
+00011200: 7468 2061 7374 7265 616d 206c 6f67 2061  th astream log a
+00011210: 6e64 2061 7374 7265 616d 2065 7665 6e74  nd astream event
+00011220: 7320 696d 706c 656d 656e 7461 7469 6f6e  s implementation
+00011230: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
+00011240: 6e67 6368 6169 6e5f 636f 7265 2e74 7261  ngchain_core.tra
+00011250: 6365 7273 2e5f 7374 7265 616d 696e 6720  cers._streaming 
+00011260: 696d 706f 7274 205f 5374 7265 616d 696e  import _Streamin
+00011270: 6743 616c 6c62 6163 6b48 616e 646c 6572  gCallbackHandler
+00011280: 0a0a 2020 2020 2020 2020 2320 7465 6520  ..        # tee 
+00011290: 7468 6520 696e 7075 7420 736f 2077 6520  the input so we 
+000112a0: 6361 6e20 6974 6572 6174 6520 6f76 6572  can iterate over
+000112b0: 2069 7420 7477 6963 650a 2020 2020 2020   it twice.      
+000112c0: 2020 696e 7075 745f 666f 725f 7472 6163    input_for_trac
+000112d0: 696e 672c 2069 6e70 7574 5f66 6f72 5f74  ing, input_for_t
+000112e0: 7261 6e73 666f 726d 203d 2061 7465 6528  ransform = atee(
+000112f0: 696e 7075 742c 2032 290a 2020 2020 2020  input, 2).      
+00011300: 2020 2320 5374 6172 7420 7468 6520 696e    # Start the in
+00011310: 7075 7420 6974 6572 6174 6f72 2074 6f20  put iterator to 
+00011320: 656e 7375 7265 2074 6865 2069 6e70 7574  ensure the input
+00011330: 2072 756e 6e61 626c 6520 7374 6172 7473   runnable starts
+00011340: 2062 6566 6f72 6520 7468 6973 206f 6e65   before this one
+00011350: 0a20 2020 2020 2020 2066 696e 616c 5f69  .        final_i
+00011360: 6e70 7574 3a20 4f70 7469 6f6e 616c 5b49  nput: Optional[I
+00011370: 6e70 7574 5d20 3d20 6177 6169 7420 7079  nput] = await py
+00011380: 5f61 6e65 7874 2869 6e70 7574 5f66 6f72  _anext(input_for
+00011390: 5f74 7261 6369 6e67 2c20 4e6f 6e65 290a  _tracing, None).
+000113a0: 2020 2020 2020 2020 6669 6e61 6c5f 696e          final_in
+000113b0: 7075 745f 7375 7070 6f72 7465 6420 3d20  put_supported = 
+000113c0: 5472 7565 0a20 2020 2020 2020 2066 696e  True.        fin
+000113d0: 616c 5f6f 7574 7075 743a 204f 7074 696f  al_output: Optio
+000113e0: 6e61 6c5b 4f75 7470 7574 5d20 3d20 4e6f  nal[Output] = No
+000113f0: 6e65 0a20 2020 2020 2020 2066 696e 616c  ne.        final
+00011400: 5f6f 7574 7075 745f 7375 7070 6f72 7465  _output_supporte
+00011410: 6420 3d20 5472 7565 0a0a 2020 2020 2020  d = True..      
+00011420: 2020 636f 6e66 6967 203d 2065 6e73 7572    config = ensur
+00011430: 655f 636f 6e66 6967 2863 6f6e 6669 6729  e_config(config)
+00011440: 0a20 2020 2020 2020 2063 616c 6c62 6163  .        callbac
+00011450: 6b5f 6d61 6e61 6765 7220 3d20 6765 745f  k_manager = get_
+00011460: 6173 796e 635f 6361 6c6c 6261 636b 5f6d  async_callback_m
+00011470: 616e 6167 6572 5f66 6f72 5f63 6f6e 6669  anager_for_confi
+00011480: 6728 636f 6e66 6967 290a 2020 2020 2020  g(config).      
+00011490: 2020 7275 6e5f 6d61 6e61 6765 7220 3d20    run_manager = 
+000114a0: 6177 6169 7420 6361 6c6c 6261 636b 5f6d  await callback_m
+000114b0: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+000114c0: 7374 6172 7428 0a20 2020 2020 2020 2020  start(.         
+000114d0: 2020 2064 756d 7064 2873 656c 6629 2c0a     dumpd(self),.
+000114e0: 2020 2020 2020 2020 2020 2020 7b22 696e              {"in
+000114f0: 7075 7422 3a20 2222 7d2c 0a20 2020 2020  put": ""},.     
+00011500: 2020 2020 2020 2072 756e 5f74 7970 653d         run_type=
+00011510: 7275 6e5f 7479 7065 2c0a 2020 2020 2020  run_type,.      
+00011520: 2020 2020 2020 6e61 6d65 3d63 6f6e 6669        name=confi
+00011530: 672e 6765 7428 2272 756e 5f6e 616d 6522  g.get("run_name"
+00011540: 2920 6f72 2073 656c 662e 6765 745f 6e61  ) or self.get_na
+00011550: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
+00011560: 2020 7275 6e5f 6964 3d63 6f6e 6669 672e    run_id=config.
+00011570: 706f 7028 2272 756e 5f69 6422 2c20 4e6f  pop("run_id", No
+00011580: 6e65 292c 0a20 2020 2020 2020 2029 0a20  ne),.        ). 
+00011590: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000115a0: 2020 2020 2020 2020 6368 696c 645f 636f          child_co
+000115b0: 6e66 6967 203d 2070 6174 6368 5f63 6f6e  nfig = patch_con
+000115c0: 6669 6728 636f 6e66 6967 2c20 6361 6c6c  fig(config, call
+000115d0: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
+000115e0: 722e 6765 745f 6368 696c 6428 2929 0a20  r.get_child()). 
+000115f0: 2020 2020 2020 2020 2020 2069 6620 6163             if ac
+00011600: 6365 7074 735f 636f 6e66 6967 2874 7261  cepts_config(tra
+00011610: 6e73 666f 726d 6572 293a 0a20 2020 2020  nsformer):.     
+00011620: 2020 2020 2020 2020 2020 206b 7761 7267             kwarg
+00011630: 735b 2263 6f6e 6669 6722 5d20 3d20 6368  s["config"] = ch
+00011640: 696c 645f 636f 6e66 6967 0a20 2020 2020  ild_config.     
+00011650: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
+00011660: 735f 7275 6e5f 6d61 6e61 6765 7228 7472  s_run_manager(tr
+00011670: 616e 7366 6f72 6d65 7229 3a0a 2020 2020  ansformer):.    
+00011680: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
+00011690: 6773 5b22 7275 6e5f 6d61 6e61 6765 7222  gs["run_manager"
+000116a0: 5d20 3d20 7275 6e5f 6d61 6e61 6765 720a  ] = run_manager.
+000116b0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000116c0: 6578 7420 3d20 636f 7079 5f63 6f6e 7465  ext = copy_conte
+000116d0: 7874 2829 0a20 2020 2020 2020 2020 2020  xt().           
+000116e0: 2063 6f6e 7465 7874 2e72 756e 2876 6172   context.run(var
+000116f0: 5f63 6869 6c64 5f72 756e 6e61 626c 655f  _child_runnable_
+00011700: 636f 6e66 6967 2e73 6574 2c20 6368 696c  config.set, chil
+00011710: 645f 636f 6e66 6967 290a 2020 2020 2020  d_config).      
+00011720: 2020 2020 2020 6974 6572 6174 6f72 203d        iterator =
+00011730: 2063 6f6e 7465 7874 2e72 756e 2874 7261   context.run(tra
+00011740: 6e73 666f 726d 6572 2c20 696e 7075 745f  nsformer, input_
+00011750: 666f 725f 7472 616e 7366 6f72 6d2c 202a  for_transform, *
+00011760: 2a6b 7761 7267 7329 2020 2320 7479 7065  *kwargs)  # type
+00011770: 3a20 6967 6e6f 7265 5b61 7267 2d74 7970  : ignore[arg-typ
+00011780: 655d 0a0a 2020 2020 2020 2020 2020 2020  e]..            
+00011790: 6966 2073 7472 6561 6d5f 6861 6e64 6c65  if stream_handle
+000117a0: 7220 3a3d 206e 6578 7428 0a20 2020 2020  r := next(.     
+000117b0: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+000117c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117d0: 2063 6173 7428 5f53 7472 6561 6d69 6e67   cast(_Streaming
+000117e0: 4361 6c6c 6261 636b 4861 6e64 6c65 722c  CallbackHandler,
+000117f0: 2068 290a 2020 2020 2020 2020 2020 2020   h).            
+00011800: 2020 2020 2020 2020 666f 7220 6820 696e          for h in
+00011810: 2072 756e 5f6d 616e 6167 6572 2e68 616e   run_manager.han
+00011820: 646c 6572 730a 2020 2020 2020 2020 2020  dlers.          
+00011830: 2020 2020 2020 2020 2020 2320 696e 7374            # inst
+00011840: 616e 6365 2063 6865 636b 204f 4b20 6865  ance check OK he
+00011850: 7265 2c20 6974 2773 2061 206d 6978 696e  re, it's a mixin
+00011860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011870: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00011880: 6365 2868 2c20 5f53 7472 6561 6d69 6e67  ce(h, _Streaming
+00011890: 4361 6c6c 6261 636b 4861 6e64 6c65 7229  CallbackHandler)
+000118a0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+000118b0: 5b6d 6973 635d 0a20 2020 2020 2020 2020  [misc].         
+000118c0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+000118d0: 2020 2020 2020 2020 2020 4e6f 6e65 2c0a            None,.
+000118e0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+000118f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00011900: 2070 6f70 756c 6174 6573 2073 7472 6561   populates strea
+00011910: 6d65 645f 6f75 7470 7574 2069 6e20 6173  med_output in as
+00011920: 7472 6561 6d5f 6c6f 6728 2920 6f75 7470  tream_log() outp
+00011930: 7574 2069 6620 6e65 6564 6564 0a20 2020  ut if needed.   
+00011940: 2020 2020 2020 2020 2020 2020 2069 7465               ite
+00011950: 7261 746f 7220 3d20 7374 7265 616d 5f68  rator = stream_h
+00011960: 616e 646c 6572 2e74 6170 5f6f 7574 7075  andler.tap_outpu
+00011970: 745f 6169 7465 7228 7275 6e5f 6d61 6e61  t_aiter(run_mana
+00011980: 6765 722e 7275 6e5f 6964 2c20 6974 6572  ger.run_id, iter
+00011990: 6174 6f72 290a 2020 2020 2020 2020 2020  ator).          
+000119a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000119b0: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
+000119c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000119d0: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
+000119e0: 735f 636f 6e74 6578 7428 6173 796e 6369  s_context(asynci
+000119f0: 6f2e 6372 6561 7465 5f74 6173 6b29 3a0a  o.create_task):.
+00011a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a10: 2020 2020 2020 2020 6368 756e 6b3a 204f          chunk: O
+00011a20: 7574 7075 7420 3d20 6177 6169 7420 6173  utput = await as
+00011a30: 796e 6369 6f2e 6372 6561 7465 5f74 6173  yncio.create_tas
+00011a40: 6b28 2020 2320 7479 7065 3a20 6967 6e6f  k(  # type: igno
+00011a50: 7265 5b63 616c 6c2d 6172 675d 0a20 2020  re[call-arg].   
+00011a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a70: 2020 2020 2020 2020 2070 795f 616e 6578           py_anex
+00011a80: 7428 6974 6572 6174 6f72 292c 2020 2320  t(iterator),  # 
+00011a90: 7479 7065 3a20 6967 6e6f 7265 5b61 7267  type: ignore[arg
+00011aa0: 2d74 7970 655d 0a20 2020 2020 2020 2020  -type].         
+00011ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ac0: 2020 2063 6f6e 7465 7874 3d63 6f6e 7465     context=conte
+00011ad0: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+00011ae0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00011af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00011b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b20: 6368 756e 6b20 3d20 6361 7374 284f 7574  chunk = cast(Out
+00011b30: 7075 742c 2061 7761 6974 2070 795f 616e  put, await py_an
+00011b40: 6578 7428 6974 6572 6174 6f72 2929 0a20  ext(iterator)). 
+00011b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b60: 2020 2079 6965 6c64 2063 6875 6e6b 0a20     yield chunk. 
+00011b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b80: 2020 2069 6620 6669 6e61 6c5f 6f75 7470     if final_outp
+00011b90: 7574 5f73 7570 706f 7274 6564 3a0a 2020  ut_supported:.  
+00011ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bb0: 2020 2020 2020 6966 2066 696e 616c 5f6f        if final_o
+00011bc0: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
+00011bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011be0: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00011bf0: 5f6f 7574 7075 7420 3d20 6368 756e 6b0a  _output = chunk.
+00011c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c30: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011c60: 696e 616c 5f6f 7574 7075 7420 3d20 6669  inal_output = fi
+00011c70: 6e61 6c5f 6f75 7470 7574 202b 2063 6875  nal_output + chu
+00011c80: 6e6b 2020 2320 7479 7065 3a20 6967 6e6f  nk  # type: igno
+00011c90: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00011ca0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011cb0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
+00011cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ce0: 2066 696e 616c 5f6f 7574 7075 7420 3d20   final_output = 
+00011cf0: 6368 756e 6b0a 2020 2020 2020 2020 2020  chunk.          
+00011d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d10: 2020 2020 2020 6669 6e61 6c5f 6f75 7470        final_outp
+00011d20: 7574 5f73 7570 706f 7274 6564 203d 2046  ut_supported = F
+00011d30: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00011d40: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00011d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d60: 2020 2020 2020 2066 696e 616c 5f6f 7574         final_out
+00011d70: 7075 7420 3d20 6368 756e 6b0a 2020 2020  put = chunk.    
+00011d80: 2020 2020 2020 2020 6578 6365 7074 2053          except S
+00011d90: 746f 7041 7379 6e63 4974 6572 6174 696f  topAsyncIteratio
+00011da0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00011db0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00011dc0: 2020 2020 6173 796e 6320 666f 7220 6963      async for ic
+00011dd0: 6875 6e6b 2069 6e20 696e 7075 745f 666f  hunk in input_fo
+00011de0: 725f 7472 6163 696e 673a 0a20 2020 2020  r_tracing:.     
+00011df0: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
+00011e00: 6e61 6c5f 696e 7075 745f 7375 7070 6f72  nal_input_suppor
+00011e10: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
+00011e20: 2020 2020 2020 2020 2069 6620 6669 6e61           if fina
+00011e30: 6c5f 696e 7075 7420 6973 204e 6f6e 653a  l_input is None:
+00011e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011e50: 2020 2020 2020 2020 2066 696e 616c 5f69           final_i
+00011e60: 6e70 7574 203d 2069 6368 756e 6b0a 2020  nput = ichunk.  
+00011e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00011e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ea0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00011eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ec0: 2066 696e 616c 5f69 6e70 7574 203d 2066   final_input = f
+00011ed0: 696e 616c 5f69 6e70 7574 202b 2069 6368  inal_input + ich
+00011ee0: 756e 6b20 2023 2074 7970 653a 2069 676e  unk  # type: ign
+00011ef0: 6f72 655b 6f70 6572 6174 6f72 5d0a 2020  ore[operator].  
+00011f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f10: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
+00011f20: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00011f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f40: 2020 2020 6669 6e61 6c5f 696e 7075 7420      final_input 
+00011f50: 3d20 6963 6875 6e6b 0a20 2020 2020 2020  = ichunk.       
+00011f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f70: 2020 2020 2066 696e 616c 5f69 6e70 7574       final_input
+00011f80: 5f73 7570 706f 7274 6564 203d 2046 616c  _supported = Fal
+00011f90: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00011fa0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00011fb0: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+00011fc0: 616c 5f69 6e70 7574 203d 2069 6368 756e  al_input = ichun
+00011fd0: 6b0a 2020 2020 2020 2020 6578 6365 7074  k.        except
+00011fe0: 2042 6173 6545 7863 6570 7469 6f6e 2061   BaseException a
+00011ff0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00012000: 2061 7761 6974 2072 756e 5f6d 616e 6167   await run_manag
+00012010: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
+00012020: 7228 652c 2069 6e70 7574 733d 6669 6e61  r(e, inputs=fina
+00012030: 6c5f 696e 7075 7429 0a20 2020 2020 2020  l_input).       
+00012040: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+00012050: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012060: 2020 2020 2061 7761 6974 2072 756e 5f6d       await run_m
+00012070: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+00012080: 656e 6428 6669 6e61 6c5f 6f75 7470 7574  end(final_output
+00012090: 2c20 696e 7075 7473 3d66 696e 616c 5f69  , inputs=final_i
+000120a0: 6e70 7574 290a 0a0a 636c 6173 7320 5275  nput)...class Ru
+000120b0: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
+000120c0: 6c65 2853 6572 6961 6c69 7a61 626c 652c  le(Serializable,
+000120d0: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
+000120e0: 204f 7574 7075 745d 293a 0a20 2020 2022   Output]):.    "
+000120f0: 2222 5275 6e6e 6162 6c65 2074 6861 7420  ""Runnable that 
+00012100: 6361 6e20 6265 2073 6572 6961 6c69 7a65  can be serialize
+00012110: 6420 746f 204a 534f 4e2e 2222 220a 0a20  d to JSON.""".. 
+00012120: 2020 206e 616d 653a 204f 7074 696f 6e61     name: Optiona
+00012130: 6c5b 7374 725d 203d 204e 6f6e 650a 2020  l[str] = None.  
+00012140: 2020 2222 2254 6865 206e 616d 6520 6f66    """The name of
+00012150: 2074 6865 2072 756e 6e61 626c 652e 2055   the runnable. U
+00012160: 7365 6420 666f 7220 6465 6275 6767 696e  sed for debuggin
+00012170: 6720 616e 6420 7472 6163 696e 672e 2222  g and tracing.""
+00012180: 220a 0a20 2020 2064 6566 2074 6f5f 6a73  "..    def to_js
+00012190: 6f6e 2873 656c 6629 202d 3e20 556e 696f  on(self) -> Unio
+000121a0: 6e5b 5365 7269 616c 697a 6564 436f 6e73  n[SerializedCons
+000121b0: 7472 7563 746f 722c 2053 6572 6961 6c69  tructor, Seriali
+000121c0: 7a65 644e 6f74 496d 706c 656d 656e 7465  zedNotImplemente
+000121d0: 645d 3a0a 2020 2020 2020 2020 2222 2253  d]:.        """S
+000121e0: 6572 6961 6c69 7a65 2074 6865 2072 756e  erialize the run
+000121f0: 6e61 626c 6520 746f 204a 534f 4e2e 2222  nable to JSON.""
+00012200: 220a 2020 2020 2020 2020 6475 6d70 6564  ".        dumped
+00012210: 203d 2073 7570 6572 2829 2e74 6f5f 6a73   = super().to_js
+00012220: 6f6e 2829 0a20 2020 2020 2020 2074 7279  on().        try
+00012230: 3a0a 2020 2020 2020 2020 2020 2020 6475  :.            du
+00012240: 6d70 6564 5b22 6e61 6d65 225d 203d 2073  mped["name"] = s
+00012250: 656c 662e 6765 745f 6e61 6d65 2829 0a20  elf.get_name(). 
+00012260: 2020 2020 2020 2020 2020 2064 756d 7065             dumpe
+00012270: 645b 2267 7261 7068 225d 203d 2073 656c  d["graph"] = sel
+00012280: 662e 6765 745f 6772 6170 6828 292e 746f  f.get_graph().to
+00012290: 5f6a 736f 6e28 290a 2020 2020 2020 2020  _json().        
+000122a0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+000122b0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+000122c0: 7373 0a20 2020 2020 2020 2072 6574 7572  ss.        retur
+000122d0: 6e20 6475 6d70 6564 0a0a 2020 2020 6465  n dumped..    de
+000122e0: 6620 636f 6e66 6967 7572 6162 6c65 5f66  f configurable_f
+000122f0: 6965 6c64 7328 0a20 2020 2020 2020 2073  ields(.        s
+00012300: 656c 662c 202a 2a6b 7761 7267 733a 2041  elf, **kwargs: A
+00012310: 6e79 436f 6e66 6967 7572 6162 6c65 4669  nyConfigurableFi
+00012320: 656c 640a 2020 2020 2920 2d3e 2052 756e  eld.    ) -> Run
+00012330: 6e61 626c 6553 6572 6961 6c69 7a61 626c  nableSerializabl
+00012340: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
+00012350: 3a0a 2020 2020 2020 2020 2222 2243 6f6e  :.        """Con
+00012360: 6669 6775 7265 2070 6172 7469 6375 6c61  figure particula
+00012370: 7220 7275 6e6e 6162 6c65 2066 6965 6c64  r runnable field
+00012380: 7320 6174 2072 756e 7469 6d65 2e0a 0a20  s at runtime... 
+00012390: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
+000123a0: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
+000123b0: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+000123c0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+000123d0: 756e 6e61 626c 6573 2069 6d70 6f72 7420  unnables import 
+000123e0: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
+000123f0: 640a 2020 2020 2020 2020 2020 2020 6672  d.            fr
+00012400: 6f6d 206c 616e 6763 6861 696e 5f6f 7065  om langchain_ope
+00012410: 6e61 6920 696d 706f 7274 2043 6861 744f  nai import ChatO
+00012420: 7065 6e41 490a 0a20 2020 2020 2020 2020  penAI..         
+00012430: 2020 206d 6f64 656c 203d 2043 6861 744f     model = ChatO
+00012440: 7065 6e41 4928 6d61 785f 746f 6b65 6e73  penAI(max_tokens
+00012450: 3d32 3029 2e63 6f6e 6669 6775 7261 626c  =20).configurabl
+00012460: 655f 6669 656c 6473 280a 2020 2020 2020  e_fields(.      
+00012470: 2020 2020 2020 2020 2020 6d61 785f 746f            max_to
+00012480: 6b65 6e73 3d43 6f6e 6669 6775 7261 626c  kens=Configurabl
+00012490: 6546 6965 6c64 280a 2020 2020 2020 2020  eField(.        
+000124a0: 2020 2020 2020 2020 2020 2020 6964 3d22              id="
+000124b0: 6f75 7470 7574 5f74 6f6b 656e 5f6e 756d  output_token_num
+000124c0: 6265 7222 2c0a 2020 2020 2020 2020 2020  ber",.          
+000124d0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
+000124e0: 4d61 7820 746f 6b65 6e73 2069 6e20 7468  Max tokens in th
+000124f0: 6520 6f75 7470 7574 222c 0a20 2020 2020  e output",.     
+00012500: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00012510: 6573 6372 6970 7469 6f6e 3d22 5468 6520  escription="The 
+00012520: 6d61 7869 6d75 6d20 6e75 6d62 6572 206f  maximum number o
+00012530: 6620 746f 6b65 6e73 2069 6e20 7468 6520  f tokens in the 
+00012540: 6f75 7470 7574 222c 0a20 2020 2020 2020  output",.       
+00012550: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00012560: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00012570: 2020 2020 2020 2320 6d61 785f 746f 6b65        # max_toke
+00012580: 6e73 203d 2032 300a 2020 2020 2020 2020  ns = 20.        
+00012590: 2020 2020 7072 696e 7428 0a20 2020 2020      print(.     
+000125a0: 2020 2020 2020 2020 2020 2022 6d61 785f             "max_
+000125b0: 746f 6b65 6e73 5f32 303a 2022 2c0a 2020  tokens_20: ",.  
+000125c0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+000125d0: 6465 6c2e 696e 766f 6b65 2822 7465 6c6c  del.invoke("tell
+000125e0: 206d 6520 736f 6d65 7468 696e 6720 6162   me something ab
+000125f0: 6f75 7420 6368 6573 7322 292e 636f 6e74  out chess").cont
+00012600: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+00012610: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00012620: 206d 6178 5f74 6f6b 656e 7320 3d20 3230   max_tokens = 20
+00012630: 300a 2020 2020 2020 2020 2020 2020 7072  0.            pr
+00012640: 696e 7428 226d 6178 5f74 6f6b 656e 735f  int("max_tokens_
+00012650: 3230 303a 2022 2c20 6d6f 6465 6c2e 7769  200: ", model.wi
+00012660: 7468 5f63 6f6e 6669 6728 0a20 2020 2020  th_config(.     
+00012670: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+00012680: 6775 7261 626c 653d 7b22 6f75 7470 7574  gurable={"output
+00012690: 5f74 6f6b 656e 5f6e 756d 6265 7222 3a20  _token_number": 
+000126a0: 3230 307d 0a20 2020 2020 2020 2020 2020  200}.           
+000126b0: 2020 2020 2029 2e69 6e76 6f6b 6528 2274       ).invoke("t
+000126c0: 656c 6c20 6d65 2073 6f6d 6574 6869 6e67  ell me something
+000126d0: 2061 626f 7574 2063 6865 7373 2229 2e63   about chess").c
+000126e0: 6f6e 7465 6e74 0a20 2020 2020 2020 2020  ontent.         
+000126f0: 2020 2029 0a20 2020 2020 2020 2022 2222     ).        """
+00012700: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
+00012710: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
+00012720: 6e61 626c 6573 2e63 6f6e 6669 6775 7261  nables.configura
+00012730: 626c 6520 696d 706f 7274 2052 756e 6e61  ble import Runna
+00012740: 626c 6543 6f6e 6669 6775 7261 626c 6546  bleConfigurableF
+00012750: 6965 6c64 730a 0a20 2020 2020 2020 2066  ields..        f
+00012760: 6f72 206b 6579 2069 6e20 6b77 6172 6773  or key in kwargs
+00012770: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00012780: 206b 6579 206e 6f74 2069 6e20 7365 6c66   key not in self
+00012790: 2e5f 5f66 6965 6c64 735f 5f3a 0a20 2020  .__fields__:.   
+000127a0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000127b0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
+000127c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127d0: 2020 2066 2243 6f6e 6669 6775 7261 7469     f"Configurati
+000127e0: 6f6e 206b 6579 207b 6b65 797d 206e 6f74  on key {key} not
+000127f0: 2066 6f75 6e64 2069 6e20 7b73 656c 667d   found in {self}
+00012800: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00012810: 2020 2020 2020 2020 6622 6176 6169 6c61          f"availa
+00012820: 626c 6520 6b65 7973 2061 7265 207b 7365  ble keys are {se
+00012830: 6c66 2e5f 5f66 6965 6c64 735f 5f2e 6b65  lf.__fields__.ke
+00012840: 7973 2829 7d22 0a20 2020 2020 2020 2020  ys()}".         
+00012850: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00012860: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
+00012870: 6543 6f6e 6669 6775 7261 626c 6546 6965  eConfigurableFie
+00012880: 6c64 7328 6465 6661 756c 743d 7365 6c66  lds(default=self
+00012890: 2c20 6669 656c 6473 3d6b 7761 7267 7329  , fields=kwargs)
+000128a0: 0a0a 2020 2020 6465 6620 636f 6e66 6967  ..    def config
+000128b0: 7572 6162 6c65 5f61 6c74 6572 6e61 7469  urable_alternati
+000128c0: 7665 7328 0a20 2020 2020 2020 2073 656c  ves(.        sel
+000128d0: 662c 0a20 2020 2020 2020 2077 6869 6368  f,.        which
+000128e0: 3a20 436f 6e66 6967 7572 6162 6c65 4669  : ConfigurableFi
+000128f0: 656c 642c 0a20 2020 2020 2020 202a 2c0a  eld,.        *,.
+00012900: 2020 2020 2020 2020 6465 6661 756c 745f          default_
+00012910: 6b65 793a 2073 7472 203d 2022 6465 6661  key: str = "defa
+00012920: 756c 7422 2c0a 2020 2020 2020 2020 7072  ult",.        pr
+00012930: 6566 6978 5f6b 6579 733a 2062 6f6f 6c20  efix_keys: bool 
+00012940: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00012950: 202a 2a6b 7761 7267 733a 2055 6e69 6f6e   **kwargs: Union
+00012960: 5b52 756e 6e61 626c 655b 496e 7075 742c  [Runnable[Input,
+00012970: 204f 7574 7075 745d 2c20 4361 6c6c 6162   Output], Callab
+00012980: 6c65 5b5b 5d2c 2052 756e 6e61 626c 655b  le[[], Runnable[
+00012990: 496e 7075 742c 204f 7574 7075 745d 5d5d  Input, Output]]]
+000129a0: 2c0a 2020 2020 2920 2d3e 2052 756e 6e61  ,.    ) -> Runna
+000129b0: 626c 6553 6572 6961 6c69 7a61 626c 655b  bleSerializable[
+000129c0: 496e 7075 742c 204f 7574 7075 745d 3a0a  Input, Output]:.
+000129d0: 2020 2020 2020 2020 2222 2243 6f6e 6669          """Confi
+000129e0: 6775 7265 2061 6c74 6572 6e61 7469 7665  gure alternative
+000129f0: 7320 666f 7220 7275 6e6e 6162 6c65 7320  s for runnables 
+00012a00: 7468 6174 2063 616e 2062 6520 7365 7420  that can be set 
+00012a10: 6174 2072 756e 7469 6d65 2e0a 0a20 2020  at runtime...   
+00012a20: 2020 2020 202e 2e20 636f 6465 2d62 6c6f       .. code-blo
+00012a30: 636b 3a3a 2070 7974 686f 6e0a 0a20 2020  ck:: python..   
+00012a40: 2020 2020 2020 2020 2066 726f 6d20 6c61           from la
+00012a50: 6e67 6368 6169 6e5f 616e 7468 726f 7069  ngchain_anthropi
+00012a60: 6320 696d 706f 7274 2043 6861 7441 6e74  c import ChatAnt
+00012a70: 6872 6f70 6963 0a20 2020 2020 2020 2020  hropic.         
+00012a80: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+00012a90: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+00012aa0: 2e75 7469 6c73 2069 6d70 6f72 7420 436f  .utils import Co
+00012ab0: 6e66 6967 7572 6162 6c65 4669 656c 640a  nfigurableField.
+00012ac0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00012ad0: 206c 616e 6763 6861 696e 5f6f 7065 6e61   langchain_opena
+00012ae0: 6920 696d 706f 7274 2043 6861 744f 7065  i import ChatOpe
+00012af0: 6e41 490a 0a20 2020 2020 2020 2020 2020  nAI..           
+00012b00: 206d 6f64 656c 203d 2043 6861 7441 6e74   model = ChatAnt
+00012b10: 6872 6f70 6963 280a 2020 2020 2020 2020  hropic(.        
+00012b20: 2020 2020 2020 2020 6d6f 6465 6c5f 6e61          model_na
+00012b30: 6d65 3d22 636c 6175 6465 2d33 2d73 6f6e  me="claude-3-son
+00012b40: 6e65 742d 3230 3234 3032 3239 220a 2020  net-20240229".  
+00012b50: 2020 2020 2020 2020 2020 292e 636f 6e66            ).conf
+00012b60: 6967 7572 6162 6c65 5f61 6c74 6572 6e61  igurable_alterna
+00012b70: 7469 7665 7328 0a20 2020 2020 2020 2020  tives(.         
+00012b80: 2020 2020 2020 2043 6f6e 6669 6775 7261         Configura
+00012b90: 626c 6546 6965 6c64 2869 643d 226c 6c6d  bleField(id="llm
+00012ba0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00012bb0: 2020 2020 6465 6661 756c 745f 6b65 793d      default_key=
+00012bc0: 2261 6e74 6872 6f70 6963 222c 0a20 2020  "anthropic",.   
+00012bd0: 2020 2020 2020 2020 2020 2020 206f 7065               ope
+00012be0: 6e61 693d 4368 6174 4f70 656e 4149 2829  nai=ChatOpenAI()
+00012bf0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00012c00: 2020 2020 2020 2020 2020 2020 2320 7573              # us
+00012c10: 6573 2074 6865 2064 6566 6175 6c74 206d  es the default m
+00012c20: 6f64 656c 2043 6861 7441 6e74 6872 6f70  odel ChatAnthrop
+00012c30: 6963 0a20 2020 2020 2020 2020 2020 2070  ic.            p
+00012c40: 7269 6e74 286d 6f64 656c 2e69 6e76 6f6b  rint(model.invok
+00012c50: 6528 2277 6869 6368 206f 7267 616e 697a  e("which organiz
+00012c60: 6174 696f 6e20 6372 6561 7465 6420 796f  ation created yo
+00012c70: 753f 2229 2e63 6f6e 7465 6e74 290a 0a20  u?").content).. 
+00012c80: 2020 2020 2020 2020 2020 2023 2075 7365             # use
+00012c90: 7320 4368 6174 4f70 656e 4149 0a20 2020  s ChatOpenAI.   
+00012ca0: 2020 2020 2020 2020 2070 7269 6e74 280a           print(.
+00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cc0: 6d6f 6465 6c2e 7769 7468 5f63 6f6e 6669  model.with_confi
+00012cd0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00012ce0: 2020 2020 2020 2063 6f6e 6669 6775 7261         configura
+00012cf0: 626c 653d 7b22 6c6c 6d22 3a20 226f 7065  ble={"llm": "ope
+00012d00: 6e61 6922 7d0a 2020 2020 2020 2020 2020  nai"}.          
+00012d10: 2020 2020 2020 292e 696e 766f 6b65 2822        ).invoke("
+00012d20: 7768 6963 6820 6f72 6761 6e69 7a61 7469  which organizati
+00012d30: 6f6e 2063 7265 6174 6564 2079 6f75 3f22  on created you?"
+00012d40: 292e 636f 6e74 656e 740a 2020 2020 2020  ).content.      
+00012d50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00012d60: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
+00012d70: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+00012d80: 7275 6e6e 6162 6c65 732e 636f 6e66 6967  runnables.config
+00012d90: 7572 6162 6c65 2069 6d70 6f72 7420 280a  urable import (.
+00012da0: 2020 2020 2020 2020 2020 2020 5275 6e6e              Runn
+00012db0: 6162 6c65 436f 6e66 6967 7572 6162 6c65  ableConfigurable
+00012dc0: 416c 7465 726e 6174 6976 6573 2c0a 2020  Alternatives,.  
+00012dd0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00012de0: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
+00012df0: 436f 6e66 6967 7572 6162 6c65 416c 7465  ConfigurableAlte
+00012e00: 726e 6174 6976 6573 280a 2020 2020 2020  rnatives(.      
+00012e10: 2020 2020 2020 7768 6963 683d 7768 6963        which=whic
+00012e20: 682c 0a20 2020 2020 2020 2020 2020 2064  h,.            d
+00012e30: 6566 6175 6c74 3d73 656c 662c 0a20 2020  efault=self,.   
+00012e40: 2020 2020 2020 2020 2061 6c74 6572 6e61           alterna
+00012e50: 7469 7665 733d 6b77 6172 6773 2c0a 2020  tives=kwargs,.  
+00012e60: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
+00012e70: 745f 6b65 793d 6465 6661 756c 745f 6b65  t_key=default_ke
+00012e80: 792c 0a20 2020 2020 2020 2020 2020 2070  y,.            p
+00012e90: 7265 6669 785f 6b65 7973 3d70 7265 6669  refix_keys=prefi
+00012ea0: 785f 6b65 7973 2c0a 2020 2020 2020 2020  x_keys,.        
+00012eb0: 290a 0a0a 6465 6620 5f73 6571 5f69 6e70  )...def _seq_inp
+00012ec0: 7574 5f73 6368 656d 6128 0a20 2020 2073  ut_schema(.    s
+00012ed0: 7465 7073 3a20 4c69 7374 5b52 756e 6e61  teps: List[Runna
+00012ee0: 626c 655b 416e 792c 2041 6e79 5d5d 2c20  ble[Any, Any]], 
+00012ef0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00012f00: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00012f10: 0a29 202d 3e20 5479 7065 5b42 6173 654d  .) -> Type[BaseM
+00012f20: 6f64 656c 5d3a 0a20 2020 2066 726f 6d20  odel]:.    from 
+00012f30: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+00012f40: 756e 6e61 626c 6573 2e70 6173 7374 6872  unnables.passthr
+00012f50: 6f75 6768 2069 6d70 6f72 7420 5275 6e6e  ough import Runn
+00012f60: 6162 6c65 4173 7369 676e 2c20 5275 6e6e  ableAssign, Runn
+00012f70: 6162 6c65 5069 636b 0a0a 2020 2020 6669  ablePick..    fi
+00012f80: 7273 7420 3d20 7374 6570 735b 305d 0a20  rst = steps[0]. 
+00012f90: 2020 2069 6620 6c65 6e28 7374 6570 7329     if len(steps)
+00012fa0: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
+00012fb0: 6574 7572 6e20 6669 7273 742e 6765 745f  eturn first.get_
+00012fc0: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
+00012fd0: 6669 6729 0a20 2020 2065 6c69 6620 6973  fig).    elif is
+00012fe0: 696e 7374 616e 6365 2866 6972 7374 2c20  instance(first, 
+00012ff0: 5275 6e6e 6162 6c65 4173 7369 676e 293a  RunnableAssign):
+00013000: 0a20 2020 2020 2020 206e 6578 745f 696e  .        next_in
+00013010: 7075 745f 7363 6865 6d61 203d 205f 7365  put_schema = _se
+00013020: 715f 696e 7075 745f 7363 6865 6d61 2873  q_input_schema(s
+00013030: 7465 7073 5b31 3a5d 2c20 636f 6e66 6967  teps[1:], config
+00013040: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00013050: 206e 6578 745f 696e 7075 745f 7363 6865   next_input_sche
+00013060: 6d61 2e5f 5f63 7573 746f 6d5f 726f 6f74  ma.__custom_root
+00013070: 5f74 7970 655f 5f3a 0a20 2020 2020 2020  _type__:.       
+00013080: 2020 2020 2023 2069 7427 7320 6120 6469       # it's a di
+00013090: 6374 2061 7320 6578 7065 6374 6564 0a20  ct as expected. 
+000130a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000130b0: 6e20 6372 6561 7465 5f6d 6f64 656c 2820  n create_model( 
+000130c0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+000130d0: 6361 6c6c 2d6f 7665 726c 6f61 645d 0a20  call-overload]. 
+000130e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000130f0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+00013100: 496e 7075 7422 2c0a 2020 2020 2020 2020  Input",.        
+00013110: 2020 2020 2020 2020 2a2a 7b0a 2020 2020          **{.    
+00013120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013130: 6b3a 2028 762e 616e 6e6f 7461 7469 6f6e  k: (v.annotation
+00013140: 2c20 762e 6465 6661 756c 7429 0a20 2020  , v.default).   
+00013150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013160: 2066 6f72 206b 2c20 7620 696e 206e 6578   for k, v in nex
+00013170: 745f 696e 7075 745f 7363 6865 6d61 2e5f  t_input_schema._
+00013180: 5f66 6965 6c64 735f 5f2e 6974 656d 7328  _fields__.items(
+00013190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000131a0: 2020 2020 2020 6966 206b 206e 6f74 2069        if k not i
+000131b0: 6e20 6669 7273 742e 6d61 7070 6572 2e73  n first.mapper.s
+000131c0: 7465 7073 5f5f 0a20 2020 2020 2020 2020  teps__.         
+000131d0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+000131e0: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
+000131f0: 2069 7369 6e73 7461 6e63 6528 6669 7273   isinstance(firs
+00013200: 742c 2052 756e 6e61 626c 6550 6963 6b29  t, RunnablePick)
+00013210: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00013220: 205f 7365 715f 696e 7075 745f 7363 6865   _seq_input_sche
+00013230: 6d61 2873 7465 7073 5b31 3a5d 2c20 636f  ma(steps[1:], co
+00013240: 6e66 6967 290a 0a20 2020 2072 6574 7572  nfig)..    retur
+00013250: 6e20 6669 7273 742e 6765 745f 696e 7075  n first.get_inpu
+00013260: 745f 7363 6865 6d61 2863 6f6e 6669 6729  t_schema(config)
+00013270: 0a0a 0a64 6566 205f 7365 715f 6f75 7470  ...def _seq_outp
+00013280: 7574 5f73 6368 656d 6128 0a20 2020 2073  ut_schema(.    s
+00013290: 7465 7073 3a20 4c69 7374 5b52 756e 6e61  teps: List[Runna
+000132a0: 626c 655b 416e 792c 2041 6e79 5d5d 2c20  ble[Any, Any]], 
+000132b0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+000132c0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+000132d0: 0a29 202d 3e20 5479 7065 5b42 6173 654d  .) -> Type[BaseM
+000132e0: 6f64 656c 5d3a 0a20 2020 2066 726f 6d20  odel]:.    from 
+000132f0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+00013300: 756e 6e61 626c 6573 2e70 6173 7374 6872  unnables.passthr
+00013310: 6f75 6768 2069 6d70 6f72 7420 5275 6e6e  ough import Runn
+00013320: 6162 6c65 4173 7369 676e 2c20 5275 6e6e  ableAssign, Runn
+00013330: 6162 6c65 5069 636b 0a0a 2020 2020 6c61  ablePick..    la
+00013340: 7374 203d 2073 7465 7073 5b2d 315d 0a20  st = steps[-1]. 
+00013350: 2020 2069 6620 6c65 6e28 7374 6570 7329     if len(steps)
+00013360: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
+00013370: 6574 7572 6e20 6c61 7374 2e67 6574 5f69  eturn last.get_i
+00013380: 6e70 7574 5f73 6368 656d 6128 636f 6e66  nput_schema(conf
+00013390: 6967 290a 2020 2020 656c 6966 2069 7369  ig).    elif isi
+000133a0: 6e73 7461 6e63 6528 6c61 7374 2c20 5275  nstance(last, Ru
+000133b0: 6e6e 6162 6c65 4173 7369 676e 293a 0a20  nnableAssign):. 
+000133c0: 2020 2020 2020 206d 6170 7065 725f 6f75         mapper_ou
+000133d0: 7470 7574 5f73 6368 656d 6120 3d20 6c61  tput_schema = la
+000133e0: 7374 2e6d 6170 7065 722e 6765 745f 6f75  st.mapper.get_ou
+000133f0: 7470 7574 5f73 6368 656d 6128 636f 6e66  tput_schema(conf
+00013400: 6967 290a 2020 2020 2020 2020 7072 6576  ig).        prev
+00013410: 5f6f 7574 7075 745f 7363 6865 6d61 203d  _output_schema =
+00013420: 205f 7365 715f 6f75 7470 7574 5f73 6368   _seq_output_sch
+00013430: 656d 6128 7374 6570 735b 3a2d 315d 2c20  ema(steps[:-1], 
+00013440: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+00013450: 6966 206e 6f74 2070 7265 765f 6f75 7470  if not prev_outp
+00013460: 7574 5f73 6368 656d 612e 5f5f 6375 7374  ut_schema.__cust
+00013470: 6f6d 5f72 6f6f 745f 7479 7065 5f5f 3a0a  om_root_type__:.
+00013480: 2020 2020 2020 2020 2020 2020 2320 6974              # it
+00013490: 2773 2061 2064 6963 7420 6173 2065 7870  's a dict as exp
+000134a0: 6563 7465 640a 2020 2020 2020 2020 2020  ected.          
+000134b0: 2020 7265 7475 726e 2063 7265 6174 655f    return create_
+000134c0: 6d6f 6465 6c28 2020 2320 7479 7065 3a20  model(  # type: 
+000134d0: 6967 6e6f 7265 5b63 616c 6c2d 6f76 6572  ignore[call-over
+000134e0: 6c6f 6164 5d0a 2020 2020 2020 2020 2020  load].          
+000134f0: 2020 2020 2020 2252 756e 6e61 626c 6553        "RunnableS
+00013500: 6571 7565 6e63 654f 7574 7075 7422 2c0a  equenceOutput",.
+00013510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013520: 2a2a 7b0a 2020 2020 2020 2020 2020 2020  **{.            
+00013530: 2020 2020 2020 2020 2a2a 7b0a 2020 2020          **{.    
+00013540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013550: 2020 2020 6b3a 2028 762e 616e 6e6f 7461      k: (v.annota
+00013560: 7469 6f6e 2c20 762e 6465 6661 756c 7429  tion, v.default)
+00013570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013580: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+00013590: 7620 696e 2070 7265 765f 6f75 7470 7574  v in prev_output
+000135a0: 5f73 6368 656d 612e 5f5f 6669 656c 6473  _schema.__fields
+000135b0: 5f5f 2e69 7465 6d73 2829 0a20 2020 2020  __.items().     
+000135c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000135d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000135e0: 2020 2020 2020 2a2a 7b0a 2020 2020 2020        **{.      
+000135f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013600: 2020 6b3a 2028 762e 616e 6e6f 7461 7469    k: (v.annotati
+00013610: 6f6e 2c20 762e 6465 6661 756c 7429 0a20  on, v.default). 
+00013620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013630: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+00013640: 696e 206d 6170 7065 725f 6f75 7470 7574  in mapper_output
+00013650: 5f73 6368 656d 612e 5f5f 6669 656c 6473  _schema.__fields
+00013660: 5f5f 2e69 7465 6d73 2829 0a20 2020 2020  __.items().     
+00013670: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00013680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013690: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+000136a0: 2029 0a20 2020 2065 6c69 6620 6973 696e   ).    elif isin
+000136b0: 7374 616e 6365 286c 6173 742c 2052 756e  stance(last, Run
+000136c0: 6e61 626c 6550 6963 6b29 3a0a 2020 2020  nablePick):.    
+000136d0: 2020 2020 7072 6576 5f6f 7574 7075 745f      prev_output_
+000136e0: 7363 6865 6d61 203d 205f 7365 715f 6f75  schema = _seq_ou
+000136f0: 7470 7574 5f73 6368 656d 6128 7374 6570  tput_schema(step
+00013700: 735b 3a2d 315d 2c20 636f 6e66 6967 290a  s[:-1], config).
+00013710: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+00013720: 7265 765f 6f75 7470 7574 5f73 6368 656d  rev_output_schem
+00013730: 612e 5f5f 6375 7374 6f6d 5f72 6f6f 745f  a.__custom_root_
+00013740: 7479 7065 5f5f 3a0a 2020 2020 2020 2020  type__:.        
+00013750: 2020 2020 2320 6974 2773 2061 2064 6963      # it's a dic
+00013760: 7420 6173 2065 7870 6563 7465 640a 2020  t as expected.  
+00013770: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00013780: 6e73 7461 6e63 6528 6c61 7374 2e6b 6579  nstance(last.key
+00013790: 732c 206c 6973 7429 3a0a 2020 2020 2020  s, list):.      
+000137a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000137b0: 2063 7265 6174 655f 6d6f 6465 6c28 2020   create_model(  
+000137c0: 2320 7479 7065 3a20 6967 6e6f 7265 5b63  # type: ignore[c
+000137d0: 616c 6c2d 6f76 6572 6c6f 6164 5d0a 2020  all-overload].  
+000137e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137f0: 2020 2252 756e 6e61 626c 6553 6571 7565    "RunnableSeque
+00013800: 6e63 654f 7574 7075 7422 2c0a 2020 2020  nceOutput",.    
+00013810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013820: 2a2a 7b0a 2020 2020 2020 2020 2020 2020  **{.            
+00013830: 2020 2020 2020 2020 2020 2020 6b3a 2028              k: (
+00013840: 762e 616e 6e6f 7461 7469 6f6e 2c20 762e  v.annotation, v.
+00013850: 6465 6661 756c 7429 0a20 2020 2020 2020  default).       
+00013860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013870: 2066 6f72 206b 2c20 7620 696e 2070 7265   for k, v in pre
+00013880: 765f 6f75 7470 7574 5f73 6368 656d 612e  v_output_schema.
+00013890: 5f5f 6669 656c 6473 5f5f 2e69 7465 6d73  __fields__.items
+000138a0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000138b0: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
+000138c0: 696e 206c 6173 742e 6b65 7973 0a20 2020  in last.keys.   
+000138d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138e0: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+000138f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00013900: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00013910: 2020 2020 2020 2020 6669 656c 6420 3d20          field = 
+00013920: 7072 6576 5f6f 7574 7075 745f 7363 6865  prev_output_sche
+00013930: 6d61 2e5f 5f66 6965 6c64 735f 5f5b 6c61  ma.__fields__[la
+00013940: 7374 2e6b 6579 735d 0a20 2020 2020 2020  st.keys].       
+00013950: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013960: 6372 6561 7465 5f6d 6f64 656c 2820 2023  create_model(  #
+00013970: 2074 7970 653a 2069 676e 6f72 655b 6361   type: ignore[ca
+00013980: 6c6c 2d6f 7665 726c 6f61 645d 0a20 2020  ll-overload].   
+00013990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139a0: 2022 5275 6e6e 6162 6c65 5365 7175 656e   "RunnableSequen
+000139b0: 6365 4f75 7470 7574 222c 0a20 2020 2020  ceOutput",.     
+000139c0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+000139d0: 5f72 6f6f 745f 5f3d 2866 6965 6c64 2e61  _root__=(field.a
+000139e0: 6e6e 6f74 6174 696f 6e2c 2066 6965 6c64  nnotation, field
+000139f0: 2e64 6566 6175 6c74 292c 0a20 2020 2020  .default),.     
+00013a00: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00013a10: 2020 7265 7475 726e 206c 6173 742e 6765    return last.ge
+00013a20: 745f 6f75 7470 7574 5f73 6368 656d 6128  t_output_schema(
+00013a30: 636f 6e66 6967 290a 0a0a 636c 6173 7320  config)...class 
+00013a40: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+00013a50: 2852 756e 6e61 626c 6553 6572 6961 6c69  (RunnableSeriali
+00013a60: 7a61 626c 655b 496e 7075 742c 204f 7574  zable[Input, Out
+00013a70: 7075 745d 293a 0a20 2020 2022 2222 5365  put]):.    """Se
+00013a80: 7175 656e 6365 206f 6620 5275 6e6e 6162  quence of Runnab
+00013a90: 6c65 732c 2077 6865 7265 2074 6865 206f  les, where the o
+00013aa0: 7574 7075 7420 6f66 2065 6163 6820 6973  utput of each is
+00013ab0: 2074 6865 2069 6e70 7574 206f 6620 7468   the input of th
+00013ac0: 6520 6e65 7874 2e0a 0a20 2020 2052 756e  e next...    Run
+00013ad0: 6e61 626c 6553 6571 7565 6e63 6520 6973  nableSequence is
+00013ae0: 2074 6865 206d 6f73 7420 696d 706f 7274   the most import
+00013af0: 616e 7420 636f 6d70 6f73 6974 696f 6e20  ant composition 
+00013b00: 6f70 6572 6174 6f72 2069 6e20 4c61 6e67  operator in Lang
+00013b10: 4368 6169 6e20 6173 2069 7420 6973 0a20  Chain as it is. 
+00013b20: 2020 2075 7365 6420 696e 2076 6972 7475     used in virtu
+00013b30: 616c 6c79 2065 7665 7279 2063 6861 696e  ally every chain
+00013b40: 2e0a 0a20 2020 2041 2052 756e 6e61 626c  ...    A Runnabl
+00013b50: 6553 6571 7565 6e63 6520 6361 6e20 6265  eSequence can be
+00013b60: 2069 6e73 7461 6e74 6961 7465 6420 6469   instantiated di
+00013b70: 7265 6374 6c79 206f 7220 6d6f 7265 2063  rectly or more c
+00013b80: 6f6d 6d6f 6e6c 7920 6279 2075 7369 6e67  ommonly by using
+00013b90: 2074 6865 2060 7c60 0a20 2020 206f 7065   the `|`.    ope
+00013ba0: 7261 746f 7220 7768 6572 6520 6569 7468  rator where eith
+00013bb0: 6572 2074 6865 206c 6566 7420 6f72 2072  er the left or r
+00013bc0: 6967 6874 206f 7065 7261 6e64 7320 286f  ight operands (o
+00013bd0: 7220 626f 7468 2920 6d75 7374 2062 6520  r both) must be 
+00013be0: 6120 5275 6e6e 6162 6c65 2e0a 0a20 2020  a Runnable...   
+00013bf0: 2041 6e79 2052 756e 6e61 626c 6553 6571   Any RunnableSeq
+00013c00: 7565 6e63 6520 6175 746f 6d61 7469 6361  uence automatica
+00013c10: 6c6c 7920 7375 7070 6f72 7473 2073 796e  lly supports syn
+00013c20: 632c 2061 7379 6e63 2c20 6261 7463 682e  c, async, batch.
+00013c30: 0a0a 2020 2020 5468 6520 6465 6661 756c  ..    The defaul
+00013c40: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
+00013c50: 7320 6f66 2060 6261 7463 6860 2061 6e64  s of `batch` and
+00013c60: 2060 6162 6174 6368 6020 7574 696c 697a   `abatch` utiliz
+00013c70: 6520 7468 7265 6164 706f 6f6c 7320 616e  e threadpools an
+00013c80: 640a 2020 2020 6173 796e 6369 6f20 6761  d.    asyncio ga
+00013c90: 7468 6572 2061 6e64 2077 696c 6c20 6265  ther and will be
+00013ca0: 2066 6173 7465 7220 7468 616e 206e 6169   faster than nai
+00013cb0: 7665 2069 6e76 6f63 6174 696f 6e20 6f66  ve invocation of
+00013cc0: 2069 6e76 6f6b 6520 6f72 2061 696e 766f   invoke or ainvo
+00013cd0: 6b65 0a20 2020 2066 6f72 2049 4f20 626f  ke.    for IO bo
+00013ce0: 756e 6420 5275 6e6e 6162 6c65 732e 0a0a  und Runnables...
+00013cf0: 2020 2020 4261 7463 6869 6e67 2069 7320      Batching is 
+00013d00: 696d 706c 656d 656e 7465 6420 6279 2069  implemented by i
+00013d10: 6e76 6f6b 696e 6720 7468 6520 6261 7463  nvoking the batc
+00013d20: 6820 6d65 7468 6f64 206f 6e20 6561 6368  h method on each
+00013d30: 2063 6f6d 706f 6e65 6e74 206f 6620 7468   component of th
+00013d40: 650a 2020 2020 5275 6e6e 6162 6c65 5365  e.    RunnableSe
+00013d50: 7175 656e 6365 2069 6e20 6f72 6465 722e  quence in order.
+00013d60: 0a0a 2020 2020 4120 5275 6e6e 6162 6c65  ..    A Runnable
+00013d70: 5365 7175 656e 6365 2070 7265 7365 7276  Sequence preserv
+00013d80: 6573 2074 6865 2073 7472 6561 6d69 6e67  es the streaming
+00013d90: 2070 726f 7065 7274 6965 7320 6f66 2069   properties of i
+00013da0: 7473 2063 6f6d 706f 6e65 6e74 732c 2073  ts components, s
+00013db0: 6f20 6966 2061 6c6c 0a20 2020 2063 6f6d  o if all.    com
+00013dc0: 706f 6e65 6e74 7320 6f66 2074 6865 2073  ponents of the s
+00013dd0: 6571 7565 6e63 6520 696d 706c 656d 656e  equence implemen
+00013de0: 7420 6120 6074 7261 6e73 666f 726d 6020  t a `transform` 
+00013df0: 6d65 7468 6f64 202d 2d20 7768 6963 680a  method -- which.
+00013e00: 2020 2020 6973 2074 6865 206d 6574 686f      is the metho
+00013e10: 6420 7468 6174 2069 6d70 6c65 6d65 6e74  d that implement
+00013e20: 7320 7468 6520 6c6f 6769 6320 746f 206d  s the logic to m
+00013e30: 6170 2061 2073 7472 6561 6d69 6e67 2069  ap a streaming i
+00013e40: 6e70 7574 2074 6f20 6120 7374 7265 616d  nput to a stream
+00013e50: 696e 670a 2020 2020 6f75 7470 7574 202d  ing.    output -
+00013e60: 2d20 7468 656e 2074 6865 2073 6571 7565  - then the seque
+00013e70: 6e63 6520 7769 6c6c 2062 6520 6162 6c65  nce will be able
+00013e80: 2074 6f20 7374 7265 616d 2069 6e70 7574   to stream input
+00013e90: 2074 6f20 6f75 7470 7574 210a 0a20 2020   to output!..   
+00013ea0: 2049 6620 616e 7920 636f 6d70 6f6e 656e   If any componen
+00013eb0: 7420 6f66 2074 6865 2073 6571 7565 6e63  t of the sequenc
+00013ec0: 6520 646f 6573 206e 6f74 2069 6d70 6c65  e does not imple
+00013ed0: 6d65 6e74 2074 7261 6e73 666f 726d 2074  ment transform t
+00013ee0: 6865 6e20 7468 650a 2020 2020 7374 7265  hen the.    stre
+00013ef0: 616d 696e 6720 7769 6c6c 206f 6e6c 7920  aming will only 
+00013f00: 6265 6769 6e20 6166 7465 7220 7468 6973  begin after this
+00013f10: 2063 6f6d 706f 6e65 6e74 2069 7320 7275   component is ru
+00013f20: 6e2e 2049 6620 7468 6572 6520 6172 650a  n. If there are.
+00013f30: 2020 2020 6d75 6c74 6970 6c65 2062 6c6f      multiple blo
+00013f40: 636b 696e 6720 636f 6d70 6f6e 656e 7473  cking components
+00013f50: 2c20 7374 7265 616d 696e 6720 6265 6769  , streaming begi
+00013f60: 6e73 2061 6674 6572 2074 6865 206c 6173  ns after the las
+00013f70: 7420 6f6e 652e 0a0a 2020 2020 506c 6561  t one...    Plea
+00013f80: 7365 206e 6f74 653a 2052 756e 6e61 626c  se note: Runnabl
+00013f90: 654c 616d 6264 6173 2064 6f20 6e6f 7420  eLambdas do not 
+00013fa0: 7375 7070 6f72 7420 6074 7261 6e73 666f  support `transfo
+00013fb0: 726d 6020 6279 2064 6566 6175 6c74 2120  rm` by default! 
+00013fc0: 536f 2069 660a 2020 2020 2020 2020 796f  So if.        yo
+00013fd0: 7520 6e65 6564 2074 6f20 7573 6520 6120  u need to use a 
+00013fe0: 5275 6e6e 6162 6c65 4c61 6d62 6461 7320  RunnableLambdas 
+00013ff0: 6265 2063 6172 6566 756c 2061 626f 7574  be careful about
+00014000: 2077 6865 7265 2079 6f75 2070 6c61 6365   where you place
+00014010: 2074 6865 6d20 696e 2061 0a20 2020 2020   them in a.     
+00014020: 2020 2052 756e 6e61 626c 6553 6571 7565     RunnableSeque
+00014030: 6e63 6520 2869 6620 796f 7520 6e65 6564  nce (if you need
+00014040: 2074 6f20 7573 6520 7468 6520 2e73 7472   to use the .str
+00014050: 6561 6d28 292f 2e61 7374 7265 616d 2829  eam()/.astream()
+00014060: 206d 6574 686f 6473 292e 0a0a 2020 2020   methods)...    
+00014070: 2020 2020 4966 2079 6f75 206e 6565 6420      If you need 
+00014080: 6172 6269 7472 6172 7920 6c6f 6769 6320  arbitrary logic 
+00014090: 616e 6420 6e65 6564 2073 7472 6561 6d69  and need streami
+000140a0: 6e67 2c20 796f 7520 6361 6e20 7375 6263  ng, you can subc
+000140b0: 6c61 7373 0a20 2020 2020 2020 2052 756e  lass.        Run
+000140c0: 6e61 626c 652c 2061 6e64 2069 6d70 6c65  nable, and imple
+000140d0: 6d65 6e74 2060 7472 616e 7366 6f72 6d60  ment `transform`
+000140e0: 2066 6f72 2077 6861 7465 7665 7220 6c6f   for whatever lo
+000140f0: 6769 6320 796f 7520 6e65 6564 2e0a 0a20  gic you need... 
+00014100: 2020 2048 6572 6520 6973 2061 2073 696d     Here is a sim
+00014110: 706c 6520 6578 616d 706c 6520 7468 6174  ple example that
+00014120: 2075 7365 7320 7369 6d70 6c65 2066 756e   uses simple fun
+00014130: 6374 696f 6e73 2074 6f20 696c 6c75 7374  ctions to illust
+00014140: 7261 7465 2074 6865 2075 7365 206f 660a  rate the use of.
+00014150: 2020 2020 5275 6e6e 6162 6c65 5365 7175      RunnableSequ
+00014160: 656e 6365 3a0a 0a20 2020 2020 2020 202e  ence:..        .
+00014170: 2e20 636f 6465 2d62 6c6f 636b 3a3a 2070  . code-block:: p
+00014180: 7974 686f 6e0a 0a20 2020 2020 2020 2020  ython..         
+00014190: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+000141a0: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+000141b0: 2069 6d70 6f72 7420 5275 6e6e 6162 6c65   import Runnable
+000141c0: 4c61 6d62 6461 0a0a 2020 2020 2020 2020  Lambda..        
+000141d0: 2020 2020 6465 6620 6164 645f 6f6e 6528      def add_one(
+000141e0: 783a 2069 6e74 2920 2d3e 2069 6e74 3a0a  x: int) -> int:.
+000141f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014200: 7265 7475 726e 2078 202b 2031 0a0a 2020  return x + 1..  
+00014210: 2020 2020 2020 2020 2020 6465 6620 6d75            def mu
+00014220: 6c5f 7477 6f28 783a 2069 6e74 2920 2d3e  l_two(x: int) ->
+00014230: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
+00014240: 2020 2020 2020 7265 7475 726e 2078 202a        return x *
+00014250: 2032 0a0a 2020 2020 2020 2020 2020 2020   2..            
+00014260: 7275 6e6e 6162 6c65 5f31 203d 2052 756e  runnable_1 = Run
+00014270: 6e61 626c 654c 616d 6264 6128 6164 645f  nableLambda(add_
+00014280: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+00014290: 2072 756e 6e61 626c 655f 3220 3d20 5275   runnable_2 = Ru
+000142a0: 6e6e 6162 6c65 4c61 6d62 6461 286d 756c  nnableLambda(mul
+000142b0: 5f74 776f 290a 2020 2020 2020 2020 2020  _two).          
+000142c0: 2020 7365 7175 656e 6365 203d 2072 756e    sequence = run
+000142d0: 6e61 626c 655f 3120 7c20 7275 6e6e 6162  nable_1 | runnab
+000142e0: 6c65 5f32 0a20 2020 2020 2020 2020 2020  le_2.           
+000142f0: 2023 204f 7220 6571 7569 7661 6c65 6e74   # Or equivalent
+00014300: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+00014310: 2320 7365 7175 656e 6365 203d 2052 756e  # sequence = Run
+00014320: 6e61 626c 6553 6571 7565 6e63 6528 6669  nableSequence(fi
+00014330: 7273 743d 7275 6e6e 6162 6c65 5f31 2c20  rst=runnable_1, 
+00014340: 6c61 7374 3d72 756e 6e61 626c 655f 3229  last=runnable_2)
+00014350: 0a20 2020 2020 2020 2020 2020 2073 6571  .            seq
+00014360: 7565 6e63 652e 696e 766f 6b65 2831 290a  uence.invoke(1).
+00014370: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00014380: 7420 7365 7175 656e 6365 2e61 696e 766f  t sequence.ainvo
+00014390: 6b65 2831 290a 0a20 2020 2020 2020 2020  ke(1)..         
+000143a0: 2020 2073 6571 7565 6e63 652e 6261 7463     sequence.batc
+000143b0: 6828 5b31 2c20 322c 2033 5d29 0a20 2020  h([1, 2, 3]).   
+000143c0: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+000143d0: 6571 7565 6e63 652e 6162 6174 6368 285b  equence.abatch([
+000143e0: 312c 2032 2c20 335d 290a 0a20 2020 2048  1, 2, 3])..    H
+000143f0: 6572 6527 7320 616e 2065 7861 6d70 6c65  ere's an example
+00014400: 2074 6861 7420 7573 6573 2073 7472 6561   that uses strea
+00014410: 6d73 204a 534f 4e20 6f75 7470 7574 2067  ms JSON output g
+00014420: 656e 6572 6174 6564 2062 7920 616e 204c  enerated by an L
+00014430: 4c4d 3a0a 0a20 2020 2020 2020 202e 2e20  LM:..        .. 
+00014440: 636f 6465 2d62 6c6f 636b 3a3a 2070 7974  code-block:: pyt
+00014450: 686f 6e0a 0a20 2020 2020 2020 2020 2020  hon..           
+00014460: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+00014470: 636f 7265 2e6f 7574 7075 745f 7061 7273  core.output_pars
+00014480: 6572 732e 6a73 6f6e 2069 6d70 6f72 7420  ers.json import 
+00014490: 5369 6d70 6c65 4a73 6f6e 4f75 7470 7574  SimpleJsonOutput
+000144a0: 5061 7273 6572 0a20 2020 2020 2020 2020  Parser.         
+000144b0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+000144c0: 6e5f 6f70 656e 6169 2069 6d70 6f72 7420  n_openai import 
+000144d0: 4368 6174 4f70 656e 4149 0a0a 2020 2020  ChatOpenAI..    
+000144e0: 2020 2020 2020 2020 7072 6f6d 7074 203d          prompt =
+000144f0: 2050 726f 6d70 7454 656d 706c 6174 652e   PromptTemplate.
+00014500: 6672 6f6d 5f74 656d 706c 6174 6528 0a20  from_template(. 
+00014510: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00014520: 496e 204a 534f 4e20 666f 726d 6174 2c20  In JSON format, 
+00014530: 6769 7665 206d 6520 6120 6c69 7374 206f  give me a list o
+00014540: 6620 7b74 6f70 6963 7d20 616e 6420 7468  f {topic} and th
+00014550: 6569 7220 270a 2020 2020 2020 2020 2020  eir '.          
+00014560: 2020 2020 2020 2763 6f72 7265 7370 6f6e        'correspon
+00014570: 6469 6e67 206e 616d 6573 2069 6e20 4672  ding names in Fr
+00014580: 656e 6368 2c20 5370 616e 6973 6820 616e  ench, Spanish an
+00014590: 6420 696e 2061 2027 0a20 2020 2020 2020  d in a '.       
+000145a0: 2020 2020 2020 2020 2027 4361 7420 4c61           'Cat La
+000145b0: 6e67 7561 6765 2e27 0a20 2020 2020 2020  nguage.'.       
+000145c0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000145d0: 2020 2020 6d6f 6465 6c20 3d20 4368 6174      model = Chat
+000145e0: 4f70 656e 4149 2829 0a20 2020 2020 2020  OpenAI().       
+000145f0: 2020 2020 2063 6861 696e 203d 2070 726f       chain = pro
+00014600: 6d70 7420 7c20 6d6f 6465 6c20 7c20 5369  mpt | model | Si
+00014610: 6d70 6c65 4a73 6f6e 4f75 7470 7574 5061  mpleJsonOutputPa
+00014620: 7273 6572 2829 0a0a 2020 2020 2020 2020  rser()..        
+00014630: 2020 2020 6173 796e 6320 666f 7220 6368      async for ch
+00014640: 756e 6b20 696e 2063 6861 696e 2e61 7374  unk in chain.ast
+00014650: 7265 616d 287b 2774 6f70 6963 273a 2027  ream({'topic': '
+00014660: 636f 6c6f 7273 277d 293a 0a20 2020 2020  colors'}):.     
+00014670: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00014680: 2827 2d27 2920 2023 206e 6f71 613a 2054  ('-')  # noqa: T
+00014690: 3230 310a 2020 2020 2020 2020 2020 2020  201.            
+000146a0: 2020 2020 7072 696e 7428 6368 756e 6b2c      print(chunk,
+000146b0: 2073 6570 3d27 272c 2066 6c75 7368 3d54   sep='', flush=T
+000146c0: 7275 6529 2020 2320 6e6f 7161 3a20 5432  rue)  # noqa: T2
+000146d0: 3031 0a20 2020 2022 2222 0a0a 2020 2020  01.    """..    
+000146e0: 2320 5468 6520 7374 6570 7320 6172 6520  # The steps are 
+000146f0: 6272 6f6b 656e 2069 6e74 6f20 6669 7273  broken into firs
+00014700: 742c 206d 6964 646c 6520 616e 6420 6c61  t, middle and la
+00014710: 7374 2c20 736f 6c65 6c79 2066 6f72 2074  st, solely for t
+00014720: 7970 6520 6368 6563 6b69 6e67 0a20 2020  ype checking.   
+00014730: 2023 2070 7572 706f 7365 732e 2049 7420   # purposes. It 
+00014740: 616c 6c6f 7773 2073 7065 6369 6679 696e  allows specifyin
+00014750: 6720 7468 6520 6049 6e70 7574 6020 6f6e  g the `Input` on
+00014760: 2074 6865 2066 6972 7374 2074 7970 652c   the first type,
+00014770: 2074 6865 2060 4f75 7470 7574 6020 6f66   the `Output` of
+00014780: 0a20 2020 2023 2074 6865 206c 6173 7420  .    # the last 
+00014790: 7479 7065 2e0a 2020 2020 6669 7273 743a  type..    first:
+000147a0: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
+000147b0: 2041 6e79 5d0a 2020 2020 2222 2254 6865   Any].    """The
+000147c0: 2066 6972 7374 2072 756e 6e61 626c 6520   first runnable 
+000147d0: 696e 2074 6865 2073 6571 7565 6e63 652e  in the sequence.
+000147e0: 2222 220a 2020 2020 6d69 6464 6c65 3a20  """.    middle: 
+000147f0: 4c69 7374 5b52 756e 6e61 626c 655b 416e  List[Runnable[An
+00014800: 792c 2041 6e79 5d5d 203d 2046 6965 6c64  y, Any]] = Field
+00014810: 2864 6566 6175 6c74 5f66 6163 746f 7279  (default_factory
+00014820: 3d6c 6973 7429 0a20 2020 2022 2222 5468  =list).    """Th
+00014830: 6520 6d69 6464 6c65 2072 756e 6e61 626c  e middle runnabl
+00014840: 6573 2069 6e20 7468 6520 7365 7175 656e  es in the sequen
+00014850: 6365 2e22 2222 0a20 2020 206c 6173 743a  ce.""".    last:
+00014860: 2052 756e 6e61 626c 655b 416e 792c 204f   Runnable[Any, O
+00014870: 7574 7075 745d 0a20 2020 2022 2222 5468  utput].    """Th
+00014880: 6520 6c61 7374 2072 756e 6e61 626c 6520  e last runnable 
+00014890: 696e 2074 6865 2073 6571 7565 6e63 652e  in the sequence.
+000148a0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+000148b0: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+000148c0: 656c 662c 0a20 2020 2020 2020 202a 7374  elf,.        *st
+000148d0: 6570 733a 2052 756e 6e61 626c 654c 696b  eps: RunnableLik
+000148e0: 652c 0a20 2020 2020 2020 206e 616d 653a  e,.        name:
+000148f0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00014900: 204e 6f6e 652c 0a20 2020 2020 2020 2066   None,.        f
+00014910: 6972 7374 3a20 4f70 7469 6f6e 616c 5b52  irst: Optional[R
+00014920: 756e 6e61 626c 655b 416e 792c 2041 6e79  unnable[Any, Any
+00014930: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00014940: 2020 206d 6964 646c 653a 204f 7074 696f     middle: Optio
+00014950: 6e61 6c5b 4c69 7374 5b52 756e 6e61 626c  nal[List[Runnabl
+00014960: 655b 416e 792c 2041 6e79 5d5d 5d20 3d20  e[Any, Any]]] = 
+00014970: 4e6f 6e65 2c0a 2020 2020 2020 2020 6c61  None,.        la
+00014980: 7374 3a20 4f70 7469 6f6e 616c 5b52 756e  st: Optional[Run
+00014990: 6e61 626c 655b 416e 792c 2041 6e79 5d5d  nable[Any, Any]]
+000149a0: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+000149b0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000149c0: 2222 2243 7265 6174 6520 6120 6e65 7720  """Create a new 
+000149d0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+000149e0: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+000149f0: 0a20 2020 2020 2020 2020 2020 2073 7465  .            ste
+00014a00: 7073 3a20 5468 6520 7374 6570 7320 746f  ps: The steps to
+00014a10: 2069 6e63 6c75 6465 2069 6e20 7468 6520   include in the 
+00014a20: 7365 7175 656e 6365 2e0a 2020 2020 2020  sequence..      
+00014a30: 2020 2222 220a 2020 2020 2020 2020 7374    """.        st
+00014a40: 6570 735f 666c 6174 3a20 4c69 7374 5b52  eps_flat: List[R
+00014a50: 756e 6e61 626c 655d 203d 205b 5d0a 2020  unnable] = [].  
+00014a60: 2020 2020 2020 6966 206e 6f74 2073 7465        if not ste
+00014a70: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+00014a80: 6966 2066 6972 7374 2069 7320 6e6f 7420  if first is not 
+00014a90: 4e6f 6e65 2061 6e64 206c 6173 7420 6973  None and last is
+00014aa0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00014ab0: 2020 2020 2020 2020 2020 2073 7465 7073             steps
+00014ac0: 5f66 6c61 7420 3d20 5b66 6972 7374 5d20  _flat = [first] 
+00014ad0: 2b20 286d 6964 646c 6520 6f72 205b 5d29  + (middle or [])
+00014ae0: 202b 205b 6c61 7374 5d0a 2020 2020 2020   + [last].      
+00014af0: 2020 666f 7220 7374 6570 2069 6e20 7374    for step in st
+00014b00: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
+00014b10: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+00014b20: 7465 702c 2052 756e 6e61 626c 6553 6571  tep, RunnableSeq
+00014b30: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
+00014b40: 2020 2020 2020 2020 7374 6570 735f 666c          steps_fl
+00014b50: 6174 2e65 7874 656e 6428 7374 6570 2e73  at.extend(step.s
+00014b60: 7465 7073 290a 2020 2020 2020 2020 2020  teps).          
+00014b70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00014b80: 2020 2020 2020 2020 7374 6570 735f 666c          steps_fl
+00014b90: 6174 2e61 7070 656e 6428 636f 6572 6365  at.append(coerce
+00014ba0: 5f74 6f5f 7275 6e6e 6162 6c65 2873 7465  _to_runnable(ste
+00014bb0: 7029 290a 2020 2020 2020 2020 6966 206c  p)).        if l
+00014bc0: 656e 2873 7465 7073 5f66 6c61 7429 203c  en(steps_flat) <
+00014bd0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+00014be0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00014bf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00014c00: 2020 6622 5275 6e6e 6162 6c65 5365 7175    f"RunnableSequ
+00014c10: 656e 6365 206d 7573 7420 6861 7665 2061  ence must have a
+00014c20: 7420 6c65 6173 7420 3220 7374 6570 732c  t least 2 steps,
+00014c30: 2067 6f74 207b 6c65 6e28 7374 6570 735f   got {len(steps_
+00014c40: 666c 6174 297d 220a 2020 2020 2020 2020  flat)}".        
+00014c50: 2020 2020 290a 2020 2020 2020 2020 7375      ).        su
+00014c60: 7065 7228 292e 5f5f 696e 6974 5f5f 2820  per().__init__( 
+00014c70: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+00014c80: 6361 6c6c 2d61 7267 5d0a 2020 2020 2020  call-arg].      
+00014c90: 2020 2020 2020 6669 7273 743d 7374 6570        first=step
+00014ca0: 735f 666c 6174 5b30 5d2c 0a20 2020 2020  s_flat[0],.     
+00014cb0: 2020 2020 2020 206d 6964 646c 653d 6c69         middle=li
+00014cc0: 7374 2873 7465 7073 5f66 6c61 745b 313a  st(steps_flat[1:
+00014cd0: 2d31 5d29 2c0a 2020 2020 2020 2020 2020  -1]),.          
+00014ce0: 2020 6c61 7374 3d73 7465 7073 5f66 6c61    last=steps_fla
+00014cf0: 745b 2d31 5d2c 0a20 2020 2020 2020 2020  t[-1],.         
+00014d00: 2020 206e 616d 653d 6e61 6d65 2c0a 2020     name=name,.  
+00014d10: 2020 2020 2020 290a 0a20 2020 2040 636c        )..    @cl
+00014d20: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+00014d30: 6620 6765 745f 6c63 5f6e 616d 6573 7061  f get_lc_namespa
+00014d40: 6365 2863 6c73 2920 2d3e 204c 6973 745b  ce(cls) -> List[
+00014d50: 7374 725d 3a0a 2020 2020 2020 2020 2222  str]:.        ""
+00014d60: 2247 6574 2074 6865 206e 616d 6573 7061  "Get the namespa
+00014d70: 6365 206f 6620 7468 6520 6c61 6e67 6368  ce of the langch
+00014d80: 6169 6e20 6f62 6a65 6374 2e22 2222 0a20  ain object.""". 
+00014d90: 2020 2020 2020 2072 6574 7572 6e20 5b22         return ["
+00014da0: 6c61 6e67 6368 6169 6e22 2c20 2273 6368  langchain", "sch
+00014db0: 656d 6122 2c20 2272 756e 6e61 626c 6522  ema", "runnable"
+00014dc0: 5d0a 0a20 2020 2040 7072 6f70 6572 7479  ]..    @property
+00014dd0: 0a20 2020 2064 6566 2073 7465 7073 2873  .    def steps(s
+00014de0: 656c 6629 202d 3e20 4c69 7374 5b52 756e  elf) -> List[Run
+00014df0: 6e61 626c 655b 416e 792c 2041 6e79 5d5d  nable[Any, Any]]
+00014e00: 3a0a 2020 2020 2020 2020 2222 2241 6c6c  :.        """All
+00014e10: 2074 6865 2072 756e 6e61 626c 6573 2074   the runnables t
+00014e20: 6861 7420 6d61 6b65 2075 7020 7468 6520  hat make up the 
+00014e30: 7365 7175 656e 6365 2069 6e20 6f72 6465  sequence in orde
+00014e40: 722e 2222 220a 2020 2020 2020 2020 7265  r.""".        re
+00014e50: 7475 726e 205b 7365 6c66 2e66 6972 7374  turn [self.first
+00014e60: 5d20 2b20 7365 6c66 2e6d 6964 646c 6520  ] + self.middle 
+00014e70: 2b20 5b73 656c 662e 6c61 7374 5d0a 0a20  + [self.last].. 
+00014e80: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
+00014e90: 2020 2020 6465 6620 6973 5f6c 635f 7365      def is_lc_se
+00014ea0: 7269 616c 697a 6162 6c65 2863 6c73 2920  rializable(cls) 
+00014eb0: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00014ec0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+00014ed0: 2020 636c 6173 7320 436f 6e66 6967 3a0a    class Config:.
+00014ee0: 2020 2020 2020 2020 6172 6269 7472 6172          arbitrar
+00014ef0: 795f 7479 7065 735f 616c 6c6f 7765 6420  y_types_allowed 
+00014f00: 3d20 5472 7565 0a0a 2020 2020 4070 726f  = True..    @pro
+00014f10: 7065 7274 790a 2020 2020 6465 6620 496e  perty.    def In
+00014f20: 7075 7454 7970 6528 7365 6c66 2920 2d3e  putType(self) ->
+00014f30: 2054 7970 655b 496e 7075 745d 3a0a 2020   Type[Input]:.  
+00014f40: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00014f50: 662e 6669 7273 742e 496e 7075 7454 7970  f.first.InputTyp
+00014f60: 650a 0a20 2020 2040 7072 6f70 6572 7479  e..    @property
+00014f70: 0a20 2020 2064 6566 204f 7574 7075 7454  .    def OutputT
+00014f80: 7970 6528 7365 6c66 2920 2d3e 2054 7970  ype(self) -> Typ
+00014f90: 655b 4f75 7470 7574 5d3a 0a20 2020 2020  e[Output]:.     
+00014fa0: 2020 2072 6574 7572 6e20 7365 6c66 2e6c     return self.l
+00014fb0: 6173 742e 4f75 7470 7574 5479 7065 0a0a  ast.OutputType..
+00014fc0: 2020 2020 6465 6620 6765 745f 696e 7075      def get_inpu
+00014fd0: 745f 7363 6865 6d61 280a 2020 2020 2020  t_schema(.      
+00014fe0: 2020 7365 6c66 2c20 636f 6e66 6967 3a20    self, config: 
+00014ff0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+00015000: 6543 6f6e 6669 675d 203d 204e 6f6e 650a  eConfig] = None.
+00015010: 2020 2020 2920 2d3e 2054 7970 655b 4261      ) -> Type[Ba
+00015020: 7365 4d6f 6465 6c5d 3a0a 2020 2020 2020  seModel]:.      
+00015030: 2020 7265 7475 726e 205f 7365 715f 696e    return _seq_in
+00015040: 7075 745f 7363 6865 6d61 2873 656c 662e  put_schema(self.
+00015050: 7374 6570 732c 2063 6f6e 6669 6729 0a0a  steps, config)..
+00015060: 2020 2020 6465 6620 6765 745f 6f75 7470      def get_outp
+00015070: 7574 5f73 6368 656d 6128 0a20 2020 2020  ut_schema(.     
+00015080: 2020 2073 656c 662c 2063 6f6e 6669 673a     self, config:
+00015090: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
+000150a0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
+000150b0: 0a20 2020 2029 202d 3e20 5479 7065 5b42  .    ) -> Type[B
+000150c0: 6173 654d 6f64 656c 5d3a 0a20 2020 2020  aseModel]:.     
+000150d0: 2020 2072 6574 7572 6e20 5f73 6571 5f6f     return _seq_o
+000150e0: 7574 7075 745f 7363 6865 6d61 2873 656c  utput_schema(sel
+000150f0: 662e 7374 6570 732c 2063 6f6e 6669 6729  f.steps, config)
+00015100: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00015110: 2020 2020 6465 6620 636f 6e66 6967 5f73      def config_s
+00015120: 7065 6373 2873 656c 6629 202d 3e20 4c69  pecs(self) -> Li
+00015130: 7374 5b43 6f6e 6669 6775 7261 626c 6546  st[ConfigurableF
+00015140: 6965 6c64 5370 6563 5d3a 0a20 2020 2020  ieldSpec]:.     
+00015150: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+00015160: 6e5f 636f 7265 2e62 6574 612e 7275 6e6e  n_core.beta.runn
+00015170: 6162 6c65 732e 636f 6e74 6578 7420 696d  ables.context im
+00015180: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
+00015190: 2020 2043 4f4e 5445 5854 5f43 4f4e 4649     CONTEXT_CONFI
+000151a0: 475f 5052 4546 4958 2c0a 2020 2020 2020  G_PREFIX,.      
+000151b0: 2020 2020 2020 5f6b 6579 5f66 726f 6d5f        _key_from_
+000151c0: 6964 2c0a 2020 2020 2020 2020 290a 0a20  id,.        ).. 
+000151d0: 2020 2020 2020 2023 2067 6574 2061 6c6c         # get all
+000151e0: 2073 7065 6373 0a20 2020 2020 2020 2061   specs.        a
+000151f0: 6c6c 5f73 7065 6373 203d 205b 0a20 2020  ll_specs = [.   
+00015200: 2020 2020 2020 2020 2028 7370 6563 2c20           (spec, 
+00015210: 6964 7829 0a20 2020 2020 2020 2020 2020  idx).           
+00015220: 2066 6f72 2069 6478 2c20 7374 6570 2069   for idx, step i
+00015230: 6e20 656e 756d 6572 6174 6528 7365 6c66  n enumerate(self
+00015240: 2e73 7465 7073 290a 2020 2020 2020 2020  .steps).        
+00015250: 2020 2020 666f 7220 7370 6563 2069 6e20      for spec in 
+00015260: 7374 6570 2e63 6f6e 6669 675f 7370 6563  step.config_spec
+00015270: 730a 2020 2020 2020 2020 5d0a 2020 2020  s.        ].    
+00015280: 2020 2020 2320 6361 6c63 756c 6174 6520      # calculate 
+00015290: 636f 6e74 6578 7420 6465 7065 6e64 656e  context dependen
+000152a0: 6369 6573 0a20 2020 2020 2020 2073 7065  cies.        spe
+000152b0: 6373 5f62 795f 706f 7320 3d20 6772 6f75  cs_by_pos = grou
+000152c0: 7062 7928 0a20 2020 2020 2020 2020 2020  pby(.           
+000152d0: 205b 7475 7020 666f 7220 7475 7020 696e   [tup for tup in
+000152e0: 2061 6c6c 5f73 7065 6373 2069 6620 7475   all_specs if tu
+000152f0: 705b 305d 2e69 642e 7374 6172 7473 7769  p[0].id.startswi
+00015300: 7468 2843 4f4e 5445 5854 5f43 4f4e 4649  th(CONTEXT_CONFI
+00015310: 475f 5052 4546 4958 295d 2c0a 2020 2020  G_PREFIX)],.    
+00015320: 2020 2020 2020 2020 6c61 6d62 6461 2078          lambda x
+00015330: 3a20 785b 315d 2c0a 2020 2020 2020 2020  : x[1],.        
+00015340: 290a 2020 2020 2020 2020 6e65 7874 5f64  ).        next_d
+00015350: 6570 733a 2053 6574 5b73 7472 5d20 3d20  eps: Set[str] = 
+00015360: 7365 7428 290a 2020 2020 2020 2020 6465  set().        de
+00015370: 7073 5f62 795f 706f 733a 2044 6963 745b  ps_by_pos: Dict[
+00015380: 696e 742c 2053 6574 5b73 7472 5d5d 203d  int, Set[str]] =
+00015390: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+000153a0: 706f 732c 2073 7065 6373 2069 6e20 7370  pos, specs in sp
+000153b0: 6563 735f 6279 5f70 6f73 3a0a 2020 2020  ecs_by_pos:.    
+000153c0: 2020 2020 2020 2020 6465 7073 5f62 795f          deps_by_
+000153d0: 706f 735b 706f 735d 203d 206e 6578 745f  pos[pos] = next_
+000153e0: 6465 7073 0a20 2020 2020 2020 2020 2020  deps.           
+000153f0: 206e 6578 745f 6465 7073 203d 206e 6578   next_deps = nex
+00015400: 745f 6465 7073 207c 207b 7370 6563 5b30  t_deps | {spec[0
+00015410: 5d2e 6964 2066 6f72 2073 7065 6320 696e  ].id for spec in
+00015420: 2073 7065 6373 7d0a 2020 2020 2020 2020   specs}.        
+00015430: 2320 6173 7369 676e 2063 6f6e 7465 7874  # assign context
+00015440: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
+00015450: 2020 2020 2020 666f 7220 706f 732c 2028        for pos, (
+00015460: 7370 6563 2c20 6964 7829 2069 6e20 656e  spec, idx) in en
+00015470: 756d 6572 6174 6528 616c 6c5f 7370 6563  umerate(all_spec
+00015480: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00015490: 6966 2073 7065 632e 6964 2e73 7461 7274  if spec.id.start
+000154a0: 7377 6974 6828 434f 4e54 4558 545f 434f  swith(CONTEXT_CO
+000154b0: 4e46 4947 5f50 5245 4649 5829 3a0a 2020  NFIG_PREFIX):.  
+000154c0: 2020 2020 2020 2020 2020 2020 2020 616c                al
+000154d0: 6c5f 7370 6563 735b 706f 735d 203d 2028  l_specs[pos] = (
+000154e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000154f0: 2020 2020 2043 6f6e 6669 6775 7261 626c       Configurabl
+00015500: 6546 6965 6c64 5370 6563 280a 2020 2020  eFieldSpec(.    
+00015510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015520: 2020 2020 6964 3d73 7065 632e 6964 2c0a      id=spec.id,.
 00015530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015540: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00015550: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00015560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015570: 2020 666f 7220 6b65 792c 2073 7465 7020    for key, step 
-00015580: 696e 2073 7465 7073 2e69 7465 6d73 2829  in steps.items()
-00015590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000155a0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-000155b0: 2020 206f 7574 7075 7420 3d20 7b6b 6579     output = {key
-000155c0: 3a20 6675 7475 7265 2e72 6573 756c 7428  : future.result(
-000155d0: 2920 666f 7220 6b65 792c 2066 7574 7572  ) for key, futur
-000155e0: 6520 696e 207a 6970 2873 7465 7073 2c20  e in zip(steps, 
-000155f0: 6675 7475 7265 7329 7d0a 2020 2020 2020  futures)}.      
-00015600: 2020 2320 6669 6e69 7368 2074 6865 2072    # finish the r
-00015610: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
-00015620: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
-00015630: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00015640: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
-00015650: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
-00015660: 7228 6529 0a20 2020 2020 2020 2020 2020  r(e).           
-00015670: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
-00015680: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00015690: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
-000156a0: 6368 6169 6e5f 656e 6428 6f75 7470 7574  chain_end(output
-000156b0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000156c0: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
-000156d0: 2061 7379 6e63 2064 6566 2061 696e 766f   async def ainvo
-000156e0: 6b65 280a 2020 2020 2020 2020 7365 6c66  ke(.        self
-000156f0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00015700: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
-00015710: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00015720: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00015730: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00015740: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00015750: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00015760: 2d3e 2044 6963 745b 7374 722c 2041 6e79  -> Dict[str, Any
-00015770: 5d3a 0a20 2020 2020 2020 2023 2073 6574  ]:.        # set
-00015780: 7570 2063 616c 6c62 6163 6b73 0a20 2020  up callbacks.   
-00015790: 2020 2020 2063 6f6e 6669 6720 3d20 656e       config = en
-000157a0: 7375 7265 5f63 6f6e 6669 6728 636f 6e66  sure_config(conf
-000157b0: 6967 290a 2020 2020 2020 2020 6361 6c6c  ig).        call
-000157c0: 6261 636b 5f6d 616e 6167 6572 203d 2067  back_manager = g
-000157d0: 6574 5f61 7379 6e63 5f63 616c 6c62 6163  et_async_callbac
-000157e0: 6b5f 6d61 6e61 6765 725f 666f 725f 636f  k_manager_for_co
-000157f0: 6e66 6967 2863 6f6e 6669 6729 0a20 2020  nfig(config).   
-00015800: 2020 2020 2023 2073 7461 7274 2074 6865       # start the
-00015810: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
-00015820: 2020 7275 6e5f 6d61 6e61 6765 7220 3d20    run_manager = 
-00015830: 6177 6169 7420 6361 6c6c 6261 636b 5f6d  await callback_m
-00015840: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-00015850: 7374 6172 7428 0a20 2020 2020 2020 2020  start(.         
-00015860: 2020 2064 756d 7064 2873 656c 6629 2c20     dumpd(self), 
-00015870: 696e 7075 742c 206e 616d 653d 636f 6e66  input, name=conf
-00015880: 6967 2e67 6574 2822 7275 6e5f 6e61 6d65  ig.get("run_name
-00015890: 2229 206f 7220 7365 6c66 2e67 6574 5f6e  ") or self.get_n
-000158a0: 616d 6528 290a 2020 2020 2020 2020 290a  ame().        ).
-000158b0: 0a20 2020 2020 2020 2023 2067 6174 6865  .        # gathe
-000158c0: 7220 7265 7375 6c74 7320 6672 6f6d 2061  r results from a
-000158d0: 6c6c 2073 7465 7073 0a20 2020 2020 2020  ll steps.       
-000158e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000158f0: 2020 2320 636f 7079 2074 6f20 6176 6f69    # copy to avoi
-00015900: 6420 6973 7375 6573 2066 726f 6d20 7468  d issues from th
-00015910: 6520 6361 6c6c 6572 206d 7574 6174 696e  e caller mutatin
-00015920: 6720 7468 6520 7374 6570 7320 6475 7269  g the steps duri
-00015930: 6e67 2069 6e76 6f6b 6528 290a 2020 2020  ng invoke().    
-00015940: 2020 2020 2020 2020 7374 6570 7320 3d20          steps = 
-00015950: 6469 6374 2873 656c 662e 7374 6570 7329  dict(self.steps)
-00015960: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00015970: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
-00015980: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-00015990: 2020 2020 2020 2020 2020 2020 202a 280a               *(.
-000159a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159b0: 2020 2020 7374 6570 2e61 696e 766f 6b65      step.ainvoke
-000159c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000159d0: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+00015540: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+00015550: 6f6e 3d73 7065 632e 616e 6e6f 7461 7469  on=spec.annotati
+00015560: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+00015570: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00015580: 3d73 7065 632e 6e61 6d65 2c0a 2020 2020  =spec.name,.    
+00015590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155a0: 2020 2020 6465 6661 756c 743d 7370 6563      default=spec
+000155b0: 2e64 6566 6175 6c74 2c0a 2020 2020 2020  .default,.      
+000155c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155d0: 2020 6465 7363 7269 7074 696f 6e3d 7370    description=sp
+000155e0: 6563 2e64 6573 6372 6970 7469 6f6e 2c0a  ec.description,.
+000155f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015600: 2020 2020 2020 2020 6973 5f73 6861 7265          is_share
+00015610: 643d 7370 6563 2e69 735f 7368 6172 6564  d=spec.is_shared
+00015620: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015630: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
+00015640: 656e 6369 6573 3d5b 0a20 2020 2020 2020  encies=[.       
+00015650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015660: 2020 2020 2064 0a20 2020 2020 2020 2020       d.         
+00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015680: 2020 2066 6f72 2064 2069 6e20 6465 7073     for d in deps
+00015690: 5f62 795f 706f 735b 6964 785d 0a20 2020  _by_pos[idx].   
+000156a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156b0: 2020 2020 2020 2020 2069 6620 5f6b 6579           if _key
+000156c0: 5f66 726f 6d5f 6964 2864 2920 213d 205f  _from_id(d) != _
+000156d0: 6b65 795f 6672 6f6d 5f69 6428 7370 6563  key_from_id(spec
+000156e0: 2e69 6429 0a20 2020 2020 2020 2020 2020  .id).           
+000156f0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
+00015700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015710: 2020 2020 2020 202b 2028 7370 6563 2e64         + (spec.d
+00015720: 6570 656e 6465 6e63 6965 7320 6f72 205b  ependencies or [
+00015730: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+00015740: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00015750: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00015760: 6478 2c0a 2020 2020 2020 2020 2020 2020  dx,.            
+00015770: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
+00015780: 6574 7572 6e20 6765 745f 756e 6971 7565  eturn get_unique
+00015790: 5f63 6f6e 6669 675f 7370 6563 7328 7370  _config_specs(sp
+000157a0: 6563 2066 6f72 2073 7065 632c 205f 2069  ec for spec, _ i
+000157b0: 6e20 616c 6c5f 7370 6563 7329 0a0a 2020  n all_specs)..  
+000157c0: 2020 6465 6620 6765 745f 6772 6170 6828    def get_graph(
+000157d0: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
+000157e0: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+000157f0: 6f6e 6669 675d 203d 204e 6f6e 6529 202d  onfig] = None) -
+00015800: 3e20 4772 6170 683a 0a20 2020 2020 2020  > Graph:.       
+00015810: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+00015820: 636f 7265 2e72 756e 6e61 626c 6573 2e67  core.runnables.g
+00015830: 7261 7068 2069 6d70 6f72 7420 4772 6170  raph import Grap
+00015840: 680a 0a20 2020 2020 2020 2067 7261 7068  h..        graph
+00015850: 203d 2047 7261 7068 2829 0a20 2020 2020   = Graph().     
+00015860: 2020 2066 6f72 2073 7465 7020 696e 2073     for step in s
+00015870: 656c 662e 7374 6570 733a 0a20 2020 2020  elf.steps:.     
+00015880: 2020 2020 2020 2063 7572 7265 6e74 5f6c         current_l
+00015890: 6173 745f 6e6f 6465 203d 2067 7261 7068  ast_node = graph
+000158a0: 2e6c 6173 745f 6e6f 6465 2829 0a20 2020  .last_node().   
+000158b0: 2020 2020 2020 2020 2073 7465 705f 6772           step_gr
+000158c0: 6170 6820 3d20 7374 6570 2e67 6574 5f67  aph = step.get_g
+000158d0: 7261 7068 2863 6f6e 6669 6729 0a20 2020  raph(config).   
+000158e0: 2020 2020 2020 2020 2069 6620 7374 6570           if step
+000158f0: 2069 7320 6e6f 7420 7365 6c66 2e66 6972   is not self.fir
+00015900: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00015910: 2020 2020 7374 6570 5f67 7261 7068 2e74      step_graph.t
+00015920: 7269 6d5f 6669 7273 745f 6e6f 6465 2829  rim_first_node()
+00015930: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00015940: 7374 6570 2069 7320 6e6f 7420 7365 6c66  step is not self
+00015950: 2e6c 6173 743a 0a20 2020 2020 2020 2020  .last:.         
+00015960: 2020 2020 2020 2073 7465 705f 6772 6170         step_grap
+00015970: 682e 7472 696d 5f6c 6173 745f 6e6f 6465  h.trim_last_node
+00015980: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+00015990: 7465 705f 6669 7273 745f 6e6f 6465 2c20  tep_first_node, 
+000159a0: 5f20 3d20 6772 6170 682e 6578 7465 6e64  _ = graph.extend
+000159b0: 2873 7465 705f 6772 6170 6829 0a20 2020  (step_graph).   
+000159c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000159d0: 7374 6570 5f66 6972 7374 5f6e 6f64 653a  step_first_node:
 000159e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000159f0: 2020 2020 2020 2020 2023 206d 6172 6b20           # mark 
-00015a00: 6561 6368 2073 7465 7020 6173 2061 2063  each step as a c
-00015a10: 6869 6c64 2072 756e 0a20 2020 2020 2020  hild run.       
-00015a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a30: 2070 6174 6368 5f63 6f6e 6669 6728 0a20   patch_config(. 
-00015a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a50: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00015a60: 672c 2063 616c 6c62 6163 6b73 3d72 756e  g, callbacks=run
-00015a70: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
-00015a80: 6c64 2866 226d 6170 3a6b 6579 3a7b 6b65  ld(f"map:key:{ke
-00015a90: 797d 2229 0a20 2020 2020 2020 2020 2020  y}").           
-00015aa0: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00015ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ac0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00015ad0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-00015ae0: 792c 2073 7465 7020 696e 2073 7465 7073  y, step in steps
-00015af0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-00015b00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015b10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00015b20: 2020 2020 206f 7574 7075 7420 3d20 7b6b       output = {k
-00015b30: 6579 3a20 7661 6c75 6520 666f 7220 6b65  ey: value for ke
-00015b40: 792c 2076 616c 7565 2069 6e20 7a69 7028  y, value in zip(
-00015b50: 7374 6570 732c 2072 6573 756c 7473 297d  steps, results)}
-00015b60: 0a20 2020 2020 2020 2023 2066 696e 6973  .        # finis
-00015b70: 6820 7468 6520 726f 6f74 2072 756e 0a20  h the root run. 
-00015b80: 2020 2020 2020 2065 7863 6570 7420 4261         except Ba
-00015b90: 7365 4578 6365 7074 696f 6e20 6173 2065  seException as e
-00015ba0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00015bb0: 6169 7420 7275 6e5f 6d61 6e61 6765 722e  ait run_manager.
-00015bc0: 6f6e 5f63 6861 696e 5f65 7272 6f72 2865  on_chain_error(e
-00015bd0: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-00015be0: 6973 650a 2020 2020 2020 2020 656c 7365  ise.        else
-00015bf0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00015c00: 6169 7420 7275 6e5f 6d61 6e61 6765 722e  ait run_manager.
-00015c10: 6f6e 5f63 6861 696e 5f65 6e64 286f 7574  on_chain_end(out
-00015c20: 7075 7429 0a20 2020 2020 2020 2020 2020  put).           
-00015c30: 2072 6574 7572 6e20 6f75 7470 7574 0a0a   return output..
-00015c40: 2020 2020 6465 6620 5f74 7261 6e73 666f      def _transfo
-00015c50: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
-00015c60: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00015c70: 2049 7465 7261 746f 725b 496e 7075 745d   Iterator[Input]
-00015c80: 2c0a 2020 2020 2020 2020 7275 6e5f 6d61  ,.        run_ma
-00015c90: 6e61 6765 723a 2043 616c 6c62 6163 6b4d  nager: CallbackM
-00015ca0: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-00015cb0: 6e2c 0a20 2020 2020 2020 2063 6f6e 6669  n,.        confi
-00015cc0: 673a 2052 756e 6e61 626c 6543 6f6e 6669  g: RunnableConfi
-00015cd0: 672c 0a20 2020 2029 202d 3e20 4974 6572  g,.    ) -> Iter
-00015ce0: 6174 6f72 5b41 6464 6162 6c65 4469 6374  ator[AddableDict
-00015cf0: 5d3a 0a20 2020 2020 2020 2023 2053 6861  ]:.        # Sha
-00015d00: 6c6c 6f77 2063 6f70 7920 7374 6570 7320  llow copy steps 
-00015d10: 746f 2069 676e 6f72 6520 6d75 7461 7469  to ignore mutati
-00015d20: 6f6e 7320 7768 696c 6520 696e 2070 726f  ons while in pro
-00015d30: 6772 6573 730a 2020 2020 2020 2020 7374  gress.        st
-00015d40: 6570 7320 3d20 6469 6374 2873 656c 662e  eps = dict(self.
-00015d50: 7374 6570 7329 0a20 2020 2020 2020 2023  steps).        #
-00015d60: 2045 6163 6820 7374 6570 2067 6574 7320   Each step gets 
-00015d70: 6120 636f 7079 206f 6620 7468 6520 696e  a copy of the in
-00015d80: 7075 7420 6974 6572 6174 6f72 2c0a 2020  put iterator,.  
-00015d90: 2020 2020 2020 2320 7768 6963 6820 6973        # which is
-00015da0: 2063 6f6e 7375 6d65 6420 696e 2070 6172   consumed in par
-00015db0: 616c 6c65 6c20 696e 2061 2073 6570 6172  allel in a separ
-00015dc0: 6174 6520 7468 7265 6164 2e0a 2020 2020  ate thread..    
-00015dd0: 2020 2020 696e 7075 745f 636f 7069 6573      input_copies
-00015de0: 203d 206c 6973 7428 7361 6665 7465 6528   = list(safetee(
-00015df0: 696e 7075 742c 206c 656e 2873 7465 7073  input, len(steps
-00015e00: 292c 206c 6f63 6b3d 7468 7265 6164 696e  ), lock=threadin
-00015e10: 672e 4c6f 636b 2829 2929 0a20 2020 2020  g.Lock())).     
-00015e20: 2020 2077 6974 6820 6765 745f 6578 6563     with get_exec
-00015e30: 7574 6f72 5f66 6f72 5f63 6f6e 6669 6728  utor_for_config(
-00015e40: 636f 6e66 6967 2920 6173 2065 7865 6375  config) as execu
-00015e50: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
-00015e60: 2023 2043 7265 6174 6520 7468 6520 7472   # Create the tr
-00015e70: 616e 7366 6f72 6d28 2920 6765 6e65 7261  ansform() genera
-00015e80: 746f 7220 666f 7220 6561 6368 2073 7465  tor for each ste
-00015e90: 700a 2020 2020 2020 2020 2020 2020 6e61  p.            na
-00015ea0: 6d65 645f 6765 6e65 7261 746f 7273 203d  med_generators =
-00015eb0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00015ec0: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00015ed0: 2020 2020 2020 2020 206e 616d 652c 0a20           name,. 
-00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ef0: 2020 2073 7465 702e 7472 616e 7366 6f72     step.transfor
-00015f00: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
-00015f10: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-00015f20: 5f63 6f70 6965 732e 706f 7028 292c 0a20  _copies.pop(),. 
-00015f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f40: 2020 2020 2020 2070 6174 6368 5f63 6f6e         patch_con
-00015f50: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
-00015f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f70: 2063 6f6e 6669 672c 2063 616c 6c62 6163   config, callbac
-00015f80: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
-00015f90: 6574 5f63 6869 6c64 2866 226d 6170 3a6b  et_child(f"map:k
-00015fa0: 6579 3a7b 6e61 6d65 7d22 290a 2020 2020  ey:{name}").    
-00015fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fc0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00015fd0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00015fe0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016000: 666f 7220 6e61 6d65 2c20 7374 6570 2069  for name, step i
-00016010: 6e20 7374 6570 732e 6974 656d 7328 290a  n steps.items().
-00016020: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00016030: 2020 2020 2020 2020 2020 2320 5374 6172            # Star
-00016040: 7420 7468 6520 6669 7273 7420 6974 6572  t the first iter
-00016050: 6174 696f 6e20 6f66 2065 6163 6820 6765  ation of each ge
-00016060: 6e65 7261 746f 720a 2020 2020 2020 2020  nerator.        
-00016070: 2020 2020 6675 7475 7265 7320 3d20 7b0a      futures = {.
-00016080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016090: 6578 6563 7574 6f72 2e73 7562 6d69 7428  executor.submit(
-000160a0: 6e65 7874 2c20 6765 6e65 7261 746f 7229  next, generator)
-000160b0: 3a20 2873 7465 705f 6e61 6d65 2c20 6765  : (step_name, ge
-000160c0: 6e65 7261 746f 7229 0a20 2020 2020 2020  nerator).       
-000160d0: 2020 2020 2020 2020 2066 6f72 2073 7465           for ste
-000160e0: 705f 6e61 6d65 2c20 6765 6e65 7261 746f  p_name, generato
-000160f0: 7220 696e 206e 616d 6564 5f67 656e 6572  r in named_gener
-00016100: 6174 6f72 730a 2020 2020 2020 2020 2020  ators.          
-00016110: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00016120: 2320 5969 656c 6420 6368 756e 6b73 2066  # Yield chunks f
-00016130: 726f 6d20 6561 6368 2061 7320 7468 6579  rom each as they
-00016140: 2062 6563 6f6d 6520 6176 6169 6c61 626c   become availabl
-00016150: 652c 0a20 2020 2020 2020 2020 2020 2023  e,.            #
-00016160: 2061 6e64 2073 7461 7274 2074 6865 206e   and start the n
-00016170: 6578 7420 6974 6572 6174 696f 6e20 6f66  ext iteration of
-00016180: 2074 6861 7420 6765 6e65 7261 746f 7220   that generator 
-00016190: 7468 6174 2079 6965 6c64 6564 2069 742e  that yielded it.
-000161a0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-000161b0: 6865 6e20 616c 6c20 6765 6e65 7261 746f  hen all generato
-000161c0: 7273 2061 7265 2065 7868 6175 7374 6564  rs are exhausted
-000161d0: 2c20 7374 6f70 2e0a 2020 2020 2020 2020  , stop..        
-000161e0: 2020 2020 7768 696c 6520 6675 7475 7265      while future
-000161f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00016200: 2020 2063 6f6d 706c 6574 6564 5f66 7574     completed_fut
-00016210: 7572 6573 2c20 5f20 3d20 7761 6974 2866  ures, _ = wait(f
-00016220: 7574 7572 6573 2c20 7265 7475 726e 5f77  utures, return_w
-00016230: 6865 6e3d 4649 5253 545f 434f 4d50 4c45  hen=FIRST_COMPLE
-00016240: 5445 4429 0a20 2020 2020 2020 2020 2020  TED).           
-00016250: 2020 2020 2066 6f72 2066 7574 7572 6520       for future 
-00016260: 696e 2063 6f6d 706c 6574 6564 5f66 7574  in completed_fut
-00016270: 7572 6573 3a0a 2020 2020 2020 2020 2020  ures:.          
-00016280: 2020 2020 2020 2020 2020 2873 7465 705f            (step_
-00016290: 6e61 6d65 2c20 6765 6e65 7261 746f 7229  name, generator)
-000162a0: 203d 2066 7574 7572 6573 2e70 6f70 2866   = futures.pop(f
-000162b0: 7574 7572 6529 0a20 2020 2020 2020 2020  uture).         
-000162c0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-000162d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162e0: 2020 2020 2020 2020 6368 756e 6b20 3d20          chunk = 
-000162f0: 4164 6461 626c 6544 6963 7428 7b73 7465  AddableDict({ste
-00016300: 705f 6e61 6d65 3a20 6675 7475 7265 2e72  p_name: future.r
-00016310: 6573 756c 7428 297d 290a 2020 2020 2020  esult()}).      
-00016320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016330: 2020 7969 656c 6420 6368 756e 6b0a 2020    yield chunk.  
-00016340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016350: 2020 2020 2020 6675 7475 7265 735b 6578        futures[ex
-00016360: 6563 7574 6f72 2e73 7562 6d69 7428 6e65  ecutor.submit(ne
-00016370: 7874 2c20 6765 6e65 7261 746f 7229 5d20  xt, generator)] 
-00016380: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00016390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163a0: 7374 6570 5f6e 616d 652c 0a20 2020 2020  step_name,.     
-000163b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163c0: 2020 2020 2020 2067 656e 6572 6174 6f72         generator
-000163d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000163e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016400: 6578 6365 7074 2053 746f 7049 7465 7261  except StopItera
-00016410: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00016420: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00016430: 7373 0a0a 2020 2020 6465 6620 7472 616e  ss..    def tran
-00016440: 7366 6f72 6d28 0a20 2020 2020 2020 2073  sform(.        s
-00016450: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00016460: 7574 3a20 4974 6572 6174 6f72 5b49 6e70  ut: Iterator[Inp
-00016470: 7574 5d2c 0a20 2020 2020 2020 2063 6f6e  ut],.        con
-00016480: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-00016490: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
-000164a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-000164b0: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-000164c0: 2029 202d 3e20 4974 6572 6174 6f72 5b44   ) -> Iterator[D
-000164d0: 6963 745b 7374 722c 2041 6e79 5d5d 3a0a  ict[str, Any]]:.
-000164e0: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-000164f0: 6f6d 2073 656c 662e 5f74 7261 6e73 666f  om self._transfo
-00016500: 726d 5f73 7472 6561 6d5f 7769 7468 5f63  rm_stream_with_c
-00016510: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
-00016520: 2020 2069 6e70 7574 2c20 7365 6c66 2e5f     input, self._
-00016530: 7472 616e 7366 6f72 6d2c 2063 6f6e 6669  transform, confi
-00016540: 672c 202a 2a6b 7761 7267 730a 2020 2020  g, **kwargs.    
-00016550: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00016560: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00016570: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00016580: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00016590: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-000165a0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-000165b0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-000165c0: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-000165d0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-000165e0: 2029 202d 3e20 4974 6572 6174 6f72 5b44   ) -> Iterator[D
-000165f0: 6963 745b 7374 722c 2041 6e79 5d5d 3a0a  ict[str, Any]]:.
-00016600: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-00016610: 6f6d 2073 656c 662e 7472 616e 7366 6f72  om self.transfor
-00016620: 6d28 6974 6572 285b 696e 7075 745d 292c  m(iter([input]),
-00016630: 2063 6f6e 6669 6729 0a0a 2020 2020 6173   config)..    as
-00016640: 796e 6320 6465 6620 5f61 7472 616e 7366  ync def _atransf
-00016650: 6f72 6d28 0a20 2020 2020 2020 2073 656c  orm(.        sel
-00016660: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
-00016670: 3a20 4173 796e 6349 7465 7261 746f 725b  : AsyncIterator[
-00016680: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-00016690: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
-000166a0: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
-000166b0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-000166c0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-000166d0: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-000166e0: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
-000166f0: 6174 6f72 5b41 6464 6162 6c65 4469 6374  ator[AddableDict
-00016700: 5d3a 0a20 2020 2020 2020 2023 2053 6861  ]:.        # Sha
-00016710: 6c6c 6f77 2063 6f70 7920 7374 6570 7320  llow copy steps 
-00016720: 746f 2069 676e 6f72 6520 6d75 7461 7469  to ignore mutati
-00016730: 6f6e 7320 7768 696c 6520 696e 2070 726f  ons while in pro
-00016740: 6772 6573 730a 2020 2020 2020 2020 7374  gress.        st
-00016750: 6570 7320 3d20 6469 6374 2873 656c 662e  eps = dict(self.
-00016760: 7374 6570 7329 0a20 2020 2020 2020 2023  steps).        #
-00016770: 2045 6163 6820 7374 6570 2067 6574 7320   Each step gets 
-00016780: 6120 636f 7079 206f 6620 7468 6520 696e  a copy of the in
-00016790: 7075 7420 6974 6572 6174 6f72 2c0a 2020  put iterator,.  
-000167a0: 2020 2020 2020 2320 7768 6963 6820 6973        # which is
-000167b0: 2063 6f6e 7375 6d65 6420 696e 2070 6172   consumed in par
-000167c0: 616c 6c65 6c20 696e 2061 2073 6570 6172  allel in a separ
-000167d0: 6174 6520 7468 7265 6164 2e0a 2020 2020  ate thread..    
-000167e0: 2020 2020 696e 7075 745f 636f 7069 6573      input_copies
-000167f0: 203d 206c 6973 7428 6174 6565 2869 6e70   = list(atee(inp
-00016800: 7574 2c20 6c65 6e28 7374 6570 7329 2c20  ut, len(steps), 
-00016810: 6c6f 636b 3d61 7379 6e63 696f 2e4c 6f63  lock=asyncio.Loc
-00016820: 6b28 2929 290a 2020 2020 2020 2020 2320  k())).        # 
-00016830: 4372 6561 7465 2074 6865 2074 7261 6e73  Create the trans
-00016840: 666f 726d 2829 2067 656e 6572 6174 6f72  form() generator
-00016850: 2066 6f72 2065 6163 6820 7374 6570 0a20   for each step. 
-00016860: 2020 2020 2020 206e 616d 6564 5f67 656e         named_gen
-00016870: 6572 6174 6f72 7320 3d20 5b0a 2020 2020  erators = [.    
-00016880: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00016890: 2020 2020 2020 2020 2020 6e61 6d65 2c0a            name,.
-000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168b0: 7374 6570 2e61 7472 616e 7366 6f72 6d28  step.atransform(
-000168c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000168d0: 2020 2020 2069 6e70 7574 5f63 6f70 6965       input_copie
-000168e0: 732e 706f 7028 292c 0a20 2020 2020 2020  s.pop(),.       
-000168f0: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-00016900: 6368 5f63 6f6e 6669 6728 0a20 2020 2020  ch_config(.     
-00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016920: 2020 2063 6f6e 6669 672c 2063 616c 6c62     config, callb
-00016930: 6163 6b73 3d72 756e 5f6d 616e 6167 6572  acks=run_manager
-00016940: 2e67 6574 5f63 6869 6c64 2866 226d 6170  .get_child(f"map
-00016950: 3a6b 6579 3a7b 6e61 6d65 7d22 290a 2020  :key:{name}").  
-00016960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016970: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00016980: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00016990: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000169a0: 2020 666f 7220 6e61 6d65 2c20 7374 6570    for name, step
-000169b0: 2069 6e20 7374 6570 732e 6974 656d 7328   in steps.items(
-000169c0: 290a 2020 2020 2020 2020 5d0a 0a20 2020  ).        ]..   
-000169d0: 2020 2020 2023 2057 7261 7020 696e 2061       # Wrap in a
-000169e0: 2063 6f72 6f75 7469 6e65 2074 6f20 7361   coroutine to sa
-000169f0: 7469 7366 7920 6c69 6e74 6572 0a20 2020  tisfy linter.   
-00016a00: 2020 2020 2061 7379 6e63 2064 6566 2067       async def g
-00016a10: 6574 5f6e 6578 745f 6368 756e 6b28 6765  et_next_chunk(ge
-00016a20: 6e65 7261 746f 723a 2041 7379 6e63 4974  nerator: AsyncIt
-00016a30: 6572 6174 6f72 2920 2d3e 204f 7074 696f  erator) -> Optio
-00016a40: 6e61 6c5b 4f75 7470 7574 5d3a 0a20 2020  nal[Output]:.   
-00016a50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00016a60: 6177 6169 7420 7079 5f61 6e65 7874 2867  await py_anext(g
-00016a70: 656e 6572 6174 6f72 290a 0a20 2020 2020  enerator)..     
-00016a80: 2020 2023 2053 7461 7274 2074 6865 2066     # Start the f
-00016a90: 6972 7374 2069 7465 7261 7469 6f6e 206f  irst iteration o
-00016aa0: 6620 6561 6368 2067 656e 6572 6174 6f72  f each generator
-00016ab0: 0a20 2020 2020 2020 2074 6173 6b73 203d  .        tasks =
-00016ac0: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
-00016ad0: 7379 6e63 696f 2e63 7265 6174 655f 7461  syncio.create_ta
-00016ae0: 736b 2867 6574 5f6e 6578 745f 6368 756e  sk(get_next_chun
-00016af0: 6b28 6765 6e65 7261 746f 7229 293a 2028  k(generator)): (
-00016b00: 7374 6570 5f6e 616d 652c 2067 656e 6572  step_name, gener
-00016b10: 6174 6f72 290a 2020 2020 2020 2020 2020  ator).          
-00016b20: 2020 666f 7220 7374 6570 5f6e 616d 652c    for step_name,
-00016b30: 2067 656e 6572 6174 6f72 2069 6e20 6e61   generator in na
-00016b40: 6d65 645f 6765 6e65 7261 746f 7273 0a20  med_generators. 
-00016b50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00016b60: 2023 2059 6965 6c64 2063 6875 6e6b 7320   # Yield chunks 
-00016b70: 6672 6f6d 2065 6163 6820 6173 2074 6865  from each as the
-00016b80: 7920 6265 636f 6d65 2061 7661 696c 6162  y become availab
-00016b90: 6c65 2c0a 2020 2020 2020 2020 2320 616e  le,.        # an
-00016ba0: 6420 7374 6172 7420 7468 6520 6e65 7874  d start the next
-00016bb0: 2069 7465 7261 7469 6f6e 206f 6620 7468   iteration of th
-00016bc0: 6520 6765 6e65 7261 746f 7220 7468 6174  e generator that
-00016bd0: 2079 6965 6c64 6564 2069 742e 0a20 2020   yielded it..   
-00016be0: 2020 2020 2023 2057 6865 6e20 616c 6c20       # When all 
-00016bf0: 6765 6e65 7261 746f 7273 2061 7265 2065  generators are e
-00016c00: 7868 6175 7374 6564 2c20 7374 6f70 2e0a  xhausted, stop..
-00016c10: 2020 2020 2020 2020 7768 696c 6520 7461          while ta
-00016c20: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
-00016c30: 2063 6f6d 706c 6574 6564 5f74 6173 6b73   completed_tasks
-00016c40: 2c20 5f20 3d20 6177 6169 7420 6173 796e  , _ = await asyn
-00016c50: 6369 6f2e 7761 6974 280a 2020 2020 2020  cio.wait(.      
-00016c60: 2020 2020 2020 2020 2020 7461 736b 732c            tasks,
-00016c70: 2072 6574 7572 6e5f 7768 656e 3d61 7379   return_when=asy
-00016c80: 6e63 696f 2e46 4952 5354 5f43 4f4d 504c  ncio.FIRST_COMPL
-00016c90: 4554 4544 0a20 2020 2020 2020 2020 2020  ETED.           
-00016ca0: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
-00016cb0: 6f72 2074 6173 6b20 696e 2063 6f6d 706c  or task in compl
-00016cc0: 6574 6564 5f74 6173 6b73 3a0a 2020 2020  eted_tasks:.    
-00016cd0: 2020 2020 2020 2020 2020 2020 2873 7465              (ste
-00016ce0: 705f 6e61 6d65 2c20 6765 6e65 7261 746f  p_name, generato
-00016cf0: 7229 203d 2074 6173 6b73 2e70 6f70 2874  r) = tasks.pop(t
-00016d00: 6173 6b29 0a20 2020 2020 2020 2020 2020  ask).           
-00016d10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00016d20: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00016d30: 756e 6b20 3d20 4164 6461 626c 6544 6963  unk = AddableDic
-00016d40: 7428 7b73 7465 705f 6e61 6d65 3a20 7461  t({step_name: ta
-00016d50: 736b 2e72 6573 756c 7428 297d 290a 2020  sk.result()}).  
-00016d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d70: 2020 7969 656c 6420 6368 756e 6b0a 2020    yield chunk.  
-00016d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d90: 2020 6e65 775f 7461 736b 203d 2061 7379    new_task = asy
-00016da0: 6e63 696f 2e63 7265 6174 655f 7461 736b  ncio.create_task
-00016db0: 2867 6574 5f6e 6578 745f 6368 756e 6b28  (get_next_chunk(
-00016dc0: 6765 6e65 7261 746f 7229 290a 2020 2020  generator)).    
-00016dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016de0: 7461 736b 735b 6e65 775f 7461 736b 5d20  tasks[new_task] 
-00016df0: 3d20 2873 7465 705f 6e61 6d65 2c20 6765  = (step_name, ge
-00016e00: 6e65 7261 746f 7229 0a20 2020 2020 2020  nerator).       
-00016e10: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00016e20: 5374 6f70 4173 796e 6349 7465 7261 7469  StopAsyncIterati
-00016e30: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00016e40: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00016e50: 2020 6173 796e 6320 6465 6620 6174 7261    async def atra
-00016e60: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-00016e70: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-00016e80: 7075 743a 2041 7379 6e63 4974 6572 6174  put: AsyncIterat
-00016e90: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
-00016ea0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00016eb0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00016ec0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00016ed0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00016ee0: 792c 0a20 2020 2029 202d 3e20 4173 796e  y,.    ) -> Asyn
-00016ef0: 6349 7465 7261 746f 725b 4469 6374 5b73  cIterator[Dict[s
-00016f00: 7472 2c20 416e 795d 5d3a 0a20 2020 2020  tr, Any]]:.     
-00016f10: 2020 2061 7379 6e63 2066 6f72 2063 6875     async for chu
-00016f20: 6e6b 2069 6e20 7365 6c66 2e5f 6174 7261  nk in self._atra
-00016f30: 6e73 666f 726d 5f73 7472 6561 6d5f 7769  nsform_stream_wi
-00016f40: 7468 5f63 6f6e 6669 6728 0a20 2020 2020  th_config(.     
-00016f50: 2020 2020 2020 2069 6e70 7574 2c20 7365         input, se
-00016f60: 6c66 2e5f 6174 7261 6e73 666f 726d 2c20  lf._atransform, 
-00016f70: 636f 6e66 6967 2c20 2a2a 6b77 6172 6773  config, **kwargs
-00016f80: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
-00016f90: 2020 2020 2020 2020 7969 656c 6420 6368          yield ch
-00016fa0: 756e 6b0a 0a20 2020 2061 7379 6e63 2064  unk..    async d
-00016fb0: 6566 2061 7374 7265 616d 280a 2020 2020  ef astream(.    
-00016fc0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00016fd0: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
-00016fe0: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-00016ff0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-00017000: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
-00017010: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00017020: 733a 204f 7074 696f 6e61 6c5b 416e 795d  s: Optional[Any]
-00017030: 2c0a 2020 2020 2920 2d3e 2041 7379 6e63  ,.    ) -> Async
-00017040: 4974 6572 6174 6f72 5b44 6963 745b 7374  Iterator[Dict[st
-00017050: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
-00017060: 2020 6173 796e 6320 6465 6620 696e 7075    async def inpu
-00017070: 745f 6169 7465 7228 2920 2d3e 2041 7379  t_aiter() -> Asy
-00017080: 6e63 4974 6572 6174 6f72 5b49 6e70 7574  ncIterator[Input
-00017090: 5d3a 0a20 2020 2020 2020 2020 2020 2079  ]:.            y
-000170a0: 6965 6c64 2069 6e70 7574 0a0a 2020 2020  ield input..    
-000170b0: 2020 2020 6173 796e 6320 666f 7220 6368      async for ch
-000170c0: 756e 6b20 696e 2073 656c 662e 6174 7261  unk in self.atra
-000170d0: 6e73 666f 726d 2869 6e70 7574 5f61 6974  nsform(input_ait
-000170e0: 6572 2829 2c20 636f 6e66 6967 293a 0a20  er(), config):. 
-000170f0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00017100: 2063 6875 6e6b 0a0a 0a23 2057 6520 7375   chunk...# We su
-00017110: 7070 6f72 7420 626f 7468 206e 616d 6573  pport both names
-00017120: 0a52 756e 6e61 626c 654d 6170 203d 2052  .RunnableMap = R
-00017130: 756e 6e61 626c 6550 6172 616c 6c65 6c0a  unnableParallel.
-00017140: 0a0a 636c 6173 7320 5275 6e6e 6162 6c65  ..class Runnable
-00017150: 4765 6e65 7261 746f 7228 5275 6e6e 6162  Generator(Runnab
-00017160: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-00017170: 5d29 3a0a 2020 2020 2222 220a 2020 2020  ]):.    """.    
-00017180: 4120 7275 6e6e 6162 6c65 2074 6861 7420  A runnable that 
-00017190: 7275 6e73 2061 2067 656e 6572 6174 6f72  runs a generator
-000171a0: 2066 756e 6374 696f 6e2e 0a20 2020 2022   function..    "
-000171b0: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-000171c0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-000171d0: 6c66 2c0a 2020 2020 2020 2020 7472 616e  lf,.        tran
-000171e0: 7366 6f72 6d3a 2055 6e69 6f6e 5b0a 2020  sform: Union[.  
-000171f0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00017200: 6c65 5b5b 4974 6572 6174 6f72 5b49 6e70  le[[Iterator[Inp
-00017210: 7574 5d5d 2c20 4974 6572 6174 6f72 5b4f  ut]], Iterator[O
-00017220: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
-00017230: 2020 2020 2043 616c 6c61 626c 655b 5b41       Callable[[A
-00017240: 7379 6e63 4974 6572 6174 6f72 5b49 6e70  syncIterator[Inp
-00017250: 7574 5d5d 2c20 4173 796e 6349 7465 7261  ut]], AsyncItera
-00017260: 746f 725b 4f75 7470 7574 5d5d 2c0a 2020  tor[Output]],.  
-00017270: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00017280: 2061 7472 616e 7366 6f72 6d3a 204f 7074   atransform: Opt
-00017290: 696f 6e61 6c5b 0a20 2020 2020 2020 2020  ional[.         
-000172a0: 2020 2043 616c 6c61 626c 655b 5b41 7379     Callable[[Asy
-000172b0: 6e63 4974 6572 6174 6f72 5b49 6e70 7574  ncIterator[Input
-000172c0: 5d5d 2c20 4173 796e 6349 7465 7261 746f  ]], AsyncIterato
-000172d0: 725b 4f75 7470 7574 5d5d 0a20 2020 2020  r[Output]].     
-000172e0: 2020 205d 203d 204e 6f6e 652c 0a20 2020     ] = None,.   
-000172f0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00017300: 2020 2020 6966 2061 7472 616e 7366 6f72      if atransfor
-00017310: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
-00017320: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017330: 5f61 7472 616e 7366 6f72 6d20 3d20 6174  _atransform = at
-00017340: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
-00017350: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
-00017360: 6d65 3a20 4361 6c6c 6162 6c65 203d 2061  me: Callable = a
-00017370: 7472 616e 7366 6f72 6d0a 0a20 2020 2020  transform..     
-00017380: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
-00017390: 6173 796e 6367 656e 6675 6e63 7469 6f6e  asyncgenfunction
-000173a0: 2874 7261 6e73 666f 726d 293a 0a20 2020  (transform):.   
-000173b0: 2020 2020 2020 2020 2073 656c 662e 5f61           self._a
-000173c0: 7472 616e 7366 6f72 6d20 3d20 7472 616e  transform = tran
-000173d0: 7366 6f72 6d0a 2020 2020 2020 2020 2020  sform.          
-000173e0: 2020 6675 6e63 5f66 6f72 5f6e 616d 6520    func_for_name 
-000173f0: 3d20 7472 616e 7366 6f72 6d0a 2020 2020  = transform.    
-00017400: 2020 2020 656c 6966 2069 6e73 7065 6374      elif inspect
-00017410: 2e69 7367 656e 6572 6174 6f72 6675 6e63  .isgeneratorfunc
-00017420: 7469 6f6e 2874 7261 6e73 666f 726d 293a  tion(transform):
-00017430: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00017440: 662e 5f74 7261 6e73 666f 726d 203d 2074  f._transform = t
-00017450: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
-00017460: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
-00017470: 6d65 203d 2074 7261 6e73 666f 726d 0a20  me = transform. 
-00017480: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00017490: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-000174a0: 7970 6545 7272 6f72 280a 2020 2020 2020  ypeError(.      
-000174b0: 2020 2020 2020 2020 2020 2245 7870 6563            "Expec
-000174c0: 7465 6420 6120 6765 6e65 7261 746f 7220  ted a generator 
-000174d0: 6675 6e63 7469 6f6e 2074 7970 6520 666f  function type fo
-000174e0: 7220 6074 7261 6e73 666f 726d 602e 220a  r `transform`.".
+000159f0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00015a00: 7228 6622 5275 6e6e 6162 6c65 207b 7374  r(f"Runnable {st
+00015a10: 6570 7d20 6861 7320 6e6f 2066 6972 7374  ep} has no first
+00015a20: 206e 6f64 6522 290a 2020 2020 2020 2020   node").        
+00015a30: 2020 2020 6966 2063 7572 7265 6e74 5f6c      if current_l
+00015a40: 6173 745f 6e6f 6465 3a0a 2020 2020 2020  ast_node:.      
+00015a50: 2020 2020 2020 2020 2020 6772 6170 682e            graph.
+00015a60: 6164 645f 6564 6765 2863 7572 7265 6e74  add_edge(current
+00015a70: 5f6c 6173 745f 6e6f 6465 2c20 7374 6570  _last_node, step
+00015a80: 5f66 6972 7374 5f6e 6f64 6529 0a0a 2020  _first_node)..  
+00015a90: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
+00015aa0: 7068 0a0a 2020 2020 6465 6620 5f5f 7265  ph..    def __re
+00015ab0: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
+00015ac0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+00015ad0: 6e20 225c 6e7c 2022 2e6a 6f69 6e28 0a20  n "\n| ".join(. 
+00015ae0: 2020 2020 2020 2020 2020 2072 6570 7228             repr(
+00015af0: 7329 2069 6620 6920 3d3d 2030 2065 6c73  s) if i == 0 els
+00015b00: 6520 696e 6465 6e74 5f6c 696e 6573 5f61  e indent_lines_a
+00015b10: 6674 6572 5f66 6972 7374 2872 6570 7228  fter_first(repr(
+00015b20: 7329 2c20 227c 2022 290a 2020 2020 2020  s), "| ").      
+00015b30: 2020 2020 2020 666f 7220 692c 2073 2069        for i, s i
+00015b40: 6e20 656e 756d 6572 6174 6528 7365 6c66  n enumerate(self
+00015b50: 2e73 7465 7073 290a 2020 2020 2020 2020  .steps).        
+00015b60: 290a 0a20 2020 2064 6566 205f 5f6f 725f  )..    def __or_
+00015b70: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+00015b80: 0a20 2020 2020 2020 206f 7468 6572 3a20  .        other: 
+00015b90: 556e 696f 6e5b 0a20 2020 2020 2020 2020  Union[.         
+00015ba0: 2020 2052 756e 6e61 626c 655b 416e 792c     Runnable[Any,
+00015bb0: 204f 7468 6572 5d2c 0a20 2020 2020 2020   Other],.       
+00015bc0: 2020 2020 2043 616c 6c61 626c 655b 5b41       Callable[[A
+00015bd0: 6e79 5d2c 204f 7468 6572 5d2c 0a20 2020  ny], Other],.   
+00015be0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
+00015bf0: 655b 5b49 7465 7261 746f 725b 416e 795d  e[[Iterator[Any]
+00015c00: 5d2c 2049 7465 7261 746f 725b 4f74 6865  ], Iterator[Othe
+00015c10: 725d 5d2c 0a20 2020 2020 2020 2020 2020  r]],.           
+00015c20: 204d 6170 7069 6e67 5b73 7472 2c20 556e   Mapping[str, Un
+00015c30: 696f 6e5b 5275 6e6e 6162 6c65 5b41 6e79  ion[Runnable[Any
+00015c40: 2c20 4f74 6865 725d 2c20 4361 6c6c 6162  , Other], Callab
+00015c50: 6c65 5b5b 416e 795d 2c20 4f74 6865 725d  le[[Any], Other]
+00015c60: 2c20 416e 795d 5d2c 0a20 2020 2020 2020  , Any]],.       
+00015c70: 205d 2c0a 2020 2020 2920 2d3e 2052 756e   ],.    ) -> Run
+00015c80: 6e61 626c 6553 6572 6961 6c69 7a61 626c  nableSerializabl
+00015c90: 655b 496e 7075 742c 204f 7468 6572 5d3a  e[Input, Other]:
+00015ca0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00015cb0: 7374 616e 6365 286f 7468 6572 2c20 5275  stance(other, Ru
+00015cc0: 6e6e 6162 6c65 5365 7175 656e 6365 293a  nnableSequence):
+00015cd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00015ce0: 7572 6e20 5275 6e6e 6162 6c65 5365 7175  urn RunnableSequ
+00015cf0: 656e 6365 280a 2020 2020 2020 2020 2020  ence(.          
+00015d00: 2020 2020 2020 7365 6c66 2e66 6972 7374        self.first
+00015d10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015d20: 2020 2a73 656c 662e 6d69 6464 6c65 2c0a    *self.middle,.
+00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d40: 7365 6c66 2e6c 6173 742c 0a20 2020 2020  self.last,.     
+00015d50: 2020 2020 2020 2020 2020 206f 7468 6572             other
+00015d60: 2e66 6972 7374 2c0a 2020 2020 2020 2020  .first,.        
+00015d70: 2020 2020 2020 2020 2a6f 7468 6572 2e6d          *other.m
+00015d80: 6964 646c 652c 0a20 2020 2020 2020 2020  iddle,.         
+00015d90: 2020 2020 2020 206f 7468 6572 2e6c 6173         other.las
+00015da0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00015db0: 2020 206e 616d 653d 7365 6c66 2e6e 616d     name=self.nam
+00015dc0: 6520 6f72 206f 7468 6572 2e6e 616d 652c  e or other.name,
+00015dd0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00015de0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00015df0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00015e00: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+00015e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00015e20: 2020 7365 6c66 2e66 6972 7374 2c0a 2020    self.first,.  
+00015e30: 2020 2020 2020 2020 2020 2020 2020 2a73                *s
+00015e40: 656c 662e 6d69 6464 6c65 2c0a 2020 2020  elf.middle,.    
+00015e50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015e60: 2e6c 6173 742c 0a20 2020 2020 2020 2020  .last,.         
+00015e70: 2020 2020 2020 2063 6f65 7263 655f 746f         coerce_to
+00015e80: 5f72 756e 6e61 626c 6528 6f74 6865 7229  _runnable(other)
+00015e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00015ea0: 2020 6e61 6d65 3d73 656c 662e 6e61 6d65    name=self.name
+00015eb0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00015ec0: 0a20 2020 2064 6566 205f 5f72 6f72 5f5f  .    def __ror__
+00015ed0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00015ee0: 2020 2020 2020 2020 6f74 6865 723a 2055          other: U
+00015ef0: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
+00015f00: 2020 5275 6e6e 6162 6c65 5b4f 7468 6572    Runnable[Other
+00015f10: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
+00015f20: 2020 2020 4361 6c6c 6162 6c65 5b5b 4f74      Callable[[Ot
+00015f30: 6865 725d 2c20 416e 795d 2c0a 2020 2020  her], Any],.    
+00015f40: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00015f50: 5b5b 4974 6572 6174 6f72 5b4f 7468 6572  [[Iterator[Other
+00015f60: 5d5d 2c20 4974 6572 6174 6f72 5b41 6e79  ]], Iterator[Any
+00015f70: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
+00015f80: 4d61 7070 696e 675b 7374 722c 2055 6e69  Mapping[str, Uni
+00015f90: 6f6e 5b52 756e 6e61 626c 655b 4f74 6865  on[Runnable[Othe
+00015fa0: 722c 2041 6e79 5d2c 2043 616c 6c61 626c  r, Any], Callabl
+00015fb0: 655b 5b4f 7468 6572 5d2c 2041 6e79 5d2c  e[[Other], Any],
+00015fc0: 2041 6e79 5d5d 2c0a 2020 2020 2020 2020   Any]],.        
+00015fd0: 5d2c 0a20 2020 2029 202d 3e20 5275 6e6e  ],.    ) -> Runn
+00015fe0: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
+00015ff0: 5b4f 7468 6572 2c20 4f75 7470 7574 5d3a  [Other, Output]:
+00016000: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00016010: 7374 616e 6365 286f 7468 6572 2c20 5275  stance(other, Ru
+00016020: 6e6e 6162 6c65 5365 7175 656e 6365 293a  nnableSequence):
+00016030: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00016040: 7572 6e20 5275 6e6e 6162 6c65 5365 7175  urn RunnableSequ
+00016050: 656e 6365 280a 2020 2020 2020 2020 2020  ence(.          
+00016060: 2020 2020 2020 6f74 6865 722e 6669 7273        other.firs
+00016070: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00016080: 2020 202a 6f74 6865 722e 6d69 6464 6c65     *other.middle
+00016090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000160a0: 2020 6f74 6865 722e 6c61 7374 2c0a 2020    other.last,.  
+000160b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000160c0: 6c66 2e66 6972 7374 2c0a 2020 2020 2020  lf.first,.      
+000160d0: 2020 2020 2020 2020 2020 2a73 656c 662e            *self.
+000160e0: 6d69 6464 6c65 2c0a 2020 2020 2020 2020  middle,.        
+000160f0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
+00016100: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00016110: 2020 206e 616d 653d 6f74 6865 722e 6e61     name=other.na
+00016120: 6d65 206f 7220 7365 6c66 2e6e 616d 652c  me or self.name,
+00016130: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00016140: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00016150: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00016160: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+00016170: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016180: 2020 636f 6572 6365 5f74 6f5f 7275 6e6e    coerce_to_runn
+00016190: 6162 6c65 286f 7468 6572 292c 0a20 2020  able(other),.   
+000161a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000161b0: 662e 6669 7273 742c 0a20 2020 2020 2020  f.first,.       
+000161c0: 2020 2020 2020 2020 202a 7365 6c66 2e6d           *self.m
+000161d0: 6964 646c 652c 0a20 2020 2020 2020 2020  iddle,.         
+000161e0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+000161f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016200: 2020 6e61 6d65 3d73 656c 662e 6e61 6d65    name=self.name
+00016210: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00016220: 0a20 2020 2064 6566 2069 6e76 6f6b 6528  .    def invoke(
+00016230: 7365 6c66 2c20 696e 7075 743a 2049 6e70  self, input: Inp
+00016240: 7574 2c20 636f 6e66 6967 3a20 4f70 7469  ut, config: Opti
+00016250: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00016260: 6669 675d 203d 204e 6f6e 6529 202d 3e20  fig] = None) -> 
+00016270: 4f75 7470 7574 3a0a 2020 2020 2020 2020  Output:.        
+00016280: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+00016290: 6f72 652e 6265 7461 2e72 756e 6e61 626c  ore.beta.runnabl
+000162a0: 6573 2e63 6f6e 7465 7874 2069 6d70 6f72  es.context impor
+000162b0: 7420 636f 6e66 6967 5f77 6974 685f 636f  t config_with_co
+000162c0: 6e74 6578 740a 0a20 2020 2020 2020 2023  ntext..        #
+000162d0: 2073 6574 7570 2063 616c 6c62 6163 6b73   setup callbacks
+000162e0: 2061 6e64 2063 6f6e 7465 7874 0a20 2020   and context.   
+000162f0: 2020 2020 2063 6f6e 6669 6720 3d20 636f       config = co
+00016300: 6e66 6967 5f77 6974 685f 636f 6e74 6578  nfig_with_contex
+00016310: 7428 656e 7375 7265 5f63 6f6e 6669 6728  t(ensure_config(
+00016320: 636f 6e66 6967 292c 2073 656c 662e 7374  config), self.st
+00016330: 6570 7329 0a20 2020 2020 2020 2063 616c  eps).        cal
+00016340: 6c62 6163 6b5f 6d61 6e61 6765 7220 3d20  lback_manager = 
+00016350: 6765 745f 6361 6c6c 6261 636b 5f6d 616e  get_callback_man
+00016360: 6167 6572 5f66 6f72 5f63 6f6e 6669 6728  ager_for_config(
+00016370: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+00016380: 2320 7374 6172 7420 7468 6520 726f 6f74  # start the root
+00016390: 2072 756e 0a20 2020 2020 2020 2072 756e   run.        run
+000163a0: 5f6d 616e 6167 6572 203d 2063 616c 6c62  _manager = callb
+000163b0: 6163 6b5f 6d61 6e61 6765 722e 6f6e 5f63  ack_manager.on_c
+000163c0: 6861 696e 5f73 7461 7274 280a 2020 2020  hain_start(.    
+000163d0: 2020 2020 2020 2020 6475 6d70 6428 7365          dumpd(se
+000163e0: 6c66 292c 0a20 2020 2020 2020 2020 2020  lf),.           
+000163f0: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
+00016400: 2020 2020 6e61 6d65 3d63 6f6e 6669 672e      name=config.
+00016410: 6765 7428 2272 756e 5f6e 616d 6522 2920  get("run_name") 
+00016420: 6f72 2073 656c 662e 6765 745f 6e61 6d65  or self.get_name
+00016430: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00016440: 7275 6e5f 6964 3d63 6f6e 6669 672e 706f  run_id=config.po
+00016450: 7028 2272 756e 5f69 6422 2c20 4e6f 6e65  p("run_id", None
+00016460: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+00016470: 2020 2020 2020 2320 696e 766f 6b65 2061        # invoke a
+00016480: 6c6c 2073 7465 7073 2069 6e20 7365 7175  ll steps in sequ
+00016490: 656e 6365 0a20 2020 2020 2020 2074 7279  ence.        try
+000164a0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+000164b0: 7220 692c 2073 7465 7020 696e 2065 6e75  r i, step in enu
+000164c0: 6d65 7261 7465 2873 656c 662e 7374 6570  merate(self.step
+000164d0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+000164e0: 2020 2020 696e 7075 7420 3d20 7374 6570      input = step
+000164f0: 2e69 6e76 6f6b 6528 0a20 2020 2020 2020  .invoke(.       
+00016500: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00016510: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00016520: 2020 2020 2020 2020 2320 6d61 726b 2065          # mark e
+00016530: 6163 6820 7374 6570 2061 7320 6120 6368  ach step as a ch
+00016540: 696c 6420 7275 6e0a 2020 2020 2020 2020  ild run.        
+00016550: 2020 2020 2020 2020 2020 2020 7061 7463              patc
+00016560: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
+00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016580: 2020 636f 6e66 6967 2c20 6361 6c6c 6261    config, callba
+00016590: 636b 733d 7275 6e5f 6d61 6e61 6765 722e  cks=run_manager.
+000165a0: 6765 745f 6368 696c 6428 6622 7365 713a  get_child(f"seq:
+000165b0: 7374 6570 3a7b 692b 317d 2229 0a20 2020  step:{i+1}").   
+000165c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165d0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+000165e0: 2020 2020 290a 2020 2020 2020 2020 2320      ).        # 
+000165f0: 6669 6e69 7368 2074 6865 2072 6f6f 7420  finish the root 
+00016600: 7275 6e0a 2020 2020 2020 2020 6578 6365  run.        exce
+00016610: 7074 2042 6173 6545 7863 6570 7469 6f6e  pt BaseException
+00016620: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00016630: 2020 2072 756e 5f6d 616e 6167 6572 2e6f     run_manager.o
+00016640: 6e5f 6368 6169 6e5f 6572 726f 7228 6529  n_chain_error(e)
+00016650: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00016660: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
+00016670: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+00016680: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
+00016690: 6e5f 656e 6428 696e 7075 7429 0a20 2020  n_end(input).   
+000166a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000166b0: 6361 7374 284f 7574 7075 742c 2069 6e70  cast(Output, inp
+000166c0: 7574 290a 0a20 2020 2061 7379 6e63 2064  ut)..    async d
+000166d0: 6566 2061 696e 766f 6b65 280a 2020 2020  ef ainvoke(.    
+000166e0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000166f0: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
+00016700: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+00016710: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+00016720: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
+00016730: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00016740: 733a 204f 7074 696f 6e61 6c5b 416e 795d  s: Optional[Any]
+00016750: 2c0a 2020 2020 2920 2d3e 204f 7574 7075  ,.    ) -> Outpu
+00016760: 743a 0a20 2020 2020 2020 2066 726f 6d20  t:.        from 
+00016770: 6c61 6e67 6368 6169 6e5f 636f 7265 2e62  langchain_core.b
+00016780: 6574 612e 7275 6e6e 6162 6c65 732e 636f  eta.runnables.co
+00016790: 6e74 6578 7420 696d 706f 7274 2061 636f  ntext import aco
+000167a0: 6e66 6967 5f77 6974 685f 636f 6e74 6578  nfig_with_contex
+000167b0: 740a 0a20 2020 2020 2020 2023 2073 6574  t..        # set
+000167c0: 7570 2063 616c 6c62 6163 6b73 2061 6e64  up callbacks and
+000167d0: 2063 6f6e 7465 7874 0a20 2020 2020 2020   context.       
+000167e0: 2063 6f6e 6669 6720 3d20 6163 6f6e 6669   config = aconfi
+000167f0: 675f 7769 7468 5f63 6f6e 7465 7874 2865  g_with_context(e
+00016800: 6e73 7572 655f 636f 6e66 6967 2863 6f6e  nsure_config(con
+00016810: 6669 6729 2c20 7365 6c66 2e73 7465 7073  fig), self.steps
+00016820: 290a 2020 2020 2020 2020 6361 6c6c 6261  ).        callba
+00016830: 636b 5f6d 616e 6167 6572 203d 2067 6574  ck_manager = get
+00016840: 5f61 7379 6e63 5f63 616c 6c62 6163 6b5f  _async_callback_
+00016850: 6d61 6e61 6765 725f 666f 725f 636f 6e66  manager_for_conf
+00016860: 6967 2863 6f6e 6669 6729 0a20 2020 2020  ig(config).     
+00016870: 2020 2023 2073 7461 7274 2074 6865 2072     # start the r
+00016880: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
+00016890: 7275 6e5f 6d61 6e61 6765 7220 3d20 6177  run_manager = aw
+000168a0: 6169 7420 6361 6c6c 6261 636b 5f6d 616e  ait callback_man
+000168b0: 6167 6572 2e6f 6e5f 6368 6169 6e5f 7374  ager.on_chain_st
+000168c0: 6172 7428 0a20 2020 2020 2020 2020 2020  art(.           
+000168d0: 2064 756d 7064 2873 656c 6629 2c0a 2020   dumpd(self),.  
+000168e0: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+000168f0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00016900: 653d 636f 6e66 6967 2e67 6574 2822 7275  e=config.get("ru
+00016910: 6e5f 6e61 6d65 2229 206f 7220 7365 6c66  n_name") or self
+00016920: 2e67 6574 5f6e 616d 6528 292c 0a20 2020  .get_name(),.   
+00016930: 2020 2020 2020 2020 2072 756e 5f69 643d           run_id=
+00016940: 636f 6e66 6967 2e70 6f70 2822 7275 6e5f  config.pop("run_
+00016950: 6964 222c 204e 6f6e 6529 2c0a 2020 2020  id", None),.    
+00016960: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00016970: 2069 6e76 6f6b 6520 616c 6c20 7374 6570   invoke all step
+00016980: 7320 696e 2073 6571 7565 6e63 650a 2020  s in sequence.  
+00016990: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000169a0: 2020 2020 2020 2066 6f72 2069 2c20 7374         for i, st
+000169b0: 6570 2069 6e20 656e 756d 6572 6174 6528  ep in enumerate(
+000169c0: 7365 6c66 2e73 7465 7073 293a 0a20 2020  self.steps):.   
+000169d0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+000169e0: 7574 203d 2061 7761 6974 2073 7465 702e  ut = await step.
+000169f0: 6169 6e76 6f6b 6528 0a20 2020 2020 2020  ainvoke(.       
+00016a00: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00016a10: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00016a20: 2020 2020 2020 2020 2320 6d61 726b 2065          # mark e
+00016a30: 6163 6820 7374 6570 2061 7320 6120 6368  ach step as a ch
+00016a40: 696c 6420 7275 6e0a 2020 2020 2020 2020  ild run.        
+00016a50: 2020 2020 2020 2020 2020 2020 7061 7463              patc
+00016a60: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
+00016a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a80: 2020 636f 6e66 6967 2c20 6361 6c6c 6261    config, callba
+00016a90: 636b 733d 7275 6e5f 6d61 6e61 6765 722e  cks=run_manager.
+00016aa0: 6765 745f 6368 696c 6428 6622 7365 713a  get_child(f"seq:
+00016ab0: 7374 6570 3a7b 692b 317d 2229 0a20 2020  step:{i+1}").   
+00016ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ad0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00016ae0: 2020 2020 290a 2020 2020 2020 2020 2320      ).        # 
+00016af0: 6669 6e69 7368 2074 6865 2072 6f6f 7420  finish the root 
+00016b00: 7275 6e0a 2020 2020 2020 2020 6578 6365  run.        exce
+00016b10: 7074 2042 6173 6545 7863 6570 7469 6f6e  pt BaseException
+00016b20: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00016b30: 2020 2061 7761 6974 2072 756e 5f6d 616e     await run_man
+00016b40: 6167 6572 2e6f 6e5f 6368 6169 6e5f 6572  ager.on_chain_er
+00016b50: 726f 7228 6529 0a20 2020 2020 2020 2020  ror(e).         
+00016b60: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
+00016b70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00016b80: 2020 2061 7761 6974 2072 756e 5f6d 616e     await run_man
+00016b90: 6167 6572 2e6f 6e5f 6368 6169 6e5f 656e  ager.on_chain_en
+00016ba0: 6428 696e 7075 7429 0a20 2020 2020 2020  d(input).       
+00016bb0: 2020 2020 2072 6574 7572 6e20 6361 7374       return cast
+00016bc0: 284f 7574 7075 742c 2069 6e70 7574 290a  (Output, input).
+00016bd0: 0a20 2020 2064 6566 2062 6174 6368 280a  .    def batch(.
+00016be0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00016bf0: 2020 2020 2020 696e 7075 7473 3a20 4c69        inputs: Li
+00016c00: 7374 5b49 6e70 7574 5d2c 0a20 2020 2020  st[Input],.     
+00016c10: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+00016c20: 6e61 6c5b 556e 696f 6e5b 5275 6e6e 6162  nal[Union[Runnab
+00016c30: 6c65 436f 6e66 6967 2c20 4c69 7374 5b52  leConfig, List[R
+00016c40: 756e 6e61 626c 6543 6f6e 6669 675d 5d5d  unnableConfig]]]
+00016c50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00016c60: 202a 2c0a 2020 2020 2020 2020 7265 7475   *,.        retu
+00016c70: 726e 5f65 7863 6570 7469 6f6e 733a 2062  rn_exceptions: b
+00016c80: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00016c90: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+00016ca0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+00016cb0: 2020 2920 2d3e 204c 6973 745b 4f75 7470    ) -> List[Outp
+00016cc0: 7574 5d3a 0a20 2020 2020 2020 2066 726f  ut]:.        fro
+00016cd0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+00016ce0: 2e62 6574 612e 7275 6e6e 6162 6c65 732e  .beta.runnables.
+00016cf0: 636f 6e74 6578 7420 696d 706f 7274 2063  context import c
+00016d00: 6f6e 6669 675f 7769 7468 5f63 6f6e 7465  onfig_with_conte
+00016d10: 7874 0a20 2020 2020 2020 2066 726f 6d20  xt.        from 
+00016d20: 6c61 6e67 6368 6169 6e5f 636f 7265 2e63  langchain_core.c
+00016d30: 616c 6c62 6163 6b73 2e6d 616e 6167 6572  allbacks.manager
+00016d40: 2069 6d70 6f72 7420 4361 6c6c 6261 636b   import Callback
+00016d50: 4d61 6e61 6765 720a 0a20 2020 2020 2020  Manager..       
+00016d60: 2069 6620 6e6f 7420 696e 7075 7473 3a0a   if not inputs:.
+00016d70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00016d80: 726e 205b 5d0a 0a20 2020 2020 2020 2023  rn []..        #
+00016d90: 2073 6574 7570 2063 616c 6c62 6163 6b73   setup callbacks
+00016da0: 2061 6e64 2063 6f6e 7465 7874 0a20 2020   and context.   
+00016db0: 2020 2020 2063 6f6e 6669 6773 203d 205b       configs = [
+00016dc0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00016dd0: 6669 675f 7769 7468 5f63 6f6e 7465 7874  fig_with_context
+00016de0: 2863 2c20 7365 6c66 2e73 7465 7073 290a  (c, self.steps).
+00016df0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00016e00: 6320 696e 2067 6574 5f63 6f6e 6669 675f  c in get_config_
+00016e10: 6c69 7374 2863 6f6e 6669 672c 206c 656e  list(config, len
+00016e20: 2869 6e70 7574 7329 290a 2020 2020 2020  (inputs)).      
+00016e30: 2020 5d0a 2020 2020 2020 2020 6361 6c6c    ].        call
+00016e40: 6261 636b 5f6d 616e 6167 6572 7320 3d20  back_managers = 
+00016e50: 5b0a 2020 2020 2020 2020 2020 2020 4361  [.            Ca
+00016e60: 6c6c 6261 636b 4d61 6e61 6765 722e 636f  llbackManager.co
+00016e70: 6e66 6967 7572 6528 0a20 2020 2020 2020  nfigure(.       
+00016e80: 2020 2020 2020 2020 2069 6e68 6572 6974           inherit
+00016e90: 6162 6c65 5f63 616c 6c62 6163 6b73 3d63  able_callbacks=c
+00016ea0: 6f6e 6669 672e 6765 7428 2263 616c 6c62  onfig.get("callb
+00016eb0: 6163 6b73 2229 2c0a 2020 2020 2020 2020  acks"),.        
+00016ec0: 2020 2020 2020 2020 6c6f 6361 6c5f 6361          local_ca
+00016ed0: 6c6c 6261 636b 733d 4e6f 6e65 2c0a 2020  llbacks=None,.  
+00016ee0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00016ef0: 7262 6f73 653d 4661 6c73 652c 0a20 2020  rbose=False,.   
+00016f00: 2020 2020 2020 2020 2020 2020 2069 6e68               inh
+00016f10: 6572 6974 6162 6c65 5f74 6167 733d 636f  eritable_tags=co
+00016f20: 6e66 6967 2e67 6574 2822 7461 6773 2229  nfig.get("tags")
+00016f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016f40: 2020 6c6f 6361 6c5f 7461 6773 3d4e 6f6e    local_tags=Non
+00016f50: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00016f60: 2020 2069 6e68 6572 6974 6162 6c65 5f6d     inheritable_m
+00016f70: 6574 6164 6174 613d 636f 6e66 6967 2e67  etadata=config.g
+00016f80: 6574 2822 6d65 7461 6461 7461 2229 2c0a  et("metadata"),.
+00016f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fa0: 6c6f 6361 6c5f 6d65 7461 6461 7461 3d4e  local_metadata=N
+00016fb0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00016fc0: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
+00016fd0: 6f72 2063 6f6e 6669 6720 696e 2063 6f6e  or config in con
+00016fe0: 6669 6773 0a20 2020 2020 2020 205d 0a20  figs.        ]. 
+00016ff0: 2020 2020 2020 2023 2073 7461 7274 2074         # start t
+00017000: 6865 2072 6f6f 7420 7275 6e73 2c20 6f6e  he root runs, on
+00017010: 6520 7065 7220 696e 7075 740a 2020 2020  e per input.    
+00017020: 2020 2020 7275 6e5f 6d61 6e61 6765 7273      run_managers
+00017030: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00017040: 2063 6d2e 6f6e 5f63 6861 696e 5f73 7461   cm.on_chain_sta
+00017050: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
+00017060: 2020 2020 6475 6d70 6428 7365 6c66 292c      dumpd(self),
+00017070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017080: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
+00017090: 2020 2020 2020 2020 6e61 6d65 3d63 6f6e          name=con
+000170a0: 6669 672e 6765 7428 2272 756e 5f6e 616d  fig.get("run_nam
+000170b0: 6522 2920 6f72 2073 656c 662e 6765 745f  e") or self.get_
+000170c0: 6e61 6d65 2829 2c0a 2020 2020 2020 2020  name(),.        
+000170d0: 2020 2020 2020 2020 7275 6e5f 6964 3d63          run_id=c
+000170e0: 6f6e 6669 672e 706f 7028 2272 756e 5f69  onfig.pop("run_i
+000170f0: 6422 2c20 4e6f 6e65 292c 0a20 2020 2020  d", None),.     
+00017100: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00017110: 2020 2020 2066 6f72 2063 6d2c 2069 6e70       for cm, inp
+00017120: 7574 2c20 636f 6e66 6967 2069 6e20 7a69  ut, config in zi
+00017130: 7028 6361 6c6c 6261 636b 5f6d 616e 6167  p(callback_manag
+00017140: 6572 732c 2069 6e70 7574 732c 2063 6f6e  ers, inputs, con
+00017150: 6669 6773 290a 2020 2020 2020 2020 5d0a  figs).        ].
+00017160: 0a20 2020 2020 2020 2023 2069 6e76 6f6b  .        # invok
+00017170: 650a 2020 2020 2020 2020 7472 793a 0a20  e.        try:. 
+00017180: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+00017190: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+000171a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000171b0: 2023 2054 7261 636b 2077 6869 6368 2069   # Track which i
+000171c0: 6e70 7574 7320 2862 7920 696e 6465 7829  nputs (by index)
+000171d0: 2066 6169 6c65 6420 736f 2066 6172 0a20   failed so far. 
+000171e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000171f0: 2049 6620 616e 2069 6e70 7574 2068 6173   If an input has
+00017200: 2066 6169 6c65 6420 6974 2077 696c 6c20   failed it will 
+00017210: 6265 2070 7265 7365 6e74 2069 6e20 7468  be present in th
+00017220: 6973 206d 6170 2c0a 2020 2020 2020 2020  is map,.        
+00017230: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
+00017240: 6520 7661 6c75 6520 7769 6c6c 2062 6520  e value will be 
+00017250: 7468 6520 6578 6365 7074 696f 6e20 7468  the exception th
+00017260: 6174 2077 6173 2072 6169 7365 642e 0a20  at was raised.. 
+00017270: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017280: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
+00017290: 3a20 4469 6374 5b69 6e74 2c20 4578 6365  : Dict[int, Exce
+000172a0: 7074 696f 6e5d 203d 207b 7d0a 2020 2020  ption] = {}.    
+000172b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000172c0: 7374 6570 6964 782c 2073 7465 7020 696e  stepidx, step in
+000172d0: 2065 6e75 6d65 7261 7465 2873 656c 662e   enumerate(self.
+000172e0: 7374 6570 7329 3a0a 2020 2020 2020 2020  steps):.        
+000172f0: 2020 2020 2020 2020 2020 2020 2320 4173              # As
+00017300: 7365 6d62 6c65 2074 6865 206f 7269 6769  semble the origi
+00017310: 6e61 6c20 696e 6465 7865 7320 6f66 2074  nal indexes of t
+00017320: 6865 2072 656d 6169 6e69 6e67 2069 6e70  he remaining inp
+00017330: 7574 730a 2020 2020 2020 2020 2020 2020  uts.            
+00017340: 2020 2020 2020 2020 2320 2869 2e65 2e20          # (i.e. 
+00017350: 7468 6520 6f6e 6573 2074 6861 7420 6861  the ones that ha
+00017360: 7665 6e27 7420 6661 696c 6564 2079 6574  ven't failed yet
+00017370: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00017380: 2020 2020 2020 7265 6d61 696e 696e 675f        remaining_
+00017390: 6964 7873 203d 205b 0a20 2020 2020 2020  idxs = [.       
+000173a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173b0: 2069 2066 6f72 2069 2069 6e20 7261 6e67   i for i in rang
+000173c0: 6528 6c65 6e28 636f 6e66 6967 7329 2920  e(len(configs)) 
+000173d0: 6966 2069 206e 6f74 2069 6e20 6661 696c  if i not in fail
+000173e0: 6564 5f69 6e70 7574 735f 6d61 700a 2020  ed_inputs_map.  
+000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017400: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00017410: 2020 2020 2020 2020 2320 496e 766f 6b65          # Invoke
+00017420: 2074 6865 2073 7465 7020 6f6e 2074 6865   the step on the
+00017430: 2072 656d 6169 6e69 6e67 2069 6e70 7574   remaining input
+00017440: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00017450: 2020 2020 2020 696e 7075 7473 203d 2073        inputs = s
+00017460: 7465 702e 6261 7463 6828 0a20 2020 2020  tep.batch(.     
+00017470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017480: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00017490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174a0: 2069 6e70 0a20 2020 2020 2020 2020 2020   inp.           
+000174b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174c0: 2066 6f72 2069 2c20 696e 7020 696e 207a   for i, inp in z
+000174d0: 6970 2872 656d 6169 6e69 6e67 5f69 6478  ip(remaining_idx
+000174e0: 732c 2069 6e70 7574 7329 0a20 2020 2020  s, inputs).     
 000174f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017500: 6622 496e 7374 6561 6420 676f 7420 616e  f"Instead got an
-00017510: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-00017520: 653a 207b 7479 7065 2874 7261 6e73 666f  e: {type(transfo
-00017530: 726d 297d 220a 2020 2020 2020 2020 2020  rm)}".          
-00017540: 2020 290a 0a20 2020 2020 2020 2074 7279    )..        try
-00017550: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00017560: 6c66 2e6e 616d 6520 3d20 6675 6e63 5f66  lf.name = func_f
-00017570: 6f72 5f6e 616d 652e 5f5f 6e61 6d65 5f5f  or_name.__name__
-00017580: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00017590: 4174 7472 6962 7574 6545 7272 6f72 3a0a  AttributeError:.
-000175a0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-000175b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000175c0: 2020 2020 6465 6620 496e 7075 7454 7970      def InputTyp
-000175d0: 6528 7365 6c66 2920 2d3e 2041 6e79 3a0a  e(self) -> Any:.
-000175e0: 2020 2020 2020 2020 6675 6e63 203d 2067          func = g
-000175f0: 6574 6174 7472 2873 656c 662c 2022 5f74  etattr(self, "_t
-00017600: 7261 6e73 666f 726d 222c 204e 6f6e 6529  ransform", None)
-00017610: 206f 7220 6765 7461 7474 7228 7365 6c66   or getattr(self
-00017620: 2c20 225f 6174 7261 6e73 666f 726d 2229  , "_atransform")
-00017630: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00017640: 2020 2020 2020 2020 2020 7061 7261 6d73            params
-00017650: 203d 2069 6e73 7065 6374 2e73 6967 6e61   = inspect.signa
-00017660: 7475 7265 2866 756e 6329 2e70 6172 616d  ture(func).param
-00017670: 6574 6572 730a 2020 2020 2020 2020 2020  eters.          
-00017680: 2020 6669 7273 745f 7061 7261 6d20 3d20    first_param = 
-00017690: 6e65 7874 2869 7465 7228 7061 7261 6d73  next(iter(params
-000176a0: 2e76 616c 7565 7328 2929 2c20 4e6f 6e65  .values()), None
-000176b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000176c0: 2066 6972 7374 5f70 6172 616d 2061 6e64   first_param and
-000176d0: 2066 6972 7374 5f70 6172 616d 2e61 6e6e   first_param.ann
-000176e0: 6f74 6174 696f 6e20 213d 2069 6e73 7065  otation != inspe
-000176f0: 6374 2e50 6172 616d 6574 6572 2e65 6d70  ct.Parameter.emp
-00017700: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00017710: 2020 2020 7265 7475 726e 2067 6574 6174      return getat
-00017720: 7472 2866 6972 7374 5f70 6172 616d 2e61  tr(first_param.a
-00017730: 6e6e 6f74 6174 696f 6e2c 2022 5f5f 6172  nnotation, "__ar
-00017740: 6773 5f5f 222c 2028 416e 792c 2929 5b30  gs__", (Any,))[0
-00017750: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-00017760: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017770: 2020 2020 7265 7475 726e 2041 6e79 0a20      return Any. 
-00017780: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
-00017790: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-000177a0: 2020 2020 2020 7265 7475 726e 2041 6e79        return Any
-000177b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000177c0: 2020 2020 6465 6620 4f75 7470 7574 5479      def OutputTy
-000177d0: 7065 2873 656c 6629 202d 3e20 416e 793a  pe(self) -> Any:
-000177e0: 0a20 2020 2020 2020 2066 756e 6320 3d20  .        func = 
-000177f0: 6765 7461 7474 7228 7365 6c66 2c20 225f  getattr(self, "_
-00017800: 7472 616e 7366 6f72 6d22 2c20 4e6f 6e65  transform", None
-00017810: 2920 6f72 2067 6574 6174 7472 2873 656c  ) or getattr(sel
-00017820: 662c 2022 5f61 7472 616e 7366 6f72 6d22  f, "_atransform"
-00017830: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-00017840: 2020 2020 2020 2020 2020 2073 6967 203d             sig =
-00017850: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
-00017860: 7265 2866 756e 6329 0a20 2020 2020 2020  re(func).       
-00017870: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-00017880: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-00017890: 7461 7474 7228 7369 672e 7265 7475 726e  tattr(sig.return
-000178a0: 5f61 6e6e 6f74 6174 696f 6e2c 2022 5f5f  _annotation, "__
-000178b0: 6172 6773 5f5f 222c 2028 416e 792c 2929  args__", (Any,))
-000178c0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-000178d0: 2020 2020 6966 2073 6967 2e72 6574 7572      if sig.retur
-000178e0: 6e5f 616e 6e6f 7461 7469 6f6e 2021 3d20  n_annotation != 
-000178f0: 696e 7370 6563 742e 5369 676e 6174 7572  inspect.Signatur
-00017900: 652e 656d 7074 790a 2020 2020 2020 2020  e.empty.        
-00017910: 2020 2020 2020 2020 656c 7365 2041 6e79          else Any
-00017920: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00017930: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
-00017940: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-00017950: 2020 2020 2020 7265 7475 726e 2041 6e79        return Any
-00017960: 0a0a 2020 2020 6465 6620 5f5f 6571 5f5f  ..    def __eq__
-00017970: 2873 656c 662c 206f 7468 6572 3a20 416e  (self, other: An
-00017980: 7929 202d 3e20 626f 6f6c 3a0a 2020 2020  y) -> bool:.    
-00017990: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000179a0: 6528 6f74 6865 722c 2052 756e 6e61 626c  e(other, Runnabl
-000179b0: 6547 656e 6572 6174 6f72 293a 0a20 2020  eGenerator):.   
-000179c0: 2020 2020 2020 2020 2069 6620 6861 7361           if hasa
-000179d0: 7474 7228 7365 6c66 2c20 225f 7472 616e  ttr(self, "_tran
-000179e0: 7366 6f72 6d22 2920 616e 6420 6861 7361  sform") and hasa
-000179f0: 7474 7228 6f74 6865 722c 2022 5f74 7261  ttr(other, "_tra
-00017a00: 6e73 666f 726d 2229 3a0a 2020 2020 2020  nsform"):.      
-00017a10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017a20: 2073 656c 662e 5f74 7261 6e73 666f 726d   self._transform
-00017a30: 203d 3d20 6f74 6865 722e 5f74 7261 6e73   == other._trans
-00017a40: 666f 726d 0a20 2020 2020 2020 2020 2020  form.           
-00017a50: 2065 6c69 6620 6861 7361 7474 7228 7365   elif hasattr(se
-00017a60: 6c66 2c20 225f 6174 7261 6e73 666f 726d  lf, "_atransform
-00017a70: 2229 2061 6e64 2068 6173 6174 7472 286f  ") and hasattr(o
-00017a80: 7468 6572 2c20 225f 6174 7261 6e73 666f  ther, "_atransfo
-00017a90: 726d 2229 3a0a 2020 2020 2020 2020 2020  rm"):.          
-00017aa0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00017ab0: 662e 5f61 7472 616e 7366 6f72 6d20 3d3d  f._atransform ==
-00017ac0: 206f 7468 6572 2e5f 6174 7261 6e73 666f   other._atransfo
-00017ad0: 726d 0a20 2020 2020 2020 2020 2020 2065  rm.            e
-00017ae0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017af0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00017b00: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00017b10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017b20: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
-00017b30: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-00017b40: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00017b50: 2069 6620 6861 7361 7474 7228 7365 6c66   if hasattr(self
-00017b60: 2c20 225f 7472 616e 7366 6f72 6d22 293a  , "_transform"):
-00017b70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00017b80: 7572 6e20 6622 5275 6e6e 6162 6c65 4765  urn f"RunnableGe
-00017b90: 6e65 7261 746f 7228 7b73 656c 662e 5f74  nerator({self._t
-00017ba0: 7261 6e73 666f 726d 2e5f 5f6e 616d 655f  ransform.__name_
-00017bb0: 5f7d 2922 0a20 2020 2020 2020 2065 6c69  _})".        eli
-00017bc0: 6620 6861 7361 7474 7228 7365 6c66 2c20  f hasattr(self, 
-00017bd0: 225f 6174 7261 6e73 666f 726d 2229 3a0a  "_atransform"):.
-00017be0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017bf0: 726e 2066 2252 756e 6e61 626c 6547 656e  rn f"RunnableGen
-00017c00: 6572 6174 6f72 287b 7365 6c66 2e5f 6174  erator({self._at
-00017c10: 7261 6e73 666f 726d 2e5f 5f6e 616d 655f  ransform.__name_
-00017c20: 5f7d 2922 0a20 2020 2020 2020 2065 6c73  _})".        els
-00017c30: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00017c40: 6574 7572 6e20 2252 756e 6e61 626c 6547  eturn "RunnableG
-00017c50: 656e 6572 6174 6f72 282e 2e2e 2922 0a0a  enerator(...)"..
-00017c60: 2020 2020 6465 6620 7472 616e 7366 6f72      def transfor
-00017c70: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
-00017c80: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
-00017c90: 4974 6572 6174 6f72 5b49 6e70 7574 5d2c  Iterator[Input],
-00017ca0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00017cb0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00017cc0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00017cd0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00017ce0: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
-00017cf0: 3e20 4974 6572 6174 6f72 5b4f 7574 7075  > Iterator[Outpu
-00017d00: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
-00017d10: 726e 2073 656c 662e 5f74 7261 6e73 666f  rn self._transfo
-00017d20: 726d 5f73 7472 6561 6d5f 7769 7468 5f63  rm_stream_with_c
-00017d30: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
-00017d40: 2020 2069 6e70 7574 2c20 7365 6c66 2e5f     input, self._
-00017d50: 7472 616e 7366 6f72 6d2c 2063 6f6e 6669  transform, confi
-00017d60: 672c 202a 2a6b 7761 7267 730a 2020 2020  g, **kwargs.    
-00017d70: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00017d80: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00017d90: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00017da0: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00017db0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00017dc0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00017dd0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00017de0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00017df0: 792c 0a20 2020 2029 202d 3e20 4974 6572  y,.    ) -> Iter
-00017e00: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
-00017e10: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00017e20: 662e 7472 616e 7366 6f72 6d28 6974 6572  f.transform(iter
-00017e30: 285b 696e 7075 745d 292c 2063 6f6e 6669  ([input]), confi
-00017e40: 672c 202a 2a6b 7761 7267 7329 0a0a 2020  g, **kwargs)..  
-00017e50: 2020 6465 6620 696e 766f 6b65 280a 2020    def invoke(.  
-00017e60: 2020 2020 2020 7365 6c66 2c20 696e 7075        self, inpu
-00017e70: 743a 2049 6e70 7574 2c20 636f 6e66 6967  t: Input, config
-00017e80: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00017e90: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00017ea0: 652c 202a 2a6b 7761 7267 733a 2041 6e79  e, **kwargs: Any
-00017eb0: 0a20 2020 2029 202d 3e20 4f75 7470 7574  .    ) -> Output
-00017ec0: 3a0a 2020 2020 2020 2020 6669 6e61 6c20  :.        final 
-00017ed0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2066  = None.        f
-00017ee0: 6f72 206f 7574 7075 7420 696e 2073 656c  or output in sel
-00017ef0: 662e 7374 7265 616d 2869 6e70 7574 2c20  f.stream(input, 
-00017f00: 636f 6e66 6967 2c20 2a2a 6b77 6172 6773  config, **kwargs
-00017f10: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00017f20: 6620 6669 6e61 6c20 6973 204e 6f6e 653a  f final is None:
-00017f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017f40: 2066 696e 616c 203d 206f 7574 7075 740a   final = output.
-00017f50: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00017f60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017f70: 2020 6669 6e61 6c20 3d20 6669 6e61 6c20    final = final 
-00017f80: 2b20 6f75 7470 7574 0a20 2020 2020 2020  + output.       
-00017f90: 2072 6574 7572 6e20 6361 7374 284f 7574   return cast(Out
-00017fa0: 7075 742c 2066 696e 616c 290a 0a20 2020  put, final)..   
-00017fb0: 2064 6566 2061 7472 616e 7366 6f72 6d28   def atransform(
-00017fc0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00017fd0: 2020 2020 2020 2069 6e70 7574 3a20 4173         input: As
-00017fe0: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
-00017ff0: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00018000: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-00018010: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-00018020: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-00018030: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00018040: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
-00018050: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
-00018060: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
-00018070: 7472 2873 656c 662c 2022 5f61 7472 616e  tr(self, "_atran
-00018080: 7366 6f72 6d22 293a 0a20 2020 2020 2020  sform"):.       
-00018090: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
-000180a0: 706c 656d 656e 7465 6445 7272 6f72 2822  plementedError("
-000180b0: 5468 6973 2072 756e 6e61 626c 6520 646f  This runnable do
-000180c0: 6573 206e 6f74 2073 7570 706f 7274 2061  es not support a
-000180d0: 7379 6e63 206d 6574 686f 6473 2e22 290a  sync methods.").
-000180e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000180f0: 7365 6c66 2e5f 6174 7261 6e73 666f 726d  self._atransform
-00018100: 5f73 7472 6561 6d5f 7769 7468 5f63 6f6e  _stream_with_con
-00018110: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
-00018120: 2069 6e70 7574 2c20 7365 6c66 2e5f 6174   input, self._at
-00018130: 7261 6e73 666f 726d 2c20 636f 6e66 6967  ransform, config
-00018140: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
-00018150: 2020 2029 0a0a 2020 2020 6465 6620 6173     )..    def as
-00018160: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00018170: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00018180: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00018190: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-000181a0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-000181b0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-000181c0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-000181d0: 792c 0a20 2020 2029 202d 3e20 4173 796e  y,.    ) -> Asyn
-000181e0: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-000181f0: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00018200: 2064 6566 2069 6e70 7574 5f61 6974 6572   def input_aiter
-00018210: 2829 202d 3e20 4173 796e 6349 7465 7261  () -> AsyncItera
-00018220: 746f 725b 496e 7075 745d 3a0a 2020 2020  tor[Input]:.    
-00018230: 2020 2020 2020 2020 7969 656c 6420 696e          yield in
-00018240: 7075 740a 0a20 2020 2020 2020 2072 6574  put..        ret
-00018250: 7572 6e20 7365 6c66 2e61 7472 616e 7366  urn self.atransf
-00018260: 6f72 6d28 696e 7075 745f 6169 7465 7228  orm(input_aiter(
-00018270: 292c 2063 6f6e 6669 672c 202a 2a6b 7761  ), config, **kwa
-00018280: 7267 7329 0a0a 2020 2020 6173 796e 6320  rgs)..    async 
-00018290: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
-000182a0: 2020 2020 2073 656c 662c 2069 6e70 7574       self, input
-000182b0: 3a20 496e 7075 742c 2063 6f6e 6669 673a  : Input, config:
-000182c0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-000182d0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-000182e0: 2c20 2a2a 6b77 6172 6773 3a20 416e 790a  , **kwargs: Any.
-000182f0: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
-00018300: 0a20 2020 2020 2020 2066 696e 616c 203d  .        final =
-00018310: 204e 6f6e 650a 2020 2020 2020 2020 6173   None.        as
-00018320: 796e 6320 666f 7220 6f75 7470 7574 2069  ync for output i
-00018330: 6e20 7365 6c66 2e61 7374 7265 616d 2869  n self.astream(i
-00018340: 6e70 7574 2c20 636f 6e66 6967 2c20 2a2a  nput, config, **
-00018350: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00018360: 2020 2020 2069 6620 6669 6e61 6c20 6973       if final is
-00018370: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00018380: 2020 2020 2020 2066 696e 616c 203d 206f         final = o
-00018390: 7574 7075 740a 2020 2020 2020 2020 2020  utput.          
-000183a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000183b0: 2020 2020 2020 2020 6669 6e61 6c20 3d20          final = 
-000183c0: 6669 6e61 6c20 2b20 6f75 7470 7574 0a20  final + output. 
-000183d0: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-000183e0: 7374 284f 7574 7075 742c 2066 696e 616c  st(Output, final
-000183f0: 290a 0a0a 636c 6173 7320 5275 6e6e 6162  )...class Runnab
-00018400: 6c65 4c61 6d62 6461 2852 756e 6e61 626c  leLambda(Runnabl
-00018410: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
-00018420: 293a 0a20 2020 2022 2222 5275 6e6e 6162  ):.    """Runnab
-00018430: 6c65 4c61 6d62 6461 2063 6f6e 7665 7274  leLambda convert
-00018440: 7320 6120 7079 7468 6f6e 2063 616c 6c61  s a python calla
-00018450: 626c 6520 696e 746f 2061 2052 756e 6e61  ble into a Runna
-00018460: 626c 652e 0a0a 2020 2020 5772 6170 7069  ble...    Wrappi
-00018470: 6e67 2061 2063 616c 6c61 626c 6520 696e  ng a callable in
-00018480: 2061 2052 756e 6e61 626c 654c 616d 6264   a RunnableLambd
-00018490: 6120 6d61 6b65 7320 7468 6520 6361 6c6c  a makes the call
-000184a0: 6162 6c65 2075 7361 626c 650a 2020 2020  able usable.    
-000184b0: 7769 7468 696e 2065 6974 6865 7220 6120  within either a 
-000184c0: 7379 6e63 206f 7220 6173 796e 6320 636f  sync or async co
-000184d0: 6e74 6578 742e 0a0a 2020 2020 5275 6e6e  ntext...    Runn
-000184e0: 6162 6c65 4c61 6d62 6461 2063 616e 2062  ableLambda can b
-000184f0: 6520 636f 6d70 6f73 6564 2061 7320 616e  e composed as an
-00018500: 7920 6f74 6865 7220 5275 6e6e 6162 6c65  y other Runnable
-00018510: 2061 6e64 2070 726f 7669 6465 730a 2020   and provides.  
-00018520: 2020 7365 616d 6c65 7373 2069 6e74 6567    seamless integ
-00018530: 7261 7469 6f6e 2077 6974 6820 4c61 6e67  ration with Lang
-00018540: 4368 6169 6e20 7472 6163 696e 672e 0a0a  Chain tracing...
-00018550: 2020 2020 4578 616d 706c 6573 3a0a 0a20      Examples:.. 
-00018560: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
-00018570: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
-00018580: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-00018590: 7320 6973 2061 2052 756e 6e61 626c 654c  s is a RunnableL
-000185a0: 616d 6264 610a 2020 2020 2020 2020 2020  ambda.          
-000185b0: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
-000185c0: 5f63 6f72 652e 7275 6e6e 6162 6c65 7320  _core.runnables 
-000185d0: 696d 706f 7274 2052 756e 6e61 626c 654c  import RunnableL
-000185e0: 616d 6264 610a 0a20 2020 2020 2020 2020  ambda..         
-000185f0: 2020 2064 6566 2061 6464 5f6f 6e65 2878     def add_one(x
-00018600: 3a20 696e 7429 202d 3e20 696e 743a 0a20  : int) -> int:. 
-00018610: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00018620: 6574 7572 6e20 7820 2b20 310a 0a20 2020  eturn x + 1..   
-00018630: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
-00018640: 6520 3d20 5275 6e6e 6162 6c65 4c61 6d62  e = RunnableLamb
-00018650: 6461 2861 6464 5f6f 6e65 290a 0a20 2020  da(add_one)..   
-00018660: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
-00018670: 652e 696e 766f 6b65 2831 2920 2320 7265  e.invoke(1) # re
-00018680: 7475 726e 7320 320a 2020 2020 2020 2020  turns 2.        
-00018690: 2020 2020 7275 6e6e 6162 6c65 2e62 6174      runnable.bat
-000186a0: 6368 285b 312c 2032 2c20 335d 2920 2320  ch([1, 2, 3]) # 
-000186b0: 7265 7475 726e 7320 5b32 2c20 332c 2034  returns [2, 3, 4
-000186c0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-000186d0: 2041 7379 6e63 2069 7320 7375 7070 6f72   Async is suppor
-000186e0: 7465 6420 6279 2064 6566 6175 6c74 2062  ted by default b
-000186f0: 7920 6465 6c65 6761 7469 6e67 2074 6f20  y delegating to 
-00018700: 7468 6520 7379 6e63 2069 6d70 6c65 6d65  the sync impleme
-00018710: 6e74 6174 696f 6e0a 2020 2020 2020 2020  ntation.        
-00018720: 2020 2020 6177 6169 7420 7275 6e6e 6162      await runnab
-00018730: 6c65 2e61 696e 766f 6b65 2831 2920 2320  le.ainvoke(1) # 
-00018740: 7265 7475 726e 7320 320a 2020 2020 2020  returns 2.      
-00018750: 2020 2020 2020 6177 6169 7420 7275 6e6e        await runn
-00018760: 6162 6c65 2e61 6261 7463 6828 5b31 2c20  able.abatch([1, 
-00018770: 322c 2033 5d29 2023 2072 6574 7572 6e73  2, 3]) # returns
-00018780: 205b 322c 2033 2c20 345d 0a0a 0a20 2020   [2, 3, 4]...   
-00018790: 2020 2020 2020 2020 2023 2041 6c74 6572           # Alter
-000187a0: 6e61 7469 7665 6c79 2c20 6361 6e20 7072  natively, can pr
-000187b0: 6f76 6964 6520 626f 7468 2073 796e 6420  ovide both synd 
-000187c0: 616e 6420 7379 6e63 2069 6d70 6c65 6d65  and sync impleme
-000187d0: 6e74 6174 696f 6e73 0a20 2020 2020 2020  ntations.       
-000187e0: 2020 2020 2061 7379 6e63 2064 6566 2061       async def a
-000187f0: 6464 5f6f 6e65 5f61 7379 6e63 2878 3a20  dd_one_async(x: 
-00018800: 696e 7429 202d 3e20 696e 743a 0a20 2020  int) -> int:.   
-00018810: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00018820: 7572 6e20 7820 2b20 310a 0a20 2020 2020  urn x + 1..     
-00018830: 2020 2020 2020 2072 756e 6e61 626c 6520         runnable 
-00018840: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
-00018850: 2861 6464 5f6f 6e65 2c20 6166 756e 633d  (add_one, afunc=
-00018860: 6164 645f 6f6e 655f 6173 796e 6329 0a20  add_one_async). 
-00018870: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-00018880: 626c 652e 696e 766f 6b65 2831 2920 2320  ble.invoke(1) # 
-00018890: 5573 6573 2061 6464 5f6f 6e65 0a20 2020  Uses add_one.   
-000188a0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-000188b0: 756e 6e61 626c 652e 6169 6e76 6f6b 6528  unnable.ainvoke(
-000188c0: 3129 2023 2055 7365 7320 6164 645f 6f6e  1) # Uses add_on
-000188d0: 655f 6173 796e 630a 2020 2020 2222 220a  e_async.    """.
-000188e0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-000188f0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-00018900: 0a20 2020 2020 2020 2066 756e 633a 2055  .        func: U
-00018910: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
-00018920: 2020 556e 696f 6e5b 0a20 2020 2020 2020    Union[.       
-00018930: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00018940: 655b 5b49 6e70 7574 5d2c 204f 7574 7075  e[[Input], Outpu
-00018950: 745d 2c0a 2020 2020 2020 2020 2020 2020  t],.            
-00018960: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00018970: 7075 745d 2c20 4974 6572 6174 6f72 5b4f  put], Iterator[O
-00018980: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
-00018990: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-000189a0: 655b 5b49 6e70 7574 2c20 5275 6e6e 6162  e[[Input, Runnab
-000189b0: 6c65 436f 6e66 6967 5d2c 204f 7574 7075  leConfig], Outpu
-000189c0: 745d 2c0a 2020 2020 2020 2020 2020 2020  t],.            
-000189d0: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-000189e0: 7075 742c 2043 616c 6c62 6163 6b4d 616e  put, CallbackMan
-000189f0: 6167 6572 466f 7243 6861 696e 5275 6e5d  agerForChainRun]
-00018a00: 2c20 4f75 7470 7574 5d2c 0a20 2020 2020  , Output],.     
-00018a10: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-00018a20: 626c 655b 5b49 6e70 7574 2c20 4361 6c6c  ble[[Input, Call
-00018a30: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
-00018a40: 6169 6e52 756e 2c20 5275 6e6e 6162 6c65  ainRun, Runnable
-00018a50: 436f 6e66 6967 5d2c 204f 7574 7075 745d  Config], Output]
-00018a60: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00018a70: 0a20 2020 2020 2020 2020 2020 2055 6e69  .            Uni
-00018a80: 6f6e 5b0a 2020 2020 2020 2020 2020 2020  on[.            
-00018a90: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00018aa0: 7075 745d 2c20 4177 6169 7461 626c 655b  put], Awaitable[
-00018ab0: 4f75 7470 7574 5d5d 2c0a 2020 2020 2020  Output]],.      
-00018ac0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00018ad0: 6c65 5b5b 496e 7075 745d 2c20 4173 796e  le[[Input], Asyn
-00018ae0: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00018af0: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-00018b00: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00018b10: 7075 742c 2052 756e 6e61 626c 6543 6f6e  put, RunnableCon
-00018b20: 6669 675d 2c20 4177 6169 7461 626c 655b  fig], Awaitable[
-00018b30: 4f75 7470 7574 5d5d 2c0a 2020 2020 2020  Output]],.      
-00018b40: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00018b50: 6c65 5b5b 496e 7075 742c 2041 7379 6e63  le[[Input, Async
-00018b60: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
-00018b70: 6f72 4368 6169 6e52 756e 5d2c 2041 7761  orChainRun], Awa
-00018b80: 6974 6162 6c65 5b4f 7574 7075 745d 5d2c  itable[Output]],
-00018b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018ba0: 2043 616c 6c61 626c 655b 0a20 2020 2020   Callable[.     
-00018bb0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00018bc0: 496e 7075 742c 2041 7379 6e63 4361 6c6c  Input, AsyncCall
-00018bd0: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
-00018be0: 6169 6e52 756e 2c20 5275 6e6e 6162 6c65  ainRun, Runnable
-00018bf0: 436f 6e66 6967 5d2c 0a20 2020 2020 2020  Config],.       
-00018c00: 2020 2020 2020 2020 2020 2020 2041 7761               Awa
-00018c10: 6974 6162 6c65 5b4f 7574 7075 745d 2c0a  itable[Output],.
+00017500: 2020 2020 2020 2069 6620 6920 6e6f 7420         if i not 
+00017510: 696e 2066 6169 6c65 645f 696e 7075 7473  in failed_inputs
+00017520: 5f6d 6170 0a20 2020 2020 2020 2020 2020  _map.           
+00017530: 2020 2020 2020 2020 2020 2020 205d 2c0a               ],.
+00017540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017550: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00017560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017570: 2020 2020 2020 2320 6561 6368 2073 7465        # each ste
+00017580: 7020 6120 6368 696c 6420 7275 6e20 6f66  p a child run of
+00017590: 2074 6865 2063 6f72 7265 7370 6f6e 6469   the correspondi
+000175a0: 6e67 2072 6f6f 7420 7275 6e0a 2020 2020  ng root run.    
+000175b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175c0: 2020 2020 2020 2020 7061 7463 685f 636f          patch_co
+000175d0: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
+000175e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175f0: 2020 2020 2020 636f 6e66 6967 2c20 6361        config, ca
+00017600: 6c6c 6261 636b 733d 726d 2e67 6574 5f63  llbacks=rm.get_c
+00017610: 6869 6c64 2866 2273 6571 3a73 7465 703a  hild(f"seq:step:
+00017620: 7b73 7465 7069 6478 2b31 7d22 290a 2020  {stepidx+1}").  
+00017630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017640: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00017650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017660: 2020 2020 2020 2020 666f 7220 692c 2028          for i, (
+00017670: 726d 2c20 636f 6e66 6967 2920 696e 2065  rm, config) in e
+00017680: 6e75 6d65 7261 7465 287a 6970 2872 756e  numerate(zip(run
+00017690: 5f6d 616e 6167 6572 732c 2063 6f6e 6669  _managers, confi
+000176a0: 6773 2929 0a20 2020 2020 2020 2020 2020  gs)).           
+000176b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176c0: 2069 6620 6920 6e6f 7420 696e 2066 6169   if i not in fai
+000176d0: 6c65 645f 696e 7075 7473 5f6d 6170 0a20  led_inputs_map. 
+000176e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176f0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00017700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017710: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+00017720: 6f6e 733d 7265 7475 726e 5f65 7863 6570  ons=return_excep
+00017730: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+00017740: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00017750: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00017760: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00017770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017780: 2020 2023 2049 6620 616e 2069 6e70 7574     # If an input
+00017790: 2066 6169 6c65 642c 2061 6464 2069 7420   failed, add it 
+000177a0: 746f 2074 6865 206d 6170 0a20 2020 2020  to the map.     
+000177b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000177c0: 6f72 2069 2c20 696e 7020 696e 207a 6970  or i, inp in zip
+000177d0: 2872 656d 6169 6e69 6e67 5f69 6478 732c  (remaining_idxs,
+000177e0: 2069 6e70 7574 7329 3a0a 2020 2020 2020   inputs):.      
+000177f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017800: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00017810: 696e 702c 2045 7863 6570 7469 6f6e 293a  inp, Exception):
+00017820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017830: 2020 2020 2020 2020 2020 2020 2066 6169               fai
+00017840: 6c65 645f 696e 7075 7473 5f6d 6170 5b69  led_inputs_map[i
+00017850: 5d20 3d20 696e 700a 2020 2020 2020 2020  ] = inp.        
+00017860: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00017870: 7473 203d 205b 696e 7020 666f 7220 696e  ts = [inp for in
+00017880: 7020 696e 2069 6e70 7574 7320 6966 206e  p in inputs if n
+00017890: 6f74 2069 7369 6e73 7461 6e63 6528 696e  ot isinstance(in
+000178a0: 702c 2045 7863 6570 7469 6f6e 295d 0a20  p, Exception)]. 
+000178b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178c0: 2020 2023 2049 6620 616c 6c20 696e 7075     # If all inpu
+000178d0: 7473 2068 6176 6520 6661 696c 6564 2c20  ts have failed, 
+000178e0: 7374 6f70 2070 726f 6365 7373 696e 670a  stop processing.
+000178f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017900: 2020 2020 6966 206c 656e 2866 6169 6c65      if len(faile
+00017910: 645f 696e 7075 7473 5f6d 6170 2920 3d3d  d_inputs_map) ==
+00017920: 206c 656e 2863 6f6e 6669 6773 293a 0a20   len(configs):. 
+00017930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017940: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00017950: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00017960: 5265 6173 7365 6d62 6c65 2074 6865 206f  Reassemble the o
+00017970: 7574 7075 7473 2c20 696e 7365 7274 696e  utputs, insertin
+00017980: 6720 4578 6365 7074 696f 6e73 2066 6f72  g Exceptions for
+00017990: 2066 6169 6c65 6420 696e 7075 7473 0a20   failed inputs. 
+000179a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000179b0: 6e70 7574 735f 636f 7079 203d 2069 6e70  nputs_copy = inp
+000179c0: 7574 732e 636f 7079 2829 0a20 2020 2020  uts.copy().     
+000179d0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+000179e0: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+000179f0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00017a00: 7261 6e67 6528 6c65 6e28 636f 6e66 6967  range(len(config
+00017a10: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
+00017a20: 2020 2020 2020 2020 2069 6620 6920 696e           if i in
+00017a30: 2066 6169 6c65 645f 696e 7075 7473 5f6d   failed_inputs_m
+00017a40: 6170 3a0a 2020 2020 2020 2020 2020 2020  ap:.            
+00017a50: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00017a60: 7473 2e61 7070 656e 6428 6361 7374 2849  ts.append(cast(I
+00017a70: 6e70 7574 2c20 6661 696c 6564 5f69 6e70  nput, failed_inp
+00017a80: 7574 735f 6d61 705b 695d 2929 0a20 2020  uts_map[i])).   
+00017a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017aa0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017ab0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017ac0: 6e70 7574 732e 6170 7065 6e64 2869 6e70  nputs.append(inp
+00017ad0: 7574 735f 636f 7079 2e70 6f70 2830 2929  uts_copy.pop(0))
+00017ae0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00017af0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00017b00: 2020 2066 6f72 2069 2c20 7374 6570 2069     for i, step i
+00017b10: 6e20 656e 756d 6572 6174 6528 7365 6c66  n enumerate(self
+00017b20: 2e73 7465 7073 293a 0a20 2020 2020 2020  .steps):.       
+00017b30: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00017b40: 7574 7320 3d20 7374 6570 2e62 6174 6368  uts = step.batch
+00017b50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00017b60: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+00017b70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017b80: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+00017b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ba0: 2020 2020 2020 2020 2320 6561 6368 2073          # each s
+00017bb0: 7465 7020 6120 6368 696c 6420 7275 6e20  tep a child run 
+00017bc0: 6f66 2074 6865 2063 6f72 7265 7370 6f6e  of the correspon
+00017bd0: 6469 6e67 2072 6f6f 7420 7275 6e0a 2020  ding root run.  
+00017be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bf0: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+00017c00: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+00017c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c20: 2020 2020 2020 2020 636f 6e66 6967 2c20          config, 
+00017c30: 6361 6c6c 6261 636b 733d 726d 2e67 6574  callbacks=rm.get
+00017c40: 5f63 6869 6c64 2866 2273 6571 3a73 7465  _child(f"seq:ste
+00017c50: 703a 7b69 2b31 7d22 290a 2020 2020 2020  p:{i+1}").      
+00017c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00017c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c90: 2020 2020 666f 7220 726d 2c20 636f 6e66      for rm, conf
+00017ca0: 6967 2069 6e20 7a69 7028 7275 6e5f 6d61  ig in zip(run_ma
+00017cb0: 6e61 6765 7273 2c20 636f 6e66 6967 7329  nagers, configs)
+00017cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017cd0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00017ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cf0: 290a 0a20 2020 2020 2020 2023 2066 696e  )..        # fin
+00017d00: 6973 6820 7468 6520 726f 6f74 2072 756e  ish the root run
+00017d10: 730a 2020 2020 2020 2020 6578 6365 7074  s.        except
+00017d20: 2042 6173 6545 7863 6570 7469 6f6e 2061   BaseException a
+00017d30: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00017d40: 2066 6f72 2072 6d20 696e 2072 756e 5f6d   for rm in run_m
+00017d50: 616e 6167 6572 733a 0a20 2020 2020 2020  anagers:.       
+00017d60: 2020 2020 2020 2020 2072 6d2e 6f6e 5f63           rm.on_c
+00017d70: 6861 696e 5f65 7272 6f72 2865 290a 2020  hain_error(e).  
+00017d80: 2020 2020 2020 2020 2020 6966 2072 6574            if ret
+00017d90: 7572 6e5f 6578 6365 7074 696f 6e73 3a0a  urn_exceptions:.
+00017da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017db0: 7265 7475 726e 2063 6173 7428 4c69 7374  return cast(List
+00017dc0: 5b4f 7574 7075 745d 2c20 5b65 2066 6f72  [Output], [e for
+00017dd0: 205f 2069 6e20 696e 7075 7473 5d29 0a20   _ in inputs]). 
+00017de0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00017df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017e00: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
+00017e10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00017e20: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
+00017e30: 3a20 4f70 7469 6f6e 616c 5b45 7863 6570  : Optional[Excep
+00017e40: 7469 6f6e 5d20 3d20 4e6f 6e65 0a20 2020  tion] = None.   
+00017e50: 2020 2020 2020 2020 2066 6f72 2072 756e           for run
+00017e60: 5f6d 616e 6167 6572 2c20 6f75 7420 696e  _manager, out in
+00017e70: 207a 6970 2872 756e 5f6d 616e 6167 6572   zip(run_manager
+00017e80: 732c 2069 6e70 7574 7329 3a0a 2020 2020  s, inputs):.    
+00017e90: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00017ea0: 7369 6e73 7461 6e63 6528 6f75 742c 2045  sinstance(out, E
+00017eb0: 7863 6570 7469 6f6e 293a 0a20 2020 2020  xception):.     
+00017ec0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017ed0: 6972 7374 5f65 7863 6570 7469 6f6e 203d  irst_exception =
+00017ee0: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
+00017ef0: 206f 7220 6f75 740a 2020 2020 2020 2020   or out.        
+00017f00: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+00017f10: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+00017f20: 5f65 7272 6f72 286f 7574 290a 2020 2020  _error(out).    
+00017f30: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00017f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017f50: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
+00017f60: 722e 6f6e 5f63 6861 696e 5f65 6e64 286f  r.on_chain_end(o
+00017f70: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
+00017f80: 6966 2072 6574 7572 6e5f 6578 6365 7074  if return_except
+00017f90: 696f 6e73 206f 7220 6669 7273 745f 6578  ions or first_ex
+00017fa0: 6365 7074 696f 6e20 6973 204e 6f6e 653a  ception is None:
+00017fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017fc0: 2072 6574 7572 6e20 6361 7374 284c 6973   return cast(Lis
+00017fd0: 745b 4f75 7470 7574 5d2c 2069 6e70 7574  t[Output], input
+00017fe0: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
+00017ff0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00018000: 2020 2020 2072 6169 7365 2066 6972 7374       raise first
+00018010: 5f65 7863 6570 7469 6f6e 0a0a 2020 2020  _exception..    
+00018020: 6173 796e 6320 6465 6620 6162 6174 6368  async def abatch
+00018030: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00018040: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00018050: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+00018060: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00018070: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+00018080: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+00018090: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+000180a0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+000180b0: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+000180c0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+000180d0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+000180e0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+000180f0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+00018100: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
+00018110: 7470 7574 5d3a 0a20 2020 2020 2020 2066  tput]:.        f
+00018120: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00018130: 7265 2e62 6574 612e 7275 6e6e 6162 6c65  re.beta.runnable
+00018140: 732e 636f 6e74 6578 7420 696d 706f 7274  s.context import
+00018150: 2061 636f 6e66 6967 5f77 6974 685f 636f   aconfig_with_co
+00018160: 6e74 6578 740a 2020 2020 2020 2020 6672  ntext.        fr
+00018170: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+00018180: 652e 6361 6c6c 6261 636b 732e 6d61 6e61  e.callbacks.mana
+00018190: 6765 7220 696d 706f 7274 2041 7379 6e63  ger import Async
+000181a0: 4361 6c6c 6261 636b 4d61 6e61 6765 720a  CallbackManager.
+000181b0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000181c0: 696e 7075 7473 3a0a 2020 2020 2020 2020  inputs:.        
+000181d0: 2020 2020 7265 7475 726e 205b 5d0a 0a20      return [].. 
+000181e0: 2020 2020 2020 2023 2073 6574 7570 2063         # setup c
+000181f0: 616c 6c62 6163 6b73 2061 6e64 2063 6f6e  allbacks and con
+00018200: 7465 7874 0a20 2020 2020 2020 2063 6f6e  text.        con
+00018210: 6669 6773 203d 205b 0a20 2020 2020 2020  figs = [.       
+00018220: 2020 2020 2061 636f 6e66 6967 5f77 6974       aconfig_wit
+00018230: 685f 636f 6e74 6578 7428 632c 2073 656c  h_context(c, sel
+00018240: 662e 7374 6570 7329 0a20 2020 2020 2020  f.steps).       
+00018250: 2020 2020 2066 6f72 2063 2069 6e20 6765       for c in ge
+00018260: 745f 636f 6e66 6967 5f6c 6973 7428 636f  t_config_list(co
+00018270: 6e66 6967 2c20 6c65 6e28 696e 7075 7473  nfig, len(inputs
+00018280: 2929 0a20 2020 2020 2020 205d 0a20 2020  )).        ].   
+00018290: 2020 2020 2063 616c 6c62 6163 6b5f 6d61       callback_ma
+000182a0: 6e61 6765 7273 203d 205b 0a20 2020 2020  nagers = [.     
+000182b0: 2020 2020 2020 2041 7379 6e63 4361 6c6c         AsyncCall
+000182c0: 6261 636b 4d61 6e61 6765 722e 636f 6e66  backManager.conf
+000182d0: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+000182e0: 2020 2020 2020 2069 6e68 6572 6974 6162         inheritab
+000182f0: 6c65 5f63 616c 6c62 6163 6b73 3d63 6f6e  le_callbacks=con
+00018300: 6669 672e 6765 7428 2263 616c 6c62 6163  fig.get("callbac
+00018310: 6b73 2229 2c0a 2020 2020 2020 2020 2020  ks"),.          
+00018320: 2020 2020 2020 6c6f 6361 6c5f 6361 6c6c        local_call
+00018330: 6261 636b 733d 4e6f 6e65 2c0a 2020 2020  backs=None,.    
+00018340: 2020 2020 2020 2020 2020 2020 7665 7262              verb
+00018350: 6f73 653d 4661 6c73 652c 0a20 2020 2020  ose=False,.     
+00018360: 2020 2020 2020 2020 2020 2069 6e68 6572             inher
+00018370: 6974 6162 6c65 5f74 6167 733d 636f 6e66  itable_tags=conf
+00018380: 6967 2e67 6574 2822 7461 6773 2229 2c0a  ig.get("tags"),.
+00018390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183a0: 6c6f 6361 6c5f 7461 6773 3d4e 6f6e 652c  local_tags=None,
+000183b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000183c0: 2069 6e68 6572 6974 6162 6c65 5f6d 6574   inheritable_met
+000183d0: 6164 6174 613d 636f 6e66 6967 2e67 6574  adata=config.get
+000183e0: 2822 6d65 7461 6461 7461 2229 2c0a 2020  ("metadata"),.  
+000183f0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00018400: 6361 6c5f 6d65 7461 6461 7461 3d4e 6f6e  cal_metadata=Non
+00018410: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+00018420: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00018430: 2063 6f6e 6669 6720 696e 2063 6f6e 6669   config in confi
+00018440: 6773 0a20 2020 2020 2020 205d 0a20 2020  gs.        ].   
+00018450: 2020 2020 2023 2073 7461 7274 2074 6865       # start the
+00018460: 2072 6f6f 7420 7275 6e73 2c20 6f6e 6520   root runs, one 
+00018470: 7065 7220 696e 7075 740a 2020 2020 2020  per input.      
+00018480: 2020 7275 6e5f 6d61 6e61 6765 7273 3a20    run_managers: 
+00018490: 4c69 7374 5b41 7379 6e63 4361 6c6c 6261  List[AsyncCallba
+000184a0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
+000184b0: 6e52 756e 5d20 3d20 6177 6169 7420 6173  nRun] = await as
+000184c0: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
+000184d0: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
+000184e0: 2020 2020 2020 2020 2020 2020 2063 6d2e               cm.
+000184f0: 6f6e 5f63 6861 696e 5f73 7461 7274 280a  on_chain_start(.
+00018500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018510: 2020 2020 6475 6d70 6428 7365 6c66 292c      dumpd(self),
+00018520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018530: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+00018540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018550: 6e61 6d65 3d63 6f6e 6669 672e 6765 7428  name=config.get(
+00018560: 2272 756e 5f6e 616d 6522 2920 6f72 2073  "run_name") or s
+00018570: 656c 662e 6765 745f 6e61 6d65 2829 2c0a  elf.get_name(),.
+00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018590: 2020 2020 7275 6e5f 6964 3d63 6f6e 6669      run_id=confi
+000185a0: 672e 706f 7028 2272 756e 5f69 6422 2c20  g.pop("run_id", 
+000185b0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+000185c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000185d0: 2020 2020 2020 2020 2066 6f72 2063 6d2c           for cm,
+000185e0: 2069 6e70 7574 2c20 636f 6e66 6967 2069   input, config i
+000185f0: 6e20 7a69 7028 6361 6c6c 6261 636b 5f6d  n zip(callback_m
+00018600: 616e 6167 6572 732c 2069 6e70 7574 732c  anagers, inputs,
+00018610: 2063 6f6e 6669 6773 290a 2020 2020 2020   configs).      
+00018620: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00018630: 290a 0a20 2020 2020 2020 2023 2069 6e76  )..        # inv
+00018640: 6f6b 6520 2e62 6174 6368 2829 206f 6e20  oke .batch() on 
+00018650: 6561 6368 2073 7465 700a 2020 2020 2020  each step.      
+00018660: 2020 2320 7468 6973 2075 7365 7320 6261    # this uses ba
+00018670: 7463 6869 6e67 206f 7074 696d 697a 6174  tching optimizat
+00018680: 696f 6e73 2069 6e20 5275 6e6e 6162 6c65  ions in Runnable
+00018690: 2073 7562 636c 6173 7365 732c 206c 696b   subclasses, lik
+000186a0: 6520 4c4c 4d0a 2020 2020 2020 2020 7472  e LLM.        tr
+000186b0: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+000186c0: 6620 7265 7475 726e 5f65 7863 6570 7469  f return_excepti
+000186d0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+000186e0: 2020 2020 2023 2054 7261 636b 2077 6869       # Track whi
+000186f0: 6368 2069 6e70 7574 7320 2862 7920 696e  ch inputs (by in
+00018700: 6465 7829 2066 6169 6c65 6420 736f 2066  dex) failed so f
+00018710: 6172 0a20 2020 2020 2020 2020 2020 2020  ar.             
+00018720: 2020 2023 2049 6620 616e 2069 6e70 7574     # If an input
+00018730: 2068 6173 2066 6169 6c65 6420 6974 2077   has failed it w
+00018740: 696c 6c20 6265 2070 7265 7365 6e74 2069  ill be present i
+00018750: 6e20 7468 6973 206d 6170 2c0a 2020 2020  n this map,.    
+00018760: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+00018770: 6420 7468 6520 7661 6c75 6520 7769 6c6c  d the value will
+00018780: 2062 6520 7468 6520 6578 6365 7074 696f   be the exceptio
+00018790: 6e20 7468 6174 2077 6173 2072 6169 7365  n that was raise
+000187a0: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
+000187b0: 2020 2066 6169 6c65 645f 696e 7075 7473     failed_inputs
+000187c0: 5f6d 6170 3a20 4469 6374 5b69 6e74 2c20  _map: Dict[int, 
+000187d0: 4578 6365 7074 696f 6e5d 203d 207b 7d0a  Exception] = {}.
+000187e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187f0: 666f 7220 7374 6570 6964 782c 2073 7465  for stepidx, ste
+00018800: 7020 696e 2065 6e75 6d65 7261 7465 2873  p in enumerate(s
+00018810: 656c 662e 7374 6570 7329 3a0a 2020 2020  elf.steps):.    
+00018820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018830: 2320 4173 7365 6d62 6c65 2074 6865 206f  # Assemble the o
+00018840: 7269 6769 6e61 6c20 696e 6465 7865 7320  riginal indexes 
+00018850: 6f66 2074 6865 2072 656d 6169 6e69 6e67  of the remaining
+00018860: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
+00018870: 2020 2020 2020 2020 2020 2020 2320 2869              # (i
+00018880: 2e65 2e20 7468 6520 6f6e 6573 2074 6861  .e. the ones tha
+00018890: 7420 6861 7665 6e27 7420 6661 696c 6564  t haven't failed
+000188a0: 2079 6574 290a 2020 2020 2020 2020 2020   yet).          
+000188b0: 2020 2020 2020 2020 2020 7265 6d61 696e            remain
+000188c0: 696e 675f 6964 7873 203d 205b 0a20 2020  ing_idxs = [.   
+000188d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188e0: 2020 2020 2069 2066 6f72 2069 2069 6e20       i for i in 
+000188f0: 7261 6e67 6528 6c65 6e28 636f 6e66 6967  range(len(config
+00018900: 7329 2920 6966 2069 206e 6f74 2069 6e20  s)) if i not in 
+00018910: 6661 696c 6564 5f69 6e70 7574 735f 6d61  failed_inputs_ma
+00018920: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00018930: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00018940: 2020 2020 2020 2020 2020 2020 2320 496e              # In
+00018950: 766f 6b65 2074 6865 2073 7465 7020 6f6e  voke the step on
+00018960: 2074 6865 2072 656d 6169 6e69 6e67 2069   the remaining i
+00018970: 6e70 7574 730a 2020 2020 2020 2020 2020  nputs.          
+00018980: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+00018990: 203d 2061 7761 6974 2073 7465 702e 6162   = await step.ab
+000189a0: 6174 6368 280a 2020 2020 2020 2020 2020  atch(.          
+000189b0: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
+000189c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189d0: 2020 2020 2020 2020 2020 2020 696e 700a              inp.
+000189e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00018a00: 692c 2069 6e70 2069 6e20 7a69 7028 7265  i, inp in zip(re
+00018a10: 6d61 696e 696e 675f 6964 7873 2c20 696e  maining_idxs, in
+00018a20: 7075 7473 290a 2020 2020 2020 2020 2020  puts).          
+00018a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a40: 2020 6966 2069 206e 6f74 2069 6e20 6661    if i not in fa
+00018a50: 696c 6564 5f69 6e70 7574 735f 6d61 700a  iled_inputs_map.
+00018a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a70: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00018a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a90: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00018aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ab0: 2023 2065 6163 6820 7374 6570 2061 2063   # each step a c
+00018ac0: 6869 6c64 2072 756e 206f 6620 7468 6520  hild run of the 
+00018ad0: 636f 7272 6573 706f 6e64 696e 6720 726f  corresponding ro
+00018ae0: 6f74 2072 756e 0a20 2020 2020 2020 2020  ot run.         
+00018af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b00: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
+00018b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b30: 2063 6f6e 6669 672c 2063 616c 6c62 6163   config, callbac
+00018b40: 6b73 3d72 6d2e 6765 745f 6368 696c 6428  ks=rm.get_child(
+00018b50: 6622 7365 713a 7374 6570 3a7b 7374 6570  f"seq:step:{step
+00018b60: 6964 782b 317d 2229 0a20 2020 2020 2020  idx+1}").       
+00018b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00018b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ba0: 2020 2066 6f72 2069 2c20 2872 6d2c 2063     for i, (rm, c
+00018bb0: 6f6e 6669 6729 2069 6e20 656e 756d 6572  onfig) in enumer
+00018bc0: 6174 6528 7a69 7028 7275 6e5f 6d61 6e61  ate(zip(run_mana
+00018bd0: 6765 7273 2c20 636f 6e66 6967 7329 290a  gers, configs)).
+00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bf0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00018c00: 206e 6f74 2069 6e20 6661 696c 6564 5f69   not in failed_i
+00018c10: 6e70 7574 735f 6d61 700a 2020 2020 2020  nputs_map.      
 00018c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c30: 5d2c 0a20 2020 2020 2020 2020 2020 205d  ],.            ]
-00018c40: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00018c50: 2020 2020 2061 6675 6e63 3a20 4f70 7469       afunc: Opti
-00018c60: 6f6e 616c 5b0a 2020 2020 2020 2020 2020  onal[.          
-00018c70: 2020 556e 696f 6e5b 0a20 2020 2020 2020    Union[.       
-00018c80: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00018c90: 655b 5b49 6e70 7574 5d2c 2041 7761 6974  e[[Input], Await
-00018ca0: 6162 6c65 5b4f 7574 7075 745d 5d2c 0a20  able[Output]],. 
-00018cb0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-00018cc0: 616c 6c61 626c 655b 5b49 6e70 7574 5d2c  allable[[Input],
-00018cd0: 2041 7379 6e63 4974 6572 6174 6f72 5b4f   AsyncIterator[O
-00018ce0: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
-00018cf0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00018d00: 655b 5b49 6e70 7574 2c20 5275 6e6e 6162  e[[Input, Runnab
-00018d10: 6c65 436f 6e66 6967 5d2c 2041 7761 6974  leConfig], Await
-00018d20: 6162 6c65 5b4f 7574 7075 745d 5d2c 0a20  able[Output]],. 
-00018d30: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-00018d40: 616c 6c61 626c 655b 5b49 6e70 7574 2c20  allable[[Input, 
-00018d50: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
-00018d60: 6167 6572 466f 7243 6861 696e 5275 6e5d  agerForChainRun]
-00018d70: 2c20 4177 6169 7461 626c 655b 4f75 7470  , Awaitable[Outp
-00018d80: 7574 5d5d 2c0a 2020 2020 2020 2020 2020  ut]],.          
-00018d90: 2020 2020 2020 4361 6c6c 6162 6c65 5b0a        Callable[.
-00018da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018db0: 2020 2020 5b49 6e70 7574 2c20 4173 796e      [Input, Asyn
-00018dc0: 6343 616c 6c62 6163 6b4d 616e 6167 6572  cCallbackManager
-00018dd0: 466f 7243 6861 696e 5275 6e2c 2052 756e  ForChainRun, Run
-00018de0: 6e61 626c 6543 6f6e 6669 675d 2c0a 2020  nableConfig],.  
-00018df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e00: 2020 4177 6169 7461 626c 655b 4f75 7470    Awaitable[Outp
-00018e10: 7574 5d2c 0a20 2020 2020 2020 2020 2020  ut],.           
-00018e20: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00018e30: 2020 2020 5d0a 2020 2020 2020 2020 5d20      ].        ] 
-00018e40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00018e50: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
-00018e60: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00018e70: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00018e80: 2020 2022 2222 4372 6561 7465 2061 2052     """Create a R
-00018e90: 756e 6e61 626c 654c 616d 6264 6120 6672  unnableLambda fr
-00018ea0: 6f6d 2061 2063 616c 6c61 626c 652c 2061  om a callable, a
-00018eb0: 6e64 2061 7379 6e63 2063 616c 6c61 626c  nd async callabl
-00018ec0: 6520 6f72 2062 6f74 682e 0a0a 2020 2020  e or both...    
-00018ed0: 2020 2020 4163 6365 7074 7320 626f 7468      Accepts both
-00018ee0: 2073 796e 6320 616e 6420 6173 796e 6320   sync and async 
-00018ef0: 7661 7269 616e 7473 2074 6f20 616c 6c6f  variants to allo
-00018f00: 7720 7072 6f76 6964 696e 6720 6566 6669  w providing effi
-00018f10: 6369 656e 740a 2020 2020 2020 2020 696d  cient.        im
-00018f20: 706c 656d 656e 7461 7469 6f6e 7320 666f  plementations fo
-00018f30: 7220 7379 6e63 2061 6e64 2061 7379 6e63  r sync and async
-00018f40: 2065 7865 6375 7469 6f6e 2e0a 0a20 2020   execution...   
-00018f50: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-00018f60: 2020 2020 2020 2066 756e 633a 2045 6974         func: Eit
-00018f70: 6865 7220 7379 6e63 206f 7220 6173 796e  her sync or asyn
-00018f80: 6320 6361 6c6c 6162 6c65 0a20 2020 2020  c callable.     
-00018f90: 2020 2020 2020 2061 6675 6e63 3a20 416e         afunc: An
-00018fa0: 2061 7379 6e63 2063 616c 6c61 626c 6520   async callable 
-00018fb0: 7468 6174 2074 616b 6573 2061 6e20 696e  that takes an in
-00018fc0: 7075 7420 616e 6420 7265 7475 726e 7320  put and returns 
-00018fd0: 616e 206f 7574 7075 742e 0a20 2020 2020  an output..     
-00018fe0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00018ff0: 6620 6166 756e 6320 6973 206e 6f74 204e  f afunc is not N
-00019000: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00019010: 2073 656c 662e 6166 756e 6320 3d20 6166   self.afunc = af
-00019020: 756e 630a 2020 2020 2020 2020 2020 2020  unc.            
-00019030: 6675 6e63 5f66 6f72 5f6e 616d 653a 2043  func_for_name: C
-00019040: 616c 6c61 626c 6520 3d20 6166 756e 630a  allable = afunc.
-00019050: 0a20 2020 2020 2020 2069 6620 696e 7370  .        if insp
-00019060: 6563 742e 6973 636f 726f 7574 696e 6566  ect.iscoroutinef
-00019070: 756e 6374 696f 6e28 6675 6e63 2920 6f72  unction(func) or
-00019080: 2069 6e73 7065 6374 2e69 7361 7379 6e63   inspect.isasync
-00019090: 6765 6e66 756e 6374 696f 6e28 6675 6e63  genfunction(func
-000190a0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-000190b0: 6620 6166 756e 6320 6973 206e 6f74 204e  f afunc is not N
-000190c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000190d0: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-000190e0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000190f0: 2020 2020 2020 2020 2020 2246 756e 6320            "Func 
-00019100: 7761 7320 7072 6f76 6964 6564 2061 7320  was provided as 
-00019110: 6120 636f 726f 7574 696e 6520 6675 6e63  a coroutine func
-00019120: 7469 6f6e 2c20 6275 7420 6166 756e 6320  tion, but afunc 
-00019130: 7761 7320 220a 2020 2020 2020 2020 2020  was ".          
-00019140: 2020 2020 2020 2020 2020 2261 6c73 6f20            "also 
-00019150: 7072 6f76 6964 6564 2e20 4966 2070 726f  provided. If pro
-00019160: 7669 6469 6e67 2062 6f74 682c 2066 756e  viding both, fun
-00019170: 6320 7368 6f75 6c64 2062 6520 6120 7265  c should be a re
-00019180: 6775 6c61 7220 220a 2020 2020 2020 2020  gular ".        
-00019190: 2020 2020 2020 2020 2020 2020 2266 756e              "fun
-000191a0: 6374 696f 6e20 746f 2061 766f 6964 2061  ction to avoid a
-000191b0: 6d62 6967 7569 7479 2e22 0a20 2020 2020  mbiguity.".     
-000191c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000191d0: 2020 2020 2020 2020 2073 656c 662e 6166           self.af
-000191e0: 756e 6320 3d20 6675 6e63 0a20 2020 2020  unc = func.     
-000191f0: 2020 2020 2020 2066 756e 635f 666f 725f         func_for_
-00019200: 6e61 6d65 203d 2066 756e 630a 2020 2020  name = func.    
-00019210: 2020 2020 656c 6966 2063 616c 6c61 626c      elif callabl
-00019220: 6528 6675 6e63 293a 0a20 2020 2020 2020  e(func):.       
-00019230: 2020 2020 2073 656c 662e 6675 6e63 203d       self.func =
-00019240: 2063 6173 7428 4361 6c6c 6162 6c65 5b5b   cast(Callable[[
-00019250: 496e 7075 745d 2c20 4f75 7470 7574 5d2c  Input], Output],
-00019260: 2066 756e 6329 0a20 2020 2020 2020 2020   func).         
-00019270: 2020 2066 756e 635f 666f 725f 6e61 6d65     func_for_name
-00019280: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
-00019290: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000192a0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-000192b0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000192c0: 2020 2022 4578 7065 6374 6564 2061 2063     "Expected a c
-000192d0: 616c 6c61 626c 6520 7479 7065 2066 6f72  allable type for
-000192e0: 2060 6675 6e63 602e 220a 2020 2020 2020   `func`.".      
-000192f0: 2020 2020 2020 2020 2020 6622 496e 7374            f"Inst
-00019300: 6561 6420 676f 7420 616e 2075 6e73 7570  ead got an unsup
-00019310: 706f 7274 6564 2074 7970 653a 207b 7479  ported type: {ty
-00019320: 7065 2866 756e 6329 7d22 0a20 2020 2020  pe(func)}".     
-00019330: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00019340: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00019350: 2020 2069 6620 6e61 6d65 2069 7320 6e6f     if name is no
-00019360: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00019370: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-00019380: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-00019390: 2020 2020 2065 6c69 6620 6675 6e63 5f66       elif func_f
-000193a0: 6f72 5f6e 616d 652e 5f5f 6e61 6d65 5f5f  or_name.__name__
-000193b0: 2021 3d20 223c 6c61 6d62 6461 3e22 3a0a   != "<lambda>":.
-000193c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193d0: 7365 6c66 2e6e 616d 6520 3d20 6675 6e63  self.name = func
-000193e0: 5f66 6f72 5f6e 616d 652e 5f5f 6e61 6d65  _for_name.__name
-000193f0: 5f5f 0a20 2020 2020 2020 2065 7863 6570  __.        excep
-00019400: 7420 4174 7472 6962 7574 6545 7272 6f72  t AttributeError
-00019410: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-00019420: 7373 0a0a 2020 2020 4070 726f 7065 7274  ss..    @propert
-00019430: 790a 2020 2020 6465 6620 496e 7075 7454  y.    def InputT
-00019440: 7970 6528 7365 6c66 2920 2d3e 2041 6e79  ype(self) -> Any
-00019450: 3a0a 2020 2020 2020 2020 2222 2254 6865  :.        """The
-00019460: 2074 7970 6520 6f66 2074 6865 2069 6e70   type of the inp
-00019470: 7574 2074 6f20 7468 6973 2072 756e 6e61  ut to this runna
-00019480: 626c 652e 2222 220a 2020 2020 2020 2020  ble.""".        
-00019490: 6675 6e63 203d 2067 6574 6174 7472 2873  func = getattr(s
-000194a0: 656c 662c 2022 6675 6e63 222c 204e 6f6e  elf, "func", Non
-000194b0: 6529 206f 7220 6765 7461 7474 7228 7365  e) or getattr(se
-000194c0: 6c66 2c20 2261 6675 6e63 2229 0a20 2020  lf, "afunc").   
-000194d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000194e0: 2020 2020 2020 7061 7261 6d73 203d 2069        params = i
-000194f0: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
-00019500: 2866 756e 6329 2e70 6172 616d 6574 6572  (func).parameter
-00019510: 730a 2020 2020 2020 2020 2020 2020 6669  s.            fi
-00019520: 7273 745f 7061 7261 6d20 3d20 6e65 7874  rst_param = next
-00019530: 2869 7465 7228 7061 7261 6d73 2e76 616c  (iter(params.val
-00019540: 7565 7328 2929 2c20 4e6f 6e65 290a 2020  ues()), None).  
-00019550: 2020 2020 2020 2020 2020 6966 2066 6972            if fir
-00019560: 7374 5f70 6172 616d 2061 6e64 2066 6972  st_param and fir
-00019570: 7374 5f70 6172 616d 2e61 6e6e 6f74 6174  st_param.annotat
-00019580: 696f 6e20 213d 2069 6e73 7065 6374 2e50  ion != inspect.P
-00019590: 6172 616d 6574 6572 2e65 6d70 7479 3a0a  arameter.empty:.
-000195a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195b0: 7265 7475 726e 2066 6972 7374 5f70 6172  return first_par
-000195c0: 616d 2e61 6e6e 6f74 6174 696f 6e0a 2020  am.annotation.  
-000195d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000195e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195f0: 7265 7475 726e 2041 6e79 0a20 2020 2020  return Any.     
-00019600: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
-00019610: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00019620: 2020 7265 7475 726e 2041 6e79 0a0a 2020    return Any..  
-00019630: 2020 6465 6620 6765 745f 696e 7075 745f    def get_input_
-00019640: 7363 6865 6d61 280a 2020 2020 2020 2020  schema(.        
-00019650: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
-00019660: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-00019670: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
-00019680: 2020 2920 2d3e 2054 7970 655b 4261 7365    ) -> Type[Base
-00019690: 4d6f 6465 6c5d 3a0a 2020 2020 2020 2020  Model]:.        
-000196a0: 2222 2254 6865 2070 7964 616e 7469 6320  """The pydantic 
-000196b0: 7363 6865 6d61 2066 6f72 2074 6865 2069  schema for the i
-000196c0: 6e70 7574 2074 6f20 7468 6973 2072 756e  nput to this run
-000196d0: 6e61 626c 652e 2222 220a 2020 2020 2020  nable.""".      
-000196e0: 2020 6675 6e63 203d 2067 6574 6174 7472    func = getattr
-000196f0: 2873 656c 662c 2022 6675 6e63 222c 204e  (self, "func", N
-00019700: 6f6e 6529 206f 7220 6765 7461 7474 7228  one) or getattr(
-00019710: 7365 6c66 2c20 2261 6675 6e63 2229 0a0a  self, "afunc")..
-00019720: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00019730: 7461 6e63 6528 6675 6e63 2c20 6974 656d  tance(func, item
-00019740: 6765 7474 6572 293a 0a20 2020 2020 2020  getter):.       
-00019750: 2020 2020 2023 2054 6869 7320 6973 2074       # This is t
-00019760: 6572 7269 626c 652c 2062 7574 2061 6661  errible, but afa
-00019770: 6963 7420 6974 2773 206e 6f74 2070 6f73  ict it's not pos
-00019780: 7369 626c 6520 746f 2061 6363 6573 7320  sible to access 
-00019790: 5f69 7465 6d73 0a20 2020 2020 2020 2020  _items.         
-000197a0: 2020 2023 206f 6e20 6974 656d 6765 7474     # on itemgett
-000197b0: 6572 206f 626a 6563 7473 2c20 736f 2077  er objects, so w
-000197c0: 6520 6861 7665 2074 6f20 7061 7273 6520  e have to parse 
-000197d0: 7468 6520 7265 7072 0a20 2020 2020 2020  the repr.       
-000197e0: 2020 2020 2069 7465 6d73 203d 2073 7472       items = str
-000197f0: 2866 756e 6329 2e72 6570 6c61 6365 2822  (func).replace("
-00019800: 6f70 6572 6174 6f72 2e69 7465 6d67 6574  operator.itemget
-00019810: 7465 7228 222c 2022 2229 5b3a 2d31 5d2e  ter(", "")[:-1].
-00019820: 7370 6c69 7428 222c 2022 290a 2020 2020  split(", ").    
-00019830: 2020 2020 2020 2020 6966 2061 6c6c 280a          if all(.
-00019840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019850: 6974 656d 5b30 5d20 3d3d 2022 2722 2061  item[0] == "'" a
-00019860: 6e64 2069 7465 6d5b 2d31 5d20 3d3d 2022  nd item[-1] == "
-00019870: 2722 2061 6e64 206c 656e 2869 7465 6d29  '" and len(item)
-00019880: 203e 2032 2066 6f72 2069 7465 6d20 696e   > 2 for item in
-00019890: 2069 7465 6d73 0a20 2020 2020 2020 2020   items.         
-000198a0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-000198b0: 2020 2020 2020 2320 4974 2773 2061 2064        # It's a d
-000198c0: 6963 742c 206c 6f6c 0a20 2020 2020 2020  ict, lol.       
-000198d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000198e0: 6372 6561 7465 5f6d 6f64 656c 280a 2020  create_model(.  
-000198f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019900: 2020 7365 6c66 2e67 6574 5f6e 616d 6528    self.get_name(
-00019910: 2249 6e70 7574 2229 2c0a 2020 2020 2020  "Input"),.      
-00019920: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-00019930: 7b69 7465 6d5b 313a 2d31 5d3a 2028 416e  {item[1:-1]: (An
-00019940: 792c 204e 6f6e 6529 2066 6f72 2069 7465  y, None) for ite
-00019950: 6d20 696e 2069 7465 6d73 7d2c 2020 2320  m in items},  # 
-00019960: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00019970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019980: 205f 5f63 6f6e 6669 675f 5f3d 5f53 6368   __config__=_Sch
-00019990: 656d 6143 6f6e 6669 672c 0a20 2020 2020  emaConfig,.     
-000199a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000199b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000199c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000199d0: 6574 7572 6e20 6372 6561 7465 5f6d 6f64  eturn create_mod
-000199e0: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-000199f0: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
-00019a00: 5f6e 616d 6528 2249 6e70 7574 2229 2c0a  _name("Input"),.
-00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a20: 2020 2020 5f5f 726f 6f74 5f5f 3d28 4c69      __root__=(Li
-00019a30: 7374 5b41 6e79 5d2c 204e 6f6e 6529 2c0a  st[Any], None),.
-00019a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a50: 2020 2020 5f5f 636f 6e66 6967 5f5f 3d5f      __config__=_
-00019a60: 5363 6865 6d61 436f 6e66 6967 2c0a 2020  SchemaConfig,.  
-00019a70: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00019a80: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00019a90: 2e49 6e70 7574 5479 7065 2021 3d20 416e  .InputType != An
-00019aa0: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-00019ab0: 6574 7572 6e20 7375 7065 7228 292e 6765  eturn super().ge
-00019ac0: 745f 696e 7075 745f 7363 6865 6d61 2863  t_input_schema(c
-00019ad0: 6f6e 6669 6729 0a0a 2020 2020 2020 2020  onfig)..        
-00019ae0: 6966 2064 6963 745f 6b65 7973 203a 3d20  if dict_keys := 
-00019af0: 6765 745f 6675 6e63 7469 6f6e 5f66 6972  get_function_fir
-00019b00: 7374 5f61 7267 5f64 6963 745f 6b65 7973  st_arg_dict_keys
-00019b10: 2866 756e 6329 3a0a 2020 2020 2020 2020  (func):.        
-00019b20: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
-00019b30: 655f 6d6f 6465 6c28 0a20 2020 2020 2020  e_model(.       
-00019b40: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00019b50: 745f 6e61 6d65 2822 496e 7075 7422 292c  t_name("Input"),
-00019b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b70: 202a 2a7b 6b65 793a 2028 416e 792c 204e   **{key: (Any, N
-00019b80: 6f6e 6529 2066 6f72 206b 6579 2069 6e20  one) for key in 
-00019b90: 6469 6374 5f6b 6579 737d 2c20 2023 2074  dict_keys},  # t
-00019ba0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00019bb0: 2020 2020 2020 2020 2020 2020 5f5f 636f              __co
-00019bc0: 6e66 6967 5f5f 3d5f 5363 6865 6d61 436f  nfig__=_SchemaCo
-00019bd0: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
-00019be0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-00019bf0: 7572 6e20 7375 7065 7228 292e 6765 745f  urn super().get_
-00019c00: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
-00019c10: 6669 6729 0a0a 2020 2020 4070 726f 7065  fig)..    @prope
-00019c20: 7274 790a 2020 2020 6465 6620 4f75 7470  rty.    def Outp
-00019c30: 7574 5479 7065 2873 656c 6629 202d 3e20  utType(self) -> 
-00019c40: 416e 793a 0a20 2020 2020 2020 2022 2222  Any:.        """
-00019c50: 5468 6520 7479 7065 206f 6620 7468 6520  The type of the 
-00019c60: 6f75 7470 7574 206f 6620 7468 6973 2072  output of this r
-00019c70: 756e 6e61 626c 6520 6173 2061 2074 7970  unnable as a typ
-00019c80: 6520 616e 6e6f 7461 7469 6f6e 2e22 2222  e annotation."""
-00019c90: 0a20 2020 2020 2020 2066 756e 6320 3d20  .        func = 
-00019ca0: 6765 7461 7474 7228 7365 6c66 2c20 2266  getattr(self, "f
-00019cb0: 756e 6322 2c20 4e6f 6e65 2920 6f72 2067  unc", None) or g
-00019cc0: 6574 6174 7472 2873 656c 662c 2022 6166  etattr(self, "af
-00019cd0: 756e 6322 290a 2020 2020 2020 2020 7472  unc").        tr
-00019ce0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-00019cf0: 6967 203d 2069 6e73 7065 6374 2e73 6967  ig = inspect.sig
-00019d00: 6e61 7475 7265 2866 756e 6329 0a20 2020  nature(func).   
-00019d10: 2020 2020 2020 2020 2069 6620 7369 672e           if sig.
-00019d20: 7265 7475 726e 5f61 6e6e 6f74 6174 696f  return_annotatio
-00019d30: 6e20 213d 2069 6e73 7065 6374 2e53 6967  n != inspect.Sig
-00019d40: 6e61 7475 7265 2e65 6d70 7479 3a0a 2020  nature.empty:.  
-00019d50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00019d60: 756e 7772 6170 2069 7465 7261 746f 7220  unwrap iterator 
-00019d70: 7479 7065 730a 2020 2020 2020 2020 2020  types.          
-00019d80: 2020 2020 2020 6966 2067 6574 6174 7472        if getattr
-00019d90: 2873 6967 2e72 6574 7572 6e5f 616e 6e6f  (sig.return_anno
-00019da0: 7461 7469 6f6e 2c20 225f 5f6f 7269 6769  tation, "__origi
-00019db0: 6e5f 5f22 2c20 4e6f 6e65 2920 696e 2028  n__", None) in (
-00019dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019dd0: 2020 2020 2063 6f6c 6c65 6374 696f 6e73       collections
-00019de0: 2e61 6263 2e49 7465 7261 746f 722c 0a20  .abc.Iterator,. 
-00019df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e00: 2020 2063 6f6c 6c65 6374 696f 6e73 2e61     collections.a
-00019e10: 6263 2e41 7379 6e63 4974 6572 6174 6f72  bc.AsyncIterator
-00019e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019e30: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00019e40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00019e50: 6765 7461 7474 7228 7369 672e 7265 7475  getattr(sig.retu
-00019e60: 726e 5f61 6e6e 6f74 6174 696f 6e2c 2022  rn_annotation, "
-00019e70: 5f5f 6172 6773 5f5f 222c 2028 416e 792c  __args__", (Any,
-00019e80: 2929 5b30 5d0a 2020 2020 2020 2020 2020  ))[0].          
-00019e90: 2020 2020 2020 7265 7475 726e 2073 6967        return sig
-00019ea0: 2e72 6574 7572 6e5f 616e 6e6f 7461 7469  .return_annotati
-00019eb0: 6f6e 0a20 2020 2020 2020 2020 2020 2065  on.            e
-00019ec0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019ed0: 2020 2020 2072 6574 7572 6e20 416e 790a       return Any.
-00019ee0: 2020 2020 2020 2020 6578 6365 7074 2056          except V
-00019ef0: 616c 7565 4572 726f 723a 0a20 2020 2020  alueError:.     
-00019f00: 2020 2020 2020 2072 6574 7572 6e20 416e         return An
-00019f10: 790a 0a20 2020 2040 7072 6f70 6572 7479  y..    @property
-00019f20: 0a20 2020 2064 6566 2064 6570 7328 7365  .    def deps(se
-00019f30: 6c66 2920 2d3e 204c 6973 745b 5275 6e6e  lf) -> List[Runn
-00019f40: 6162 6c65 5d3a 0a20 2020 2020 2020 2022  able]:.        "
-00019f50: 2222 5468 6520 6465 7065 6e64 656e 6369  ""The dependenci
-00019f60: 6573 206f 6620 7468 6973 2072 756e 6e61  es of this runna
-00019f70: 626c 652e 2222 220a 2020 2020 2020 2020  ble.""".        
-00019f80: 6966 2068 6173 6174 7472 2873 656c 662c  if hasattr(self,
-00019f90: 2022 6675 6e63 2229 3a0a 2020 2020 2020   "func"):.      
-00019fa0: 2020 2020 2020 6f62 6a65 6374 7320 3d20        objects = 
-00019fb0: 6765 745f 6675 6e63 7469 6f6e 5f6e 6f6e  get_function_non
-00019fc0: 6c6f 6361 6c73 2873 656c 662e 6675 6e63  locals(self.func
-00019fd0: 290a 2020 2020 2020 2020 656c 6966 2068  ).        elif h
-00019fe0: 6173 6174 7472 2873 656c 662c 2022 6166  asattr(self, "af
-00019ff0: 756e 6322 293a 0a20 2020 2020 2020 2020  unc"):.         
-0001a000: 2020 206f 626a 6563 7473 203d 2067 6574     objects = get
-0001a010: 5f66 756e 6374 696f 6e5f 6e6f 6e6c 6f63  _function_nonloc
-0001a020: 616c 7328 7365 6c66 2e61 6675 6e63 290a  als(self.afunc).
-0001a030: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a040: 2020 2020 2020 2020 2020 6f62 6a65 6374            object
-0001a050: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
-0001a060: 7265 7475 726e 205b 6f62 6a20 666f 7220  return [obj for 
-0001a070: 6f62 6a20 696e 206f 626a 6563 7473 2069  obj in objects i
-0001a080: 6620 6973 696e 7374 616e 6365 286f 626a  f isinstance(obj
-0001a090: 2c20 5275 6e6e 6162 6c65 295d 0a0a 2020  , Runnable)]..  
-0001a0a0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-0001a0b0: 6465 6620 636f 6e66 6967 5f73 7065 6373  def config_specs
-0001a0c0: 2873 656c 6629 202d 3e20 4c69 7374 5b43  (self) -> List[C
-0001a0d0: 6f6e 6669 6775 7261 626c 6546 6965 6c64  onfigurableField
-0001a0e0: 5370 6563 5d3a 0a20 2020 2020 2020 2072  Spec]:.        r
-0001a0f0: 6574 7572 6e20 6765 745f 756e 6971 7565  eturn get_unique
-0001a100: 5f63 6f6e 6669 675f 7370 6563 7328 0a20  _config_specs(. 
-0001a110: 2020 2020 2020 2020 2020 2073 7065 6320             spec 
-0001a120: 666f 7220 6465 7020 696e 2073 656c 662e  for dep in self.
-0001a130: 6465 7073 2066 6f72 2073 7065 6320 696e  deps for spec in
-0001a140: 2064 6570 2e63 6f6e 6669 675f 7370 6563   dep.config_spec
-0001a150: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
-0001a160: 2064 6566 2067 6574 5f67 7261 7068 2873   def get_graph(s
-0001a170: 656c 662c 2063 6f6e 6669 673a 2052 756e  elf, config: Run
-0001a180: 6e61 626c 6543 6f6e 6669 6720 7c20 4e6f  nableConfig | No
-0001a190: 6e65 203d 204e 6f6e 6529 202d 3e20 4772  ne = None) -> Gr
-0001a1a0: 6170 683a 0a20 2020 2020 2020 2069 6620  aph:.        if 
-0001a1b0: 6465 7073 203a 3d20 7365 6c66 2e64 6570  deps := self.dep
-0001a1c0: 733a 0a20 2020 2020 2020 2020 2020 2067  s:.            g
-0001a1d0: 7261 7068 203d 2047 7261 7068 2829 0a20  raph = Graph(). 
-0001a1e0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-0001a1f0: 5f6e 6f64 6520 3d20 6772 6170 682e 6164  _node = graph.ad
-0001a200: 645f 6e6f 6465 2873 656c 662e 6765 745f  d_node(self.get_
-0001a210: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
-0001a220: 6669 6729 290a 2020 2020 2020 2020 2020  fig)).          
-0001a230: 2020 6f75 7470 7574 5f6e 6f64 6520 3d20    output_node = 
-0001a240: 6772 6170 682e 6164 645f 6e6f 6465 2873  graph.add_node(s
-0001a250: 656c 662e 6765 745f 6f75 7470 7574 5f73  elf.get_output_s
-0001a260: 6368 656d 6128 636f 6e66 6967 2929 0a20  chema(config)). 
-0001a270: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-0001a280: 6570 2069 6e20 6465 7073 3a0a 2020 2020  ep in deps:.    
-0001a290: 2020 2020 2020 2020 2020 2020 6465 705f              dep_
-0001a2a0: 6772 6170 6820 3d20 6465 702e 6765 745f  graph = dep.get_
-0001a2b0: 6772 6170 6828 290a 2020 2020 2020 2020  graph().        
-0001a2c0: 2020 2020 2020 2020 6465 705f 6772 6170          dep_grap
-0001a2d0: 682e 7472 696d 5f66 6972 7374 5f6e 6f64  h.trim_first_nod
-0001a2e0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0001a2f0: 2020 2020 6465 705f 6772 6170 682e 7472      dep_graph.tr
-0001a300: 696d 5f6c 6173 745f 6e6f 6465 2829 0a20  im_last_node(). 
-0001a310: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a320: 6620 6e6f 7420 6465 705f 6772 6170 683a  f not dep_graph:
-0001a330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a340: 2020 2020 2067 7261 7068 2e61 6464 5f65       graph.add_e
-0001a350: 6467 6528 696e 7075 745f 6e6f 6465 2c20  dge(input_node, 
-0001a360: 6f75 7470 7574 5f6e 6f64 6529 0a20 2020  output_node).   
-0001a370: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001a380: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001a390: 2020 2020 2020 2067 7261 7068 2e65 7874         graph.ext
-0001a3a0: 656e 6428 6465 705f 6772 6170 6829 0a20  end(dep_graph). 
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a3c0: 2020 2064 6570 5f66 6972 7374 5f6e 6f64     dep_first_nod
-0001a3d0: 6520 3d20 6465 705f 6772 6170 682e 6669  e = dep_graph.fi
-0001a3e0: 7273 745f 6e6f 6465 2829 0a20 2020 2020  rst_node().     
-0001a3f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a400: 6620 6e6f 7420 6465 705f 6669 7273 745f  f not dep_first_
-0001a410: 6e6f 6465 3a0a 2020 2020 2020 2020 2020  node:.          
-0001a420: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001a430: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0001a440: 2252 756e 6e61 626c 6520 7b64 6570 7d20  "Runnable {dep} 
-0001a450: 6861 7320 6e6f 2066 6972 7374 206e 6f64  has no first nod
-0001a460: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-0001a470: 2020 2020 2020 2020 6465 705f 6c61 7374          dep_last
-0001a480: 5f6e 6f64 6520 3d20 6465 705f 6772 6170  _node = dep_grap
-0001a490: 682e 6c61 7374 5f6e 6f64 6528 290a 2020  h.last_node().  
-0001a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4b0: 2020 6966 206e 6f74 2064 6570 5f6c 6173    if not dep_las
-0001a4c0: 745f 6e6f 6465 3a0a 2020 2020 2020 2020  t_node:.        
-0001a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0001a4f0: 2866 2252 756e 6e61 626c 6520 7b64 6570  (f"Runnable {dep
-0001a500: 7d20 6861 7320 6e6f 206c 6173 7420 6e6f  } has no last no
-0001a510: 6465 2229 0a20 2020 2020 2020 2020 2020  de").           
-0001a520: 2020 2020 2020 2020 2067 7261 7068 2e61           graph.a
-0001a530: 6464 5f65 6467 6528 696e 7075 745f 6e6f  dd_edge(input_no
-0001a540: 6465 2c20 6465 705f 6669 7273 745f 6e6f  de, dep_first_no
-0001a550: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
-0001a560: 2020 2020 2020 2020 6772 6170 682e 6164          graph.ad
-0001a570: 645f 6564 6765 2864 6570 5f6c 6173 745f  d_edge(dep_last_
-0001a580: 6e6f 6465 2c20 6f75 7470 7574 5f6e 6f64  node, output_nod
-0001a590: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
-0001a5a0: 0a20 2020 2020 2020 2020 2020 2067 7261  .            gra
-0001a5b0: 7068 203d 2073 7570 6572 2829 2e67 6574  ph = super().get
-0001a5c0: 5f67 7261 7068 2863 6f6e 6669 6729 0a0a  _graph(config)..
-0001a5d0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0001a5e0: 7261 7068 0a0a 2020 2020 6465 6620 5f5f  raph..    def __
-0001a5f0: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
-0001a600: 3a20 416e 7929 202d 3e20 626f 6f6c 3a0a  : Any) -> bool:.
-0001a610: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001a620: 7461 6e63 6528 6f74 6865 722c 2052 756e  tance(other, Run
-0001a630: 6e61 626c 654c 616d 6264 6129 3a0a 2020  nableLambda):.  
-0001a640: 2020 2020 2020 2020 2020 6966 2068 6173            if has
-0001a650: 6174 7472 2873 656c 662c 2022 6675 6e63  attr(self, "func
-0001a660: 2229 2061 6e64 2068 6173 6174 7472 286f  ") and hasattr(o
-0001a670: 7468 6572 2c20 2266 756e 6322 293a 0a20  ther, "func"):. 
-0001a680: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001a690: 6574 7572 6e20 7365 6c66 2e66 756e 6320  eturn self.func 
-0001a6a0: 3d3d 206f 7468 6572 2e66 756e 630a 2020  == other.func.  
-0001a6b0: 2020 2020 2020 2020 2020 656c 6966 2068            elif h
-0001a6c0: 6173 6174 7472 2873 656c 662c 2022 6166  asattr(self, "af
-0001a6d0: 756e 6322 2920 616e 6420 6861 7361 7474  unc") and hasatt
-0001a6e0: 7228 6f74 6865 722c 2022 6166 756e 6322  r(other, "afunc"
-0001a6f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001a700: 2020 2072 6574 7572 6e20 7365 6c66 2e61     return self.a
-0001a710: 6675 6e63 203d 3d20 6f74 6865 722e 6166  func == other.af
-0001a720: 756e 630a 2020 2020 2020 2020 2020 2020  unc.            
-0001a730: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a740: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0001a750: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-0001a760: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a770: 7572 6e20 4661 6c73 650a 0a20 2020 2064  urn False..    d
-0001a780: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-0001a790: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0001a7a0: 2020 2222 2241 2073 7472 696e 6720 7265    """A string re
-0001a7b0: 7072 6573 656e 7461 7469 6f6e 206f 6620  presentation of 
-0001a7c0: 7468 6973 2072 756e 6e61 626c 652e 2222  this runnable.""
-0001a7d0: 220a 2020 2020 2020 2020 6966 2068 6173  ".        if has
-0001a7e0: 6174 7472 2873 656c 662c 2022 6675 6e63  attr(self, "func
-0001a7f0: 2229 2061 6e64 2069 7369 6e73 7461 6e63  ") and isinstanc
-0001a800: 6528 7365 6c66 2e66 756e 632c 2069 7465  e(self.func, ite
-0001a810: 6d67 6574 7465 7229 3a0a 2020 2020 2020  mgetter):.      
-0001a820: 2020 2020 2020 7265 7475 726e 2066 2252        return f"R
-0001a830: 756e 6e61 626c 654c 616d 6264 6128 7b73  unnableLambda({s
-0001a840: 7472 2873 656c 662e 6675 6e63 295b 6c65  tr(self.func)[le
-0001a850: 6e28 276f 7065 7261 746f 722e 2729 3a5d  n('operator.'):]
-0001a860: 7d29 220a 2020 2020 2020 2020 656c 6966  })".        elif
-0001a870: 2068 6173 6174 7472 2873 656c 662c 2022   hasattr(self, "
-0001a880: 6675 6e63 2229 3a0a 2020 2020 2020 2020  func"):.        
-0001a890: 2020 2020 7265 7475 726e 2066 2252 756e      return f"Run
-0001a8a0: 6e61 626c 654c 616d 6264 6128 7b67 6574  nableLambda({get
-0001a8b0: 5f6c 616d 6264 615f 736f 7572 6365 2873  _lambda_source(s
-0001a8c0: 656c 662e 6675 6e63 2920 6f72 2027 2e2e  elf.func) or '..
-0001a8d0: 2e27 7d29 220a 2020 2020 2020 2020 656c  .'})".        el
-0001a8e0: 6966 2068 6173 6174 7472 2873 656c 662c  if hasattr(self,
-0001a8f0: 2022 6166 756e 6322 293a 0a20 2020 2020   "afunc"):.     
-0001a900: 2020 2020 2020 2072 6574 7572 6e20 6622         return f"
-0001a910: 5275 6e6e 6162 6c65 4c61 6d62 6461 2861  RunnableLambda(a
-0001a920: 6675 6e63 3d7b 6765 745f 6c61 6d62 6461  func={get_lambda
-0001a930: 5f73 6f75 7263 6528 7365 6c66 2e61 6675  _source(self.afu
-0001a940: 6e63 2920 6f72 2027 2e2e 2e27 7d29 220a  nc) or '...'})".
-0001a950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a960: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001a970: 2022 5275 6e6e 6162 6c65 4c61 6d62 6461   "RunnableLambda
-0001a980: 282e 2e2e 2922 0a0a 2020 2020 6465 6620  (...)"..    def 
-0001a990: 5f69 6e76 6f6b 6528 0a20 2020 2020 2020  _invoke(.       
-0001a9a0: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
-0001a9b0: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
-0001a9c0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-0001a9d0: 3a20 4361 6c6c 6261 636b 4d61 6e61 6765  : CallbackManage
-0001a9e0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-0001a9f0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-0001aa00: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-0001aa10: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001aa20: 416e 792c 0a20 2020 2029 202d 3e20 4f75  Any,.    ) -> Ou
-0001aa30: 7470 7574 3a0a 2020 2020 2020 2020 6966  tput:.        if
-0001aa40: 2069 6e73 7065 6374 2e69 7367 656e 6572   inspect.isgener
-0001aa50: 6174 6f72 6675 6e63 7469 6f6e 2873 656c  atorfunction(sel
-0001aa60: 662e 6675 6e63 293a 0a20 2020 2020 2020  f.func):.       
-0001aa70: 2020 2020 206f 7574 7075 743a 204f 7074       output: Opt
-0001aa80: 696f 6e61 6c5b 4f75 7470 7574 5d20 3d20  ional[Output] = 
-0001aa90: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0001aaa0: 2066 6f72 2063 6875 6e6b 2069 6e20 6361   for chunk in ca
-0001aab0: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
-0001aac0: 6961 626c 655f 6172 6773 280a 2020 2020  iable_args(.    
-0001aad0: 2020 2020 2020 2020 2020 2020 6361 7374              cast
-0001aae0: 2843 616c 6c61 626c 655b 5b49 6e70 7574  (Callable[[Input
-0001aaf0: 5d2c 2049 7465 7261 746f 725b 4f75 7470  ], Iterator[Outp
-0001ab00: 7574 5d5d 2c20 7365 6c66 2e66 756e 6329  ut]], self.func)
-0001ab10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ab20: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-0001ab30: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
-0001ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ab50: 2072 756e 5f6d 616e 6167 6572 2c0a 2020   run_manager,.  
-0001ab60: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-0001ab70: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-0001ab80: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0001ab90: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
-0001aba0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001abb0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0001abc0: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
-0001abd0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001abe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001abf0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 2020 6f75 7470 7574 203d 206f 7574      output = out
-0001ac20: 7075 7420 2b20 6368 756e 6b20 2023 2074  put + chunk  # t
-0001ac30: 7970 653a 2069 676e 6f72 655b 6f70 6572  ype: ignore[oper
-0001ac40: 6174 6f72 5d0a 2020 2020 2020 2020 2020  ator].          
-0001ac50: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001ac60: 2054 7970 6545 7272 6f72 3a0a 2020 2020   TypeError:.    
-0001ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac80: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
-0001ac90: 6e6b 0a20 2020 2020 2020 2065 6c73 653a  nk.        else:
-0001aca0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001acb0: 7075 7420 3d20 6361 6c6c 5f66 756e 635f  put = call_func_
-0001acc0: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
-0001acd0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001ace0: 2020 2020 7365 6c66 2e66 756e 632c 2069      self.func, i
-0001acf0: 6e70 7574 2c20 636f 6e66 6967 2c20 7275  nput, config, ru
-0001ad00: 6e5f 6d61 6e61 6765 722c 202a 2a6b 7761  n_manager, **kwa
-0001ad10: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
-0001ad20: 290a 2020 2020 2020 2020 2320 4966 2074  ).        # If t
-0001ad30: 6865 206f 7574 7075 7420 6973 2061 2072  he output is a r
-0001ad40: 756e 6e61 626c 652c 2069 6e76 6f6b 6520  unnable, invoke 
-0001ad50: 6974 0a20 2020 2020 2020 2069 6620 6973  it.        if is
-0001ad60: 696e 7374 616e 6365 286f 7574 7075 742c  instance(output,
-0001ad70: 2052 756e 6e61 626c 6529 3a0a 2020 2020   Runnable):.    
-0001ad80: 2020 2020 2020 2020 7265 6375 7273 696f          recursio
-0001ad90: 6e5f 6c69 6d69 7420 3d20 636f 6e66 6967  n_limit = config
-0001ada0: 5b22 7265 6375 7273 696f 6e5f 6c69 6d69  ["recursion_limi
-0001adb0: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
-0001adc0: 6966 2072 6563 7572 7369 6f6e 5f6c 696d  if recursion_lim
-0001add0: 6974 203c 3d20 303a 0a20 2020 2020 2020  it <= 0:.       
-0001ade0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-0001adf0: 6563 7572 7369 6f6e 4572 726f 7228 0a20  ecursionError(. 
-0001ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae10: 2020 2066 2252 6563 7572 7369 6f6e 206c     f"Recursion l
-0001ae20: 696d 6974 2072 6561 6368 6564 2077 6865  imit reached whe
-0001ae30: 6e20 696e 766f 6b69 6e67 207b 7365 6c66  n invoking {self
-0001ae40: 7d20 7769 7468 2069 6e70 7574 207b 696e  } with input {in
-0001ae50: 7075 747d 2e22 0a20 2020 2020 2020 2020  put}.".         
-0001ae60: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001ae70: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
-0001ae80: 7470 7574 2e69 6e76 6f6b 6528 0a20 2020  tput.invoke(.   
-0001ae90: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-0001aea0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-0001aeb0: 2020 2020 7061 7463 685f 636f 6e66 6967      patch_config
-0001aec0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001aed0: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-0001aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aef0: 2020 6361 6c6c 6261 636b 733d 7275 6e5f    callbacks=run_
-0001af00: 6d61 6e61 6765 722e 6765 745f 6368 696c  manager.get_chil
-0001af10: 6428 292c 0a20 2020 2020 2020 2020 2020  d(),.           
-0001af20: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
-0001af30: 6f6e 5f6c 696d 6974 3d72 6563 7572 7369  on_limit=recursi
-0001af40: 6f6e 5f6c 696d 6974 202d 2031 2c0a 2020  on_limit - 1,.  
-0001af50: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-0001af60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001af70: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-0001af80: 7374 284f 7574 7075 742c 206f 7574 7075  st(Output, outpu
-0001af90: 7429 0a0a 2020 2020 6173 796e 6320 6465  t)..    async de
-0001afa0: 6620 5f61 696e 766f 6b65 280a 2020 2020  f _ainvoke(.    
-0001afb0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0001afc0: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
-0001afd0: 2020 2020 2020 2020 7275 6e5f 6d61 6e61          run_mana
-0001afe0: 6765 723a 2041 7379 6e63 4361 6c6c 6261  ger: AsyncCallba
-0001aff0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-0001b000: 6e52 756e 2c0a 2020 2020 2020 2020 636f  nRun,.        co
-0001b010: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
-0001b020: 6e66 6967 2c0a 2020 2020 2020 2020 2a2a  nfig,.        **
-0001b030: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-0001b040: 2029 202d 3e20 4f75 7470 7574 3a0a 2020   ) -> Output:.  
-0001b050: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
-0001b060: 2873 656c 662c 2022 6166 756e 6322 293a  (self, "afunc"):
-0001b070: 0a20 2020 2020 2020 2020 2020 2061 6675  .            afu
-0001b080: 6e63 203d 2073 656c 662e 6166 756e 630a  nc = self.afunc.
-0001b090: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001b0a0: 2020 2020 2020 2020 2020 6966 2069 6e73            if ins
-0001b0b0: 7065 6374 2e69 7367 656e 6572 6174 6f72  pect.isgenerator
-0001b0c0: 6675 6e63 7469 6f6e 2873 656c 662e 6675  function(self.fu
-0001b0d0: 6e63 293a 0a0a 2020 2020 2020 2020 2020  nc):..          
-0001b0e0: 2020 2020 2020 6465 6620 6675 6e63 280a        def func(.
-0001b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b100: 2020 2020 696e 7075 743a 2049 6e70 7574      input: Input
-0001b110: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b120: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
-0001b130: 723a 2041 7379 6e63 4361 6c6c 6261 636b  r: AsyncCallback
-0001b140: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
-0001b150: 756e 2c0a 2020 2020 2020 2020 2020 2020  un,.            
-0001b160: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-0001b170: 5275 6e6e 6162 6c65 436f 6e66 6967 2c0a  RunnableConfig,.
-0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b190: 2920 2d3e 204f 7574 7075 743a 0a20 2020  ) -> Output:.   
-0001b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1b0: 206f 7574 7075 743a 204f 7074 696f 6e61   output: Optiona
-0001b1c0: 6c5b 4f75 7470 7574 5d20 3d20 4e6f 6e65  l[Output] = None
-0001b1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b1e0: 2020 2020 2066 6f72 2063 6875 6e6b 2069       for chunk i
-0001b1f0: 6e20 6361 6c6c 5f66 756e 635f 7769 7468  n call_func_with
-0001b200: 5f76 6172 6961 626c 655f 6172 6773 280a  _variable_args(.
-0001b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b220: 2020 2020 2020 2020 6361 7374 2843 616c          cast(Cal
-0001b230: 6c61 626c 655b 5b49 6e70 7574 5d2c 2049  lable[[Input], I
-0001b240: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
-0001b250: 2c20 7365 6c66 2e66 756e 6329 2c0a 2020  , self.func),.  
-0001b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b270: 2020 2020 2020 696e 7075 742c 0a20 2020        input,.   
-0001b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b290: 2020 2020 2063 6f6e 6669 672c 0a20 2020       config,.   
-0001b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2b0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-0001b2c0: 2e67 6574 5f73 796e 6328 292c 0a20 2020  .get_sync(),.   
-0001b2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2e0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0001b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b300: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0001b310: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001b320: 206f 7574 7075 7420 6973 204e 6f6e 653a   output is None:
-0001b330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b340: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0001b350: 7075 7420 3d20 6368 756e 6b0a 2020 2020  put = chunk.    
-0001b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b370: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b390: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3b0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0001b3c0: 7420 3d20 6f75 7470 7574 202b 2063 6875  t = output + chu
-0001b3d0: 6e6b 2020 2320 7479 7065 3a20 6967 6e6f  nk  # type: igno
-0001b3e0: 7265 5b6f 7065 7261 746f 725d 0a20 2020  re[operator].   
-0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b400: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0001b410: 5479 7065 4572 726f 723a 0a20 2020 2020  TypeError:.     
-0001b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b430: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0001b440: 7420 3d20 6368 756e 6b0a 2020 2020 2020  t = chunk.      
-0001b450: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001b460: 7475 726e 2063 6173 7428 4f75 7470 7574  turn cast(Output
-0001b470: 2c20 6f75 7470 7574 290a 0a20 2020 2020  , output)..     
-0001b480: 2020 2020 2020 2065 6c73 653a 0a0a 2020         else:..  
-0001b490: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0001b4a0: 6620 6675 6e63 280a 2020 2020 2020 2020  f func(.        
-0001b4b0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
-0001b4c0: 743a 2049 6e70 7574 2c0a 2020 2020 2020  t: Input,.      
-0001b4d0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
-0001b4e0: 6e5f 6d61 6e61 6765 723a 2041 7379 6e63  n_manager: Async
-0001b4f0: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
-0001b500: 6f72 4368 6169 6e52 756e 2c0a 2020 2020  orChainRun,.    
-0001b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b520: 636f 6e66 6967 3a20 5275 6e6e 6162 6c65  config: Runnable
-0001b530: 436f 6e66 6967 2c0a 2020 2020 2020 2020  Config,.        
-0001b540: 2020 2020 2020 2020 2920 2d3e 204f 7574          ) -> Out
-0001b550: 7075 743a 0a20 2020 2020 2020 2020 2020  put:.           
-0001b560: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b570: 6361 6c6c 5f66 756e 635f 7769 7468 5f76  call_func_with_v
-0001b580: 6172 6961 626c 655f 6172 6773 280a 2020  ariable_args(.  
-0001b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b5a0: 2020 2020 2020 7365 6c66 2e66 756e 632c        self.func,
-0001b5b0: 2069 6e70 7574 2c20 636f 6e66 6967 2c20   input, config, 
-0001b5c0: 7275 6e5f 6d61 6e61 6765 722e 6765 745f  run_manager.get_
-0001b5d0: 7379 6e63 2829 2c20 2a2a 6b77 6172 6773  sync(), **kwargs
-0001b5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b5f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001b600: 2020 2020 4077 7261 7073 2866 756e 6329      @wraps(func)
-0001b610: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
-0001b620: 6e63 2064 6566 2066 282a 6172 6773 2c20  nc def f(*args, 
-0001b630: 2a2a 6b77 6172 6773 293a 2020 2320 7479  **kwargs):  # ty
-0001b640: 7065 3a20 6967 6e6f 7265 5b6e 6f2d 756e  pe: ignore[no-un
-0001b650: 7479 7065 642d 6465 665d 0a20 2020 2020  typed-def].     
-0001b660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001b670: 6e20 6177 6169 7420 7275 6e5f 696e 5f65  n await run_in_e
-0001b680: 7865 6375 746f 7228 636f 6e66 6967 2c20  xecutor(config, 
-0001b690: 6675 6e63 2c20 2a61 7267 732c 202a 2a6b  func, *args, **k
-0001b6a0: 7761 7267 7329 0a0a 2020 2020 2020 2020  wargs)..        
-0001b6b0: 2020 2020 6166 756e 6320 3d20 660a 0a20      afunc = f.. 
-0001b6c0: 2020 2020 2020 2069 6620 696e 7370 6563         if inspec
-0001b6d0: 742e 6973 6173 796e 6367 656e 6675 6e63  t.isasyncgenfunc
-0001b6e0: 7469 6f6e 2861 6675 6e63 293a 0a20 2020  tion(afunc):.   
-0001b6f0: 2020 2020 2020 2020 206f 7574 7075 743a           output:
-0001b700: 204f 7074 696f 6e61 6c5b 4f75 7470 7574   Optional[Output
-0001b710: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-0001b720: 2020 2020 2061 7379 6e63 2066 6f72 2063       async for c
-0001b730: 6875 6e6b 2069 6e20 6361 7374 280a 2020  hunk in cast(.  
-0001b740: 2020 2020 2020 2020 2020 2020 2020 4173                As
-0001b750: 796e 6349 7465 7261 746f 725b 4f75 7470  yncIterator[Outp
-0001b760: 7574 5d2c 0a20 2020 2020 2020 2020 2020  ut],.           
-0001b770: 2020 2020 2061 6361 6c6c 5f66 756e 635f       acall_func_
-0001b780: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
-0001b790: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001b7a0: 2020 2020 2020 2020 6361 7374 2843 616c          cast(Cal
-0001b7b0: 6c61 626c 652c 2061 6675 6e63 292c 0a20  lable, afunc),. 
-0001b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7d0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001b7f0: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
-0001b800: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
-0001b810: 6e61 6765 722c 0a20 2020 2020 2020 2020  nager,.         
-0001b820: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-0001b830: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
-0001b840: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0001b850: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0001b860: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
-0001b870: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001b880: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0001b890: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
-0001b8a0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001b8b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001b8c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8e0: 2020 2020 6f75 7470 7574 203d 206f 7574      output = out
-0001b8f0: 7075 7420 2b20 6368 756e 6b20 2023 2074  put + chunk  # t
-0001b900: 7970 653a 2069 676e 6f72 655b 6f70 6572  ype: ignore[oper
-0001b910: 6174 6f72 5d0a 2020 2020 2020 2020 2020  ator].          
-0001b920: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001b930: 2054 7970 6545 7272 6f72 3a0a 2020 2020   TypeError:.    
-0001b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b950: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
-0001b960: 6e6b 0a20 2020 2020 2020 2065 6c73 653a  nk.        else:
-0001b970: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001b980: 7075 7420 3d20 6177 6169 7420 6163 616c  put = await acal
-0001b990: 6c5f 6675 6e63 5f77 6974 685f 7661 7269  l_func_with_vari
-0001b9a0: 6162 6c65 5f61 7267 7328 0a20 2020 2020  able_args(.     
-0001b9b0: 2020 2020 2020 2020 2020 2063 6173 7428             cast(
-0001b9c0: 4361 6c6c 6162 6c65 2c20 6166 756e 6329  Callable, afunc)
-0001b9d0: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
-0001b9e0: 2072 756e 5f6d 616e 6167 6572 2c20 2a2a   run_manager, **
-0001b9f0: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
-0001ba00: 2020 2029 0a20 2020 2020 2020 2023 2049     ).        # I
-0001ba10: 6620 7468 6520 6f75 7470 7574 2069 7320  f the output is 
-0001ba20: 6120 7275 6e6e 6162 6c65 2c20 696e 766f  a runnable, invo
-0001ba30: 6b65 2069 740a 2020 2020 2020 2020 6966  ke it.        if
-0001ba40: 2069 7369 6e73 7461 6e63 6528 6f75 7470   isinstance(outp
-0001ba50: 7574 2c20 5275 6e6e 6162 6c65 293a 0a20  ut, Runnable):. 
-0001ba60: 2020 2020 2020 2020 2020 2072 6563 7572             recur
-0001ba70: 7369 6f6e 5f6c 696d 6974 203d 2063 6f6e  sion_limit = con
-0001ba80: 6669 675b 2272 6563 7572 7369 6f6e 5f6c  fig["recursion_l
-0001ba90: 696d 6974 225d 0a20 2020 2020 2020 2020  imit"].         
-0001baa0: 2020 2069 6620 7265 6375 7273 696f 6e5f     if recursion_
-0001bab0: 6c69 6d69 7420 3c3d 2030 3a0a 2020 2020  limit <= 0:.    
-0001bac0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001bad0: 6520 5265 6375 7273 696f 6e45 7272 6f72  e RecursionError
-0001bae0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001baf0: 2020 2020 2020 6622 5265 6375 7273 696f        f"Recursio
-0001bb00: 6e20 6c69 6d69 7420 7265 6163 6865 6420  n limit reached 
-0001bb10: 7768 656e 2069 6e76 6f6b 696e 6720 7b73  when invoking {s
-0001bb20: 656c 667d 2077 6974 6820 696e 7075 7420  elf} with input 
-0001bb30: 7b69 6e70 7574 7d2e 220a 2020 2020 2020  {input}.".      
-0001bb40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001bb50: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-0001bb60: 2061 7761 6974 206f 7574 7075 742e 6169   await output.ai
-0001bb70: 6e76 6f6b 6528 0a20 2020 2020 2020 2020  nvoke(.         
-0001bb80: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
-0001bb90: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0001bba0: 7463 685f 636f 6e66 6967 280a 2020 2020  tch_config(.    
-0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbc0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-0001bbd0: 2020 2020 2020 2020 2020 2020 6361 6c6c              call
-0001bbe0: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
-0001bbf0: 722e 6765 745f 6368 696c 6428 292c 0a20  r.get_child(),. 
-0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 2020 2072 6563 7572 7369 6f6e 5f6c 696d     recursion_lim
-0001bc20: 6974 3d72 6563 7572 7369 6f6e 5f6c 696d  it=recursion_lim
-0001bc30: 6974 202d 2031 2c0a 2020 2020 2020 2020  it - 1,.        
-0001bc40: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0001bc50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001bc60: 2072 6574 7572 6e20 6361 7374 284f 7574   return cast(Out
-0001bc70: 7075 742c 206f 7574 7075 7429 0a0a 2020  put, output)..  
-0001bc80: 2020 6465 6620 5f63 6f6e 6669 6728 0a20    def _config(. 
-0001bc90: 2020 2020 2020 2073 656c 662c 2063 6f6e         self, con
-0001bca0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-0001bcb0: 6e6e 6162 6c65 436f 6e66 6967 5d2c 2063  nnableConfig], c
-0001bcc0: 616c 6c61 626c 653a 2043 616c 6c61 626c  allable: Callabl
-0001bcd0: 655b 2e2e 2e2c 2041 6e79 5d0a 2020 2020  e[..., Any].    
-0001bce0: 2920 2d3e 2052 756e 6e61 626c 6543 6f6e  ) -> RunnableCon
-0001bcf0: 6669 673a 0a20 2020 2020 2020 2072 6574  fig:.        ret
-0001bd00: 7572 6e20 656e 7375 7265 5f63 6f6e 6669  urn ensure_confi
-0001bd10: 6728 636f 6e66 6967 290a 0a20 2020 2064  g(config)..    d
-0001bd20: 6566 2069 6e76 6f6b 6528 0a20 2020 2020  ef invoke(.     
-0001bd30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001bd40: 2069 6e70 7574 3a20 496e 7075 742c 0a20   input: Input,. 
-0001bd50: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
-0001bd60: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-0001bd70: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
-0001bd80: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0001bd90: 3a20 4f70 7469 6f6e 616c 5b41 6e79 5d2c  : Optional[Any],
-0001bda0: 0a20 2020 2029 202d 3e20 4f75 7470 7574  .    ) -> Output
-0001bdb0: 3a0a 2020 2020 2020 2020 2222 2249 6e76  :.        """Inv
-0001bdc0: 6f6b 6520 7468 6973 2072 756e 6e61 626c  oke this runnabl
-0001bdd0: 6520 7379 6e63 6872 6f6e 6f75 736c 792e  e synchronously.
-0001bde0: 2222 220a 2020 2020 2020 2020 6966 2068  """.        if h
-0001bdf0: 6173 6174 7472 2873 656c 662c 2022 6675  asattr(self, "fu
-0001be00: 6e63 2229 3a0a 2020 2020 2020 2020 2020  nc"):.          
-0001be10: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
-0001be20: 616c 6c5f 7769 7468 5f63 6f6e 6669 6728  all_with_config(
-0001be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001be40: 2073 656c 662e 5f69 6e76 6f6b 652c 0a20   self._invoke,. 
-0001be50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001be60: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
-0001be70: 2020 2020 2020 7365 6c66 2e5f 636f 6e66        self._conf
-0001be80: 6967 2863 6f6e 6669 672c 2073 656c 662e  ig(config, self.
-0001be90: 6675 6e63 292c 0a20 2020 2020 2020 2020  func),.         
-0001bea0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0001beb0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001bec0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001bed0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-0001bee0: 7970 6545 7272 6f72 280a 2020 2020 2020  ypeError(.      
-0001bef0: 2020 2020 2020 2020 2020 2243 616e 6e6f            "Canno
-0001bf00: 7420 696e 766f 6b65 2061 2063 6f72 6f75  t invoke a corou
-0001bf10: 7469 6e65 2066 756e 6374 696f 6e20 7379  tine function sy
-0001bf20: 6e63 6872 6f6e 6f75 736c 792e 220a 2020  nchronously.".  
-0001bf30: 2020 2020 2020 2020 2020 2020 2020 2255                "U
-0001bf40: 7365 2060 6169 6e76 6f6b 6560 2069 6e73  se `ainvoke` ins
-0001bf50: 7465 6164 2e22 0a20 2020 2020 2020 2020  tead.".         
-0001bf60: 2020 2029 0a0a 2020 2020 6173 796e 6320     )..    async 
-0001bf70: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
-0001bf80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001bf90: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-0001bfa0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-0001bfb0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-0001bfc0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-0001bfd0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-0001bfe0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-0001bff0: 5d2c 0a20 2020 2029 202d 3e20 4f75 7470  ],.    ) -> Outp
-0001c000: 7574 3a0a 2020 2020 2020 2020 2222 2249  ut:.        """I
-0001c010: 6e76 6f6b 6520 7468 6973 2072 756e 6e61  nvoke this runna
-0001c020: 626c 6520 6173 796e 6368 726f 6e6f 7573  ble asynchronous
-0001c030: 6c79 2e22 2222 0a20 2020 2020 2020 2074  ly.""".        t
-0001c040: 6865 5f66 756e 6320 3d20 7365 6c66 2e61  he_func = self.a
-0001c050: 6675 6e63 2069 6620 6861 7361 7474 7228  func if hasattr(
-0001c060: 7365 6c66 2c20 2261 6675 6e63 2229 2065  self, "afunc") e
-0001c070: 6c73 6520 7365 6c66 2e66 756e 630a 2020  lse self.func.  
-0001c080: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
-0001c090: 6974 2073 656c 662e 5f61 6361 6c6c 5f77  it self._acall_w
-0001c0a0: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
-0001c0b0: 2020 2020 2020 2020 7365 6c66 2e5f 6169          self._ai
-0001c0c0: 6e76 6f6b 652c 0a20 2020 2020 2020 2020  nvoke,.         
-0001c0d0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-0001c0e0: 2020 2020 2020 7365 6c66 2e5f 636f 6e66        self._conf
-0001c0f0: 6967 2863 6f6e 6669 672c 2074 6865 5f66  ig(config, the_f
-0001c100: 756e 6329 2c0a 2020 2020 2020 2020 2020  unc),.          
-0001c110: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0001c120: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
-0001c130: 7472 616e 7366 6f72 6d28 0a20 2020 2020  transform(.     
-0001c140: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001c150: 2069 6e70 7574 3a20 4974 6572 6174 6f72   input: Iterator
-0001c160: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
-0001c170: 2072 756e 5f6d 616e 6167 6572 3a20 4361   run_manager: Ca
-0001c180: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
-0001c190: 4368 6169 6e52 756e 2c0a 2020 2020 2020  ChainRun,.      
-0001c1a0: 2020 636f 6e66 6967 3a20 5275 6e6e 6162    config: Runnab
-0001c1b0: 6c65 436f 6e66 6967 2c0a 2020 2020 2020  leConfig,.      
-0001c1c0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
-0001c1d0: 0a20 2020 2029 202d 3e20 4974 6572 6174  .    ) -> Iterat
-0001c1e0: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
-0001c1f0: 2020 2020 6669 6e61 6c3a 204f 7074 696f      final: Optio
-0001c200: 6e61 6c5b 496e 7075 745d 203d 204e 6f6e  nal[Input] = Non
-0001c210: 650a 2020 2020 2020 2020 666f 7220 6963  e.        for ic
-0001c220: 6875 6e6b 2069 6e20 696e 7075 743a 0a20  hunk in input:. 
-0001c230: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
-0001c240: 6e61 6c20 6973 204e 6f6e 653a 0a20 2020  nal is None:.   
-0001c250: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-0001c260: 616c 203d 2069 6368 756e 6b0a 2020 2020  al = ichunk.    
-0001c270: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001c280: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0001c290: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0001c2a0: 2020 2020 2020 2066 696e 616c 203d 2066         final = f
-0001c2b0: 696e 616c 202b 2069 6368 756e 6b20 2023  inal + ichunk  #
-0001c2c0: 2074 7970 653a 2069 676e 6f72 655b 6f70   type: ignore[op
-0001c2d0: 6572 6174 6f72 5d0a 2020 2020 2020 2020  erator].        
-0001c2e0: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0001c2f0: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
-0001c300: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001c310: 6e61 6c20 3d20 6963 6875 6e6b 0a0a 2020  nal = ichunk..  
-0001c320: 2020 2020 2020 6966 2069 6e73 7065 6374        if inspect
-0001c330: 2e69 7367 656e 6572 6174 6f72 6675 6e63  .isgeneratorfunc
-0001c340: 7469 6f6e 2873 656c 662e 6675 6e63 293a  tion(self.func):
-0001c350: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001c360: 7075 743a 204f 7074 696f 6e61 6c5b 4f75  put: Optional[Ou
-0001c370: 7470 7574 5d20 3d20 4e6f 6e65 0a20 2020  tput] = None.   
-0001c380: 2020 2020 2020 2020 2066 6f72 2063 6875           for chu
-0001c390: 6e6b 2069 6e20 6361 6c6c 5f66 756e 635f  nk in call_func_
-0001c3a0: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
-0001c3b0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001c3c0: 2020 2020 7365 6c66 2e66 756e 632c 2063      self.func, c
-0001c3d0: 6173 7428 496e 7075 742c 2066 696e 616c  ast(Input, final
-0001c3e0: 292c 2063 6f6e 6669 672c 2072 756e 5f6d  ), config, run_m
-0001c3f0: 616e 6167 6572 2c20 2a2a 6b77 6172 6773  anager, **kwargs
-0001c400: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-0001c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c420: 7969 656c 6420 6368 756e 6b0a 2020 2020  yield chunk.    
-0001c430: 2020 2020 2020 2020 2020 2020 6966 206f              if o
-0001c440: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
-0001c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c460: 2020 206f 7574 7075 7420 3d20 6368 756e     output = chun
-0001c470: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-0001c480: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001c490: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00018c30: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00018c40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00018c50: 7572 6e5f 6578 6365 7074 696f 6e73 3d72  urn_exceptions=r
+00018c60: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00018c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018c80: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00018c90: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00018ca0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00018cb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00018cc0: 4966 2061 6e20 696e 7075 7420 6661 696c  If an input fail
+00018cd0: 6564 2c20 6164 6420 6974 2074 6f20 7468  ed, add it to th
+00018ce0: 6520 6d61 700a 2020 2020 2020 2020 2020  e map.          
+00018cf0: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
+00018d00: 2069 6e70 2069 6e20 7a69 7028 7265 6d61   inp in zip(rema
+00018d10: 696e 696e 675f 6964 7873 2c20 696e 7075  ining_idxs, inpu
+00018d20: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
+00018d30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00018d40: 6973 696e 7374 616e 6365 2869 6e70 2c20  isinstance(inp, 
+00018d50: 4578 6365 7074 696f 6e29 3a0a 2020 2020  Exception):.    
+00018d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d70: 2020 2020 2020 2020 6661 696c 6564 5f69          failed_i
+00018d80: 6e70 7574 735f 6d61 705b 695d 203d 2069  nputs_map[i] = i
+00018d90: 6e70 0a20 2020 2020 2020 2020 2020 2020  np.             
+00018da0: 2020 2020 2020 2069 6e70 7574 7320 3d20         inputs = 
+00018db0: 5b69 6e70 2066 6f72 2069 6e70 2069 6e20  [inp for inp in 
+00018dc0: 696e 7075 7473 2069 6620 6e6f 7420 6973  inputs if not is
+00018dd0: 696e 7374 616e 6365 2869 6e70 2c20 4578  instance(inp, Ex
+00018de0: 6365 7074 696f 6e29 5d0a 2020 2020 2020  ception)].      
+00018df0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00018e00: 4966 2061 6c6c 2069 6e70 7574 7320 6861  If all inputs ha
+00018e10: 7665 2066 6169 6c65 642c 2073 746f 7020  ve failed, stop 
+00018e20: 7072 6f63 6573 7369 6e67 0a20 2020 2020  processing.     
+00018e30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018e40: 6620 6c65 6e28 6661 696c 6564 5f69 6e70  f len(failed_inp
+00018e50: 7574 735f 6d61 7029 203d 3d20 6c65 6e28  uts_map) == len(
+00018e60: 636f 6e66 6967 7329 3a0a 2020 2020 2020  configs):.      
+00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e80: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+00018e90: 2020 2020 2020 2020 2023 2052 6561 7373           # Reass
+00018ea0: 656d 626c 6520 7468 6520 6f75 7470 7574  emble the output
+00018eb0: 732c 2069 6e73 6572 7469 6e67 2045 7863  s, inserting Exc
+00018ec0: 6570 7469 6f6e 7320 666f 7220 6661 696c  eptions for fail
+00018ed0: 6564 2069 6e70 7574 730a 2020 2020 2020  ed inputs.      
+00018ee0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+00018ef0: 5f63 6f70 7920 3d20 696e 7075 7473 2e63  _copy = inputs.c
+00018f00: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+00018f10: 2020 2020 2020 696e 7075 7473 203d 205b        inputs = [
+00018f20: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00018f30: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00018f40: 286c 656e 2863 6f6e 6669 6773 2929 3a0a  (len(configs)):.
+00018f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f60: 2020 2020 6966 2069 2069 6e20 6661 696c      if i in fail
+00018f70: 6564 5f69 6e70 7574 735f 6d61 703a 0a20  ed_inputs_map:. 
+00018f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f90: 2020 2020 2020 2069 6e70 7574 732e 6170         inputs.ap
+00018fa0: 7065 6e64 2863 6173 7428 496e 7075 742c  pend(cast(Input,
+00018fb0: 2066 6169 6c65 645f 696e 7075 7473 5f6d   failed_inputs_m
+00018fc0: 6170 5b69 5d29 290a 2020 2020 2020 2020  ap[i])).        
+00018fd0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00018fe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018ff0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+00019000: 2e61 7070 656e 6428 696e 7075 7473 5f63  .append(inputs_c
+00019010: 6f70 792e 706f 7028 3029 290a 2020 2020  opy.pop(0)).    
+00019020: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00019030: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00019040: 7220 692c 2073 7465 7020 696e 2065 6e75  r i, step in enu
+00019050: 6d65 7261 7465 2873 656c 662e 7374 6570  merate(self.step
+00019060: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00019070: 2020 2020 2020 2020 696e 7075 7473 203d          inputs =
+00019080: 2061 7761 6974 2073 7465 702e 6162 6174   await step.abat
+00019090: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
+000190a0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+000190b0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+000190c0: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+000190d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000190e0: 2020 2020 2020 2020 2020 2320 6561 6368            # each
+000190f0: 2073 7465 7020 6120 6368 696c 6420 7275   step a child ru
+00019100: 6e20 6f66 2074 6865 2063 6f72 7265 7370  n of the corresp
+00019110: 6f6e 6469 6e67 2072 6f6f 7420 7275 6e0a  onding root run.
+00019120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019130: 2020 2020 2020 2020 2020 2020 7061 7463              patc
+00019140: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
+00019150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019160: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00019170: 2c20 6361 6c6c 6261 636b 733d 726d 2e67  , callbacks=rm.g
+00019180: 6574 5f63 6869 6c64 2866 2273 6571 3a73  et_child(f"seq:s
+00019190: 7465 703a 7b69 2b31 7d22 290a 2020 2020  tep:{i+1}").    
+000191a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000191c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191d0: 2020 2020 2020 666f 7220 726d 2c20 636f        for rm, co
+000191e0: 6e66 6967 2069 6e20 7a69 7028 7275 6e5f  nfig in zip(run_
+000191f0: 6d61 6e61 6765 7273 2c20 636f 6e66 6967  managers, config
+00019200: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00019210: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00019220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019230: 2020 290a 2020 2020 2020 2020 2320 6669    ).        # fi
+00019240: 6e69 7368 2074 6865 2072 6f6f 7420 7275  nish the root ru
+00019250: 6e73 0a20 2020 2020 2020 2065 7863 6570  ns.        excep
+00019260: 7420 4261 7365 4578 6365 7074 696f 6e20  t BaseException 
+00019270: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00019280: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+00019290: 6761 7468 6572 282a 2872 6d2e 6f6e 5f63  gather(*(rm.on_c
+000192a0: 6861 696e 5f65 7272 6f72 2865 2920 666f  hain_error(e) fo
+000192b0: 7220 726d 2069 6e20 7275 6e5f 6d61 6e61  r rm in run_mana
+000192c0: 6765 7273 2929 0a20 2020 2020 2020 2020  gers)).         
+000192d0: 2020 2069 6620 7265 7475 726e 5f65 7863     if return_exc
+000192e0: 6570 7469 6f6e 733a 0a20 2020 2020 2020  eptions:.       
+000192f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00019300: 6361 7374 284c 6973 745b 4f75 7470 7574  cast(List[Output
+00019310: 5d2c 205b 6520 666f 7220 5f20 696e 2069  ], [e for _ in i
+00019320: 6e70 7574 735d 290a 2020 2020 2020 2020  nputs]).        
+00019330: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00019340: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+00019350: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00019360: 2020 2020 2020 2020 2020 6669 7273 745f            first_
+00019370: 6578 6365 7074 696f 6e3a 204f 7074 696f  exception: Optio
+00019380: 6e61 6c5b 4578 6365 7074 696f 6e5d 203d  nal[Exception] =
+00019390: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000193a0: 2020 636f 726f 733a 204c 6973 745b 4177    coros: List[Aw
+000193b0: 6169 7461 626c 655b 4e6f 6e65 5d5d 203d  aitable[None]] =
+000193c0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000193d0: 666f 7220 7275 6e5f 6d61 6e61 6765 722c  for run_manager,
+000193e0: 206f 7574 2069 6e20 7a69 7028 7275 6e5f   out in zip(run_
+000193f0: 6d61 6e61 6765 7273 2c20 696e 7075 7473  managers, inputs
+00019400: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019410: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00019420: 286f 7574 2c20 4578 6365 7074 696f 6e29  (out, Exception)
+00019430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019440: 2020 2020 2020 6669 7273 745f 6578 6365        first_exce
+00019450: 7074 696f 6e20 3d20 6669 7273 745f 6578  ption = first_ex
+00019460: 6365 7074 696f 6e20 6f72 206f 7574 0a20  ception or out. 
+00019470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019480: 2020 2063 6f72 6f73 2e61 7070 656e 6428     coros.append(
+00019490: 7275 6e5f 6d61 6e61 6765 722e 6f6e 5f63  run_manager.on_c
+000194a0: 6861 696e 5f65 7272 6f72 286f 7574 2929  hain_error(out))
+000194b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000194c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000194d0: 2020 2020 2020 2020 2020 2063 6f72 6f73             coros
+000194e0: 2e61 7070 656e 6428 7275 6e5f 6d61 6e61  .append(run_mana
+000194f0: 6765 722e 6f6e 5f63 6861 696e 5f65 6e64  ger.on_chain_end
+00019500: 286f 7574 2929 0a20 2020 2020 2020 2020  (out)).         
+00019510: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
+00019520: 2e67 6174 6865 7228 2a63 6f72 6f73 290a  .gather(*coros).
+00019530: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00019540: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00019550: 206f 7220 6669 7273 745f 6578 6365 7074   or first_except
+00019560: 696f 6e20 6973 204e 6f6e 653a 0a20 2020  ion is None:.   
+00019570: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00019580: 7572 6e20 6361 7374 284c 6973 745b 4f75  urn cast(List[Ou
+00019590: 7470 7574 5d2c 2069 6e70 7574 7329 0a20  tput], inputs). 
+000195a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000195b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000195c0: 2072 6169 7365 2066 6972 7374 5f65 7863   raise first_exc
+000195d0: 6570 7469 6f6e 0a0a 2020 2020 6465 6620  eption..    def 
+000195e0: 5f74 7261 6e73 666f 726d 280a 2020 2020  _transform(.    
+000195f0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00019600: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+00019610: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+00019620: 2020 7275 6e5f 6d61 6e61 6765 723a 2043    run_manager: C
+00019630: 616c 6c62 6163 6b4d 616e 6167 6572 466f  allbackManagerFo
+00019640: 7243 6861 696e 5275 6e2c 0a20 2020 2020  rChainRun,.     
+00019650: 2020 2063 6f6e 6669 673a 2052 756e 6e61     config: Runna
+00019660: 626c 6543 6f6e 6669 672c 0a20 2020 2029  bleConfig,.    )
+00019670: 202d 3e20 4974 6572 6174 6f72 5b4f 7574   -> Iterator[Out
+00019680: 7075 745d 3a0a 2020 2020 2020 2020 6672  put]:.        fr
+00019690: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+000196a0: 652e 6265 7461 2e72 756e 6e61 626c 6573  e.beta.runnables
+000196b0: 2e63 6f6e 7465 7874 2069 6d70 6f72 7420  .context import 
+000196c0: 636f 6e66 6967 5f77 6974 685f 636f 6e74  config_with_cont
+000196d0: 6578 740a 0a20 2020 2020 2020 2073 7465  ext..        ste
+000196e0: 7073 203d 205b 7365 6c66 2e66 6972 7374  ps = [self.first
+000196f0: 5d20 2b20 7365 6c66 2e6d 6964 646c 6520  ] + self.middle 
+00019700: 2b20 5b73 656c 662e 6c61 7374 5d0a 2020  + [self.last].  
+00019710: 2020 2020 2020 636f 6e66 6967 203d 2063        config = c
+00019720: 6f6e 6669 675f 7769 7468 5f63 6f6e 7465  onfig_with_conte
+00019730: 7874 2863 6f6e 6669 672c 2073 656c 662e  xt(config, self.
+00019740: 7374 6570 7329 0a0a 2020 2020 2020 2020  steps)..        
+00019750: 2320 7472 616e 7366 6f72 6d20 7468 6520  # transform the 
+00019760: 696e 7075 7420 7374 7265 616d 206f 6620  input stream of 
+00019770: 6561 6368 2073 7465 7020 7769 7468 2074  each step with t
+00019780: 6865 206e 6578 740a 2020 2020 2020 2020  he next.        
+00019790: 2320 7374 6570 7320 7468 6174 2064 6f6e  # steps that don
+000197a0: 2774 206e 6174 6976 656c 7920 7375 7070  't natively supp
+000197b0: 6f72 7420 7472 616e 7366 6f72 6d69 6e67  ort transforming
+000197c0: 2061 6e20 696e 7075 7420 7374 7265 616d   an input stream
+000197d0: 2077 696c 6c0a 2020 2020 2020 2020 2320   will.        # 
+000197e0: 6275 6666 6572 2069 6e70 7574 2069 6e20  buffer input in 
+000197f0: 6d65 6d6f 7279 2075 6e74 696c 2061 6c6c  memory until all
+00019800: 2061 7661 696c 6162 6c65 2c20 616e 6420   available, and 
+00019810: 7468 656e 2073 7461 7274 2065 6d69 7474  then start emitt
+00019820: 696e 6720 6f75 7470 7574 0a20 2020 2020  ing output.     
+00019830: 2020 2066 696e 616c 5f70 6970 656c 696e     final_pipelin
+00019840: 6520 3d20 6361 7374 2849 7465 7261 746f  e = cast(Iterato
+00019850: 725b 4f75 7470 7574 5d2c 2069 6e70 7574  r[Output], input
+00019860: 290a 2020 2020 2020 2020 666f 7220 7374  ).        for st
+00019870: 6570 2069 6e20 7374 6570 733a 0a20 2020  ep in steps:.   
+00019880: 2020 2020 2020 2020 2066 696e 616c 5f70           final_p
+00019890: 6970 656c 696e 6520 3d20 7374 6570 2e74  ipeline = step.t
+000198a0: 7261 6e73 666f 726d 280a 2020 2020 2020  ransform(.      
+000198b0: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
+000198c0: 7069 7065 6c69 6e65 2c0a 2020 2020 2020  pipeline,.      
+000198d0: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+000198e0: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+000198f0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00019900: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
+00019910: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
+00019920: 733d 7275 6e5f 6d61 6e61 6765 722e 6765  s=run_manager.ge
+00019930: 745f 6368 696c 6428 6622 7365 713a 7374  t_child(f"seq:st
+00019940: 6570 3a7b 7374 6570 732e 696e 6465 7828  ep:{steps.index(
+00019950: 7374 6570 292b 317d 2229 2c0a 2020 2020  step)+1}"),.    
+00019960: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00019970: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00019980: 2020 2020 2020 666f 7220 6f75 7470 7574        for output
+00019990: 2069 6e20 6669 6e61 6c5f 7069 7065 6c69   in final_pipeli
+000199a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000199b0: 7969 656c 6420 6f75 7470 7574 0a0a 2020  yield output..  
+000199c0: 2020 6173 796e 6320 6465 6620 5f61 7472    async def _atr
+000199d0: 616e 7366 6f72 6d28 0a20 2020 2020 2020  ansform(.       
+000199e0: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+000199f0: 6e70 7574 3a20 4173 796e 6349 7465 7261  nput: AsyncItera
+00019a00: 746f 725b 496e 7075 745d 2c0a 2020 2020  tor[Input],.    
+00019a10: 2020 2020 7275 6e5f 6d61 6e61 6765 723a      run_manager:
+00019a20: 2041 7379 6e63 4361 6c6c 6261 636b 4d61   AsyncCallbackMa
+00019a30: 6e61 6765 7246 6f72 4368 6169 6e52 756e  nagerForChainRun
+00019a40: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+00019a50: 3a20 5275 6e6e 6162 6c65 436f 6e66 6967  : RunnableConfig
+00019a60: 2c0a 2020 2020 2920 2d3e 2041 7379 6e63  ,.    ) -> Async
+00019a70: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
+00019a80: 3a0a 2020 2020 2020 2020 6672 6f6d 206c  :.        from l
+00019a90: 616e 6763 6861 696e 5f63 6f72 652e 6265  angchain_core.be
+00019aa0: 7461 2e72 756e 6e61 626c 6573 2e63 6f6e  ta.runnables.con
+00019ab0: 7465 7874 2069 6d70 6f72 7420 6163 6f6e  text import acon
+00019ac0: 6669 675f 7769 7468 5f63 6f6e 7465 7874  fig_with_context
+00019ad0: 0a0a 2020 2020 2020 2020 7374 6570 7320  ..        steps 
+00019ae0: 3d20 5b73 656c 662e 6669 7273 745d 202b  = [self.first] +
+00019af0: 2073 656c 662e 6d69 6464 6c65 202b 205b   self.middle + [
+00019b00: 7365 6c66 2e6c 6173 745d 0a20 2020 2020  self.last].     
+00019b10: 2020 2063 6f6e 6669 6720 3d20 6163 6f6e     config = acon
+00019b20: 6669 675f 7769 7468 5f63 6f6e 7465 7874  fig_with_context
+00019b30: 2863 6f6e 6669 672c 2073 656c 662e 7374  (config, self.st
+00019b40: 6570 7329 0a0a 2020 2020 2020 2020 2320  eps)..        # 
+00019b50: 7374 7265 616d 2074 6865 206c 6173 7420  stream the last 
+00019b60: 7374 6570 730a 2020 2020 2020 2020 2320  steps.        # 
+00019b70: 7472 616e 7366 6f72 6d20 7468 6520 696e  transform the in
+00019b80: 7075 7420 7374 7265 616d 206f 6620 6561  put stream of ea
+00019b90: 6368 2073 7465 7020 7769 7468 2074 6865  ch step with the
+00019ba0: 206e 6578 740a 2020 2020 2020 2020 2320   next.        # 
+00019bb0: 7374 6570 7320 7468 6174 2064 6f6e 2774  steps that don't
+00019bc0: 206e 6174 6976 656c 7920 7375 7070 6f72   natively suppor
+00019bd0: 7420 7472 616e 7366 6f72 6d69 6e67 2061  t transforming a
+00019be0: 6e20 696e 7075 7420 7374 7265 616d 2077  n input stream w
+00019bf0: 696c 6c0a 2020 2020 2020 2020 2320 6275  ill.        # bu
+00019c00: 6666 6572 2069 6e70 7574 2069 6e20 6d65  ffer input in me
+00019c10: 6d6f 7279 2075 6e74 696c 2061 6c6c 2061  mory until all a
+00019c20: 7661 696c 6162 6c65 2c20 616e 6420 7468  vailable, and th
+00019c30: 656e 2073 7461 7274 2065 6d69 7474 696e  en start emittin
+00019c40: 6720 6f75 7470 7574 0a20 2020 2020 2020  g output.       
+00019c50: 2066 696e 616c 5f70 6970 656c 696e 6520   final_pipeline 
+00019c60: 3d20 6361 7374 2841 7379 6e63 4974 6572  = cast(AsyncIter
+00019c70: 6174 6f72 5b4f 7574 7075 745d 2c20 696e  ator[Output], in
+00019c80: 7075 7429 0a20 2020 2020 2020 2066 6f72  put).        for
+00019c90: 2073 7465 7020 696e 2073 7465 7073 3a0a   step in steps:.
+00019ca0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+00019cb0: 6c5f 7069 7065 6c69 6e65 203d 2073 7465  l_pipeline = ste
+00019cc0: 702e 6174 7261 6e73 666f 726d 280a 2020  p.atransform(.  
+00019cd0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00019ce0: 6e61 6c5f 7069 7065 6c69 6e65 2c0a 2020  nal_pipeline,.  
+00019cf0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00019d00: 7463 685f 636f 6e66 6967 280a 2020 2020  tch_config(.    
+00019d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d20: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
+00019d30: 2020 2020 2020 2020 2020 2020 6361 6c6c              call
+00019d40: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
+00019d50: 722e 6765 745f 6368 696c 6428 6622 7365  r.get_child(f"se
+00019d60: 713a 7374 6570 3a7b 7374 6570 732e 696e  q:step:{steps.in
+00019d70: 6465 7828 7374 6570 292b 317d 2229 2c0a  dex(step)+1}"),.
+00019d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d90: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00019da0: 0a20 2020 2020 2020 2061 7379 6e63 2066  .        async f
+00019db0: 6f72 206f 7574 7075 7420 696e 2066 696e  or output in fin
+00019dc0: 616c 5f70 6970 656c 696e 653a 0a20 2020  al_pipeline:.   
+00019dd0: 2020 2020 2020 2020 2079 6965 6c64 206f           yield o
+00019de0: 7574 7075 740a 0a20 2020 2064 6566 2074  utput..    def t
+00019df0: 7261 6e73 666f 726d 280a 2020 2020 2020  ransform(.      
+00019e00: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00019e10: 696e 7075 743a 2049 7465 7261 746f 725b  input: Iterator[
+00019e20: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
+00019e30: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00019e40: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00019e50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00019e60: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
+00019e70: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
+00019e80: 2d3e 2049 7465 7261 746f 725b 4f75 7470  -> Iterator[Outp
+00019e90: 7574 5d3a 0a20 2020 2020 2020 2079 6965  ut]:.        yie
+00019ea0: 6c64 2066 726f 6d20 7365 6c66 2e5f 7472  ld from self._tr
+00019eb0: 616e 7366 6f72 6d5f 7374 7265 616d 5f77  ansform_stream_w
+00019ec0: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
+00019ed0: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00019ee0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019ef0: 5f74 7261 6e73 666f 726d 2c0a 2020 2020  _transform,.    
+00019f00: 2020 2020 2020 2020 7061 7463 685f 636f          patch_co
+00019f10: 6e66 6967 2863 6f6e 6669 672c 2072 756e  nfig(config, run
+00019f20: 5f6e 616d 653d 2863 6f6e 6669 6720 6f72  _name=(config or
+00019f30: 207b 7d29 2e67 6574 2822 7275 6e5f 6e61   {}).get("run_na
+00019f40: 6d65 2229 206f 7220 7365 6c66 2e6e 616d  me") or self.nam
+00019f50: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00019f60: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+00019f70: 2020 290a 0a20 2020 2064 6566 2073 7472    )..    def str
+00019f80: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
+00019f90: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+00019fa0: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
+00019fb0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+00019fc0: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+00019fd0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00019fe0: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+00019ff0: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+0001a000: 202d 3e20 4974 6572 6174 6f72 5b4f 7574   -> Iterator[Out
+0001a010: 7075 745d 3a0a 2020 2020 2020 2020 7969  put]:.        yi
+0001a020: 656c 6420 6672 6f6d 2073 656c 662e 7472  eld from self.tr
+0001a030: 616e 7366 6f72 6d28 6974 6572 285b 696e  ansform(iter([in
+0001a040: 7075 745d 292c 2063 6f6e 6669 672c 202a  put]), config, *
+0001a050: 2a6b 7761 7267 7329 0a0a 2020 2020 6173  *kwargs)..    as
+0001a060: 796e 6320 6465 6620 6174 7261 6e73 666f  ync def atransfo
+0001a070: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
+0001a080: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+0001a090: 2041 7379 6e63 4974 6572 6174 6f72 5b49   AsyncIterator[I
+0001a0a0: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
+0001a0b0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+0001a0c0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+0001a0d0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0001a0e0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+0001a0f0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+0001a100: 3e20 4173 796e 6349 7465 7261 746f 725b  > AsyncIterator[
+0001a110: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+0001a120: 2061 7379 6e63 2066 6f72 2063 6875 6e6b   async for chunk
+0001a130: 2069 6e20 7365 6c66 2e5f 6174 7261 6e73   in self._atrans
+0001a140: 666f 726d 5f73 7472 6561 6d5f 7769 7468  form_stream_with
+0001a150: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+0001a160: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+0001a170: 2020 2020 2020 2020 7365 6c66 2e5f 6174          self._at
+0001a180: 7261 6e73 666f 726d 2c0a 2020 2020 2020  ransform,.      
+0001a190: 2020 2020 2020 7061 7463 685f 636f 6e66        patch_conf
+0001a1a0: 6967 2863 6f6e 6669 672c 2072 756e 5f6e  ig(config, run_n
+0001a1b0: 616d 653d 2863 6f6e 6669 6720 6f72 207b  ame=(config or {
+0001a1c0: 7d29 2e67 6574 2822 7275 6e5f 6e61 6d65  }).get("run_name
+0001a1d0: 2229 206f 7220 7365 6c66 2e6e 616d 6529  ") or self.name)
+0001a1e0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+0001a1f0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+0001a200: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
+0001a210: 6965 6c64 2063 6875 6e6b 0a0a 2020 2020  ield chunk..    
+0001a220: 6173 796e 6320 6465 6620 6173 7472 6561  async def astrea
+0001a230: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
+0001a240: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+0001a250: 496e 7075 742c 0a20 2020 2020 2020 2063  Input,.        c
+0001a260: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+0001a270: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+0001a280: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0001a290: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+0001a2a0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+0001a2b0: 3e20 4173 796e 6349 7465 7261 746f 725b  > AsyncIterator[
+0001a2c0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+0001a2d0: 2061 7379 6e63 2064 6566 2069 6e70 7574   async def input
+0001a2e0: 5f61 6974 6572 2829 202d 3e20 4173 796e  _aiter() -> Asyn
+0001a2f0: 6349 7465 7261 746f 725b 496e 7075 745d  cIterator[Input]
+0001a300: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
+0001a310: 656c 6420 696e 7075 740a 0a20 2020 2020  eld input..     
+0001a320: 2020 2061 7379 6e63 2066 6f72 2063 6875     async for chu
+0001a330: 6e6b 2069 6e20 7365 6c66 2e61 7472 616e  nk in self.atran
+0001a340: 7366 6f72 6d28 696e 7075 745f 6169 7465  sform(input_aite
+0001a350: 7228 292c 2063 6f6e 6669 672c 202a 2a6b  r(), config, **k
+0001a360: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0001a370: 2020 2020 7969 656c 6420 6368 756e 6b0a      yield chunk.
+0001a380: 0a0a 636c 6173 7320 5275 6e6e 6162 6c65  ..class Runnable
+0001a390: 5061 7261 6c6c 656c 2852 756e 6e61 626c  Parallel(Runnabl
+0001a3a0: 6553 6572 6961 6c69 7a61 626c 655b 496e  eSerializable[In
+0001a3b0: 7075 742c 2044 6963 745b 7374 722c 2041  put, Dict[str, A
+0001a3c0: 6e79 5d5d 293a 0a20 2020 2022 2222 5275  ny]]):.    """Ru
+0001a3d0: 6e6e 6162 6c65 2074 6861 7420 7275 6e73  nnable that runs
+0001a3e0: 2061 206d 6170 7069 6e67 206f 6620 5275   a mapping of Ru
+0001a3f0: 6e6e 6162 6c65 7320 696e 2070 6172 616c  nnables in paral
+0001a400: 6c65 6c2c 2061 6e64 2072 6574 7572 6e73  lel, and returns
+0001a410: 2061 206d 6170 7069 6e67 0a20 2020 206f   a mapping.    o
+0001a420: 6620 7468 6569 7220 6f75 7470 7574 732e  f their outputs.
+0001a430: 0a0a 2020 2020 5275 6e6e 6162 6c65 5061  ..    RunnablePa
+0001a440: 7261 6c6c 656c 2069 7320 6f6e 6520 6f66  rallel is one of
+0001a450: 2074 6865 2074 776f 206d 6169 6e20 636f   the two main co
+0001a460: 6d70 6f73 6974 696f 6e20 7072 696d 6974  mposition primit
+0001a470: 6976 6573 2066 6f72 2074 6865 204c 4345  ives for the LCE
+0001a480: 4c2c 0a20 2020 2061 6c6f 6e67 7369 6465  L,.    alongside
+0001a490: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
+0001a4a0: 652e 2049 7420 696e 766f 6b65 7320 5275  e. It invokes Ru
+0001a4b0: 6e6e 6162 6c65 7320 636f 6e63 7572 7265  nnables concurre
+0001a4c0: 6e74 6c79 2c20 7072 6f76 6964 696e 6720  ntly, providing 
+0001a4d0: 7468 6520 7361 6d65 0a20 2020 2069 6e70  the same.    inp
+0001a4e0: 7574 2074 6f20 6561 6368 2e0a 0a20 2020  ut to each...   
+0001a4f0: 2041 2052 756e 6e61 626c 6550 6172 616c   A RunnableParal
+0001a500: 6c65 6c20 6361 6e20 6265 2069 6e73 7461  lel can be insta
+0001a510: 6e74 6961 7465 6420 6469 7265 6374 6c79  ntiated directly
+0001a520: 206f 7220 6279 2075 7369 6e67 2061 2064   or by using a d
+0001a530: 6963 7420 6c69 7465 7261 6c20 7769 7468  ict literal with
+0001a540: 696e 2061 0a20 2020 2073 6571 7565 6e63  in a.    sequenc
+0001a550: 652e 0a0a 2020 2020 4865 7265 2069 7320  e...    Here is 
+0001a560: 6120 7369 6d70 6c65 2065 7861 6d70 6c65  a simple example
+0001a570: 2074 6861 7420 7573 6573 2066 756e 6374   that uses funct
+0001a580: 696f 6e73 2074 6f20 696c 6c75 7374 7261  ions to illustra
+0001a590: 7465 2074 6865 2075 7365 206f 660a 2020  te the use of.  
+0001a5a0: 2020 5275 6e6e 6162 6c65 5061 7261 6c6c    RunnableParall
+0001a5b0: 656c 3a0a 0a20 2020 2020 2020 202e 2e20  el:..        .. 
+0001a5c0: 636f 6465 2d62 6c6f 636b 3a3a 2070 7974  code-block:: pyt
+0001a5d0: 686f 6e0a 0a20 2020 2020 2020 2020 2020  hon..           
+0001a5e0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+0001a5f0: 636f 7265 2e72 756e 6e61 626c 6573 2069  core.runnables i
+0001a600: 6d70 6f72 7420 5275 6e6e 6162 6c65 4c61  mport RunnableLa
+0001a610: 6d62 6461 0a0a 2020 2020 2020 2020 2020  mbda..          
+0001a620: 2020 6465 6620 6164 645f 6f6e 6528 783a    def add_one(x:
+0001a630: 2069 6e74 2920 2d3e 2069 6e74 3a0a 2020   int) -> int:.  
+0001a640: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001a650: 7475 726e 2078 202b 2031 0a0a 2020 2020  turn x + 1..    
+0001a660: 2020 2020 2020 2020 6465 6620 6d75 6c5f          def mul_
+0001a670: 7477 6f28 783a 2069 6e74 2920 2d3e 2069  two(x: int) -> i
+0001a680: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+0001a690: 2020 2020 7265 7475 726e 2078 202a 2032      return x * 2
+0001a6a0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+0001a6b0: 6620 6d75 6c5f 7468 7265 6528 783a 2069  f mul_three(x: i
+0001a6c0: 6e74 2920 2d3e 2069 6e74 3a0a 2020 2020  nt) -> int:.    
+0001a6d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001a6e0: 726e 2078 202a 2033 0a0a 2020 2020 2020  rn x * 3..      
+0001a6f0: 2020 2020 2020 7275 6e6e 6162 6c65 5f31        runnable_1
+0001a700: 203d 2052 756e 6e61 626c 654c 616d 6264   = RunnableLambd
+0001a710: 6128 6164 645f 6f6e 6529 0a20 2020 2020  a(add_one).     
+0001a720: 2020 2020 2020 2072 756e 6e61 626c 655f         runnable_
+0001a730: 3220 3d20 5275 6e6e 6162 6c65 4c61 6d62  2 = RunnableLamb
+0001a740: 6461 286d 756c 5f74 776f 290a 2020 2020  da(mul_two).    
+0001a750: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+0001a760: 5f33 203d 2052 756e 6e61 626c 654c 616d  _3 = RunnableLam
+0001a770: 6264 6128 6d75 6c5f 7468 7265 6529 0a0a  bda(mul_three)..
+0001a780: 2020 2020 2020 2020 2020 2020 7365 7175              sequ
+0001a790: 656e 6365 203d 2072 756e 6e61 626c 655f  ence = runnable_
+0001a7a0: 3120 7c20 7b20 2023 2074 6869 7320 6469  1 | {  # this di
+0001a7b0: 6374 2069 7320 636f 6572 6365 6420 746f  ct is coerced to
+0001a7c0: 2061 2052 756e 6e61 626c 6550 6172 616c   a RunnableParal
+0001a7d0: 6c65 6c0a 2020 2020 2020 2020 2020 2020  lel.            
+0001a7e0: 2020 2020 226d 756c 5f74 776f 223a 2072      "mul_two": r
+0001a7f0: 756e 6e61 626c 655f 322c 0a20 2020 2020  unnable_2,.     
+0001a800: 2020 2020 2020 2020 2020 2022 6d75 6c5f             "mul_
+0001a810: 7468 7265 6522 3a20 7275 6e6e 6162 6c65  three": runnable
+0001a820: 5f33 2c0a 2020 2020 2020 2020 2020 2020  _3,.            
+0001a830: 7d0a 2020 2020 2020 2020 2020 2020 2320  }.            # 
+0001a840: 4f72 2065 7175 6976 616c 656e 746c 793a  Or equivalently:
+0001a850: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+0001a860: 6571 7565 6e63 6520 3d20 7275 6e6e 6162  equence = runnab
+0001a870: 6c65 5f31 207c 2052 756e 6e61 626c 6550  le_1 | RunnableP
+0001a880: 6172 616c 6c65 6c28 0a20 2020 2020 2020  arallel(.       
+0001a890: 2020 2020 2023 2020 2020 207b 226d 756c       #     {"mul
+0001a8a0: 5f74 776f 223a 2072 756e 6e61 626c 655f  _two": runnable_
+0001a8b0: 322c 2022 6d75 6c5f 7468 7265 6522 3a20  2, "mul_three": 
+0001a8c0: 7275 6e6e 6162 6c65 5f33 7d0a 2020 2020  runnable_3}.    
+0001a8d0: 2020 2020 2020 2020 2320 290a 2020 2020          # ).    
+0001a8e0: 2020 2020 2020 2020 2320 416c 736f 2065          # Also e
+0001a8f0: 7175 6976 616c 656e 746c 793a 0a20 2020  quivalently:.   
+0001a900: 2020 2020 2020 2020 2023 2073 6571 7565           # seque
+0001a910: 6e63 6520 3d20 7275 6e6e 6162 6c65 5f31  nce = runnable_1
+0001a920: 207c 2052 756e 6e61 626c 6550 6172 616c   | RunnableParal
+0001a930: 6c65 6c28 0a20 2020 2020 2020 2020 2020  lel(.           
+0001a940: 2023 2020 2020 206d 756c 5f74 776f 3d72   #     mul_two=r
+0001a950: 756e 6e61 626c 655f 322c 0a20 2020 2020  unnable_2,.     
+0001a960: 2020 2020 2020 2023 2020 2020 206d 756c         #     mul
+0001a970: 5f74 6872 6565 3d72 756e 6e61 626c 655f  _three=runnable_
+0001a980: 332c 0a20 2020 2020 2020 2020 2020 2023  3,.            #
+0001a990: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0001a9a0: 7365 7175 656e 6365 2e69 6e76 6f6b 6528  sequence.invoke(
+0001a9b0: 3129 0a20 2020 2020 2020 2020 2020 2061  1).            a
+0001a9c0: 7761 6974 2073 6571 7565 6e63 652e 6169  wait sequence.ai
+0001a9d0: 6e76 6f6b 6528 3129 0a0a 2020 2020 2020  nvoke(1)..      
+0001a9e0: 2020 2020 2020 7365 7175 656e 6365 2e62        sequence.b
+0001a9f0: 6174 6368 285b 312c 2032 2c20 335d 290a  atch([1, 2, 3]).
+0001aa00: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0001aa10: 7420 7365 7175 656e 6365 2e61 6261 7463  t sequence.abatc
+0001aa20: 6828 5b31 2c20 322c 2033 5d29 0a0a 2020  h([1, 2, 3])..  
+0001aa30: 2020 5275 6e6e 6162 6c65 5061 7261 6c6c    RunnableParall
+0001aa40: 656c 206d 616b 6573 2069 7420 6561 7379  el makes it easy
+0001aa50: 2074 6f20 7275 6e20 5275 6e6e 6162 6c65   to run Runnable
+0001aa60: 7320 696e 2070 6172 616c 6c65 6c2e 2049  s in parallel. I
+0001aa70: 6e20 7468 6520 6265 6c6f 7720 6578 616d  n the below exam
+0001aa80: 706c 652c 0a20 2020 2077 6520 7369 6d75  ple,.    we simu
+0001aa90: 6c74 616e 656f 7573 6c79 2073 7472 6561  ltaneously strea
+0001aaa0: 6d20 6f75 7470 7574 2066 726f 6d20 7477  m output from tw
+0001aab0: 6f20 6469 6666 6572 656e 7420 5275 6e6e  o different Runn
+0001aac0: 6162 6c65 733a 0a0a 2020 2020 2020 2020  ables:..        
+0001aad0: 2e2e 2063 6f64 652d 626c 6f63 6b3a 3a20  .. code-block:: 
+0001aae0: 7079 7468 6f6e 0a0a 2020 2020 2020 2020  python..        
+0001aaf0: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
+0001ab00: 696e 5f63 6f72 652e 7072 6f6d 7074 7320  in_core.prompts 
+0001ab10: 696d 706f 7274 2043 6861 7450 726f 6d70  import ChatPromp
+0001ab20: 7454 656d 706c 6174 650a 2020 2020 2020  tTemplate.      
+0001ab30: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+0001ab40: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
+0001ab50: 6c65 7320 696d 706f 7274 2052 756e 6e61  les import Runna
+0001ab60: 626c 6550 6172 616c 6c65 6c0a 2020 2020  bleParallel.    
+0001ab70: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0001ab80: 6763 6861 696e 5f6f 7065 6e61 6920 696d  gchain_openai im
+0001ab90: 706f 7274 2043 6861 744f 7065 6e41 490a  port ChatOpenAI.
+0001aba0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+0001abb0: 656c 203d 2043 6861 744f 7065 6e41 4928  el = ChatOpenAI(
+0001abc0: 290a 2020 2020 2020 2020 2020 2020 6a6f  ).            jo
+0001abd0: 6b65 5f63 6861 696e 203d 2028 0a20 2020  ke_chain = (.   
+0001abe0: 2020 2020 2020 2020 2020 2020 2043 6861               Cha
+0001abf0: 7450 726f 6d70 7454 656d 706c 6174 652e  tPromptTemplate.
+0001ac00: 6672 6f6d 5f74 656d 706c 6174 6528 2274  from_template("t
+0001ac10: 656c 6c20 6d65 2061 206a 6f6b 6520 6162  ell me a joke ab
+0001ac20: 6f75 7420 7b74 6f70 6963 7d22 290a 2020  out {topic}").  
+0001ac30: 2020 2020 2020 2020 2020 2020 2020 7c20                | 
+0001ac40: 6d6f 6465 6c0a 2020 2020 2020 2020 2020  model.          
+0001ac50: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001ac60: 706f 656d 5f63 6861 696e 203d 2028 0a20  poem_chain = (. 
+0001ac70: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+0001ac80: 6861 7450 726f 6d70 7454 656d 706c 6174  hatPromptTemplat
+0001ac90: 652e 6672 6f6d 5f74 656d 706c 6174 6528  e.from_template(
+0001aca0: 2277 7269 7465 2061 2032 2d6c 696e 6520  "write a 2-line 
+0001acb0: 706f 656d 2061 626f 7574 207b 746f 7069  poem about {topi
+0001acc0: 637d 2229 0a20 2020 2020 2020 2020 2020  c}").           
+0001acd0: 2020 2020 207c 206d 6f64 656c 0a20 2020       | model.   
+0001ace0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0001acf0: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+0001ad00: 203d 2052 756e 6e61 626c 6550 6172 616c   = RunnableParal
+0001ad10: 6c65 6c28 6a6f 6b65 3d6a 6f6b 655f 6368  lel(joke=joke_ch
+0001ad20: 6169 6e2c 2070 6f65 6d3d 706f 656d 5f63  ain, poem=poem_c
+0001ad30: 6861 696e 290a 0a20 2020 2020 2020 2020  hain)..         
+0001ad40: 2020 2023 2044 6973 706c 6179 2073 7472     # Display str
+0001ad50: 6561 6d0a 2020 2020 2020 2020 2020 2020  eam.            
+0001ad60: 6f75 7470 7574 203d 207b 6b65 793a 2022  output = {key: "
+0001ad70: 2220 666f 7220 6b65 792c 205f 2069 6e20  " for key, _ in 
+0001ad80: 7275 6e6e 6162 6c65 2e6f 7574 7075 745f  runnable.output_
+0001ad90: 7363 6865 6d61 2829 7d0a 2020 2020 2020  schema()}.      
+0001ada0: 2020 2020 2020 666f 7220 6368 756e 6b20        for chunk 
+0001adb0: 696e 2072 756e 6e61 626c 652e 7374 7265  in runnable.stre
+0001adc0: 616d 287b 2274 6f70 6963 223a 2022 6265  am({"topic": "be
+0001add0: 6172 227d 293a 0a20 2020 2020 2020 2020  ar"}):.         
+0001ade0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0001adf0: 6e20 6368 756e 6b3a 0a20 2020 2020 2020  n chunk:.       
+0001ae00: 2020 2020 2020 2020 2020 2020 206f 7574               out
+0001ae10: 7075 745b 6b65 795d 203d 206f 7574 7075  put[key] = outpu
+0001ae20: 745b 6b65 795d 202b 2063 6875 6e6b 5b6b  t[key] + chunk[k
+0001ae30: 6579 5d2e 636f 6e74 656e 740a 2020 2020  ey].content.    
+0001ae40: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001ae50: 7428 6f75 7470 7574 2920 2023 206e 6f71  t(output)  # noq
+0001ae60: 613a 2054 3230 310a 2020 2020 2222 220a  a: T201.    """.
+0001ae70: 0a20 2020 2073 7465 7073 5f5f 3a20 4d61  .    steps__: Ma
+0001ae80: 7070 696e 675b 7374 722c 2052 756e 6e61  pping[str, Runna
+0001ae90: 626c 655b 496e 7075 742c 2041 6e79 5d5d  ble[Input, Any]]
+0001aea0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+0001aeb0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+0001aec0: 2c0a 2020 2020 2020 2020 7374 6570 735f  ,.        steps_
+0001aed0: 5f3a 204f 7074 696f 6e61 6c5b 0a20 2020  _: Optional[.   
+0001aee0: 2020 2020 2020 2020 204d 6170 7069 6e67           Mapping
+0001aef0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0001af00: 2020 7374 722c 0a20 2020 2020 2020 2020    str,.         
+0001af10: 2020 2020 2020 2055 6e69 6f6e 5b0a 2020         Union[.  
+0001af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af30: 2020 5275 6e6e 6162 6c65 5b49 6e70 7574    Runnable[Input
+0001af40: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
+0001af50: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0001af60: 6162 6c65 5b5b 496e 7075 745d 2c20 416e  able[[Input], An
+0001af70: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
+0001af80: 2020 2020 2020 2020 4d61 7070 696e 675b          Mapping[
+0001af90: 7374 722c 2055 6e69 6f6e 5b52 756e 6e61  str, Union[Runna
+0001afa0: 626c 655b 496e 7075 742c 2041 6e79 5d2c  ble[Input, Any],
+0001afb0: 2043 616c 6c61 626c 655b 5b49 6e70 7574   Callable[[Input
+0001afc0: 5d2c 2041 6e79 5d5d 5d2c 0a20 2020 2020  ], Any]]],.     
+0001afd0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+0001afe0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0001aff0: 2020 2020 5d20 3d20 4e6f 6e65 2c0a 2020      ] = None,.  
+0001b000: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+0001b010: 556e 696f 6e5b 0a20 2020 2020 2020 2020  Union[.         
+0001b020: 2020 2052 756e 6e61 626c 655b 496e 7075     Runnable[Inpu
+0001b030: 742c 2041 6e79 5d2c 0a20 2020 2020 2020  t, Any],.       
+0001b040: 2020 2020 2043 616c 6c61 626c 655b 5b49       Callable[[I
+0001b050: 6e70 7574 5d2c 2041 6e79 5d2c 0a20 2020  nput], Any],.   
+0001b060: 2020 2020 2020 2020 204d 6170 7069 6e67           Mapping
+0001b070: 5b73 7472 2c20 556e 696f 6e5b 5275 6e6e  [str, Union[Runn
+0001b080: 6162 6c65 5b49 6e70 7574 2c20 416e 795d  able[Input, Any]
+0001b090: 2c20 4361 6c6c 6162 6c65 5b5b 496e 7075  , Callable[[Inpu
+0001b0a0: 745d 2c20 416e 795d 5d5d 2c0a 2020 2020  t], Any]]],.    
+0001b0b0: 2020 2020 5d2c 0a20 2020 2029 202d 3e20      ],.    ) -> 
+0001b0c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6d65  None:.        me
+0001b0d0: 7267 6564 203d 207b 2a2a 7374 6570 735f  rged = {**steps_
+0001b0e0: 5f7d 2069 6620 7374 6570 735f 5f20 6973  _} if steps__ is
+0001b0f0: 206e 6f74 204e 6f6e 6520 656c 7365 207b   not None else {
+0001b100: 7d0a 2020 2020 2020 2020 6d65 7267 6564  }.        merged
+0001b110: 2e75 7064 6174 6528 6b77 6172 6773 290a  .update(kwargs).
+0001b120: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0001b130: 5f5f 696e 6974 5f5f 2820 2023 2074 7970  __init__(  # typ
+0001b140: 653a 2069 676e 6f72 655b 6361 6c6c 2d61  e: ignore[call-a
+0001b150: 7267 5d0a 2020 2020 2020 2020 2020 2020  rg].            
+0001b160: 7374 6570 735f 5f3d 7b6b 6579 3a20 636f  steps__={key: co
+0001b170: 6572 6365 5f74 6f5f 7275 6e6e 6162 6c65  erce_to_runnable
+0001b180: 2872 2920 666f 7220 6b65 792c 2072 2069  (r) for key, r i
+0001b190: 6e20 6d65 7267 6564 2e69 7465 6d73 2829  n merged.items()
+0001b1a0: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
+0001b1b0: 2040 636c 6173 736d 6574 686f 640a 2020   @classmethod.  
+0001b1c0: 2020 6465 6620 6973 5f6c 635f 7365 7269    def is_lc_seri
+0001b1d0: 616c 697a 6162 6c65 2863 6c73 2920 2d3e  alizable(cls) ->
+0001b1e0: 2062 6f6f 6c3a 0a20 2020 2020 2020 2072   bool:.        r
+0001b1f0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+0001b200: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
+0001b210: 2064 6566 2067 6574 5f6c 635f 6e61 6d65   def get_lc_name
+0001b220: 7370 6163 6528 636c 7329 202d 3e20 4c69  space(cls) -> Li
+0001b230: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+0001b240: 2022 2222 4765 7420 7468 6520 6e61 6d65   """Get the name
+0001b250: 7370 6163 6520 6f66 2074 6865 206c 616e  space of the lan
+0001b260: 6763 6861 696e 206f 626a 6563 742e 2222  gchain object.""
+0001b270: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+0001b280: 205b 226c 616e 6763 6861 696e 222c 2022   ["langchain", "
+0001b290: 7363 6865 6d61 222c 2022 7275 6e6e 6162  schema", "runnab
+0001b2a0: 6c65 225d 0a0a 2020 2020 636c 6173 7320  le"]..    class 
+0001b2b0: 436f 6e66 6967 3a0a 2020 2020 2020 2020  Config:.        
+0001b2c0: 6172 6269 7472 6172 795f 7479 7065 735f  arbitrary_types_
+0001b2d0: 616c 6c6f 7765 6420 3d20 5472 7565 0a0a  allowed = True..
+0001b2e0: 2020 2020 6465 6620 6765 745f 6e61 6d65      def get_name
+0001b2f0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001b300: 7375 6666 6978 3a20 4f70 7469 6f6e 616c  suffix: Optional
+0001b310: 5b73 7472 5d20 3d20 4e6f 6e65 2c20 2a2c  [str] = None, *,
+0001b320: 206e 616d 653a 204f 7074 696f 6e61 6c5b   name: Optional[
+0001b330: 7374 725d 203d 204e 6f6e 650a 2020 2020  str] = None.    
+0001b340: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+0001b350: 2020 6e61 6d65 203d 206e 616d 6520 6f72    name = name or
+0001b360: 2073 656c 662e 6e61 6d65 206f 7220 6622   self.name or f"
+0001b370: 5275 6e6e 6162 6c65 5061 7261 6c6c 656c  RunnableParallel
+0001b380: 3c7b 272c 272e 6a6f 696e 2873 656c 662e  <{','.join(self.
+0001b390: 7374 6570 735f 5f2e 6b65 7973 2829 297d  steps__.keys())}
+0001b3a0: 3e22 0a20 2020 2020 2020 2072 6574 7572  >".        retur
+0001b3b0: 6e20 7375 7065 7228 292e 6765 745f 6e61  n super().get_na
+0001b3c0: 6d65 2873 7566 6669 782c 206e 616d 653d  me(suffix, name=
+0001b3d0: 6e61 6d65 290a 0a20 2020 2040 7072 6f70  name)..    @prop
+0001b3e0: 6572 7479 0a20 2020 2064 6566 2049 6e70  erty.    def Inp
+0001b3f0: 7574 5479 7065 2873 656c 6629 202d 3e20  utType(self) -> 
+0001b400: 416e 793a 0a20 2020 2020 2020 2066 6f72  Any:.        for
+0001b410: 2073 7465 7020 696e 2073 656c 662e 7374   step in self.st
+0001b420: 6570 735f 5f2e 7661 6c75 6573 2829 3a0a  eps__.values():.
+0001b430: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001b440: 7465 702e 496e 7075 7454 7970 653a 0a20  tep.InputType:. 
+0001b450: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001b460: 6574 7572 6e20 7374 6570 2e49 6e70 7574  eturn step.Input
+0001b470: 5479 7065 0a0a 2020 2020 2020 2020 7265  Type..        re
+0001b480: 7475 726e 2041 6e79 0a0a 2020 2020 6465  turn Any..    de
+0001b490: 6620 6765 745f 696e 7075 745f 7363 6865  f get_input_sche
+0001b4a0: 6d61 280a 2020 2020 2020 2020 7365 6c66  ma(.        self
+0001b4b0: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
+0001b4c0: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+0001b4d0: 675d 203d 204e 6f6e 650a 2020 2020 2920  g] = None.    ) 
+0001b4e0: 2d3e 2054 7970 655b 4261 7365 4d6f 6465  -> Type[BaseMode
+0001b4f0: 6c5d 3a0a 2020 2020 2020 2020 6966 2061  l]:.        if a
+0001b500: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
+0001b510: 732e 6765 745f 696e 7075 745f 7363 6865  s.get_input_sche
+0001b520: 6d61 2863 6f6e 6669 6729 2e73 6368 656d  ma(config).schem
+0001b530: 6128 292e 6765 7428 2274 7970 6522 2c20  a().get("type", 
+0001b540: 226f 626a 6563 7422 2920 3d3d 2022 6f62  "object") == "ob
+0001b550: 6a65 6374 220a 2020 2020 2020 2020 2020  ject".          
+0001b560: 2020 666f 7220 7320 696e 2073 656c 662e    for s in self.
+0001b570: 7374 6570 735f 5f2e 7661 6c75 6573 2829  steps__.values()
+0001b580: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+0001b590: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+0001b5a0: 7320 636f 7272 6563 742c 2062 7574 2070  s correct, but p
+0001b5b0: 7964 616e 7469 6320 7479 7069 6e67 732f  ydantic typings/
+0001b5c0: 6d79 7079 2064 6f6e 2774 2074 6869 6e6b  mypy don't think
+0001b5d0: 2073 6f2e 0a20 2020 2020 2020 2020 2020   so..           
+0001b5e0: 2072 6574 7572 6e20 6372 6561 7465 5f6d   return create_m
+0001b5f0: 6f64 656c 2820 2023 2074 7970 653a 2069  odel(  # type: i
+0001b600: 676e 6f72 655b 6361 6c6c 2d6f 7665 726c  gnore[call-overl
+0001b610: 6f61 645d 0a20 2020 2020 2020 2020 2020  oad].           
+0001b620: 2020 2020 2073 656c 662e 6765 745f 6e61       self.get_na
+0001b630: 6d65 2822 496e 7075 7422 292c 0a20 2020  me("Input"),.   
+0001b640: 2020 2020 2020 2020 2020 2020 202a 2a7b               **{
+0001b650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b660: 2020 2020 206b 3a20 2876 2e61 6e6e 6f74       k: (v.annot
+0001b670: 6174 696f 6e2c 2076 2e64 6566 6175 6c74  ation, v.default
+0001b680: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b690: 2020 2020 2020 666f 7220 7374 6570 2069        for step i
+0001b6a0: 6e20 7365 6c66 2e73 7465 7073 5f5f 2e76  n self.steps__.v
+0001b6b0: 616c 7565 7328 290a 2020 2020 2020 2020  alues().        
+0001b6c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001b6d0: 6b2c 2076 2069 6e20 7374 6570 2e67 6574  k, v in step.get
+0001b6e0: 5f69 6e70 7574 5f73 6368 656d 6128 636f  _input_schema(co
+0001b6f0: 6e66 6967 292e 5f5f 6669 656c 6473 5f5f  nfig).__fields__
+0001b700: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+0001b710: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b720: 6b20 213d 2022 5f5f 726f 6f74 5f5f 220a  k != "__root__".
+0001b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b740: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
+0001b750: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001b760: 2073 7570 6572 2829 2e67 6574 5f69 6e70   super().get_inp
+0001b770: 7574 5f73 6368 656d 6128 636f 6e66 6967  ut_schema(config
+0001b780: 290a 0a20 2020 2064 6566 2067 6574 5f6f  )..    def get_o
+0001b790: 7574 7075 745f 7363 6865 6d61 280a 2020  utput_schema(.  
+0001b7a0: 2020 2020 2020 7365 6c66 2c20 636f 6e66        self, conf
+0001b7b0: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+0001b7c0: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+0001b7d0: 6f6e 650a 2020 2020 2920 2d3e 2054 7970  one.    ) -> Typ
+0001b7e0: 655b 4261 7365 4d6f 6465 6c5d 3a0a 2020  e[BaseModel]:.  
+0001b7f0: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
+0001b800: 636f 7272 6563 742c 2062 7574 2070 7964  correct, but pyd
+0001b810: 616e 7469 6320 7479 7069 6e67 732f 6d79  antic typings/my
+0001b820: 7079 2064 6f6e 2774 2074 6869 6e6b 2073  py don't think s
+0001b830: 6f2e 0a20 2020 2020 2020 2072 6574 7572  o..        retur
+0001b840: 6e20 6372 6561 7465 5f6d 6f64 656c 2820  n create_model( 
+0001b850: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+0001b860: 6361 6c6c 2d6f 7665 726c 6f61 645d 0a20  call-overload]. 
+0001b870: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001b880: 6765 745f 6e61 6d65 2822 4f75 7470 7574  get_name("Output
+0001b890: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001b8a0: 2a2a 7b6b 3a20 2876 2e4f 7574 7075 7454  **{k: (v.OutputT
+0001b8b0: 7970 652c 204e 6f6e 6529 2066 6f72 206b  ype, None) for k
+0001b8c0: 2c20 7620 696e 2073 656c 662e 7374 6570  , v in self.step
+0001b8d0: 735f 5f2e 6974 656d 7328 297d 2c0a 2020  s__.items()},.  
+0001b8e0: 2020 2020 2020 290a 0a20 2020 2040 7072        )..    @pr
+0001b8f0: 6f70 6572 7479 0a20 2020 2064 6566 2063  operty.    def c
+0001b900: 6f6e 6669 675f 7370 6563 7328 7365 6c66  onfig_specs(self
+0001b910: 2920 2d3e 204c 6973 745b 436f 6e66 6967  ) -> List[Config
+0001b920: 7572 6162 6c65 4669 656c 6453 7065 635d  urableFieldSpec]
+0001b930: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001b940: 2067 6574 5f75 6e69 7175 655f 636f 6e66   get_unique_conf
+0001b950: 6967 5f73 7065 6373 280a 2020 2020 2020  ig_specs(.      
+0001b960: 2020 2020 2020 7370 6563 2066 6f72 2073        spec for s
+0001b970: 7465 7020 696e 2073 656c 662e 7374 6570  tep in self.step
+0001b980: 735f 5f2e 7661 6c75 6573 2829 2066 6f72  s__.values() for
+0001b990: 2073 7065 6320 696e 2073 7465 702e 636f   spec in step.co
+0001b9a0: 6e66 6967 5f73 7065 6373 0a20 2020 2020  nfig_specs.     
+0001b9b0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
+0001b9c0: 745f 6772 6170 6828 7365 6c66 2c20 636f  t_graph(self, co
+0001b9d0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+0001b9e0: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+0001b9f0: 204e 6f6e 6529 202d 3e20 4772 6170 683a   None) -> Graph:
+0001ba00: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
+0001ba10: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
+0001ba20: 6e61 626c 6573 2e67 7261 7068 2069 6d70  nables.graph imp
+0001ba30: 6f72 7420 4772 6170 680a 0a20 2020 2020  ort Graph..     
+0001ba40: 2020 2067 7261 7068 203d 2047 7261 7068     graph = Graph
+0001ba50: 2829 0a20 2020 2020 2020 2069 6e70 7574  ().        input
+0001ba60: 5f6e 6f64 6520 3d20 6772 6170 682e 6164  _node = graph.ad
+0001ba70: 645f 6e6f 6465 2873 656c 662e 6765 745f  d_node(self.get_
+0001ba80: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
+0001ba90: 6669 6729 290a 2020 2020 2020 2020 6f75  fig)).        ou
+0001baa0: 7470 7574 5f6e 6f64 6520 3d20 6772 6170  tput_node = grap
+0001bab0: 682e 6164 645f 6e6f 6465 2873 656c 662e  h.add_node(self.
+0001bac0: 6765 745f 6f75 7470 7574 5f73 6368 656d  get_output_schem
+0001bad0: 6128 636f 6e66 6967 2929 0a20 2020 2020  a(config)).     
+0001bae0: 2020 2066 6f72 2073 7465 7020 696e 2073     for step in s
+0001baf0: 656c 662e 7374 6570 735f 5f2e 7661 6c75  elf.steps__.valu
+0001bb00: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+0001bb10: 2020 7374 6570 5f67 7261 7068 203d 2073    step_graph = s
+0001bb20: 7465 702e 6765 745f 6772 6170 6828 290a  tep.get_graph().
+0001bb30: 2020 2020 2020 2020 2020 2020 7374 6570              step
+0001bb40: 5f67 7261 7068 2e74 7269 6d5f 6669 7273  _graph.trim_firs
+0001bb50: 745f 6e6f 6465 2829 0a20 2020 2020 2020  t_node().       
+0001bb60: 2020 2020 2073 7465 705f 6772 6170 682e       step_graph.
+0001bb70: 7472 696d 5f6c 6173 745f 6e6f 6465 2829  trim_last_node()
+0001bb80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001bb90: 6e6f 7420 7374 6570 5f67 7261 7068 3a0a  not step_graph:.
+0001bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbb0: 6772 6170 682e 6164 645f 6564 6765 2869  graph.add_edge(i
+0001bbc0: 6e70 7574 5f6e 6f64 652c 206f 7574 7075  nput_node, outpu
+0001bbd0: 745f 6e6f 6465 290a 2020 2020 2020 2020  t_node).        
+0001bbe0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001bbf0: 2020 2020 2020 2020 2020 7374 6570 5f66            step_f
+0001bc00: 6972 7374 5f6e 6f64 652c 2073 7465 705f  irst_node, step_
+0001bc10: 6c61 7374 5f6e 6f64 6520 3d20 6772 6170  last_node = grap
+0001bc20: 682e 6578 7465 6e64 2873 7465 705f 6772  h.extend(step_gr
+0001bc30: 6170 6829 0a20 2020 2020 2020 2020 2020  aph).           
+0001bc40: 2020 2020 2069 6620 6e6f 7420 7374 6570       if not step
+0001bc50: 5f66 6972 7374 5f6e 6f64 653a 0a20 2020  _first_node:.   
+0001bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc70: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0001bc80: 7228 6622 5275 6e6e 6162 6c65 207b 7374  r(f"Runnable {st
+0001bc90: 6570 7d20 6861 7320 6e6f 2066 6972 7374  ep} has no first
+0001bca0: 206e 6f64 6522 290a 2020 2020 2020 2020   node").        
+0001bcb0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0001bcc0: 7465 705f 6c61 7374 5f6e 6f64 653a 0a20  tep_last_node:. 
+0001bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bce0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0001bcf0: 726f 7228 6622 5275 6e6e 6162 6c65 207b  ror(f"Runnable {
+0001bd00: 7374 6570 7d20 6861 7320 6e6f 206c 6173  step} has no las
+0001bd10: 7420 6e6f 6465 2229 0a20 2020 2020 2020  t node").       
+0001bd20: 2020 2020 2020 2020 2067 7261 7068 2e61           graph.a
+0001bd30: 6464 5f65 6467 6528 696e 7075 745f 6e6f  dd_edge(input_no
+0001bd40: 6465 2c20 7374 6570 5f66 6972 7374 5f6e  de, step_first_n
+0001bd50: 6f64 6529 0a20 2020 2020 2020 2020 2020  ode).           
+0001bd60: 2020 2020 2067 7261 7068 2e61 6464 5f65       graph.add_e
+0001bd70: 6467 6528 7374 6570 5f6c 6173 745f 6e6f  dge(step_last_no
+0001bd80: 6465 2c20 6f75 7470 7574 5f6e 6f64 6529  de, output_node)
+0001bd90: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001bda0: 2067 7261 7068 0a0a 2020 2020 6465 6620   graph..    def 
+0001bdb0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+0001bdc0: 3e20 7374 723a 0a20 2020 2020 2020 206d  > str:.        m
+0001bdd0: 6170 5f66 6f72 5f72 6570 7220 3d20 222c  ap_for_repr = ",
+0001bde0: 5c6e 2020 222e 6a6f 696e 280a 2020 2020  \n  ".join(.    
+0001bdf0: 2020 2020 2020 2020 6622 7b6b 7d3a 207b          f"{k}: {
+0001be00: 696e 6465 6e74 5f6c 696e 6573 5f61 6674  indent_lines_aft
+0001be10: 6572 5f66 6972 7374 2872 6570 7228 7629  er_first(repr(v)
+0001be20: 2c20 2720 2027 202b 206b 202b 2027 3a20  , '  ' + k + ': 
+0001be30: 2729 7d22 0a20 2020 2020 2020 2020 2020  ')}".           
+0001be40: 2066 6f72 206b 2c20 7620 696e 2073 656c   for k, v in sel
+0001be50: 662e 7374 6570 735f 5f2e 6974 656d 7328  f.steps__.items(
+0001be60: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0001be70: 2020 2020 7265 7475 726e 2022 7b5c 6e20      return "{\n 
+0001be80: 2022 202b 206d 6170 5f66 6f72 5f72 6570   " + map_for_rep
+0001be90: 7220 2b20 225c 6e7d 220a 0a20 2020 2064  r + "\n}"..    d
+0001bea0: 6566 2069 6e76 6f6b 6528 0a20 2020 2020  ef invoke(.     
+0001beb0: 2020 2073 656c 662c 2069 6e70 7574 3a20     self, input: 
+0001bec0: 496e 7075 742c 2063 6f6e 6669 673a 204f  Input, config: O
+0001bed0: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+0001bee0: 436f 6e66 6967 5d20 3d20 4e6f 6e65 0a20  Config] = None. 
+0001bef0: 2020 2029 202d 3e20 4469 6374 5b73 7472     ) -> Dict[str
+0001bf00: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+0001bf10: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+0001bf20: 6f72 652e 6361 6c6c 6261 636b 732e 6d61  ore.callbacks.ma
+0001bf30: 6e61 6765 7220 696d 706f 7274 2043 616c  nager import Cal
+0001bf40: 6c62 6163 6b4d 616e 6167 6572 0a0a 2020  lbackManager..  
+0001bf50: 2020 2020 2020 2320 7365 7475 7020 6361        # setup ca
+0001bf60: 6c6c 6261 636b 730a 2020 2020 2020 2020  llbacks.        
+0001bf70: 636f 6e66 6967 203d 2065 6e73 7572 655f  config = ensure_
+0001bf80: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
+0001bf90: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
+0001bfa0: 6d61 6e61 6765 7220 3d20 4361 6c6c 6261  manager = Callba
+0001bfb0: 636b 4d61 6e61 6765 722e 636f 6e66 6967  ckManager.config
+0001bfc0: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+0001bfd0: 2069 6e68 6572 6974 6162 6c65 5f63 616c   inheritable_cal
+0001bfe0: 6c62 6163 6b73 3d63 6f6e 6669 672e 6765  lbacks=config.ge
+0001bff0: 7428 2263 616c 6c62 6163 6b73 2229 2c0a  t("callbacks"),.
+0001c000: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+0001c010: 6c5f 6361 6c6c 6261 636b 733d 4e6f 6e65  l_callbacks=None
+0001c020: 2c0a 2020 2020 2020 2020 2020 2020 7665  ,.            ve
+0001c030: 7262 6f73 653d 4661 6c73 652c 0a20 2020  rbose=False,.   
+0001c040: 2020 2020 2020 2020 2069 6e68 6572 6974           inherit
+0001c050: 6162 6c65 5f74 6167 733d 636f 6e66 6967  able_tags=config
+0001c060: 2e67 6574 2822 7461 6773 2229 2c0a 2020  .get("tags"),.  
+0001c070: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
+0001c080: 7461 6773 3d4e 6f6e 652c 0a20 2020 2020  tags=None,.     
+0001c090: 2020 2020 2020 2069 6e68 6572 6974 6162         inheritab
+0001c0a0: 6c65 5f6d 6574 6164 6174 613d 636f 6e66  le_metadata=conf
+0001c0b0: 6967 2e67 6574 2822 6d65 7461 6461 7461  ig.get("metadata
+0001c0c0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001c0d0: 6c6f 6361 6c5f 6d65 7461 6461 7461 3d4e  local_metadata=N
+0001c0e0: 6f6e 652c 0a20 2020 2020 2020 2029 0a20  one,.        ). 
+0001c0f0: 2020 2020 2020 2023 2073 7461 7274 2074         # start t
+0001c100: 6865 2072 6f6f 7420 7275 6e0a 2020 2020  he root run.    
+0001c110: 2020 2020 7275 6e5f 6d61 6e61 6765 7220      run_manager 
+0001c120: 3d20 6361 6c6c 6261 636b 5f6d 616e 6167  = callback_manag
+0001c130: 6572 2e6f 6e5f 6368 6169 6e5f 7374 6172  er.on_chain_star
+0001c140: 7428 0a20 2020 2020 2020 2020 2020 2064  t(.            d
+0001c150: 756d 7064 2873 656c 6629 2c0a 2020 2020  umpd(self),.    
+0001c160: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+0001c170: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+0001c180: 636f 6e66 6967 2e67 6574 2822 7275 6e5f  config.get("run_
+0001c190: 6e61 6d65 2229 206f 7220 7365 6c66 2e67  name") or self.g
+0001c1a0: 6574 5f6e 616d 6528 292c 0a20 2020 2020  et_name(),.     
+0001c1b0: 2020 2020 2020 2072 756e 5f69 643d 636f         run_id=co
+0001c1c0: 6e66 6967 2e70 6f70 2822 7275 6e5f 6964  nfig.pop("run_id
+0001c1d0: 222c 204e 6f6e 6529 2c0a 2020 2020 2020  ", None),.      
+0001c1e0: 2020 290a 0a20 2020 2020 2020 2023 2067    )..        # g
+0001c1f0: 6174 6865 7220 7265 7375 6c74 7320 6672  ather results fr
+0001c200: 6f6d 2061 6c6c 2073 7465 7073 0a20 2020  om all steps.   
+0001c210: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001c220: 2020 2020 2020 2320 636f 7079 2074 6f20        # copy to 
+0001c230: 6176 6f69 6420 6973 7375 6573 2066 726f  avoid issues fro
+0001c240: 6d20 7468 6520 6361 6c6c 6572 206d 7574  m the caller mut
+0001c250: 6174 696e 6720 7468 6520 7374 6570 7320  ating the steps 
+0001c260: 6475 7269 6e67 2069 6e76 6f6b 6528 290a  during invoke().
+0001c270: 2020 2020 2020 2020 2020 2020 7374 6570              step
+0001c280: 7320 3d20 6469 6374 2873 656c 662e 7374  s = dict(self.st
+0001c290: 6570 735f 5f29 0a20 2020 2020 2020 2020  eps__).         
+0001c2a0: 2020 2077 6974 6820 6765 745f 6578 6563     with get_exec
+0001c2b0: 7574 6f72 5f66 6f72 5f63 6f6e 6669 6728  utor_for_config(
+0001c2c0: 636f 6e66 6967 2920 6173 2065 7865 6375  config) as execu
+0001c2d0: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
+0001c2e0: 2020 2020 2066 7574 7572 6573 203d 205b       futures = [
+0001c2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c300: 2020 2020 2065 7865 6375 746f 722e 7375       executor.su
+0001c310: 626d 6974 280a 2020 2020 2020 2020 2020  bmit(.          
+0001c320: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001c330: 6570 2e69 6e76 6f6b 652c 0a20 2020 2020  ep.invoke,.     
+0001c340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c350: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
+0001c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c370: 2020 2320 6d61 726b 2065 6163 6820 7374    # mark each st
+0001c380: 6570 2061 7320 6120 6368 696c 6420 7275  ep as a child ru
+0001c390: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0001c3a0: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+0001c3b0: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3d0: 2020 2020 636f 6e66 6967 2c0a 2020 2020      config,.    
+0001c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3f0: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
+0001c400: 733d 7275 6e5f 6d61 6e61 6765 722e 6765  s=run_manager.ge
+0001c410: 745f 6368 696c 6428 6622 6d61 703a 6b65  t_child(f"map:ke
+0001c420: 793a 7b6b 6579 7d22 292c 0a20 2020 2020  y:{key}"),.     
+0001c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c440: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+0001c450: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c470: 666f 7220 6b65 792c 2073 7465 7020 696e  for key, step in
+0001c480: 2073 7465 7073 2e69 7465 6d73 2829 0a20   steps.items(). 
+0001c490: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
 0001c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c4b0: 2020 2020 2020 2020 206f 7574 7075 7420           output 
-0001c4c0: 3d20 6f75 7470 7574 202b 2063 6875 6e6b  = output + chunk
-0001c4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c4e0: 2020 2020 2065 7863 6570 7420 5479 7065       except Type
-0001c4f0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001c500: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0001c510: 7574 7075 7420 3d20 6368 756e 6b0a 2020  utput = chunk.  
-0001c520: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001c530: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-0001c540: 2063 616c 6c5f 6675 6e63 5f77 6974 685f   call_func_with_
-0001c550: 7661 7269 6162 6c65 5f61 7267 7328 0a20  variable_args(. 
-0001c560: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c570: 656c 662e 6675 6e63 2c20 6361 7374 2849  elf.func, cast(I
-0001c580: 6e70 7574 2c20 6669 6e61 6c29 2c20 636f  nput, final), co
-0001c590: 6e66 6967 2c20 7275 6e5f 6d61 6e61 6765  nfig, run_manage
-0001c5a0: 722c 202a 2a6b 7761 7267 730a 2020 2020  r, **kwargs.    
-0001c5b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001c5c0: 2020 2023 2049 6620 7468 6520 6f75 7470     # If the outp
-0001c5d0: 7574 2069 7320 6120 7275 6e6e 6162 6c65  ut is a runnable
-0001c5e0: 2c20 7573 6520 6974 7320 7374 7265 616d  , use its stream
-0001c5f0: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0001c600: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-0001c610: 7470 7574 2c20 5275 6e6e 6162 6c65 293a  tput, Runnable):
-0001c620: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-0001c630: 7572 7369 6f6e 5f6c 696d 6974 203d 2063  ursion_limit = c
-0001c640: 6f6e 6669 675b 2272 6563 7572 7369 6f6e  onfig["recursion
-0001c650: 5f6c 696d 6974 225d 0a20 2020 2020 2020  _limit"].       
-0001c660: 2020 2020 2069 6620 7265 6375 7273 696f       if recursio
-0001c670: 6e5f 6c69 6d69 7420 3c3d 2030 3a0a 2020  n_limit <= 0:.  
-0001c680: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001c690: 6973 6520 5265 6375 7273 696f 6e45 7272  ise RecursionErr
-0001c6a0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001c6b0: 2020 2020 2020 2020 6622 5265 6375 7273          f"Recurs
-0001c6c0: 696f 6e20 6c69 6d69 7420 7265 6163 6865  ion limit reache
-0001c6d0: 6420 7768 656e 2069 6e76 6f6b 696e 6720  d when invoking 
-0001c6e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001c6f0: 2020 2020 2020 6622 7b73 656c 667d 2077        f"{self} w
-0001c700: 6974 6820 696e 7075 7420 7b66 696e 616c  ith input {final
-0001c710: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
-0001c720: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001c730: 2020 666f 7220 6368 756e 6b20 696e 206f    for chunk in o
-0001c740: 7574 7075 742e 7374 7265 616d 280a 2020  utput.stream(.  
-0001c750: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001c760: 6e61 6c2c 0a20 2020 2020 2020 2020 2020  nal,.           
-0001c770: 2020 2020 2070 6174 6368 5f63 6f6e 6669       patch_confi
-0001c780: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001c790: 2020 2020 2020 2063 6f6e 6669 672c 0a20         config,. 
-0001c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7b0: 2020 2063 616c 6c62 6163 6b73 3d72 756e     callbacks=run
-0001c7c0: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
-0001c7d0: 6c64 2829 2c0a 2020 2020 2020 2020 2020  ld(),.          
-0001c7e0: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
-0001c7f0: 696f 6e5f 6c69 6d69 743d 7265 6375 7273  ion_limit=recurs
-0001c800: 696f 6e5f 6c69 6d69 7420 2d20 312c 0a20  ion_limit - 1,. 
-0001c810: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001c820: 2c0a 2020 2020 2020 2020 2020 2020 293a  ,.            ):
-0001c830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c840: 2079 6965 6c64 2063 6875 6e6b 0a20 2020   yield chunk.   
-0001c850: 2020 2020 2065 6c69 6620 6e6f 7420 696e       elif not in
-0001c860: 7370 6563 742e 6973 6765 6e65 7261 746f  spect.isgenerato
-0001c870: 7266 756e 6374 696f 6e28 7365 6c66 2e66  rfunction(self.f
-0001c880: 756e 6329 3a0a 2020 2020 2020 2020 2020  unc):.          
-0001c890: 2020 2320 4f74 6865 7277 6973 652c 206a    # Otherwise, j
-0001c8a0: 7573 7420 7969 656c 6420 6974 0a20 2020  ust yield it.   
-0001c8b0: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-0001c8c0: 6173 7428 4f75 7470 7574 2c20 6f75 7470  ast(Output, outp
-0001c8d0: 7574 290a 0a20 2020 2064 6566 2074 7261  ut)..    def tra
-0001c8e0: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-0001c8f0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-0001c900: 7075 743a 2049 7465 7261 746f 725b 496e  put: Iterator[In
-0001c910: 7075 745d 2c0a 2020 2020 2020 2020 636f  put],.        co
-0001c920: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-0001c930: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-0001c940: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-0001c950: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
-0001c960: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
-0001c970: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
-0001c980: 5d3a 0a20 2020 2020 2020 2069 6620 6861  ]:.        if ha
-0001c990: 7361 7474 7228 7365 6c66 2c20 2266 756e  sattr(self, "fun
-0001c9a0: 6322 293a 0a20 2020 2020 2020 2020 2020  c"):.           
-0001c9b0: 2066 6f72 206f 7574 7075 7420 696e 2073   for output in s
-0001c9c0: 656c 662e 5f74 7261 6e73 666f 726d 5f73  elf._transform_s
-0001c9d0: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
-0001c9e0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001c9f0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-0001ca00: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001ca10: 7472 616e 7366 6f72 6d2c 0a20 2020 2020  transform,.     
-0001ca20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001ca30: 5f63 6f6e 6669 6728 636f 6e66 6967 2c20  _config(config, 
-0001ca40: 7365 6c66 2e66 756e 6329 2c0a 2020 2020  self.func),.    
-0001ca50: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-0001ca60: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
-0001ca70: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0001ca80: 2020 2020 2079 6965 6c64 206f 7574 7075       yield outpu
-0001ca90: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-0001caa0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001cab0: 6520 5479 7065 4572 726f 7228 0a20 2020  e TypeError(.   
-0001cac0: 2020 2020 2020 2020 2020 2020 2022 4361               "Ca
-0001cad0: 6e6e 6f74 2073 7472 6561 6d20 6120 636f  nnot stream a co
-0001cae0: 726f 7574 696e 6520 6675 6e63 7469 6f6e  routine function
-0001caf0: 2073 796e 6368 726f 6e6f 7573 6c79 2e22   synchronously."
-0001cb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cb10: 2022 5573 6520 6061 7374 7265 616d 6020   "Use `astream` 
-0001cb20: 696e 7374 6561 642e 220a 2020 2020 2020  instead.".      
-0001cb30: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0001cb40: 2073 7472 6561 6d28 0a20 2020 2020 2020   stream(.       
-0001cb50: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
-0001cb60: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
-0001cb70: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
-0001cb80: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
-0001cb90: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2020  nfig] = None,.  
-0001cba0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001cbb0: 4f70 7469 6f6e 616c 5b41 6e79 5d2c 0a20  Optional[Any],. 
-0001cbc0: 2020 2029 202d 3e20 4974 6572 6174 6f72     ) -> Iterator
-0001cbd0: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
-0001cbe0: 2020 7265 7475 726e 2073 656c 662e 7472    return self.tr
-0001cbf0: 616e 7366 6f72 6d28 6974 6572 285b 696e  ansform(iter([in
-0001cc00: 7075 745d 292c 2063 6f6e 6669 672c 202a  put]), config, *
-0001cc10: 2a6b 7761 7267 7329 0a0a 2020 2020 6173  *kwargs)..    as
-0001cc20: 796e 6320 6465 6620 5f61 7472 616e 7366  ync def _atransf
-0001cc30: 6f72 6d28 0a20 2020 2020 2020 2073 656c  orm(.        sel
-0001cc40: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
-0001cc50: 3a20 4173 796e 6349 7465 7261 746f 725b  : AsyncIterator[
-0001cc60: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-0001cc70: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
-0001cc80: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
-0001cc90: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-0001cca0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-0001ccb0: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-0001ccc0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001ccd0: 416e 792c 0a20 2020 2029 202d 3e20 4173  Any,.    ) -> As
-0001cce0: 796e 6349 7465 7261 746f 725b 4f75 7470  yncIterator[Outp
-0001ccf0: 7574 5d3a 0a20 2020 2020 2020 2066 696e  ut]:.        fin
-0001cd00: 616c 3a20 4f70 7469 6f6e 616c 5b49 6e70  al: Optional[Inp
-0001cd10: 7574 5d20 3d20 4e6f 6e65 0a20 2020 2020  ut] = None.     
-0001cd20: 2020 2061 7379 6e63 2066 6f72 2069 6368     async for ich
-0001cd30: 756e 6b20 696e 2069 6e70 7574 3a0a 2020  unk in input:.  
-0001cd40: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
-0001cd50: 616c 2069 7320 4e6f 6e65 3a0a 2020 2020  al is None:.    
-0001cd60: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0001cd70: 6c20 3d20 6963 6875 6e6b 0a20 2020 2020  l = ichunk.     
-0001cd80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001cd90: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0001cda0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cdb0: 2020 2020 2020 6669 6e61 6c20 3d20 6669        final = fi
-0001cdc0: 6e61 6c20 2b20 6963 6875 6e6b 2020 2320  nal + ichunk  # 
-0001cdd0: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
-0001cde0: 7261 746f 725d 0a20 2020 2020 2020 2020  rator].         
-0001cdf0: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
-0001ce00: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
-0001ce10: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-0001ce20: 616c 203d 2069 6368 756e 6b0a 0a20 2020  al = ichunk..   
-0001ce30: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
-0001ce40: 7365 6c66 2c20 2261 6675 6e63 2229 3a0a  self, "afunc"):.
-0001ce50: 2020 2020 2020 2020 2020 2020 6166 756e              afun
-0001ce60: 6320 3d20 7365 6c66 2e61 6675 6e63 0a20  c = self.afunc. 
-0001ce70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001ce80: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
-0001ce90: 6563 742e 6973 6765 6e65 7261 746f 7266  ect.isgeneratorf
-0001cea0: 756e 6374 696f 6e28 7365 6c66 2e66 756e  unction(self.fun
-0001ceb0: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
-0001cec0: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
-0001ced0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0001cee0: 2020 2020 2020 2020 2022 4361 6e6e 6f74           "Cannot
-0001cef0: 2073 7472 6561 6d20 6672 6f6d 2061 2067   stream from a g
-0001cf00: 656e 6572 6174 6f72 2066 756e 6374 696f  enerator functio
-0001cf10: 6e20 6173 796e 6368 726f 6e6f 7573 6c79  n asynchronously
-0001cf20: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-0001cf30: 2020 2020 2020 2022 5573 6520 2e73 7472         "Use .str
-0001cf40: 6561 6d28 2920 696e 7374 6561 642e 220a  eam() instead.".
-0001cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf60: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
-0001cf70: 6566 2066 756e 6328 0a20 2020 2020 2020  ef func(.       
-0001cf80: 2020 2020 2020 2020 2069 6e70 7574 3a20           input: 
-0001cf90: 496e 7075 742c 0a20 2020 2020 2020 2020  Input,.         
-0001cfa0: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
-0001cfb0: 6572 3a20 4173 796e 6343 616c 6c62 6163  er: AsyncCallbac
-0001cfc0: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
-0001cfd0: 5275 6e2c 0a20 2020 2020 2020 2020 2020  Run,.           
-0001cfe0: 2020 2020 2063 6f6e 6669 673a 2052 756e       config: Run
-0001cff0: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
-0001d000: 2020 2020 2020 2020 2029 202d 3e20 4f75           ) -> Ou
-0001d010: 7470 7574 3a0a 2020 2020 2020 2020 2020  tput:.          
-0001d020: 2020 2020 2020 7265 7475 726e 2063 616c        return cal
-0001d030: 6c5f 6675 6e63 5f77 6974 685f 7661 7269  l_func_with_vari
-0001d040: 6162 6c65 5f61 7267 7328 0a20 2020 2020  able_args(.     
-0001d050: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001d060: 656c 662e 6675 6e63 2c20 696e 7075 742c  elf.func, input,
-0001d070: 2063 6f6e 6669 672c 2072 756e 5f6d 616e   config, run_man
-0001d080: 6167 6572 2e67 6574 5f73 796e 6328 292c  ager.get_sync(),
-0001d090: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-0001d0a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001d0b0: 2020 2020 2020 2020 2040 7772 6170 7328           @wraps(
-0001d0c0: 6675 6e63 290a 2020 2020 2020 2020 2020  func).          
-0001d0d0: 2020 6173 796e 6320 6465 6620 6628 2a61    async def f(*a
-0001d0e0: 7267 732c 202a 2a6b 7761 7267 7329 3a20  rgs, **kwargs): 
-0001d0f0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-0001d100: 6e6f 2d75 6e74 7970 6564 2d64 6566 5d0a  no-untyped-def].
-0001d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d120: 7265 7475 726e 2061 7761 6974 2072 756e  return await run
-0001d130: 5f69 6e5f 6578 6563 7574 6f72 2863 6f6e  _in_executor(con
-0001d140: 6669 672c 2066 756e 632c 202a 6172 6773  fig, func, *args
-0001d150: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-0001d160: 2020 2020 2020 2020 2061 6675 6e63 203d           afunc =
-0001d170: 2066 0a0a 2020 2020 2020 2020 6966 2069   f..        if i
-0001d180: 6e73 7065 6374 2e69 7361 7379 6e63 6765  nspect.isasyncge
-0001d190: 6e66 756e 6374 696f 6e28 6166 756e 6329  nfunction(afunc)
-0001d1a0: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
-0001d1b0: 7470 7574 3a20 4f70 7469 6f6e 616c 5b4f  tput: Optional[O
-0001d1c0: 7574 7075 745d 203d 204e 6f6e 650a 2020  utput] = None.  
-0001d1d0: 2020 2020 2020 2020 2020 6173 796e 6320            async 
-0001d1e0: 666f 7220 6368 756e 6b20 696e 2063 6173  for chunk in cas
-0001d1f0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0001d200: 2020 2041 7379 6e63 4974 6572 6174 6f72     AsyncIterator
-0001d210: 5b4f 7574 7075 745d 2c0a 2020 2020 2020  [Output],.      
-0001d220: 2020 2020 2020 2020 2020 6163 616c 6c5f            acall_
-0001d230: 6675 6e63 5f77 6974 685f 7661 7269 6162  func_with_variab
-0001d240: 6c65 5f61 7267 7328 0a20 2020 2020 2020  le_args(.       
-0001d250: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0001d260: 7428 4361 6c6c 6162 6c65 2c20 6166 756e  t(Callable, afun
-0001d270: 6329 2c0a 2020 2020 2020 2020 2020 2020  c),.            
-0001d280: 2020 2020 2020 2020 6361 7374 2849 6e70          cast(Inp
-0001d290: 7574 2c20 6669 6e61 6c29 2c0a 2020 2020  ut, final),.    
-0001d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2b0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-0001d2c0: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
-0001d2d0: 6d61 6e61 6765 722c 0a20 2020 2020 2020  manager,.       
-0001d2e0: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
-0001d2f0: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
-0001d300: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0001d310: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-0001d320: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-0001d330: 6875 6e6b 0a20 2020 2020 2020 2020 2020  hunk.           
-0001d340: 2020 2020 2069 6620 6f75 7470 7574 2069       if output i
-0001d350: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001d360: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-0001d370: 7574 203d 2063 6875 6e6b 0a20 2020 2020  ut = chunk.     
-0001d380: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001d390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d3a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3c0: 2020 6f75 7470 7574 203d 206f 7574 7075    output = outpu
-0001d3d0: 7420 2b20 6368 756e 6b20 2023 2074 7970  t + chunk  # typ
-0001d3e0: 653a 2069 676e 6f72 655b 6f70 6572 6174  e: ignore[operat
-0001d3f0: 6f72 5d0a 2020 2020 2020 2020 2020 2020  or].            
-0001d400: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0001d410: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
-0001d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d430: 2020 6f75 7470 7574 203d 2063 6875 6e6b    output = chunk
-0001d440: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001d450: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0001d460: 7420 3d20 6177 6169 7420 6163 616c 6c5f  t = await acall_
-0001d470: 6675 6e63 5f77 6974 685f 7661 7269 6162  func_with_variab
-0001d480: 6c65 5f61 7267 7328 0a20 2020 2020 2020  le_args(.       
-0001d490: 2020 2020 2020 2020 2063 6173 7428 4361           cast(Ca
-0001d4a0: 6c6c 6162 6c65 2c20 6166 756e 6329 2c20  llable, afunc), 
-0001d4b0: 6361 7374 2849 6e70 7574 2c20 6669 6e61  cast(Input, fina
-0001d4c0: 6c29 2c20 636f 6e66 6967 2c20 7275 6e5f  l), config, run_
-0001d4d0: 6d61 6e61 6765 722c 202a 2a6b 7761 7267  manager, **kwarg
-0001d4e0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-0001d4f0: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
-0001d500: 6520 6f75 7470 7574 2069 7320 6120 7275  e output is a ru
-0001d510: 6e6e 6162 6c65 2c20 7573 6520 6974 7320  nnable, use its 
-0001d520: 6173 7472 6561 6d20 6f75 7470 7574 0a20  astream output. 
-0001d530: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0001d540: 616e 6365 286f 7574 7075 742c 2052 756e  ance(output, Run
-0001d550: 6e61 626c 6529 3a0a 2020 2020 2020 2020  nable):.        
-0001d560: 2020 2020 7265 6375 7273 696f 6e5f 6c69      recursion_li
-0001d570: 6d69 7420 3d20 636f 6e66 6967 5b22 7265  mit = config["re
-0001d580: 6375 7273 696f 6e5f 6c69 6d69 7422 5d0a  cursion_limit"].
-0001d590: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0001d5a0: 6563 7572 7369 6f6e 5f6c 696d 6974 203c  ecursion_limit <
-0001d5b0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0001d5c0: 2020 2020 2072 6169 7365 2052 6563 7572       raise Recur
-0001d5d0: 7369 6f6e 4572 726f 7228 0a20 2020 2020  sionError(.     
-0001d5e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001d5f0: 2252 6563 7572 7369 6f6e 206c 696d 6974  "Recursion limit
-0001d600: 2072 6561 6368 6564 2077 6865 6e20 696e   reached when in
-0001d610: 766f 6b69 6e67 2022 0a20 2020 2020 2020  voking ".       
-0001d620: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-0001d630: 7365 6c66 7d20 7769 7468 2069 6e70 7574  self} with input
-0001d640: 207b 6669 6e61 6c7d 2e22 0a20 2020 2020   {final}.".     
-0001d650: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d660: 2020 2020 2020 2020 2061 7379 6e63 2066           async f
-0001d670: 6f72 2063 6875 6e6b 2069 6e20 6f75 7470  or chunk in outp
-0001d680: 7574 2e61 7374 7265 616d 280a 2020 2020  ut.astream(.    
-0001d690: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0001d6a0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-0001d6b0: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
-0001d6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d6d0: 2020 2020 2063 6f6e 6669 672c 0a20 2020       config,.   
-0001d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6f0: 2063 616c 6c62 6163 6b73 3d72 756e 5f6d   callbacks=run_m
-0001d700: 616e 6167 6572 2e67 6574 5f63 6869 6c64  anager.get_child
-0001d710: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0001d720: 2020 2020 2020 2020 7265 6375 7273 696f          recursio
-0001d730: 6e5f 6c69 6d69 743d 7265 6375 7273 696f  n_limit=recursio
-0001d740: 6e5f 6c69 6d69 7420 2d20 312c 0a20 2020  n_limit - 1,.   
-0001d750: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-0001d760: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0001d770: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0001d780: 6965 6c64 2063 6875 6e6b 0a20 2020 2020  ield chunk.     
-0001d790: 2020 2065 6c69 6620 6e6f 7420 696e 7370     elif not insp
-0001d7a0: 6563 742e 6973 6173 796e 6367 656e 6675  ect.isasyncgenfu
-0001d7b0: 6e63 7469 6f6e 2861 6675 6e63 293a 0a20  nction(afunc):. 
-0001d7c0: 2020 2020 2020 2020 2020 2023 204f 7468             # Oth
-0001d7d0: 6572 7769 7365 2c20 6a75 7374 2079 6965  erwise, just yie
-0001d7e0: 6c64 2069 740a 2020 2020 2020 2020 2020  ld it.          
-0001d7f0: 2020 7969 656c 6420 6361 7374 284f 7574    yield cast(Out
-0001d800: 7075 742c 206f 7574 7075 7429 0a0a 2020  put, output)..  
-0001d810: 2020 6173 796e 6320 6465 6620 6174 7261    async def atra
-0001d820: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-0001d830: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-0001d840: 7075 743a 2041 7379 6e63 4974 6572 6174  put: AsyncIterat
-0001d850: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
-0001d860: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-0001d870: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0001d880: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-0001d890: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-0001d8a0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-0001d8b0: 2029 202d 3e20 4173 796e 6349 7465 7261   ) -> AsyncItera
-0001d8c0: 746f 725b 4f75 7470 7574 5d3a 0a20 2020  tor[Output]:.   
-0001d8d0: 2020 2020 2061 7379 6e63 2066 6f72 206f       async for o
-0001d8e0: 7574 7075 7420 696e 2073 656c 662e 5f61  utput in self._a
-0001d8f0: 7472 616e 7366 6f72 6d5f 7374 7265 616d  transform_stream
-0001d900: 5f77 6974 685f 636f 6e66 6967 280a 2020  _with_config(.  
-0001d910: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-0001d920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001d930: 662e 5f61 7472 616e 7366 6f72 6d2c 0a20  f._atransform,. 
-0001d940: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001d950: 5f63 6f6e 6669 6728 636f 6e66 6967 2c20  _config(config, 
-0001d960: 7365 6c66 2e61 6675 6e63 2069 6620 6861  self.afunc if ha
-0001d970: 7361 7474 7228 7365 6c66 2c20 2261 6675  sattr(self, "afu
-0001d980: 6e63 2229 2065 6c73 6520 7365 6c66 2e66  nc") else self.f
-0001d990: 756e 6329 2c0a 2020 2020 2020 2020 2020  unc),.          
-0001d9a0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0001d9b0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0001d9c0: 2020 2079 6965 6c64 206f 7574 7075 740a     yield output.
-0001d9d0: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
-0001d9e0: 7374 7265 616d 280a 2020 2020 2020 2020  stream(.        
-0001d9f0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-0001da00: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
-0001da10: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
-0001da20: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
-0001da30: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
-0001da40: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
-0001da50: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
-0001da60: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
-0001da70: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
-0001da80: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
-0001da90: 696e 7075 745f 6169 7465 7228 2920 2d3e  input_aiter() ->
-0001daa0: 2041 7379 6e63 4974 6572 6174 6f72 5b49   AsyncIterator[I
-0001dab0: 6e70 7574 5d3a 0a20 2020 2020 2020 2020  nput]:.         
-0001dac0: 2020 2079 6965 6c64 2069 6e70 7574 0a0a     yield input..
-0001dad0: 2020 2020 2020 2020 6173 796e 6320 666f          async fo
-0001dae0: 7220 6368 756e 6b20 696e 2073 656c 662e  r chunk in self.
-0001daf0: 6174 7261 6e73 666f 726d 2869 6e70 7574  atransform(input
-0001db00: 5f61 6974 6572 2829 2c20 636f 6e66 6967  _aiter(), config
-0001db10: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001db20: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-0001db30: 6875 6e6b 0a0a 0a63 6c61 7373 2052 756e  hunk...class Run
-0001db40: 6e61 626c 6545 6163 6842 6173 6528 5275  nableEachBase(Ru
-0001db50: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
-0001db60: 6c65 5b4c 6973 745b 496e 7075 745d 2c20  le[List[Input], 
-0001db70: 4c69 7374 5b4f 7574 7075 745d 5d29 3a0a  List[Output]]):.
-0001db80: 2020 2020 2222 220a 2020 2020 4120 7275      """.    A ru
-0001db90: 6e6e 6162 6c65 2074 6861 7420 6465 6c65  nnable that dele
-0001dba0: 6761 7465 7320 6361 6c6c 7320 746f 2061  gates calls to a
-0001dbb0: 6e6f 7468 6572 2072 756e 6e61 626c 650a  nother runnable.
-0001dbc0: 2020 2020 7769 7468 2065 6163 6820 656c      with each el
-0001dbd0: 656d 656e 7420 6f66 2074 6865 2069 6e70  ement of the inp
-0001dbe0: 7574 2073 6571 7565 6e63 652e 0a0a 2020  ut sequence...  
-0001dbf0: 2020 5573 6520 6f6e 6c79 2069 6620 6372    Use only if cr
-0001dc00: 6561 7469 6e67 2061 206e 6577 2052 756e  eating a new Run
-0001dc10: 6e61 626c 6545 6163 6820 7375 6263 6c61  nableEach subcla
-0001dc20: 7373 2077 6974 6820 6469 6666 6572 656e  ss with differen
-0001dc30: 7420 5f5f 696e 6974 5f5f 2061 7267 732e  t __init__ args.
-0001dc40: 0a20 2020 2022 2222 0a0a 2020 2020 626f  .    """..    bo
-0001dc50: 756e 643a 2052 756e 6e61 626c 655b 496e  und: Runnable[In
-0001dc60: 7075 742c 204f 7574 7075 745d 0a0a 2020  put, Output]..  
-0001dc70: 2020 636c 6173 7320 436f 6e66 6967 3a0a    class Config:.
-0001dc80: 2020 2020 2020 2020 6172 6269 7472 6172          arbitrar
-0001dc90: 795f 7479 7065 735f 616c 6c6f 7765 6420  y_types_allowed 
-0001dca0: 3d20 5472 7565 0a0a 2020 2020 4070 726f  = True..    @pro
-0001dcb0: 7065 7274 790a 2020 2020 6465 6620 496e  perty.    def In
-0001dcc0: 7075 7454 7970 6528 7365 6c66 2920 2d3e  putType(self) ->
-0001dcd0: 2041 6e79 3a0a 2020 2020 2020 2020 7265   Any:.        re
-0001dce0: 7475 726e 204c 6973 745b 7365 6c66 2e62  turn List[self.b
-0001dcf0: 6f75 6e64 2e49 6e70 7574 5479 7065 5d20  ound.InputType] 
-0001dd00: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-0001dd10: 6e61 6d65 2d64 6566 696e 6564 5d0a 0a20  name-defined].. 
-0001dd20: 2020 2064 6566 2067 6574 5f69 6e70 7574     def get_input
-0001dd30: 5f73 6368 656d 6128 0a20 2020 2020 2020  _schema(.       
-0001dd40: 2073 656c 662c 2063 6f6e 6669 673a 204f   self, config: O
-0001dd50: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-0001dd60: 436f 6e66 6967 5d20 3d20 4e6f 6e65 0a20  Config] = None. 
-0001dd70: 2020 2029 202d 3e20 5479 7065 5b42 6173     ) -> Type[Bas
-0001dd80: 654d 6f64 656c 5d3a 0a20 2020 2020 2020  eModel]:.       
-0001dd90: 2072 6574 7572 6e20 6372 6561 7465 5f6d   return create_m
-0001dda0: 6f64 656c 280a 2020 2020 2020 2020 2020  odel(.          
-0001ddb0: 2020 7365 6c66 2e67 6574 5f6e 616d 6528    self.get_name(
-0001ddc0: 2249 6e70 7574 2229 2c0a 2020 2020 2020  "Input"),.      
-0001ddd0: 2020 2020 2020 5f5f 726f 6f74 5f5f 3d28        __root__=(
-0001dde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ddf0: 204c 6973 745b 7365 6c66 2e62 6f75 6e64   List[self.bound
-0001de00: 2e67 6574 5f69 6e70 7574 5f73 6368 656d  .get_input_schem
-0001de10: 6128 636f 6e66 6967 295d 2c20 2023 2074  a(config)],  # t
-0001de20: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-0001de30: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
-0001de40: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-0001de50: 0a20 2020 2020 2020 2020 2020 205f 5f63  .            __c
-0001de60: 6f6e 6669 675f 5f3d 5f53 6368 656d 6143  onfig__=_SchemaC
-0001de70: 6f6e 6669 672c 0a20 2020 2020 2020 2029  onfig,.        )
-0001de80: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0001de90: 2020 2020 6465 6620 4f75 7470 7574 5479      def OutputTy
-0001dea0: 7065 2873 656c 6629 202d 3e20 5479 7065  pe(self) -> Type
-0001deb0: 5b4c 6973 745b 4f75 7470 7574 5d5d 3a0a  [List[Output]]:.
-0001dec0: 2020 2020 2020 2020 7265 7475 726e 204c          return L
-0001ded0: 6973 745b 7365 6c66 2e62 6f75 6e64 2e4f  ist[self.bound.O
-0001dee0: 7574 7075 7454 7970 655d 2020 2320 7479  utputType]  # ty
-0001def0: 7065 3a20 6967 6e6f 7265 5b6e 616d 652d  pe: ignore[name-
-0001df00: 6465 6669 6e65 645d 0a0a 2020 2020 6465  defined]..    de
-0001df10: 6620 6765 745f 6f75 7470 7574 5f73 6368  f get_output_sch
-0001df20: 656d 6128 0a20 2020 2020 2020 2073 656c  ema(.        sel
-0001df30: 662c 2063 6f6e 6669 673a 204f 7074 696f  f, config: Optio
-0001df40: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0001df50: 6967 5d20 3d20 4e6f 6e65 0a20 2020 2029  ig] = None.    )
-0001df60: 202d 3e20 5479 7065 5b42 6173 654d 6f64   -> Type[BaseMod
-0001df70: 656c 5d3a 0a20 2020 2020 2020 2073 6368  el]:.        sch
-0001df80: 656d 6120 3d20 7365 6c66 2e62 6f75 6e64  ema = self.bound
-0001df90: 2e67 6574 5f6f 7574 7075 745f 7363 6865  .get_output_sche
-0001dfa0: 6d61 2863 6f6e 6669 6729 0a20 2020 2020  ma(config).     
-0001dfb0: 2020 2072 6574 7572 6e20 6372 6561 7465     return create
-0001dfc0: 5f6d 6f64 656c 280a 2020 2020 2020 2020  _model(.        
-0001dfd0: 2020 2020 7365 6c66 2e67 6574 5f6e 616d      self.get_nam
-0001dfe0: 6528 224f 7574 7075 7422 292c 0a20 2020  e("Output"),.   
-0001dff0: 2020 2020 2020 2020 205f 5f72 6f6f 745f           __root_
-0001e000: 5f3d 280a 2020 2020 2020 2020 2020 2020  _=(.            
-0001e010: 2020 2020 4c69 7374 5b73 6368 656d 615d      List[schema]
-0001e020: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
-0001e030: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001e040: 2020 4e6f 6e65 2c0a 2020 2020 2020 2020    None,.        
-0001e050: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001e060: 2020 205f 5f63 6f6e 6669 675f 5f3d 5f53     __config__=_S
-0001e070: 6368 656d 6143 6f6e 6669 672c 0a20 2020  chemaConfig,.   
-0001e080: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
-0001e090: 7065 7274 790a 2020 2020 6465 6620 636f  perty.    def co
-0001e0a0: 6e66 6967 5f73 7065 6373 2873 656c 6629  nfig_specs(self)
-0001e0b0: 202d 3e20 4c69 7374 5b43 6f6e 6669 6775   -> List[Configu
-0001e0c0: 7261 626c 6546 6965 6c64 5370 6563 5d3a  rableFieldSpec]:
-0001e0d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001e0e0: 7365 6c66 2e62 6f75 6e64 2e63 6f6e 6669  self.bound.confi
-0001e0f0: 675f 7370 6563 730a 0a20 2020 2064 6566  g_specs..    def
-0001e100: 2067 6574 5f67 7261 7068 2873 656c 662c   get_graph(self,
-0001e110: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
-0001e120: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
-0001e130: 5d20 3d20 4e6f 6e65 2920 2d3e 2047 7261  ] = None) -> Gra
-0001e140: 7068 3a0a 2020 2020 2020 2020 7265 7475  ph:.        retu
-0001e150: 726e 2073 656c 662e 626f 756e 642e 6765  rn self.bound.ge
-0001e160: 745f 6772 6170 6828 636f 6e66 6967 290a  t_graph(config).
-0001e170: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-0001e180: 640a 2020 2020 6465 6620 6973 5f6c 635f  d.    def is_lc_
-0001e190: 7365 7269 616c 697a 6162 6c65 2863 6c73  serializable(cls
-0001e1a0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0001e1b0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0001e1c0: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
-0001e1d0: 0a20 2020 2064 6566 2067 6574 5f6c 635f  .    def get_lc_
-0001e1e0: 6e61 6d65 7370 6163 6528 636c 7329 202d  namespace(cls) -
-0001e1f0: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
-0001e200: 2020 2020 2022 2222 4765 7420 7468 6520       """Get the 
-0001e210: 6e61 6d65 7370 6163 6520 6f66 2074 6865  namespace of the
-0001e220: 206c 616e 6763 6861 696e 206f 626a 6563   langchain objec
-0001e230: 742e 2222 220a 2020 2020 2020 2020 7265  t.""".        re
-0001e240: 7475 726e 205b 226c 616e 6763 6861 696e  turn ["langchain
-0001e250: 222c 2022 7363 6865 6d61 222c 2022 7275  ", "schema", "ru
-0001e260: 6e6e 6162 6c65 225d 0a0a 2020 2020 6465  nnable"]..    de
-0001e270: 6620 5f69 6e76 6f6b 6528 0a20 2020 2020  f _invoke(.     
-0001e280: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001e290: 2069 6e70 7574 733a 204c 6973 745b 496e   inputs: List[In
-0001e2a0: 7075 745d 2c0a 2020 2020 2020 2020 7275  put],.        ru
-0001e2b0: 6e5f 6d61 6e61 6765 723a 2043 616c 6c62  n_manager: Callb
-0001e2c0: 6163 6b4d 616e 6167 6572 466f 7243 6861  ackManagerForCha
-0001e2d0: 696e 5275 6e2c 0a20 2020 2020 2020 2063  inRun,.        c
-0001e2e0: 6f6e 6669 673a 2052 756e 6e61 626c 6543  onfig: RunnableC
-0001e2f0: 6f6e 6669 672c 0a20 2020 2020 2020 202a  onfig,.        *
-0001e300: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
-0001e310: 2020 2920 2d3e 204c 6973 745b 4f75 7470    ) -> List[Outp
-0001e320: 7574 5d3a 0a20 2020 2020 2020 2072 6574  ut]:.        ret
-0001e330: 7572 6e20 7365 6c66 2e62 6f75 6e64 2e62  urn self.bound.b
-0001e340: 6174 6368 280a 2020 2020 2020 2020 2020  atch(.          
-0001e350: 2020 696e 7075 7473 2c20 7061 7463 685f    inputs, patch_
-0001e360: 636f 6e66 6967 2863 6f6e 6669 672c 2063  config(config, c
-0001e370: 616c 6c62 6163 6b73 3d72 756e 5f6d 616e  allbacks=run_man
-0001e380: 6167 6572 2e67 6574 5f63 6869 6c64 2829  ager.get_child()
-0001e390: 292c 202a 2a6b 7761 7267 730a 2020 2020  ), **kwargs.    
-0001e3a0: 2020 2020 290a 0a20 2020 2064 6566 2069      )..    def i
-0001e3b0: 6e76 6f6b 6528 0a20 2020 2020 2020 2073  nvoke(.        s
-0001e3c0: 656c 662c 2069 6e70 7574 3a20 4c69 7374  elf, input: List
-0001e3d0: 5b49 6e70 7574 5d2c 2063 6f6e 6669 673a  [Input], config:
-0001e3e0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-0001e3f0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-0001e400: 2c20 2a2a 6b77 6172 6773 3a20 416e 790a  , **kwargs: Any.
-0001e410: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
-0001e420: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
-0001e430: 6574 7572 6e20 7365 6c66 2e5f 6361 6c6c  eturn self._call
-0001e440: 5f77 6974 685f 636f 6e66 6967 2873 656c  _with_config(sel
-0001e450: 662e 5f69 6e76 6f6b 652c 2069 6e70 7574  f._invoke, input
-0001e460: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
-0001e470: 6773 290a 0a20 2020 2061 7379 6e63 2064  gs)..    async d
-0001e480: 6566 205f 6169 6e76 6f6b 6528 0a20 2020  ef _ainvoke(.   
-0001e490: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001e4a0: 2020 2069 6e70 7574 733a 204c 6973 745b     inputs: List[
-0001e4b0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-0001e4c0: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
-0001e4d0: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
-0001e4e0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-0001e4f0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-0001e500: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-0001e510: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001e520: 416e 792c 0a20 2020 2029 202d 3e20 4c69  Any,.    ) -> Li
-0001e530: 7374 5b4f 7574 7075 745d 3a0a 2020 2020  st[Output]:.    
-0001e540: 2020 2020 7265 7475 726e 2061 7761 6974      return await
-0001e550: 2073 656c 662e 626f 756e 642e 6162 6174   self.bound.abat
-0001e560: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
-0001e570: 696e 7075 7473 2c20 7061 7463 685f 636f  inputs, patch_co
-0001e580: 6e66 6967 2863 6f6e 6669 672c 2063 616c  nfig(config, cal
-0001e590: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
-0001e5a0: 6572 2e67 6574 5f63 6869 6c64 2829 292c  er.get_child()),
-0001e5b0: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-0001e5c0: 2020 290a 0a20 2020 2061 7379 6e63 2064    )..    async d
-0001e5d0: 6566 2061 696e 766f 6b65 280a 2020 2020  ef ainvoke(.    
-0001e5e0: 2020 2020 7365 6c66 2c20 696e 7075 743a      self, input:
-0001e5f0: 204c 6973 745b 496e 7075 745d 2c20 636f   List[Input], co
-0001e600: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-0001e610: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-0001e620: 204e 6f6e 652c 202a 2a6b 7761 7267 733a   None, **kwargs:
-0001e630: 2041 6e79 0a20 2020 2029 202d 3e20 4c69   Any.    ) -> Li
-0001e640: 7374 5b4f 7574 7075 745d 3a0a 2020 2020  st[Output]:.    
-0001e650: 2020 2020 7265 7475 726e 2061 7761 6974      return await
-0001e660: 2073 656c 662e 5f61 6361 6c6c 5f77 6974   self._acall_wit
-0001e670: 685f 636f 6e66 6967 2873 656c 662e 5f61  h_config(self._a
-0001e680: 696e 766f 6b65 2c20 696e 7075 742c 2063  invoke, input, c
-0001e690: 6f6e 6669 672c 202a 2a6b 7761 7267 7329  onfig, **kwargs)
-0001e6a0: 0a0a 0a63 6c61 7373 2052 756e 6e61 626c  ...class Runnabl
-0001e6b0: 6545 6163 6828 5275 6e6e 6162 6c65 4561  eEach(RunnableEa
-0001e6c0: 6368 4261 7365 5b49 6e70 7574 2c20 4f75  chBase[Input, Ou
-0001e6d0: 7470 7574 5d29 3a0a 2020 2020 2222 220a  tput]):.    """.
-0001e6e0: 2020 2020 4120 7275 6e6e 6162 6c65 2074      A runnable t
-0001e6f0: 6861 7420 6465 6c65 6761 7465 7320 6361  hat delegates ca
-0001e700: 6c6c 7320 746f 2061 6e6f 7468 6572 2072  lls to another r
-0001e710: 756e 6e61 626c 650a 2020 2020 7769 7468  unnable.    with
-0001e720: 2065 6163 6820 656c 656d 656e 7420 6f66   each element of
-0001e730: 2074 6865 2069 6e70 7574 2073 6571 7565   the input seque
-0001e740: 6e63 652e 0a20 2020 2022 2222 0a0a 2020  nce..    """..  
-0001e750: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
-0001e760: 2020 2064 6566 2067 6574 5f6c 635f 6e61     def get_lc_na
-0001e770: 6d65 7370 6163 6528 636c 7329 202d 3e20  mespace(cls) -> 
-0001e780: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
-0001e790: 2020 2022 2222 4765 7420 7468 6520 6e61     """Get the na
-0001e7a0: 6d65 7370 6163 6520 6f66 2074 6865 206c  mespace of the l
-0001e7b0: 616e 6763 6861 696e 206f 626a 6563 742e  angchain object.
-0001e7c0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-0001e7d0: 726e 205b 226c 616e 6763 6861 696e 222c  rn ["langchain",
-0001e7e0: 2022 7363 6865 6d61 222c 2022 7275 6e6e   "schema", "runn
-0001e7f0: 6162 6c65 225d 0a0a 2020 2020 6465 6620  able"]..    def 
-0001e800: 6765 745f 6e61 6d65 280a 2020 2020 2020  get_name(.      
-0001e810: 2020 7365 6c66 2c20 7375 6666 6978 3a20    self, suffix: 
-0001e820: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0001e830: 4e6f 6e65 2c20 2a2c 206e 616d 653a 204f  None, *, name: O
-0001e840: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-0001e850: 6f6e 650a 2020 2020 2920 2d3e 2073 7472  one.    ) -> str
-0001e860: 3a0a 2020 2020 2020 2020 6e61 6d65 203d  :.        name =
-0001e870: 206e 616d 6520 6f72 2073 656c 662e 6e61   name or self.na
-0001e880: 6d65 206f 7220 6622 5275 6e6e 6162 6c65  me or f"Runnable
-0001e890: 4561 6368 3c7b 7365 6c66 2e62 6f75 6e64  Each<{self.bound
-0001e8a0: 2e67 6574 5f6e 616d 6528 297d 3e22 0a20  .get_name()}>". 
-0001e8b0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-0001e8c0: 7065 7228 292e 6765 745f 6e61 6d65 2873  per().get_name(s
-0001e8d0: 7566 6669 782c 206e 616d 653d 6e61 6d65  uffix, name=name
-0001e8e0: 290a 0a20 2020 2064 6566 2062 696e 6428  )..    def bind(
-0001e8f0: 7365 6c66 2c20 2a2a 6b77 6172 6773 3a20  self, **kwargs: 
-0001e900: 416e 7929 202d 3e20 5275 6e6e 6162 6c65  Any) -> Runnable
-0001e910: 4561 6368 5b49 6e70 7574 2c20 4f75 7470  Each[Input, Outp
-0001e920: 7574 5d3a 0a20 2020 2020 2020 2072 6574  ut]:.        ret
-0001e930: 7572 6e20 5275 6e6e 6162 6c65 4561 6368  urn RunnableEach
-0001e940: 2862 6f75 6e64 3d73 656c 662e 626f 756e  (bound=self.boun
-0001e950: 642e 6269 6e64 282a 2a6b 7761 7267 7329  d.bind(**kwargs)
-0001e960: 290a 0a20 2020 2064 6566 2077 6974 685f  )..    def with_
-0001e970: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
-0001e980: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
-0001e990: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-0001e9a0: 6f6e 6669 675d 203d 204e 6f6e 652c 202a  onfig] = None, *
-0001e9b0: 2a6b 7761 7267 733a 2041 6e79 0a20 2020  *kwargs: Any.   
-0001e9c0: 2029 202d 3e20 5275 6e6e 6162 6c65 4561   ) -> RunnableEa
-0001e9d0: 6368 5b49 6e70 7574 2c20 4f75 7470 7574  ch[Input, Output
-0001e9e0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-0001e9f0: 6e20 5275 6e6e 6162 6c65 4561 6368 2862  n RunnableEach(b
-0001ea00: 6f75 6e64 3d73 656c 662e 626f 756e 642e  ound=self.bound.
-0001ea10: 7769 7468 5f63 6f6e 6669 6728 636f 6e66  with_config(conf
-0001ea20: 6967 2c20 2a2a 6b77 6172 6773 2929 0a0a  ig, **kwargs))..
-0001ea30: 2020 2020 6465 6620 7769 7468 5f6c 6973      def with_lis
-0001ea40: 7465 6e65 7273 280a 2020 2020 2020 2020  teners(.        
-0001ea50: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-0001ea60: 0a20 2020 2020 2020 206f 6e5f 7374 6172  .        on_star
-0001ea70: 743a 204f 7074 696f 6e61 6c5b 4c69 7374  t: Optional[List
-0001ea80: 656e 6572 5d20 3d20 4e6f 6e65 2c0a 2020  ener] = None,.  
-0001ea90: 2020 2020 2020 6f6e 5f65 6e64 3a20 4f70        on_end: Op
-0001eaa0: 7469 6f6e 616c 5b4c 6973 7465 6e65 725d  tional[Listener]
-0001eab0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0001eac0: 206f 6e5f 6572 726f 723a 204f 7074 696f   on_error: Optio
-0001ead0: 6e61 6c5b 4c69 7374 656e 6572 5d20 3d20  nal[Listener] = 
-0001eae0: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
-0001eaf0: 756e 6e61 626c 6545 6163 685b 496e 7075  unnableEach[Inpu
-0001eb00: 742c 204f 7574 7075 745d 3a0a 2020 2020  t, Output]:.    
-0001eb10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001eb20: 4269 6e64 206c 6966 6563 7963 6c65 206c  Bind lifecycle l
-0001eb30: 6973 7465 6e65 7273 2074 6f20 6120 5275  isteners to a Ru
-0001eb40: 6e6e 6162 6c65 2c20 7265 7475 726e 696e  nnable, returnin
-0001eb50: 6720 6120 6e65 7720 5275 6e6e 6162 6c65  g a new Runnable
-0001eb60: 2e0a 0a20 2020 2020 2020 206f 6e5f 7374  ...        on_st
-0001eb70: 6172 743a 2043 616c 6c65 6420 6265 666f  art: Called befo
-0001eb80: 7265 2074 6865 2072 756e 6e61 626c 6520  re the runnable 
-0001eb90: 7374 6172 7473 2072 756e 6e69 6e67 2c20  starts running, 
-0001eba0: 7769 7468 2074 6865 2052 756e 206f 626a  with the Run obj
-0001ebb0: 6563 742e 0a20 2020 2020 2020 206f 6e5f  ect..        on_
-0001ebc0: 656e 643a 2043 616c 6c65 6420 6166 7465  end: Called afte
-0001ebd0: 7220 7468 6520 7275 6e6e 6162 6c65 2066  r the runnable f
-0001ebe0: 696e 6973 6865 7320 7275 6e6e 696e 672c  inishes running,
-0001ebf0: 2077 6974 6820 7468 6520 5275 6e20 6f62   with the Run ob
-0001ec00: 6a65 6374 2e0a 2020 2020 2020 2020 6f6e  ject..        on
-0001ec10: 5f65 7272 6f72 3a20 4361 6c6c 6564 2069  _error: Called i
-0001ec20: 6620 7468 6520 7275 6e6e 6162 6c65 2074  f the runnable t
-0001ec30: 6872 6f77 7320 616e 2065 7272 6f72 2c20  hrows an error, 
-0001ec40: 7769 7468 2074 6865 2052 756e 206f 626a  with the Run obj
-0001ec50: 6563 742e 0a0a 2020 2020 2020 2020 5468  ect...        Th
-0001ec60: 6520 5275 6e20 6f62 6a65 6374 2063 6f6e  e Run object con
-0001ec70: 7461 696e 7320 696e 666f 726d 6174 696f  tains informatio
-0001ec80: 6e20 6162 6f75 7420 7468 6520 7275 6e2c  n about the run,
-0001ec90: 2069 6e63 6c75 6469 6e67 2069 7473 2069   including its i
-0001eca0: 642c 0a20 2020 2020 2020 2074 7970 652c  d,.        type,
-0001ecb0: 2069 6e70 7574 2c20 6f75 7470 7574 2c20   input, output, 
-0001ecc0: 6572 726f 722c 2073 7461 7274 5f74 696d  error, start_tim
-0001ecd0: 652c 2065 6e64 5f74 696d 652c 2061 6e64  e, end_time, and
-0001ece0: 2061 6e79 2074 6167 7320 6f72 206d 6574   any tags or met
-0001ecf0: 6164 6174 610a 2020 2020 2020 2020 6164  adata.        ad
-0001ed00: 6465 6420 746f 2074 6865 2072 756e 2e0a  ded to the run..
-0001ed10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001ed20: 2020 2020 7265 7475 726e 2052 756e 6e61      return Runna
-0001ed30: 626c 6545 6163 6828 0a20 2020 2020 2020  bleEach(.       
-0001ed40: 2020 2020 2062 6f75 6e64 3d73 656c 662e       bound=self.
-0001ed50: 626f 756e 642e 7769 7468 5f6c 6973 7465  bound.with_liste
-0001ed60: 6e65 7273 280a 2020 2020 2020 2020 2020  ners(.          
-0001ed70: 2020 2020 2020 6f6e 5f73 7461 7274 3d6f        on_start=o
-0001ed80: 6e5f 7374 6172 742c 206f 6e5f 656e 643d  n_start, on_end=
-0001ed90: 6f6e 5f65 6e64 2c20 6f6e 5f65 7272 6f72  on_end, on_error
-0001eda0: 3d6f 6e5f 6572 726f 720a 2020 2020 2020  =on_error.      
-0001edb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001edc0: 290a 0a0a 636c 6173 7320 5275 6e6e 6162  )...class Runnab
-0001edd0: 6c65 4269 6e64 696e 6742 6173 6528 5275  leBindingBase(Ru
-0001ede0: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
-0001edf0: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-0001ee00: 5d29 3a0a 2020 2020 2222 2241 2072 756e  ]):.    """A run
-0001ee10: 6e61 626c 6520 7468 6174 2064 656c 6567  nable that deleg
-0001ee20: 6174 6573 2063 616c 6c73 2074 6f20 616e  ates calls to an
-0001ee30: 6f74 6865 7220 7275 6e6e 6162 6c65 2077  other runnable w
-0001ee40: 6974 6820 6120 7365 7420 6f66 206b 7761  ith a set of kwa
-0001ee50: 7267 732e 0a0a 2020 2020 5573 6520 6f6e  rgs...    Use on
-0001ee60: 6c79 2069 6620 6372 6561 7469 6e67 2061  ly if creating a
-0001ee70: 206e 6577 2052 756e 6e61 626c 6542 696e   new RunnableBin
-0001ee80: 6469 6e67 2073 7562 636c 6173 7320 7769  ding subclass wi
-0001ee90: 7468 2064 6966 6665 7265 6e74 205f 5f69  th different __i
-0001eea0: 6e69 745f 5f20 6172 6773 2e0a 0a20 2020  nit__ args...   
-0001eeb0: 2053 6565 2064 6f63 756d 656e 7461 7469   See documentati
-0001eec0: 6f6e 2066 6f72 2052 756e 6e61 626c 6542  on for RunnableB
-0001eed0: 696e 6469 6e67 2066 6f72 206d 6f72 6520  inding for more 
-0001eee0: 6465 7461 696c 732e 0a20 2020 2022 2222  details..    """
-0001eef0: 0a0a 2020 2020 626f 756e 643a 2052 756e  ..    bound: Run
-0001ef00: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
-0001ef10: 7075 745d 0a20 2020 2022 2222 5468 6520  put].    """The 
-0001ef20: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
-0001ef30: 626c 6520 7468 6174 2074 6869 7320 7275  ble that this ru
-0001ef40: 6e6e 6162 6c65 2064 656c 6567 6174 6573  nnable delegates
-0001ef50: 2074 6f2e 2222 220a 0a20 2020 206b 7761   to."""..    kwa
-0001ef60: 7267 733a 204d 6170 7069 6e67 5b73 7472  rgs: Mapping[str
-0001ef70: 2c20 416e 795d 203d 2046 6965 6c64 2864  , Any] = Field(d
-0001ef80: 6566 6175 6c74 5f66 6163 746f 7279 3d64  efault_factory=d
-0001ef90: 6963 7429 0a20 2020 2022 2222 6b77 6172  ict).    """kwar
-0001efa0: 6773 2074 6f20 7061 7373 2074 6f20 7468  gs to pass to th
-0001efb0: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
-0001efc0: 6e61 626c 6520 7768 656e 2072 756e 6e69  nable when runni
-0001efd0: 6e67 2e0a 0a20 2020 2046 6f72 2065 7861  ng...    For exa
-0001efe0: 6d70 6c65 2c20 7768 656e 2074 6865 2072  mple, when the r
-0001eff0: 756e 6e61 626c 6520 6269 6e64 696e 6720  unnable binding 
-0001f000: 6973 2069 6e76 6f6b 6564 2074 6865 2075  is invoked the u
-0001f010: 6e64 6572 6c79 696e 670a 2020 2020 7275  nderlying.    ru
-0001f020: 6e6e 6162 6c65 2077 696c 6c20 6265 2069  nnable will be i
-0001f030: 6e76 6f6b 6564 2077 6974 6820 7468 6520  nvoked with the 
-0001f040: 7361 6d65 2069 6e70 7574 2062 7574 2077  same input but w
-0001f050: 6974 6820 7468 6573 6520 6164 6469 7469  ith these additi
-0001f060: 6f6e 616c 0a20 2020 206b 7761 7267 732e  onal.    kwargs.
-0001f070: 0a20 2020 2022 2222 0a0a 2020 2020 636f  .    """..    co
-0001f080: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
-0001f090: 6e66 6967 203d 2046 6965 6c64 2864 6566  nfig = Field(def
-0001f0a0: 6175 6c74 5f66 6163 746f 7279 3d64 6963  ault_factory=dic
-0001f0b0: 7429 0a20 2020 2022 2222 5468 6520 636f  t).    """The co
-0001f0c0: 6e66 6967 2074 6f20 6269 6e64 2074 6f20  nfig to bind to 
-0001f0d0: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
-0001f0e0: 756e 6e61 626c 652e 2222 220a 0a20 2020  unnable."""..   
-0001f0f0: 2063 6f6e 6669 675f 6661 6374 6f72 6965   config_factorie
-0001f100: 733a 204c 6973 745b 4361 6c6c 6162 6c65  s: List[Callable
-0001f110: 5b5b 5275 6e6e 6162 6c65 436f 6e66 6967  [[RunnableConfig
-0001f120: 5d2c 2052 756e 6e61 626c 6543 6f6e 6669  ], RunnableConfi
-0001f130: 675d 5d20 3d20 4669 656c 6428 0a20 2020  g]] = Field(.   
-0001f140: 2020 2020 2064 6566 6175 6c74 5f66 6163       default_fac
-0001f150: 746f 7279 3d6c 6973 740a 2020 2020 290a  tory=list.    ).
-0001f160: 2020 2020 2222 2254 6865 2063 6f6e 6669      """The confi
-0001f170: 6720 6661 6374 6f72 6965 7320 746f 2062  g factories to b
-0001f180: 696e 6420 746f 2074 6865 2075 6e64 6572  ind to the under
-0001f190: 6c79 696e 6720 7275 6e6e 6162 6c65 2e22  lying runnable."
-0001f1a0: 2222 0a0a 2020 2020 2320 556e 696f 6e5b  ""..    # Union[
-0001f1b0: 5479 7065 5b49 6e70 7574 5d2c 2042 6173  Type[Input], Bas
-0001f1c0: 654d 6f64 656c 5d20 2b20 7468 696e 6773  eModel] + things
-0001f1d0: 206c 696b 6520 4c69 7374 5b73 7472 5d0a   like List[str].
-0001f1e0: 2020 2020 6375 7374 6f6d 5f69 6e70 7574      custom_input
-0001f1f0: 5f74 7970 653a 204f 7074 696f 6e61 6c5b  _type: Optional[
-0001f200: 416e 795d 203d 204e 6f6e 650a 2020 2020  Any] = None.    
-0001f210: 2222 224f 7665 7272 6964 6520 7468 6520  """Override the 
-0001f220: 696e 7075 7420 7479 7065 206f 6620 7468  input type of th
-0001f230: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
-0001f240: 6e61 626c 6520 7769 7468 2061 2063 7573  nable with a cus
-0001f250: 746f 6d20 7479 7065 2e0a 0a20 2020 2054  tom type...    T
-0001f260: 6865 2074 7970 6520 6361 6e20 6265 2061  he type can be a
-0001f270: 2070 7964 616e 7469 6320 6d6f 6465 6c2c   pydantic model,
-0001f280: 206f 7220 6120 7479 7065 2061 6e6e 6f74   or a type annot
-0001f290: 6174 696f 6e20 2865 2e67 2e2c 2060 4c69  ation (e.g., `Li
-0001f2a0: 7374 5b73 7472 5d60 292e 0a20 2020 2022  st[str]`)..    "
-0001f2b0: 2222 0a20 2020 2023 2055 6e69 6f6e 5b54  "".    # Union[T
-0001f2c0: 7970 655b 4f75 7470 7574 5d2c 2042 6173  ype[Output], Bas
-0001f2d0: 654d 6f64 656c 5d20 2b20 7468 696e 6773  eModel] + things
-0001f2e0: 206c 696b 6520 4c69 7374 5b73 7472 5d0a   like List[str].
-0001f2f0: 2020 2020 6375 7374 6f6d 5f6f 7574 7075      custom_outpu
-0001f300: 745f 7479 7065 3a20 4f70 7469 6f6e 616c  t_type: Optional
-0001f310: 5b41 6e79 5d20 3d20 4e6f 6e65 0a20 2020  [Any] = None.   
-0001f320: 2022 2222 4f76 6572 7269 6465 2074 6865   """Override the
-0001f330: 206f 7574 7075 7420 7479 7065 206f 6620   output type of 
-0001f340: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
-0001f350: 756e 6e61 626c 6520 7769 7468 2061 2063  unnable with a c
-0001f360: 7573 746f 6d20 7479 7065 2e0a 0a20 2020  ustom type...   
-0001f370: 2054 6865 2074 7970 6520 6361 6e20 6265   The type can be
-0001f380: 2061 2070 7964 616e 7469 6320 6d6f 6465   a pydantic mode
-0001f390: 6c2c 206f 7220 6120 7479 7065 2061 6e6e  l, or a type ann
-0001f3a0: 6f74 6174 696f 6e20 2865 2e67 2e2c 2060  otation (e.g., `
-0001f3b0: 4c69 7374 5b73 7472 5d60 292e 0a20 2020  List[str]`)..   
-0001f3c0: 2022 2222 0a0a 2020 2020 636c 6173 7320   """..    class 
-0001f3d0: 436f 6e66 6967 3a0a 2020 2020 2020 2020  Config:.        
-0001f3e0: 6172 6269 7472 6172 795f 7479 7065 735f  arbitrary_types_
-0001f3f0: 616c 6c6f 7765 6420 3d20 5472 7565 0a0a  allowed = True..
-0001f400: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0001f410: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0001f420: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-0001f430: 2020 2062 6f75 6e64 3a20 5275 6e6e 6162     bound: Runnab
-0001f440: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-0001f450: 5d2c 0a20 2020 2020 2020 206b 7761 7267  ],.        kwarg
-0001f460: 733a 204f 7074 696f 6e61 6c5b 4d61 7070  s: Optional[Mapp
-0001f470: 696e 675b 7374 722c 2041 6e79 5d5d 203d  ing[str, Any]] =
-0001f480: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
-0001f490: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-0001f4a0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
-0001f4b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0001f4c0: 636f 6e66 6967 5f66 6163 746f 7269 6573  config_factories
-0001f4d0: 3a20 4f70 7469 6f6e 616c 5b0a 2020 2020  : Optional[.    
-0001f4e0: 2020 2020 2020 2020 4c69 7374 5b43 616c          List[Cal
-0001f4f0: 6c61 626c 655b 5b52 756e 6e61 626c 6543  lable[[RunnableC
-0001f500: 6f6e 6669 675d 2c20 5275 6e6e 6162 6c65  onfig], Runnable
-0001f510: 436f 6e66 6967 5d5d 0a20 2020 2020 2020  Config]].       
-0001f520: 205d 203d 204e 6f6e 652c 0a20 2020 2020   ] = None,.     
-0001f530: 2020 2063 7573 746f 6d5f 696e 7075 745f     custom_input_
-0001f540: 7479 7065 3a20 4f70 7469 6f6e 616c 5b55  type: Optional[U
-0001f550: 6e69 6f6e 5b54 7970 655b 496e 7075 745d  nion[Type[Input]
-0001f560: 2c20 4261 7365 4d6f 6465 6c5d 5d20 3d20  , BaseModel]] = 
-0001f570: 4e6f 6e65 2c0a 2020 2020 2020 2020 6375  None,.        cu
-0001f580: 7374 6f6d 5f6f 7574 7075 745f 7479 7065  stom_output_type
-0001f590: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
-0001f5a0: 5b54 7970 655b 4f75 7470 7574 5d2c 2042  [Type[Output], B
-0001f5b0: 6173 654d 6f64 656c 5d5d 203d 204e 6f6e  aseModel]] = Non
-0001f5c0: 652c 0a20 2020 2020 2020 202a 2a6f 7468  e,.        **oth
-0001f5d0: 6572 5f6b 7761 7267 733a 2041 6e79 2c0a  er_kwargs: Any,.
-0001f5e0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0001f5f0: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
-0001f600: 2061 2052 756e 6e61 626c 6542 696e 6469   a RunnableBindi
-0001f610: 6e67 2066 726f 6d20 6120 7275 6e6e 6162  ng from a runnab
-0001f620: 6c65 2061 6e64 206b 7761 7267 732e 0a0a  le and kwargs...
-0001f630: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0001f640: 2020 2020 2020 2020 2020 626f 756e 643a            bound:
-0001f650: 2054 6865 2075 6e64 6572 6c79 696e 6720   The underlying 
-0001f660: 7275 6e6e 6162 6c65 2074 6861 7420 7468  runnable that th
-0001f670: 6973 2072 756e 6e61 626c 6520 6465 6c65  is runnable dele
-0001f680: 6761 7465 7320 6361 6c6c 7320 746f 2e0a  gates calls to..
-0001f690: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
-0001f6a0: 6773 3a20 6f70 7469 6f6e 616c 206b 7761  gs: optional kwa
-0001f6b0: 7267 7320 746f 2070 6173 7320 746f 2074  rgs to pass to t
-0001f6c0: 6865 2075 6e64 6572 6c79 696e 6720 7275  he underlying ru
-0001f6d0: 6e6e 6162 6c65 2c20 7768 656e 2072 756e  nnable, when run
-0001f6e0: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
-0001f6f0: 2020 2020 2020 2020 2074 6865 2075 6e64           the und
-0001f700: 6572 6c79 696e 6720 7275 6e6e 6162 6c65  erlying runnable
-0001f710: 2028 652e 672e 2c20 7669 6120 6069 6e76   (e.g., via `inv
-0001f720: 6f6b 6560 2c20 6062 6174 6368 602c 0a20  oke`, `batch`,. 
-0001f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f740: 2020 2060 7472 616e 7366 6f72 6d60 2c20     `transform`, 
-0001f750: 6f72 2060 7374 7265 616d 6020 6f72 2061  or `stream` or a
-0001f760: 7379 6e63 2076 6172 6961 6e74 7329 0a20  sync variants). 
-0001f770: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-0001f780: 673a 2063 6f6e 6669 675f 6661 6374 6f72  g: config_factor
-0001f790: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-0001f7a0: 2063 6f6e 6669 675f 6661 6374 6f72 6965   config_factorie
-0001f7b0: 733a 206f 7074 696f 6e61 6c20 6c69 7374  s: optional list
-0001f7c0: 206f 6620 636f 6e66 6967 2066 6163 746f   of config facto
-0001f7d0: 7269 6573 2074 6f20 6170 706c 7920 746f  ries to apply to
-0001f7e0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-0001f7f0: 2063 7573 746f 6d5f 696e 7075 745f 7479   custom_input_ty
-0001f800: 7065 3a20 5370 6563 6966 7920 746f 206f  pe: Specify to o
-0001f810: 7665 7272 6964 6520 7468 6520 696e 7075  verride the inpu
-0001f820: 7420 7479 7065 206f 6620 7468 6520 756e  t type of the un
-0001f830: 6465 726c 7969 6e67 0a20 2020 2020 2020  derlying.       
-0001f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f850: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
-0001f860: 2077 6974 6820 6120 6375 7374 6f6d 2074   with a custom t
-0001f870: 7970 652e 0a20 2020 2020 2020 2020 2020  ype..           
-0001f880: 2063 7573 746f 6d5f 6f75 7470 7574 5f74   custom_output_t
-0001f890: 7970 653a 2053 7065 6369 6679 2074 6f20  ype: Specify to 
-0001f8a0: 6f76 6572 7269 6465 2074 6865 206f 7574  override the out
-0001f8b0: 7075 7420 7479 7065 206f 6620 7468 6520  put type of the 
-0001f8c0: 756e 6465 726c 7969 6e67 0a20 2020 2020  underlying.     
-0001f8d0: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-0001f8e0: 626c 6520 7769 7468 2061 2063 7573 746f  ble with a custo
-0001f8f0: 6d20 7479 7065 2e0a 2020 2020 2020 2020  m type..        
-0001f900: 2020 2020 2a2a 6f74 6865 725f 6b77 6172      **other_kwar
-0001f910: 6773 3a20 556e 7061 636b 6564 2069 6e74  gs: Unpacked int
-0001f920: 6f20 7468 6520 6261 7365 2063 6c61 7373  o the base class
-0001f930: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0001f940: 2020 2020 2020 636f 6e66 6967 203d 2063        config = c
-0001f950: 6f6e 6669 6720 6f72 207b 7d0a 2020 2020  onfig or {}.    
-0001f960: 2020 2020 2320 636f 6e66 6967 5f73 7065      # config_spe
-0001f970: 6373 2063 6f6e 7461 696e 7320 7468 6520  cs contains the 
-0001f980: 6c69 7374 206f 6620 7661 6c69 6420 6063  list of valid `c
-0001f990: 6f6e 6669 6775 7261 626c 6560 206b 6579  onfigurable` key
-0001f9a0: 730a 2020 2020 2020 2020 6966 2063 6f6e  s.        if con
-0001f9b0: 6669 6775 7261 626c 6520 3a3d 2063 6f6e  figurable := con
-0001f9c0: 6669 672e 6765 7428 2263 6f6e 6669 6775  fig.get("configu
-0001f9d0: 7261 626c 6522 2c20 4e6f 6e65 293a 0a20  rable", None):. 
-0001f9e0: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-0001f9f0: 6564 5f6b 6579 7320 3d20 7365 7428 732e  ed_keys = set(s.
-0001fa00: 6964 2066 6f72 2073 2069 6e20 626f 756e  id for s in boun
-0001fa10: 642e 636f 6e66 6967 5f73 7065 6373 290a  d.config_specs).
-0001fa20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001fa30: 6b65 7920 696e 2063 6f6e 6669 6775 7261  key in configura
-0001fa40: 626c 653a 0a20 2020 2020 2020 2020 2020  ble:.           
-0001fa50: 2020 2020 2069 6620 6b65 7920 6e6f 7420       if key not 
-0001fa60: 696e 2061 6c6c 6f77 6564 5f6b 6579 733a  in allowed_keys:
-0001fa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fa80: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0001fa90: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0001faa0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001fab0: 2243 6f6e 6669 6775 7261 626c 6520 6b65  "Configurable ke
-0001fac0: 7920 277b 6b65 797d 2720 6e6f 7420 666f  y '{key}' not fo
-0001fad0: 756e 6420 696e 2072 756e 6e61 626c 6520  und in runnable 
-0001fae0: 7769 7468 220a 2020 2020 2020 2020 2020  with".          
-0001faf0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001fb00: 2063 6f6e 6669 6720 6b65 7973 3a20 7b61   config keys: {a
-0001fb10: 6c6c 6f77 6564 5f6b 6579 737d 220a 2020  llowed_keys}".  
-0001fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb30: 2020 290a 2020 2020 2020 2020 7375 7065    ).        supe
-0001fb40: 7228 292e 5f5f 696e 6974 5f5f 280a 2020  r().__init__(.  
-0001fb50: 2020 2020 2020 2020 2020 626f 756e 643d            bound=
-0001fb60: 626f 756e 642c 0a20 2020 2020 2020 2020  bound,.         
-0001fb70: 2020 206b 7761 7267 733d 6b77 6172 6773     kwargs=kwargs
-0001fb80: 206f 7220 7b7d 2c0a 2020 2020 2020 2020   or {},.        
-0001fb90: 2020 2020 636f 6e66 6967 3d63 6f6e 6669      config=confi
-0001fba0: 6720 6f72 207b 7d2c 0a20 2020 2020 2020  g or {},.       
-0001fbb0: 2020 2020 2063 6f6e 6669 675f 6661 6374       config_fact
-0001fbc0: 6f72 6965 733d 636f 6e66 6967 5f66 6163  ories=config_fac
-0001fbd0: 746f 7269 6573 206f 7220 5b5d 2c0a 2020  tories or [],.  
-0001fbe0: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
-0001fbf0: 5f69 6e70 7574 5f74 7970 653d 6375 7374  _input_type=cust
-0001fc00: 6f6d 5f69 6e70 7574 5f74 7970 652c 0a20  om_input_type,. 
-0001fc10: 2020 2020 2020 2020 2020 2063 7573 746f             custo
-0001fc20: 6d5f 6f75 7470 7574 5f74 7970 653d 6375  m_output_type=cu
-0001fc30: 7374 6f6d 5f6f 7574 7075 745f 7479 7065  stom_output_type
-0001fc40: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-0001fc50: 6f74 6865 725f 6b77 6172 6773 2c0a 2020  other_kwargs,.  
-0001fc60: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0001fc70: 2067 6574 5f6e 616d 6528 0a20 2020 2020   get_name(.     
-0001fc80: 2020 2073 656c 662c 2073 7566 6669 783a     self, suffix:
-0001fc90: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-0001fca0: 204e 6f6e 652c 202a 2c20 6e61 6d65 3a20   None, *, name: 
-0001fcb0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0001fcc0: 4e6f 6e65 0a20 2020 2029 202d 3e20 7374  None.    ) -> st
-0001fcd0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
-0001fce0: 6e20 7365 6c66 2e62 6f75 6e64 2e67 6574  n self.bound.get
-0001fcf0: 5f6e 616d 6528 7375 6666 6978 2c20 6e61  _name(suffix, na
-0001fd00: 6d65 3d6e 616d 6529 0a0a 2020 2020 4070  me=name)..    @p
-0001fd10: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001fd20: 496e 7075 7454 7970 6528 7365 6c66 2920  InputType(self) 
-0001fd30: 2d3e 2054 7970 655b 496e 7075 745d 3a0a  -> Type[Input]:.
-0001fd40: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-0001fd50: 0a20 2020 2020 2020 2020 2020 2063 6173  .            cas
-0001fd60: 7428 5479 7065 5b49 6e70 7574 5d2c 2073  t(Type[Input], s
-0001fd70: 656c 662e 6375 7374 6f6d 5f69 6e70 7574  elf.custom_input
-0001fd80: 5f74 7970 6529 0a20 2020 2020 2020 2020  _type).         
-0001fd90: 2020 2069 6620 7365 6c66 2e63 7573 746f     if self.custo
-0001fda0: 6d5f 696e 7075 745f 7479 7065 2069 7320  m_input_type is 
-0001fdb0: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
-0001fdc0: 2020 2020 2065 6c73 6520 7365 6c66 2e62       else self.b
-0001fdd0: 6f75 6e64 2e49 6e70 7574 5479 7065 0a20  ound.InputType. 
-0001fde0: 2020 2020 2020 2029 0a0a 2020 2020 4070         )..    @p
-0001fdf0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001fe00: 4f75 7470 7574 5479 7065 2873 656c 6629  OutputType(self)
-0001fe10: 202d 3e20 5479 7065 5b4f 7574 7075 745d   -> Type[Output]
-0001fe20: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001fe30: 2028 0a20 2020 2020 2020 2020 2020 2063   (.            c
-0001fe40: 6173 7428 5479 7065 5b4f 7574 7075 745d  ast(Type[Output]
-0001fe50: 2c20 7365 6c66 2e63 7573 746f 6d5f 6f75  , self.custom_ou
-0001fe60: 7470 7574 5f74 7970 6529 0a20 2020 2020  tput_type).     
-0001fe70: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-0001fe80: 7573 746f 6d5f 6f75 7470 7574 5f74 7970  ustom_output_typ
-0001fe90: 6520 6973 206e 6f74 204e 6f6e 650a 2020  e is not None.  
-0001fea0: 2020 2020 2020 2020 2020 656c 7365 2073            else s
-0001feb0: 656c 662e 626f 756e 642e 4f75 7470 7574  elf.bound.Output
-0001fec0: 5479 7065 0a20 2020 2020 2020 2029 0a0a  Type.        )..
-0001fed0: 2020 2020 6465 6620 6765 745f 696e 7075      def get_inpu
-0001fee0: 745f 7363 6865 6d61 280a 2020 2020 2020  t_schema(.      
-0001fef0: 2020 7365 6c66 2c20 636f 6e66 6967 3a20    self, config: 
-0001ff00: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-0001ff10: 6543 6f6e 6669 675d 203d 204e 6f6e 650a  eConfig] = None.
-0001ff20: 2020 2020 2920 2d3e 2054 7970 655b 4261      ) -> Type[Ba
-0001ff30: 7365 4d6f 6465 6c5d 3a0a 2020 2020 2020  seModel]:.      
-0001ff40: 2020 6966 2073 656c 662e 6375 7374 6f6d    if self.custom
-0001ff50: 5f69 6e70 7574 5f74 7970 6520 6973 206e  _input_type is n
-0001ff60: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001ff70: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-0001ff80: 7228 292e 6765 745f 696e 7075 745f 7363  r().get_input_sc
-0001ff90: 6865 6d61 2863 6f6e 6669 6729 0a20 2020  hema(config).   
-0001ffa0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001ffb0: 2e62 6f75 6e64 2e67 6574 5f69 6e70 7574  .bound.get_input
-0001ffc0: 5f73 6368 656d 6128 6d65 7267 655f 636f  _schema(merge_co
-0001ffd0: 6e66 6967 7328 7365 6c66 2e63 6f6e 6669  nfigs(self.confi
-0001ffe0: 672c 2063 6f6e 6669 6729 290a 0a20 2020  g, config))..   
-0001fff0: 2064 6566 2067 6574 5f6f 7574 7075 745f   def get_output_
-00020000: 7363 6865 6d61 280a 2020 2020 2020 2020  schema(.        
-00020010: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
-00020020: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-00020030: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
-00020040: 2020 2920 2d3e 2054 7970 655b 4261 7365    ) -> Type[Base
-00020050: 4d6f 6465 6c5d 3a0a 2020 2020 2020 2020  Model]:.        
-00020060: 6966 2073 656c 662e 6375 7374 6f6d 5f6f  if self.custom_o
-00020070: 7574 7075 745f 7479 7065 2069 7320 6e6f  utput_type is no
-00020080: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00020090: 2020 2020 7265 7475 726e 2073 7570 6572      return super
-000200a0: 2829 2e67 6574 5f6f 7574 7075 745f 7363  ().get_output_sc
-000200b0: 6865 6d61 2863 6f6e 6669 6729 0a20 2020  hema(config).   
-000200c0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000200d0: 2e62 6f75 6e64 2e67 6574 5f6f 7574 7075  .bound.get_outpu
-000200e0: 745f 7363 6865 6d61 286d 6572 6765 5f63  t_schema(merge_c
-000200f0: 6f6e 6669 6773 2873 656c 662e 636f 6e66  onfigs(self.conf
-00020100: 6967 2c20 636f 6e66 6967 2929 0a0a 2020  ig, config))..  
-00020110: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00020120: 6465 6620 636f 6e66 6967 5f73 7065 6373  def config_specs
-00020130: 2873 656c 6629 202d 3e20 4c69 7374 5b43  (self) -> List[C
-00020140: 6f6e 6669 6775 7261 626c 6546 6965 6c64  onfigurableField
-00020150: 5370 6563 5d3a 0a20 2020 2020 2020 2072  Spec]:.        r
-00020160: 6574 7572 6e20 7365 6c66 2e62 6f75 6e64  eturn self.bound
-00020170: 2e63 6f6e 6669 675f 7370 6563 730a 0a20  .config_specs.. 
-00020180: 2020 2064 6566 2067 6574 5f67 7261 7068     def get_graph
-00020190: 2873 656c 662c 2063 6f6e 6669 673a 204f  (self, config: O
-000201a0: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-000201b0: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2920  Config] = None) 
-000201c0: 2d3e 2047 7261 7068 3a0a 2020 2020 2020  -> Graph:.      
-000201d0: 2020 7265 7475 726e 2073 656c 662e 626f    return self.bo
-000201e0: 756e 642e 6765 745f 6772 6170 6828 636f  und.get_graph(co
-000201f0: 6e66 6967 290a 0a20 2020 2040 636c 6173  nfig)..    @clas
-00020200: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
-00020210: 6973 5f6c 635f 7365 7269 616c 697a 6162  is_lc_serializab
-00020220: 6c65 2863 6c73 2920 2d3e 2062 6f6f 6c3a  le(cls) -> bool:
-00020230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020240: 5472 7565 0a0a 2020 2020 4063 6c61 7373  True..    @class
-00020250: 6d65 7468 6f64 0a20 2020 2064 6566 2067  method.    def g
-00020260: 6574 5f6c 635f 6e61 6d65 7370 6163 6528  et_lc_namespace(
-00020270: 636c 7329 202d 3e20 4c69 7374 5b73 7472  cls) -> List[str
-00020280: 5d3a 0a20 2020 2020 2020 2022 2222 4765  ]:.        """Ge
-00020290: 7420 7468 6520 6e61 6d65 7370 6163 6520  t the namespace 
-000202a0: 6f66 2074 6865 206c 616e 6763 6861 696e  of the langchain
-000202b0: 206f 626a 6563 742e 2222 220a 2020 2020   object.""".    
-000202c0: 2020 2020 7265 7475 726e 205b 226c 616e      return ["lan
-000202d0: 6763 6861 696e 222c 2022 7363 6865 6d61  gchain", "schema
-000202e0: 222c 2022 7275 6e6e 6162 6c65 225d 0a0a  ", "runnable"]..
-000202f0: 2020 2020 6465 6620 5f6d 6572 6765 5f63      def _merge_c
-00020300: 6f6e 6669 6773 2873 656c 662c 202a 636f  onfigs(self, *co
-00020310: 6e66 6967 733a 204f 7074 696f 6e61 6c5b  nfigs: Optional[
-00020320: 5275 6e6e 6162 6c65 436f 6e66 6967 5d29  RunnableConfig])
-00020330: 202d 3e20 5275 6e6e 6162 6c65 436f 6e66   -> RunnableConf
-00020340: 6967 3a0a 2020 2020 2020 2020 636f 6e66  ig:.        conf
-00020350: 6967 203d 206d 6572 6765 5f63 6f6e 6669  ig = merge_confi
-00020360: 6773 2873 656c 662e 636f 6e66 6967 2c20  gs(self.config, 
-00020370: 2a63 6f6e 6669 6773 290a 2020 2020 2020  *configs).      
-00020380: 2020 7265 7475 726e 206d 6572 6765 5f63    return merge_c
-00020390: 6f6e 6669 6773 2863 6f6e 6669 672c 202a  onfigs(config, *
-000203a0: 2866 2863 6f6e 6669 6729 2066 6f72 2066  (f(config) for f
-000203b0: 2069 6e20 7365 6c66 2e63 6f6e 6669 675f   in self.config_
-000203c0: 6661 6374 6f72 6965 7329 290a 0a20 2020  factories))..   
-000203d0: 2064 6566 2069 6e76 6f6b 6528 0a20 2020   def invoke(.   
-000203e0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-000203f0: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00020400: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00020410: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00020420: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00020430: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00020440: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00020450: 5d2c 0a20 2020 2029 202d 3e20 4f75 7470  ],.    ) -> Outp
-00020460: 7574 3a0a 2020 2020 2020 2020 7265 7475  ut:.        retu
-00020470: 726e 2073 656c 662e 626f 756e 642e 696e  rn self.bound.in
-00020480: 766f 6b65 280a 2020 2020 2020 2020 2020  voke(.          
-00020490: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-000204a0: 2020 2020 2073 656c 662e 5f6d 6572 6765       self._merge
-000204b0: 5f63 6f6e 6669 6773 2863 6f6e 6669 6729  _configs(config)
-000204c0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-000204d0: 7b2a 2a73 656c 662e 6b77 6172 6773 2c20  {**self.kwargs, 
-000204e0: 2a2a 6b77 6172 6773 7d2c 0a20 2020 2020  **kwargs},.     
-000204f0: 2020 2029 0a0a 2020 2020 6173 796e 6320     )..    async 
-00020500: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
-00020510: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00020520: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00020530: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00020540: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00020550: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00020560: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00020570: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00020580: 5d2c 0a20 2020 2029 202d 3e20 4f75 7470  ],.    ) -> Outp
-00020590: 7574 3a0a 2020 2020 2020 2020 7265 7475  ut:.        retu
-000205a0: 726e 2061 7761 6974 2073 656c 662e 626f  rn await self.bo
-000205b0: 756e 642e 6169 6e76 6f6b 6528 0a20 2020  und.ainvoke(.   
-000205c0: 2020 2020 2020 2020 2069 6e70 7574 2c0a           input,.
-000205d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000205e0: 2e5f 6d65 7267 655f 636f 6e66 6967 7328  ._merge_configs(
-000205f0: 636f 6e66 6967 292c 0a20 2020 2020 2020  config),.       
-00020600: 2020 2020 202a 2a7b 2a2a 7365 6c66 2e6b       **{**self.k
-00020610: 7761 7267 732c 202a 2a6b 7761 7267 737d  wargs, **kwargs}
-00020620: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00020630: 2064 6566 2062 6174 6368 280a 2020 2020   def batch(.    
-00020640: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00020650: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
-00020660: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
-00020670: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-00020680: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
-00020690: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
-000206a0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
-000206b0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
-000206c0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
-000206d0: 7863 6570 7469 6f6e 733a 2062 6f6f 6c20  xceptions: bool 
-000206e0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000206f0: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00020700: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00020710: 2d3e 204c 6973 745b 4f75 7470 7574 5d3a  -> List[Output]:
-00020720: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00020730: 7374 616e 6365 2863 6f6e 6669 672c 206c  stance(config, l
-00020740: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
-00020750: 2020 636f 6e66 6967 7320 3d20 6361 7374    configs = cast
-00020760: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00020770: 2020 4c69 7374 5b52 756e 6e61 626c 6543    List[RunnableC
-00020780: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
-00020790: 2020 2020 2020 2020 5b73 656c 662e 5f6d          [self._m
-000207a0: 6572 6765 5f63 6f6e 6669 6773 2863 6f6e  erge_configs(con
-000207b0: 6629 2066 6f72 2063 6f6e 6620 696e 2063  f) for conf in c
-000207c0: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
-000207d0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-000207e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000207f0: 636f 6e66 6967 7320 3d20 5b73 656c 662e  configs = [self.
-00020800: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
-00020810: 6f6e 6669 6729 2066 6f72 205f 2069 6e20  onfig) for _ in 
-00020820: 7261 6e67 6528 6c65 6e28 696e 7075 7473  range(len(inputs
-00020830: 2929 5d0a 2020 2020 2020 2020 7265 7475  ))].        retu
-00020840: 726e 2073 656c 662e 626f 756e 642e 6261  rn self.bound.ba
-00020850: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
-00020860: 2069 6e70 7574 732c 0a20 2020 2020 2020   inputs,.       
-00020870: 2020 2020 2063 6f6e 6669 6773 2c0a 2020       configs,.  
-00020880: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00020890: 5f65 7863 6570 7469 6f6e 733d 7265 7475  _exceptions=retu
-000208a0: 726e 5f65 7863 6570 7469 6f6e 732c 0a20  rn_exceptions,. 
-000208b0: 2020 2020 2020 2020 2020 202a 2a7b 2a2a             **{**
-000208c0: 7365 6c66 2e6b 7761 7267 732c 202a 2a6b  self.kwargs, **k
-000208d0: 7761 7267 737d 2c0a 2020 2020 2020 2020  wargs},.        
-000208e0: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-000208f0: 2061 6261 7463 6828 0a20 2020 2020 2020   abatch(.       
-00020900: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
-00020910: 6e70 7574 733a 204c 6973 745b 496e 7075  nputs: List[Inpu
-00020920: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00020930: 6967 3a20 4f70 7469 6f6e 616c 5b55 6e69  ig: Optional[Uni
-00020940: 6f6e 5b52 756e 6e61 626c 6543 6f6e 6669  on[RunnableConfi
-00020950: 672c 204c 6973 745b 5275 6e6e 6162 6c65  g, List[Runnable
-00020960: 436f 6e66 6967 5d5d 5d20 3d20 4e6f 6e65  Config]]] = None
-00020970: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00020980: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
-00020990: 7074 696f 6e73 3a20 626f 6f6c 203d 2046  ptions: bool = F
-000209a0: 616c 7365 2c0a 2020 2020 2020 2020 2a2a  alse,.        **
-000209b0: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
-000209c0: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
-000209d0: 4c69 7374 5b4f 7574 7075 745d 3a0a 2020  List[Output]:.  
-000209e0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000209f0: 6e63 6528 636f 6e66 6967 2c20 6c69 7374  nce(config, list
-00020a00: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00020a10: 6f6e 6669 6773 203d 2063 6173 7428 0a20  onfigs = cast(. 
-00020a20: 2020 2020 2020 2020 2020 2020 2020 204c                 L
-00020a30: 6973 745b 5275 6e6e 6162 6c65 436f 6e66  ist[RunnableConf
-00020a40: 6967 5d2c 0a20 2020 2020 2020 2020 2020  ig],.           
-00020a50: 2020 2020 205b 7365 6c66 2e5f 6d65 7267       [self._merg
-00020a60: 655f 636f 6e66 6967 7328 636f 6e66 2920  e_configs(conf) 
-00020a70: 666f 7220 636f 6e66 2069 6e20 636f 6e66  for conf in conf
-00020a80: 6967 5d2c 0a20 2020 2020 2020 2020 2020  ig],.           
-00020a90: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
-00020aa0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00020ab0: 6669 6773 203d 205b 7365 6c66 2e5f 6d65  figs = [self._me
-00020ac0: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
-00020ad0: 6967 2920 666f 7220 5f20 696e 2072 616e  ig) for _ in ran
-00020ae0: 6765 286c 656e 2869 6e70 7574 7329 295d  ge(len(inputs))]
-00020af0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020b00: 6177 6169 7420 7365 6c66 2e62 6f75 6e64  await self.bound
-00020b10: 2e61 6261 7463 6828 0a20 2020 2020 2020  .abatch(.       
-00020b20: 2020 2020 2069 6e70 7574 732c 0a20 2020       inputs,.   
-00020b30: 2020 2020 2020 2020 2063 6f6e 6669 6773           configs
-00020b40: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00020b50: 7475 726e 5f65 7863 6570 7469 6f6e 733d  turn_exceptions=
-00020b60: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00020b70: 732c 0a20 2020 2020 2020 2020 2020 202a  s,.            *
-00020b80: 2a7b 2a2a 7365 6c66 2e6b 7761 7267 732c  *{**self.kwargs,
-00020b90: 202a 2a6b 7761 7267 737d 2c0a 2020 2020   **kwargs},.    
-00020ba0: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00020bb0: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00020bc0: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00020bd0: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00020be0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00020bf0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00020c00: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00020c10: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-00020c20: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-00020c30: 2029 202d 3e20 4974 6572 6174 6f72 5b4f   ) -> Iterator[O
-00020c40: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
-00020c50: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-00020c60: 626f 756e 642e 7374 7265 616d 280a 2020  bound.stream(.  
-00020c70: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-00020c80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020c90: 662e 5f6d 6572 6765 5f63 6f6e 6669 6773  f._merge_configs
-00020ca0: 2863 6f6e 6669 6729 2c0a 2020 2020 2020  (config),.      
-00020cb0: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
-00020cc0: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
-00020cd0: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
-00020ce0: 2020 6173 796e 6320 6465 6620 6173 7472    async def astr
-00020cf0: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
-00020d00: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
-00020d10: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
-00020d20: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
-00020d30: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
-00020d40: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00020d50: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
-00020d60: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
-00020d70: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
-00020d80: 725b 4f75 7470 7574 5d3a 0a20 2020 2020  r[Output]:.     
-00020d90: 2020 2061 7379 6e63 2066 6f72 2069 7465     async for ite
-00020da0: 6d20 696e 2073 656c 662e 626f 756e 642e  m in self.bound.
-00020db0: 6173 7472 6561 6d28 0a20 2020 2020 2020  astream(.       
-00020dc0: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
-00020dd0: 2020 2020 2020 2020 7365 6c66 2e5f 6d65          self._me
-00020de0: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
-00020df0: 6967 292c 0a20 2020 2020 2020 2020 2020  ig),.           
-00020e00: 202a 2a7b 2a2a 7365 6c66 2e6b 7761 7267   **{**self.kwarg
-00020e10: 732c 202a 2a6b 7761 7267 737d 2c0a 2020  s, **kwargs},.  
-00020e20: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00020e30: 2020 2020 2079 6965 6c64 2069 7465 6d0a       yield item.
-00020e40: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-00020e50: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
-00020e60: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00020e70: 2049 7465 7261 746f 725b 496e 7075 745d   Iterator[Input]
-00020e80: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
-00020e90: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00020ea0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00020eb0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00020ec0: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
-00020ed0: 2d3e 2049 7465 7261 746f 725b 4f75 7470  -> Iterator[Outp
-00020ee0: 7574 5d3a 0a20 2020 2020 2020 2079 6965  ut]:.        yie
-00020ef0: 6c64 2066 726f 6d20 7365 6c66 2e62 6f75  ld from self.bou
-00020f00: 6e64 2e74 7261 6e73 666f 726d 280a 2020  nd.transform(.  
-00020f10: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-00020f20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020f30: 662e 5f6d 6572 6765 5f63 6f6e 6669 6773  f._merge_configs
-00020f40: 2863 6f6e 6669 6729 2c0a 2020 2020 2020  (config),.      
-00020f50: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
-00020f60: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
-00020f70: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
-00020f80: 2020 6173 796e 6320 6465 6620 6174 7261    async def atra
-00020f90: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-00020fa0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-00020fb0: 7075 743a 2041 7379 6e63 4974 6572 6174  put: AsyncIterat
-00020fc0: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
-00020fd0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00020fe0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00020ff0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00021000: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00021010: 792c 0a20 2020 2029 202d 3e20 4173 796e  y,.    ) -> Asyn
-00021020: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00021030: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00021040: 2066 6f72 2069 7465 6d20 696e 2073 656c   for item in sel
-00021050: 662e 626f 756e 642e 6174 7261 6e73 666f  f.bound.atransfo
-00021060: 726d 280a 2020 2020 2020 2020 2020 2020  rm(.            
-00021070: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-00021080: 2020 2073 656c 662e 5f6d 6572 6765 5f63     self._merge_c
-00021090: 6f6e 6669 6773 2863 6f6e 6669 6729 2c0a  onfigs(config),.
-000210a0: 2020 2020 2020 2020 2020 2020 2a2a 7b2a              **{*
-000210b0: 2a73 656c 662e 6b77 6172 6773 2c20 2a2a  *self.kwargs, **
-000210c0: 6b77 6172 6773 7d2c 0a20 2020 2020 2020  kwargs},.       
-000210d0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000210e0: 7969 656c 6420 6974 656d 0a0a 0a52 756e  yield item...Run
-000210f0: 6e61 626c 6542 696e 6469 6e67 4261 7365  nableBindingBase
-00021100: 2e75 7064 6174 655f 666f 7277 6172 645f  .update_forward_
-00021110: 7265 6673 2852 756e 6e61 626c 6543 6f6e  refs(RunnableCon
-00021120: 6669 673d 5275 6e6e 6162 6c65 436f 6e66  fig=RunnableConf
-00021130: 6967 290a 0a0a 636c 6173 7320 5275 6e6e  ig)...class Runn
-00021140: 6162 6c65 4269 6e64 696e 6728 5275 6e6e  ableBinding(Runn
-00021150: 6162 6c65 4269 6e64 696e 6742 6173 655b  ableBindingBase[
-00021160: 496e 7075 742c 204f 7574 7075 745d 293a  Input, Output]):
-00021170: 0a20 2020 2022 2222 5772 6170 2061 2072  .    """Wrap a r
-00021180: 756e 6e61 626c 6520 7769 7468 2061 6464  unnable with add
-00021190: 6974 696f 6e61 6c20 6675 6e63 7469 6f6e  itional function
-000211a0: 616c 6974 792e 0a0a 2020 2020 4120 5275  ality...    A Ru
-000211b0: 6e6e 6162 6c65 4269 6e64 696e 6720 6361  nnableBinding ca
-000211c0: 6e20 6265 2074 686f 7567 6874 206f 6620  n be thought of 
-000211d0: 6173 2061 2022 7275 6e6e 6162 6c65 2064  as a "runnable d
-000211e0: 6563 6f72 6174 6f72 2220 7468 6174 0a20  ecorator" that. 
-000211f0: 2020 2070 7265 7365 7276 6573 2074 6865     preserves the
-00021200: 2065 7373 656e 7469 616c 2066 6561 7475   essential featu
-00021210: 7265 7320 6f66 2052 756e 6e61 626c 653b  res of Runnable;
-00021220: 2069 2e65 2e2c 2062 6174 6368 696e 672c   i.e., batching,
-00021230: 2073 7472 6561 6d69 6e67 2c0a 2020 2020   streaming,.    
-00021240: 616e 6420 6173 796e 6320 7375 7070 6f72  and async suppor
-00021250: 742c 2077 6869 6c65 2061 6464 696e 6720  t, while adding 
-00021260: 6164 6469 7469 6f6e 616c 2066 756e 6374  additional funct
-00021270: 696f 6e61 6c69 7479 2e0a 0a20 2020 2041  ionality...    A
-00021280: 6e79 2063 6c61 7373 2074 6861 7420 696e  ny class that in
-00021290: 6865 7269 7473 2066 726f 6d20 5275 6e6e  herits from Runn
-000212a0: 6162 6c65 2063 616e 2062 6520 626f 756e  able can be boun
-000212b0: 6420 746f 2061 2060 5275 6e6e 6162 6c65  d to a `Runnable
-000212c0: 4269 6e64 696e 6760 2e0a 2020 2020 5275  Binding`..    Ru
-000212d0: 6e6e 6162 6c65 7320 6578 706f 7365 2061  nnables expose a
-000212e0: 2073 7461 6e64 6172 6420 7365 7420 6f66   standard set of
-000212f0: 206d 6574 686f 6473 2066 6f72 2063 7265   methods for cre
-00021300: 6174 696e 6720 6052 756e 6e61 626c 6542  ating `RunnableB
-00021310: 696e 6469 6e67 7360 0a20 2020 206f 7220  indings`.    or 
-00021320: 7375 622d 636c 6173 7365 7320 6f66 2060  sub-classes of `
-00021330: 5275 6e6e 6162 6c65 4269 6e64 696e 6773  RunnableBindings
-00021340: 6020 2865 2e67 2e2c 2060 5275 6e6e 6162  ` (e.g., `Runnab
-00021350: 6c65 5265 7472 7960 2c0a 2020 2020 6052  leRetry`,.    `R
-00021360: 756e 6e61 626c 6557 6974 6846 616c 6c62  unnableWithFallb
-00021370: 6163 6b73 6029 2074 6861 7420 6164 6420  acks`) that add 
-00021380: 6164 6469 7469 6f6e 616c 2066 756e 6374  additional funct
-00021390: 696f 6e61 6c69 7479 2e0a 0a20 2020 2054  ionality...    T
-000213a0: 6865 7365 206d 6574 686f 6473 2069 6e63  hese methods inc
-000213b0: 6c75 6465 3a0a 2020 2020 2d20 6062 696e  lude:.    - `bin
-000213c0: 6460 3a20 4269 6e64 206b 7761 7267 7320  d`: Bind kwargs 
-000213d0: 746f 2070 6173 7320 746f 2074 6865 2075  to pass to the u
-000213e0: 6e64 6572 6c79 696e 6720 7275 6e6e 6162  nderlying runnab
-000213f0: 6c65 2077 6865 6e20 7275 6e6e 696e 6720  le when running 
-00021400: 6974 2e0a 2020 2020 2d20 6077 6974 685f  it..    - `with_
-00021410: 636f 6e66 6967 603a 2042 696e 6420 636f  config`: Bind co
-00021420: 6e66 6967 2074 6f20 7061 7373 2074 6f20  nfig to pass to 
-00021430: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
-00021440: 756e 6e61 626c 6520 7768 656e 2072 756e  unnable when run
-00021450: 6e69 6e67 2069 742e 0a20 2020 202d 2060  ning it..    - `
-00021460: 7769 7468 5f6c 6973 7465 6e65 7273 603a  with_listeners`:
-00021470: 2020 4269 6e64 206c 6966 6563 7963 6c65    Bind lifecycle
-00021480: 206c 6973 7465 6e65 7273 2074 6f20 7468   listeners to th
-00021490: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
-000214a0: 6e61 626c 652e 0a20 2020 202d 2060 7769  nable..    - `wi
-000214b0: 7468 5f74 7970 6573 603a 204f 7665 7272  th_types`: Overr
-000214c0: 6964 6520 7468 6520 696e 7075 7420 616e  ide the input an
-000214d0: 6420 6f75 7470 7574 2074 7970 6573 206f  d output types o
-000214e0: 6620 7468 6520 756e 6465 726c 7969 6e67  f the underlying
-000214f0: 2072 756e 6e61 626c 652e 0a20 2020 202d   runnable..    -
-00021500: 2060 7769 7468 5f72 6574 7279 603a 2042   `with_retry`: B
-00021510: 696e 6420 6120 7265 7472 7920 706f 6c69  ind a retry poli
-00021520: 6379 2074 6f20 7468 6520 756e 6465 726c  cy to the underl
-00021530: 7969 6e67 2072 756e 6e61 626c 652e 0a20  ying runnable.. 
-00021540: 2020 202d 2060 7769 7468 5f66 616c 6c62     - `with_fallb
-00021550: 6163 6b73 603a 2042 696e 6420 6120 6661  acks`: Bind a fa
-00021560: 6c6c 6261 636b 2070 6f6c 6963 7920 746f  llback policy to
-00021570: 2074 6865 2075 6e64 6572 6c79 696e 6720   the underlying 
-00021580: 7275 6e6e 6162 6c65 2e0a 0a20 2020 2045  runnable...    E
-00021590: 7861 6d70 6c65 3a0a 0a20 2020 2060 6269  xample:..    `bi
-000215a0: 6e64 603a 2042 696e 6420 6b77 6172 6773  nd`: Bind kwargs
-000215b0: 2074 6f20 7061 7373 2074 6f20 7468 6520   to pass to the 
-000215c0: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
-000215d0: 626c 6520 7768 656e 2072 756e 6e69 6e67  ble when running
-000215e0: 2069 742e 0a0a 2020 2020 2020 2020 2e2e   it...        ..
-000215f0: 2063 6f64 652d 626c 6f63 6b3a 3a20 7079   code-block:: py
-00021600: 7468 6f6e 0a0a 2020 2020 2020 2020 2020  thon..          
-00021610: 2020 2320 4372 6561 7465 2061 2072 756e    # Create a run
-00021620: 6e61 626c 6520 6269 6e64 696e 6720 7468  nable binding th
-00021630: 6174 2069 6e76 6f6b 6573 2074 6865 2043  at invokes the C
-00021640: 6861 744d 6f64 656c 2077 6974 6820 7468  hatModel with th
-00021650: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00021660: 6164 6469 7469 6f6e 616c 206b 7761 7267  additional kwarg
-00021670: 2060 7374 6f70 3d5b 272d 275d 6020 7768   `stop=['-']` wh
-00021680: 656e 2072 756e 6e69 6e67 2069 742e 0a20  en running it.. 
-00021690: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-000216a0: 6c61 6e67 6368 6169 6e5f 636f 6d6d 756e  langchain_commun
-000216b0: 6974 792e 6368 6174 5f6d 6f64 656c 7320  ity.chat_models 
-000216c0: 696d 706f 7274 2043 6861 744f 7065 6e41  import ChatOpenA
-000216d0: 490a 2020 2020 2020 2020 2020 2020 6d6f  I.            mo
-000216e0: 6465 6c20 3d20 4368 6174 4f70 656e 4149  del = ChatOpenAI
-000216f0: 2829 0a20 2020 2020 2020 2020 2020 206d  ().            m
-00021700: 6f64 656c 2e69 6e76 6f6b 6528 2753 6179  odel.invoke('Say
-00021710: 2022 5061 7272 6f74 2d4d 4147 4943 2227   "Parrot-MAGIC"'
-00021720: 2c20 7374 6f70 3d5b 272d 275d 2920 2320  , stop=['-']) # 
-00021730: 5368 6f75 6c64 2072 6574 7572 6e20 6050  Should return `P
-00021740: 6172 726f 7460 0a20 2020 2020 2020 2020  arrot`.         
-00021750: 2020 2023 2055 7369 6e67 2069 7420 7468     # Using it th
-00021760: 6520 6561 7379 2077 6179 2076 6961 2060  e easy way via `
-00021770: 6269 6e64 6020 6d65 7468 6f64 2077 6869  bind` method whi
-00021780: 6368 2072 6574 7572 6e73 2061 206e 6577  ch returns a new
-00021790: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-000217a0: 756e 6e61 626c 6542 696e 6469 6e67 0a20  unnableBinding. 
-000217b0: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-000217c0: 626c 655f 6269 6e64 696e 6720 3d20 6d6f  ble_binding = mo
-000217d0: 6465 6c2e 6269 6e64 2873 746f 703d 5b27  del.bind(stop=['
-000217e0: 2d27 5d29 0a20 2020 2020 2020 2020 2020  -']).           
-000217f0: 2072 756e 6e61 626c 655f 6269 6e64 696e   runnable_bindin
-00021800: 672e 696e 766f 6b65 2827 5361 7920 2250  g.invoke('Say "P
-00021810: 6172 726f 742d 4d41 4749 4322 2729 2023  arrot-MAGIC"') #
-00021820: 2053 686f 756c 6420 7265 7475 726e 2060   Should return `
-00021830: 5061 7272 6f74 600a 0a20 2020 2020 2020  Parrot`..       
-00021840: 2043 616e 2061 6c73 6f20 6265 2064 6f6e   Can also be don
-00021850: 6520 6279 2069 6e73 7461 6e74 6961 7469  e by instantiati
-00021860: 6e67 2061 2052 756e 6e61 626c 6542 696e  ng a RunnableBin
-00021870: 6469 6e67 2064 6972 6563 746c 7920 286e  ding directly (n
-00021880: 6f74 2072 6563 6f6d 6d65 6e64 6564 293a  ot recommended):
-00021890: 0a0a 2020 2020 2020 2020 2e2e 2063 6f64  ..        .. cod
-000218a0: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
-000218b0: 0a0a 2020 2020 2020 2020 2020 2020 6672  ..            fr
-000218c0: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-000218d0: 652e 7275 6e6e 6162 6c65 7320 696d 706f  e.runnables impo
-000218e0: 7274 2052 756e 6e61 626c 6542 696e 6469  rt RunnableBindi
-000218f0: 6e67 0a20 2020 2020 2020 2020 2020 2072  ng.            r
-00021900: 756e 6e61 626c 655f 6269 6e64 696e 6720  unnable_binding 
-00021910: 3d20 5275 6e6e 6162 6c65 4269 6e64 696e  = RunnableBindin
-00021920: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00021930: 2020 2062 6f75 6e64 3d6d 6f64 656c 2c0a     bound=model,.
-00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021950: 6b77 6172 6773 3d7b 2773 746f 7027 3a20  kwargs={'stop': 
-00021960: 5b27 2d27 5d7d 2023 203c 2d2d 204e 6f74  ['-']} # <-- Not
-00021970: 6520 7468 6520 6164 6469 7469 6f6e 616c  e the additional
-00021980: 206b 7761 7267 730a 2020 2020 2020 2020   kwargs.        
-00021990: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000219a0: 2020 7275 6e6e 6162 6c65 5f62 696e 6469    runnable_bindi
-000219b0: 6e67 2e69 6e76 6f6b 6528 2753 6179 2022  ng.invoke('Say "
-000219c0: 5061 7272 6f74 2d4d 4147 4943 2227 2920  Parrot-MAGIC"') 
-000219d0: 2320 5368 6f75 6c64 2072 6574 7572 6e20  # Should return 
-000219e0: 6050 6172 726f 7460 0a20 2020 2022 2222  `Parrot`.    """
-000219f0: 0a0a 2020 2020 4063 6c61 7373 6d65 7468  ..    @classmeth
-00021a00: 6f64 0a20 2020 2064 6566 2067 6574 5f6c  od.    def get_l
-00021a10: 635f 6e61 6d65 7370 6163 6528 636c 7329  c_namespace(cls)
-00021a20: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
-00021a30: 2020 2020 2020 2022 2222 4765 7420 7468         """Get th
-00021a40: 6520 6e61 6d65 7370 6163 6520 6f66 2074  e namespace of t
-00021a50: 6865 206c 616e 6763 6861 696e 206f 626a  he langchain obj
-00021a60: 6563 742e 2222 220a 2020 2020 2020 2020  ect.""".        
-00021a70: 7265 7475 726e 205b 226c 616e 6763 6861  return ["langcha
-00021a80: 696e 222c 2022 7363 6865 6d61 222c 2022  in", "schema", "
-00021a90: 7275 6e6e 6162 6c65 225d 0a0a 2020 2020  runnable"]..    
-00021aa0: 6465 6620 6269 6e64 2873 656c 662c 202a  def bind(self, *
-00021ab0: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
-00021ac0: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
-00021ad0: 204f 7574 7075 745d 3a0a 2020 2020 2020   Output]:.      
-00021ae0: 2020 2222 2242 696e 6420 6164 6469 7469    """Bind additi
-00021af0: 6f6e 616c 206b 7761 7267 7320 746f 2061  onal kwargs to a
-00021b00: 2052 756e 6e61 626c 652c 2072 6574 7572   Runnable, retur
-00021b10: 6e69 6e67 2061 206e 6577 2052 756e 6e61  ning a new Runna
-00021b20: 626c 652e 0a0a 2020 2020 2020 2020 4172  ble...        Ar
-00021b30: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00021b40: 2a2a 6b77 6172 6773 3a20 5468 6520 6b77  **kwargs: The kw
-00021b50: 6172 6773 2074 6f20 6269 6e64 2074 6f20  args to bind to 
-00021b60: 7468 6520 5275 6e6e 6162 6c65 2e0a 0a20  the Runnable... 
-00021b70: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00021b80: 2020 2020 2020 2020 2020 2020 4120 6e65              A ne
-00021b90: 7720 5275 6e6e 6162 6c65 2077 6974 6820  w Runnable with 
-00021ba0: 7468 6520 7361 6d65 2074 7970 6520 616e  the same type an
-00021bb0: 6420 636f 6e66 6967 2061 7320 7468 6520  d config as the 
-00021bc0: 6f72 6967 696e 616c 2c0a 2020 2020 2020  original,.      
-00021bd0: 2020 2020 2020 6275 7420 7769 7468 2074        but with t
-00021be0: 6865 2061 6464 6974 696f 6e61 6c20 6b77  he additional kw
-00021bf0: 6172 6773 2062 6f75 6e64 2e0a 2020 2020  args bound..    
-00021c00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00021c10: 7265 7475 726e 2073 656c 662e 5f5f 636c  return self.__cl
-00021c20: 6173 735f 5f28 0a20 2020 2020 2020 2020  ass__(.         
-00021c30: 2020 2062 6f75 6e64 3d73 656c 662e 626f     bound=self.bo
-00021c40: 756e 642c 0a20 2020 2020 2020 2020 2020  und,.           
-00021c50: 2063 6f6e 6669 673d 7365 6c66 2e63 6f6e   config=self.con
-00021c60: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
-00021c70: 206b 7761 7267 733d 7b2a 2a73 656c 662e   kwargs={**self.
-00021c80: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
-00021c90: 7d2c 0a20 2020 2020 2020 2020 2020 2063  },.            c
-00021ca0: 7573 746f 6d5f 696e 7075 745f 7479 7065  ustom_input_type
-00021cb0: 3d73 656c 662e 6375 7374 6f6d 5f69 6e70  =self.custom_inp
-00021cc0: 7574 5f74 7970 652c 0a20 2020 2020 2020  ut_type,.       
-00021cd0: 2020 2020 2063 7573 746f 6d5f 6f75 7470       custom_outp
-00021ce0: 7574 5f74 7970 653d 7365 6c66 2e63 7573  ut_type=self.cus
-00021cf0: 746f 6d5f 6f75 7470 7574 5f74 7970 652c  tom_output_type,
-00021d00: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00021d10: 6465 6620 7769 7468 5f63 6f6e 6669 6728  def with_config(
-00021d20: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00021d30: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
-00021d40: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-00021d50: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
-00021d60: 2020 2020 2020 2020 2320 5361 646c 7920          # Sadly 
-00021d70: 556e 7061 636b 2069 7320 6e6f 7420 7765  Unpack is not we
-00021d80: 6c6c 2073 7570 706f 7274 6564 2062 7920  ll supported by 
-00021d90: 6d79 7079 2073 6f20 7468 6973 2077 696c  mypy so this wil
-00021da0: 6c20 6861 7665 2074 6f20 6265 2075 6e74  l have to be unt
-00021db0: 7970 6564 0a20 2020 2020 2020 202a 2a6b  yped.        **k
-00021dc0: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00021dd0: 2920 2d3e 2052 756e 6e61 626c 655b 496e  ) -> Runnable[In
-00021de0: 7075 742c 204f 7574 7075 745d 3a0a 2020  put, Output]:.  
-00021df0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00021e00: 662e 5f5f 636c 6173 735f 5f28 0a20 2020  f.__class__(.   
-00021e10: 2020 2020 2020 2020 2062 6f75 6e64 3d73           bound=s
-00021e20: 656c 662e 626f 756e 642c 0a20 2020 2020  elf.bound,.     
-00021e30: 2020 2020 2020 206b 7761 7267 733d 7365         kwargs=se
-00021e40: 6c66 2e6b 7761 7267 732c 0a20 2020 2020  lf.kwargs,.     
-00021e50: 2020 2020 2020 2063 6f6e 6669 673d 6361         config=ca
-00021e60: 7374 2852 756e 6e61 626c 6543 6f6e 6669  st(RunnableConfi
-00021e70: 672c 207b 2a2a 7365 6c66 2e63 6f6e 6669  g, {**self.confi
-00021e80: 672c 202a 2a28 636f 6e66 6967 206f 7220  g, **(config or 
-00021e90: 7b7d 292c 202a 2a6b 7761 7267 737d 292c  {}), **kwargs}),
-00021ea0: 0a20 2020 2020 2020 2020 2020 2063 7573  .            cus
-00021eb0: 746f 6d5f 696e 7075 745f 7479 7065 3d73  tom_input_type=s
-00021ec0: 656c 662e 6375 7374 6f6d 5f69 6e70 7574  elf.custom_input
-00021ed0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
-00021ee0: 2020 2063 7573 746f 6d5f 6f75 7470 7574     custom_output
-00021ef0: 5f74 7970 653d 7365 6c66 2e63 7573 746f  _type=self.custo
-00021f00: 6d5f 6f75 7470 7574 5f74 7970 652c 0a20  m_output_type,. 
-00021f10: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00021f20: 6620 7769 7468 5f6c 6973 7465 6e65 7273  f with_listeners
-00021f30: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00021f40: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00021f50: 2020 206f 6e5f 7374 6172 743a 204f 7074     on_start: Opt
-00021f60: 696f 6e61 6c5b 4c69 7374 656e 6572 5d20  ional[Listener] 
-00021f70: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00021f80: 6f6e 5f65 6e64 3a20 4f70 7469 6f6e 616c  on_end: Optional
-00021f90: 5b4c 6973 7465 6e65 725d 203d 204e 6f6e  [Listener] = Non
-00021fa0: 652c 0a20 2020 2020 2020 206f 6e5f 6572  e,.        on_er
-00021fb0: 726f 723a 204f 7074 696f 6e61 6c5b 4c69  ror: Optional[Li
-00021fc0: 7374 656e 6572 5d20 3d20 4e6f 6e65 2c0a  stener] = None,.
-00021fd0: 2020 2020 2920 2d3e 2052 756e 6e61 626c      ) -> Runnabl
-00021fe0: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
-00021ff0: 3a0a 2020 2020 2020 2020 2222 2242 696e  :.        """Bin
-00022000: 6420 6c69 6665 6379 636c 6520 6c69 7374  d lifecycle list
-00022010: 656e 6572 7320 746f 2061 2052 756e 6e61  eners to a Runna
-00022020: 626c 652c 2072 6574 7572 6e69 6e67 2061  ble, returning a
-00022030: 206e 6577 2052 756e 6e61 626c 652e 0a0a   new Runnable...
-00022040: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00022050: 2020 2020 2020 2020 2020 6f6e 5f73 7461            on_sta
-00022060: 7274 3a20 4361 6c6c 6564 2062 6566 6f72  rt: Called befor
-00022070: 6520 7468 6520 7275 6e6e 6162 6c65 2073  e the runnable s
-00022080: 7461 7274 7320 7275 6e6e 696e 672c 2077  tarts running, w
-00022090: 6974 6820 7468 6520 5275 6e20 6f62 6a65  ith the Run obje
-000220a0: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
-000220b0: 6f6e 5f65 6e64 3a20 4361 6c6c 6564 2061  on_end: Called a
-000220c0: 6674 6572 2074 6865 2072 756e 6e61 626c  fter the runnabl
-000220d0: 6520 6669 6e69 7368 6573 2072 756e 6e69  e finishes runni
-000220e0: 6e67 2c20 7769 7468 2074 6865 2052 756e  ng, with the Run
-000220f0: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
-00022100: 2020 2020 206f 6e5f 6572 726f 723a 2043       on_error: C
-00022110: 616c 6c65 6420 6966 2074 6865 2072 756e  alled if the run
-00022120: 6e61 626c 6520 7468 726f 7773 2061 6e20  nable throws an 
-00022130: 6572 726f 722c 2077 6974 6820 7468 6520  error, with the 
-00022140: 5275 6e20 6f62 6a65 6374 2e0a 0a20 2020  Run object...   
-00022150: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-00022160: 2020 2020 2020 2020 2020 5468 6520 5275            The Ru
-00022170: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
-00022180: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
-00022190: 6f75 7420 7468 6520 7275 6e2c 2069 6e63  out the run, inc
-000221a0: 6c75 6469 6e67 2069 7473 2069 642c 0a20  luding its id,. 
-000221b0: 2020 2020 2020 2020 2020 2074 7970 652c             type,
-000221c0: 2069 6e70 7574 2c20 6f75 7470 7574 2c20   input, output, 
-000221d0: 6572 726f 722c 2073 7461 7274 5f74 696d  error, start_tim
-000221e0: 652c 2065 6e64 5f74 696d 652c 2061 6e64  e, end_time, and
-000221f0: 2061 6e79 2074 6167 7320 6f72 206d 6574   any tags or met
-00022200: 6164 6174 610a 2020 2020 2020 2020 2020  adata.          
-00022210: 2020 6164 6465 6420 746f 2074 6865 2072    added to the r
-00022220: 756e 2e0a 2020 2020 2020 2020 2222 220a  un..        """.
-00022230: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00022240: 6763 6861 696e 5f63 6f72 652e 7472 6163  gchain_core.trac
-00022250: 6572 732e 726f 6f74 5f6c 6973 7465 6e65  ers.root_listene
-00022260: 7273 2069 6d70 6f72 7420 526f 6f74 4c69  rs import RootLi
-00022270: 7374 656e 6572 7354 7261 6365 720a 0a20  stenersTracer.. 
-00022280: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00022290: 6c66 2e5f 5f63 6c61 7373 5f5f 280a 2020  lf.__class__(.  
-000222a0: 2020 2020 2020 2020 2020 626f 756e 643d            bound=
-000222b0: 7365 6c66 2e62 6f75 6e64 2c0a 2020 2020  self.bound,.    
-000222c0: 2020 2020 2020 2020 6b77 6172 6773 3d73          kwargs=s
-000222d0: 656c 662e 6b77 6172 6773 2c0a 2020 2020  elf.kwargs,.    
-000222e0: 2020 2020 2020 2020 636f 6e66 6967 3d73          config=s
-000222f0: 656c 662e 636f 6e66 6967 2c0a 2020 2020  elf.config,.    
-00022300: 2020 2020 2020 2020 636f 6e66 6967 5f66          config_f
-00022310: 6163 746f 7269 6573 3d5b 0a20 2020 2020  actories=[.     
-00022320: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00022330: 6120 636f 6e66 6967 3a20 7b0a 2020 2020  a config: {.    
-00022340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022350: 2263 616c 6c62 6163 6b73 223a 205b 0a20  "callbacks": [. 
-00022360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022370: 2020 2020 2020 2052 6f6f 744c 6973 7465         RootListe
-00022380: 6e65 7273 5472 6163 6572 280a 2020 2020  nersTracer(.    
-00022390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223a0: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
-000223b0: 6f6e 6669 672c 0a20 2020 2020 2020 2020  onfig,.         
-000223c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223d0: 2020 206f 6e5f 7374 6172 743d 6f6e 5f73     on_start=on_s
-000223e0: 7461 7274 2c0a 2020 2020 2020 2020 2020  tart,.          
-000223f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022400: 2020 6f6e 5f65 6e64 3d6f 6e5f 656e 642c    on_end=on_end,
-00022410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022420: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
-00022430: 6572 726f 723d 6f6e 5f65 7272 6f72 2c0a  error=on_error,.
-00022440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022450: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00022460: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00022470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022480: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
-00022490: 2c0a 2020 2020 2020 2020 2020 2020 6375  ,.            cu
-000224a0: 7374 6f6d 5f69 6e70 7574 5f74 7970 653d  stom_input_type=
-000224b0: 7365 6c66 2e63 7573 746f 6d5f 696e 7075  self.custom_inpu
-000224c0: 745f 7479 7065 2c0a 2020 2020 2020 2020  t_type,.        
-000224d0: 2020 2020 6375 7374 6f6d 5f6f 7574 7075      custom_outpu
-000224e0: 745f 7479 7065 3d73 656c 662e 6375 7374  t_type=self.cust
-000224f0: 6f6d 5f6f 7574 7075 745f 7479 7065 2c0a  om_output_type,.
-00022500: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00022510: 6566 2077 6974 685f 7479 7065 7328 0a20  ef with_types(. 
-00022520: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00022530: 2020 2020 2069 6e70 7574 5f74 7970 653a       input_type:
-00022540: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00022550: 5479 7065 5b49 6e70 7574 5d2c 2042 6173  Type[Input], Bas
-00022560: 654d 6f64 656c 5d5d 203d 204e 6f6e 652c  eModel]] = None,
-00022570: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
-00022580: 7479 7065 3a20 4f70 7469 6f6e 616c 5b55  type: Optional[U
-00022590: 6e69 6f6e 5b54 7970 655b 4f75 7470 7574  nion[Type[Output
-000225a0: 5d2c 2042 6173 654d 6f64 656c 5d5d 203d  ], BaseModel]] =
-000225b0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-000225c0: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-000225d0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
-000225e0: 2072 6574 7572 6e20 7365 6c66 2e5f 5f63   return self.__c
-000225f0: 6c61 7373 5f5f 280a 2020 2020 2020 2020  lass__(.        
-00022600: 2020 2020 626f 756e 643d 7365 6c66 2e62      bound=self.b
-00022610: 6f75 6e64 2c0a 2020 2020 2020 2020 2020  ound,.          
-00022620: 2020 6b77 6172 6773 3d73 656c 662e 6b77    kwargs=self.kw
-00022630: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
-00022640: 2020 636f 6e66 6967 3d73 656c 662e 636f    config=self.co
-00022650: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
-00022660: 2020 6375 7374 6f6d 5f69 6e70 7574 5f74    custom_input_t
-00022670: 7970 653d 696e 7075 745f 7479 7065 0a20  ype=input_type. 
-00022680: 2020 2020 2020 2020 2020 2069 6620 696e             if in
-00022690: 7075 745f 7479 7065 2069 7320 6e6f 7420  put_type is not 
-000226a0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000226b0: 2065 6c73 6520 7365 6c66 2e63 7573 746f   else self.custo
-000226c0: 6d5f 696e 7075 745f 7479 7065 2c0a 2020  m_input_type,.  
-000226d0: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
-000226e0: 5f6f 7574 7075 745f 7479 7065 3d6f 7574  _output_type=out
-000226f0: 7075 745f 7479 7065 0a20 2020 2020 2020  put_type.       
-00022700: 2020 2020 2069 6620 6f75 7470 7574 5f74       if output_t
-00022710: 7970 6520 6973 206e 6f74 204e 6f6e 650a  ype is not None.
-00022720: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00022730: 2073 656c 662e 6375 7374 6f6d 5f6f 7574   self.custom_out
-00022740: 7075 745f 7479 7065 2c0a 2020 2020 2020  put_type,.      
-00022750: 2020 290a 0a20 2020 2064 6566 2077 6974    )..    def wit
-00022760: 685f 7265 7472 7928 7365 6c66 2c20 2a2a  h_retry(self, **
-00022770: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-00022780: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-00022790: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
-000227a0: 2072 6574 7572 6e20 7365 6c66 2e5f 5f63   return self.__c
-000227b0: 6c61 7373 5f5f 280a 2020 2020 2020 2020  lass__(.        
-000227c0: 2020 2020 626f 756e 643d 7365 6c66 2e62      bound=self.b
-000227d0: 6f75 6e64 2e77 6974 685f 7265 7472 7928  ound.with_retry(
-000227e0: 2a2a 6b77 6172 6773 292c 0a20 2020 2020  **kwargs),.     
-000227f0: 2020 2020 2020 206b 7761 7267 733d 7365         kwargs=se
-00022800: 6c66 2e6b 7761 7267 732c 0a20 2020 2020  lf.kwargs,.     
-00022810: 2020 2020 2020 2063 6f6e 6669 673d 7365         config=se
-00022820: 6c66 2e63 6f6e 6669 672c 0a20 2020 2020  lf.config,.     
-00022830: 2020 2029 0a0a 0a52 756e 6e61 626c 654c     )...RunnableL
-00022840: 696b 6520 3d20 556e 696f 6e5b 0a20 2020  ike = Union[.   
-00022850: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
-00022860: 204f 7574 7075 745d 2c0a 2020 2020 4361   Output],.    Ca
-00022870: 6c6c 6162 6c65 5b5b 496e 7075 745d 2c20  llable[[Input], 
-00022880: 4f75 7470 7574 5d2c 0a20 2020 2043 616c  Output],.    Cal
-00022890: 6c61 626c 655b 5b49 6e70 7574 5d2c 2041  lable[[Input], A
-000228a0: 7761 6974 6162 6c65 5b4f 7574 7075 745d  waitable[Output]
-000228b0: 5d2c 0a20 2020 2043 616c 6c61 626c 655b  ],.    Callable[
-000228c0: 5b49 7465 7261 746f 725b 496e 7075 745d  [Iterator[Input]
-000228d0: 5d2c 2049 7465 7261 746f 725b 4f75 7470  ], Iterator[Outp
-000228e0: 7574 5d5d 2c0a 2020 2020 4361 6c6c 6162  ut]],.    Callab
-000228f0: 6c65 5b5b 4173 796e 6349 7465 7261 746f  le[[AsyncIterato
-00022900: 725b 496e 7075 745d 5d2c 2041 7379 6e63  r[Input]], Async
-00022910: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
-00022920: 5d2c 0a20 2020 204d 6170 7069 6e67 5b73  ],.    Mapping[s
-00022930: 7472 2c20 416e 795d 2c0a 5d0a 0a0a 6465  tr, Any],.]...de
-00022940: 6620 636f 6572 6365 5f74 6f5f 7275 6e6e  f coerce_to_runn
-00022950: 6162 6c65 2874 6869 6e67 3a20 5275 6e6e  able(thing: Runn
-00022960: 6162 6c65 4c69 6b65 2920 2d3e 2052 756e  ableLike) -> Run
-00022970: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
-00022980: 7075 745d 3a0a 2020 2020 2222 2243 6f65  put]:.    """Coe
-00022990: 7263 6520 6120 7275 6e6e 6162 6c65 2d6c  rce a runnable-l
-000229a0: 696b 6520 6f62 6a65 6374 2069 6e74 6f20  ike object into 
-000229b0: 6120 5275 6e6e 6162 6c65 2e0a 0a20 2020  a Runnable...   
-000229c0: 2041 7267 733a 0a20 2020 2020 2020 2074   Args:.        t
-000229d0: 6869 6e67 3a20 4120 7275 6e6e 6162 6c65  hing: A runnable
-000229e0: 2d6c 696b 6520 6f62 6a65 6374 2e0a 0a20  -like object... 
-000229f0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00022a00: 2020 2020 4120 5275 6e6e 6162 6c65 2e0a      A Runnable..
-00022a10: 2020 2020 2222 220a 2020 2020 6966 2069      """.    if i
-00022a20: 7369 6e73 7461 6e63 6528 7468 696e 672c  sinstance(thing,
-00022a30: 2052 756e 6e61 626c 6529 3a0a 2020 2020   Runnable):.    
-00022a40: 2020 2020 7265 7475 726e 2074 6869 6e67      return thing
-00022a50: 0a20 2020 2065 6c69 6620 696e 7370 6563  .    elif inspec
-00022a60: 742e 6973 6173 796e 6367 656e 6675 6e63  t.isasyncgenfunc
-00022a70: 7469 6f6e 2874 6869 6e67 2920 6f72 2069  tion(thing) or i
-00022a80: 6e73 7065 6374 2e69 7367 656e 6572 6174  nspect.isgenerat
-00022a90: 6f72 6675 6e63 7469 6f6e 2874 6869 6e67  orfunction(thing
-00022aa0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00022ab0: 6e20 5275 6e6e 6162 6c65 4765 6e65 7261  n RunnableGenera
-00022ac0: 746f 7228 7468 696e 6729 0a20 2020 2065  tor(thing).    e
-00022ad0: 6c69 6620 6361 6c6c 6162 6c65 2874 6869  lif callable(thi
-00022ae0: 6e67 293a 0a20 2020 2020 2020 2072 6574  ng):.        ret
-00022af0: 7572 6e20 5275 6e6e 6162 6c65 4c61 6d62  urn RunnableLamb
-00022b00: 6461 2863 6173 7428 4361 6c6c 6162 6c65  da(cast(Callable
-00022b10: 5b5b 496e 7075 745d 2c20 4f75 7470 7574  [[Input], Output
-00022b20: 5d2c 2074 6869 6e67 2929 0a20 2020 2065  ], thing)).    e
-00022b30: 6c69 6620 6973 696e 7374 616e 6365 2874  lif isinstance(t
-00022b40: 6869 6e67 2c20 6469 6374 293a 0a20 2020  hing, dict):.   
-00022b50: 2020 2020 2072 6574 7572 6e20 6361 7374       return cast
-00022b60: 2852 756e 6e61 626c 655b 496e 7075 742c  (Runnable[Input,
-00022b70: 204f 7574 7075 745d 2c20 5275 6e6e 6162   Output], Runnab
-00022b80: 6c65 5061 7261 6c6c 656c 2874 6869 6e67  leParallel(thing
-00022b90: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
-00022ba0: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-00022bb0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00022bc0: 2020 6622 4578 7065 6374 6564 2061 2052    f"Expected a R
-00022bd0: 756e 6e61 626c 652c 2063 616c 6c61 626c  unnable, callabl
-00022be0: 6520 6f72 2064 6963 742e 220a 2020 2020  e or dict.".    
-00022bf0: 2020 2020 2020 2020 6622 496e 7374 6561          f"Instea
-00022c00: 6420 676f 7420 616e 2075 6e73 7570 706f  d got an unsuppo
-00022c10: 7274 6564 2074 7970 653a 207b 7479 7065  rted type: {type
-00022c20: 2874 6869 6e67 297d 220a 2020 2020 2020  (thing)}".      
-00022c30: 2020 290a 0a0a 406f 7665 726c 6f61 640a    )...@overload.
-00022c40: 6465 6620 6368 6169 6e28 0a20 2020 2066  def chain(.    f
-00022c50: 756e 633a 2043 616c 6c61 626c 655b 5b49  unc: Callable[[I
-00022c60: 6e70 7574 5d2c 2043 6f72 6f75 7469 6e65  nput], Coroutine
-00022c70: 5b41 6e79 2c20 416e 792c 204f 7574 7075  [Any, Any, Outpu
-00022c80: 745d 5d2c 0a29 202d 3e20 5275 6e6e 6162  t]],.) -> Runnab
-00022c90: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-00022ca0: 5d3a 0a20 2020 202e 2e2e 0a0a 0a40 6f76  ]:.    ......@ov
-00022cb0: 6572 6c6f 6164 0a64 6566 2063 6861 696e  erload.def chain
-00022cc0: 280a 2020 2020 6675 6e63 3a20 4361 6c6c  (.    func: Call
-00022cd0: 6162 6c65 5b5b 496e 7075 745d 2c20 4974  able[[Input], It
-00022ce0: 6572 6174 6f72 5b4f 7574 7075 745d 5d2c  erator[Output]],
-00022cf0: 0a29 202d 3e20 5275 6e6e 6162 6c65 5b49  .) -> Runnable[I
-00022d00: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
-00022d10: 2020 202e 2e2e 0a0a 0a40 6f76 6572 6c6f     ......@overlo
-00022d20: 6164 0a64 6566 2063 6861 696e 280a 2020  ad.def chain(.  
-00022d30: 2020 6675 6e63 3a20 4361 6c6c 6162 6c65    func: Callable
-00022d40: 5b5b 496e 7075 745d 2c20 4173 796e 6349  [[Input], AsyncI
-00022d50: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
-00022d60: 2c0a 2920 2d3e 2052 756e 6e61 626c 655b  ,.) -> Runnable[
-00022d70: 496e 7075 742c 204f 7574 7075 745d 3a0a  Input, Output]:.
-00022d80: 2020 2020 2e2e 2e0a 0a0a 406f 7665 726c      ......@overl
-00022d90: 6f61 640a 6465 6620 6368 6169 6e28 0a20  oad.def chain(. 
-00022da0: 2020 2066 756e 633a 2043 616c 6c61 626c     func: Callabl
-00022db0: 655b 5b49 6e70 7574 5d2c 204f 7574 7075  e[[Input], Outpu
-00022dc0: 745d 2c0a 2920 2d3e 2052 756e 6e61 626c  t],.) -> Runnabl
-00022dd0: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
-00022de0: 3a0a 2020 2020 2e2e 2e0a 0a0a 6465 6620  :.    ......def 
-00022df0: 6368 6169 6e28 0a20 2020 2066 756e 633a  chain(.    func:
-00022e00: 2055 6e69 6f6e 5b0a 2020 2020 2020 2020   Union[.        
-00022e10: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
-00022e20: 2c20 4f75 7470 7574 5d2c 0a20 2020 2020  , Output],.     
-00022e30: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
-00022e40: 7574 5d2c 2049 7465 7261 746f 725b 4f75  ut], Iterator[Ou
-00022e50: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
-00022e60: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
-00022e70: 2c20 436f 726f 7574 696e 655b 416e 792c  , Coroutine[Any,
-00022e80: 2041 6e79 2c20 4f75 7470 7574 5d5d 2c0a   Any, Output]],.
-00022e90: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00022ea0: 5b5b 496e 7075 745d 2c20 4173 796e 6349  [[Input], AsyncI
-00022eb0: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
-00022ec0: 2c0a 2020 2020 5d2c 0a29 202d 3e20 5275  ,.    ],.) -> Ru
-00022ed0: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
-00022ee0: 7470 7574 5d3a 0a20 2020 2022 2222 4465  tput]:.    """De
-00022ef0: 636f 7261 7465 2061 2066 756e 6374 696f  corate a functio
-00022f00: 6e20 746f 206d 616b 6520 6974 2061 2052  n to make it a R
-00022f10: 756e 6e61 626c 652e 0a20 2020 2053 6574  unnable..    Set
-00022f20: 7320 7468 6520 6e61 6d65 206f 6620 7468  s the name of th
-00022f30: 6520 7275 6e6e 6162 6c65 2074 6f20 7468  e runnable to th
-00022f40: 6520 6e61 6d65 206f 6620 7468 6520 6675  e name of the fu
-00022f50: 6e63 7469 6f6e 2e0a 2020 2020 416e 7920  nction..    Any 
-00022f60: 7275 6e6e 6162 6c65 7320 6361 6c6c 6564  runnables called
-00022f70: 2062 7920 7468 6520 6675 6e63 7469 6f6e   by the function
-00022f80: 2077 696c 6c20 6265 2074 7261 6365 6420   will be traced 
-00022f90: 6173 2064 6570 656e 6465 6e63 6965 732e  as dependencies.
-00022fa0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00022fb0: 2020 2020 6675 6e63 3a20 4120 6361 6c6c      func: A call
-00022fc0: 6162 6c65 2e0a 0a20 2020 2052 6574 7572  able...    Retur
-00022fd0: 6e73 3a0a 2020 2020 2020 2020 4120 5275  ns:.        A Ru
-00022fe0: 6e6e 6162 6c65 2e0a 0a20 2020 2045 7861  nnable...    Exa
-00022ff0: 6d70 6c65 3a0a 0a20 2020 202e 2e20 636f  mple:..    .. co
-00023000: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
-00023010: 6e0a 0a20 2020 2020 2020 2066 726f 6d20  n..        from 
-00023020: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
-00023030: 756e 6e61 626c 6573 2069 6d70 6f72 7420  unnables import 
-00023040: 6368 6169 6e0a 2020 2020 2020 2020 6672  chain.        fr
-00023050: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-00023060: 652e 7072 6f6d 7074 7320 696d 706f 7274  e.prompts import
-00023070: 2050 726f 6d70 7454 656d 706c 6174 650a   PromptTemplate.
-00023080: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00023090: 6763 6861 696e 5f6f 7065 6e61 6920 696d  gchain_openai im
-000230a0: 706f 7274 204f 7065 6e41 490a 0a20 2020  port OpenAI..   
-000230b0: 2020 2020 2040 6368 6169 6e0a 2020 2020       @chain.    
-000230c0: 2020 2020 6465 6620 6d79 5f66 756e 6328      def my_func(
-000230d0: 6669 656c 6473 293a 0a20 2020 2020 2020  fields):.       
-000230e0: 2020 2020 2070 726f 6d70 7420 3d20 5072       prompt = Pr
-000230f0: 6f6d 7074 5465 6d70 6c61 7465 2822 4865  omptTemplate("He
-00023100: 6c6c 6f2c 207b 6e61 6d65 7d21 2229 0a20  llo, {name}!"). 
-00023110: 2020 2020 2020 2020 2020 206c 6c6d 203d             llm =
-00023120: 204f 7065 6e41 4928 290a 2020 2020 2020   OpenAI().      
-00023130: 2020 2020 2020 666f 726d 6174 7465 6420        formatted 
-00023140: 3d20 7072 6f6d 7074 2e69 6e76 6f6b 6528  = prompt.invoke(
-00023150: 2a2a 6669 656c 6473 290a 0a20 2020 2020  **fields)..     
-00023160: 2020 2020 2020 2066 6f72 2063 6875 6e6b         for chunk
-00023170: 2069 6e20 6c6c 6d2e 7374 7265 616d 2866   in llm.stream(f
-00023180: 6f72 6d61 7474 6564 293a 0a20 2020 2020  ormatted):.     
-00023190: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-000231a0: 2063 6875 6e6b 0a20 2020 2022 2222 0a20   chunk.    """. 
-000231b0: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
-000231c0: 6c65 4c61 6d62 6461 2866 756e 6329 0a    leLambda(func).
+0001c4b0: 206f 7574 7075 7420 3d20 7b6b 6579 3a20   output = {key: 
+0001c4c0: 6675 7475 7265 2e72 6573 756c 7428 2920  future.result() 
+0001c4d0: 666f 7220 6b65 792c 2066 7574 7572 6520  for key, future 
+0001c4e0: 696e 207a 6970 2873 7465 7073 2c20 6675  in zip(steps, fu
+0001c4f0: 7475 7265 7329 7d0a 2020 2020 2020 2020  tures)}.        
+0001c500: 2320 6669 6e69 7368 2074 6865 2072 6f6f  # finish the roo
+0001c510: 7420 7275 6e0a 2020 2020 2020 2020 6578  t run.        ex
+0001c520: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
+0001c530: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0001c540: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+0001c550: 2e6f 6e5f 6368 6169 6e5f 6572 726f 7228  .on_chain_error(
+0001c560: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+0001c570: 6169 7365 0a20 2020 2020 2020 2065 6c73  aise.        els
+0001c580: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001c590: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
+0001c5a0: 6169 6e5f 656e 6428 6f75 7470 7574 290a  ain_end(output).
+0001c5b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001c5c0: 726e 206f 7574 7075 740a 0a20 2020 2061  rn output..    a
+0001c5d0: 7379 6e63 2064 6566 2061 696e 766f 6b65  sync def ainvoke
+0001c5e0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0001c5f0: 2020 2020 2020 2020 696e 7075 743a 2049          input: I
+0001c600: 6e70 7574 2c0a 2020 2020 2020 2020 636f  nput,.        co
+0001c610: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+0001c620: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+0001c630: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+0001c640: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+0001c650: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+0001c660: 2044 6963 745b 7374 722c 2041 6e79 5d3a   Dict[str, Any]:
+0001c670: 0a20 2020 2020 2020 2023 2073 6574 7570  .        # setup
+0001c680: 2063 616c 6c62 6163 6b73 0a20 2020 2020   callbacks.     
+0001c690: 2020 2063 6f6e 6669 6720 3d20 656e 7375     config = ensu
+0001c6a0: 7265 5f63 6f6e 6669 6728 636f 6e66 6967  re_config(config
+0001c6b0: 290a 2020 2020 2020 2020 6361 6c6c 6261  ).        callba
+0001c6c0: 636b 5f6d 616e 6167 6572 203d 2067 6574  ck_manager = get
+0001c6d0: 5f61 7379 6e63 5f63 616c 6c62 6163 6b5f  _async_callback_
+0001c6e0: 6d61 6e61 6765 725f 666f 725f 636f 6e66  manager_for_conf
+0001c6f0: 6967 2863 6f6e 6669 6729 0a20 2020 2020  ig(config).     
+0001c700: 2020 2023 2073 7461 7274 2074 6865 2072     # start the r
+0001c710: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
+0001c720: 7275 6e5f 6d61 6e61 6765 7220 3d20 6177  run_manager = aw
+0001c730: 6169 7420 6361 6c6c 6261 636b 5f6d 616e  ait callback_man
+0001c740: 6167 6572 2e6f 6e5f 6368 6169 6e5f 7374  ager.on_chain_st
+0001c750: 6172 7428 0a20 2020 2020 2020 2020 2020  art(.           
+0001c760: 2064 756d 7064 2873 656c 6629 2c0a 2020   dumpd(self),.  
+0001c770: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+0001c780: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001c790: 653d 636f 6e66 6967 2e67 6574 2822 7275  e=config.get("ru
+0001c7a0: 6e5f 6e61 6d65 2229 206f 7220 7365 6c66  n_name") or self
+0001c7b0: 2e67 6574 5f6e 616d 6528 292c 0a20 2020  .get_name(),.   
+0001c7c0: 2020 2020 2020 2020 2072 756e 5f69 643d           run_id=
+0001c7d0: 636f 6e66 6967 2e70 6f70 2822 7275 6e5f  config.pop("run_
+0001c7e0: 6964 222c 204e 6f6e 6529 2c0a 2020 2020  id", None),.    
+0001c7f0: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+0001c800: 2067 6174 6865 7220 7265 7375 6c74 7320   gather results 
+0001c810: 6672 6f6d 2061 6c6c 2073 7465 7073 0a20  from all steps. 
+0001c820: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001c830: 2020 2020 2020 2020 2320 636f 7079 2074          # copy t
+0001c840: 6f20 6176 6f69 6420 6973 7375 6573 2066  o avoid issues f
+0001c850: 726f 6d20 7468 6520 6361 6c6c 6572 206d  rom the caller m
+0001c860: 7574 6174 696e 6720 7468 6520 7374 6570  utating the step
+0001c870: 7320 6475 7269 6e67 2069 6e76 6f6b 6528  s during invoke(
+0001c880: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0001c890: 6570 7320 3d20 6469 6374 2873 656c 662e  eps = dict(self.
+0001c8a0: 7374 6570 735f 5f29 0a20 2020 2020 2020  steps__).       
+0001c8b0: 2020 2020 2072 6573 756c 7473 203d 2061       results = a
+0001c8c0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+0001c8d0: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
+0001c8e0: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
+0001c8f0: 2020 2020 2020 2020 2020 2020 7374 6570              step
+0001c900: 2e61 696e 766f 6b65 280a 2020 2020 2020  .ainvoke(.      
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c920: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
+0001c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c940: 2023 206d 6172 6b20 6561 6368 2073 7465   # mark each ste
+0001c950: 7020 6173 2061 2063 6869 6c64 2072 756e  p as a child run
+0001c960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c970: 2020 2020 2020 2020 2070 6174 6368 5f63           patch_c
+0001c980: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
+0001c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c9a0: 2020 2063 6f6e 6669 672c 2063 616c 6c62     config, callb
+0001c9b0: 6163 6b73 3d72 756e 5f6d 616e 6167 6572  acks=run_manager
+0001c9c0: 2e67 6574 5f63 6869 6c64 2866 226d 6170  .get_child(f"map
+0001c9d0: 3a6b 6579 3a7b 6b65 797d 2229 0a20 2020  :key:{key}").   
+0001c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c9f0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0001ca00: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca20: 2020 666f 7220 6b65 792c 2073 7465 7020    for key, step 
+0001ca30: 696e 2073 7465 7073 2e69 7465 6d73 2829  in steps.items()
+0001ca40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ca50: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
+0001ca60: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0001ca70: 7075 7420 3d20 7b6b 6579 3a20 7661 6c75  put = {key: valu
+0001ca80: 6520 666f 7220 6b65 792c 2076 616c 7565  e for key, value
+0001ca90: 2069 6e20 7a69 7028 7374 6570 732c 2072   in zip(steps, r
+0001caa0: 6573 756c 7473 297d 0a20 2020 2020 2020  esults)}.       
+0001cab0: 2023 2066 696e 6973 6820 7468 6520 726f   # finish the ro
+0001cac0: 6f74 2072 756e 0a20 2020 2020 2020 2065  ot run.        e
+0001cad0: 7863 6570 7420 4261 7365 4578 6365 7074  xcept BaseExcept
+0001cae0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0001caf0: 2020 2020 2020 6177 6169 7420 7275 6e5f        await run_
+0001cb00: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+0001cb10: 5f65 7272 6f72 2865 290a 2020 2020 2020  _error(e).      
+0001cb20: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
+0001cb30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001cb40: 2020 2020 2020 6177 6169 7420 7275 6e5f        await run_
+0001cb50: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+0001cb60: 5f65 6e64 286f 7574 7075 7429 0a20 2020  _end(output).   
+0001cb70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001cb80: 6f75 7470 7574 0a0a 2020 2020 6465 6620  output..    def 
+0001cb90: 5f74 7261 6e73 666f 726d 280a 2020 2020  _transform(.    
+0001cba0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0001cbb0: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+0001cbc0: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+0001cbd0: 2020 7275 6e5f 6d61 6e61 6765 723a 2043    run_manager: C
+0001cbe0: 616c 6c62 6163 6b4d 616e 6167 6572 466f  allbackManagerFo
+0001cbf0: 7243 6861 696e 5275 6e2c 0a20 2020 2020  rChainRun,.     
+0001cc00: 2020 2063 6f6e 6669 673a 2052 756e 6e61     config: Runna
+0001cc10: 626c 6543 6f6e 6669 672c 0a20 2020 2029  bleConfig,.    )
+0001cc20: 202d 3e20 4974 6572 6174 6f72 5b41 6464   -> Iterator[Add
+0001cc30: 6162 6c65 4469 6374 5d3a 0a20 2020 2020  ableDict]:.     
+0001cc40: 2020 2023 2053 6861 6c6c 6f77 2063 6f70     # Shallow cop
+0001cc50: 7920 7374 6570 7320 746f 2069 676e 6f72  y steps to ignor
+0001cc60: 6520 6d75 7461 7469 6f6e 7320 7768 696c  e mutations whil
+0001cc70: 6520 696e 2070 726f 6772 6573 730a 2020  e in progress.  
+0001cc80: 2020 2020 2020 7374 6570 7320 3d20 6469        steps = di
+0001cc90: 6374 2873 656c 662e 7374 6570 735f 5f29  ct(self.steps__)
+0001cca0: 0a20 2020 2020 2020 2023 2045 6163 6820  .        # Each 
+0001ccb0: 7374 6570 2067 6574 7320 6120 636f 7079  step gets a copy
+0001ccc0: 206f 6620 7468 6520 696e 7075 7420 6974   of the input it
+0001ccd0: 6572 6174 6f72 2c0a 2020 2020 2020 2020  erator,.        
+0001cce0: 2320 7768 6963 6820 6973 2063 6f6e 7375  # which is consu
+0001ccf0: 6d65 6420 696e 2070 6172 616c 6c65 6c20  med in parallel 
+0001cd00: 696e 2061 2073 6570 6172 6174 6520 7468  in a separate th
+0001cd10: 7265 6164 2e0a 2020 2020 2020 2020 696e  read..        in
+0001cd20: 7075 745f 636f 7069 6573 203d 206c 6973  put_copies = lis
+0001cd30: 7428 7361 6665 7465 6528 696e 7075 742c  t(safetee(input,
+0001cd40: 206c 656e 2873 7465 7073 292c 206c 6f63   len(steps), loc
+0001cd50: 6b3d 7468 7265 6164 696e 672e 4c6f 636b  k=threading.Lock
+0001cd60: 2829 2929 0a20 2020 2020 2020 2077 6974  ())).        wit
+0001cd70: 6820 6765 745f 6578 6563 7574 6f72 5f66  h get_executor_f
+0001cd80: 6f72 5f63 6f6e 6669 6728 636f 6e66 6967  or_config(config
+0001cd90: 2920 6173 2065 7865 6375 746f 723a 0a20  ) as executor:. 
+0001cda0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
+0001cdb0: 6174 6520 7468 6520 7472 616e 7366 6f72  ate the transfor
+0001cdc0: 6d28 2920 6765 6e65 7261 746f 7220 666f  m() generator fo
+0001cdd0: 7220 6561 6368 2073 7465 700a 2020 2020  r each step.    
+0001cde0: 2020 2020 2020 2020 6e61 6d65 645f 6765          named_ge
+0001cdf0: 6e65 7261 746f 7273 203d 205b 0a20 2020  nerators = [.   
+0001ce00: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
+0001ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce20: 2020 206e 616d 652c 0a20 2020 2020 2020     name,.       
+0001ce30: 2020 2020 2020 2020 2020 2020 2073 7465               ste
+0001ce40: 702e 7472 616e 7366 6f72 6d28 0a20 2020  p.transform(.   
+0001ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce60: 2020 2020 2069 6e70 7574 5f63 6f70 6965       input_copie
+0001ce70: 732e 706f 7028 292c 0a20 2020 2020 2020  s.pop(),.       
+0001ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce90: 2070 6174 6368 5f63 6f6e 6669 6728 0a20   patch_config(. 
+0001cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ceb0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+0001cec0: 672c 2063 616c 6c62 6163 6b73 3d72 756e  g, callbacks=run
+0001ced0: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
+0001cee0: 6c64 2866 226d 6170 3a6b 6579 3a7b 6e61  ld(f"map:key:{na
+0001cef0: 6d65 7d22 290a 2020 2020 2020 2020 2020  me}").          
+0001cf00: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+0001cf10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cf20: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0001cf30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001cf40: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
+0001cf50: 6d65 2c20 7374 6570 2069 6e20 7374 6570  me, step in step
+0001cf60: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+0001cf70: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0001cf80: 2020 2020 2320 5374 6172 7420 7468 6520      # Start the 
+0001cf90: 6669 7273 7420 6974 6572 6174 696f 6e20  first iteration 
+0001cfa0: 6f66 2065 6163 6820 6765 6e65 7261 746f  of each generato
+0001cfb0: 720a 2020 2020 2020 2020 2020 2020 6675  r.            fu
+0001cfc0: 7475 7265 7320 3d20 7b0a 2020 2020 2020  tures = {.      
+0001cfd0: 2020 2020 2020 2020 2020 6578 6563 7574            execut
+0001cfe0: 6f72 2e73 7562 6d69 7428 6e65 7874 2c20  or.submit(next, 
+0001cff0: 6765 6e65 7261 746f 7229 3a20 2873 7465  generator): (ste
+0001d000: 705f 6e61 6d65 2c20 6765 6e65 7261 746f  p_name, generato
+0001d010: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+0001d020: 2020 2066 6f72 2073 7465 705f 6e61 6d65     for step_name
+0001d030: 2c20 6765 6e65 7261 746f 7220 696e 206e  , generator in n
+0001d040: 616d 6564 5f67 656e 6572 6174 6f72 730a  amed_generators.
+0001d050: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0001d060: 2020 2020 2020 2020 2020 2320 5969 656c            # Yiel
+0001d070: 6420 6368 756e 6b73 2066 726f 6d20 6561  d chunks from ea
+0001d080: 6368 2061 7320 7468 6579 2062 6563 6f6d  ch as they becom
+0001d090: 6520 6176 6169 6c61 626c 652c 0a20 2020  e available,.   
+0001d0a0: 2020 2020 2020 2020 2023 2061 6e64 2073           # and s
+0001d0b0: 7461 7274 2074 6865 206e 6578 7420 6974  tart the next it
+0001d0c0: 6572 6174 696f 6e20 6f66 2074 6861 7420  eration of that 
+0001d0d0: 6765 6e65 7261 746f 7220 7468 6174 2079  generator that y
+0001d0e0: 6965 6c64 6564 2069 742e 0a20 2020 2020  ielded it..     
+0001d0f0: 2020 2020 2020 2023 2057 6865 6e20 616c         # When al
+0001d100: 6c20 6765 6e65 7261 746f 7273 2061 7265  l generators are
+0001d110: 2065 7868 6175 7374 6564 2c20 7374 6f70   exhausted, stop
+0001d120: 2e0a 2020 2020 2020 2020 2020 2020 7768  ..            wh
+0001d130: 696c 6520 6675 7475 7265 733a 0a20 2020  ile futures:.   
+0001d140: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+0001d150: 706c 6574 6564 5f66 7574 7572 6573 2c20  pleted_futures, 
+0001d160: 5f20 3d20 7761 6974 2866 7574 7572 6573  _ = wait(futures
+0001d170: 2c20 7265 7475 726e 5f77 6865 6e3d 4649  , return_when=FI
+0001d180: 5253 545f 434f 4d50 4c45 5445 4429 0a20  RST_COMPLETED). 
+0001d190: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001d1a0: 6f72 2066 7574 7572 6520 696e 2063 6f6d  or future in com
+0001d1b0: 706c 6574 6564 5f66 7574 7572 6573 3a0a  pleted_futures:.
+0001d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1d0: 2020 2020 2873 7465 705f 6e61 6d65 2c20      (step_name, 
+0001d1e0: 6765 6e65 7261 746f 7229 203d 2066 7574  generator) = fut
+0001d1f0: 7572 6573 2e70 6f70 2866 7574 7572 6529  ures.pop(future)
+0001d200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d210: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d230: 2020 6368 756e 6b20 3d20 4164 6461 626c    chunk = Addabl
+0001d240: 6544 6963 7428 7b73 7465 705f 6e61 6d65  eDict({step_name
+0001d250: 3a20 6675 7475 7265 2e72 6573 756c 7428  : future.result(
+0001d260: 297d 290a 2020 2020 2020 2020 2020 2020  )}).            
+0001d270: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0001d280: 6420 6368 756e 6b0a 2020 2020 2020 2020  d chunk.        
+0001d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2a0: 6675 7475 7265 735b 6578 6563 7574 6f72  futures[executor
+0001d2b0: 2e73 7562 6d69 7428 6e65 7874 2c20 6765  .submit(next, ge
+0001d2c0: 6e65 7261 746f 7229 5d20 3d20 280a 2020  nerator)] = (.  
+0001d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2e0: 2020 2020 2020 2020 2020 7374 6570 5f6e            step_n
+0001d2f0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0001d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d310: 2067 656e 6572 6174 6f72 2c0a 2020 2020   generator,.    
+0001d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d330: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001d340: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0001d350: 2053 746f 7049 7465 7261 7469 6f6e 3a0a   StopIteration:.
+0001d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d370: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+0001d380: 2020 6465 6620 7472 616e 7366 6f72 6d28    def transform(
+0001d390: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0001d3a0: 2020 2020 2020 2069 6e70 7574 3a20 4974         input: It
+0001d3b0: 6572 6174 6f72 5b49 6e70 7574 5d2c 0a20  erator[Input],. 
+0001d3c0: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
+0001d3d0: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+0001d3e0: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
+0001d3f0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0001d400: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+0001d410: 4974 6572 6174 6f72 5b44 6963 745b 7374  Iterator[Dict[st
+0001d420: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
+0001d430: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0001d440: 662e 5f74 7261 6e73 666f 726d 5f73 7472  f._transform_str
+0001d450: 6561 6d5f 7769 7468 5f63 6f6e 6669 6728  eam_with_config(
+0001d460: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+0001d470: 7574 2c20 7365 6c66 2e5f 7472 616e 7366  ut, self._transf
+0001d480: 6f72 6d2c 2063 6f6e 6669 672c 202a 2a6b  orm, config, **k
+0001d490: 7761 7267 730a 2020 2020 2020 2020 290a  wargs.        ).
+0001d4a0: 0a20 2020 2064 6566 2073 7472 6561 6d28  .    def stream(
+0001d4b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0001d4c0: 2020 2020 2020 2069 6e70 7574 3a20 496e         input: In
+0001d4d0: 7075 742c 0a20 2020 2020 2020 2063 6f6e  put,.        con
+0001d4e0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
+0001d4f0: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
+0001d500: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
+0001d510: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
+0001d520: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
+0001d530: 4974 6572 6174 6f72 5b44 6963 745b 7374  Iterator[Dict[st
+0001d540: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
+0001d550: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0001d560: 662e 7472 616e 7366 6f72 6d28 6974 6572  f.transform(iter
+0001d570: 285b 696e 7075 745d 292c 2063 6f6e 6669  ([input]), confi
+0001d580: 6729 0a0a 2020 2020 6173 796e 6320 6465  g)..    async de
+0001d590: 6620 5f61 7472 616e 7366 6f72 6d28 0a20  f _atransform(. 
+0001d5a0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001d5b0: 2020 2020 2069 6e70 7574 3a20 4173 796e       input: Asyn
+0001d5c0: 6349 7465 7261 746f 725b 496e 7075 745d  cIterator[Input]
+0001d5d0: 2c0a 2020 2020 2020 2020 7275 6e5f 6d61  ,.        run_ma
+0001d5e0: 6e61 6765 723a 2041 7379 6e63 4361 6c6c  nager: AsyncCall
+0001d5f0: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
+0001d600: 6169 6e52 756e 2c0a 2020 2020 2020 2020  ainRun,.        
+0001d610: 636f 6e66 6967 3a20 5275 6e6e 6162 6c65  config: Runnable
+0001d620: 436f 6e66 6967 2c0a 2020 2020 2920 2d3e  Config,.    ) ->
+0001d630: 2041 7379 6e63 4974 6572 6174 6f72 5b41   AsyncIterator[A
+0001d640: 6464 6162 6c65 4469 6374 5d3a 0a20 2020  ddableDict]:.   
+0001d650: 2020 2020 2023 2053 6861 6c6c 6f77 2063       # Shallow c
+0001d660: 6f70 7920 7374 6570 7320 746f 2069 676e  opy steps to ign
+0001d670: 6f72 6520 6d75 7461 7469 6f6e 7320 7768  ore mutations wh
+0001d680: 696c 6520 696e 2070 726f 6772 6573 730a  ile in progress.
+0001d690: 2020 2020 2020 2020 7374 6570 7320 3d20          steps = 
+0001d6a0: 6469 6374 2873 656c 662e 7374 6570 735f  dict(self.steps_
+0001d6b0: 5f29 0a20 2020 2020 2020 2023 2045 6163  _).        # Eac
+0001d6c0: 6820 7374 6570 2067 6574 7320 6120 636f  h step gets a co
+0001d6d0: 7079 206f 6620 7468 6520 696e 7075 7420  py of the input 
+0001d6e0: 6974 6572 6174 6f72 2c0a 2020 2020 2020  iterator,.      
+0001d6f0: 2020 2320 7768 6963 6820 6973 2063 6f6e    # which is con
+0001d700: 7375 6d65 6420 696e 2070 6172 616c 6c65  sumed in paralle
+0001d710: 6c20 696e 2061 2073 6570 6172 6174 6520  l in a separate 
+0001d720: 7468 7265 6164 2e0a 2020 2020 2020 2020  thread..        
+0001d730: 696e 7075 745f 636f 7069 6573 203d 206c  input_copies = l
+0001d740: 6973 7428 6174 6565 2869 6e70 7574 2c20  ist(atee(input, 
+0001d750: 6c65 6e28 7374 6570 7329 2c20 6c6f 636b  len(steps), lock
+0001d760: 3d61 7379 6e63 696f 2e4c 6f63 6b28 2929  =asyncio.Lock())
+0001d770: 290a 2020 2020 2020 2020 2320 4372 6561  ).        # Crea
+0001d780: 7465 2074 6865 2074 7261 6e73 666f 726d  te the transform
+0001d790: 2829 2067 656e 6572 6174 6f72 2066 6f72  () generator for
+0001d7a0: 2065 6163 6820 7374 6570 0a20 2020 2020   each step.     
+0001d7b0: 2020 206e 616d 6564 5f67 656e 6572 6174     named_generat
+0001d7c0: 6f72 7320 3d20 5b0a 2020 2020 2020 2020  ors = [.        
+0001d7d0: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+0001d7e0: 2020 2020 2020 6e61 6d65 2c0a 2020 2020        name,.    
+0001d7f0: 2020 2020 2020 2020 2020 2020 7374 6570              step
+0001d800: 2e61 7472 616e 7366 6f72 6d28 0a20 2020  .atransform(.   
+0001d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d820: 2069 6e70 7574 5f63 6f70 6965 732e 706f   input_copies.po
+0001d830: 7028 292c 0a20 2020 2020 2020 2020 2020  p(),.           
+0001d840: 2020 2020 2020 2020 2070 6174 6368 5f63           patch_c
+0001d850: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
+0001d860: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001d870: 6f6e 6669 672c 2063 616c 6c62 6163 6b73  onfig, callbacks
+0001d880: 3d72 756e 5f6d 616e 6167 6572 2e67 6574  =run_manager.get
+0001d890: 5f63 6869 6c64 2866 226d 6170 3a6b 6579  _child(f"map:key
+0001d8a0: 3a7b 6e61 6d65 7d22 290a 2020 2020 2020  :{name}").      
+0001d8b0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+0001d8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d8d0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0001d8e0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0001d8f0: 7220 6e61 6d65 2c20 7374 6570 2069 6e20  r name, step in 
+0001d900: 7374 6570 732e 6974 656d 7328 290a 2020  steps.items().  
+0001d910: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
+0001d920: 2023 2057 7261 7020 696e 2061 2063 6f72   # Wrap in a cor
+0001d930: 6f75 7469 6e65 2074 6f20 7361 7469 7366  outine to satisf
+0001d940: 7920 6c69 6e74 6572 0a20 2020 2020 2020  y linter.       
+0001d950: 2061 7379 6e63 2064 6566 2067 6574 5f6e   async def get_n
+0001d960: 6578 745f 6368 756e 6b28 6765 6e65 7261  ext_chunk(genera
+0001d970: 746f 723a 2041 7379 6e63 4974 6572 6174  tor: AsyncIterat
+0001d980: 6f72 2920 2d3e 204f 7074 696f 6e61 6c5b  or) -> Optional[
+0001d990: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+0001d9a0: 2020 2020 2072 6574 7572 6e20 6177 6169       return awai
+0001d9b0: 7420 7079 5f61 6e65 7874 2867 656e 6572  t py_anext(gener
+0001d9c0: 6174 6f72 290a 0a20 2020 2020 2020 2023  ator)..        #
+0001d9d0: 2053 7461 7274 2074 6865 2066 6972 7374   Start the first
+0001d9e0: 2069 7465 7261 7469 6f6e 206f 6620 6561   iteration of ea
+0001d9f0: 6368 2067 656e 6572 6174 6f72 0a20 2020  ch generator.   
+0001da00: 2020 2020 2074 6173 6b73 203d 207b 0a20       tasks = {. 
+0001da10: 2020 2020 2020 2020 2020 2061 7379 6e63             async
+0001da20: 696f 2e63 7265 6174 655f 7461 736b 2867  io.create_task(g
+0001da30: 6574 5f6e 6578 745f 6368 756e 6b28 6765  et_next_chunk(ge
+0001da40: 6e65 7261 746f 7229 293a 2028 7374 6570  nerator)): (step
+0001da50: 5f6e 616d 652c 2067 656e 6572 6174 6f72  _name, generator
+0001da60: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0001da70: 7220 7374 6570 5f6e 616d 652c 2067 656e  r step_name, gen
+0001da80: 6572 6174 6f72 2069 6e20 6e61 6d65 645f  erator in named_
+0001da90: 6765 6e65 7261 746f 7273 0a20 2020 2020  generators.     
+0001daa0: 2020 207d 0a20 2020 2020 2020 2023 2059     }.        # Y
+0001dab0: 6965 6c64 2063 6875 6e6b 7320 6672 6f6d  ield chunks from
+0001dac0: 2065 6163 6820 6173 2074 6865 7920 6265   each as they be
+0001dad0: 636f 6d65 2061 7661 696c 6162 6c65 2c0a  come available,.
+0001dae0: 2020 2020 2020 2020 2320 616e 6420 7374          # and st
+0001daf0: 6172 7420 7468 6520 6e65 7874 2069 7465  art the next ite
+0001db00: 7261 7469 6f6e 206f 6620 7468 6520 6765  ration of the ge
+0001db10: 6e65 7261 746f 7220 7468 6174 2079 6965  nerator that yie
+0001db20: 6c64 6564 2069 742e 0a20 2020 2020 2020  lded it..       
+0001db30: 2023 2057 6865 6e20 616c 6c20 6765 6e65   # When all gene
+0001db40: 7261 746f 7273 2061 7265 2065 7868 6175  rators are exhau
+0001db50: 7374 6564 2c20 7374 6f70 2e0a 2020 2020  sted, stop..    
+0001db60: 2020 2020 7768 696c 6520 7461 736b 733a      while tasks:
+0001db70: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+0001db80: 706c 6574 6564 5f74 6173 6b73 2c20 5f20  pleted_tasks, _ 
+0001db90: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
+0001dba0: 7761 6974 280a 2020 2020 2020 2020 2020  wait(.          
+0001dbb0: 2020 2020 2020 7461 736b 732c 2072 6574        tasks, ret
+0001dbc0: 7572 6e5f 7768 656e 3d61 7379 6e63 696f  urn_when=asyncio
+0001dbd0: 2e46 4952 5354 5f43 4f4d 504c 4554 4544  .FIRST_COMPLETED
+0001dbe0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001dbf0: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0001dc00: 6173 6b20 696e 2063 6f6d 706c 6574 6564  ask in completed
+0001dc10: 5f74 6173 6b73 3a0a 2020 2020 2020 2020  _tasks:.        
+0001dc20: 2020 2020 2020 2020 2873 7465 705f 6e61          (step_na
+0001dc30: 6d65 2c20 6765 6e65 7261 746f 7229 203d  me, generator) =
+0001dc40: 2074 6173 6b73 2e70 6f70 2874 6173 6b29   tasks.pop(task)
+0001dc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dc60: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001dc70: 2020 2020 2020 2020 2020 6368 756e 6b20            chunk 
+0001dc80: 3d20 4164 6461 626c 6544 6963 7428 7b73  = AddableDict({s
+0001dc90: 7465 705f 6e61 6d65 3a20 7461 736b 2e72  tep_name: task.r
+0001dca0: 6573 756c 7428 297d 290a 2020 2020 2020  esult()}).      
+0001dcb0: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0001dcc0: 656c 6420 6368 756e 6b0a 2020 2020 2020  eld chunk.      
+0001dcd0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0001dce0: 775f 7461 736b 203d 2061 7379 6e63 696f  w_task = asyncio
+0001dcf0: 2e63 7265 6174 655f 7461 736b 2867 6574  .create_task(get
+0001dd00: 5f6e 6578 745f 6368 756e 6b28 6765 6e65  _next_chunk(gene
+0001dd10: 7261 746f 7229 290a 2020 2020 2020 2020  rator)).        
+0001dd20: 2020 2020 2020 2020 2020 2020 7461 736b              task
+0001dd30: 735b 6e65 775f 7461 736b 5d20 3d20 2873  s[new_task] = (s
+0001dd40: 7465 705f 6e61 6d65 2c20 6765 6e65 7261  tep_name, genera
+0001dd50: 746f 7229 0a20 2020 2020 2020 2020 2020  tor).           
+0001dd60: 2020 2020 2065 7863 6570 7420 5374 6f70       except Stop
+0001dd70: 4173 796e 6349 7465 7261 7469 6f6e 3a0a  AsyncIteration:.
+0001dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd90: 2020 2020 7061 7373 0a0a 2020 2020 6173      pass..    as
+0001dda0: 796e 6320 6465 6620 6174 7261 6e73 666f  ync def atransfo
+0001ddb0: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
+0001ddc0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+0001ddd0: 2041 7379 6e63 4974 6572 6174 6f72 5b49   AsyncIterator[I
+0001dde0: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
+0001ddf0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+0001de00: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+0001de10: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0001de20: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
+0001de30: 2020 2029 202d 3e20 4173 796e 6349 7465     ) -> AsyncIte
+0001de40: 7261 746f 725b 4469 6374 5b73 7472 2c20  rator[Dict[str, 
+0001de50: 416e 795d 5d3a 0a20 2020 2020 2020 2061  Any]]:.        a
+0001de60: 7379 6e63 2066 6f72 2063 6875 6e6b 2069  sync for chunk i
+0001de70: 6e20 7365 6c66 2e5f 6174 7261 6e73 666f  n self._atransfo
+0001de80: 726d 5f73 7472 6561 6d5f 7769 7468 5f63  rm_stream_with_c
+0001de90: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
+0001dea0: 2020 2069 6e70 7574 2c20 7365 6c66 2e5f     input, self._
+0001deb0: 6174 7261 6e73 666f 726d 2c20 636f 6e66  atransform, conf
+0001dec0: 6967 2c20 2a2a 6b77 6172 6773 0a20 2020  ig, **kwargs.   
+0001ded0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+0001dee0: 2020 2020 7969 656c 6420 6368 756e 6b0a      yield chunk.
+0001def0: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
+0001df00: 7374 7265 616d 280a 2020 2020 2020 2020  stream(.        
+0001df10: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+0001df20: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+0001df30: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+0001df40: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+0001df50: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+0001df60: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+0001df70: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+0001df80: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
+0001df90: 6174 6f72 5b44 6963 745b 7374 722c 2041  ator[Dict[str, A
+0001dfa0: 6e79 5d5d 3a0a 2020 2020 2020 2020 6173  ny]]:.        as
+0001dfb0: 796e 6320 6465 6620 696e 7075 745f 6169  ync def input_ai
+0001dfc0: 7465 7228 2920 2d3e 2041 7379 6e63 4974  ter() -> AsyncIt
+0001dfd0: 6572 6174 6f72 5b49 6e70 7574 5d3a 0a20  erator[Input]:. 
+0001dfe0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+0001dff0: 2069 6e70 7574 0a0a 2020 2020 2020 2020   input..        
+0001e000: 6173 796e 6320 666f 7220 6368 756e 6b20  async for chunk 
+0001e010: 696e 2073 656c 662e 6174 7261 6e73 666f  in self.atransfo
+0001e020: 726d 2869 6e70 7574 5f61 6974 6572 2829  rm(input_aiter()
+0001e030: 2c20 636f 6e66 6967 293a 0a20 2020 2020  , config):.     
+0001e040: 2020 2020 2020 2079 6965 6c64 2063 6875         yield chu
+0001e050: 6e6b 0a0a 0a23 2057 6520 7375 7070 6f72  nk...# We suppor
+0001e060: 7420 626f 7468 206e 616d 6573 0a52 756e  t both names.Run
+0001e070: 6e61 626c 654d 6170 203d 2052 756e 6e61  nableMap = Runna
+0001e080: 626c 6550 6172 616c 6c65 6c0a 0a0a 636c  bleParallel...cl
+0001e090: 6173 7320 5275 6e6e 6162 6c65 4765 6e65  ass RunnableGene
+0001e0a0: 7261 746f 7228 5275 6e6e 6162 6c65 5b49  rator(Runnable[I
+0001e0b0: 6e70 7574 2c20 4f75 7470 7574 5d29 3a0a  nput, Output]):.
+0001e0c0: 2020 2020 2222 2252 756e 6e61 626c 6520      """Runnable 
+0001e0d0: 7468 6174 2072 756e 7320 6120 6765 6e65  that runs a gene
+0001e0e0: 7261 746f 7220 6675 6e63 7469 6f6e 2e0a  rator function..
+0001e0f0: 0a20 2020 2052 756e 6e61 626c 6547 656e  .    RunnableGen
+0001e100: 6572 6174 6f72 7320 6361 6e20 6265 2069  erators can be i
+0001e110: 6e73 7461 6e74 6961 7465 6420 6469 7265  nstantiated dire
+0001e120: 6374 6c79 206f 7220 6279 2075 7369 6e67  ctly or by using
+0001e130: 2061 2067 656e 6572 6174 6f72 2077 6974   a generator wit
+0001e140: 6869 6e0a 2020 2020 6120 7365 7175 656e  hin.    a sequen
+0001e150: 6365 2e0a 0a20 2020 2052 756e 6e61 626c  ce...    Runnabl
+0001e160: 6547 656e 6572 6174 6f72 7320 6361 6e20  eGenerators can 
+0001e170: 6265 2075 7365 6420 746f 2069 6d70 6c65  be used to imple
+0001e180: 6d65 6e74 2063 7573 746f 6d20 6265 6861  ment custom beha
+0001e190: 7669 6f72 2c20 7375 6368 2061 7320 6375  vior, such as cu
+0001e1a0: 7374 6f6d 206f 7574 7075 740a 2020 2020  stom output.    
+0001e1b0: 7061 7273 6572 732c 2077 6869 6c65 2070  parsers, while p
+0001e1c0: 7265 7365 7276 696e 6720 7374 7265 616d  reserving stream
+0001e1d0: 696e 6720 6361 7061 6269 6c69 7469 6573  ing capabilities
+0001e1e0: 2e20 4769 7665 6e20 6120 6765 6e65 7261  . Given a genera
+0001e1f0: 746f 7220 6675 6e63 7469 6f6e 2077 6974  tor function wit
+0001e200: 680a 2020 2020 6120 7369 676e 6174 7572  h.    a signatur
+0001e210: 6520 4974 6572 6174 6f72 5b41 5d20 2d3e  e Iterator[A] ->
+0001e220: 2049 7465 7261 746f 725b 425d 2c20 7772   Iterator[B], wr
+0001e230: 6170 7069 6e67 2069 7420 696e 2061 2052  apping it in a R
+0001e240: 756e 6e61 626c 6547 656e 6572 6174 6f72  unnableGenerator
+0001e250: 2061 6c6c 6f77 730a 2020 2020 6974 2074   allows.    it t
+0001e260: 6f20 656d 6974 206f 7574 7075 7420 6368  o emit output ch
+0001e270: 756e 6b73 2061 7320 736f 6f6e 2061 7320  unks as soon as 
+0001e280: 7468 6579 2061 7265 2073 7472 6561 6d65  they are streame
+0001e290: 6420 696e 2066 726f 6d20 7468 6520 7072  d in from the pr
+0001e2a0: 6576 696f 7573 2073 7465 702e 0a0a 2020  evious step...  
+0001e2b0: 2020 4e6f 7465 2074 6861 7420 6966 2061    Note that if a
+0001e2c0: 2067 656e 6572 6174 6f72 2066 756e 6374   generator funct
+0001e2d0: 696f 6e20 6861 7320 6120 7369 676e 6174  ion has a signat
+0001e2e0: 7572 6520 4120 2d3e 2049 7465 7261 746f  ure A -> Iterato
+0001e2f0: 725b 425d 2c20 7375 6368 2074 6861 7420  r[B], such that 
+0001e300: 6974 0a20 2020 2072 6571 7569 7265 7320  it.    requires 
+0001e310: 6974 7320 696e 7075 7420 6672 6f6d 2074  its input from t
+0001e320: 6865 2070 7265 7669 6f75 7320 7374 6570  he previous step
+0001e330: 2074 6f20 6265 2063 6f6d 706c 6574 6564   to be completed
+0001e340: 2062 6566 6f72 6520 656d 6974 7469 6e67   before emitting
+0001e350: 2063 6875 6e6b 730a 2020 2020 2865 2e67   chunks.    (e.g
+0001e360: 2e2c 206d 6f73 7420 4c4c 4d73 206e 6565  ., most LLMs nee
+0001e370: 6420 7468 6520 656e 7469 7265 2070 726f  d the entire pro
+0001e380: 6d70 7420 6176 6169 6c61 626c 6520 746f  mpt available to
+0001e390: 2073 7461 7274 2067 656e 6572 6174 696e   start generatin
+0001e3a0: 6729 2c20 6974 2063 616e 0a20 2020 2069  g), it can.    i
+0001e3b0: 6e73 7465 6164 2062 6520 7772 6170 7065  nstead be wrappe
+0001e3c0: 6420 696e 2061 2052 756e 6e61 626c 654c  d in a RunnableL
+0001e3d0: 616d 6264 612e 0a0a 2020 2020 4865 7265  ambda...    Here
+0001e3e0: 2069 7320 616e 2065 7861 6d70 6c65 2074   is an example t
+0001e3f0: 6f20 7368 6f77 2074 6865 2062 6173 6963  o show the basic
+0001e400: 206d 6563 6861 6e69 6373 206f 6620 6120   mechanics of a 
+0001e410: 5275 6e6e 6162 6c65 4765 6e65 7261 746f  RunnableGenerato
+0001e420: 723a 0a0a 2020 2020 2020 2020 2e2e 2063  r:..        .. c
+0001e430: 6f64 652d 626c 6f63 6b3a 3a20 7079 7468  ode-block:: pyth
+0001e440: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+0001e450: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
+0001e460: 7274 2041 6e79 2c20 4173 796e 6349 7465  rt Any, AsyncIte
+0001e470: 7261 746f 722c 2049 7465 7261 746f 720a  rator, Iterator.
+0001e480: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+0001e490: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+0001e4a0: 2e72 756e 6e61 626c 6573 2069 6d70 6f72  .runnables impor
+0001e4b0: 7420 5275 6e6e 6162 6c65 4765 6e65 7261  t RunnableGenera
+0001e4c0: 746f 720a 0a0a 2020 2020 2020 2020 2020  tor...          
+0001e4d0: 2020 6465 6620 6765 6e28 696e 7075 743a    def gen(input:
+0001e4e0: 2049 7465 7261 746f 725b 416e 795d 2920   Iterator[Any]) 
+0001e4f0: 2d3e 2049 7465 7261 746f 725b 7374 725d  -> Iterator[str]
+0001e500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e510: 2020 666f 7220 746f 6b65 6e20 696e 205b    for token in [
+0001e520: 2248 6176 6522 2c20 2220 6122 2c20 2220  "Have", " a", " 
+0001e530: 6e69 6365 222c 2022 2064 6179 225d 3a0a  nice", " day"]:.
+0001e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e550: 2020 2020 7969 656c 6420 746f 6b65 6e0a      yield token.
+0001e560: 0a0a 2020 2020 2020 2020 2020 2020 7275  ..            ru
+0001e570: 6e6e 6162 6c65 203d 2052 756e 6e61 626c  nnable = Runnabl
+0001e580: 6547 656e 6572 6174 6f72 2867 656e 290a  eGenerator(gen).
+0001e590: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+0001e5a0: 6162 6c65 2e69 6e76 6f6b 6528 4e6f 6e65  able.invoke(None
+0001e5b0: 2920 2023 2022 4861 7665 2061 206e 6963  )  # "Have a nic
+0001e5c0: 6520 6461 7922 0a20 2020 2020 2020 2020  e day".         
+0001e5d0: 2020 206c 6973 7428 7275 6e6e 6162 6c65     list(runnable
+0001e5e0: 2e73 7472 6561 6d28 4e6f 6e65 2929 2020  .stream(None))  
+0001e5f0: 2320 5b22 4861 7665 222c 2022 2061 222c  # ["Have", " a",
+0001e600: 2022 206e 6963 6522 2c20 2220 6461 7922   " nice", " day"
+0001e610: 5d0a 2020 2020 2020 2020 2020 2020 7275  ].            ru
+0001e620: 6e6e 6162 6c65 2e62 6174 6368 285b 4e6f  nnable.batch([No
+0001e630: 6e65 2c20 4e6f 6e65 5d29 2020 2320 5b22  ne, None])  # ["
+0001e640: 4861 7665 2061 206e 6963 6520 6461 7922  Have a nice day"
+0001e650: 2c20 2248 6176 6520 6120 6e69 6365 2064  , "Have a nice d
+0001e660: 6179 225d 0a0a 0a20 2020 2020 2020 2020  ay"]...         
+0001e670: 2020 2023 2041 7379 6e63 2076 6572 7369     # Async versi
+0001e680: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+0001e690: 6173 796e 6320 6465 6620 6167 656e 2869  async def agen(i
+0001e6a0: 6e70 7574 3a20 4173 796e 6349 7465 7261  nput: AsyncItera
+0001e6b0: 746f 725b 416e 795d 2920 2d3e 2041 7379  tor[Any]) -> Asy
+0001e6c0: 6e63 4974 6572 6174 6f72 5b73 7472 5d3a  ncIterator[str]:
+0001e6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e6e0: 2066 6f72 2074 6f6b 656e 2069 6e20 5b22   for token in ["
+0001e6f0: 4861 7665 222c 2022 2061 222c 2022 206e  Have", " a", " n
+0001e700: 6963 6522 2c20 2220 6461 7922 5d3a 0a20  ice", " day"]:. 
+0001e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e720: 2020 2079 6965 6c64 2074 6f6b 656e 0a0a     yield token..
+0001e730: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+0001e740: 6162 6c65 203d 2052 756e 6e61 626c 6547  able = RunnableG
+0001e750: 656e 6572 6174 6f72 2861 6765 6e29 0a20  enerator(agen). 
+0001e760: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001e770: 2072 756e 6e61 626c 652e 6169 6e76 6f6b   runnable.ainvok
+0001e780: 6528 4e6f 6e65 2920 2023 2022 4861 7665  e(None)  # "Have
+0001e790: 2061 206e 6963 6520 6461 7922 0a20 2020   a nice day".   
+0001e7a0: 2020 2020 2020 2020 205b 7020 6173 796e           [p asyn
+0001e7b0: 6320 666f 7220 7020 696e 2072 756e 6e61  c for p in runna
+0001e7c0: 626c 652e 6173 7472 6561 6d28 4e6f 6e65  ble.astream(None
+0001e7d0: 295d 2023 205b 2248 6176 6522 2c20 2220  )] # ["Have", " 
+0001e7e0: 6122 2c20 2220 6e69 6365 222c 2022 2064  a", " nice", " d
+0001e7f0: 6179 225d 0a0a 2020 2020 5275 6e6e 6162  ay"]..    Runnab
+0001e800: 6c65 4765 6e65 7261 746f 7220 6d61 6b65  leGenerator make
+0001e810: 7320 6974 2065 6173 7920 746f 2069 6d70  s it easy to imp
+0001e820: 6c65 6d65 6e74 2063 7573 746f 6d20 6265  lement custom be
+0001e830: 6861 7669 6f72 2077 6974 6869 6e20 6120  havior within a 
+0001e840: 7374 7265 616d 696e 670a 2020 2020 636f  streaming.    co
+0001e850: 6e74 6578 742e 2042 656c 6f77 2077 6520  ntext. Below we 
+0001e860: 7368 6f77 2061 6e20 6578 616d 706c 653a  show an example:
+0001e870: 0a20 2020 2020 2020 202e 2e20 636f 6465  .        .. code
+0001e880: 2d62 6c6f 636b 3a3a 2070 7974 686f 6e0a  -block:: python.
+0001e890: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+0001e8a0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+0001e8b0: 2e70 726f 6d70 7473 2069 6d70 6f72 7420  .prompts import 
+0001e8c0: 4368 6174 5072 6f6d 7074 5465 6d70 6c61  ChatPromptTempla
+0001e8d0: 7465 0a20 2020 2020 2020 2020 2020 2066  te.            f
+0001e8e0: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+0001e8f0: 7265 2e72 756e 6e61 626c 6573 2069 6d70  re.runnables imp
+0001e900: 6f72 7420 5275 6e6e 6162 6c65 4765 6e65  ort RunnableGene
+0001e910: 7261 746f 722c 2052 756e 6e61 626c 654c  rator, RunnableL
+0001e920: 616d 6264 610a 2020 2020 2020 2020 2020  ambda.          
+0001e930: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+0001e940: 5f6f 7065 6e61 6920 696d 706f 7274 2043  _openai import C
+0001e950: 6861 744f 7065 6e41 490a 2020 2020 2020  hatOpenAI.      
+0001e960: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+0001e970: 6861 696e 5f63 6f72 652e 6f75 7470 7574  hain_core.output
+0001e980: 5f70 6172 7365 7273 2069 6d70 6f72 7420  _parsers import 
+0001e990: 5374 724f 7574 7075 7450 6172 7365 720a  StrOutputParser.
+0001e9a0: 0a0a 2020 2020 2020 2020 2020 2020 6d6f  ..            mo
+0001e9b0: 6465 6c20 3d20 4368 6174 4f70 656e 4149  del = ChatOpenAI
+0001e9c0: 2829 0a20 2020 2020 2020 2020 2020 2063  ().            c
+0001e9d0: 6861 6e74 5f63 6861 696e 203d 2028 0a20  hant_chain = (. 
+0001e9e0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+0001e9f0: 6861 7450 726f 6d70 7454 656d 706c 6174  hatPromptTemplat
+0001ea00: 652e 6672 6f6d 5f74 656d 706c 6174 6528  e.from_template(
+0001ea10: 2247 6976 6520 6d65 2061 2033 2077 6f72  "Give me a 3 wor
+0001ea20: 6420 6368 616e 7420 6162 6f75 7420 7b74  d chant about {t
+0001ea30: 6f70 6963 7d22 290a 2020 2020 2020 2020  opic}").        
+0001ea40: 2020 2020 2020 2020 7c20 6d6f 6465 6c0a          | model.
+0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea60: 7c20 5374 724f 7574 7075 7450 6172 7365  | StrOutputParse
+0001ea70: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+0001ea80: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+0001ea90: 6566 2063 6861 7261 6374 6572 5f67 656e  ef character_gen
+0001eaa0: 6572 6174 6f72 2869 6e70 7574 3a20 4974  erator(input: It
+0001eab0: 6572 6174 6f72 5b73 7472 5d29 202d 3e20  erator[str]) -> 
+0001eac0: 4974 6572 6174 6f72 5b73 7472 5d3a 0a20  Iterator[str]:. 
+0001ead0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001eae0: 6f72 2074 6f6b 656e 2069 6e20 696e 7075  or token in inpu
+0001eaf0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0001eb00: 2020 2020 2020 2069 6620 222c 2220 696e         if "," in
+0001eb10: 2074 6f6b 656e 206f 7220 222e 2220 696e   token or "." in
+0001eb20: 2074 6f6b 656e 3a0a 2020 2020 2020 2020   token:.        
+0001eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb40: 7969 656c 6420 22f0 9f91 8f22 202b 2074  yield "...." + t
+0001eb50: 6f6b 656e 0a20 2020 2020 2020 2020 2020  oken.           
+0001eb60: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb80: 2020 2020 2020 2079 6965 6c64 2074 6f6b         yield tok
+0001eb90: 656e 0a0a 0a20 2020 2020 2020 2020 2020  en...           
+0001eba0: 2072 756e 6e61 626c 6520 3d20 6368 616e   runnable = chan
+0001ebb0: 745f 6368 6169 6e20 7c20 6368 6172 6163  t_chain | charac
+0001ebc0: 7465 725f 6765 6e65 7261 746f 720a 2020  ter_generator.  
+0001ebd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001ebe0: 2074 7970 6528 7275 6e6e 6162 6c65 2e6c   type(runnable.l
+0001ebf0: 6173 7429 2069 7320 5275 6e6e 6162 6c65  ast) is Runnable
+0001ec00: 4765 6e65 7261 746f 720a 2020 2020 2020  Generator.      
+0001ec10: 2020 2020 2020 2222 2e6a 6f69 6e28 7275        "".join(ru
+0001ec20: 6e6e 6162 6c65 2e73 7472 6561 6d28 7b22  nnable.stream({"
+0001ec30: 746f 7069 6322 3a20 2277 6173 7465 227d  topic": "waste"}
+0001ec40: 2929 2023 2052 6564 7563 65f0 9f91 8f2c  )) # Reduce....,
+0001ec50: 2052 6575 7365 f09f 918f 2c20 5265 6379   Reuse...., Recy
+0001ec60: 636c 65f0 9f91 8f2e 0a0a 2020 2020 2020  cle.......      
+0001ec70: 2020 2020 2020 2320 4e6f 7465 2074 6861        # Note tha
+0001ec80: 7420 5275 6e6e 6162 6c65 4c61 6d62 6461  t RunnableLambda
+0001ec90: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
+0001eca0: 6465 6c61 7920 7374 7265 616d 696e 6720  delay streaming 
+0001ecb0: 6f66 206f 6e65 2073 7465 7020 696e 2061  of one step in a
+0001ecc0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+0001ecd0: 6571 7565 6e63 6520 756e 7469 6c20 7468  equence until th
+0001ece0: 6520 7072 6576 696f 7573 2073 7465 7020  e previous step 
+0001ecf0: 6973 2066 696e 6973 6865 643a 0a20 2020  is finished:.   
+0001ed00: 2020 2020 2020 2020 2064 6566 2072 6576           def rev
+0001ed10: 6572 7365 5f67 656e 6572 6174 6f72 2869  erse_generator(i
+0001ed20: 6e70 7574 3a20 7374 7229 202d 3e20 4974  nput: str) -> It
+0001ed30: 6572 6174 6f72 5b73 7472 5d3a 0a20 2020  erator[str]:.   
+0001ed40: 2020 2020 2020 2020 2020 2020 2023 2059               # Y
+0001ed50: 6965 6c64 2063 6861 7261 6374 6572 7320  ield characters 
+0001ed60: 6f66 2069 6e70 7574 2069 6e20 7265 7665  of input in reve
+0001ed70: 7273 6520 6f72 6465 722e 0a20 2020 2020  rse order..     
+0001ed80: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+0001ed90: 6861 7261 6374 6572 2069 6e20 696e 7075  haracter in inpu
+0001eda0: 745b 3a3a 2d31 5d3a 0a20 2020 2020 2020  t[::-1]:.       
+0001edb0: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+0001edc0: 6c64 2063 6861 7261 6374 6572 0a0a 2020  ld character..  
+0001edd0: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
+0001ede0: 6c65 203d 2063 6861 6e74 5f63 6861 696e  le = chant_chain
+0001edf0: 207c 2052 756e 6e61 626c 654c 616d 6264   | RunnableLambd
+0001ee00: 6128 7265 7665 7273 655f 6765 6e65 7261  a(reverse_genera
+0001ee10: 746f 7229 0a20 2020 2020 2020 2020 2020  tor).           
+0001ee20: 2022 222e 6a6f 696e 2872 756e 6e61 626c   "".join(runnabl
+0001ee30: 652e 7374 7265 616d 287b 2274 6f70 6963  e.stream({"topic
+0001ee40: 223a 2022 7761 7374 6522 7d29 2920 2023  ": "waste"}))  #
+0001ee50: 2022 2e65 6c63 7963 6572 202c 6573 7565   ".elcycer ,esue
+0001ee60: 7220 2c65 6375 6465 5222 0a20 2020 2022  r ,ecudeR".    "
+0001ee70: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+0001ee80: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
+0001ee90: 6c66 2c0a 2020 2020 2020 2020 7472 616e  lf,.        tran
+0001eea0: 7366 6f72 6d3a 2055 6e69 6f6e 5b0a 2020  sform: Union[.  
+0001eeb0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
+0001eec0: 6c65 5b5b 4974 6572 6174 6f72 5b49 6e70  le[[Iterator[Inp
+0001eed0: 7574 5d5d 2c20 4974 6572 6174 6f72 5b4f  ut]], Iterator[O
+0001eee0: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
+0001eef0: 2020 2020 2043 616c 6c61 626c 655b 5b41       Callable[[A
+0001ef00: 7379 6e63 4974 6572 6174 6f72 5b49 6e70  syncIterator[Inp
+0001ef10: 7574 5d5d 2c20 4173 796e 6349 7465 7261  ut]], AsyncItera
+0001ef20: 746f 725b 4f75 7470 7574 5d5d 2c0a 2020  tor[Output]],.  
+0001ef30: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0001ef40: 2061 7472 616e 7366 6f72 6d3a 204f 7074   atransform: Opt
+0001ef50: 696f 6e61 6c5b 0a20 2020 2020 2020 2020  ional[.         
+0001ef60: 2020 2043 616c 6c61 626c 655b 5b41 7379     Callable[[Asy
+0001ef70: 6e63 4974 6572 6174 6f72 5b49 6e70 7574  ncIterator[Input
+0001ef80: 5d5d 2c20 4173 796e 6349 7465 7261 746f  ]], AsyncIterato
+0001ef90: 725b 4f75 7470 7574 5d5d 0a20 2020 2020  r[Output]].     
+0001efa0: 2020 205d 203d 204e 6f6e 652c 0a20 2020     ] = None,.   
+0001efb0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0001efc0: 2020 2020 6966 2061 7472 616e 7366 6f72      if atransfor
+0001efd0: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
+0001efe0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001eff0: 5f61 7472 616e 7366 6f72 6d20 3d20 6174  _atransform = at
+0001f000: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
+0001f010: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
+0001f020: 6d65 3a20 4361 6c6c 6162 6c65 203d 2061  me: Callable = a
+0001f030: 7472 616e 7366 6f72 6d0a 0a20 2020 2020  transform..     
+0001f040: 2020 2069 6620 6973 5f61 7379 6e63 5f67     if is_async_g
+0001f050: 656e 6572 6174 6f72 2874 7261 6e73 666f  enerator(transfo
+0001f060: 726d 293a 0a20 2020 2020 2020 2020 2020  rm):.           
+0001f070: 2073 656c 662e 5f61 7472 616e 7366 6f72   self._atransfor
+0001f080: 6d20 3d20 7472 616e 7366 6f72 6d20 2023  m = transform  #
+0001f090: 2074 7970 653a 2069 676e 6f72 655b 6173   type: ignore[as
+0001f0a0: 7369 676e 6d65 6e74 5d0a 2020 2020 2020  signment].      
+0001f0b0: 2020 2020 2020 6675 6e63 5f66 6f72 5f6e        func_for_n
+0001f0c0: 616d 6520 3d20 7472 616e 7366 6f72 6d0a  ame = transform.
+0001f0d0: 2020 2020 2020 2020 656c 6966 2069 6e73          elif ins
+0001f0e0: 7065 6374 2e69 7367 656e 6572 6174 6f72  pect.isgenerator
+0001f0f0: 6675 6e63 7469 6f6e 2874 7261 6e73 666f  function(transfo
+0001f100: 726d 293a 0a20 2020 2020 2020 2020 2020  rm):.           
+0001f110: 2073 656c 662e 5f74 7261 6e73 666f 726d   self._transform
+0001f120: 203d 2074 7261 6e73 666f 726d 0a20 2020   = transform.   
+0001f130: 2020 2020 2020 2020 2066 756e 635f 666f           func_fo
+0001f140: 725f 6e61 6d65 203d 2074 7261 6e73 666f  r_name = transfo
+0001f150: 726d 0a20 2020 2020 2020 2065 6c73 653a  rm.        else:
+0001f160: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001f170: 7365 2054 7970 6545 7272 6f72 280a 2020  se TypeError(.  
+0001f180: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+0001f190: 7870 6563 7465 6420 6120 6765 6e65 7261  xpected a genera
+0001f1a0: 746f 7220 6675 6e63 7469 6f6e 2074 7970  tor function typ
+0001f1b0: 6520 666f 7220 6074 7261 6e73 666f 726d  e for `transform
+0001f1c0: 602e 220a 2020 2020 2020 2020 2020 2020  `.".            
+0001f1d0: 2020 2020 6622 496e 7374 6561 6420 676f      f"Instead go
+0001f1e0: 7420 616e 2075 6e73 7570 706f 7274 6564  t an unsupported
+0001f1f0: 2074 7970 653a 207b 7479 7065 2874 7261   type: {type(tra
+0001f200: 6e73 666f 726d 297d 220a 2020 2020 2020  nsform)}".      
+0001f210: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001f220: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001f230: 2020 7365 6c66 2e6e 616d 6520 3d20 6675    self.name = fu
+0001f240: 6e63 5f66 6f72 5f6e 616d 652e 5f5f 6e61  nc_for_name.__na
+0001f250: 6d65 5f5f 0a20 2020 2020 2020 2065 7863  me__.        exc
+0001f260: 6570 7420 4174 7472 6962 7574 6545 7272  ept AttributeErr
+0001f270: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0001f280: 7061 7373 0a0a 2020 2020 4070 726f 7065  pass..    @prope
+0001f290: 7274 790a 2020 2020 6465 6620 496e 7075  rty.    def Inpu
+0001f2a0: 7454 7970 6528 7365 6c66 2920 2d3e 2041  tType(self) -> A
+0001f2b0: 6e79 3a0a 2020 2020 2020 2020 6675 6e63  ny:.        func
+0001f2c0: 203d 2067 6574 6174 7472 2873 656c 662c   = getattr(self,
+0001f2d0: 2022 5f74 7261 6e73 666f 726d 222c 204e   "_transform", N
+0001f2e0: 6f6e 6529 206f 7220 6765 7461 7474 7228  one) or getattr(
+0001f2f0: 7365 6c66 2c20 225f 6174 7261 6e73 666f  self, "_atransfo
+0001f300: 726d 2229 0a20 2020 2020 2020 2074 7279  rm").        try
+0001f310: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+0001f320: 7261 6d73 203d 2069 6e73 7065 6374 2e73  rams = inspect.s
+0001f330: 6967 6e61 7475 7265 2866 756e 6329 2e70  ignature(func).p
+0001f340: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+0001f350: 2020 2020 2020 6669 7273 745f 7061 7261        first_para
+0001f360: 6d20 3d20 6e65 7874 2869 7465 7228 7061  m = next(iter(pa
+0001f370: 7261 6d73 2e76 616c 7565 7328 2929 2c20  rams.values()), 
+0001f380: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+0001f390: 2020 6966 2066 6972 7374 5f70 6172 616d    if first_param
+0001f3a0: 2061 6e64 2066 6972 7374 5f70 6172 616d   and first_param
+0001f3b0: 2e61 6e6e 6f74 6174 696f 6e20 213d 2069  .annotation != i
+0001f3c0: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
+0001f3d0: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+0001f3e0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+0001f3f0: 6574 6174 7472 2866 6972 7374 5f70 6172  etattr(first_par
+0001f400: 616d 2e61 6e6e 6f74 6174 696f 6e2c 2022  am.annotation, "
+0001f410: 5f5f 6172 6773 5f5f 222c 2028 416e 792c  __args__", (Any,
+0001f420: 2929 5b30 5d0a 2020 2020 2020 2020 2020  ))[0].          
+0001f430: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001f440: 2020 2020 2020 2020 7265 7475 726e 2041          return A
+0001f450: 6e79 0a20 2020 2020 2020 2065 7863 6570  ny.        excep
+0001f460: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+0001f470: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001f480: 2041 6e79 0a0a 2020 2020 4070 726f 7065   Any..    @prope
+0001f490: 7274 790a 2020 2020 6465 6620 4f75 7470  rty.    def Outp
+0001f4a0: 7574 5479 7065 2873 656c 6629 202d 3e20  utType(self) -> 
+0001f4b0: 416e 793a 0a20 2020 2020 2020 2066 756e  Any:.        fun
+0001f4c0: 6320 3d20 6765 7461 7474 7228 7365 6c66  c = getattr(self
+0001f4d0: 2c20 225f 7472 616e 7366 6f72 6d22 2c20  , "_transform", 
+0001f4e0: 4e6f 6e65 2920 6f72 2067 6574 6174 7472  None) or getattr
+0001f4f0: 2873 656c 662c 2022 5f61 7472 616e 7366  (self, "_atransf
+0001f500: 6f72 6d22 290a 2020 2020 2020 2020 7472  orm").        tr
+0001f510: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+0001f520: 6967 203d 2069 6e73 7065 6374 2e73 6967  ig = inspect.sig
+0001f530: 6e61 7475 7265 2866 756e 6329 0a20 2020  nature(func).   
+0001f540: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001f550: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001f560: 2020 6765 7461 7474 7228 7369 672e 7265    getattr(sig.re
+0001f570: 7475 726e 5f61 6e6e 6f74 6174 696f 6e2c  turn_annotation,
+0001f580: 2022 5f5f 6172 6773 5f5f 222c 2028 416e   "__args__", (An
+0001f590: 792c 2929 5b30 5d0a 2020 2020 2020 2020  y,))[0].        
+0001f5a0: 2020 2020 2020 2020 6966 2073 6967 2e72          if sig.r
+0001f5b0: 6574 7572 6e5f 616e 6e6f 7461 7469 6f6e  eturn_annotation
+0001f5c0: 2021 3d20 696e 7370 6563 742e 5369 676e   != inspect.Sign
+0001f5d0: 6174 7572 652e 656d 7074 790a 2020 2020  ature.empty.    
+0001f5e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001f5f0: 2041 6e79 0a20 2020 2020 2020 2020 2020   Any.           
+0001f600: 2029 0a20 2020 2020 2020 2065 7863 6570   ).        excep
+0001f610: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+0001f620: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001f630: 2041 6e79 0a0a 2020 2020 6465 6620 5f5f   Any..    def __
+0001f640: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
+0001f650: 3a20 416e 7929 202d 3e20 626f 6f6c 3a0a  : Any) -> bool:.
+0001f660: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001f670: 7461 6e63 6528 6f74 6865 722c 2052 756e  tance(other, Run
+0001f680: 6e61 626c 6547 656e 6572 6174 6f72 293a  nableGenerator):
+0001f690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001f6a0: 6861 7361 7474 7228 7365 6c66 2c20 225f  hasattr(self, "_
+0001f6b0: 7472 616e 7366 6f72 6d22 2920 616e 6420  transform") and 
+0001f6c0: 6861 7361 7474 7228 6f74 6865 722c 2022  hasattr(other, "
+0001f6d0: 5f74 7261 6e73 666f 726d 2229 3a0a 2020  _transform"):.  
+0001f6e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001f6f0: 7475 726e 2073 656c 662e 5f74 7261 6e73  turn self._trans
+0001f700: 666f 726d 203d 3d20 6f74 6865 722e 5f74  form == other._t
+0001f710: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
+0001f720: 2020 2020 2065 6c69 6620 6861 7361 7474       elif hasatt
+0001f730: 7228 7365 6c66 2c20 225f 6174 7261 6e73  r(self, "_atrans
+0001f740: 666f 726d 2229 2061 6e64 2068 6173 6174  form") and hasat
+0001f750: 7472 286f 7468 6572 2c20 225f 6174 7261  tr(other, "_atra
+0001f760: 6e73 666f 726d 2229 3a0a 2020 2020 2020  nsform"):.      
+0001f770: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001f780: 2073 656c 662e 5f61 7472 616e 7366 6f72   self._atransfor
+0001f790: 6d20 3d3d 206f 7468 6572 2e5f 6174 7261  m == other._atra
+0001f7a0: 6e73 666f 726d 0a20 2020 2020 2020 2020  nsform.         
+0001f7b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001f7c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001f7d0: 4661 6c73 650a 2020 2020 2020 2020 656c  False.        el
+0001f7e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001f7f0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+0001f800: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+0001f810: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+0001f820: 2020 2020 2072 6574 7572 6e20 6622 5275       return f"Ru
+0001f830: 6e6e 6162 6c65 4765 6e65 7261 746f 7228  nnableGenerator(
+0001f840: 7b73 656c 662e 6e61 6d65 7d29 220a 0a20  {self.name})".. 
+0001f850: 2020 2064 6566 2074 7261 6e73 666f 726d     def transform
+0001f860: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0001f870: 2020 2020 2020 2020 696e 7075 743a 2049          input: I
+0001f880: 7465 7261 746f 725b 496e 7075 745d 2c0a  terator[Input],.
+0001f890: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+0001f8a0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+0001f8b0: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
+0001f8c0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0001f8d0: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+0001f8e0: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
+0001f8f0: 5d3a 0a20 2020 2020 2020 2069 6620 6e6f  ]:.        if no
+0001f900: 7420 6861 7361 7474 7228 7365 6c66 2c20  t hasattr(self, 
+0001f910: 225f 7472 616e 7366 6f72 6d22 293a 0a20  "_transform"):. 
+0001f920: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001f930: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+0001f940: 7272 6f72 2866 227b 7265 7072 2873 656c  rror(f"{repr(sel
+0001f950: 6629 7d20 6f6e 6c79 2073 7570 706f 7274  f)} only support
+0001f960: 7320 6173 796e 6320 6d65 7468 6f64 732e  s async methods.
+0001f970: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
+0001f980: 6e20 7365 6c66 2e5f 7472 616e 7366 6f72  n self._transfor
+0001f990: 6d5f 7374 7265 616d 5f77 6974 685f 636f  m_stream_with_co
+0001f9a0: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
+0001f9b0: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
+0001f9c0: 2020 2020 2073 656c 662e 5f74 7261 6e73       self._trans
+0001f9d0: 666f 726d 2c20 2023 2074 7970 653a 2069  form,  # type: i
+0001f9e0: 676e 6f72 655b 6172 672d 7479 7065 5d0a  gnore[arg-type].
+0001f9f0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+0001fa00: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
+0001fa10: 2a2a 6b77 6172 6773 2c20 2023 2074 7970  **kwargs,  # typ
+0001fa20: 653a 2069 676e 6f72 655b 6172 672d 7479  e: ignore[arg-ty
+0001fa30: 7065 5d0a 2020 2020 2020 2020 290a 0a20  pe].        ).. 
+0001fa40: 2020 2064 6566 2073 7472 6561 6d28 0a20     def stream(. 
+0001fa50: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001fa60: 2020 2020 2069 6e70 7574 3a20 496e 7075       input: Inpu
+0001fa70: 742c 0a20 2020 2020 2020 2063 6f6e 6669  t,.        confi
+0001fa80: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+0001fa90: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+0001faa0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+0001fab0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
+0001fac0: 202d 3e20 4974 6572 6174 6f72 5b4f 7574   -> Iterator[Out
+0001fad0: 7075 745d 3a0a 2020 2020 2020 2020 7265  put]:.        re
+0001fae0: 7475 726e 2073 656c 662e 7472 616e 7366  turn self.transf
+0001faf0: 6f72 6d28 6974 6572 285b 696e 7075 745d  orm(iter([input]
+0001fb00: 292c 2063 6f6e 6669 672c 202a 2a6b 7761  ), config, **kwa
+0001fb10: 7267 7329 0a0a 2020 2020 6465 6620 696e  rgs)..    def in
+0001fb20: 766f 6b65 280a 2020 2020 2020 2020 7365  voke(.        se
+0001fb30: 6c66 2c20 696e 7075 743a 2049 6e70 7574  lf, input: Input
+0001fb40: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
+0001fb50: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+0001fb60: 675d 203d 204e 6f6e 652c 202a 2a6b 7761  g] = None, **kwa
+0001fb70: 7267 733a 2041 6e79 0a20 2020 2029 202d  rgs: Any.    ) -
+0001fb80: 3e20 4f75 7470 7574 3a0a 2020 2020 2020  > Output:.      
+0001fb90: 2020 6669 6e61 6c20 3d20 4e6f 6e65 0a20    final = None. 
+0001fba0: 2020 2020 2020 2066 6f72 206f 7574 7075         for outpu
+0001fbb0: 7420 696e 2073 656c 662e 7374 7265 616d  t in self.stream
+0001fbc0: 2869 6e70 7574 2c20 636f 6e66 6967 2c20  (input, config, 
+0001fbd0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+0001fbe0: 2020 2020 2020 2069 6620 6669 6e61 6c20         if final 
+0001fbf0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001fc00: 2020 2020 2020 2020 2066 696e 616c 203d           final =
+0001fc10: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0001fc20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001fc30: 2020 2020 2020 2020 2020 6669 6e61 6c20            final 
+0001fc40: 3d20 6669 6e61 6c20 2b20 6f75 7470 7574  = final + output
+0001fc50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001fc60: 6361 7374 284f 7574 7075 742c 2066 696e  cast(Output, fin
+0001fc70: 616c 290a 0a20 2020 2064 6566 2061 7472  al)..    def atr
+0001fc80: 616e 7366 6f72 6d28 0a20 2020 2020 2020  ansform(.       
+0001fc90: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+0001fca0: 6e70 7574 3a20 4173 796e 6349 7465 7261  nput: AsyncItera
+0001fcb0: 746f 725b 496e 7075 745d 2c0a 2020 2020  tor[Input],.    
+0001fcc0: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+0001fcd0: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+0001fce0: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+0001fcf0: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+0001fd00: 6e79 2c0a 2020 2020 2920 2d3e 2041 7379  ny,.    ) -> Asy
+0001fd10: 6e63 4974 6572 6174 6f72 5b4f 7574 7075  ncIterator[Outpu
+0001fd20: 745d 3a0a 2020 2020 2020 2020 6966 206e  t]:.        if n
+0001fd30: 6f74 2068 6173 6174 7472 2873 656c 662c  ot hasattr(self,
+0001fd40: 2022 5f61 7472 616e 7366 6f72 6d22 293a   "_atransform"):
+0001fd50: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001fd60: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+0001fd70: 6445 7272 6f72 2866 227b 7265 7072 2873  dError(f"{repr(s
+0001fd80: 656c 6629 7d20 6f6e 6c79 2073 7570 706f  elf)} only suppo
+0001fd90: 7274 7320 7379 6e63 206d 6574 686f 6473  rts sync methods
+0001fda0: 2e22 290a 0a20 2020 2020 2020 2072 6574  .")..        ret
+0001fdb0: 7572 6e20 7365 6c66 2e5f 6174 7261 6e73  urn self._atrans
+0001fdc0: 666f 726d 5f73 7472 6561 6d5f 7769 7468  form_stream_with
+0001fdd0: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+0001fde0: 2020 2020 2069 6e70 7574 2c20 7365 6c66       input, self
+0001fdf0: 2e5f 6174 7261 6e73 666f 726d 2c20 636f  ._atransform, co
+0001fe00: 6e66 6967 2c20 2a2a 6b77 6172 6773 0a20  nfig, **kwargs. 
+0001fe10: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0001fe20: 6620 6173 7472 6561 6d28 0a20 2020 2020  f astream(.     
+0001fe30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0001fe40: 2069 6e70 7574 3a20 496e 7075 742c 0a20   input: Input,. 
+0001fe50: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
+0001fe60: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+0001fe70: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
+0001fe80: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0001fe90: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+0001fea0: 4173 796e 6349 7465 7261 746f 725b 4f75  AsyncIterator[Ou
+0001feb0: 7470 7574 5d3a 0a20 2020 2020 2020 2061  tput]:.        a
+0001fec0: 7379 6e63 2064 6566 2069 6e70 7574 5f61  sync def input_a
+0001fed0: 6974 6572 2829 202d 3e20 4173 796e 6349  iter() -> AsyncI
+0001fee0: 7465 7261 746f 725b 496e 7075 745d 3a0a  terator[Input]:.
+0001fef0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0001ff00: 6420 696e 7075 740a 0a20 2020 2020 2020  d input..       
+0001ff10: 2072 6574 7572 6e20 7365 6c66 2e61 7472   return self.atr
+0001ff20: 616e 7366 6f72 6d28 696e 7075 745f 6169  ansform(input_ai
+0001ff30: 7465 7228 292c 2063 6f6e 6669 672c 202a  ter(), config, *
+0001ff40: 2a6b 7761 7267 7329 0a0a 2020 2020 6173  *kwargs)..    as
+0001ff50: 796e 6320 6465 6620 6169 6e76 6f6b 6528  ync def ainvoke(
+0001ff60: 0a20 2020 2020 2020 2073 656c 662c 2069  .        self, i
+0001ff70: 6e70 7574 3a20 496e 7075 742c 2063 6f6e  nput: Input, con
+0001ff80: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
+0001ff90: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
+0001ffa0: 4e6f 6e65 2c20 2a2a 6b77 6172 6773 3a20  None, **kwargs: 
+0001ffb0: 416e 790a 2020 2020 2920 2d3e 204f 7574  Any.    ) -> Out
+0001ffc0: 7075 743a 0a20 2020 2020 2020 2066 696e  put:.        fin
+0001ffd0: 616c 203d 204e 6f6e 650a 2020 2020 2020  al = None.      
+0001ffe0: 2020 6173 796e 6320 666f 7220 6f75 7470    async for outp
+0001fff0: 7574 2069 6e20 7365 6c66 2e61 7374 7265  ut in self.astre
+00020000: 616d 2869 6e70 7574 2c20 636f 6e66 6967  am(input, config
+00020010: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00020020: 2020 2020 2020 2020 2069 6620 6669 6e61           if fina
+00020030: 6c20 6973 204e 6f6e 653a 0a20 2020 2020  l is None:.     
+00020040: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00020050: 203d 206f 7574 7075 740a 2020 2020 2020   = output.      
+00020060: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00020070: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+00020080: 6c20 3d20 6669 6e61 6c20 2b20 6f75 7470  l = final + outp
+00020090: 7574 0a20 2020 2020 2020 2072 6574 7572  ut.        retur
+000200a0: 6e20 6361 7374 284f 7574 7075 742c 2066  n cast(Output, f
+000200b0: 696e 616c 290a 0a0a 636c 6173 7320 5275  inal)...class Ru
+000200c0: 6e6e 6162 6c65 4c61 6d62 6461 2852 756e  nnableLambda(Run
+000200d0: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
+000200e0: 7075 745d 293a 0a20 2020 2022 2222 5275  put]):.    """Ru
+000200f0: 6e6e 6162 6c65 4c61 6d62 6461 2063 6f6e  nnableLambda con
+00020100: 7665 7274 7320 6120 7079 7468 6f6e 2063  verts a python c
+00020110: 616c 6c61 626c 6520 696e 746f 2061 2052  allable into a R
+00020120: 756e 6e61 626c 652e 0a0a 2020 2020 5772  unnable...    Wr
+00020130: 6170 7069 6e67 2061 2063 616c 6c61 626c  apping a callabl
+00020140: 6520 696e 2061 2052 756e 6e61 626c 654c  e in a RunnableL
+00020150: 616d 6264 6120 6d61 6b65 7320 7468 6520  ambda makes the 
+00020160: 6361 6c6c 6162 6c65 2075 7361 626c 650a  callable usable.
+00020170: 2020 2020 7769 7468 696e 2065 6974 6865      within eithe
+00020180: 7220 6120 7379 6e63 206f 7220 6173 796e  r a sync or asyn
+00020190: 6320 636f 6e74 6578 742e 0a0a 2020 2020  c context...    
+000201a0: 5275 6e6e 6162 6c65 4c61 6d62 6461 2063  RunnableLambda c
+000201b0: 616e 2062 6520 636f 6d70 6f73 6564 2061  an be composed a
+000201c0: 7320 616e 7920 6f74 6865 7220 5275 6e6e  s any other Runn
+000201d0: 6162 6c65 2061 6e64 2070 726f 7669 6465  able and provide
+000201e0: 730a 2020 2020 7365 616d 6c65 7373 2069  s.    seamless i
+000201f0: 6e74 6567 7261 7469 6f6e 2077 6974 6820  ntegration with 
+00020200: 4c61 6e67 4368 6169 6e20 7472 6163 696e  LangChain tracin
+00020210: 672e 0a0a 2020 2020 4578 616d 706c 6573  g...    Examples
+00020220: 3a0a 0a20 2020 2020 2020 202e 2e20 636f  :..        .. co
+00020230: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
+00020240: 6e0a 0a20 2020 2020 2020 2020 2020 2023  n..            #
+00020250: 2054 6869 7320 6973 2061 2052 756e 6e61   This is a Runna
+00020260: 626c 654c 616d 6264 610a 2020 2020 2020  bleLambda.      
+00020270: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+00020280: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
+00020290: 6c65 7320 696d 706f 7274 2052 756e 6e61  les import Runna
+000202a0: 626c 654c 616d 6264 610a 0a20 2020 2020  bleLambda..     
+000202b0: 2020 2020 2020 2064 6566 2061 6464 5f6f         def add_o
+000202c0: 6e65 2878 3a20 696e 7429 202d 3e20 696e  ne(x: int) -> in
+000202d0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000202e0: 2020 2072 6574 7572 6e20 7820 2b20 310a     return x + 1.
+000202f0: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+00020300: 6e61 626c 6520 3d20 5275 6e6e 6162 6c65  nable = Runnable
+00020310: 4c61 6d62 6461 2861 6464 5f6f 6e65 290a  Lambda(add_one).
+00020320: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+00020330: 6e61 626c 652e 696e 766f 6b65 2831 2920  nable.invoke(1) 
+00020340: 2320 7265 7475 726e 7320 320a 2020 2020  # returns 2.    
+00020350: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+00020360: 2e62 6174 6368 285b 312c 2032 2c20 335d  .batch([1, 2, 3]
+00020370: 2920 2320 7265 7475 726e 7320 5b32 2c20  ) # returns [2, 
+00020380: 332c 2034 5d0a 0a20 2020 2020 2020 2020  3, 4]..         
+00020390: 2020 2023 2041 7379 6e63 2069 7320 7375     # Async is su
+000203a0: 7070 6f72 7465 6420 6279 2064 6566 6175  pported by defau
+000203b0: 6c74 2062 7920 6465 6c65 6761 7469 6e67  lt by delegating
+000203c0: 2074 6f20 7468 6520 7379 6e63 2069 6d70   to the sync imp
+000203d0: 6c65 6d65 6e74 6174 696f 6e0a 2020 2020  lementation.    
+000203e0: 2020 2020 2020 2020 6177 6169 7420 7275          await ru
+000203f0: 6e6e 6162 6c65 2e61 696e 766f 6b65 2831  nnable.ainvoke(1
+00020400: 2920 2320 7265 7475 726e 7320 320a 2020  ) # returns 2.  
+00020410: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00020420: 7275 6e6e 6162 6c65 2e61 6261 7463 6828  runnable.abatch(
+00020430: 5b31 2c20 322c 2033 5d29 2023 2072 6574  [1, 2, 3]) # ret
+00020440: 7572 6e73 205b 322c 2033 2c20 345d 0a0a  urns [2, 3, 4]..
+00020450: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
+00020460: 6c74 6572 6e61 7469 7665 6c79 2c20 6361  lternatively, ca
+00020470: 6e20 7072 6f76 6964 6520 626f 7468 2073  n provide both s
+00020480: 796e 6420 616e 6420 7379 6e63 2069 6d70  ynd and sync imp
+00020490: 6c65 6d65 6e74 6174 696f 6e73 0a20 2020  lementations.   
+000204a0: 2020 2020 2020 2020 2061 7379 6e63 2064           async d
+000204b0: 6566 2061 6464 5f6f 6e65 5f61 7379 6e63  ef add_one_async
+000204c0: 2878 3a20 696e 7429 202d 3e20 696e 743a  (x: int) -> int:
+000204d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000204e0: 2072 6574 7572 6e20 7820 2b20 310a 0a20   return x + 1.. 
+000204f0: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
+00020500: 626c 6520 3d20 5275 6e6e 6162 6c65 4c61  ble = RunnableLa
+00020510: 6d62 6461 2861 6464 5f6f 6e65 2c20 6166  mbda(add_one, af
+00020520: 756e 633d 6164 645f 6f6e 655f 6173 796e  unc=add_one_asyn
+00020530: 6329 0a20 2020 2020 2020 2020 2020 2072  c).            r
+00020540: 756e 6e61 626c 652e 696e 766f 6b65 2831  unnable.invoke(1
+00020550: 2920 2320 5573 6573 2061 6464 5f6f 6e65  ) # Uses add_one
+00020560: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00020570: 6974 2072 756e 6e61 626c 652e 6169 6e76  it runnable.ainv
+00020580: 6f6b 6528 3129 2023 2055 7365 7320 6164  oke(1) # Uses ad
+00020590: 645f 6f6e 655f 6173 796e 630a 2020 2020  d_one_async.    
+000205a0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+000205b0: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+000205c0: 656c 662c 0a20 2020 2020 2020 2066 756e  elf,.        fun
+000205d0: 633a 2055 6e69 6f6e 5b0a 2020 2020 2020  c: Union[.      
+000205e0: 2020 2020 2020 556e 696f 6e5b 0a20 2020        Union[.   
+000205f0: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+00020600: 6c61 626c 655b 5b49 6e70 7574 5d2c 204f  lable[[Input], O
+00020610: 7574 7075 745d 2c0a 2020 2020 2020 2020  utput],.        
+00020620: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00020630: 5b5b 496e 7075 745d 2c20 4974 6572 6174  [[Input], Iterat
+00020640: 6f72 5b4f 7574 7075 745d 5d2c 0a20 2020  or[Output]],.   
+00020650: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+00020660: 6c61 626c 655b 5b49 6e70 7574 2c20 5275  lable[[Input, Ru
+00020670: 6e6e 6162 6c65 436f 6e66 6967 5d2c 204f  nnableConfig], O
+00020680: 7574 7075 745d 2c0a 2020 2020 2020 2020  utput],.        
+00020690: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+000206a0: 5b5b 496e 7075 742c 2043 616c 6c62 6163  [[Input, Callbac
+000206b0: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+000206c0: 5275 6e5d 2c20 4f75 7470 7574 5d2c 0a20  Run], Output],. 
+000206d0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+000206e0: 616c 6c61 626c 655b 5b49 6e70 7574 2c20  allable[[Input, 
+000206f0: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
+00020700: 6f72 4368 6169 6e52 756e 2c20 5275 6e6e  orChainRun, Runn
+00020710: 6162 6c65 436f 6e66 6967 5d2c 204f 7574  ableConfig], Out
+00020720: 7075 745d 2c0a 2020 2020 2020 2020 2020  put],.          
+00020730: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00020740: 2055 6e69 6f6e 5b0a 2020 2020 2020 2020   Union[.        
+00020750: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00020760: 5b5b 496e 7075 745d 2c20 4177 6169 7461  [[Input], Awaita
+00020770: 626c 655b 4f75 7470 7574 5d5d 2c0a 2020  ble[Output]],.  
+00020780: 2020 2020 2020 2020 2020 2020 2020 4361                Ca
+00020790: 6c6c 6162 6c65 5b5b 496e 7075 745d 2c20  llable[[Input], 
+000207a0: 4173 796e 6349 7465 7261 746f 725b 4f75  AsyncIterator[Ou
+000207b0: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
+000207c0: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+000207d0: 5b5b 496e 7075 742c 2052 756e 6e61 626c  [[Input, Runnabl
+000207e0: 6543 6f6e 6669 675d 2c20 4177 6169 7461  eConfig], Awaita
+000207f0: 626c 655b 4f75 7470 7574 5d5d 2c0a 2020  ble[Output]],.  
+00020800: 2020 2020 2020 2020 2020 2020 2020 4361                Ca
+00020810: 6c6c 6162 6c65 5b5b 496e 7075 742c 2041  llable[[Input, A
+00020820: 7379 6e63 4361 6c6c 6261 636b 4d61 6e61  syncCallbackMana
+00020830: 6765 7246 6f72 4368 6169 6e52 756e 5d2c  gerForChainRun],
+00020840: 2041 7761 6974 6162 6c65 5b4f 7574 7075   Awaitable[Outpu
+00020850: 745d 5d2c 0a20 2020 2020 2020 2020 2020  t]],.           
+00020860: 2020 2020 2043 616c 6c61 626c 655b 0a20       Callable[. 
+00020870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020880: 2020 205b 496e 7075 742c 2041 7379 6e63     [Input, Async
+00020890: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
+000208a0: 6f72 4368 6169 6e52 756e 2c20 5275 6e6e  orChainRun, Runn
+000208b0: 6162 6c65 436f 6e66 6967 5d2c 0a20 2020  ableConfig],.   
+000208c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208d0: 2041 7761 6974 6162 6c65 5b4f 7574 7075   Awaitable[Outpu
+000208e0: 745d 2c0a 2020 2020 2020 2020 2020 2020  t],.            
+000208f0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00020900: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
+00020910: 0a20 2020 2020 2020 2061 6675 6e63 3a20  .        afunc: 
+00020920: 4f70 7469 6f6e 616c 5b0a 2020 2020 2020  Optional[.      
+00020930: 2020 2020 2020 556e 696f 6e5b 0a20 2020        Union[.   
+00020940: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+00020950: 6c61 626c 655b 5b49 6e70 7574 5d2c 2041  lable[[Input], A
+00020960: 7761 6974 6162 6c65 5b4f 7574 7075 745d  waitable[Output]
+00020970: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00020980: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
+00020990: 7574 5d2c 2041 7379 6e63 4974 6572 6174  ut], AsyncIterat
+000209a0: 6f72 5b4f 7574 7075 745d 5d2c 0a20 2020  or[Output]],.   
+000209b0: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+000209c0: 6c61 626c 655b 5b49 6e70 7574 2c20 5275  lable[[Input, Ru
+000209d0: 6e6e 6162 6c65 436f 6e66 6967 5d2c 2041  nnableConfig], A
+000209e0: 7761 6974 6162 6c65 5b4f 7574 7075 745d  waitable[Output]
+000209f0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00020a00: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
+00020a10: 7574 2c20 4173 796e 6343 616c 6c62 6163  ut, AsyncCallbac
+00020a20: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00020a30: 5275 6e5d 2c20 4177 6169 7461 626c 655b  Run], Awaitable[
+00020a40: 4f75 7470 7574 5d5d 2c0a 2020 2020 2020  Output]],.      
+00020a50: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
+00020a60: 6c65 5b0a 2020 2020 2020 2020 2020 2020  le[.            
+00020a70: 2020 2020 2020 2020 5b49 6e70 7574 2c20          [Input, 
+00020a80: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
+00020a90: 6167 6572 466f 7243 6861 696e 5275 6e2c  agerForChainRun,
+00020aa0: 2052 756e 6e61 626c 6543 6f6e 6669 675d   RunnableConfig]
+00020ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020ac0: 2020 2020 2020 4177 6169 7461 626c 655b        Awaitable[
+00020ad0: 4f75 7470 7574 5d2c 0a20 2020 2020 2020  Output],.       
+00020ae0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00020af0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00020b00: 2020 5d20 3d20 4e6f 6e65 2c0a 2020 2020    ] = None,.    
+00020b10: 2020 2020 6e61 6d65 3a20 4f70 7469 6f6e      name: Option
+00020b20: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00020b30: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00020b40: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
+00020b50: 2061 2052 756e 6e61 626c 654c 616d 6264   a RunnableLambd
+00020b60: 6120 6672 6f6d 2061 2063 616c 6c61 626c  a from a callabl
+00020b70: 652c 2061 6e64 2061 7379 6e63 2063 616c  e, and async cal
+00020b80: 6c61 626c 6520 6f72 2062 6f74 682e 0a0a  lable or both...
+00020b90: 2020 2020 2020 2020 4163 6365 7074 7320          Accepts 
+00020ba0: 626f 7468 2073 796e 6320 616e 6420 6173  both sync and as
+00020bb0: 796e 6320 7661 7269 616e 7473 2074 6f20  ync variants to 
+00020bc0: 616c 6c6f 7720 7072 6f76 6964 696e 6720  allow providing 
+00020bd0: 6566 6669 6369 656e 740a 2020 2020 2020  efficient.      
+00020be0: 2020 696d 706c 656d 656e 7461 7469 6f6e    implementation
+00020bf0: 7320 666f 7220 7379 6e63 2061 6e64 2061  s for sync and a
+00020c00: 7379 6e63 2065 7865 6375 7469 6f6e 2e0a  sync execution..
+00020c10: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+00020c20: 2020 2020 2020 2020 2020 2066 756e 633a             func:
+00020c30: 2045 6974 6865 7220 7379 6e63 206f 7220   Either sync or 
+00020c40: 6173 796e 6320 6361 6c6c 6162 6c65 0a20  async callable. 
+00020c50: 2020 2020 2020 2020 2020 2061 6675 6e63             afunc
+00020c60: 3a20 416e 2061 7379 6e63 2063 616c 6c61  : An async calla
+00020c70: 626c 6520 7468 6174 2074 616b 6573 2061  ble that takes a
+00020c80: 6e20 696e 7075 7420 616e 6420 7265 7475  n input and retu
+00020c90: 726e 7320 616e 206f 7574 7075 742e 0a20  rns an output.. 
+00020ca0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00020cb0: 2020 2069 6620 6166 756e 6320 6973 206e     if afunc is n
+00020cc0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00020cd0: 2020 2020 2073 656c 662e 6166 756e 6320       self.afunc 
+00020ce0: 3d20 6166 756e 630a 2020 2020 2020 2020  = afunc.        
+00020cf0: 2020 2020 6675 6e63 5f66 6f72 5f6e 616d      func_for_nam
+00020d00: 653a 2043 616c 6c61 626c 6520 3d20 6166  e: Callable = af
+00020d10: 756e 630a 0a20 2020 2020 2020 2069 6620  unc..        if 
+00020d20: 6973 5f61 7379 6e63 5f63 616c 6c61 626c  is_async_callabl
+00020d30: 6528 6675 6e63 2920 6f72 2069 735f 6173  e(func) or is_as
+00020d40: 796e 635f 6765 6e65 7261 746f 7228 6675  ync_generator(fu
+00020d50: 6e63 293a 0a20 2020 2020 2020 2020 2020  nc):.           
+00020d60: 2069 6620 6166 756e 6320 6973 206e 6f74   if afunc is not
+00020d70: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00020d80: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
+00020d90: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00020da0: 2020 2020 2020 2020 2020 2020 2246 756e              "Fun
+00020db0: 6320 7761 7320 7072 6f76 6964 6564 2061  c was provided a
+00020dc0: 7320 6120 636f 726f 7574 696e 6520 6675  s a coroutine fu
+00020dd0: 6e63 7469 6f6e 2c20 6275 7420 6166 756e  nction, but afun
+00020de0: 6320 7761 7320 220a 2020 2020 2020 2020  c was ".        
+00020df0: 2020 2020 2020 2020 2020 2020 2261 6c73              "als
+00020e00: 6f20 7072 6f76 6964 6564 2e20 4966 2070  o provided. If p
+00020e10: 726f 7669 6469 6e67 2062 6f74 682c 2066  roviding both, f
+00020e20: 756e 6320 7368 6f75 6c64 2062 6520 6120  unc should be a 
+00020e30: 7265 6775 6c61 7220 220a 2020 2020 2020  regular ".      
+00020e40: 2020 2020 2020 2020 2020 2020 2020 2266                "f
+00020e50: 756e 6374 696f 6e20 746f 2061 766f 6964  unction to avoid
+00020e60: 2061 6d62 6967 7569 7479 2e22 0a20 2020   ambiguity.".   
+00020e70: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00020e80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00020e90: 6166 756e 6320 3d20 6675 6e63 0a20 2020  afunc = func.   
+00020ea0: 2020 2020 2020 2020 2066 756e 635f 666f           func_fo
+00020eb0: 725f 6e61 6d65 203d 2066 756e 630a 2020  r_name = func.  
+00020ec0: 2020 2020 2020 656c 6966 2063 616c 6c61        elif calla
+00020ed0: 626c 6528 6675 6e63 293a 0a20 2020 2020  ble(func):.     
+00020ee0: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+00020ef0: 203d 2063 6173 7428 4361 6c6c 6162 6c65   = cast(Callable
+00020f00: 5b5b 496e 7075 745d 2c20 4f75 7470 7574  [[Input], Output
+00020f10: 5d2c 2066 756e 6329 0a20 2020 2020 2020  ], func).       
+00020f20: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
+00020f30: 6d65 203d 2066 756e 630a 2020 2020 2020  me = func.      
+00020f40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00020f50: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
+00020f60: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00020f70: 2020 2020 2022 4578 7065 6374 6564 2061       "Expected a
+00020f80: 2063 616c 6c61 626c 6520 7479 7065 2066   callable type f
+00020f90: 6f72 2060 6675 6e63 602e 220a 2020 2020  or `func`.".    
+00020fa0: 2020 2020 2020 2020 2020 2020 6622 496e              f"In
+00020fb0: 7374 6561 6420 676f 7420 616e 2075 6e73  stead got an uns
+00020fc0: 7570 706f 7274 6564 2074 7970 653a 207b  upported type: {
+00020fd0: 7479 7065 2866 756e 6329 7d22 0a20 2020  type(func)}".   
+00020fe0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00020ff0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00021000: 2020 2020 2069 6620 6e61 6d65 2069 7320       if name is 
+00021010: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00021020: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
+00021030: 616d 6520 3d20 6e61 6d65 0a20 2020 2020  ame = name.     
+00021040: 2020 2020 2020 2065 6c69 6620 6675 6e63         elif func
+00021050: 5f66 6f72 5f6e 616d 652e 5f5f 6e61 6d65  _for_name.__name
+00021060: 5f5f 2021 3d20 223c 6c61 6d62 6461 3e22  __ != "<lambda>"
+00021070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021080: 2020 7365 6c66 2e6e 616d 6520 3d20 6675    self.name = fu
+00021090: 6e63 5f66 6f72 5f6e 616d 652e 5f5f 6e61  nc_for_name.__na
+000210a0: 6d65 5f5f 0a20 2020 2020 2020 2065 7863  me__.        exc
+000210b0: 6570 7420 4174 7472 6962 7574 6545 7272  ept AttributeErr
+000210c0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+000210d0: 7061 7373 0a0a 2020 2020 4070 726f 7065  pass..    @prope
+000210e0: 7274 790a 2020 2020 6465 6620 496e 7075  rty.    def Inpu
+000210f0: 7454 7970 6528 7365 6c66 2920 2d3e 2041  tType(self) -> A
+00021100: 6e79 3a0a 2020 2020 2020 2020 2222 2254  ny:.        """T
+00021110: 6865 2074 7970 6520 6f66 2074 6865 2069  he type of the i
+00021120: 6e70 7574 2074 6f20 7468 6973 2072 756e  nput to this run
+00021130: 6e61 626c 652e 2222 220a 2020 2020 2020  nable.""".      
+00021140: 2020 6675 6e63 203d 2067 6574 6174 7472    func = getattr
+00021150: 2873 656c 662c 2022 6675 6e63 222c 204e  (self, "func", N
+00021160: 6f6e 6529 206f 7220 6765 7461 7474 7228  one) or getattr(
+00021170: 7365 6c66 2c20 2261 6675 6e63 2229 0a20  self, "afunc"). 
+00021180: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00021190: 2020 2020 2020 2020 7061 7261 6d73 203d          params =
+000211a0: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
+000211b0: 7265 2866 756e 6329 2e70 6172 616d 6574  re(func).paramet
+000211c0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+000211d0: 6669 7273 745f 7061 7261 6d20 3d20 6e65  first_param = ne
+000211e0: 7874 2869 7465 7228 7061 7261 6d73 2e76  xt(iter(params.v
+000211f0: 616c 7565 7328 2929 2c20 4e6f 6e65 290a  alues()), None).
+00021200: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00021210: 6972 7374 5f70 6172 616d 2061 6e64 2066  irst_param and f
+00021220: 6972 7374 5f70 6172 616d 2e61 6e6e 6f74  irst_param.annot
+00021230: 6174 696f 6e20 213d 2069 6e73 7065 6374  ation != inspect
+00021240: 2e50 6172 616d 6574 6572 2e65 6d70 7479  .Parameter.empty
+00021250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021260: 2020 7265 7475 726e 2066 6972 7374 5f70    return first_p
+00021270: 6172 616d 2e61 6e6e 6f74 6174 696f 6e0a  aram.annotation.
+00021280: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00021290: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000212a0: 2020 7265 7475 726e 2041 6e79 0a20 2020    return Any.   
+000212b0: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+000212c0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+000212d0: 2020 2020 7265 7475 726e 2041 6e79 0a0a      return Any..
+000212e0: 2020 2020 6465 6620 6765 745f 696e 7075      def get_inpu
+000212f0: 745f 7363 6865 6d61 280a 2020 2020 2020  t_schema(.      
+00021300: 2020 7365 6c66 2c20 636f 6e66 6967 3a20    self, config: 
+00021310: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+00021320: 6543 6f6e 6669 675d 203d 204e 6f6e 650a  eConfig] = None.
+00021330: 2020 2020 2920 2d3e 2054 7970 655b 4261      ) -> Type[Ba
+00021340: 7365 4d6f 6465 6c5d 3a0a 2020 2020 2020  seModel]:.      
+00021350: 2020 2222 2254 6865 2070 7964 616e 7469    """The pydanti
+00021360: 6320 7363 6865 6d61 2066 6f72 2074 6865  c schema for the
+00021370: 2069 6e70 7574 2074 6f20 7468 6973 2072   input to this r
+00021380: 756e 6e61 626c 652e 2222 220a 2020 2020  unnable.""".    
+00021390: 2020 2020 6675 6e63 203d 2067 6574 6174      func = getat
+000213a0: 7472 2873 656c 662c 2022 6675 6e63 222c  tr(self, "func",
+000213b0: 204e 6f6e 6529 206f 7220 6765 7461 7474   None) or getatt
+000213c0: 7228 7365 6c66 2c20 2261 6675 6e63 2229  r(self, "afunc")
+000213d0: 0a0a 2020 2020 2020 2020 6966 2069 7369  ..        if isi
+000213e0: 6e73 7461 6e63 6528 6675 6e63 2c20 6974  nstance(func, it
+000213f0: 656d 6765 7474 6572 293a 0a20 2020 2020  emgetter):.     
+00021400: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
+00021410: 2074 6572 7269 626c 652c 2062 7574 2061   terrible, but a
+00021420: 6661 6963 7420 6974 2773 206e 6f74 2070  faict it's not p
+00021430: 6f73 7369 626c 6520 746f 2061 6363 6573  ossible to acces
+00021440: 7320 5f69 7465 6d73 0a20 2020 2020 2020  s _items.       
+00021450: 2020 2020 2023 206f 6e20 6974 656d 6765       # on itemge
+00021460: 7474 6572 206f 626a 6563 7473 2c20 736f  tter objects, so
+00021470: 2077 6520 6861 7665 2074 6f20 7061 7273   we have to pars
+00021480: 6520 7468 6520 7265 7072 0a20 2020 2020  e the repr.     
+00021490: 2020 2020 2020 2069 7465 6d73 203d 2073         items = s
+000214a0: 7472 2866 756e 6329 2e72 6570 6c61 6365  tr(func).replace
+000214b0: 2822 6f70 6572 6174 6f72 2e69 7465 6d67  ("operator.itemg
+000214c0: 6574 7465 7228 222c 2022 2229 5b3a 2d31  etter(", "")[:-1
+000214d0: 5d2e 7370 6c69 7428 222c 2022 290a 2020  ].split(", ").  
+000214e0: 2020 2020 2020 2020 2020 6966 2061 6c6c            if all
+000214f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00021500: 2020 6974 656d 5b30 5d20 3d3d 2022 2722    item[0] == "'"
+00021510: 2061 6e64 2069 7465 6d5b 2d31 5d20 3d3d   and item[-1] ==
+00021520: 2022 2722 2061 6e64 206c 656e 2869 7465   "'" and len(ite
+00021530: 6d29 203e 2032 2066 6f72 2069 7465 6d20  m) > 2 for item 
+00021540: 696e 2069 7465 6d73 0a20 2020 2020 2020  in items.       
+00021550: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00021560: 2020 2020 2020 2020 2320 4974 2773 2061          # It's a
+00021570: 2064 6963 742c 206c 6f6c 0a20 2020 2020   dict, lol.     
+00021580: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00021590: 6e20 6372 6561 7465 5f6d 6f64 656c 280a  n create_model(.
+000215a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215b0: 2020 2020 7365 6c66 2e67 6574 5f6e 616d      self.get_nam
+000215c0: 6528 2249 6e70 7574 2229 2c0a 2020 2020  e("Input"),.    
+000215d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215e0: 2a2a 7b69 7465 6d5b 313a 2d31 5d3a 2028  **{item[1:-1]: (
+000215f0: 416e 792c 204e 6f6e 6529 2066 6f72 2069  Any, None) for i
+00021600: 7465 6d20 696e 2069 7465 6d73 7d2c 2020  tem in items},  
+00021610: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00021620: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00021630: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00021640: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00021650: 2020 2072 6574 7572 6e20 6372 6561 7465     return create
+00021660: 5f6d 6f64 656c 280a 2020 2020 2020 2020  _model(.        
+00021670: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00021680: 2e67 6574 5f6e 616d 6528 2249 6e70 7574  .get_name("Input
+00021690: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+000216a0: 2020 2020 2020 2020 5f5f 726f 6f74 5f5f          __root__
+000216b0: 3d28 4c69 7374 5b41 6e79 5d2c 204e 6f6e  =(List[Any], Non
+000216c0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+000216d0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+000216e0: 6620 7365 6c66 2e49 6e70 7574 5479 7065  f self.InputType
+000216f0: 2021 3d20 416e 793a 0a20 2020 2020 2020   != Any:.       
+00021700: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+00021710: 7228 292e 6765 745f 696e 7075 745f 7363  r().get_input_sc
+00021720: 6865 6d61 2863 6f6e 6669 6729 0a0a 2020  hema(config)..  
+00021730: 2020 2020 2020 6966 2064 6963 745f 6b65        if dict_ke
+00021740: 7973 203a 3d20 6765 745f 6675 6e63 7469  ys := get_functi
+00021750: 6f6e 5f66 6972 7374 5f61 7267 5f64 6963  on_first_arg_dic
+00021760: 745f 6b65 7973 2866 756e 6329 3a0a 2020  t_keys(func):.  
+00021770: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021780: 2063 7265 6174 655f 6d6f 6465 6c28 0a20   create_model(. 
+00021790: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000217a0: 656c 662e 6765 745f 6e61 6d65 2822 496e  elf.get_name("In
+000217b0: 7075 7422 292c 0a20 2020 2020 2020 2020  put"),.         
+000217c0: 2020 2020 2020 202a 2a7b 6b65 793a 2028         **{key: (
+000217d0: 416e 792c 204e 6f6e 6529 2066 6f72 206b  Any, None) for k
+000217e0: 6579 2069 6e20 6469 6374 5f6b 6579 737d  ey in dict_keys}
+000217f0: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
+00021800: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
+00021810: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00021820: 7375 7065 7228 292e 6765 745f 696e 7075  super().get_inpu
+00021830: 745f 7363 6865 6d61 2863 6f6e 6669 6729  t_schema(config)
+00021840: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00021850: 2020 2020 6465 6620 4f75 7470 7574 5479      def OutputTy
+00021860: 7065 2873 656c 6629 202d 3e20 416e 793a  pe(self) -> Any:
+00021870: 0a20 2020 2020 2020 2022 2222 5468 6520  .        """The 
+00021880: 7479 7065 206f 6620 7468 6520 6f75 7470  type of the outp
+00021890: 7574 206f 6620 7468 6973 2072 756e 6e61  ut of this runna
+000218a0: 626c 6520 6173 2061 2074 7970 6520 616e  ble as a type an
+000218b0: 6e6f 7461 7469 6f6e 2e22 2222 0a20 2020  notation.""".   
+000218c0: 2020 2020 2066 756e 6320 3d20 6765 7461       func = geta
+000218d0: 7474 7228 7365 6c66 2c20 2266 756e 6322  ttr(self, "func"
+000218e0: 2c20 4e6f 6e65 2920 6f72 2067 6574 6174  , None) or getat
+000218f0: 7472 2873 656c 662c 2022 6166 756e 6322  tr(self, "afunc"
+00021900: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00021910: 2020 2020 2020 2020 2020 2073 6967 203d             sig =
+00021920: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
+00021930: 7265 2866 756e 6329 0a20 2020 2020 2020  re(func).       
+00021940: 2020 2020 2069 6620 7369 672e 7265 7475       if sig.retu
+00021950: 726e 5f61 6e6e 6f74 6174 696f 6e20 213d  rn_annotation !=
+00021960: 2069 6e73 7065 6374 2e53 6967 6e61 7475   inspect.Signatu
+00021970: 7265 2e65 6d70 7479 3a0a 2020 2020 2020  re.empty:.      
+00021980: 2020 2020 2020 2020 2020 2320 756e 7772            # unwr
+00021990: 6170 2069 7465 7261 746f 7220 7479 7065  ap iterator type
+000219a0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000219b0: 2020 6966 2067 6574 6174 7472 2873 6967    if getattr(sig
+000219c0: 2e72 6574 7572 6e5f 616e 6e6f 7461 7469  .return_annotati
+000219d0: 6f6e 2c20 225f 5f6f 7269 6769 6e5f 5f22  on, "__origin__"
+000219e0: 2c20 4e6f 6e65 2920 696e 2028 0a20 2020  , None) in (.   
+000219f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a00: 2063 6f6c 6c65 6374 696f 6e73 2e61 6263   collections.abc
+00021a10: 2e49 7465 7261 746f 722c 0a20 2020 2020  .Iterator,.     
+00021a20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00021a30: 6f6c 6c65 6374 696f 6e73 2e61 6263 2e41  ollections.abc.A
+00021a40: 7379 6e63 4974 6572 6174 6f72 2c0a 2020  syncIterator,.  
+00021a50: 2020 2020 2020 2020 2020 2020 2020 293a                ):
+00021a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021a70: 2020 2020 2072 6574 7572 6e20 6765 7461       return geta
+00021a80: 7474 7228 7369 672e 7265 7475 726e 5f61  ttr(sig.return_a
+00021a90: 6e6e 6f74 6174 696f 6e2c 2022 5f5f 6172  nnotation, "__ar
+00021aa0: 6773 5f5f 222c 2028 416e 792c 2929 5b30  gs__", (Any,))[0
+00021ab0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00021ac0: 2020 7265 7475 726e 2073 6967 2e72 6574    return sig.ret
+00021ad0: 7572 6e5f 616e 6e6f 7461 7469 6f6e 0a20  urn_annotation. 
+00021ae0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00021af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021b00: 2072 6574 7572 6e20 416e 790a 2020 2020   return Any.    
+00021b10: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
+00021b20: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00021b30: 2020 2072 6574 7572 6e20 416e 790a 0a20     return Any.. 
+00021b40: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00021b50: 2064 6566 2064 6570 7328 7365 6c66 2920   def deps(self) 
+00021b60: 2d3e 204c 6973 745b 5275 6e6e 6162 6c65  -> List[Runnable
+00021b70: 5d3a 0a20 2020 2020 2020 2022 2222 5468  ]:.        """Th
+00021b80: 6520 6465 7065 6e64 656e 6369 6573 206f  e dependencies o
+00021b90: 6620 7468 6973 2072 756e 6e61 626c 652e  f this runnable.
+00021ba0: 2222 220a 2020 2020 2020 2020 6966 2068  """.        if h
+00021bb0: 6173 6174 7472 2873 656c 662c 2022 6675  asattr(self, "fu
+00021bc0: 6e63 2229 3a0a 2020 2020 2020 2020 2020  nc"):.          
+00021bd0: 2020 6f62 6a65 6374 7320 3d20 6765 745f    objects = get_
+00021be0: 6675 6e63 7469 6f6e 5f6e 6f6e 6c6f 6361  function_nonloca
+00021bf0: 6c73 2873 656c 662e 6675 6e63 290a 2020  ls(self.func).  
+00021c00: 2020 2020 2020 656c 6966 2068 6173 6174        elif hasat
+00021c10: 7472 2873 656c 662c 2022 6166 756e 6322  tr(self, "afunc"
+00021c20: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
+00021c30: 626a 6563 7473 203d 2067 6574 5f66 756e  bjects = get_fun
+00021c40: 6374 696f 6e5f 6e6f 6e6c 6f63 616c 7328  ction_nonlocals(
+00021c50: 7365 6c66 2e61 6675 6e63 290a 2020 2020  self.afunc).    
+00021c60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00021c70: 2020 2020 2020 6f62 6a65 6374 7320 3d20        objects = 
+00021c80: 5b5d 0a0a 2020 2020 2020 2020 6465 7073  []..        deps
+00021c90: 3a20 4c69 7374 5b52 756e 6e61 626c 655d  : List[Runnable]
+00021ca0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+00021cb0: 7220 6f62 6a20 696e 206f 626a 6563 7473  r obj in objects
+00021cc0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00021cd0: 2069 7369 6e73 7461 6e63 6528 6f62 6a2c   isinstance(obj,
+00021ce0: 2052 756e 6e61 626c 6529 3a0a 2020 2020   Runnable):.    
+00021cf0: 2020 2020 2020 2020 2020 2020 6465 7073              deps
+00021d00: 2e61 7070 656e 6428 6f62 6a29 0a20 2020  .append(obj).   
+00021d10: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+00021d20: 696e 7374 616e 6365 2867 6574 6174 7472  instance(getattr
+00021d30: 286f 626a 2c20 225f 5f73 656c 665f 5f22  (obj, "__self__"
+00021d40: 2c20 4e6f 6e65 292c 2052 756e 6e61 626c  , None), Runnabl
+00021d50: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00021d60: 2020 2020 6465 7073 2e61 7070 656e 6428      deps.append(
+00021d70: 6f62 6a2e 5f5f 7365 6c66 5f5f 290a 2020  obj.__self__).  
+00021d80: 2020 2020 2020 7265 7475 726e 2064 6570        return dep
+00021d90: 730a 0a20 2020 2040 7072 6f70 6572 7479  s..    @property
+00021da0: 0a20 2020 2064 6566 2063 6f6e 6669 675f  .    def config_
+00021db0: 7370 6563 7328 7365 6c66 2920 2d3e 204c  specs(self) -> L
+00021dc0: 6973 745b 436f 6e66 6967 7572 6162 6c65  ist[Configurable
+00021dd0: 4669 656c 6453 7065 635d 3a0a 2020 2020  FieldSpec]:.    
+00021de0: 2020 2020 7265 7475 726e 2067 6574 5f75      return get_u
+00021df0: 6e69 7175 655f 636f 6e66 6967 5f73 7065  nique_config_spe
+00021e00: 6373 280a 2020 2020 2020 2020 2020 2020  cs(.            
+00021e10: 7370 6563 2066 6f72 2064 6570 2069 6e20  spec for dep in 
+00021e20: 7365 6c66 2e64 6570 7320 666f 7220 7370  self.deps for sp
+00021e30: 6563 2069 6e20 6465 702e 636f 6e66 6967  ec in dep.config
+00021e40: 5f73 7065 6373 0a20 2020 2020 2020 2029  _specs.        )
+00021e50: 0a0a 2020 2020 6465 6620 6765 745f 6772  ..    def get_gr
+00021e60: 6170 6828 7365 6c66 2c20 636f 6e66 6967  aph(self, config
+00021e70: 3a20 5275 6e6e 6162 6c65 436f 6e66 6967  : RunnableConfig
+00021e80: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00021e90: 2d3e 2047 7261 7068 3a0a 2020 2020 2020  -> Graph:.      
+00021ea0: 2020 6966 2064 6570 7320 3a3d 2073 656c    if deps := sel
+00021eb0: 662e 6465 7073 3a0a 2020 2020 2020 2020  f.deps:.        
+00021ec0: 2020 2020 6772 6170 6820 3d20 4772 6170      graph = Grap
+00021ed0: 6828 290a 2020 2020 2020 2020 2020 2020  h().            
+00021ee0: 696e 7075 745f 6e6f 6465 203d 2067 7261  input_node = gra
+00021ef0: 7068 2e61 6464 5f6e 6f64 6528 7365 6c66  ph.add_node(self
+00021f00: 2e67 6574 5f69 6e70 7574 5f73 6368 656d  .get_input_schem
+00021f10: 6128 636f 6e66 6967 2929 0a20 2020 2020  a(config)).     
+00021f20: 2020 2020 2020 206f 7574 7075 745f 6e6f         output_no
+00021f30: 6465 203d 2067 7261 7068 2e61 6464 5f6e  de = graph.add_n
+00021f40: 6f64 6528 7365 6c66 2e67 6574 5f6f 7574  ode(self.get_out
+00021f50: 7075 745f 7363 6865 6d61 2863 6f6e 6669  put_schema(confi
+00021f60: 6729 290a 2020 2020 2020 2020 2020 2020  g)).            
+00021f70: 666f 7220 6465 7020 696e 2064 6570 733a  for dep in deps:
+00021f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021f90: 2064 6570 5f67 7261 7068 203d 2064 6570   dep_graph = dep
+00021fa0: 2e67 6574 5f67 7261 7068 2829 0a20 2020  .get_graph().   
+00021fb0: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+00021fc0: 5f67 7261 7068 2e74 7269 6d5f 6669 7273  _graph.trim_firs
+00021fd0: 745f 6e6f 6465 2829 0a20 2020 2020 2020  t_node().       
+00021fe0: 2020 2020 2020 2020 2064 6570 5f67 7261           dep_gra
+00021ff0: 7068 2e74 7269 6d5f 6c61 7374 5f6e 6f64  ph.trim_last_nod
+00022000: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00022010: 2020 2020 6966 206e 6f74 2064 6570 5f67      if not dep_g
+00022020: 7261 7068 3a0a 2020 2020 2020 2020 2020  raph:.          
+00022030: 2020 2020 2020 2020 2020 6772 6170 682e            graph.
+00022040: 6164 645f 6564 6765 2869 6e70 7574 5f6e  add_edge(input_n
+00022050: 6f64 652c 206f 7574 7075 745f 6e6f 6465  ode, output_node
+00022060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00022070: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00022080: 2020 2020 2020 2020 2020 2020 6465 705f              dep_
+00022090: 6669 7273 745f 6e6f 6465 2c20 6465 705f  first_node, dep_
+000220a0: 6c61 7374 5f6e 6f64 6520 3d20 6772 6170  last_node = grap
+000220b0: 682e 6578 7465 6e64 2864 6570 5f67 7261  h.extend(dep_gra
+000220c0: 7068 290a 2020 2020 2020 2020 2020 2020  ph).            
+000220d0: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+000220e0: 6570 5f66 6972 7374 5f6e 6f64 653a 0a20  ep_first_node:. 
+000220f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022100: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00022110: 7565 4572 726f 7228 6622 5275 6e6e 6162  ueError(f"Runnab
+00022120: 6c65 207b 6465 707d 2068 6173 206e 6f20  le {dep} has no 
+00022130: 6669 7273 7420 6e6f 6465 2229 0a20 2020  first node").   
+00022140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022150: 2069 6620 6e6f 7420 6465 705f 6c61 7374   if not dep_last
+00022160: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
+00022170: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00022180: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00022190: 6622 5275 6e6e 6162 6c65 207b 6465 707d  f"Runnable {dep}
+000221a0: 2068 6173 206e 6f20 6c61 7374 206e 6f64   has no last nod
+000221b0: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+000221c0: 2020 2020 2020 2020 6772 6170 682e 6164          graph.ad
+000221d0: 645f 6564 6765 2869 6e70 7574 5f6e 6f64  d_edge(input_nod
+000221e0: 652c 2064 6570 5f66 6972 7374 5f6e 6f64  e, dep_first_nod
+000221f0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00022200: 2020 2020 2020 2067 7261 7068 2e61 6464         graph.add
+00022210: 5f65 6467 6528 6465 705f 6c61 7374 5f6e  _edge(dep_last_n
+00022220: 6f64 652c 206f 7574 7075 745f 6e6f 6465  ode, output_node
+00022230: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00022240: 2020 2020 2020 2020 2020 2020 6772 6170              grap
+00022250: 6820 3d20 7375 7065 7228 292e 6765 745f  h = super().get_
+00022260: 6772 6170 6828 636f 6e66 6967 290a 0a20  graph(config).. 
+00022270: 2020 2020 2020 2072 6574 7572 6e20 6772         return gr
+00022280: 6170 680a 0a20 2020 2064 6566 205f 5f65  aph..    def __e
+00022290: 715f 5f28 7365 6c66 2c20 6f74 6865 723a  q__(self, other:
+000222a0: 2041 6e79 2920 2d3e 2062 6f6f 6c3a 0a20   Any) -> bool:. 
+000222b0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+000222c0: 616e 6365 286f 7468 6572 2c20 5275 6e6e  ance(other, Runn
+000222d0: 6162 6c65 4c61 6d62 6461 293a 0a20 2020  ableLambda):.   
+000222e0: 2020 2020 2020 2020 2069 6620 6861 7361           if hasa
+000222f0: 7474 7228 7365 6c66 2c20 2266 756e 6322  ttr(self, "func"
+00022300: 2920 616e 6420 6861 7361 7474 7228 6f74  ) and hasattr(ot
+00022310: 6865 722c 2022 6675 6e63 2229 3a0a 2020  her, "func"):.  
+00022320: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00022330: 7475 726e 2073 656c 662e 6675 6e63 203d  turn self.func =
+00022340: 3d20 6f74 6865 722e 6675 6e63 0a20 2020  = other.func.   
+00022350: 2020 2020 2020 2020 2065 6c69 6620 6861           elif ha
+00022360: 7361 7474 7228 7365 6c66 2c20 2261 6675  sattr(self, "afu
+00022370: 6e63 2229 2061 6e64 2068 6173 6174 7472  nc") and hasattr
+00022380: 286f 7468 6572 2c20 2261 6675 6e63 2229  (other, "afunc")
+00022390: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000223a0: 2020 7265 7475 726e 2073 656c 662e 6166    return self.af
+000223b0: 756e 6320 3d3d 206f 7468 6572 2e61 6675  unc == other.afu
+000223c0: 6e63 0a20 2020 2020 2020 2020 2020 2065  nc.            e
+000223d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000223e0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+000223f0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00022400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00022410: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
+00022420: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00022430: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00022440: 2022 2222 4120 7374 7269 6e67 2072 6570   """A string rep
+00022450: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
+00022460: 6869 7320 7275 6e6e 6162 6c65 2e22 2222  his runnable."""
+00022470: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
+00022480: 7474 7228 7365 6c66 2c20 2266 756e 6322  ttr(self, "func"
+00022490: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
+000224a0: 2873 656c 662e 6675 6e63 2c20 6974 656d  (self.func, item
+000224b0: 6765 7474 6572 293a 0a20 2020 2020 2020  getter):.       
+000224c0: 2020 2020 2072 6574 7572 6e20 6622 5275       return f"Ru
+000224d0: 6e6e 6162 6c65 4c61 6d62 6461 287b 7374  nnableLambda({st
+000224e0: 7228 7365 6c66 2e66 756e 6329 5b6c 656e  r(self.func)[len
+000224f0: 2827 6f70 6572 6174 6f72 2e27 293a 5d7d  ('operator.'):]}
+00022500: 2922 0a20 2020 2020 2020 2065 6c69 6620  )".        elif 
+00022510: 6861 7361 7474 7228 7365 6c66 2c20 2266  hasattr(self, "f
+00022520: 756e 6322 293a 0a20 2020 2020 2020 2020  unc"):.         
+00022530: 2020 2072 6574 7572 6e20 6622 5275 6e6e     return f"Runn
+00022540: 6162 6c65 4c61 6d62 6461 287b 6765 745f  ableLambda({get_
+00022550: 6c61 6d62 6461 5f73 6f75 7263 6528 7365  lambda_source(se
+00022560: 6c66 2e66 756e 6329 206f 7220 272e 2e2e  lf.func) or '...
+00022570: 277d 2922 0a20 2020 2020 2020 2065 6c69  '})".        eli
+00022580: 6620 6861 7361 7474 7228 7365 6c66 2c20  f hasattr(self, 
+00022590: 2261 6675 6e63 2229 3a0a 2020 2020 2020  "afunc"):.      
+000225a0: 2020 2020 2020 7265 7475 726e 2066 2252        return f"R
+000225b0: 756e 6e61 626c 654c 616d 6264 6128 6166  unnableLambda(af
+000225c0: 756e 633d 7b67 6574 5f6c 616d 6264 615f  unc={get_lambda_
+000225d0: 736f 7572 6365 2873 656c 662e 6166 756e  source(self.afun
+000225e0: 6329 206f 7220 272e 2e2e 277d 2922 0a20  c) or '...'})". 
+000225f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00022600: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00022610: 2252 756e 6e61 626c 654c 616d 6264 6128  "RunnableLambda(
+00022620: 2e2e 2e29 220a 0a20 2020 2064 6566 205f  ...)"..    def _
+00022630: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00022640: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00022650: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+00022660: 2020 2020 7275 6e5f 6d61 6e61 6765 723a      run_manager:
+00022670: 2043 616c 6c62 6163 6b4d 616e 6167 6572   CallbackManager
+00022680: 466f 7243 6861 696e 5275 6e2c 0a20 2020  ForChainRun,.   
+00022690: 2020 2020 2063 6f6e 6669 673a 2052 756e       config: Run
+000226a0: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
+000226b0: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+000226c0: 6e79 2c0a 2020 2020 2920 2d3e 204f 7574  ny,.    ) -> Out
+000226d0: 7075 743a 0a20 2020 2020 2020 2069 6620  put:.        if 
+000226e0: 696e 7370 6563 742e 6973 6765 6e65 7261  inspect.isgenera
+000226f0: 746f 7266 756e 6374 696f 6e28 7365 6c66  torfunction(self
+00022700: 2e66 756e 6329 3a0a 2020 2020 2020 2020  .func):.        
+00022710: 2020 2020 6f75 7470 7574 3a20 4f70 7469      output: Opti
+00022720: 6f6e 616c 5b4f 7574 7075 745d 203d 204e  onal[Output] = N
+00022730: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00022740: 666f 7220 6368 756e 6b20 696e 2063 616c  for chunk in cal
+00022750: 6c5f 6675 6e63 5f77 6974 685f 7661 7269  l_func_with_vari
+00022760: 6162 6c65 5f61 7267 7328 0a20 2020 2020  able_args(.     
+00022770: 2020 2020 2020 2020 2020 2063 6173 7428             cast(
+00022780: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
+00022790: 2c20 4974 6572 6174 6f72 5b4f 7574 7075  , Iterator[Outpu
+000227a0: 745d 5d2c 2073 656c 662e 6675 6e63 292c  t]], self.func),
+000227b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000227c0: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
+000227d0: 2020 2020 2020 2020 636f 6e66 6967 2c0a          config,.
+000227e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227f0: 7275 6e5f 6d61 6e61 6765 722c 0a20 2020  run_manager,.   
+00022800: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
+00022810: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
+00022820: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00022830: 2020 2020 2020 6966 206f 7574 7075 7420        if output 
+00022840: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00022850: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00022860: 7075 7420 3d20 6368 756e 6b0a 2020 2020  put = chunk.    
+00022870: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00022880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00022890: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000228a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228b0: 2020 206f 7574 7075 7420 3d20 6f75 7470     output = outp
+000228c0: 7574 202b 2063 6875 6e6b 2020 2320 7479  ut + chunk  # ty
+000228d0: 7065 3a20 6967 6e6f 7265 5b6f 7065 7261  pe: ignore[opera
+000228e0: 746f 725d 0a20 2020 2020 2020 2020 2020  tor].           
+000228f0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00022900: 5479 7065 4572 726f 723a 0a20 2020 2020  TypeError:.     
+00022910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022920: 2020 206f 7574 7075 7420 3d20 6368 756e     output = chun
+00022930: 6b0a 2020 2020 2020 2020 656c 7365 3a0a  k.        else:.
+00022940: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00022950: 7574 203d 2063 616c 6c5f 6675 6e63 5f77  ut = call_func_w
+00022960: 6974 685f 7661 7269 6162 6c65 5f61 7267  ith_variable_arg
+00022970: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00022980: 2020 2073 656c 662e 6675 6e63 2c20 696e     self.func, in
+00022990: 7075 742c 2063 6f6e 6669 672c 2072 756e  put, config, run
+000229a0: 5f6d 616e 6167 6572 2c20 2a2a 6b77 6172  _manager, **kwar
+000229b0: 6773 0a20 2020 2020 2020 2020 2020 2029  gs.            )
+000229c0: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
+000229d0: 6520 6f75 7470 7574 2069 7320 6120 7275  e output is a ru
+000229e0: 6e6e 6162 6c65 2c20 696e 766f 6b65 2069  nnable, invoke i
+000229f0: 740a 2020 2020 2020 2020 6966 2069 7369  t.        if isi
+00022a00: 6e73 7461 6e63 6528 6f75 7470 7574 2c20  nstance(output, 
+00022a10: 5275 6e6e 6162 6c65 293a 0a20 2020 2020  Runnable):.     
+00022a20: 2020 2020 2020 2072 6563 7572 7369 6f6e         recursion
+00022a30: 5f6c 696d 6974 203d 2063 6f6e 6669 675b  _limit = config[
+00022a40: 2272 6563 7572 7369 6f6e 5f6c 696d 6974  "recursion_limit
+00022a50: 225d 0a20 2020 2020 2020 2020 2020 2069  "].            i
+00022a60: 6620 7265 6375 7273 696f 6e5f 6c69 6d69  f recursion_limi
+00022a70: 7420 3c3d 2030 3a0a 2020 2020 2020 2020  t <= 0:.        
+00022a80: 2020 2020 2020 2020 7261 6973 6520 5265          raise Re
+00022a90: 6375 7273 696f 6e45 7272 6f72 280a 2020  cursionError(.  
+00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ab0: 2020 6622 5265 6375 7273 696f 6e20 6c69    f"Recursion li
+00022ac0: 6d69 7420 7265 6163 6865 6420 7768 656e  mit reached when
+00022ad0: 2069 6e76 6f6b 696e 6720 7b73 656c 667d   invoking {self}
+00022ae0: 2077 6974 6820 696e 7075 7420 7b69 6e70   with input {inp
+00022af0: 7574 7d2e 220a 2020 2020 2020 2020 2020  ut}.".          
+00022b00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00022b10: 2020 2020 6f75 7470 7574 203d 206f 7574      output = out
+00022b20: 7075 742e 696e 766f 6b65 280a 2020 2020  put.invoke(.    
+00022b30: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00022b40: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00022b50: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
+00022b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b70: 2020 2020 2063 6f6e 6669 672c 0a20 2020       config,.   
+00022b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b90: 2063 616c 6c62 6163 6b73 3d72 756e 5f6d   callbacks=run_m
+00022ba0: 616e 6167 6572 2e67 6574 5f63 6869 6c64  anager.get_child
+00022bb0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00022bc0: 2020 2020 2020 2020 7265 6375 7273 696f          recursio
+00022bd0: 6e5f 6c69 6d69 743d 7265 6375 7273 696f  n_limit=recursio
+00022be0: 6e5f 6c69 6d69 7420 2d20 312c 0a20 2020  n_limit - 1,.   
+00022bf0: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00022c00: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00022c10: 2020 2020 2020 7265 7475 726e 2063 6173        return cas
+00022c20: 7428 4f75 7470 7574 2c20 6f75 7470 7574  t(Output, output
+00022c30: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+00022c40: 205f 6169 6e76 6f6b 6528 0a20 2020 2020   _ainvoke(.     
+00022c50: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00022c60: 2069 6e70 7574 3a20 496e 7075 742c 0a20   input: Input,. 
+00022c70: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+00022c80: 6572 3a20 4173 796e 6343 616c 6c62 6163  er: AsyncCallbac
+00022c90: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00022ca0: 5275 6e2c 0a20 2020 2020 2020 2063 6f6e  Run,.        con
+00022cb0: 6669 673a 2052 756e 6e61 626c 6543 6f6e  fig: RunnableCon
+00022cc0: 6669 672c 0a20 2020 2020 2020 202a 2a6b  fig,.        **k
+00022cd0: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+00022ce0: 2920 2d3e 204f 7574 7075 743a 0a20 2020  ) -> Output:.   
+00022cf0: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
+00022d00: 7365 6c66 2c20 2261 6675 6e63 2229 3a0a  self, "afunc"):.
+00022d10: 2020 2020 2020 2020 2020 2020 6166 756e              afun
+00022d20: 6320 3d20 7365 6c66 2e61 6675 6e63 0a20  c = self.afunc. 
+00022d30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00022d40: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
+00022d50: 6563 742e 6973 6765 6e65 7261 746f 7266  ect.isgeneratorf
+00022d60: 756e 6374 696f 6e28 7365 6c66 2e66 756e  unction(self.fun
+00022d70: 6329 3a0a 0a20 2020 2020 2020 2020 2020  c):..           
+00022d80: 2020 2020 2064 6566 2066 756e 6328 0a20       def func(. 
+00022d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022da0: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
+00022db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022dc0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+00022dd0: 3a20 4173 796e 6343 616c 6c62 6163 6b4d  : AsyncCallbackM
+00022de0: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
+00022df0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00022e00: 2020 2020 2020 2063 6f6e 6669 673a 2052         config: R
+00022e10: 756e 6e61 626c 6543 6f6e 6669 672c 0a20  unnableConfig,. 
+00022e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e30: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+00022e40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022e50: 2020 2920 2d3e 204f 7574 7075 743a 0a20    ) -> Output:. 
+00022e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e70: 2020 206f 7574 7075 743a 204f 7074 696f     output: Optio
+00022e80: 6e61 6c5b 4f75 7470 7574 5d20 3d20 4e6f  nal[Output] = No
+00022e90: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00022ea0: 2020 2020 2020 2066 6f72 2063 6875 6e6b         for chunk
+00022eb0: 2069 6e20 6361 6c6c 5f66 756e 635f 7769   in call_func_wi
+00022ec0: 7468 5f76 6172 6961 626c 655f 6172 6773  th_variable_args
+00022ed0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00022ee0: 2020 2020 2020 2020 2020 6361 7374 2843            cast(C
+00022ef0: 616c 6c61 626c 655b 5b49 6e70 7574 5d2c  allable[[Input],
+00022f00: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
+00022f10: 5d5d 2c20 7365 6c66 2e66 756e 6329 2c0a  ]], self.func),.
+00022f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f30: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00022f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f50: 2020 2020 2020 2063 6f6e 6669 672c 0a20         config,. 
+00022f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f70: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+00022f80: 6572 2e67 6574 5f73 796e 6328 292c 0a20  er.get_sync(),. 
+00022f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fa0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+00022fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022fc0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00022fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fe0: 6966 206f 7574 7075 7420 6973 204e 6f6e  if output is Non
+00022ff0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00023000: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00023010: 7574 7075 7420 3d20 6368 756e 6b0a 2020  utput = chunk.  
+00023020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023030: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00023040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023050: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00023060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023070: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00023080: 7075 7420 3d20 6f75 7470 7574 202b 2063  put = output + c
+00023090: 6875 6e6b 2020 2320 7479 7065 3a20 6967  hunk  # type: ig
+000230a0: 6e6f 7265 5b6f 7065 7261 746f 725d 0a20  nore[operator]. 
+000230b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230c0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000230d0: 7420 5479 7065 4572 726f 723a 0a20 2020  t TypeError:.   
+000230e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230f0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00023100: 7075 7420 3d20 6368 756e 6b0a 2020 2020  put = chunk.    
+00023110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023120: 7265 7475 726e 2063 6173 7428 4f75 7470  return cast(Outp
+00023130: 7574 2c20 6f75 7470 7574 290a 0a20 2020  ut, output)..   
+00023140: 2020 2020 2020 2020 2065 6c73 653a 0a0a           else:..
+00023150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023160: 6465 6620 6675 6e63 280a 2020 2020 2020  def func(.      
+00023170: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00023180: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+00023190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231a0: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
+000231b0: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
+000231c0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
+000231d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231e0: 2020 636f 6e66 6967 3a20 5275 6e6e 6162    config: Runnab
+000231f0: 6c65 436f 6e66 6967 2c0a 2020 2020 2020  leConfig,.      
+00023200: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
+00023210: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
+00023220: 2020 2020 2020 2020 2020 2020 2029 202d               ) -
+00023230: 3e20 4f75 7470 7574 3a0a 2020 2020 2020  > Output:.      
+00023240: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00023250: 7475 726e 2063 616c 6c5f 6675 6e63 5f77  turn call_func_w
+00023260: 6974 685f 7661 7269 6162 6c65 5f61 7267  ith_variable_arg
+00023270: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00023280: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00023290: 6675 6e63 2c20 696e 7075 742c 2063 6f6e  func, input, con
+000232a0: 6669 672c 2072 756e 5f6d 616e 6167 6572  fig, run_manager
+000232b0: 2e67 6574 5f73 796e 6328 292c 202a 2a6b  .get_sync(), **k
+000232c0: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+000232d0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000232e0: 2020 2020 2020 2020 2040 7772 6170 7328           @wraps(
+000232f0: 6675 6e63 290a 2020 2020 2020 2020 2020  func).          
+00023300: 2020 6173 796e 6320 6465 6620 6628 2a61    async def f(*a
+00023310: 7267 732c 202a 2a6b 7761 7267 7329 3a20  rgs, **kwargs): 
+00023320: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+00023330: 6e6f 2d75 6e74 7970 6564 2d64 6566 5d0a  no-untyped-def].
+00023340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023350: 7265 7475 726e 2061 7761 6974 2072 756e  return await run
+00023360: 5f69 6e5f 6578 6563 7574 6f72 2863 6f6e  _in_executor(con
+00023370: 6669 672c 2066 756e 632c 202a 6172 6773  fig, func, *args
+00023380: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
+00023390: 2020 2020 2020 2020 2061 6675 6e63 203d           afunc =
+000233a0: 2066 0a0a 2020 2020 2020 2020 6966 2069   f..        if i
+000233b0: 735f 6173 796e 635f 6765 6e65 7261 746f  s_async_generato
+000233c0: 7228 6166 756e 6329 3a0a 2020 2020 2020  r(afunc):.      
+000233d0: 2020 2020 2020 6f75 7470 7574 3a20 4f70        output: Op
+000233e0: 7469 6f6e 616c 5b4f 7574 7075 745d 203d  tional[Output] =
+000233f0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00023400: 2020 6173 796e 6320 666f 7220 6368 756e    async for chun
+00023410: 6b20 696e 2063 6173 7428 0a20 2020 2020  k in cast(.     
+00023420: 2020 2020 2020 2020 2020 2041 7379 6e63             Async
+00023430: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
+00023440: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023450: 2020 6163 616c 6c5f 6675 6e63 5f77 6974    acall_func_wit
+00023460: 685f 7661 7269 6162 6c65 5f61 7267 7328  h_variable_args(
+00023470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023480: 2020 2020 2063 6173 7428 4361 6c6c 6162       cast(Callab
+00023490: 6c65 2c20 6166 756e 6329 2c0a 2020 2020  le, afunc),.    
+000234a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000234b0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
+000234c0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+000234d0: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+000234e0: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+000234f0: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00023500: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00023510: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023520: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00023530: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00023540: 2020 2020 6966 206f 7574 7075 7420 6973      if output is
+00023550: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00023560: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00023570: 7420 3d20 6368 756e 6b0a 2020 2020 2020  t = chunk.      
+00023580: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00023590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000235a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000235b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000235c0: 206f 7574 7075 7420 3d20 6f75 7470 7574   output = output
+000235d0: 202b 2063 6875 6e6b 2020 2320 7479 7065   + chunk  # type
+000235e0: 3a20 6967 6e6f 7265 5b6f 7065 7261 746f  : ignore[operato
+000235f0: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
+00023600: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+00023610: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+00023620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023630: 206f 7574 7075 7420 3d20 6368 756e 6b0a   output = chunk.
+00023640: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00023650: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00023660: 203d 2061 7761 6974 2061 6361 6c6c 5f66   = await acall_f
+00023670: 756e 635f 7769 7468 5f76 6172 6961 626c  unc_with_variabl
+00023680: 655f 6172 6773 280a 2020 2020 2020 2020  e_args(.        
+00023690: 2020 2020 2020 2020 6361 7374 2843 616c          cast(Cal
+000236a0: 6c61 626c 652c 2061 6675 6e63 292c 2069  lable, afunc), i
+000236b0: 6e70 7574 2c20 636f 6e66 6967 2c20 7275  nput, config, ru
+000236c0: 6e5f 6d61 6e61 6765 722c 202a 2a6b 7761  n_manager, **kwa
+000236d0: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
+000236e0: 290a 2020 2020 2020 2020 2320 4966 2074  ).        # If t
+000236f0: 6865 206f 7574 7075 7420 6973 2061 2072  he output is a r
+00023700: 756e 6e61 626c 652c 2069 6e76 6f6b 6520  unnable, invoke 
+00023710: 6974 0a20 2020 2020 2020 2069 6620 6973  it.        if is
+00023720: 696e 7374 616e 6365 286f 7574 7075 742c  instance(output,
+00023730: 2052 756e 6e61 626c 6529 3a0a 2020 2020   Runnable):.    
+00023740: 2020 2020 2020 2020 7265 6375 7273 696f          recursio
+00023750: 6e5f 6c69 6d69 7420 3d20 636f 6e66 6967  n_limit = config
+00023760: 5b22 7265 6375 7273 696f 6e5f 6c69 6d69  ["recursion_limi
+00023770: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
+00023780: 6966 2072 6563 7572 7369 6f6e 5f6c 696d  if recursion_lim
+00023790: 6974 203c 3d20 303a 0a20 2020 2020 2020  it <= 0:.       
+000237a0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+000237b0: 6563 7572 7369 6f6e 4572 726f 7228 0a20  ecursionError(. 
+000237c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237d0: 2020 2066 2252 6563 7572 7369 6f6e 206c     f"Recursion l
+000237e0: 696d 6974 2072 6561 6368 6564 2077 6865  imit reached whe
+000237f0: 6e20 696e 766f 6b69 6e67 207b 7365 6c66  n invoking {self
+00023800: 7d20 7769 7468 2069 6e70 7574 207b 696e  } with input {in
+00023810: 7075 747d 2e22 0a20 2020 2020 2020 2020  put}.".         
+00023820: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00023830: 2020 2020 206f 7574 7075 7420 3d20 6177       output = aw
+00023840: 6169 7420 6f75 7470 7574 2e61 696e 766f  ait output.ainvo
+00023850: 6b65 280a 2020 2020 2020 2020 2020 2020  ke(.            
+00023860: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
+00023870: 2020 2020 2020 2020 2020 2070 6174 6368             patch
+00023880: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+00023890: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000238a0: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
+000238b0: 2020 2020 2020 2020 2063 616c 6c62 6163           callbac
+000238c0: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
+000238d0: 6574 5f63 6869 6c64 2829 2c0a 2020 2020  et_child(),.    
+000238e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000238f0: 7265 6375 7273 696f 6e5f 6c69 6d69 743d  recursion_limit=
+00023900: 7265 6375 7273 696f 6e5f 6c69 6d69 7420  recursion_limit 
+00023910: 2d20 312c 0a20 2020 2020 2020 2020 2020  - 1,.           
+00023920: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00023930: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00023940: 7475 726e 2063 6173 7428 4f75 7470 7574  turn cast(Output
+00023950: 2c20 6f75 7470 7574 290a 0a20 2020 2064  , output)..    d
+00023960: 6566 205f 636f 6e66 6967 280a 2020 2020  ef _config(.    
+00023970: 2020 2020 7365 6c66 2c20 636f 6e66 6967      self, config
+00023980: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+00023990: 626c 6543 6f6e 6669 675d 2c20 6361 6c6c  bleConfig], call
+000239a0: 6162 6c65 3a20 4361 6c6c 6162 6c65 5b2e  able: Callable[.
+000239b0: 2e2e 2c20 416e 795d 0a20 2020 2029 202d  .., Any].    ) -
+000239c0: 3e20 5275 6e6e 6162 6c65 436f 6e66 6967  > RunnableConfig
+000239d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000239e0: 2065 6e73 7572 655f 636f 6e66 6967 2863   ensure_config(c
+000239f0: 6f6e 6669 6729 0a0a 2020 2020 6465 6620  onfig)..    def 
+00023a00: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00023a10: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00023a20: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+00023a30: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+00023a40: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00023a50: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+00023a60: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+00023a70: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+00023a80: 2020 2920 2d3e 204f 7574 7075 743a 0a20    ) -> Output:. 
+00023a90: 2020 2020 2020 2022 2222 496e 766f 6b65         """Invoke
+00023aa0: 2074 6869 7320 7275 6e6e 6162 6c65 2073   this runnable s
+00023ab0: 796e 6368 726f 6e6f 7573 6c79 2e22 2222  ynchronously."""
+00023ac0: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
+00023ad0: 7474 7228 7365 6c66 2c20 2266 756e 6322  ttr(self, "func"
+00023ae0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00023af0: 6574 7572 6e20 7365 6c66 2e5f 6361 6c6c  eturn self._call
+00023b00: 5f77 6974 685f 636f 6e66 6967 280a 2020  _with_config(.  
+00023b10: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00023b20: 6c66 2e5f 696e 766f 6b65 2c0a 2020 2020  lf._invoke,.    
+00023b30: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00023b40: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00023b50: 2020 2073 656c 662e 5f63 6f6e 6669 6728     self._config(
+00023b60: 636f 6e66 6967 2c20 7365 6c66 2e66 756e  config, self.fun
+00023b70: 6329 2c0a 2020 2020 2020 2020 2020 2020  c),.            
+00023b80: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00023b90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00023ba0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00023bb0: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+00023bc0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00023bd0: 2020 2020 2020 2022 4361 6e6e 6f74 2069         "Cannot i
+00023be0: 6e76 6f6b 6520 6120 636f 726f 7574 696e  nvoke a coroutin
+00023bf0: 6520 6675 6e63 7469 6f6e 2073 796e 6368  e function synch
+00023c00: 726f 6e6f 7573 6c79 2e22 0a20 2020 2020  ronously.".     
+00023c10: 2020 2020 2020 2020 2020 2022 5573 6520             "Use 
+00023c20: 6061 696e 766f 6b65 6020 696e 7374 6561  `ainvoke` instea
+00023c30: 642e 220a 2020 2020 2020 2020 2020 2020  d.".            
+00023c40: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+00023c50: 2061 696e 766f 6b65 280a 2020 2020 2020   ainvoke(.      
+00023c60: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00023c70: 696e 7075 743a 2049 6e70 7574 2c0a 2020  input: Input,.  
+00023c80: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+00023c90: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+00023ca0: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
+00023cb0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00023cc0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+00023cd0: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
+00023ce0: 0a20 2020 2020 2020 2022 2222 496e 766f  .        """Invo
+00023cf0: 6b65 2074 6869 7320 7275 6e6e 6162 6c65  ke this runnable
+00023d00: 2061 7379 6e63 6872 6f6e 6f75 736c 792e   asynchronously.
+00023d10: 2222 220a 2020 2020 2020 2020 7468 655f  """.        the_
+00023d20: 6675 6e63 203d 2073 656c 662e 6166 756e  func = self.afun
+00023d30: 6320 6966 2068 6173 6174 7472 2873 656c  c if hasattr(sel
+00023d40: 662c 2022 6166 756e 6322 2920 656c 7365  f, "afunc") else
+00023d50: 2073 656c 662e 6675 6e63 0a20 2020 2020   self.func.     
+00023d60: 2020 2072 6574 7572 6e20 6177 6169 7420     return await 
+00023d70: 7365 6c66 2e5f 6163 616c 6c5f 7769 7468  self._acall_with
+00023d80: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+00023d90: 2020 2020 2073 656c 662e 5f61 696e 766f       self._ainvo
+00023da0: 6b65 2c0a 2020 2020 2020 2020 2020 2020  ke,.            
+00023db0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
+00023dc0: 2020 2073 656c 662e 5f63 6f6e 6669 6728     self._config(
+00023dd0: 636f 6e66 6967 2c20 7468 655f 6675 6e63  config, the_func
+00023de0: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+00023df0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00023e00: 2029 0a0a 2020 2020 6465 6620 5f74 7261   )..    def _tra
+00023e10: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
+00023e20: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00023e30: 7075 743a 2049 7465 7261 746f 725b 496e  put: Iterator[In
+00023e40: 7075 745d 2c0a 2020 2020 2020 2020 7275  put],.        ru
+00023e50: 6e5f 6d61 6e61 6765 723a 2043 616c 6c62  n_manager: Callb
+00023e60: 6163 6b4d 616e 6167 6572 466f 7243 6861  ackManagerForCha
+00023e70: 696e 5275 6e2c 0a20 2020 2020 2020 2063  inRun,.        c
+00023e80: 6f6e 6669 673a 2052 756e 6e61 626c 6543  onfig: RunnableC
+00023e90: 6f6e 6669 672c 0a20 2020 2020 2020 202a  onfig,.        *
+00023ea0: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
+00023eb0: 2020 2920 2d3e 2049 7465 7261 746f 725b    ) -> Iterator[
+00023ec0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+00023ed0: 2066 696e 616c 3a20 496e 7075 740a 2020   final: Input.  
+00023ee0: 2020 2020 2020 676f 745f 6669 7273 745f        got_first_
+00023ef0: 7661 6c20 3d20 4661 6c73 650a 2020 2020  val = False.    
+00023f00: 2020 2020 666f 7220 6963 6875 6e6b 2069      for ichunk i
+00023f10: 6e20 696e 7075 743a 0a20 2020 2020 2020  n input:.       
+00023f20: 2020 2020 2023 2042 7920 6465 6669 6e69       # By defini
+00023f30: 7469 6f6e 732c 2052 756e 6e61 626c 654c  tions, RunnableL
+00023f40: 616d 6264 6173 2063 6f6e 7375 6d65 2061  ambdas consume a
+00023f50: 6c6c 2069 6e70 7574 2062 6566 6f72 6520  ll input before 
+00023f60: 656d 6974 7469 6e67 206f 7574 7075 742e  emitting output.
+00023f70: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+00023f80: 6620 7468 6520 696e 7075 7420 6973 206e  f the input is n
+00023f90: 6f74 2061 6464 6162 6c65 2c20 7468 656e  ot addable, then
+00023fa0: 2077 6527 6c6c 2061 7373 756d 6520 7468   we'll assume th
+00023fb0: 6174 2077 6520 6361 6e0a 2020 2020 2020  at we can.      
+00023fc0: 2020 2020 2020 2320 6f6e 6c79 206f 7065        # only ope
+00023fd0: 7261 7465 206f 6e20 7468 6520 6c61 7374  rate on the last
+00023fe0: 2063 6875 6e6b 2e0a 2020 2020 2020 2020   chunk..        
+00023ff0: 2020 2020 2320 536f 2077 6527 6c6c 2069      # So we'll i
+00024000: 7465 7261 7465 2075 6e74 696c 2077 6520  terate until we 
+00024010: 6765 7420 746f 2074 6865 206c 6173 7420  get to the last 
+00024020: 6368 756e 6b21 0a20 2020 2020 2020 2020  chunk!.         
+00024030: 2020 2069 6620 6e6f 7420 676f 745f 6669     if not got_fi
+00024040: 7273 745f 7661 6c3a 0a20 2020 2020 2020  rst_val:.       
+00024050: 2020 2020 2020 2020 2066 696e 616c 203d           final =
+00024060: 2069 6368 756e 6b0a 2020 2020 2020 2020   ichunk.        
+00024070: 2020 2020 2020 2020 676f 745f 6669 7273          got_firs
+00024080: 745f 7661 6c20 3d20 5472 7565 0a20 2020  t_val = True.   
+00024090: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000240a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000240b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000240c0: 2020 2020 2020 2020 6669 6e61 6c20 3d20          final = 
+000240d0: 6669 6e61 6c20 2b20 6963 6875 6e6b 2020  final + ichunk  
+000240e0: 2320 7479 7065 3a20 6967 6e6f 7265 5b6f  # type: ignore[o
+000240f0: 7065 7261 746f 725d 0a20 2020 2020 2020  perator].       
+00024100: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00024110: 5479 7065 4572 726f 723a 0a20 2020 2020  TypeError:.     
+00024120: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00024130: 696e 616c 203d 2069 6368 756e 6b0a 0a20  inal = ichunk.. 
+00024140: 2020 2020 2020 2069 6620 696e 7370 6563         if inspec
+00024150: 742e 6973 6765 6e65 7261 746f 7266 756e  t.isgeneratorfun
+00024160: 6374 696f 6e28 7365 6c66 2e66 756e 6329  ction(self.func)
+00024170: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
+00024180: 7470 7574 3a20 4f70 7469 6f6e 616c 5b4f  tput: Optional[O
+00024190: 7574 7075 745d 203d 204e 6f6e 650a 2020  utput] = None.  
+000241a0: 2020 2020 2020 2020 2020 666f 7220 6368            for ch
+000241b0: 756e 6b20 696e 2063 616c 6c5f 6675 6e63  unk in call_func
+000241c0: 5f77 6974 685f 7661 7269 6162 6c65 5f61  _with_variable_a
+000241d0: 7267 7328 0a20 2020 2020 2020 2020 2020  rgs(.           
+000241e0: 2020 2020 2073 656c 662e 6675 6e63 2c20       self.func, 
+000241f0: 6361 7374 2849 6e70 7574 2c20 6669 6e61  cast(Input, fina
+00024200: 6c29 2c20 636f 6e66 6967 2c20 7275 6e5f  l), config, run_
+00024210: 6d61 6e61 6765 722c 202a 2a6b 7761 7267  manager, **kwarg
+00024220: 730a 2020 2020 2020 2020 2020 2020 293a  s.            ):
+00024230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024240: 2079 6965 6c64 2063 6875 6e6b 0a20 2020   yield chunk.   
+00024250: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00024260: 6f75 7470 7574 2069 7320 4e6f 6e65 3a0a  output is None:.
+00024270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024280: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
+00024290: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
+000242a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000242b0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+000242c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000242d0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+000242e0: 203d 206f 7574 7075 7420 2b20 6368 756e   = output + chun
+000242f0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+00024300: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
+00024310: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00024320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024330: 6f75 7470 7574 203d 2063 6875 6e6b 0a20  output = chunk. 
+00024340: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00024350: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+00024360: 3d20 6361 6c6c 5f66 756e 635f 7769 7468  = call_func_with
+00024370: 5f76 6172 6961 626c 655f 6172 6773 280a  _variable_args(.
+00024380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024390: 7365 6c66 2e66 756e 632c 2063 6173 7428  self.func, cast(
+000243a0: 496e 7075 742c 2066 696e 616c 292c 2063  Input, final), c
+000243b0: 6f6e 6669 672c 2072 756e 5f6d 616e 6167  onfig, run_manag
+000243c0: 6572 2c20 2a2a 6b77 6172 6773 0a20 2020  er, **kwargs.   
+000243d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000243e0: 2020 2020 2320 4966 2074 6865 206f 7574      # If the out
+000243f0: 7075 7420 6973 2061 2072 756e 6e61 626c  put is a runnabl
+00024400: 652c 2075 7365 2069 7473 2073 7472 6561  e, use its strea
+00024410: 6d20 6f75 7470 7574 0a20 2020 2020 2020  m output.       
+00024420: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+00024430: 7574 7075 742c 2052 756e 6e61 626c 6529  utput, Runnable)
+00024440: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00024450: 6375 7273 696f 6e5f 6c69 6d69 7420 3d20  cursion_limit = 
+00024460: 636f 6e66 6967 5b22 7265 6375 7273 696f  config["recursio
+00024470: 6e5f 6c69 6d69 7422 5d0a 2020 2020 2020  n_limit"].      
+00024480: 2020 2020 2020 6966 2072 6563 7572 7369        if recursi
+00024490: 6f6e 5f6c 696d 6974 203c 3d20 303a 0a20  on_limit <= 0:. 
+000244a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000244b0: 6169 7365 2052 6563 7572 7369 6f6e 4572  aise RecursionEr
+000244c0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+000244d0: 2020 2020 2020 2020 2066 2252 6563 7572           f"Recur
+000244e0: 7369 6f6e 206c 696d 6974 2072 6561 6368  sion limit reach
+000244f0: 6564 2077 6865 6e20 696e 766f 6b69 6e67  ed when invoking
+00024500: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00024510: 2020 2020 2020 2066 227b 7365 6c66 7d20         f"{self} 
+00024520: 7769 7468 2069 6e70 7574 207b 6669 6e61  with input {fina
+00024530: 6c7d 2e22 0a20 2020 2020 2020 2020 2020  l}.".           
+00024540: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00024550: 2020 2066 6f72 2063 6875 6e6b 2069 6e20     for chunk in 
+00024560: 6f75 7470 7574 2e73 7472 6561 6d28 0a20  output.stream(. 
+00024570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00024580: 696e 616c 2c0a 2020 2020 2020 2020 2020  inal,.          
+00024590: 2020 2020 2020 7061 7463 685f 636f 6e66        patch_conf
+000245a0: 6967 280a 2020 2020 2020 2020 2020 2020  ig(.            
+000245b0: 2020 2020 2020 2020 636f 6e66 6967 2c0a          config,.
+000245c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000245d0: 2020 2020 6361 6c6c 6261 636b 733d 7275      callbacks=ru
+000245e0: 6e5f 6d61 6e61 6765 722e 6765 745f 6368  n_manager.get_ch
+000245f0: 696c 6428 292c 0a20 2020 2020 2020 2020  ild(),.         
+00024600: 2020 2020 2020 2020 2020 2072 6563 7572             recur
+00024610: 7369 6f6e 5f6c 696d 6974 3d72 6563 7572  sion_limit=recur
+00024620: 7369 6f6e 5f6c 696d 6974 202d 2031 2c0a  sion_limit - 1,.
+00024630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024640: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00024650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024660: 2020 7969 656c 6420 6368 756e 6b0a 2020    yield chunk.  
+00024670: 2020 2020 2020 656c 6966 206e 6f74 2069        elif not i
+00024680: 6e73 7065 6374 2e69 7367 656e 6572 6174  nspect.isgenerat
+00024690: 6f72 6675 6e63 7469 6f6e 2873 656c 662e  orfunction(self.
+000246a0: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
+000246b0: 2020 2023 204f 7468 6572 7769 7365 2c20     # Otherwise, 
+000246c0: 6a75 7374 2079 6965 6c64 2069 740a 2020  just yield it.  
+000246d0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+000246e0: 6361 7374 284f 7574 7075 742c 206f 7574  cast(Output, out
+000246f0: 7075 7429 0a0a 2020 2020 6465 6620 7472  put)..    def tr
+00024700: 616e 7366 6f72 6d28 0a20 2020 2020 2020  ansform(.       
+00024710: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00024720: 6e70 7574 3a20 4974 6572 6174 6f72 5b49  nput: Iterator[I
+00024730: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
+00024740: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+00024750: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+00024760: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00024770: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+00024780: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+00024790: 3e20 4974 6572 6174 6f72 5b4f 7574 7075  > Iterator[Outpu
+000247a0: 745d 3a0a 2020 2020 2020 2020 6966 2068  t]:.        if h
+000247b0: 6173 6174 7472 2873 656c 662c 2022 6675  asattr(self, "fu
+000247c0: 6e63 2229 3a0a 2020 2020 2020 2020 2020  nc"):.          
+000247d0: 2020 666f 7220 6f75 7470 7574 2069 6e20    for output in 
+000247e0: 7365 6c66 2e5f 7472 616e 7366 6f72 6d5f  self._transform_
+000247f0: 7374 7265 616d 5f77 6974 685f 636f 6e66  stream_with_conf
+00024800: 6967 280a 2020 2020 2020 2020 2020 2020  ig(.            
+00024810: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
+00024820: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00024830: 5f74 7261 6e73 666f 726d 2c0a 2020 2020  _transform,.    
+00024840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00024850: 2e5f 636f 6e66 6967 2863 6f6e 6669 672c  ._config(config,
+00024860: 2073 656c 662e 6675 6e63 292c 0a20 2020   self.func),.   
+00024870: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
+00024880: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
+00024890: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+000248a0: 2020 2020 2020 7969 656c 6420 6f75 7470        yield outp
+000248b0: 7574 0a20 2020 2020 2020 2065 6c73 653a  ut.        else:
+000248c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000248d0: 7365 2054 7970 6545 7272 6f72 280a 2020  se TypeError(.  
+000248e0: 2020 2020 2020 2020 2020 2020 2020 2243                "C
+000248f0: 616e 6e6f 7420 7374 7265 616d 2061 2063  annot stream a c
+00024900: 6f72 6f75 7469 6e65 2066 756e 6374 696f  oroutine functio
+00024910: 6e20 7379 6e63 6872 6f6e 6f75 736c 792e  n synchronously.
+00024920: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00024930: 2020 2255 7365 2060 6173 7472 6561 6d60    "Use `astream`
+00024940: 2069 6e73 7465 6164 2e22 0a20 2020 2020   instead.".     
+00024950: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00024960: 6620 7374 7265 616d 280a 2020 2020 2020  f stream(.      
+00024970: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00024980: 696e 7075 743a 2049 6e70 7574 2c0a 2020  input: Input,.  
+00024990: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+000249a0: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+000249b0: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
+000249c0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+000249d0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+000249e0: 2020 2020 2920 2d3e 2049 7465 7261 746f      ) -> Iterato
+000249f0: 725b 4f75 7470 7574 5d3a 0a20 2020 2020  r[Output]:.     
+00024a00: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
+00024a10: 7261 6e73 666f 726d 2869 7465 7228 5b69  ransform(iter([i
+00024a20: 6e70 7574 5d29 2c20 636f 6e66 6967 2c20  nput]), config, 
+00024a30: 2a2a 6b77 6172 6773 290a 0a20 2020 2061  **kwargs)..    a
+00024a40: 7379 6e63 2064 6566 205f 6174 7261 6e73  sync def _atrans
+00024a50: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
+00024a60: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+00024a70: 743a 2041 7379 6e63 4974 6572 6174 6f72  t: AsyncIterator
+00024a80: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+00024a90: 2072 756e 5f6d 616e 6167 6572 3a20 4173   run_manager: As
+00024aa0: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
+00024ab0: 6572 466f 7243 6861 696e 5275 6e2c 0a20  erForChainRun,. 
+00024ac0: 2020 2020 2020 2063 6f6e 6669 673a 2052         config: R
+00024ad0: 756e 6e61 626c 6543 6f6e 6669 672c 0a20  unnableConfig,. 
+00024ae0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00024af0: 2041 6e79 2c0a 2020 2020 2920 2d3e 2041   Any,.    ) -> A
+00024b00: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
+00024b10: 7075 745d 3a0a 2020 2020 2020 2020 6669  put]:.        fi
+00024b20: 6e61 6c3a 2049 6e70 7574 0a20 2020 2020  nal: Input.     
+00024b30: 2020 2067 6f74 5f66 6972 7374 5f76 616c     got_first_val
+00024b40: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00024b50: 2061 7379 6e63 2066 6f72 2069 6368 756e   async for ichun
+00024b60: 6b20 696e 2069 6e70 7574 3a0a 2020 2020  k in input:.    
+00024b70: 2020 2020 2020 2020 2320 4279 2064 6566          # By def
+00024b80: 696e 6974 696f 6e73 2c20 5275 6e6e 6162  initions, Runnab
+00024b90: 6c65 4c61 6d62 6461 7320 636f 6e73 756d  leLambdas consum
+00024ba0: 6520 616c 6c20 696e 7075 7420 6265 666f  e all input befo
+00024bb0: 7265 2065 6d69 7474 696e 6720 6f75 7470  re emitting outp
+00024bc0: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
+00024bd0: 2320 4966 2074 6865 2069 6e70 7574 2069  # If the input i
+00024be0: 7320 6e6f 7420 6164 6461 626c 652c 2074  s not addable, t
+00024bf0: 6865 6e20 7765 276c 6c20 6173 7375 6d65  hen we'll assume
+00024c00: 2074 6861 7420 7765 2063 616e 0a20 2020   that we can.   
+00024c10: 2020 2020 2020 2020 2023 206f 6e6c 7920           # only 
+00024c20: 6f70 6572 6174 6520 6f6e 2074 6865 206c  operate on the l
+00024c30: 6173 7420 6368 756e 6b2e 0a20 2020 2020  ast chunk..     
+00024c40: 2020 2020 2020 2023 2053 6f20 7765 276c         # So we'l
+00024c50: 6c20 6974 6572 6174 6520 756e 7469 6c20  l iterate until 
+00024c60: 7765 2067 6574 2074 6f20 7468 6520 6c61  we get to the la
+00024c70: 7374 2063 6875 6e6b 210a 2020 2020 2020  st chunk!.      
+00024c80: 2020 2020 2020 6966 206e 6f74 2067 6f74        if not got
+00024c90: 5f66 6972 7374 5f76 616c 3a0a 2020 2020  _first_val:.    
+00024ca0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+00024cb0: 6c20 3d20 6963 6875 6e6b 0a20 2020 2020  l = ichunk.     
+00024cc0: 2020 2020 2020 2020 2020 2067 6f74 5f66             got_f
+00024cd0: 6972 7374 5f76 616c 203d 2054 7275 650a  irst_val = True.
+00024ce0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00024cf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024d00: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00024d10: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00024d20: 203d 2066 696e 616c 202b 2069 6368 756e   = final + ichun
+00024d30: 6b20 2023 2074 7970 653a 2069 676e 6f72  k  # type: ignor
+00024d40: 655b 6f70 6572 6174 6f72 5d0a 2020 2020  e[operator].    
+00024d50: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00024d60: 7074 2054 7970 6545 7272 6f72 3a0a 2020  pt TypeError:.  
+00024d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d80: 2020 6669 6e61 6c20 3d20 6963 6875 6e6b    final = ichunk
+00024d90: 0a0a 2020 2020 2020 2020 6966 2068 6173  ..        if has
+00024da0: 6174 7472 2873 656c 662c 2022 6166 756e  attr(self, "afun
+00024db0: 6322 293a 0a20 2020 2020 2020 2020 2020  c"):.           
+00024dc0: 2061 6675 6e63 203d 2073 656c 662e 6166   afunc = self.af
+00024dd0: 756e 630a 2020 2020 2020 2020 656c 7365  unc.        else
+00024de0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00024df0: 2069 6e73 7065 6374 2e69 7367 656e 6572   inspect.isgener
+00024e00: 6174 6f72 6675 6e63 7469 6f6e 2873 656c  atorfunction(sel
+00024e10: 662e 6675 6e63 293a 0a20 2020 2020 2020  f.func):.       
+00024e20: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+00024e30: 7970 6545 7272 6f72 280a 2020 2020 2020  ypeError(.      
+00024e40: 2020 2020 2020 2020 2020 2020 2020 2243                "C
+00024e50: 616e 6e6f 7420 7374 7265 616d 2066 726f  annot stream fro
+00024e60: 6d20 6120 6765 6e65 7261 746f 7220 6675  m a generator fu
+00024e70: 6e63 7469 6f6e 2061 7379 6e63 6872 6f6e  nction asynchron
+00024e80: 6f75 736c 792e 220a 2020 2020 2020 2020  ously.".        
+00024e90: 2020 2020 2020 2020 2020 2020 2255 7365              "Use
+00024ea0: 202e 7374 7265 616d 2829 2069 6e73 7465   .stream() inste
+00024eb0: 6164 2e22 0a20 2020 2020 2020 2020 2020  ad.".           
+00024ec0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00024ed0: 2020 2020 6465 6620 6675 6e63 280a 2020      def func(.  
+00024ee0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00024ef0: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+00024f00: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+00024f10: 6d61 6e61 6765 723a 2041 7379 6e63 4361  manager: AsyncCa
+00024f20: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+00024f30: 4368 6169 6e52 756e 2c0a 2020 2020 2020  ChainRun,.      
+00024f40: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00024f50: 3a20 5275 6e6e 6162 6c65 436f 6e66 6967  : RunnableConfig
+00024f60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024f70: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+00024f80: 0a20 2020 2020 2020 2020 2020 2029 202d  .            ) -
+00024f90: 3e20 4f75 7470 7574 3a0a 2020 2020 2020  > Output:.      
+00024fa0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00024fb0: 2063 616c 6c5f 6675 6e63 5f77 6974 685f   call_func_with_
+00024fc0: 7661 7269 6162 6c65 5f61 7267 7328 0a20  variable_args(. 
+00024fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fe0: 2020 2073 656c 662e 6675 6e63 2c20 696e     self.func, in
+00024ff0: 7075 742c 2063 6f6e 6669 672c 2072 756e  put, config, run
+00025000: 5f6d 616e 6167 6572 2e67 6574 5f73 796e  _manager.get_syn
+00025010: 6328 292c 202a 2a6b 7761 7267 730a 2020  c(), **kwargs.  
+00025020: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00025030: 0a20 2020 2020 2020 2020 2020 2040 7772  .            @wr
+00025040: 6170 7328 6675 6e63 290a 2020 2020 2020  aps(func).      
+00025050: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
+00025060: 6628 2a61 7267 732c 202a 2a6b 7761 7267  f(*args, **kwarg
+00025070: 7329 3a20 2023 2074 7970 653a 2069 676e  s):  # type: ign
+00025080: 6f72 655b 6e6f 2d75 6e74 7970 6564 2d64  ore[no-untyped-d
+00025090: 6566 5d0a 2020 2020 2020 2020 2020 2020  ef].            
+000250a0: 2020 2020 7265 7475 726e 2061 7761 6974      return await
+000250b0: 2072 756e 5f69 6e5f 6578 6563 7574 6f72   run_in_executor
+000250c0: 2863 6f6e 6669 672c 2066 756e 632c 202a  (config, func, *
+000250d0: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+000250e0: 0a20 2020 2020 2020 2020 2020 2061 6675  .            afu
+000250f0: 6e63 203d 2066 0a0a 2020 2020 2020 2020  nc = f..        
+00025100: 6966 2069 735f 6173 796e 635f 6765 6e65  if is_async_gene
+00025110: 7261 746f 7228 6166 756e 6329 3a0a 2020  rator(afunc):.  
+00025120: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00025130: 3a20 4f70 7469 6f6e 616c 5b4f 7574 7075  : Optional[Outpu
+00025140: 745d 203d 204e 6f6e 650a 2020 2020 2020  t] = None.      
+00025150: 2020 2020 2020 6173 796e 6320 666f 7220        async for 
+00025160: 6368 756e 6b20 696e 2063 6173 7428 0a20  chunk in cast(. 
+00025170: 2020 2020 2020 2020 2020 2020 2020 2041                 A
+00025180: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
+00025190: 7075 745d 2c0a 2020 2020 2020 2020 2020  put],.          
+000251a0: 2020 2020 2020 6163 616c 6c5f 6675 6e63        acall_func
+000251b0: 5f77 6974 685f 7661 7269 6162 6c65 5f61  _with_variable_a
+000251c0: 7267 7328 0a20 2020 2020 2020 2020 2020  rgs(.           
+000251d0: 2020 2020 2020 2020 2063 6173 7428 4361           cast(Ca
+000251e0: 6c6c 6162 6c65 2c20 6166 756e 6329 2c0a  llable, afunc),.
+000251f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025200: 2020 2020 6361 7374 2849 6e70 7574 2c20      cast(Input, 
+00025210: 6669 6e61 6c29 2c0a 2020 2020 2020 2020  final),.        
+00025220: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00025230: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
+00025240: 2020 2020 2020 2020 7275 6e5f 6d61 6e61          run_mana
+00025250: 6765 722c 0a20 2020 2020 2020 2020 2020  ger,.           
+00025260: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00025270: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00025280: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00025290: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+000252a0: 2020 2020 2079 6965 6c64 2063 6875 6e6b       yield chunk
+000252b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000252c0: 2069 6620 6f75 7470 7574 2069 7320 4e6f   if output is No
+000252d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000252e0: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+000252f0: 2063 6875 6e6b 0a20 2020 2020 2020 2020   chunk.         
+00025300: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00025310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025320: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00025330: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00025340: 7470 7574 203d 206f 7574 7075 7420 2b20  tput = output + 
+00025350: 6368 756e 6b20 2023 2074 7970 653a 2069  chunk  # type: i
+00025360: 676e 6f72 655b 6f70 6572 6174 6f72 5d0a  gnore[operator].
+00025370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025380: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
+00025390: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+000253a0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+000253b0: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
+000253c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000253d0: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+000253e0: 6177 6169 7420 6163 616c 6c5f 6675 6e63  await acall_func
+000253f0: 5f77 6974 685f 7661 7269 6162 6c65 5f61  _with_variable_a
+00025400: 7267 7328 0a20 2020 2020 2020 2020 2020  rgs(.           
+00025410: 2020 2020 2063 6173 7428 4361 6c6c 6162       cast(Callab
+00025420: 6c65 2c20 6166 756e 6329 2c20 6361 7374  le, afunc), cast
+00025430: 2849 6e70 7574 2c20 6669 6e61 6c29 2c20  (Input, final), 
+00025440: 636f 6e66 6967 2c20 7275 6e5f 6d61 6e61  config, run_mana
+00025450: 6765 722c 202a 2a6b 7761 7267 730a 2020  ger, **kwargs.  
+00025460: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00025470: 2020 2020 2023 2049 6620 7468 6520 6f75       # If the ou
+00025480: 7470 7574 2069 7320 6120 7275 6e6e 6162  tput is a runnab
+00025490: 6c65 2c20 7573 6520 6974 7320 6173 7472  le, use its astr
+000254a0: 6561 6d20 6f75 7470 7574 0a20 2020 2020  eam output.     
+000254b0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000254c0: 286f 7574 7075 742c 2052 756e 6e61 626c  (output, Runnabl
+000254d0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+000254e0: 7265 6375 7273 696f 6e5f 6c69 6d69 7420  recursion_limit 
+000254f0: 3d20 636f 6e66 6967 5b22 7265 6375 7273  = config["recurs
+00025500: 696f 6e5f 6c69 6d69 7422 5d0a 2020 2020  ion_limit"].    
+00025510: 2020 2020 2020 2020 6966 2072 6563 7572          if recur
+00025520: 7369 6f6e 5f6c 696d 6974 203c 3d20 303a  sion_limit <= 0:
+00025530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025540: 2072 6169 7365 2052 6563 7572 7369 6f6e   raise Recursion
+00025550: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00025560: 2020 2020 2020 2020 2020 2066 2252 6563             f"Rec
+00025570: 7572 7369 6f6e 206c 696d 6974 2072 6561  ursion limit rea
+00025580: 6368 6564 2077 6865 6e20 696e 766f 6b69  ched when invoki
+00025590: 6e67 2022 0a20 2020 2020 2020 2020 2020  ng ".           
+000255a0: 2020 2020 2020 2020 2066 227b 7365 6c66           f"{self
+000255b0: 7d20 7769 7468 2069 6e70 7574 207b 6669  } with input {fi
+000255c0: 6e61 6c7d 2e22 0a20 2020 2020 2020 2020  nal}.".         
+000255d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000255e0: 2020 2020 2061 7379 6e63 2066 6f72 2063       async for c
+000255f0: 6875 6e6b 2069 6e20 6f75 7470 7574 2e61  hunk in output.a
+00025600: 7374 7265 616d 280a 2020 2020 2020 2020  stream(.        
+00025610: 2020 2020 2020 2020 6669 6e61 6c2c 0a20          final,. 
+00025620: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00025630: 6174 6368 5f63 6f6e 6669 6728 0a20 2020  atch_config(.   
+00025640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025650: 2063 6f6e 6669 672c 0a20 2020 2020 2020   config,.       
+00025660: 2020 2020 2020 2020 2020 2020 2063 616c               cal
+00025670: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
+00025680: 6572 2e67 6574 5f63 6869 6c64 2829 2c0a  er.get_child(),.
+00025690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256a0: 2020 2020 7265 6375 7273 696f 6e5f 6c69      recursion_li
+000256b0: 6d69 743d 7265 6375 7273 696f 6e5f 6c69  mit=recursion_li
+000256c0: 6d69 7420 2d20 312c 0a20 2020 2020 2020  mit - 1,.       
+000256d0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+000256e0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+000256f0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+00025700: 2063 6875 6e6b 0a20 2020 2020 2020 2065   chunk.        e
+00025710: 6c69 6620 6e6f 7420 6973 5f61 7379 6e63  lif not is_async
+00025720: 5f67 656e 6572 6174 6f72 2861 6675 6e63  _generator(afunc
+00025730: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+00025740: 204f 7468 6572 7769 7365 2c20 6a75 7374   Otherwise, just
+00025750: 2079 6965 6c64 2069 740a 2020 2020 2020   yield it.      
+00025760: 2020 2020 2020 7969 656c 6420 6361 7374        yield cast
+00025770: 284f 7574 7075 742c 206f 7574 7075 7429  (Output, output)
+00025780: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00025790: 6174 7261 6e73 666f 726d 280a 2020 2020  atransform(.    
+000257a0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000257b0: 2020 696e 7075 743a 2041 7379 6e63 4974    input: AsyncIt
+000257c0: 6572 6174 6f72 5b49 6e70 7574 5d2c 0a20  erator[Input],. 
+000257d0: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
+000257e0: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+000257f0: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
+00025800: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00025810: 3a20 4f70 7469 6f6e 616c 5b41 6e79 5d2c  : Optional[Any],
+00025820: 0a20 2020 2029 202d 3e20 4173 796e 6349  .    ) -> AsyncI
+00025830: 7465 7261 746f 725b 4f75 7470 7574 5d3a  terator[Output]:
+00025840: 0a20 2020 2020 2020 2061 7379 6e63 2066  .        async f
+00025850: 6f72 206f 7574 7075 7420 696e 2073 656c  or output in sel
+00025860: 662e 5f61 7472 616e 7366 6f72 6d5f 7374  f._atransform_st
+00025870: 7265 616d 5f77 6974 685f 636f 6e66 6967  ream_with_config
+00025880: 280a 2020 2020 2020 2020 2020 2020 696e  (.            in
+00025890: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+000258a0: 2073 656c 662e 5f61 7472 616e 7366 6f72   self._atransfor
+000258b0: 6d2c 0a20 2020 2020 2020 2020 2020 2073  m,.            s
+000258c0: 656c 662e 5f63 6f6e 6669 6728 636f 6e66  elf._config(conf
+000258d0: 6967 2c20 7365 6c66 2e61 6675 6e63 2069  ig, self.afunc i
+000258e0: 6620 6861 7361 7474 7228 7365 6c66 2c20  f hasattr(self, 
+000258f0: 2261 6675 6e63 2229 2065 6c73 6520 7365  "afunc") else se
+00025900: 6c66 2e66 756e 6329 2c0a 2020 2020 2020  lf.func),.      
+00025910: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+00025920: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00025930: 2020 2020 2020 2079 6965 6c64 206f 7574         yield out
+00025940: 7075 740a 0a20 2020 2061 7379 6e63 2064  put..    async d
+00025950: 6566 2061 7374 7265 616d 280a 2020 2020  ef astream(.    
+00025960: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00025970: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
+00025980: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+00025990: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+000259a0: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
+000259b0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+000259c0: 733a 204f 7074 696f 6e61 6c5b 416e 795d  s: Optional[Any]
+000259d0: 2c0a 2020 2020 2920 2d3e 2041 7379 6e63  ,.    ) -> Async
+000259e0: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
+000259f0: 3a0a 2020 2020 2020 2020 6173 796e 6320  :.        async 
+00025a00: 6465 6620 696e 7075 745f 6169 7465 7228  def input_aiter(
+00025a10: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
+00025a20: 6f72 5b49 6e70 7574 5d3a 0a20 2020 2020  or[Input]:.     
+00025a30: 2020 2020 2020 2079 6965 6c64 2069 6e70         yield inp
+00025a40: 7574 0a0a 2020 2020 2020 2020 6173 796e  ut..        asyn
+00025a50: 6320 666f 7220 6368 756e 6b20 696e 2073  c for chunk in s
+00025a60: 656c 662e 6174 7261 6e73 666f 726d 2869  elf.atransform(i
+00025a70: 6e70 7574 5f61 6974 6572 2829 2c20 636f  nput_aiter(), co
+00025a80: 6e66 6967 2c20 2a2a 6b77 6172 6773 293a  nfig, **kwargs):
+00025a90: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+00025aa0: 6c64 2063 6875 6e6b 0a0a 0a63 6c61 7373  ld chunk...class
+00025ab0: 2052 756e 6e61 626c 6545 6163 6842 6173   RunnableEachBas
+00025ac0: 6528 5275 6e6e 6162 6c65 5365 7269 616c  e(RunnableSerial
+00025ad0: 697a 6162 6c65 5b4c 6973 745b 496e 7075  izable[List[Inpu
+00025ae0: 745d 2c20 4c69 7374 5b4f 7574 7075 745d  t], List[Output]
+00025af0: 5d29 3a0a 2020 2020 2222 2252 756e 6e61  ]):.    """Runna
+00025b00: 626c 6520 7468 6174 2064 656c 6567 6174  ble that delegat
+00025b10: 6573 2063 616c 6c73 2074 6f20 616e 6f74  es calls to anot
+00025b20: 6865 7220 5275 6e6e 6162 6c65 0a20 2020  her Runnable.   
+00025b30: 2077 6974 6820 6561 6368 2065 6c65 6d65   with each eleme
+00025b40: 6e74 206f 6620 7468 6520 696e 7075 7420  nt of the input 
+00025b50: 7365 7175 656e 6365 2e0a 0a20 2020 2055  sequence...    U
+00025b60: 7365 206f 6e6c 7920 6966 2063 7265 6174  se only if creat
+00025b70: 696e 6720 6120 6e65 7720 5275 6e6e 6162  ing a new Runnab
+00025b80: 6c65 4561 6368 2073 7562 636c 6173 7320  leEach subclass 
+00025b90: 7769 7468 2064 6966 6665 7265 6e74 205f  with different _
+00025ba0: 5f69 6e69 745f 5f20 6172 6773 2e0a 0a20  _init__ args... 
+00025bb0: 2020 2053 6565 2064 6f63 756d 656e 7461     See documenta
+00025bc0: 7469 6f6e 2066 6f72 2052 756e 6e61 626c  tion for Runnabl
+00025bd0: 6545 6163 6820 666f 7220 6d6f 7265 2064  eEach for more d
+00025be0: 6574 6169 6c73 2e0a 2020 2020 2222 220a  etails..    """.
+00025bf0: 0a20 2020 2062 6f75 6e64 3a20 5275 6e6e  .    bound: Runn
+00025c00: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
+00025c10: 7574 5d0a 0a20 2020 2063 6c61 7373 2043  ut]..    class C
+00025c20: 6f6e 6669 673a 0a20 2020 2020 2020 2061  onfig:.        a
+00025c30: 7262 6974 7261 7279 5f74 7970 6573 5f61  rbitrary_types_a
+00025c40: 6c6c 6f77 6564 203d 2054 7275 650a 0a20  llowed = True.. 
+00025c50: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00025c60: 2064 6566 2049 6e70 7574 5479 7065 2873   def InputType(s
+00025c70: 656c 6629 202d 3e20 416e 793a 0a20 2020  elf) -> Any:.   
+00025c80: 2020 2020 2072 6574 7572 6e20 4c69 7374       return List
+00025c90: 5b73 656c 662e 626f 756e 642e 496e 7075  [self.bound.Inpu
+00025ca0: 7454 7970 655d 2020 2320 7479 7065 3a20  tType]  # type: 
+00025cb0: 6967 6e6f 7265 5b6e 616d 652d 6465 6669  ignore[name-defi
+00025cc0: 6e65 645d 0a0a 2020 2020 6465 6620 6765  ned]..    def ge
+00025cd0: 745f 696e 7075 745f 7363 6865 6d61 280a  t_input_schema(.
+00025ce0: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
+00025cf0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00025d00: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+00025d10: 204e 6f6e 650a 2020 2020 2920 2d3e 2054   None.    ) -> T
+00025d20: 7970 655b 4261 7365 4d6f 6465 6c5d 3a0a  ype[BaseModel]:.
+00025d30: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00025d40: 7265 6174 655f 6d6f 6465 6c28 0a20 2020  reate_model(.   
+00025d50: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
+00025d60: 745f 6e61 6d65 2822 496e 7075 7422 292c  t_name("Input"),
+00025d70: 0a20 2020 2020 2020 2020 2020 205f 5f72  .            __r
+00025d80: 6f6f 745f 5f3d 280a 2020 2020 2020 2020  oot__=(.        
+00025d90: 2020 2020 2020 2020 4c69 7374 5b73 656c          List[sel
+00025da0: 662e 626f 756e 642e 6765 745f 696e 7075  f.bound.get_inpu
+00025db0: 745f 7363 6865 6d61 2863 6f6e 6669 6729  t_schema(config)
+00025dc0: 5d2c 2020 2320 7479 7065 3a20 6967 6e6f  ],  # type: igno
+00025dd0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00025de0: 2020 204e 6f6e 652c 0a20 2020 2020 2020     None,.       
+00025df0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00025e00: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+00025e10: 0a20 2020 2064 6566 204f 7574 7075 7454  .    def OutputT
+00025e20: 7970 6528 7365 6c66 2920 2d3e 2054 7970  ype(self) -> Typ
+00025e30: 655b 4c69 7374 5b4f 7574 7075 745d 5d3a  e[List[Output]]:
+00025e40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00025e50: 4c69 7374 5b73 656c 662e 626f 756e 642e  List[self.bound.
+00025e60: 4f75 7470 7574 5479 7065 5d20 2023 2074  OutputType]  # t
+00025e70: 7970 653a 2069 676e 6f72 655b 6e61 6d65  ype: ignore[name
+00025e80: 2d64 6566 696e 6564 5d0a 0a20 2020 2064  -defined]..    d
+00025e90: 6566 2067 6574 5f6f 7574 7075 745f 7363  ef get_output_sc
+00025ea0: 6865 6d61 280a 2020 2020 2020 2020 7365  hema(.        se
+00025eb0: 6c66 2c20 636f 6e66 6967 3a20 4f70 7469  lf, config: Opti
+00025ec0: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00025ed0: 6669 675d 203d 204e 6f6e 650a 2020 2020  fig] = None.    
+00025ee0: 2920 2d3e 2054 7970 655b 4261 7365 4d6f  ) -> Type[BaseMo
+00025ef0: 6465 6c5d 3a0a 2020 2020 2020 2020 7363  del]:.        sc
+00025f00: 6865 6d61 203d 2073 656c 662e 626f 756e  hema = self.boun
+00025f10: 642e 6765 745f 6f75 7470 7574 5f73 6368  d.get_output_sch
+00025f20: 656d 6128 636f 6e66 6967 290a 2020 2020  ema(config).    
+00025f30: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
+00025f40: 655f 6d6f 6465 6c28 0a20 2020 2020 2020  e_model(.       
+00025f50: 2020 2020 2073 656c 662e 6765 745f 6e61       self.get_na
+00025f60: 6d65 2822 4f75 7470 7574 2229 2c0a 2020  me("Output"),.  
+00025f70: 2020 2020 2020 2020 2020 5f5f 726f 6f74            __root
+00025f80: 5f5f 3d28 0a20 2020 2020 2020 2020 2020  __=(.           
+00025f90: 2020 2020 204c 6973 745b 7363 6865 6d61       List[schema
+00025fa0: 5d2c 2020 2320 7479 7065 3a20 6967 6e6f  ],  # type: igno
+00025fb0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00025fc0: 2020 204e 6f6e 652c 0a20 2020 2020 2020     None,.       
+00025fd0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00025fe0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+00025ff0: 0a20 2020 2064 6566 2063 6f6e 6669 675f  .    def config_
+00026000: 7370 6563 7328 7365 6c66 2920 2d3e 204c  specs(self) -> L
+00026010: 6973 745b 436f 6e66 6967 7572 6162 6c65  ist[Configurable
+00026020: 4669 656c 6453 7065 635d 3a0a 2020 2020  FieldSpec]:.    
+00026030: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00026040: 626f 756e 642e 636f 6e66 6967 5f73 7065  bound.config_spe
+00026050: 6373 0a0a 2020 2020 6465 6620 6765 745f  cs..    def get_
+00026060: 6772 6170 6828 7365 6c66 2c20 636f 6e66  graph(self, conf
+00026070: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+00026080: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+00026090: 6f6e 6529 202d 3e20 4772 6170 683a 0a20  one) -> Graph:. 
+000260a0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000260b0: 6c66 2e62 6f75 6e64 2e67 6574 5f67 7261  lf.bound.get_gra
+000260c0: 7068 2863 6f6e 6669 6729 0a0a 2020 2020  ph(config)..    
+000260d0: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
+000260e0: 2064 6566 2069 735f 6c63 5f73 6572 6961   def is_lc_seria
+000260f0: 6c69 7a61 626c 6528 636c 7329 202d 3e20  lizable(cls) -> 
+00026100: 626f 6f6c 3a0a 2020 2020 2020 2020 7265  bool:.        re
+00026110: 7475 726e 2054 7275 650a 0a20 2020 2040  turn True..    @
+00026120: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
+00026130: 6465 6620 6765 745f 6c63 5f6e 616d 6573  def get_lc_names
+00026140: 7061 6365 2863 6c73 2920 2d3e 204c 6973  pace(cls) -> Lis
+00026150: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
+00026160: 2222 2247 6574 2074 6865 206e 616d 6573  """Get the names
+00026170: 7061 6365 206f 6620 7468 6520 6c61 6e67  pace of the lang
+00026180: 6368 6169 6e20 6f62 6a65 6374 2e22 2222  chain object."""
+00026190: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000261a0: 5b22 6c61 6e67 6368 6169 6e22 2c20 2273  ["langchain", "s
+000261b0: 6368 656d 6122 2c20 2272 756e 6e61 626c  chema", "runnabl
+000261c0: 6522 5d0a 0a20 2020 2064 6566 205f 696e  e"]..    def _in
+000261d0: 766f 6b65 280a 2020 2020 2020 2020 7365  voke(.        se
+000261e0: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+000261f0: 7473 3a20 4c69 7374 5b49 6e70 7574 5d2c  ts: List[Input],
+00026200: 0a20 2020 2020 2020 2072 756e 5f6d 616e  .        run_man
+00026210: 6167 6572 3a20 4361 6c6c 6261 636b 4d61  ager: CallbackMa
+00026220: 6e61 6765 7246 6f72 4368 6169 6e52 756e  nagerForChainRun
+00026230: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+00026240: 3a20 5275 6e6e 6162 6c65 436f 6e66 6967  : RunnableConfig
+00026250: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00026260: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
+00026270: 3e20 4c69 7374 5b4f 7574 7075 745d 3a0a  > List[Output]:.
+00026280: 2020 2020 2020 2020 636f 6e66 6967 7320          configs 
+00026290: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+000262a0: 7061 7463 685f 636f 6e66 6967 2863 6f6e  patch_config(con
+000262b0: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
+000262c0: 756e 5f6d 616e 6167 6572 2e67 6574 5f63  un_manager.get_c
+000262d0: 6869 6c64 2829 2920 666f 7220 5f20 696e  hild()) for _ in
+000262e0: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
+000262f0: 5d0a 2020 2020 2020 2020 7265 7475 726e  ].        return
+00026300: 2073 656c 662e 626f 756e 642e 6261 7463   self.bound.batc
+00026310: 6828 696e 7075 7473 2c20 636f 6e66 6967  h(inputs, config
+00026320: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
+00026330: 2020 6465 6620 696e 766f 6b65 280a 2020    def invoke(.  
+00026340: 2020 2020 2020 7365 6c66 2c20 696e 7075        self, inpu
+00026350: 743a 204c 6973 745b 496e 7075 745d 2c20  t: List[Input], 
+00026360: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00026370: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00026380: 203d 204e 6f6e 652c 202a 2a6b 7761 7267   = None, **kwarg
+00026390: 733a 2041 6e79 0a20 2020 2029 202d 3e20  s: Any.    ) -> 
+000263a0: 4c69 7374 5b4f 7574 7075 745d 3a0a 2020  List[Output]:.  
+000263b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000263c0: 662e 5f63 616c 6c5f 7769 7468 5f63 6f6e  f._call_with_con
+000263d0: 6669 6728 7365 6c66 2e5f 696e 766f 6b65  fig(self._invoke
+000263e0: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
+000263f0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+00026400: 6173 796e 6320 6465 6620 5f61 696e 766f  async def _ainvo
+00026410: 6b65 280a 2020 2020 2020 2020 7365 6c66  ke(.        self
+00026420: 2c0a 2020 2020 2020 2020 696e 7075 7473  ,.        inputs
+00026430: 3a20 4c69 7374 5b49 6e70 7574 5d2c 0a20  : List[Input],. 
+00026440: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+00026450: 6572 3a20 4173 796e 6343 616c 6c62 6163  er: AsyncCallbac
+00026460: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00026470: 5275 6e2c 0a20 2020 2020 2020 2063 6f6e  Run,.        con
+00026480: 6669 673a 2052 756e 6e61 626c 6543 6f6e  fig: RunnableCon
+00026490: 6669 672c 0a20 2020 2020 2020 202a 2a6b  fig,.        **k
+000264a0: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+000264b0: 2920 2d3e 204c 6973 745b 4f75 7470 7574  ) -> List[Output
+000264c0: 5d3a 0a20 2020 2020 2020 2063 6f6e 6669  ]:.        confi
+000264d0: 6773 203d 205b 0a20 2020 2020 2020 2020  gs = [.         
+000264e0: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
+000264f0: 636f 6e66 6967 2c20 6361 6c6c 6261 636b  config, callback
+00026500: 733d 7275 6e5f 6d61 6e61 6765 722e 6765  s=run_manager.ge
+00026510: 745f 6368 696c 6428 2929 2066 6f72 205f  t_child()) for _
+00026520: 2069 6e20 696e 7075 7473 0a20 2020 2020   in inputs.     
+00026530: 2020 205d 0a20 2020 2020 2020 2072 6574     ].        ret
+00026540: 7572 6e20 6177 6169 7420 7365 6c66 2e62  urn await self.b
+00026550: 6f75 6e64 2e61 6261 7463 6828 696e 7075  ound.abatch(inpu
+00026560: 7473 2c20 636f 6e66 6967 732c 202a 2a6b  ts, configs, **k
+00026570: 7761 7267 7329 0a0a 2020 2020 6173 796e  wargs)..    asyn
+00026580: 6320 6465 6620 6169 6e76 6f6b 6528 0a20  c def ainvoke(. 
+00026590: 2020 2020 2020 2073 656c 662c 2069 6e70         self, inp
+000265a0: 7574 3a20 4c69 7374 5b49 6e70 7574 5d2c  ut: List[Input],
+000265b0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+000265c0: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+000265d0: 5d20 3d20 4e6f 6e65 2c20 2a2a 6b77 6172  ] = None, **kwar
+000265e0: 6773 3a20 416e 790a 2020 2020 2920 2d3e  gs: Any.    ) ->
+000265f0: 204c 6973 745b 4f75 7470 7574 5d3a 0a20   List[Output]:. 
+00026600: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+00026610: 6169 7420 7365 6c66 2e5f 6163 616c 6c5f  ait self._acall_
+00026620: 7769 7468 5f63 6f6e 6669 6728 7365 6c66  with_config(self
+00026630: 2e5f 6169 6e76 6f6b 652c 2069 6e70 7574  ._ainvoke, input
+00026640: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
+00026650: 6773 290a 0a20 2020 2061 7379 6e63 2064  gs)..    async d
+00026660: 6566 2061 7374 7265 616d 5f65 7665 6e74  ef astream_event
+00026670: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00026680: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+00026690: 496e 7075 742c 0a20 2020 2020 2020 2063  Input,.        c
+000266a0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+000266b0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+000266c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000266d0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+000266e0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+000266f0: 3e20 4173 796e 6349 7465 7261 746f 725b  > AsyncIterator[
+00026700: 5374 7265 616d 4576 656e 745d 3a0a 2020  StreamEvent]:.  
+00026710: 2020 2020 2020 666f 7220 5f20 696e 2072        for _ in r
+00026720: 616e 6765 2831 293a 0a20 2020 2020 2020  ange(1):.       
+00026730: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+00026740: 706c 656d 656e 7465 6445 7272 6f72 280a  plementedError(.
+00026750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026760: 2252 756e 6e61 626c 6545 6163 6820 646f  "RunnableEach do
+00026770: 6573 206e 6f74 2073 7570 706f 7274 2061  es not support a
+00026780: 7374 7265 616d 5f65 7665 6e74 7320 7965  stream_events ye
+00026790: 742e 220a 2020 2020 2020 2020 2020 2020  t.".            
+000267a0: 290a 2020 2020 2020 2020 2020 2020 7969  ).            yi
+000267b0: 656c 640a 0a0a 636c 6173 7320 5275 6e6e  eld...class Runn
+000267c0: 6162 6c65 4561 6368 2852 756e 6e61 626c  ableEach(Runnabl
+000267d0: 6545 6163 6842 6173 655b 496e 7075 742c  eEachBase[Input,
+000267e0: 204f 7574 7075 745d 293a 0a20 2020 2022   Output]):.    "
+000267f0: 2222 5275 6e6e 6162 6c65 2074 6861 7420  ""Runnable that 
+00026800: 6465 6c65 6761 7465 7320 6361 6c6c 7320  delegates calls 
+00026810: 746f 2061 6e6f 7468 6572 2052 756e 6e61  to another Runna
+00026820: 626c 650a 2020 2020 7769 7468 2065 6163  ble.    with eac
+00026830: 6820 656c 656d 656e 7420 6f66 2074 6865  h element of the
+00026840: 2069 6e70 7574 2073 6571 7565 6e63 652e   input sequence.
+00026850: 0a0a 2020 2020 4974 2061 6c6c 6f77 7320  ..    It allows 
+00026860: 796f 7520 746f 2063 616c 6c20 6d75 6c74  you to call mult
+00026870: 6970 6c65 2069 6e70 7574 7320 7769 7468  iple inputs with
+00026880: 2074 6865 2062 6f75 6e64 6564 2052 756e   the bounded Run
+00026890: 6e61 626c 652e 0a0a 2020 2020 5275 6e6e  nable...    Runn
+000268a0: 6162 6c65 4561 6368 206d 616b 6573 2069  ableEach makes i
+000268b0: 7420 6561 7379 2074 6f20 7275 6e20 6d75  t easy to run mu
+000268c0: 6c74 6970 6c65 2069 6e70 7574 7320 666f  ltiple inputs fo
+000268d0: 7220 7468 6520 7275 6e6e 6162 6c65 2e0a  r the runnable..
+000268e0: 2020 2020 496e 2074 6865 2062 656c 6f77      In the below
+000268f0: 2065 7861 6d70 6c65 2c20 7765 2061 7373   example, we ass
+00026900: 6f63 6961 7465 2061 6e64 2072 756e 2074  ociate and run t
+00026910: 6872 6565 2069 6e70 7574 730a 2020 2020  hree inputs.    
+00026920: 7769 7468 2061 2052 756e 6e61 626c 653a  with a Runnable:
+00026930: 0a0a 2020 2020 2020 2020 2e2e 2063 6f64  ..        .. cod
+00026940: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
+00026950: 0a0a 2020 2020 2020 2020 2020 2020 6672  ..            fr
+00026960: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+00026970: 652e 7275 6e6e 6162 6c65 732e 6261 7365  e.runnables.base
+00026980: 2069 6d70 6f72 7420 5275 6e6e 6162 6c65   import Runnable
+00026990: 4561 6368 0a20 2020 2020 2020 2020 2020  Each.           
+000269a0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+000269b0: 6f70 656e 6169 2069 6d70 6f72 7420 4368  openai import Ch
+000269c0: 6174 4f70 656e 4149 0a20 2020 2020 2020  atOpenAI.       
+000269d0: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+000269e0: 6169 6e5f 636f 7265 2e70 726f 6d70 7473  ain_core.prompts
+000269f0: 2069 6d70 6f72 7420 4368 6174 5072 6f6d   import ChatProm
+00026a00: 7074 5465 6d70 6c61 7465 0a20 2020 2020  ptTemplate.     
+00026a10: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
+00026a20: 6368 6169 6e5f 636f 7265 2e6f 7574 7075  chain_core.outpu
+00026a30: 745f 7061 7273 6572 7320 696d 706f 7274  t_parsers import
+00026a40: 2053 7472 4f75 7470 7574 5061 7273 6572   StrOutputParser
+00026a50: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+00026a60: 6d70 7420 3d20 4368 6174 5072 6f6d 7074  mpt = ChatPrompt
+00026a70: 5465 6d70 6c61 7465 2e66 726f 6d5f 7465  Template.from_te
+00026a80: 6d70 6c61 7465 2822 5465 6c6c 206d 6520  mplate("Tell me 
+00026a90: 6120 7368 6f72 7420 6a6f 6b65 2061 626f  a short joke abo
+00026aa0: 7574 0a20 2020 2020 2020 2020 2020 207b  ut.            {
+00026ab0: 746f 7069 637d 2229 0a20 2020 2020 2020  topic}").       
+00026ac0: 2020 2020 206d 6f64 656c 203d 2043 6861       model = Cha
+00026ad0: 744f 7065 6e41 4928 290a 2020 2020 2020  tOpenAI().      
+00026ae0: 2020 2020 2020 6f75 7470 7574 5f70 6172        output_par
+00026af0: 7365 7220 3d20 5374 724f 7574 7075 7450  ser = StrOutputP
+00026b00: 6172 7365 7228 290a 2020 2020 2020 2020  arser().        
+00026b10: 2020 2020 7275 6e6e 6162 6c65 203d 2070      runnable = p
+00026b20: 726f 6d70 7420 7c20 6d6f 6465 6c20 7c20  rompt | model | 
+00026b30: 6f75 7470 7574 5f70 6172 7365 720a 2020  output_parser.  
+00026b40: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
+00026b50: 6c65 5f65 6163 6820 3d20 5275 6e6e 6162  le_each = Runnab
+00026b60: 6c65 4561 6368 2862 6f75 6e64 3d72 756e  leEach(bound=run
+00026b70: 6e61 626c 6529 0a20 2020 2020 2020 2020  nable).         
+00026b80: 2020 206f 7574 7075 7420 3d20 7275 6e6e     output = runn
+00026b90: 6162 6c65 5f65 6163 682e 696e 766f 6b65  able_each.invoke
+00026ba0: 285b 7b27 746f 7069 6327 3a27 436f 6d70  ([{'topic':'Comp
+00026bb0: 7574 6572 2053 6369 656e 6365 277d 2c0a  uter Science'},.
+00026bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026be0: 2020 2020 2020 2020 7b27 746f 7069 6327          {'topic'
+00026bf0: 3a27 4172 7427 7d2c 0a20 2020 2020 2020  :'Art'},.       
+00026c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c20: 207b 2774 6f70 6963 273a 2742 696f 6c6f   {'topic':'Biolo
+00026c30: 6779 277d 5d29 0a20 2020 2020 2020 2020  gy'}]).         
+00026c40: 2020 2070 7269 6e74 286f 7574 7075 7429     print(output)
+00026c50: 2020 2320 6e6f 7161 3a20 5432 3031 0a20    # noqa: T201. 
+00026c60: 2020 2022 2222 0a0a 2020 2020 4063 6c61     """..    @cla
+00026c70: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
+00026c80: 2067 6574 5f6c 635f 6e61 6d65 7370 6163   get_lc_namespac
+00026c90: 6528 636c 7329 202d 3e20 4c69 7374 5b73  e(cls) -> List[s
+00026ca0: 7472 5d3a 0a20 2020 2020 2020 2022 2222  tr]:.        """
+00026cb0: 4765 7420 7468 6520 6e61 6d65 7370 6163  Get the namespac
+00026cc0: 6520 6f66 2074 6865 206c 616e 6763 6861  e of the langcha
+00026cd0: 696e 206f 626a 6563 742e 2222 220a 2020  in object.""".  
+00026ce0: 2020 2020 2020 7265 7475 726e 205b 226c        return ["l
+00026cf0: 616e 6763 6861 696e 222c 2022 7363 6865  angchain", "sche
+00026d00: 6d61 222c 2022 7275 6e6e 6162 6c65 225d  ma", "runnable"]
+00026d10: 0a0a 2020 2020 6465 6620 6765 745f 6e61  ..    def get_na
+00026d20: 6d65 280a 2020 2020 2020 2020 7365 6c66  me(.        self
+00026d30: 2c20 7375 6666 6978 3a20 4f70 7469 6f6e  , suffix: Option
+00026d40: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c20  al[str] = None, 
+00026d50: 2a2c 206e 616d 653a 204f 7074 696f 6e61  *, name: Optiona
+00026d60: 6c5b 7374 725d 203d 204e 6f6e 650a 2020  l[str] = None.  
+00026d70: 2020 2920 2d3e 2073 7472 3a0a 2020 2020    ) -> str:.    
+00026d80: 2020 2020 6e61 6d65 203d 206e 616d 6520      name = name 
+00026d90: 6f72 2073 656c 662e 6e61 6d65 206f 7220  or self.name or 
+00026da0: 6622 5275 6e6e 6162 6c65 4561 6368 3c7b  f"RunnableEach<{
+00026db0: 7365 6c66 2e62 6f75 6e64 2e67 6574 5f6e  self.bound.get_n
+00026dc0: 616d 6528 297d 3e22 0a20 2020 2020 2020  ame()}>".       
+00026dd0: 2072 6574 7572 6e20 7375 7065 7228 292e   return super().
+00026de0: 6765 745f 6e61 6d65 2873 7566 6669 782c  get_name(suffix,
+00026df0: 206e 616d 653d 6e61 6d65 290a 0a20 2020   name=name)..   
+00026e00: 2064 6566 2062 696e 6428 7365 6c66 2c20   def bind(self, 
+00026e10: 2a2a 6b77 6172 6773 3a20 416e 7929 202d  **kwargs: Any) -
+00026e20: 3e20 5275 6e6e 6162 6c65 4561 6368 5b49  > RunnableEach[I
+00026e30: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
+00026e40: 2020 2020 2020 2072 6574 7572 6e20 5275         return Ru
+00026e50: 6e6e 6162 6c65 4561 6368 2862 6f75 6e64  nnableEach(bound
+00026e60: 3d73 656c 662e 626f 756e 642e 6269 6e64  =self.bound.bind
+00026e70: 282a 2a6b 7761 7267 7329 290a 0a20 2020  (**kwargs))..   
+00026e80: 2064 6566 2077 6974 685f 636f 6e66 6967   def with_config
+00026e90: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00026ea0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00026eb0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00026ec0: 203d 204e 6f6e 652c 202a 2a6b 7761 7267   = None, **kwarg
+00026ed0: 733a 2041 6e79 0a20 2020 2029 202d 3e20  s: Any.    ) -> 
+00026ee0: 5275 6e6e 6162 6c65 4561 6368 5b49 6e70  RunnableEach[Inp
+00026ef0: 7574 2c20 4f75 7470 7574 5d3a 0a20 2020  ut, Output]:.   
+00026f00: 2020 2020 2072 6574 7572 6e20 5275 6e6e       return Runn
+00026f10: 6162 6c65 4561 6368 2862 6f75 6e64 3d73  ableEach(bound=s
+00026f20: 656c 662e 626f 756e 642e 7769 7468 5f63  elf.bound.with_c
+00026f30: 6f6e 6669 6728 636f 6e66 6967 2c20 2a2a  onfig(config, **
+00026f40: 6b77 6172 6773 2929 0a0a 2020 2020 6465  kwargs))..    de
+00026f50: 6620 7769 7468 5f6c 6973 7465 6e65 7273  f with_listeners
+00026f60: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00026f70: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00026f80: 2020 206f 6e5f 7374 6172 743a 204f 7074     on_start: Opt
+00026f90: 696f 6e61 6c5b 0a20 2020 2020 2020 2020  ional[.         
+00026fa0: 2020 2055 6e69 6f6e 5b43 616c 6c61 626c     Union[Callabl
+00026fb0: 655b 5b52 756e 5d2c 204e 6f6e 655d 2c20  e[[Run], None], 
+00026fc0: 4361 6c6c 6162 6c65 5b5b 5275 6e2c 2052  Callable[[Run, R
+00026fd0: 756e 6e61 626c 6543 6f6e 6669 675d 2c20  unnableConfig], 
+00026fe0: 4e6f 6e65 5d5d 0a20 2020 2020 2020 205d  None]].        ]
+00026ff0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00027000: 206f 6e5f 656e 643a 204f 7074 696f 6e61   on_end: Optiona
+00027010: 6c5b 0a20 2020 2020 2020 2020 2020 2055  l[.            U
+00027020: 6e69 6f6e 5b43 616c 6c61 626c 655b 5b52  nion[Callable[[R
+00027030: 756e 5d2c 204e 6f6e 655d 2c20 4361 6c6c  un], None], Call
+00027040: 6162 6c65 5b5b 5275 6e2c 2052 756e 6e61  able[[Run, Runna
+00027050: 626c 6543 6f6e 6669 675d 2c20 4e6f 6e65  bleConfig], None
+00027060: 5d5d 0a20 2020 2020 2020 205d 203d 204e  ]].        ] = N
+00027070: 6f6e 652c 0a20 2020 2020 2020 206f 6e5f  one,.        on_
+00027080: 6572 726f 723a 204f 7074 696f 6e61 6c5b  error: Optional[
+00027090: 0a20 2020 2020 2020 2020 2020 2055 6e69  .            Uni
+000270a0: 6f6e 5b43 616c 6c61 626c 655b 5b52 756e  on[Callable[[Run
+000270b0: 5d2c 204e 6f6e 655d 2c20 4361 6c6c 6162  ], None], Callab
+000270c0: 6c65 5b5b 5275 6e2c 2052 756e 6e61 626c  le[[Run, Runnabl
+000270d0: 6543 6f6e 6669 675d 2c20 4e6f 6e65 5d5d  eConfig], None]]
+000270e0: 0a20 2020 2020 2020 205d 203d 204e 6f6e  .        ] = Non
+000270f0: 652c 0a20 2020 2029 202d 3e20 5275 6e6e  e,.    ) -> Runn
+00027100: 6162 6c65 4561 6368 5b49 6e70 7574 2c20  ableEach[Input, 
+00027110: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+00027120: 2022 2222 0a20 2020 2020 2020 2042 696e   """.        Bin
+00027130: 6420 6c69 6665 6379 636c 6520 6c69 7374  d lifecycle list
+00027140: 656e 6572 7320 746f 2061 2052 756e 6e61  eners to a Runna
+00027150: 626c 652c 2072 6574 7572 6e69 6e67 2061  ble, returning a
+00027160: 206e 6577 2052 756e 6e61 626c 652e 0a0a   new Runnable...
+00027170: 2020 2020 2020 2020 6f6e 5f73 7461 7274          on_start
+00027180: 3a20 4361 6c6c 6564 2062 6566 6f72 6520  : Called before 
+00027190: 7468 6520 7275 6e6e 6162 6c65 2073 7461  the runnable sta
+000271a0: 7274 7320 7275 6e6e 696e 672c 2077 6974  rts running, wit
+000271b0: 6820 7468 6520 5275 6e20 6f62 6a65 6374  h the Run object
+000271c0: 2e0a 2020 2020 2020 2020 6f6e 5f65 6e64  ..        on_end
+000271d0: 3a20 4361 6c6c 6564 2061 6674 6572 2074  : Called after t
+000271e0: 6865 2072 756e 6e61 626c 6520 6669 6e69  he runnable fini
+000271f0: 7368 6573 2072 756e 6e69 6e67 2c20 7769  shes running, wi
+00027200: 7468 2074 6865 2052 756e 206f 626a 6563  th the Run objec
+00027210: 742e 0a20 2020 2020 2020 206f 6e5f 6572  t..        on_er
+00027220: 726f 723a 2043 616c 6c65 6420 6966 2074  ror: Called if t
+00027230: 6865 2072 756e 6e61 626c 6520 7468 726f  he runnable thro
+00027240: 7773 2061 6e20 6572 726f 722c 2077 6974  ws an error, wit
+00027250: 6820 7468 6520 5275 6e20 6f62 6a65 6374  h the Run object
+00027260: 2e0a 0a20 2020 2020 2020 2054 6865 2052  ...        The R
+00027270: 756e 206f 626a 6563 7420 636f 6e74 6169  un object contai
+00027280: 6e73 2069 6e66 6f72 6d61 7469 6f6e 2061  ns information a
+00027290: 626f 7574 2074 6865 2072 756e 2c20 696e  bout the run, in
+000272a0: 636c 7564 696e 6720 6974 7320 6964 2c0a  cluding its id,.
+000272b0: 2020 2020 2020 2020 7479 7065 2c20 696e          type, in
+000272c0: 7075 742c 206f 7574 7075 742c 2065 7272  put, output, err
+000272d0: 6f72 2c20 7374 6172 745f 7469 6d65 2c20  or, start_time, 
+000272e0: 656e 645f 7469 6d65 2c20 616e 6420 616e  end_time, and an
+000272f0: 7920 7461 6773 206f 7220 6d65 7461 6461  y tags or metada
+00027300: 7461 0a20 2020 2020 2020 2061 6464 6564  ta.        added
+00027310: 2074 6f20 7468 6520 7275 6e2e 0a20 2020   to the run..   
+00027320: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00027330: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
+00027340: 4561 6368 280a 2020 2020 2020 2020 2020  Each(.          
+00027350: 2020 626f 756e 643d 7365 6c66 2e62 6f75    bound=self.bou
+00027360: 6e64 2e77 6974 685f 6c69 7374 656e 6572  nd.with_listener
+00027370: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00027380: 2020 206f 6e5f 7374 6172 743d 6f6e 5f73     on_start=on_s
+00027390: 7461 7274 2c20 6f6e 5f65 6e64 3d6f 6e5f  tart, on_end=on_
+000273a0: 656e 642c 206f 6e5f 6572 726f 723d 6f6e  end, on_error=on
+000273b0: 5f65 7272 6f72 0a20 2020 2020 2020 2020  _error.         
+000273c0: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
+000273d0: 0a63 6c61 7373 2052 756e 6e61 626c 6542  .class RunnableB
+000273e0: 696e 6469 6e67 4261 7365 2852 756e 6e61  indingBase(Runna
+000273f0: 626c 6553 6572 6961 6c69 7a61 626c 655b  bleSerializable[
+00027400: 496e 7075 742c 204f 7574 7075 745d 293a  Input, Output]):
+00027410: 0a20 2020 2022 2222 5275 6e6e 6162 6c65  .    """Runnable
+00027420: 2074 6861 7420 6465 6c65 6761 7465 7320   that delegates 
+00027430: 6361 6c6c 7320 746f 2061 6e6f 7468 6572  calls to another
+00027440: 2052 756e 6e61 626c 6520 7769 7468 2061   Runnable with a
+00027450: 2073 6574 206f 6620 6b77 6172 6773 2e0a   set of kwargs..
+00027460: 0a20 2020 2055 7365 206f 6e6c 7920 6966  .    Use only if
+00027470: 2063 7265 6174 696e 6720 6120 6e65 7720   creating a new 
+00027480: 5275 6e6e 6162 6c65 4269 6e64 696e 6720  RunnableBinding 
+00027490: 7375 6263 6c61 7373 2077 6974 6820 6469  subclass with di
+000274a0: 6666 6572 656e 7420 5f5f 696e 6974 5f5f  fferent __init__
+000274b0: 2061 7267 732e 0a0a 2020 2020 5365 6520   args...    See 
+000274c0: 646f 6375 6d65 6e74 6174 696f 6e20 666f  documentation fo
+000274d0: 7220 5275 6e6e 6162 6c65 4269 6e64 696e  r RunnableBindin
+000274e0: 6720 666f 7220 6d6f 7265 2064 6574 6169  g for more detai
+000274f0: 6c73 2e0a 2020 2020 2222 220a 0a20 2020  ls..    """..   
+00027500: 2062 6f75 6e64 3a20 5275 6e6e 6162 6c65   bound: Runnable
+00027510: 5b49 6e70 7574 2c20 4f75 7470 7574 5d0a  [Input, Output].
+00027520: 2020 2020 2222 2254 6865 2075 6e64 6572      """The under
+00027530: 6c79 696e 6720 7275 6e6e 6162 6c65 2074  lying runnable t
+00027540: 6861 7420 7468 6973 2072 756e 6e61 626c  hat this runnabl
+00027550: 6520 6465 6c65 6761 7465 7320 746f 2e22  e delegates to."
+00027560: 2222 0a0a 2020 2020 6b77 6172 6773 3a20  ""..    kwargs: 
+00027570: 4d61 7070 696e 675b 7374 722c 2041 6e79  Mapping[str, Any
+00027580: 5d20 3d20 4669 656c 6428 6465 6661 756c  ] = Field(defaul
+00027590: 745f 6661 6374 6f72 793d 6469 6374 290a  t_factory=dict).
+000275a0: 2020 2020 2222 226b 7761 7267 7320 746f      """kwargs to
+000275b0: 2070 6173 7320 746f 2074 6865 2075 6e64   pass to the und
+000275c0: 6572 6c79 696e 6720 7275 6e6e 6162 6c65  erlying runnable
+000275d0: 2077 6865 6e20 7275 6e6e 696e 672e 0a0a   when running...
+000275e0: 2020 2020 466f 7220 6578 616d 706c 652c      For example,
+000275f0: 2077 6865 6e20 7468 6520 7275 6e6e 6162   when the runnab
+00027600: 6c65 2062 696e 6469 6e67 2069 7320 696e  le binding is in
+00027610: 766f 6b65 6420 7468 6520 756e 6465 726c  voked the underl
+00027620: 7969 6e67 0a20 2020 2072 756e 6e61 626c  ying.    runnabl
+00027630: 6520 7769 6c6c 2062 6520 696e 766f 6b65  e will be invoke
+00027640: 6420 7769 7468 2074 6865 2073 616d 6520  d with the same 
+00027650: 696e 7075 7420 6275 7420 7769 7468 2074  input but with t
+00027660: 6865 7365 2061 6464 6974 696f 6e61 6c0a  hese additional.
+00027670: 2020 2020 6b77 6172 6773 2e0a 2020 2020      kwargs..    
+00027680: 2222 220a 0a20 2020 2063 6f6e 6669 673a  """..    config:
+00027690: 2052 756e 6e61 626c 6543 6f6e 6669 6720   RunnableConfig 
+000276a0: 3d20 4669 656c 6428 6465 6661 756c 745f  = Field(default_
+000276b0: 6661 6374 6f72 793d 6469 6374 290a 2020  factory=dict).  
+000276c0: 2020 2222 2254 6865 2063 6f6e 6669 6720    """The config 
+000276d0: 746f 2062 696e 6420 746f 2074 6865 2075  to bind to the u
+000276e0: 6e64 6572 6c79 696e 6720 7275 6e6e 6162  nderlying runnab
+000276f0: 6c65 2e22 2222 0a0a 2020 2020 636f 6e66  le."""..    conf
+00027700: 6967 5f66 6163 746f 7269 6573 3a20 4c69  ig_factories: Li
+00027710: 7374 5b43 616c 6c61 626c 655b 5b52 756e  st[Callable[[Run
+00027720: 6e61 626c 6543 6f6e 6669 675d 2c20 5275  nableConfig], Ru
+00027730: 6e6e 6162 6c65 436f 6e66 6967 5d5d 203d  nnableConfig]] =
+00027740: 2046 6965 6c64 280a 2020 2020 2020 2020   Field(.        
+00027750: 6465 6661 756c 745f 6661 6374 6f72 793d  default_factory=
+00027760: 6c69 7374 0a20 2020 2029 0a20 2020 2022  list.    ).    "
+00027770: 2222 5468 6520 636f 6e66 6967 2066 6163  ""The config fac
+00027780: 746f 7269 6573 2074 6f20 6269 6e64 2074  tories to bind t
+00027790: 6f20 7468 6520 756e 6465 726c 7969 6e67  o the underlying
+000277a0: 2072 756e 6e61 626c 652e 2222 220a 0a20   runnable.""".. 
+000277b0: 2020 2023 2055 6e69 6f6e 5b54 7970 655b     # Union[Type[
+000277c0: 496e 7075 745d 2c20 4261 7365 4d6f 6465  Input], BaseMode
+000277d0: 6c5d 202b 2074 6869 6e67 7320 6c69 6b65  l] + things like
+000277e0: 204c 6973 745b 7374 725d 0a20 2020 2063   List[str].    c
+000277f0: 7573 746f 6d5f 696e 7075 745f 7479 7065  ustom_input_type
+00027800: 3a20 4f70 7469 6f6e 616c 5b41 6e79 5d20  : Optional[Any] 
+00027810: 3d20 4e6f 6e65 0a20 2020 2022 2222 4f76  = None.    """Ov
+00027820: 6572 7269 6465 2074 6865 2069 6e70 7574  erride the input
+00027830: 2074 7970 6520 6f66 2074 6865 2075 6e64   type of the und
+00027840: 6572 6c79 696e 6720 7275 6e6e 6162 6c65  erlying runnable
+00027850: 2077 6974 6820 6120 6375 7374 6f6d 2074   with a custom t
+00027860: 7970 652e 0a0a 2020 2020 5468 6520 7479  ype...    The ty
+00027870: 7065 2063 616e 2062 6520 6120 7079 6461  pe can be a pyda
+00027880: 6e74 6963 206d 6f64 656c 2c20 6f72 2061  ntic model, or a
+00027890: 2074 7970 6520 616e 6e6f 7461 7469 6f6e   type annotation
+000278a0: 2028 652e 672e 2c20 604c 6973 745b 7374   (e.g., `List[st
+000278b0: 725d 6029 2e0a 2020 2020 2222 220a 2020  r]`)..    """.  
+000278c0: 2020 2320 556e 696f 6e5b 5479 7065 5b4f    # Union[Type[O
+000278d0: 7574 7075 745d 2c20 4261 7365 4d6f 6465  utput], BaseMode
+000278e0: 6c5d 202b 2074 6869 6e67 7320 6c69 6b65  l] + things like
+000278f0: 204c 6973 745b 7374 725d 0a20 2020 2063   List[str].    c
+00027900: 7573 746f 6d5f 6f75 7470 7574 5f74 7970  ustom_output_typ
+00027910: 653a 204f 7074 696f 6e61 6c5b 416e 795d  e: Optional[Any]
+00027920: 203d 204e 6f6e 650a 2020 2020 2222 224f   = None.    """O
+00027930: 7665 7272 6964 6520 7468 6520 6f75 7470  verride the outp
+00027940: 7574 2074 7970 6520 6f66 2074 6865 2075  ut type of the u
+00027950: 6e64 6572 6c79 696e 6720 7275 6e6e 6162  nderlying runnab
+00027960: 6c65 2077 6974 6820 6120 6375 7374 6f6d  le with a custom
+00027970: 2074 7970 652e 0a0a 2020 2020 5468 6520   type...    The 
+00027980: 7479 7065 2063 616e 2062 6520 6120 7079  type can be a py
+00027990: 6461 6e74 6963 206d 6f64 656c 2c20 6f72  dantic model, or
+000279a0: 2061 2074 7970 6520 616e 6e6f 7461 7469   a type annotati
+000279b0: 6f6e 2028 652e 672e 2c20 604c 6973 745b  on (e.g., `List[
+000279c0: 7374 725d 6029 2e0a 2020 2020 2222 220a  str]`)..    """.
+000279d0: 0a20 2020 2063 6c61 7373 2043 6f6e 6669  .    class Confi
+000279e0: 673a 0a20 2020 2020 2020 2061 7262 6974  g:.        arbit
+000279f0: 7261 7279 5f74 7970 6573 5f61 6c6c 6f77  rary_types_allow
+00027a00: 6564 203d 2054 7275 650a 0a20 2020 2064  ed = True..    d
+00027a10: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00027a20: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00027a30: 2020 202a 2c0a 2020 2020 2020 2020 626f     *,.        bo
+00027a40: 756e 643a 2052 756e 6e61 626c 655b 496e  und: Runnable[In
+00027a50: 7075 742c 204f 7574 7075 745d 2c0a 2020  put, Output],.  
+00027a60: 2020 2020 2020 6b77 6172 6773 3a20 4f70        kwargs: Op
+00027a70: 7469 6f6e 616c 5b4d 6170 7069 6e67 5b73  tional[Mapping[s
+00027a80: 7472 2c20 416e 795d 5d20 3d20 4e6f 6e65  tr, Any]] = None
+00027a90: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+00027aa0: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+00027ab0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
+00027ac0: 652c 0a20 2020 2020 2020 2063 6f6e 6669  e,.        confi
+00027ad0: 675f 6661 6374 6f72 6965 733a 204f 7074  g_factories: Opt
+00027ae0: 696f 6e61 6c5b 0a20 2020 2020 2020 2020  ional[.         
+00027af0: 2020 204c 6973 745b 4361 6c6c 6162 6c65     List[Callable
+00027b00: 5b5b 5275 6e6e 6162 6c65 436f 6e66 6967  [[RunnableConfig
+00027b10: 5d2c 2052 756e 6e61 626c 6543 6f6e 6669  ], RunnableConfi
+00027b20: 675d 5d0a 2020 2020 2020 2020 5d20 3d20  g]].        ] = 
+00027b30: 4e6f 6e65 2c0a 2020 2020 2020 2020 6375  None,.        cu
+00027b40: 7374 6f6d 5f69 6e70 7574 5f74 7970 653a  stom_input_type:
+00027b50: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+00027b60: 5479 7065 5b49 6e70 7574 5d2c 2042 6173  Type[Input], Bas
+00027b70: 654d 6f64 656c 5d5d 203d 204e 6f6e 652c  eModel]] = None,
+00027b80: 0a20 2020 2020 2020 2063 7573 746f 6d5f  .        custom_
+00027b90: 6f75 7470 7574 5f74 7970 653a 204f 7074  output_type: Opt
+00027ba0: 696f 6e61 6c5b 556e 696f 6e5b 5479 7065  ional[Union[Type
+00027bb0: 5b4f 7574 7075 745d 2c20 4261 7365 4d6f  [Output], BaseMo
+00027bc0: 6465 6c5d 5d20 3d20 4e6f 6e65 2c0a 2020  del]] = None,.  
+00027bd0: 2020 2020 2020 2a2a 6f74 6865 725f 6b77        **other_kw
+00027be0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
+00027bf0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00027c00: 2020 2222 2243 7265 6174 6520 6120 5275    """Create a Ru
+00027c10: 6e6e 6162 6c65 4269 6e64 696e 6720 6672  nnableBinding fr
+00027c20: 6f6d 2061 2072 756e 6e61 626c 6520 616e  om a runnable an
+00027c30: 6420 6b77 6172 6773 2e0a 0a20 2020 2020  d kwargs...     
+00027c40: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00027c50: 2020 2020 2062 6f75 6e64 3a20 5468 6520       bound: The 
+00027c60: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
+00027c70: 626c 6520 7468 6174 2074 6869 7320 7275  ble that this ru
+00027c80: 6e6e 6162 6c65 2064 656c 6567 6174 6573  nnable delegates
+00027c90: 2063 616c 6c73 2074 6f2e 0a20 2020 2020   calls to..     
+00027ca0: 2020 2020 2020 206b 7761 7267 733a 206f         kwargs: o
+00027cb0: 7074 696f 6e61 6c20 6b77 6172 6773 2074  ptional kwargs t
+00027cc0: 6f20 7061 7373 2074 6f20 7468 6520 756e  o pass to the un
+00027cd0: 6465 726c 7969 6e67 2072 756e 6e61 626c  derlying runnabl
+00027ce0: 652c 2077 6865 6e20 7275 6e6e 696e 670a  e, when running.
+00027cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d00: 2020 2020 7468 6520 756e 6465 726c 7969      the underlyi
+00027d10: 6e67 2072 756e 6e61 626c 6520 2865 2e67  ng runnable (e.g
+00027d20: 2e2c 2076 6961 2060 696e 766f 6b65 602c  ., via `invoke`,
+00027d30: 2060 6261 7463 6860 2c0a 2020 2020 2020   `batch`,.      
+00027d40: 2020 2020 2020 2020 2020 2020 2020 6074                `t
+00027d50: 7261 6e73 666f 726d 602c 206f 7220 6073  ransform`, or `s
+00027d60: 7472 6561 6d60 206f 7220 6173 796e 6320  tream` or async 
+00027d70: 7661 7269 616e 7473 290a 2020 2020 2020  variants).      
+00027d80: 2020 2020 2020 636f 6e66 6967 3a20 636f        config: co
+00027d90: 6e66 6967 5f66 6163 746f 7269 6573 3a0a  nfig_factories:.
+00027da0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00027db0: 6967 5f66 6163 746f 7269 6573 3a20 6f70  ig_factories: op
+00027dc0: 7469 6f6e 616c 206c 6973 7420 6f66 2063  tional list of c
+00027dd0: 6f6e 6669 6720 6661 6374 6f72 6965 7320  onfig factories 
+00027de0: 746f 2061 7070 6c79 2074 6f20 7468 650a  to apply to the.
+00027df0: 2020 2020 2020 2020 2020 2020 6375 7374              cust
+00027e00: 6f6d 5f69 6e70 7574 5f74 7970 653a 2053  om_input_type: S
+00027e10: 7065 6369 6679 2074 6f20 6f76 6572 7269  pecify to overri
+00027e20: 6465 2074 6865 2069 6e70 7574 2074 7970  de the input typ
+00027e30: 6520 6f66 2074 6865 2075 6e64 6572 6c79  e of the underly
+00027e40: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00027e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e60: 2020 2072 756e 6e61 626c 6520 7769 7468     runnable with
+00027e70: 2061 2063 7573 746f 6d20 7479 7065 2e0a   a custom type..
+00027e80: 2020 2020 2020 2020 2020 2020 6375 7374              cust
+00027e90: 6f6d 5f6f 7574 7075 745f 7479 7065 3a20  om_output_type: 
+00027ea0: 5370 6563 6966 7920 746f 206f 7665 7272  Specify to overr
+00027eb0: 6964 6520 7468 6520 6f75 7470 7574 2074  ide the output t
+00027ec0: 7970 6520 6f66 2074 6865 2075 6e64 6572  ype of the under
+00027ed0: 6c79 696e 670a 2020 2020 2020 2020 2020  lying.          
+00027ee0: 2020 2020 2020 7275 6e6e 6162 6c65 2077        runnable w
+00027ef0: 6974 6820 6120 6375 7374 6f6d 2074 7970  ith a custom typ
+00027f00: 652e 0a20 2020 2020 2020 2020 2020 202a  e..            *
+00027f10: 2a6f 7468 6572 5f6b 7761 7267 733a 2055  *other_kwargs: U
+00027f20: 6e70 6163 6b65 6420 696e 746f 2074 6865  npacked into the
+00027f30: 2062 6173 6520 636c 6173 732e 0a20 2020   base class..   
+00027f40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00027f50: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00027f60: 5f28 2020 2320 7479 7065 3a20 6967 6e6f  _(  # type: igno
+00027f70: 7265 5b63 616c 6c2d 6172 675d 0a20 2020  re[call-arg].   
+00027f80: 2020 2020 2020 2020 2062 6f75 6e64 3d62           bound=b
+00027f90: 6f75 6e64 2c0a 2020 2020 2020 2020 2020  ound,.          
+00027fa0: 2020 6b77 6172 6773 3d6b 7761 7267 7320    kwargs=kwargs 
+00027fb0: 6f72 207b 7d2c 0a20 2020 2020 2020 2020  or {},.         
+00027fc0: 2020 2063 6f6e 6669 673d 636f 6e66 6967     config=config
+00027fd0: 206f 7220 7b7d 2c0a 2020 2020 2020 2020   or {},.        
+00027fe0: 2020 2020 636f 6e66 6967 5f66 6163 746f      config_facto
+00027ff0: 7269 6573 3d63 6f6e 6669 675f 6661 6374  ries=config_fact
+00028000: 6f72 6965 7320 6f72 205b 5d2c 0a20 2020  ories or [],.   
+00028010: 2020 2020 2020 2020 2063 7573 746f 6d5f           custom_
+00028020: 696e 7075 745f 7479 7065 3d63 7573 746f  input_type=custo
+00028030: 6d5f 696e 7075 745f 7479 7065 2c0a 2020  m_input_type,.  
+00028040: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
+00028050: 5f6f 7574 7075 745f 7479 7065 3d63 7573  _output_type=cus
+00028060: 746f 6d5f 6f75 7470 7574 5f74 7970 652c  tom_output_type,
+00028070: 0a20 2020 2020 2020 2020 2020 202a 2a6f  .            **o
+00028080: 7468 6572 5f6b 7761 7267 732c 0a20 2020  ther_kwargs,.   
+00028090: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
+000280a0: 2069 6620 7765 2064 6f6e 2774 2065 7870   if we don't exp
+000280b0: 6c69 6369 746c 7920 7365 7420 636f 6e66  licitly set conf
+000280c0: 6967 2074 6f20 7468 6520 5479 7065 6444  ig to the TypedD
+000280d0: 6963 7420 6865 7265 2c0a 2020 2020 2020  ict here,.      
+000280e0: 2020 2320 7468 6520 7079 6461 6e74 6963    # the pydantic
+000280f0: 2069 6e69 7420 6162 6f76 6520 7769 6c6c   init above will
+00028100: 2073 7472 6970 206f 7574 2061 6e79 206f   strip out any o
+00028110: 6620 7468 6520 2265 7874 7261 220a 2020  f the "extra".  
+00028120: 2020 2020 2020 2320 6669 656c 6473 2065        # fields e
+00028130: 7665 6e20 7468 6f75 6768 2074 6f74 616c  ven though total
+00028140: 3d46 616c 7365 206f 6e20 7468 6520 7479  =False on the ty
+00028150: 7065 6420 6469 6374 2e0a 2020 2020 2020  ped dict..      
+00028160: 2020 7365 6c66 2e63 6f6e 6669 6720 3d20    self.config = 
+00028170: 636f 6e66 6967 206f 7220 7b7d 0a0a 2020  config or {}..  
+00028180: 2020 6465 6620 6765 745f 6e61 6d65 280a    def get_name(.
+00028190: 2020 2020 2020 2020 7365 6c66 2c20 7375          self, su
+000281a0: 6666 6978 3a20 4f70 7469 6f6e 616c 5b73  ffix: Optional[s
+000281b0: 7472 5d20 3d20 4e6f 6e65 2c20 2a2c 206e  tr] = None, *, n
+000281c0: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
+000281d0: 725d 203d 204e 6f6e 650a 2020 2020 2920  r] = None.    ) 
+000281e0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+000281f0: 7265 7475 726e 2073 656c 662e 626f 756e  return self.boun
+00028200: 642e 6765 745f 6e61 6d65 2873 7566 6669  d.get_name(suffi
+00028210: 782c 206e 616d 653d 6e61 6d65 290a 0a20  x, name=name).. 
+00028220: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00028230: 2064 6566 2049 6e70 7574 5479 7065 2873   def InputType(s
+00028240: 656c 6629 202d 3e20 5479 7065 5b49 6e70  elf) -> Type[Inp
+00028250: 7574 5d3a 0a20 2020 2020 2020 2072 6574  ut]:.        ret
+00028260: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
+00028270: 2020 6361 7374 2854 7970 655b 496e 7075    cast(Type[Inpu
+00028280: 745d 2c20 7365 6c66 2e63 7573 746f 6d5f  t], self.custom_
+00028290: 696e 7075 745f 7479 7065 290a 2020 2020  input_type).    
+000282a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000282b0: 6375 7374 6f6d 5f69 6e70 7574 5f74 7970  custom_input_typ
+000282c0: 6520 6973 206e 6f74 204e 6f6e 650a 2020  e is not None.  
+000282d0: 2020 2020 2020 2020 2020 656c 7365 2073            else s
+000282e0: 656c 662e 626f 756e 642e 496e 7075 7454  elf.bound.InputT
+000282f0: 7970 650a 2020 2020 2020 2020 290a 0a20  ype.        ).. 
+00028300: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00028310: 2064 6566 204f 7574 7075 7454 7970 6528   def OutputType(
+00028320: 7365 6c66 2920 2d3e 2054 7970 655b 4f75  self) -> Type[Ou
+00028330: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
+00028340: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+00028350: 2020 2020 6361 7374 2854 7970 655b 4f75      cast(Type[Ou
+00028360: 7470 7574 5d2c 2073 656c 662e 6375 7374  tput], self.cust
+00028370: 6f6d 5f6f 7574 7075 745f 7479 7065 290a  om_output_type).
+00028380: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00028390: 656c 662e 6375 7374 6f6d 5f6f 7574 7075  elf.custom_outpu
+000283a0: 745f 7479 7065 2069 7320 6e6f 7420 4e6f  t_type is not No
+000283b0: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
+000283c0: 6c73 6520 7365 6c66 2e62 6f75 6e64 2e4f  lse self.bound.O
+000283d0: 7574 7075 7454 7970 650a 2020 2020 2020  utputType.      
+000283e0: 2020 290a 0a20 2020 2064 6566 2067 6574    )..    def get
+000283f0: 5f69 6e70 7574 5f73 6368 656d 6128 0a20  _input_schema(. 
+00028400: 2020 2020 2020 2073 656c 662c 2063 6f6e         self, con
+00028410: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
+00028420: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
+00028430: 4e6f 6e65 0a20 2020 2029 202d 3e20 5479  None.    ) -> Ty
+00028440: 7065 5b42 6173 654d 6f64 656c 5d3a 0a20  pe[BaseModel]:. 
+00028450: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+00028460: 7573 746f 6d5f 696e 7075 745f 7479 7065  ustom_input_type
+00028470: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00028480: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00028490: 2073 7570 6572 2829 2e67 6574 5f69 6e70   super().get_inp
+000284a0: 7574 5f73 6368 656d 6128 636f 6e66 6967  ut_schema(config
+000284b0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000284c0: 2073 656c 662e 626f 756e 642e 6765 745f   self.bound.get_
+000284d0: 696e 7075 745f 7363 6865 6d61 286d 6572  input_schema(mer
+000284e0: 6765 5f63 6f6e 6669 6773 2873 656c 662e  ge_configs(self.
+000284f0: 636f 6e66 6967 2c20 636f 6e66 6967 2929  config, config))
+00028500: 0a0a 2020 2020 6465 6620 6765 745f 6f75  ..    def get_ou
+00028510: 7470 7574 5f73 6368 656d 6128 0a20 2020  tput_schema(.   
+00028520: 2020 2020 2073 656c 662c 2063 6f6e 6669       self, confi
+00028530: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+00028540: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+00028550: 6e65 0a20 2020 2029 202d 3e20 5479 7065  ne.    ) -> Type
+00028560: 5b42 6173 654d 6f64 656c 5d3a 0a20 2020  [BaseModel]:.   
+00028570: 2020 2020 2069 6620 7365 6c66 2e63 7573       if self.cus
+00028580: 746f 6d5f 6f75 7470 7574 5f74 7970 6520  tom_output_type 
+00028590: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000285a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000285b0: 7375 7065 7228 292e 6765 745f 6f75 7470  super().get_outp
+000285c0: 7574 5f73 6368 656d 6128 636f 6e66 6967  ut_schema(config
+000285d0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000285e0: 2073 656c 662e 626f 756e 642e 6765 745f   self.bound.get_
+000285f0: 6f75 7470 7574 5f73 6368 656d 6128 6d65  output_schema(me
+00028600: 7267 655f 636f 6e66 6967 7328 7365 6c66  rge_configs(self
+00028610: 2e63 6f6e 6669 672c 2063 6f6e 6669 6729  .config, config)
+00028620: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+00028630: 0a20 2020 2064 6566 2063 6f6e 6669 675f  .    def config_
+00028640: 7370 6563 7328 7365 6c66 2920 2d3e 204c  specs(self) -> L
+00028650: 6973 745b 436f 6e66 6967 7572 6162 6c65  ist[Configurable
+00028660: 4669 656c 6453 7065 635d 3a0a 2020 2020  FieldSpec]:.    
+00028670: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00028680: 626f 756e 642e 636f 6e66 6967 5f73 7065  bound.config_spe
+00028690: 6373 0a0a 2020 2020 6465 6620 6765 745f  cs..    def get_
+000286a0: 6772 6170 6828 7365 6c66 2c20 636f 6e66  graph(self, conf
+000286b0: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+000286c0: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+000286d0: 6f6e 6529 202d 3e20 4772 6170 683a 0a20  one) -> Graph:. 
+000286e0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000286f0: 6c66 2e62 6f75 6e64 2e67 6574 5f67 7261  lf.bound.get_gra
+00028700: 7068 2863 6f6e 6669 6729 0a0a 2020 2020  ph(config)..    
+00028710: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
+00028720: 2064 6566 2069 735f 6c63 5f73 6572 6961   def is_lc_seria
+00028730: 6c69 7a61 626c 6528 636c 7329 202d 3e20  lizable(cls) -> 
+00028740: 626f 6f6c 3a0a 2020 2020 2020 2020 7265  bool:.        re
+00028750: 7475 726e 2054 7275 650a 0a20 2020 2040  turn True..    @
+00028760: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
+00028770: 6465 6620 6765 745f 6c63 5f6e 616d 6573  def get_lc_names
+00028780: 7061 6365 2863 6c73 2920 2d3e 204c 6973  pace(cls) -> Lis
+00028790: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
+000287a0: 2222 2247 6574 2074 6865 206e 616d 6573  """Get the names
+000287b0: 7061 6365 206f 6620 7468 6520 6c61 6e67  pace of the lang
+000287c0: 6368 6169 6e20 6f62 6a65 6374 2e22 2222  chain object."""
+000287d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000287e0: 5b22 6c61 6e67 6368 6169 6e22 2c20 2273  ["langchain", "s
+000287f0: 6368 656d 6122 2c20 2272 756e 6e61 626c  chema", "runnabl
+00028800: 6522 5d0a 0a20 2020 2064 6566 205f 6d65  e"]..    def _me
+00028810: 7267 655f 636f 6e66 6967 7328 7365 6c66  rge_configs(self
+00028820: 2c20 2a63 6f6e 6669 6773 3a20 4f70 7469  , *configs: Opti
+00028830: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00028840: 6669 675d 2920 2d3e 2052 756e 6e61 626c  fig]) -> Runnabl
+00028850: 6543 6f6e 6669 673a 0a20 2020 2020 2020  eConfig:.       
+00028860: 2063 6f6e 6669 6720 3d20 6d65 7267 655f   config = merge_
+00028870: 636f 6e66 6967 7328 7365 6c66 2e63 6f6e  configs(self.con
+00028880: 6669 672c 202a 636f 6e66 6967 7329 0a20  fig, *configs). 
+00028890: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
+000288a0: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
+000288b0: 6967 2c20 2a28 6628 636f 6e66 6967 2920  ig, *(f(config) 
+000288c0: 666f 7220 6620 696e 2073 656c 662e 636f  for f in self.co
+000288d0: 6e66 6967 5f66 6163 746f 7269 6573 2929  nfig_factories))
+000288e0: 0a0a 2020 2020 6465 6620 696e 766f 6b65  ..    def invoke
+000288f0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00028900: 2020 2020 2020 2020 696e 7075 743a 2049          input: I
+00028910: 6e70 7574 2c0a 2020 2020 2020 2020 636f  nput,.        co
+00028920: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00028930: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+00028940: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00028950: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+00028960: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+00028970: 204f 7574 7075 743a 0a20 2020 2020 2020   Output:.       
+00028980: 2072 6574 7572 6e20 7365 6c66 2e62 6f75   return self.bou
+00028990: 6e64 2e69 6e76 6f6b 6528 0a20 2020 2020  nd.invoke(.     
+000289a0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+000289b0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000289c0: 6d65 7267 655f 636f 6e66 6967 7328 636f  merge_configs(co
+000289d0: 6e66 6967 292c 0a20 2020 2020 2020 2020  nfig),.         
+000289e0: 2020 202a 2a7b 2a2a 7365 6c66 2e6b 7761     **{**self.kwa
+000289f0: 7267 732c 202a 2a6b 7761 7267 737d 2c0a  rgs, **kwargs},.
+00028a00: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
+00028a10: 7379 6e63 2064 6566 2061 696e 766f 6b65  sync def ainvoke
+00028a20: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00028a30: 2020 2020 2020 2020 696e 7075 743a 2049          input: I
+00028a40: 6e70 7574 2c0a 2020 2020 2020 2020 636f  nput,.        co
+00028a50: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00028a60: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+00028a70: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00028a80: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+00028a90: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+00028aa0: 204f 7574 7075 743a 0a20 2020 2020 2020   Output:.       
+00028ab0: 2072 6574 7572 6e20 6177 6169 7420 7365   return await se
+00028ac0: 6c66 2e62 6f75 6e64 2e61 696e 766f 6b65  lf.bound.ainvoke
+00028ad0: 280a 2020 2020 2020 2020 2020 2020 696e  (.            in
+00028ae0: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+00028af0: 2073 656c 662e 5f6d 6572 6765 5f63 6f6e   self._merge_con
+00028b00: 6669 6773 2863 6f6e 6669 6729 2c0a 2020  figs(config),.  
+00028b10: 2020 2020 2020 2020 2020 2a2a 7b2a 2a73            **{**s
+00028b20: 656c 662e 6b77 6172 6773 2c20 2a2a 6b77  elf.kwargs, **kw
+00028b30: 6172 6773 7d2c 0a20 2020 2020 2020 2029  args},.        )
+00028b40: 0a0a 2020 2020 6465 6620 6261 7463 6828  ..    def batch(
+00028b50: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00028b60: 2020 2020 2020 2069 6e70 7574 733a 204c         inputs: L
+00028b70: 6973 745b 496e 7075 745d 2c0a 2020 2020  ist[Input],.    
+00028b80: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+00028b90: 6f6e 616c 5b55 6e69 6f6e 5b52 756e 6e61  onal[Union[Runna
+00028ba0: 626c 6543 6f6e 6669 672c 204c 6973 745b  bleConfig, List[
+00028bb0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d5d  RunnableConfig]]
+00028bc0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00028bd0: 2020 2a2c 0a20 2020 2020 2020 2072 6574    *,.        ret
+00028be0: 7572 6e5f 6578 6365 7074 696f 6e73 3a20  urn_exceptions: 
+00028bf0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00028c00: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+00028c10: 4f70 7469 6f6e 616c 5b41 6e79 5d2c 0a20  Optional[Any],. 
+00028c20: 2020 2029 202d 3e20 4c69 7374 5b4f 7574     ) -> List[Out
+00028c30: 7075 745d 3a0a 2020 2020 2020 2020 6966  put]:.        if
+00028c40: 2069 7369 6e73 7461 6e63 6528 636f 6e66   isinstance(conf
+00028c50: 6967 2c20 6c69 7374 293a 0a20 2020 2020  ig, list):.     
+00028c60: 2020 2020 2020 2063 6f6e 6669 6773 203d         configs =
+00028c70: 2063 6173 7428 0a20 2020 2020 2020 2020   cast(.         
+00028c80: 2020 2020 2020 204c 6973 745b 5275 6e6e         List[Runn
+00028c90: 6162 6c65 436f 6e66 6967 5d2c 0a20 2020  ableConfig],.   
+00028ca0: 2020 2020 2020 2020 2020 2020 205b 7365               [se
+00028cb0: 6c66 2e5f 6d65 7267 655f 636f 6e66 6967  lf._merge_config
+00028cc0: 7328 636f 6e66 2920 666f 7220 636f 6e66  s(conf) for conf
+00028cd0: 2069 6e20 636f 6e66 6967 5d2c 0a20 2020   in config],.   
+00028ce0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00028cf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00028d00: 2020 2020 2063 6f6e 6669 6773 203d 205b       configs = [
+00028d10: 7365 6c66 2e5f 6d65 7267 655f 636f 6e66  self._merge_conf
+00028d20: 6967 7328 636f 6e66 6967 2920 666f 7220  igs(config) for 
+00028d30: 5f20 696e 2072 616e 6765 286c 656e 2869  _ in range(len(i
+00028d40: 6e70 7574 7329 295d 0a20 2020 2020 2020  nputs))].       
+00028d50: 2072 6574 7572 6e20 7365 6c66 2e62 6f75   return self.bou
+00028d60: 6e64 2e62 6174 6368 280a 2020 2020 2020  nd.batch(.      
+00028d70: 2020 2020 2020 696e 7075 7473 2c0a 2020        inputs,.  
+00028d80: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00028d90: 732c 0a20 2020 2020 2020 2020 2020 2072  s,.            r
+00028da0: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00028db0: 3d72 6574 7572 6e5f 6578 6365 7074 696f  =return_exceptio
+00028dc0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00028dd0: 2a2a 7b2a 2a73 656c 662e 6b77 6172 6773  **{**self.kwargs
+00028de0: 2c20 2a2a 6b77 6172 6773 7d2c 0a20 2020  , **kwargs},.   
+00028df0: 2020 2020 2029 0a0a 2020 2020 6173 796e       )..    asyn
+00028e00: 6320 6465 6620 6162 6174 6368 280a 2020  c def abatch(.  
+00028e10: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00028e20: 2020 2020 696e 7075 7473 3a20 4c69 7374      inputs: List
+00028e30: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+00028e40: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+00028e50: 6c5b 556e 696f 6e5b 5275 6e6e 6162 6c65  l[Union[Runnable
+00028e60: 436f 6e66 6967 2c20 4c69 7374 5b52 756e  Config, List[Run
+00028e70: 6e61 626c 6543 6f6e 6669 675d 5d5d 203d  nableConfig]]] =
+00028e80: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00028e90: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+00028ea0: 5f65 7863 6570 7469 6f6e 733a 2062 6f6f  _exceptions: boo
+00028eb0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00028ec0: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
+00028ed0: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
+00028ee0: 2920 2d3e 204c 6973 745b 4f75 7470 7574  ) -> List[Output
+00028ef0: 5d3a 0a20 2020 2020 2020 2069 6620 6973  ]:.        if is
+00028f00: 696e 7374 616e 6365 2863 6f6e 6669 672c  instance(config,
+00028f10: 206c 6973 7429 3a0a 2020 2020 2020 2020   list):.        
+00028f20: 2020 2020 636f 6e66 6967 7320 3d20 6361      configs = ca
+00028f30: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00028f40: 2020 2020 4c69 7374 5b52 756e 6e61 626c      List[Runnabl
+00028f50: 6543 6f6e 6669 675d 2c0a 2020 2020 2020  eConfig],.      
+00028f60: 2020 2020 2020 2020 2020 5b73 656c 662e            [self.
+00028f70: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
+00028f80: 6f6e 6629 2066 6f72 2063 6f6e 6620 696e  onf) for conf in
+00028f90: 2063 6f6e 6669 675d 2c0a 2020 2020 2020   config],.      
+00028fa0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00028fb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00028fc0: 2020 636f 6e66 6967 7320 3d20 5b73 656c    configs = [sel
+00028fd0: 662e 5f6d 6572 6765 5f63 6f6e 6669 6773  f._merge_configs
+00028fe0: 2863 6f6e 6669 6729 2066 6f72 205f 2069  (config) for _ i
+00028ff0: 6e20 7261 6e67 6528 6c65 6e28 696e 7075  n range(len(inpu
+00029000: 7473 2929 5d0a 2020 2020 2020 2020 7265  ts))].        re
+00029010: 7475 726e 2061 7761 6974 2073 656c 662e  turn await self.
+00029020: 626f 756e 642e 6162 6174 6368 280a 2020  bound.abatch(.  
+00029030: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+00029040: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00029050: 6e66 6967 732c 0a20 2020 2020 2020 2020  nfigs,.         
+00029060: 2020 2072 6574 7572 6e5f 6578 6365 7074     return_except
+00029070: 696f 6e73 3d72 6574 7572 6e5f 6578 6365  ions=return_exce
+00029080: 7074 696f 6e73 2c0a 2020 2020 2020 2020  ptions,.        
+00029090: 2020 2020 2a2a 7b2a 2a73 656c 662e 6b77      **{**self.kw
+000290a0: 6172 6773 2c20 2a2a 6b77 6172 6773 7d2c  args, **kwargs},
+000290b0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000290c0: 406f 7665 726c 6f61 640a 2020 2020 6465  @overload.    de
+000290d0: 6620 6261 7463 685f 6173 5f63 6f6d 706c  f batch_as_compl
+000290e0: 6574 6564 280a 2020 2020 2020 2020 7365  eted(.        se
+000290f0: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+00029100: 7473 3a20 4c69 7374 5b49 6e70 7574 5d2c  ts: List[Input],
+00029110: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+00029120: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+00029130: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
+00029140: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
+00029150: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
+00029160: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+00029170: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+00029180: 6f6e 733a 204c 6974 6572 616c 5b46 616c  ons: Literal[Fal
+00029190: 7365 5d20 3d20 4661 6c73 652c 0a20 2020  se] = False,.   
+000291a0: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+000291b0: 6e79 2c0a 2020 2020 2920 2d3e 2049 7465  ny,.    ) -> Ite
+000291c0: 7261 746f 725b 5475 706c 655b 696e 742c  rator[Tuple[int,
+000291d0: 204f 7574 7075 745d 5d3a 0a20 2020 2020   Output]]:.     
+000291e0: 2020 202e 2e2e 0a0a 2020 2020 406f 7665     .....    @ove
+000291f0: 726c 6f61 640a 2020 2020 6465 6620 6261  rload.    def ba
+00029200: 7463 685f 6173 5f63 6f6d 706c 6574 6564  tch_as_completed
+00029210: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00029220: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00029230: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+00029240: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00029250: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+00029260: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+00029270: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00029280: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00029290: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+000292a0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+000292b0: 204c 6974 6572 616c 5b54 7275 655d 2c0a   Literal[True],.
+000292c0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+000292d0: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+000292e0: 4974 6572 6174 6f72 5b54 7570 6c65 5b69  Iterator[Tuple[i
+000292f0: 6e74 2c20 556e 696f 6e5b 4f75 7470 7574  nt, Union[Output
+00029300: 2c20 4578 6365 7074 696f 6e5d 5d5d 3a0a  , Exception]]]:.
+00029310: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
+00029320: 2064 6566 2062 6174 6368 5f61 735f 636f   def batch_as_co
+00029330: 6d70 6c65 7465 6428 0a20 2020 2020 2020  mpleted(.       
+00029340: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00029350: 6e70 7574 733a 204c 6973 745b 496e 7075  nputs: List[Inpu
+00029360: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
+00029370: 6967 3a20 4f70 7469 6f6e 616c 5b55 6e69  ig: Optional[Uni
+00029380: 6f6e 5b52 756e 6e61 626c 6543 6f6e 6669  on[RunnableConfi
+00029390: 672c 204c 6973 745b 5275 6e6e 6162 6c65  g, List[Runnable
+000293a0: 436f 6e66 6967 5d5d 5d20 3d20 4e6f 6e65  Config]]] = None
+000293b0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+000293c0: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
+000293d0: 7074 696f 6e73 3a20 626f 6f6c 203d 2046  ptions: bool = F
+000293e0: 616c 7365 2c0a 2020 2020 2020 2020 2a2a  alse,.        **
+000293f0: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
+00029400: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
+00029410: 4974 6572 6174 6f72 5b54 7570 6c65 5b69  Iterator[Tuple[i
+00029420: 6e74 2c20 556e 696f 6e5b 4f75 7470 7574  nt, Union[Output
+00029430: 2c20 4578 6365 7074 696f 6e5d 5d5d 3a0a  , Exception]]]:.
+00029440: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00029450: 7461 6e63 6528 636f 6e66 6967 2c20 6c69  tance(config, li
+00029460: 7374 293a 0a20 2020 2020 2020 2020 2020  st):.           
+00029470: 2063 6f6e 6669 6773 203d 2063 6173 7428   configs = cast(
+00029480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029490: 204c 6973 745b 5275 6e6e 6162 6c65 436f   List[RunnableCo
+000294a0: 6e66 6967 5d2c 0a20 2020 2020 2020 2020  nfig],.         
+000294b0: 2020 2020 2020 205b 7365 6c66 2e5f 6d65         [self._me
+000294c0: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
+000294d0: 2920 666f 7220 636f 6e66 2069 6e20 636f  ) for conf in co
+000294e0: 6e66 6967 5d2c 0a20 2020 2020 2020 2020  nfig],.         
+000294f0: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+00029500: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00029510: 6f6e 6669 6773 203d 205b 7365 6c66 2e5f  onfigs = [self._
+00029520: 6d65 7267 655f 636f 6e66 6967 7328 636f  merge_configs(co
+00029530: 6e66 6967 2920 666f 7220 5f20 696e 2072  nfig) for _ in r
+00029540: 616e 6765 286c 656e 2869 6e70 7574 7329  ange(len(inputs)
+00029550: 295d 0a20 2020 2020 2020 2023 206c 6f6c  )].        # lol
+00029560: 206d 7970 790a 2020 2020 2020 2020 6966   mypy.        if
+00029570: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+00029580: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00029590: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+000295a0: 626f 756e 642e 6261 7463 685f 6173 5f63  bound.batch_as_c
+000295b0: 6f6d 706c 6574 6564 280a 2020 2020 2020  ompleted(.      
+000295c0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+000295d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000295e0: 2020 636f 6e66 6967 732c 0a20 2020 2020    configs,.     
+000295f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00029600: 6e5f 6578 6365 7074 696f 6e73 3d72 6574  n_exceptions=ret
+00029610: 7572 6e5f 6578 6365 7074 696f 6e73 2c0a  urn_exceptions,.
+00029620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029630: 2a2a 7b2a 2a73 656c 662e 6b77 6172 6773  **{**self.kwargs
+00029640: 2c20 2a2a 6b77 6172 6773 7d2c 0a20 2020  , **kwargs},.   
+00029650: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00029660: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00029670: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
+00029680: 7365 6c66 2e62 6f75 6e64 2e62 6174 6368  self.bound.batch
+00029690: 5f61 735f 636f 6d70 6c65 7465 6428 0a20  _as_completed(. 
+000296a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000296b0: 6e70 7574 732c 0a20 2020 2020 2020 2020  nputs,.         
+000296c0: 2020 2020 2020 2063 6f6e 6669 6773 2c0a         configs,.
+000296d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296e0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+000296f0: 733d 7265 7475 726e 5f65 7863 6570 7469  s=return_excepti
+00029700: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00029710: 2020 2020 202a 2a7b 2a2a 7365 6c66 2e6b       **{**self.k
+00029720: 7761 7267 732c 202a 2a6b 7761 7267 737d  wargs, **kwargs}
+00029730: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00029740: 0a20 2020 2040 6f76 6572 6c6f 6164 0a20  .    @overload. 
+00029750: 2020 2064 6566 2061 6261 7463 685f 6173     def abatch_as
+00029760: 5f63 6f6d 706c 6574 6564 280a 2020 2020  _completed(.    
+00029770: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00029780: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
+00029790: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
+000297a0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+000297b0: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
+000297c0: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
+000297d0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
+000297e0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
+000297f0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
+00029800: 7863 6570 7469 6f6e 733a 204c 6974 6572  xceptions: Liter
+00029810: 616c 5b46 616c 7365 5d20 3d20 4661 6c73  al[False] = Fals
+00029820: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+00029830: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+00029840: 795d 2c0a 2020 2020 2920 2d3e 2041 7379  y],.    ) -> Asy
+00029850: 6e63 4974 6572 6174 6f72 5b54 7570 6c65  ncIterator[Tuple
+00029860: 5b69 6e74 2c20 4f75 7470 7574 5d5d 3a0a  [int, Output]]:.
+00029870: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
+00029880: 2040 6f76 6572 6c6f 6164 0a20 2020 2064   @overload.    d
+00029890: 6566 2061 6261 7463 685f 6173 5f63 6f6d  ef abatch_as_com
+000298a0: 706c 6574 6564 280a 2020 2020 2020 2020  pleted(.        
+000298b0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+000298c0: 7075 7473 3a20 4c69 7374 5b49 6e70 7574  puts: List[Input
+000298d0: 5d2c 0a20 2020 2020 2020 2063 6f6e 6669  ],.        confi
+000298e0: 673a 204f 7074 696f 6e61 6c5b 556e 696f  g: Optional[Unio
+000298f0: 6e5b 5275 6e6e 6162 6c65 436f 6e66 6967  n[RunnableConfig
+00029900: 2c20 4c69 7374 5b52 756e 6e61 626c 6543  , List[RunnableC
+00029910: 6f6e 6669 675d 5d5d 203d 204e 6f6e 652c  onfig]]] = None,
+00029920: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00029930: 2020 2020 7265 7475 726e 5f65 7863 6570      return_excep
+00029940: 7469 6f6e 733a 204c 6974 6572 616c 5b54  tions: Literal[T
+00029950: 7275 655d 2c0a 2020 2020 2020 2020 2a2a  rue],.        **
+00029960: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
+00029970: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
+00029980: 4173 796e 6349 7465 7261 746f 725b 5475  AsyncIterator[Tu
+00029990: 706c 655b 696e 742c 2055 6e69 6f6e 5b4f  ple[int, Union[O
+000299a0: 7574 7075 742c 2045 7863 6570 7469 6f6e  utput, Exception
+000299b0: 5d5d 5d3a 0a20 2020 2020 2020 202e 2e2e  ]]]:.        ...
+000299c0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000299d0: 6162 6174 6368 5f61 735f 636f 6d70 6c65  abatch_as_comple
+000299e0: 7465 6428 0a20 2020 2020 2020 2073 656c  ted(.        sel
+000299f0: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+00029a00: 733a 204c 6973 745b 496e 7075 745d 2c0a  s: List[Input],.
+00029a10: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+00029a20: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b52  Optional[Union[R
+00029a30: 756e 6e61 626c 6543 6f6e 6669 672c 204c  unnableConfig, L
+00029a40: 6973 745b 5275 6e6e 6162 6c65 436f 6e66  ist[RunnableConf
+00029a50: 6967 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  ig]]] = None,.  
+00029a60: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00029a70: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+00029a80: 6e73 3a20 626f 6f6c 203d 2046 616c 7365  ns: bool = False
+00029a90: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00029aa0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
+00029ab0: 5d2c 0a20 2020 2029 202d 3e20 4173 796e  ],.    ) -> Asyn
+00029ac0: 6349 7465 7261 746f 725b 5475 706c 655b  cIterator[Tuple[
+00029ad0: 696e 742c 2055 6e69 6f6e 5b4f 7574 7075  int, Union[Outpu
+00029ae0: 742c 2045 7863 6570 7469 6f6e 5d5d 5d3a  t, Exception]]]:
+00029af0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00029b00: 7374 616e 6365 2863 6f6e 6669 672c 206c  stance(config, l
+00029b10: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
+00029b20: 2020 636f 6e66 6967 7320 3d20 6361 7374    configs = cast
+00029b30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00029b40: 2020 4c69 7374 5b52 756e 6e61 626c 6543    List[RunnableC
+00029b50: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
+00029b60: 2020 2020 2020 2020 5b73 656c 662e 5f6d          [self._m
+00029b70: 6572 6765 5f63 6f6e 6669 6773 2863 6f6e  erge_configs(con
+00029b80: 6629 2066 6f72 2063 6f6e 6620 696e 2063  f) for conf in c
+00029b90: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
+00029ba0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00029bb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00029bc0: 636f 6e66 6967 7320 3d20 5b73 656c 662e  configs = [self.
+00029bd0: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
+00029be0: 6f6e 6669 6729 2066 6f72 205f 2069 6e20  onfig) for _ in 
+00029bf0: 7261 6e67 6528 6c65 6e28 696e 7075 7473  range(len(inputs
+00029c00: 2929 5d0a 2020 2020 2020 2020 6966 2072  ))].        if r
+00029c10: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00029c20: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00029c30: 796e 6320 666f 7220 6974 656d 2069 6e20  ync for item in 
+00029c40: 7365 6c66 2e62 6f75 6e64 2e61 6261 7463  self.bound.abatc
+00029c50: 685f 6173 5f63 6f6d 706c 6574 6564 280a  h_as_completed(.
+00029c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c70: 696e 7075 7473 2c0a 2020 2020 2020 2020  inputs,.        
+00029c80: 2020 2020 2020 2020 636f 6e66 6967 732c          configs,
+00029c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029ca0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+00029cb0: 6e73 3d72 6574 7572 6e5f 6578 6365 7074  ns=return_except
+00029cc0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00029cd0: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
+00029ce0: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
+00029cf0: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
+00029d00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029d10: 2020 7969 656c 6420 6974 656d 0a20 2020    yield item.   
+00029d20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00029d30: 2020 2020 2020 2061 7379 6e63 2066 6f72         async for
+00029d40: 2069 7465 6d20 696e 2073 656c 662e 626f   item in self.bo
+00029d50: 756e 642e 6162 6174 6368 5f61 735f 636f  und.abatch_as_co
+00029d60: 6d70 6c65 7465 6428 0a20 2020 2020 2020  mpleted(.       
+00029d70: 2020 2020 2020 2020 2069 6e70 7574 732c           inputs,
+00029d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029d90: 2063 6f6e 6669 6773 2c0a 2020 2020 2020   configs,.      
+00029da0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00029db0: 5f65 7863 6570 7469 6f6e 733d 7265 7475  _exceptions=retu
+00029dc0: 726e 5f65 7863 6570 7469 6f6e 732c 0a20  rn_exceptions,. 
+00029dd0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00029de0: 2a7b 2a2a 7365 6c66 2e6b 7761 7267 732c  *{**self.kwargs,
+00029df0: 202a 2a6b 7761 7267 737d 2c0a 2020 2020   **kwargs},.    
+00029e00: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00029e10: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+00029e20: 2069 7465 6d0a 0a20 2020 2064 6566 2073   item..    def s
+00029e30: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
+00029e40: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
+00029e50: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
+00029e60: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+00029e70: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
+00029e80: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
+00029e90: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
+00029ea0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
+00029eb0: 2029 202d 3e20 4974 6572 6174 6f72 5b4f   ) -> Iterator[O
+00029ec0: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+00029ed0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+00029ee0: 626f 756e 642e 7374 7265 616d 280a 2020  bound.stream(.  
+00029ef0: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+00029f00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00029f10: 662e 5f6d 6572 6765 5f63 6f6e 6669 6773  f._merge_configs
+00029f20: 2863 6f6e 6669 6729 2c0a 2020 2020 2020  (config),.      
+00029f30: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
+00029f40: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
+00029f50: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
+00029f60: 2020 6173 796e 6320 6465 6620 6173 7472    async def astr
+00029f70: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
+00029f80: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+00029f90: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
+00029fa0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+00029fb0: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+00029fc0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00029fd0: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+00029fe0: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+00029ff0: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
+0002a000: 725b 4f75 7470 7574 5d3a 0a20 2020 2020  r[Output]:.     
+0002a010: 2020 2061 7379 6e63 2066 6f72 2069 7465     async for ite
+0002a020: 6d20 696e 2073 656c 662e 626f 756e 642e  m in self.bound.
+0002a030: 6173 7472 6561 6d28 0a20 2020 2020 2020  astream(.       
+0002a040: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+0002a050: 2020 2020 2020 2020 7365 6c66 2e5f 6d65          self._me
+0002a060: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
+0002a070: 6967 292c 0a20 2020 2020 2020 2020 2020  ig),.           
+0002a080: 202a 2a7b 2a2a 7365 6c66 2e6b 7761 7267   **{**self.kwarg
+0002a090: 732c 202a 2a6b 7761 7267 737d 2c0a 2020  s, **kwargs},.  
+0002a0a0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+0002a0b0: 2020 2020 2079 6965 6c64 2069 7465 6d0a       yield item.
+0002a0c0: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
+0002a0d0: 7374 7265 616d 5f65 7665 6e74 7328 0a20  stream_events(. 
+0002a0e0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0002a0f0: 2020 2020 2069 6e70 7574 3a20 496e 7075       input: Inpu
+0002a100: 742c 0a20 2020 2020 2020 2063 6f6e 6669  t,.        confi
+0002a110: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+0002a120: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+0002a130: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+0002a140: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+0002a150: 6e79 5d2c 0a20 2020 2029 202d 3e20 4173  ny],.    ) -> As
+0002a160: 796e 6349 7465 7261 746f 725b 5374 7265  yncIterator[Stre
+0002a170: 616d 4576 656e 745d 3a0a 2020 2020 2020  amEvent]:.      
+0002a180: 2020 6173 796e 6320 666f 7220 6974 656d    async for item
+0002a190: 2069 6e20 7365 6c66 2e62 6f75 6e64 2e61   in self.bound.a
+0002a1a0: 7374 7265 616d 5f65 7665 6e74 7328 0a20  stream_events(. 
+0002a1b0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0002a1c0: 2c20 7365 6c66 2e5f 6d65 7267 655f 636f  , self._merge_co
+0002a1d0: 6e66 6967 7328 636f 6e66 6967 292c 202a  nfigs(config), *
+0002a1e0: 2a7b 2a2a 7365 6c66 2e6b 7761 7267 732c  *{**self.kwargs,
+0002a1f0: 202a 2a6b 7761 7267 737d 0a20 2020 2020   **kwargs}.     
+0002a200: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0002a210: 2020 7969 656c 6420 6974 656d 0a0a 2020    yield item..  
+0002a220: 2020 6465 6620 7472 616e 7366 6f72 6d28    def transform(
+0002a230: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0002a240: 2020 2020 2020 2069 6e70 7574 3a20 4974         input: It
+0002a250: 6572 6174 6f72 5b49 6e70 7574 5d2c 0a20  erator[Input],. 
+0002a260: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
+0002a270: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+0002a280: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
+0002a290: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0002a2a0: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+0002a2b0: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
+0002a2c0: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
+0002a2d0: 6672 6f6d 2073 656c 662e 626f 756e 642e  from self.bound.
+0002a2e0: 7472 616e 7366 6f72 6d28 0a20 2020 2020  transform(.     
+0002a2f0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+0002a300: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0002a310: 6d65 7267 655f 636f 6e66 6967 7328 636f  merge_configs(co
+0002a320: 6e66 6967 292c 0a20 2020 2020 2020 2020  nfig),.         
+0002a330: 2020 202a 2a7b 2a2a 7365 6c66 2e6b 7761     **{**self.kwa
+0002a340: 7267 732c 202a 2a6b 7761 7267 737d 2c0a  rgs, **kwargs},.
+0002a350: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
+0002a360: 7379 6e63 2064 6566 2061 7472 616e 7366  sync def atransf
+0002a370: 6f72 6d28 0a20 2020 2020 2020 2073 656c  orm(.        sel
+0002a380: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+0002a390: 3a20 4173 796e 6349 7465 7261 746f 725b  : AsyncIterator[
+0002a3a0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
+0002a3b0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0002a3c0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+0002a3d0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0002a3e0: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+0002a3f0: 2020 2020 2920 2d3e 2041 7379 6e63 4974      ) -> AsyncIt
+0002a400: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
+0002a410: 2020 2020 2020 2020 6173 796e 6320 666f          async fo
+0002a420: 7220 6974 656d 2069 6e20 7365 6c66 2e62  r item in self.b
+0002a430: 6f75 6e64 2e61 7472 616e 7366 6f72 6d28  ound.atransform(
+0002a440: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+0002a450: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+0002a460: 7365 6c66 2e5f 6d65 7267 655f 636f 6e66  self._merge_conf
+0002a470: 6967 7328 636f 6e66 6967 292c 0a20 2020  igs(config),.   
+0002a480: 2020 2020 2020 2020 202a 2a7b 2a2a 7365           **{**se
+0002a490: 6c66 2e6b 7761 7267 732c 202a 2a6b 7761  lf.kwargs, **kwa
+0002a4a0: 7267 737d 2c0a 2020 2020 2020 2020 293a  rgs},.        ):
+0002a4b0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+0002a4c0: 6c64 2069 7465 6d0a 0a0a 5275 6e6e 6162  ld item...Runnab
+0002a4d0: 6c65 4269 6e64 696e 6742 6173 652e 7570  leBindingBase.up
+0002a4e0: 6461 7465 5f66 6f72 7761 7264 5f72 6566  date_forward_ref
+0002a4f0: 7328 5275 6e6e 6162 6c65 436f 6e66 6967  s(RunnableConfig
+0002a500: 3d52 756e 6e61 626c 6543 6f6e 6669 6729  =RunnableConfig)
+0002a510: 0a0a 0a63 6c61 7373 2052 756e 6e61 626c  ...class Runnabl
+0002a520: 6542 696e 6469 6e67 2852 756e 6e61 626c  eBinding(Runnabl
+0002a530: 6542 696e 6469 6e67 4261 7365 5b49 6e70  eBindingBase[Inp
+0002a540: 7574 2c20 4f75 7470 7574 5d29 3a0a 2020  ut, Output]):.  
+0002a550: 2020 2222 2257 7261 7020 6120 5275 6e6e    """Wrap a Runn
+0002a560: 6162 6c65 2077 6974 6820 6164 6469 7469  able with additi
+0002a570: 6f6e 616c 2066 756e 6374 696f 6e61 6c69  onal functionali
+0002a580: 7479 2e0a 0a20 2020 2041 2052 756e 6e61  ty...    A Runna
+0002a590: 626c 6542 696e 6469 6e67 2063 616e 2062  bleBinding can b
+0002a5a0: 6520 7468 6f75 6768 7420 6f66 2061 7320  e thought of as 
+0002a5b0: 6120 2272 756e 6e61 626c 6520 6465 636f  a "runnable deco
+0002a5c0: 7261 746f 7222 2074 6861 740a 2020 2020  rator" that.    
+0002a5d0: 7072 6573 6572 7665 7320 7468 6520 6573  preserves the es
+0002a5e0: 7365 6e74 6961 6c20 6665 6174 7572 6573  sential features
+0002a5f0: 206f 6620 5275 6e6e 6162 6c65 3b20 692e   of Runnable; i.
+0002a600: 652e 2c20 6261 7463 6869 6e67 2c20 7374  e., batching, st
+0002a610: 7265 616d 696e 672c 0a20 2020 2061 6e64  reaming,.    and
+0002a620: 2061 7379 6e63 2073 7570 706f 7274 2c20   async support, 
+0002a630: 7768 696c 6520 6164 6469 6e67 2061 6464  while adding add
+0002a640: 6974 696f 6e61 6c20 6675 6e63 7469 6f6e  itional function
+0002a650: 616c 6974 792e 0a0a 2020 2020 416e 7920  ality...    Any 
+0002a660: 636c 6173 7320 7468 6174 2069 6e68 6572  class that inher
+0002a670: 6974 7320 6672 6f6d 2052 756e 6e61 626c  its from Runnabl
+0002a680: 6520 6361 6e20 6265 2062 6f75 6e64 2074  e can be bound t
+0002a690: 6f20 6120 6052 756e 6e61 626c 6542 696e  o a `RunnableBin
+0002a6a0: 6469 6e67 602e 0a20 2020 2052 756e 6e61  ding`..    Runna
+0002a6b0: 626c 6573 2065 7870 6f73 6520 6120 7374  bles expose a st
+0002a6c0: 616e 6461 7264 2073 6574 206f 6620 6d65  andard set of me
+0002a6d0: 7468 6f64 7320 666f 7220 6372 6561 7469  thods for creati
+0002a6e0: 6e67 2060 5275 6e6e 6162 6c65 4269 6e64  ng `RunnableBind
+0002a6f0: 696e 6773 600a 2020 2020 6f72 2073 7562  ings`.    or sub
+0002a700: 2d63 6c61 7373 6573 206f 6620 6052 756e  -classes of `Run
+0002a710: 6e61 626c 6542 696e 6469 6e67 7360 2028  nableBindings` (
+0002a720: 652e 672e 2c20 6052 756e 6e61 626c 6552  e.g., `RunnableR
+0002a730: 6574 7279 602c 0a20 2020 2060 5275 6e6e  etry`,.    `Runn
+0002a740: 6162 6c65 5769 7468 4661 6c6c 6261 636b  ableWithFallback
+0002a750: 7360 2920 7468 6174 2061 6464 2061 6464  s`) that add add
+0002a760: 6974 696f 6e61 6c20 6675 6e63 7469 6f6e  itional function
+0002a770: 616c 6974 792e 0a0a 2020 2020 5468 6573  ality...    Thes
+0002a780: 6520 6d65 7468 6f64 7320 696e 636c 7564  e methods includ
+0002a790: 653a 0a20 2020 202d 2060 6269 6e64 603a  e:.    - `bind`:
+0002a7a0: 2042 696e 6420 6b77 6172 6773 2074 6f20   Bind kwargs to 
+0002a7b0: 7061 7373 2074 6f20 7468 6520 756e 6465  pass to the unde
+0002a7c0: 726c 7969 6e67 2072 756e 6e61 626c 6520  rlying runnable 
+0002a7d0: 7768 656e 2072 756e 6e69 6e67 2069 742e  when running it.
+0002a7e0: 0a20 2020 202d 2060 7769 7468 5f63 6f6e  .    - `with_con
+0002a7f0: 6669 6760 3a20 4269 6e64 2063 6f6e 6669  fig`: Bind confi
+0002a800: 6720 746f 2070 6173 7320 746f 2074 6865  g to pass to the
+0002a810: 2075 6e64 6572 6c79 696e 6720 7275 6e6e   underlying runn
+0002a820: 6162 6c65 2077 6865 6e20 7275 6e6e 696e  able when runnin
+0002a830: 6720 6974 2e0a 2020 2020 2d20 6077 6974  g it..    - `wit
+0002a840: 685f 6c69 7374 656e 6572 7360 3a20 2042  h_listeners`:  B
+0002a850: 696e 6420 6c69 6665 6379 636c 6520 6c69  ind lifecycle li
+0002a860: 7374 656e 6572 7320 746f 2074 6865 2075  steners to the u
+0002a870: 6e64 6572 6c79 696e 6720 7275 6e6e 6162  nderlying runnab
+0002a880: 6c65 2e0a 2020 2020 2d20 6077 6974 685f  le..    - `with_
+0002a890: 7479 7065 7360 3a20 4f76 6572 7269 6465  types`: Override
+0002a8a0: 2074 6865 2069 6e70 7574 2061 6e64 206f   the input and o
+0002a8b0: 7574 7075 7420 7479 7065 7320 6f66 2074  utput types of t
+0002a8c0: 6865 2075 6e64 6572 6c79 696e 6720 7275  he underlying ru
+0002a8d0: 6e6e 6162 6c65 2e0a 2020 2020 2d20 6077  nnable..    - `w
+0002a8e0: 6974 685f 7265 7472 7960 3a20 4269 6e64  ith_retry`: Bind
+0002a8f0: 2061 2072 6574 7279 2070 6f6c 6963 7920   a retry policy 
+0002a900: 746f 2074 6865 2075 6e64 6572 6c79 696e  to the underlyin
+0002a910: 6720 7275 6e6e 6162 6c65 2e0a 2020 2020  g runnable..    
+0002a920: 2d20 6077 6974 685f 6661 6c6c 6261 636b  - `with_fallback
+0002a930: 7360 3a20 4269 6e64 2061 2066 616c 6c62  s`: Bind a fallb
+0002a940: 6163 6b20 706f 6c69 6379 2074 6f20 7468  ack policy to th
+0002a950: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
+0002a960: 6e61 626c 652e 0a0a 2020 2020 4578 616d  nable...    Exam
+0002a970: 706c 653a 0a0a 2020 2020 6062 696e 6460  ple:..    `bind`
+0002a980: 3a20 4269 6e64 206b 7761 7267 7320 746f  : Bind kwargs to
+0002a990: 2070 6173 7320 746f 2074 6865 2075 6e64   pass to the und
+0002a9a0: 6572 6c79 696e 6720 7275 6e6e 6162 6c65  erlying runnable
+0002a9b0: 2077 6865 6e20 7275 6e6e 696e 6720 6974   when running it
+0002a9c0: 2e0a 0a20 2020 2020 2020 202e 2e20 636f  ...        .. co
+0002a9d0: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
+0002a9e0: 6e0a 0a20 2020 2020 2020 2020 2020 2023  n..            #
+0002a9f0: 2043 7265 6174 6520 6120 7275 6e6e 6162   Create a runnab
+0002aa00: 6c65 2062 696e 6469 6e67 2074 6861 7420  le binding that 
+0002aa10: 696e 766f 6b65 7320 7468 6520 4368 6174  invokes the Chat
+0002aa20: 4d6f 6465 6c20 7769 7468 2074 6865 0a20  Model with the. 
+0002aa30: 2020 2020 2020 2020 2020 2023 2061 6464             # add
+0002aa40: 6974 696f 6e61 6c20 6b77 6172 6720 6073  itional kwarg `s
+0002aa50: 746f 703d 5b27 2d27 5d60 2077 6865 6e20  top=['-']` when 
+0002aa60: 7275 6e6e 696e 6720 6974 2e0a 2020 2020  running it..    
+0002aa70: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0002aa80: 6763 6861 696e 5f63 6f6d 6d75 6e69 7479  gchain_community
+0002aa90: 2e63 6861 745f 6d6f 6465 6c73 2069 6d70  .chat_models imp
+0002aaa0: 6f72 7420 4368 6174 4f70 656e 4149 0a20  ort ChatOpenAI. 
+0002aab0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0002aac0: 203d 2043 6861 744f 7065 6e41 4928 290a   = ChatOpenAI().
+0002aad0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0002aae0: 6c2e 696e 766f 6b65 2827 5361 7920 2250  l.invoke('Say "P
+0002aaf0: 6172 726f 742d 4d41 4749 4322 272c 2073  arrot-MAGIC"', s
+0002ab00: 746f 703d 5b27 2d27 5d29 2023 2053 686f  top=['-']) # Sho
+0002ab10: 756c 6420 7265 7475 726e 2060 5061 7272  uld return `Parr
+0002ab20: 6f74 600a 2020 2020 2020 2020 2020 2020  ot`.            
+0002ab30: 2320 5573 696e 6720 6974 2074 6865 2065  # Using it the e
+0002ab40: 6173 7920 7761 7920 7669 6120 6062 696e  asy way via `bin
+0002ab50: 6460 206d 6574 686f 6420 7768 6963 6820  d` method which 
+0002ab60: 7265 7475 726e 7320 6120 6e65 770a 2020  returns a new.  
+0002ab70: 2020 2020 2020 2020 2020 2320 5275 6e6e            # Runn
+0002ab80: 6162 6c65 4269 6e64 696e 670a 2020 2020  ableBinding.    
+0002ab90: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+0002aba0: 5f62 696e 6469 6e67 203d 206d 6f64 656c  _binding = model
+0002abb0: 2e62 696e 6428 7374 6f70 3d5b 272d 275d  .bind(stop=['-']
+0002abc0: 290a 2020 2020 2020 2020 2020 2020 7275  ).            ru
+0002abd0: 6e6e 6162 6c65 5f62 696e 6469 6e67 2e69  nnable_binding.i
+0002abe0: 6e76 6f6b 6528 2753 6179 2022 5061 7272  nvoke('Say "Parr
+0002abf0: 6f74 2d4d 4147 4943 2227 2920 2320 5368  ot-MAGIC"') # Sh
+0002ac00: 6f75 6c64 2072 6574 7572 6e20 6050 6172  ould return `Par
+0002ac10: 726f 7460 0a0a 2020 2020 2020 2020 4361  rot`..        Ca
+0002ac20: 6e20 616c 736f 2062 6520 646f 6e65 2062  n also be done b
+0002ac30: 7920 696e 7374 616e 7469 6174 696e 6720  y instantiating 
+0002ac40: 6120 5275 6e6e 6162 6c65 4269 6e64 696e  a RunnableBindin
+0002ac50: 6720 6469 7265 6374 6c79 2028 6e6f 7420  g directly (not 
+0002ac60: 7265 636f 6d6d 656e 6465 6429 3a0a 0a20  recommended):.. 
+0002ac70: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
+0002ac80: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
+0002ac90: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0002aca0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+0002acb0: 756e 6e61 626c 6573 2069 6d70 6f72 7420  unnables import 
+0002acc0: 5275 6e6e 6162 6c65 4269 6e64 696e 670a  RunnableBinding.
+0002acd0: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+0002ace0: 6162 6c65 5f62 696e 6469 6e67 203d 2052  able_binding = R
+0002acf0: 756e 6e61 626c 6542 696e 6469 6e67 280a  unnableBinding(.
+0002ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ad10: 626f 756e 643d 6d6f 6465 6c2c 0a20 2020  bound=model,.   
+0002ad20: 2020 2020 2020 2020 2020 2020 206b 7761               kwa
+0002ad30: 7267 733d 7b27 7374 6f70 273a 205b 272d  rgs={'stop': ['-
+0002ad40: 275d 7d20 2320 3c2d 2d20 4e6f 7465 2074  ']} # <-- Note t
+0002ad50: 6865 2061 6464 6974 696f 6e61 6c20 6b77  he additional kw
+0002ad60: 6172 6773 0a20 2020 2020 2020 2020 2020  args.           
+0002ad70: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
+0002ad80: 756e 6e61 626c 655f 6269 6e64 696e 672e  unnable_binding.
+0002ad90: 696e 766f 6b65 2827 5361 7920 2250 6172  invoke('Say "Par
+0002ada0: 726f 742d 4d41 4749 4322 2729 2023 2053  rot-MAGIC"') # S
+0002adb0: 686f 756c 6420 7265 7475 726e 2060 5061  hould return `Pa
+0002adc0: 7272 6f74 600a 2020 2020 2222 220a 0a20  rrot`.    """.. 
+0002add0: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
+0002ade0: 2020 2020 6465 6620 6765 745f 6c63 5f6e      def get_lc_n
+0002adf0: 616d 6573 7061 6365 2863 6c73 2920 2d3e  amespace(cls) ->
+0002ae00: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
+0002ae10: 2020 2020 2222 2247 6574 2074 6865 206e      """Get the n
+0002ae20: 616d 6573 7061 6365 206f 6620 7468 6520  amespace of the 
+0002ae30: 6c61 6e67 6368 6169 6e20 6f62 6a65 6374  langchain object
+0002ae40: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
+0002ae50: 7572 6e20 5b22 6c61 6e67 6368 6169 6e22  urn ["langchain"
+0002ae60: 2c20 2273 6368 656d 6122 2c20 2272 756e  , "schema", "run
+0002ae70: 6e61 626c 6522 5d0a 0a20 2020 2064 6566  nable"]..    def
+0002ae80: 2062 696e 6428 7365 6c66 2c20 2a2a 6b77   bind(self, **kw
+0002ae90: 6172 6773 3a20 416e 7929 202d 3e20 5275  args: Any) -> Ru
+0002aea0: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
+0002aeb0: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
+0002aec0: 2222 4269 6e64 2061 6464 6974 696f 6e61  ""Bind additiona
+0002aed0: 6c20 6b77 6172 6773 2074 6f20 6120 5275  l kwargs to a Ru
+0002aee0: 6e6e 6162 6c65 2c20 7265 7475 726e 696e  nnable, returnin
+0002aef0: 6720 6120 6e65 7720 5275 6e6e 6162 6c65  g a new Runnable
+0002af00: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+0002af10: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+0002af20: 7761 7267 733a 2054 6865 206b 7761 7267  wargs: The kwarg
+0002af30: 7320 746f 2062 696e 6420 746f 2074 6865  s to bind to the
+0002af40: 2052 756e 6e61 626c 652e 0a0a 2020 2020   Runnable...    
+0002af50: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0002af60: 2020 2020 2020 2020 2041 206e 6577 2052           A new R
+0002af70: 756e 6e61 626c 6520 7769 7468 2074 6865  unnable with the
+0002af80: 2073 616d 6520 7479 7065 2061 6e64 2063   same type and c
+0002af90: 6f6e 6669 6720 6173 2074 6865 206f 7269  onfig as the ori
+0002afa0: 6769 6e61 6c2c 0a20 2020 2020 2020 2020  ginal,.         
+0002afb0: 2020 2062 7574 2077 6974 6820 7468 6520     but with the 
+0002afc0: 6164 6469 7469 6f6e 616c 206b 7761 7267  additional kwarg
+0002afd0: 7320 626f 756e 642e 0a20 2020 2020 2020  s bound..       
+0002afe0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+0002aff0: 7572 6e20 7365 6c66 2e5f 5f63 6c61 7373  urn self.__class
+0002b000: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
+0002b010: 626f 756e 643d 7365 6c66 2e62 6f75 6e64  bound=self.bound
+0002b020: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+0002b030: 6e66 6967 3d73 656c 662e 636f 6e66 6967  nfig=self.config
+0002b040: 2c0a 2020 2020 2020 2020 2020 2020 6b77  ,.            kw
+0002b050: 6172 6773 3d7b 2a2a 7365 6c66 2e6b 7761  args={**self.kwa
+0002b060: 7267 732c 202a 2a6b 7761 7267 737d 2c0a  rgs, **kwargs},.
+0002b070: 2020 2020 2020 2020 2020 2020 6375 7374              cust
+0002b080: 6f6d 5f69 6e70 7574 5f74 7970 653d 7365  om_input_type=se
+0002b090: 6c66 2e63 7573 746f 6d5f 696e 7075 745f  lf.custom_input_
+0002b0a0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0002b0b0: 2020 6375 7374 6f6d 5f6f 7574 7075 745f    custom_output_
+0002b0c0: 7479 7065 3d73 656c 662e 6375 7374 6f6d  type=self.custom
+0002b0d0: 5f6f 7574 7075 745f 7479 7065 2c0a 2020  _output_type,.  
+0002b0e0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+0002b0f0: 2077 6974 685f 636f 6e66 6967 280a 2020   with_config(.  
+0002b100: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0002b110: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+0002b120: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+0002b130: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+0002b140: 2020 2020 2023 2053 6164 6c79 2055 6e70       # Sadly Unp
+0002b150: 6163 6b20 6973 206e 6f74 2077 656c 6c20  ack is not well 
+0002b160: 7375 7070 6f72 7465 6420 6279 206d 7970  supported by myp
+0002b170: 7920 736f 2074 6869 7320 7769 6c6c 2068  y so this will h
+0002b180: 6176 6520 746f 2062 6520 756e 7479 7065  ave to be untype
+0002b190: 640a 2020 2020 2020 2020 2a2a 6b77 6172  d.        **kwar
+0002b1a0: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
+0002b1b0: 3e20 5275 6e6e 6162 6c65 5b49 6e70 7574  > Runnable[Input
+0002b1c0: 2c20 4f75 7470 7574 5d3a 0a20 2020 2020  , Output]:.     
+0002b1d0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0002b1e0: 5f63 6c61 7373 5f5f 280a 2020 2020 2020  _class__(.      
+0002b1f0: 2020 2020 2020 626f 756e 643d 7365 6c66        bound=self
+0002b200: 2e62 6f75 6e64 2c0a 2020 2020 2020 2020  .bound,.        
+0002b210: 2020 2020 6b77 6172 6773 3d73 656c 662e      kwargs=self.
+0002b220: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+0002b230: 2020 2020 636f 6e66 6967 3d63 6173 7428      config=cast(
+0002b240: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
+0002b250: 7b2a 2a73 656c 662e 636f 6e66 6967 2c20  {**self.config, 
+0002b260: 2a2a 2863 6f6e 6669 6720 6f72 207b 7d29  **(config or {})
+0002b270: 2c20 2a2a 6b77 6172 6773 7d29 2c0a 2020  , **kwargs}),.  
+0002b280: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
+0002b290: 5f69 6e70 7574 5f74 7970 653d 7365 6c66  _input_type=self
+0002b2a0: 2e63 7573 746f 6d5f 696e 7075 745f 7479  .custom_input_ty
+0002b2b0: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+0002b2c0: 6375 7374 6f6d 5f6f 7574 7075 745f 7479  custom_output_ty
+0002b2d0: 7065 3d73 656c 662e 6375 7374 6f6d 5f6f  pe=self.custom_o
+0002b2e0: 7574 7075 745f 7479 7065 2c0a 2020 2020  utput_type,.    
+0002b2f0: 2020 2020 290a 0a20 2020 2064 6566 2077      )..    def w
+0002b300: 6974 685f 6c69 7374 656e 6572 7328 0a20  ith_listeners(. 
+0002b310: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0002b320: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
+0002b330: 6f6e 5f73 7461 7274 3a20 4f70 7469 6f6e  on_start: Option
+0002b340: 616c 5b0a 2020 2020 2020 2020 2020 2020  al[.            
+0002b350: 556e 696f 6e5b 4361 6c6c 6162 6c65 5b5b  Union[Callable[[
+0002b360: 5275 6e5d 2c20 4e6f 6e65 5d2c 2043 616c  Run], None], Cal
+0002b370: 6c61 626c 655b 5b52 756e 2c20 5275 6e6e  lable[[Run, Runn
+0002b380: 6162 6c65 436f 6e66 6967 5d2c 204e 6f6e  ableConfig], Non
+0002b390: 655d 5d0a 2020 2020 2020 2020 5d20 3d20  e]].        ] = 
+0002b3a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f6e  None,.        on
+0002b3b0: 5f65 6e64 3a20 4f70 7469 6f6e 616c 5b0a  _end: Optional[.
+0002b3c0: 2020 2020 2020 2020 2020 2020 556e 696f              Unio
+0002b3d0: 6e5b 4361 6c6c 6162 6c65 5b5b 5275 6e5d  n[Callable[[Run]
+0002b3e0: 2c20 4e6f 6e65 5d2c 2043 616c 6c61 626c  , None], Callabl
+0002b3f0: 655b 5b52 756e 2c20 5275 6e6e 6162 6c65  e[[Run, Runnable
+0002b400: 436f 6e66 6967 5d2c 204e 6f6e 655d 5d0a  Config], None]].
+0002b410: 2020 2020 2020 2020 5d20 3d20 4e6f 6e65          ] = None
+0002b420: 2c0a 2020 2020 2020 2020 6f6e 5f65 7272  ,.        on_err
+0002b430: 6f72 3a20 4f70 7469 6f6e 616c 5b0a 2020  or: Optional[.  
+0002b440: 2020 2020 2020 2020 2020 556e 696f 6e5b            Union[
+0002b450: 4361 6c6c 6162 6c65 5b5b 5275 6e5d 2c20  Callable[[Run], 
+0002b460: 4e6f 6e65 5d2c 2043 616c 6c61 626c 655b  None], Callable[
+0002b470: 5b52 756e 2c20 5275 6e6e 6162 6c65 436f  [Run, RunnableCo
+0002b480: 6e66 6967 5d2c 204e 6f6e 655d 5d0a 2020  nfig], None]].  
+0002b490: 2020 2020 2020 5d20 3d20 4e6f 6e65 2c0a        ] = None,.
+0002b4a0: 2020 2020 2920 2d3e 2052 756e 6e61 626c      ) -> Runnabl
+0002b4b0: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
+0002b4c0: 3a0a 2020 2020 2020 2020 2222 2242 696e  :.        """Bin
+0002b4d0: 6420 6c69 6665 6379 636c 6520 6c69 7374  d lifecycle list
+0002b4e0: 656e 6572 7320 746f 2061 2052 756e 6e61  eners to a Runna
+0002b4f0: 626c 652c 2072 6574 7572 6e69 6e67 2061  ble, returning a
+0002b500: 206e 6577 2052 756e 6e61 626c 652e 0a0a   new Runnable...
+0002b510: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+0002b520: 2020 2020 2020 2020 2020 6f6e 5f73 7461            on_sta
+0002b530: 7274 3a20 4361 6c6c 6564 2062 6566 6f72  rt: Called befor
+0002b540: 6520 7468 6520 7275 6e6e 6162 6c65 2073  e the runnable s
+0002b550: 7461 7274 7320 7275 6e6e 696e 672c 2077  tarts running, w
+0002b560: 6974 6820 7468 6520 5275 6e20 6f62 6a65  ith the Run obje
+0002b570: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
+0002b580: 6f6e 5f65 6e64 3a20 4361 6c6c 6564 2061  on_end: Called a
+0002b590: 6674 6572 2074 6865 2072 756e 6e61 626c  fter the runnabl
+0002b5a0: 6520 6669 6e69 7368 6573 2072 756e 6e69  e finishes runni
+0002b5b0: 6e67 2c20 7769 7468 2074 6865 2052 756e  ng, with the Run
+0002b5c0: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
+0002b5d0: 2020 2020 206f 6e5f 6572 726f 723a 2043       on_error: C
+0002b5e0: 616c 6c65 6420 6966 2074 6865 2072 756e  alled if the run
+0002b5f0: 6e61 626c 6520 7468 726f 7773 2061 6e20  nable throws an 
+0002b600: 6572 726f 722c 2077 6974 6820 7468 6520  error, with the 
+0002b610: 5275 6e20 6f62 6a65 6374 2e0a 0a20 2020  Run object...   
+0002b620: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+0002b630: 2020 2020 2020 2020 2020 5468 6520 5275            The Ru
+0002b640: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
+0002b650: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
+0002b660: 6f75 7420 7468 6520 7275 6e2c 2069 6e63  out the run, inc
+0002b670: 6c75 6469 6e67 2069 7473 2069 642c 0a20  luding its id,. 
+0002b680: 2020 2020 2020 2020 2020 2074 7970 652c             type,
+0002b690: 2069 6e70 7574 2c20 6f75 7470 7574 2c20   input, output, 
+0002b6a0: 6572 726f 722c 2073 7461 7274 5f74 696d  error, start_tim
+0002b6b0: 652c 2065 6e64 5f74 696d 652c 2061 6e64  e, end_time, and
+0002b6c0: 2061 6e79 2074 6167 7320 6f72 206d 6574   any tags or met
+0002b6d0: 6164 6174 610a 2020 2020 2020 2020 2020  adata.          
+0002b6e0: 2020 6164 6465 6420 746f 2074 6865 2072    added to the r
+0002b6f0: 756e 2e0a 2020 2020 2020 2020 2222 220a  un..        """.
+0002b700: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0002b710: 6763 6861 696e 5f63 6f72 652e 7472 6163  gchain_core.trac
+0002b720: 6572 732e 726f 6f74 5f6c 6973 7465 6e65  ers.root_listene
+0002b730: 7273 2069 6d70 6f72 7420 526f 6f74 4c69  rs import RootLi
+0002b740: 7374 656e 6572 7354 7261 6365 720a 0a20  stenersTracer.. 
+0002b750: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0002b760: 6c66 2e5f 5f63 6c61 7373 5f5f 280a 2020  lf.__class__(.  
+0002b770: 2020 2020 2020 2020 2020 626f 756e 643d            bound=
+0002b780: 7365 6c66 2e62 6f75 6e64 2c0a 2020 2020  self.bound,.    
+0002b790: 2020 2020 2020 2020 6b77 6172 6773 3d73          kwargs=s
+0002b7a0: 656c 662e 6b77 6172 6773 2c0a 2020 2020  elf.kwargs,.    
+0002b7b0: 2020 2020 2020 2020 636f 6e66 6967 3d73          config=s
+0002b7c0: 656c 662e 636f 6e66 6967 2c0a 2020 2020  elf.config,.    
+0002b7d0: 2020 2020 2020 2020 636f 6e66 6967 5f66          config_f
+0002b7e0: 6163 746f 7269 6573 3d5b 0a20 2020 2020  actories=[.     
+0002b7f0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+0002b800: 6120 636f 6e66 6967 3a20 7b0a 2020 2020  a config: {.    
+0002b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b820: 2263 616c 6c62 6163 6b73 223a 205b 0a20  "callbacks": [. 
+0002b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b840: 2020 2020 2020 2052 6f6f 744c 6973 7465         RootListe
+0002b850: 6e65 7273 5472 6163 6572 280a 2020 2020  nersTracer(.    
+0002b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b870: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
+0002b880: 6f6e 6669 672c 0a20 2020 2020 2020 2020  onfig,.         
+0002b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8a0: 2020 206f 6e5f 7374 6172 743d 6f6e 5f73     on_start=on_s
+0002b8b0: 7461 7274 2c0a 2020 2020 2020 2020 2020  tart,.          
+0002b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8d0: 2020 6f6e 5f65 6e64 3d6f 6e5f 656e 642c    on_end=on_end,
+0002b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b8f0: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
+0002b900: 6572 726f 723d 6f6e 5f65 7272 6f72 2c0a  error=on_error,.
+0002b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b920: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002b930: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+0002b940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b950: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
+0002b960: 2c0a 2020 2020 2020 2020 2020 2020 6375  ,.            cu
+0002b970: 7374 6f6d 5f69 6e70 7574 5f74 7970 653d  stom_input_type=
+0002b980: 7365 6c66 2e63 7573 746f 6d5f 696e 7075  self.custom_inpu
+0002b990: 745f 7479 7065 2c0a 2020 2020 2020 2020  t_type,.        
+0002b9a0: 2020 2020 6375 7374 6f6d 5f6f 7574 7075      custom_outpu
+0002b9b0: 745f 7479 7065 3d73 656c 662e 6375 7374  t_type=self.cust
+0002b9c0: 6f6d 5f6f 7574 7075 745f 7479 7065 2c0a  om_output_type,.
+0002b9d0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+0002b9e0: 6566 2077 6974 685f 7479 7065 7328 0a20  ef with_types(. 
+0002b9f0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0002ba00: 2020 2020 2069 6e70 7574 5f74 7970 653a       input_type:
+0002ba10: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+0002ba20: 5479 7065 5b49 6e70 7574 5d2c 2042 6173  Type[Input], Bas
+0002ba30: 654d 6f64 656c 5d5d 203d 204e 6f6e 652c  eModel]] = None,
+0002ba40: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+0002ba50: 7479 7065 3a20 4f70 7469 6f6e 616c 5b55  type: Optional[U
+0002ba60: 6e69 6f6e 5b54 7970 655b 4f75 7470 7574  nion[Type[Output
+0002ba70: 5d2c 2042 6173 654d 6f64 656c 5d5d 203d  ], BaseModel]] =
+0002ba80: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+0002ba90: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
+0002baa0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+0002bab0: 2072 6574 7572 6e20 7365 6c66 2e5f 5f63   return self.__c
+0002bac0: 6c61 7373 5f5f 280a 2020 2020 2020 2020  lass__(.        
+0002bad0: 2020 2020 626f 756e 643d 7365 6c66 2e62      bound=self.b
+0002bae0: 6f75 6e64 2c0a 2020 2020 2020 2020 2020  ound,.          
+0002baf0: 2020 6b77 6172 6773 3d73 656c 662e 6b77    kwargs=self.kw
+0002bb00: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
+0002bb10: 2020 636f 6e66 6967 3d73 656c 662e 636f    config=self.co
+0002bb20: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
+0002bb30: 2020 6375 7374 6f6d 5f69 6e70 7574 5f74    custom_input_t
+0002bb40: 7970 653d 280a 2020 2020 2020 2020 2020  ype=(.          
+0002bb50: 2020 2020 2020 696e 7075 745f 7479 7065        input_type
+0002bb60: 2069 6620 696e 7075 745f 7479 7065 2069   if input_type i
+0002bb70: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+0002bb80: 7365 6c66 2e63 7573 746f 6d5f 696e 7075  self.custom_inpu
+0002bb90: 745f 7479 7065 0a20 2020 2020 2020 2020  t_type.         
+0002bba0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+0002bbb0: 2020 6375 7374 6f6d 5f6f 7574 7075 745f    custom_output_
+0002bbc0: 7479 7065 3d28 0a20 2020 2020 2020 2020  type=(.         
+0002bbd0: 2020 2020 2020 206f 7574 7075 745f 7479         output_ty
+0002bbe0: 7065 2069 6620 6f75 7470 7574 5f74 7970  pe if output_typ
+0002bbf0: 6520 6973 206e 6f74 204e 6f6e 6520 656c  e is not None el
+0002bc00: 7365 2073 656c 662e 6375 7374 6f6d 5f6f  se self.custom_o
+0002bc10: 7574 7075 745f 7479 7065 0a20 2020 2020  utput_type.     
+0002bc20: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0002bc30: 2020 290a 0a20 2020 2064 6566 2077 6974    )..    def wit
+0002bc40: 685f 7265 7472 7928 7365 6c66 2c20 2a2a  h_retry(self, **
+0002bc50: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
+0002bc60: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
+0002bc70: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+0002bc80: 2072 6574 7572 6e20 7365 6c66 2e5f 5f63   return self.__c
+0002bc90: 6c61 7373 5f5f 280a 2020 2020 2020 2020  lass__(.        
+0002bca0: 2020 2020 626f 756e 643d 7365 6c66 2e62      bound=self.b
+0002bcb0: 6f75 6e64 2e77 6974 685f 7265 7472 7928  ound.with_retry(
+0002bcc0: 2a2a 6b77 6172 6773 292c 0a20 2020 2020  **kwargs),.     
+0002bcd0: 2020 2020 2020 206b 7761 7267 733d 7365         kwargs=se
+0002bce0: 6c66 2e6b 7761 7267 732c 0a20 2020 2020  lf.kwargs,.     
+0002bcf0: 2020 2020 2020 2063 6f6e 6669 673d 7365         config=se
+0002bd00: 6c66 2e63 6f6e 6669 672c 0a20 2020 2020  lf.config,.     
+0002bd10: 2020 2029 0a0a 2020 2020 6465 6620 5f5f     )..    def __
+0002bd20: 6765 7461 7474 725f 5f28 7365 6c66 2c20  getattr__(self, 
+0002bd30: 6e61 6d65 3a20 7374 7229 202d 3e20 416e  name: str) -> An
+0002bd40: 793a 0a20 2020 2020 2020 2061 7474 7220  y:.        attr 
+0002bd50: 3d20 6765 7461 7474 7228 7365 6c66 2e62  = getattr(self.b
+0002bd60: 6f75 6e64 2c20 6e61 6d65 290a 0a20 2020  ound, name)..   
+0002bd70: 2020 2020 2069 6620 6361 6c6c 6162 6c65       if callable
+0002bd80: 2861 7474 7229 2061 6e64 2028 0a20 2020  (attr) and (.   
+0002bd90: 2020 2020 2020 2020 2063 6f6e 6669 675f           config_
+0002bda0: 7061 7261 6d20 3a3d 2069 6e73 7065 6374  param := inspect
+0002bdb0: 2e73 6967 6e61 7475 7265 2861 7474 7229  .signature(attr)
+0002bdc0: 2e70 6172 616d 6574 6572 732e 6765 7428  .parameters.get(
+0002bdd0: 2263 6f6e 6669 6722 290a 2020 2020 2020  "config").      
+0002bde0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0002bdf0: 2069 6620 636f 6e66 6967 5f70 6172 616d   if config_param
+0002be00: 2e6b 696e 6420 3d3d 2069 6e73 7065 6374  .kind == inspect
+0002be10: 2e50 6172 616d 6574 6572 2e4b 4559 574f  .Parameter.KEYWO
+0002be20: 5244 5f4f 4e4c 593a 0a0a 2020 2020 2020  RD_ONLY:..      
+0002be30: 2020 2020 2020 2020 2020 4077 7261 7073            @wraps
+0002be40: 2861 7474 7229 0a20 2020 2020 2020 2020  (attr).         
+0002be50: 2020 2020 2020 2064 6566 2077 7261 7070         def wrapp
+0002be60: 6572 282a 6172 6773 3a20 416e 792c 202a  er(*args: Any, *
+0002be70: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
+0002be80: 2041 6e79 3a0a 2020 2020 2020 2020 2020   Any:.          
+0002be90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002bea0: 2061 7474 7228 0a20 2020 2020 2020 2020   attr(.         
+0002beb0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0002bec0: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
+0002bed0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0002bee0: 6e66 6967 3d6d 6572 6765 5f63 6f6e 6669  nfig=merge_confi
+0002bef0: 6773 2873 656c 662e 636f 6e66 6967 2c20  gs(self.config, 
+0002bf00: 6b77 6172 6773 2e70 6f70 2822 636f 6e66  kwargs.pop("conf
+0002bf10: 6967 222c 204e 6f6e 6529 292c 0a20 2020  ig", None)),.   
+0002bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf30: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+0002bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf50: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0002bf60: 2020 2020 2020 7265 7475 726e 2077 7261        return wra
+0002bf70: 7070 6572 0a20 2020 2020 2020 2020 2020  pper.           
+0002bf80: 2065 6c69 6620 636f 6e66 6967 5f70 6172   elif config_par
+0002bf90: 616d 2e6b 696e 6420 3d3d 2069 6e73 7065  am.kind == inspe
+0002bfa0: 6374 2e50 6172 616d 6574 6572 2e50 4f53  ct.Parameter.POS
+0002bfb0: 4954 494f 4e41 4c5f 4f52 5f4b 4559 574f  ITIONAL_OR_KEYWO
+0002bfc0: 5244 3a0a 2020 2020 2020 2020 2020 2020  RD:.            
+0002bfd0: 2020 2020 6964 7820 3d20 6c69 7374 2869      idx = list(i
+0002bfe0: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
+0002bff0: 2861 7474 7229 2e70 6172 616d 6574 6572  (attr).parameter
+0002c000: 7329 2e69 6e64 6578 2822 636f 6e66 6967  s).index("config
+0002c010: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+0002c020: 2020 2020 4077 7261 7073 2861 7474 7229      @wraps(attr)
+0002c030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c040: 2064 6566 2077 7261 7070 6572 282a 6172   def wrapper(*ar
+0002c050: 6773 3a20 416e 792c 202a 2a6b 7761 7267  gs: Any, **kwarg
+0002c060: 733a 2041 6e79 2920 2d3e 2041 6e79 3a0a  s: Any) -> Any:.
+0002c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c080: 2020 2020 6966 206c 656e 2861 7267 7329      if len(args)
+0002c090: 203e 3d20 6964 7820 2b20 313a 0a20 2020   >= idx + 1:.   
+0002c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c0b0: 2020 2020 2061 7267 736c 203d 206c 6973       argsl = lis
+0002c0c0: 7428 6172 6773 290a 2020 2020 2020 2020  t(args).        
+0002c0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c0e0: 6172 6773 6c5b 6964 785d 203d 206d 6572  argsl[idx] = mer
+0002c0f0: 6765 5f63 6f6e 6669 6773 2873 656c 662e  ge_configs(self.
+0002c100: 636f 6e66 6967 2c20 6172 6773 6c5b 6964  config, argsl[id
+0002c110: 785d 290a 2020 2020 2020 2020 2020 2020  x]).            
+0002c120: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002c130: 726e 2061 7474 7228 2a61 7267 736c 2c20  rn attr(*argsl, 
+0002c140: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+0002c150: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0002c160: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002c170: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002c180: 726e 2061 7474 7228 0a20 2020 2020 2020  rn attr(.       
+0002c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1a0: 2020 2020 202a 6172 6773 2c0a 2020 2020       *args,.    
+0002c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1c0: 2020 2020 2020 2020 636f 6e66 6967 3d6d          config=m
+0002c1d0: 6572 6765 5f63 6f6e 6669 6773 280a 2020  erge_configs(.  
+0002c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0002c200: 6c66 2e63 6f6e 6669 672c 206b 7761 7267  lf.config, kwarg
+0002c210: 732e 706f 7028 2263 6f6e 6669 6722 2c20  s.pop("config", 
+0002c220: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+0002c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c240: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+0002c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c260: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0002c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c280: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0002c290: 2020 2020 2020 7265 7475 726e 2077 7261        return wra
+0002c2a0: 7070 6572 0a0a 2020 2020 2020 2020 7265  pper..        re
+0002c2b0: 7475 726e 2061 7474 720a 0a0a 5275 6e6e  turn attr...Runn
+0002c2c0: 6162 6c65 4c69 6b65 203d 2055 6e69 6f6e  ableLike = Union
+0002c2d0: 5b0a 2020 2020 5275 6e6e 6162 6c65 5b49  [.    Runnable[I
+0002c2e0: 6e70 7574 2c20 4f75 7470 7574 5d2c 0a20  nput, Output],. 
+0002c2f0: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
+0002c300: 7574 5d2c 204f 7574 7075 745d 2c0a 2020  ut], Output],.  
+0002c310: 2020 4361 6c6c 6162 6c65 5b5b 496e 7075    Callable[[Inpu
+0002c320: 745d 2c20 4177 6169 7461 626c 655b 4f75  t], Awaitable[Ou
+0002c330: 7470 7574 5d5d 2c0a 2020 2020 4361 6c6c  tput]],.    Call
+0002c340: 6162 6c65 5b5b 4974 6572 6174 6f72 5b49  able[[Iterator[I
+0002c350: 6e70 7574 5d5d 2c20 4974 6572 6174 6f72  nput]], Iterator
+0002c360: 5b4f 7574 7075 745d 5d2c 0a20 2020 2043  [Output]],.    C
+0002c370: 616c 6c61 626c 655b 5b41 7379 6e63 4974  allable[[AsyncIt
+0002c380: 6572 6174 6f72 5b49 6e70 7574 5d5d 2c20  erator[Input]], 
+0002c390: 4173 796e 6349 7465 7261 746f 725b 4f75  AsyncIterator[Ou
+0002c3a0: 7470 7574 5d5d 2c0a 2020 2020 4d61 7070  tput]],.    Mapp
+0002c3b0: 696e 675b 7374 722c 2041 6e79 5d2c 0a5d  ing[str, Any],.]
+0002c3c0: 0a0a 0a64 6566 2063 6f65 7263 655f 746f  ...def coerce_to
+0002c3d0: 5f72 756e 6e61 626c 6528 7468 696e 673a  _runnable(thing:
+0002c3e0: 2052 756e 6e61 626c 654c 696b 6529 202d   RunnableLike) -
+0002c3f0: 3e20 5275 6e6e 6162 6c65 5b49 6e70 7574  > Runnable[Input
+0002c400: 2c20 4f75 7470 7574 5d3a 0a20 2020 2022  , Output]:.    "
+0002c410: 2222 436f 6572 6365 2061 2072 756e 6e61  ""Coerce a runna
+0002c420: 626c 652d 6c69 6b65 206f 626a 6563 7420  ble-like object 
+0002c430: 696e 746f 2061 2052 756e 6e61 626c 652e  into a Runnable.
+0002c440: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0002c450: 2020 2020 7468 696e 673a 2041 2072 756e      thing: A run
+0002c460: 6e61 626c 652d 6c69 6b65 206f 626a 6563  nable-like objec
+0002c470: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
+0002c480: 0a20 2020 2020 2020 2041 2052 756e 6e61  .        A Runna
+0002c490: 626c 652e 0a20 2020 2022 2222 0a20 2020  ble..    """.   
+0002c4a0: 2069 6620 6973 696e 7374 616e 6365 2874   if isinstance(t
+0002c4b0: 6869 6e67 2c20 5275 6e6e 6162 6c65 293a  hing, Runnable):
+0002c4c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002c4d0: 7468 696e 670a 2020 2020 656c 6966 2069  thing.    elif i
+0002c4e0: 735f 6173 796e 635f 6765 6e65 7261 746f  s_async_generato
+0002c4f0: 7228 7468 696e 6729 206f 7220 696e 7370  r(thing) or insp
+0002c500: 6563 742e 6973 6765 6e65 7261 746f 7266  ect.isgeneratorf
+0002c510: 756e 6374 696f 6e28 7468 696e 6729 3a0a  unction(thing):.
+0002c520: 2020 2020 2020 2020 7265 7475 726e 2052          return R
+0002c530: 756e 6e61 626c 6547 656e 6572 6174 6f72  unnableGenerator
+0002c540: 2874 6869 6e67 290a 2020 2020 656c 6966  (thing).    elif
+0002c550: 2063 616c 6c61 626c 6528 7468 696e 6729   callable(thing)
+0002c560: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0002c570: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
+0002c580: 6361 7374 2843 616c 6c61 626c 655b 5b49  cast(Callable[[I
+0002c590: 6e70 7574 5d2c 204f 7574 7075 745d 2c20  nput], Output], 
+0002c5a0: 7468 696e 6729 290a 2020 2020 656c 6966  thing)).    elif
+0002c5b0: 2069 7369 6e73 7461 6e63 6528 7468 696e   isinstance(thin
+0002c5c0: 672c 2064 6963 7429 3a0a 2020 2020 2020  g, dict):.      
+0002c5d0: 2020 7265 7475 726e 2063 6173 7428 5275    return cast(Ru
+0002c5e0: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
+0002c5f0: 7470 7574 5d2c 2052 756e 6e61 626c 6550  tput], RunnableP
+0002c600: 6172 616c 6c65 6c28 7468 696e 6729 290a  arallel(thing)).
+0002c610: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002c620: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
+0002c630: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
+0002c640: 2245 7870 6563 7465 6420 6120 5275 6e6e  "Expected a Runn
+0002c650: 6162 6c65 2c20 6361 6c6c 6162 6c65 206f  able, callable o
+0002c660: 7220 6469 6374 2e22 0a20 2020 2020 2020  r dict.".       
+0002c670: 2020 2020 2066 2249 6e73 7465 6164 2067       f"Instead g
+0002c680: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
+0002c690: 6420 7479 7065 3a20 7b74 7970 6528 7468  d type: {type(th
+0002c6a0: 696e 6729 7d22 0a20 2020 2020 2020 2029  ing)}".        )
+0002c6b0: 0a0a 0a40 6f76 6572 6c6f 6164 0a64 6566  ...@overload.def
+0002c6c0: 2063 6861 696e 280a 2020 2020 6675 6e63   chain(.    func
+0002c6d0: 3a20 4361 6c6c 6162 6c65 5b5b 496e 7075  : Callable[[Inpu
+0002c6e0: 745d 2c20 436f 726f 7574 696e 655b 416e  t], Coroutine[An
+0002c6f0: 792c 2041 6e79 2c20 4f75 7470 7574 5d5d  y, Any, Output]]
+0002c700: 2c0a 2920 2d3e 2052 756e 6e61 626c 655b  ,.) -> Runnable[
+0002c710: 496e 7075 742c 204f 7574 7075 745d 3a0a  Input, Output]:.
+0002c720: 2020 2020 2e2e 2e0a 0a0a 406f 7665 726c      ......@overl
+0002c730: 6f61 640a 6465 6620 6368 6169 6e28 0a20  oad.def chain(. 
+0002c740: 2020 2066 756e 633a 2043 616c 6c61 626c     func: Callabl
+0002c750: 655b 5b49 6e70 7574 5d2c 2049 7465 7261  e[[Input], Itera
+0002c760: 746f 725b 4f75 7470 7574 5d5d 2c0a 2920  tor[Output]],.) 
+0002c770: 2d3e 2052 756e 6e61 626c 655b 496e 7075  -> Runnable[Inpu
+0002c780: 742c 204f 7574 7075 745d 3a0a 2020 2020  t, Output]:.    
+0002c790: 2e2e 2e0a 0a0a 406f 7665 726c 6f61 640a  ......@overload.
+0002c7a0: 6465 6620 6368 6169 6e28 0a20 2020 2066  def chain(.    f
+0002c7b0: 756e 633a 2043 616c 6c61 626c 655b 5b49  unc: Callable[[I
+0002c7c0: 6e70 7574 5d2c 2041 7379 6e63 4974 6572  nput], AsyncIter
+0002c7d0: 6174 6f72 5b4f 7574 7075 745d 5d2c 0a29  ator[Output]],.)
+0002c7e0: 202d 3e20 5275 6e6e 6162 6c65 5b49 6e70   -> Runnable[Inp
+0002c7f0: 7574 2c20 4f75 7470 7574 5d3a 0a20 2020  ut, Output]:.   
+0002c800: 202e 2e2e 0a0a 0a40 6f76 6572 6c6f 6164   ......@overload
+0002c810: 0a64 6566 2063 6861 696e 280a 2020 2020  .def chain(.    
+0002c820: 6675 6e63 3a20 4361 6c6c 6162 6c65 5b5b  func: Callable[[
+0002c830: 496e 7075 745d 2c20 4f75 7470 7574 5d2c  Input], Output],
+0002c840: 0a29 202d 3e20 5275 6e6e 6162 6c65 5b49  .) -> Runnable[I
+0002c850: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
+0002c860: 2020 202e 2e2e 0a0a 0a64 6566 2063 6861     ......def cha
+0002c870: 696e 280a 2020 2020 6675 6e63 3a20 556e  in(.    func: Un
+0002c880: 696f 6e5b 0a20 2020 2020 2020 2043 616c  ion[.        Cal
+0002c890: 6c61 626c 655b 5b49 6e70 7574 5d2c 204f  lable[[Input], O
+0002c8a0: 7574 7075 745d 2c0a 2020 2020 2020 2020  utput],.        
+0002c8b0: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
+0002c8c0: 2c20 4974 6572 6174 6f72 5b4f 7574 7075  , Iterator[Outpu
+0002c8d0: 745d 5d2c 0a20 2020 2020 2020 2043 616c  t]],.        Cal
+0002c8e0: 6c61 626c 655b 5b49 6e70 7574 5d2c 2043  lable[[Input], C
+0002c8f0: 6f72 6f75 7469 6e65 5b41 6e79 2c20 416e  oroutine[Any, An
+0002c900: 792c 204f 7574 7075 745d 5d2c 0a20 2020  y, Output]],.   
+0002c910: 2020 2020 2043 616c 6c61 626c 655b 5b49       Callable[[I
+0002c920: 6e70 7574 5d2c 2041 7379 6e63 4974 6572  nput], AsyncIter
+0002c930: 6174 6f72 5b4f 7574 7075 745d 5d2c 0a20  ator[Output]],. 
+0002c940: 2020 205d 2c0a 2920 2d3e 2052 756e 6e61     ],.) -> Runna
+0002c950: 626c 655b 496e 7075 742c 204f 7574 7075  ble[Input, Outpu
+0002c960: 745d 3a0a 2020 2020 2222 2244 6563 6f72  t]:.    """Decor
+0002c970: 6174 6520 6120 6675 6e63 7469 6f6e 2074  ate a function t
+0002c980: 6f20 6d61 6b65 2069 7420 6120 5275 6e6e  o make it a Runn
+0002c990: 6162 6c65 2e0a 2020 2020 5365 7473 2074  able..    Sets t
+0002c9a0: 6865 206e 616d 6520 6f66 2074 6865 2072  he name of the r
+0002c9b0: 756e 6e61 626c 6520 746f 2074 6865 206e  unnable to the n
+0002c9c0: 616d 6520 6f66 2074 6865 2066 756e 6374  ame of the funct
+0002c9d0: 696f 6e2e 0a20 2020 2041 6e79 2072 756e  ion..    Any run
+0002c9e0: 6e61 626c 6573 2063 616c 6c65 6420 6279  nables called by
+0002c9f0: 2074 6865 2066 756e 6374 696f 6e20 7769   the function wi
+0002ca00: 6c6c 2062 6520 7472 6163 6564 2061 7320  ll be traced as 
+0002ca10: 6465 7065 6e64 656e 6369 6573 2e0a 0a20  dependencies... 
+0002ca20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0002ca30: 2066 756e 633a 2041 2063 616c 6c61 626c   func: A callabl
+0002ca40: 652e 0a0a 2020 2020 5265 7475 726e 733a  e...    Returns:
+0002ca50: 0a20 2020 2020 2020 2041 2052 756e 6e61  .        A Runna
+0002ca60: 626c 652e 0a0a 2020 2020 4578 616d 706c  ble...    Exampl
+0002ca70: 653a 0a0a 2020 2020 2e2e 2063 6f64 652d  e:..    .. code-
+0002ca80: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
+0002ca90: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0002caa0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
+0002cab0: 6162 6c65 7320 696d 706f 7274 2063 6861  ables import cha
+0002cac0: 696e 0a20 2020 2020 2020 2066 726f 6d20  in.        from 
+0002cad0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e70  langchain_core.p
+0002cae0: 726f 6d70 7473 2069 6d70 6f72 7420 5072  rompts import Pr
+0002caf0: 6f6d 7074 5465 6d70 6c61 7465 0a20 2020  omptTemplate.   
+0002cb00: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+0002cb10: 6169 6e5f 6f70 656e 6169 2069 6d70 6f72  ain_openai impor
+0002cb20: 7420 4f70 656e 4149 0a0a 2020 2020 2020  t OpenAI..      
+0002cb30: 2020 4063 6861 696e 0a20 2020 2020 2020    @chain.       
+0002cb40: 2064 6566 206d 795f 6675 6e63 2866 6965   def my_func(fie
+0002cb50: 6c64 7329 3a0a 2020 2020 2020 2020 2020  lds):.          
+0002cb60: 2020 7072 6f6d 7074 203d 2050 726f 6d70    prompt = Promp
+0002cb70: 7454 656d 706c 6174 6528 2248 656c 6c6f  tTemplate("Hello
+0002cb80: 2c20 7b6e 616d 657d 2122 290a 2020 2020  , {name}!").    
+0002cb90: 2020 2020 2020 2020 6c6c 6d20 3d20 4f70          llm = Op
+0002cba0: 656e 4149 2829 0a20 2020 2020 2020 2020  enAI().         
+0002cbb0: 2020 2066 6f72 6d61 7474 6564 203d 2070     formatted = p
+0002cbc0: 726f 6d70 742e 696e 766f 6b65 282a 2a66  rompt.invoke(**f
+0002cbd0: 6965 6c64 7329 0a0a 2020 2020 2020 2020  ields)..        
+0002cbe0: 2020 2020 666f 7220 6368 756e 6b20 696e      for chunk in
+0002cbf0: 206c 6c6d 2e73 7472 6561 6d28 666f 726d   llm.stream(form
+0002cc00: 6174 7465 6429 3a0a 2020 2020 2020 2020  atted):.        
+0002cc10: 2020 2020 2020 2020 7969 656c 6420 6368          yield ch
+0002cc20: 756e 6b0a 2020 2020 2222 220a 2020 2020  unk.    """.    
+0002cc30: 7265 7475 726e 2052 756e 6e61 626c 654c  return RunnableL
+0002cc40: 616d 6264 6128 6675 6e63 290a            ambda(func).
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/branch.py` & `gigachain_core-0.2.0/langchain_core/runnables/branch.py`

 * *Files 3% similar despite different names*

```diff
@@ -34,21 +34,21 @@
     Input,
     Output,
     get_unique_config_specs,
 )
 
 
 class RunnableBranch(RunnableSerializable[Input, Output]):
-    """A Runnable that selects which branch to run based on a condition.
+    """Runnable that selects which branch to run based on a condition.
 
-    The runnable is initialized with a list of (condition, runnable) pairs and
+    The Runnable is initialized with a list of (condition, Runnable) pairs and
     a default branch.
 
     When operating on an input, the first condition that evaluates to True is
-    selected, and the corresponding runnable is run on the input.
+    selected, and the corresponding Runnable is run on the input.
 
     If no condition evaluates to True, the default branch is run on the input.
 
     Examples:
 
         .. code-block:: python
 
@@ -115,15 +115,15 @@
                     f"tuples or lists of length 2, not {len(branch)}"
                 )
             condition, runnable = branch
             condition = cast(Runnable[Input, bool], coerce_to_runnable(condition))
             runnable = coerce_to_runnable(runnable)
             _branches.append((condition, runnable))
 
-        super().__init__(branches=_branches, default=default_)
+        super().__init__(branches=_branches, default=default_)  # type: ignore[call-arg]
 
     class Config:
         arbitrary_types_allowed = True
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """RunnableBranch is serializable if all its branches are serializable."""
@@ -179,14 +179,15 @@
         """First evaluates the condition, then delegate to true or false branch."""
         config = ensure_config(config)
         callback_manager = get_callback_manager_for_config(config)
         run_manager = callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
 
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
 
                 expression_value = condition.invoke(
@@ -227,14 +228,15 @@
         """Async version of invoke."""
         config = ensure_config(config)
         callback_manager = get_async_callback_manager_for_config(config)
         run_manager = await callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
 
                 expression_value = await condition.ainvoke(
                     input,
@@ -278,14 +280,15 @@
         then delegate to true or false branch."""
         config = ensure_config(config)
         callback_manager = get_callback_manager_for_config(config)
         run_manager = callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
         final_output: Optional[Output] = None
         final_output_supported = True
 
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
@@ -352,14 +355,15 @@
         then delegate to true or false branch."""
         config = ensure_config(config)
         callback_manager = get_async_callback_manager_for_config(config)
         run_manager = await callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
         final_output: Optional[Output] = None
         final_output_supported = True
 
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/config.py` & `gigachain_core-0.2.0/langchain_core/runnables/config.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,12 @@
 from __future__ import annotations
 
 import asyncio
+import uuid
+import warnings
 from concurrent.futures import Executor, Future, ThreadPoolExecutor
 from contextlib import contextmanager
 from contextvars import ContextVar, copy_context
 from functools import partial
 from typing import (
     TYPE_CHECKING,
     Any,
@@ -91,14 +93,20 @@
     """
     Runtime values for attributes previously made configurable on this Runnable,
     or sub-Runnables, through .configurable_fields() or .configurable_alternatives().
     Check .output_schema() for a description of the attributes that have been made 
     configurable.
     """
 
+    run_id: Optional[uuid.UUID]
+    """
+    Unique identifier for the tracer run for this call. If not provided, a new UUID
+        will be generated.
+    """
+
 
 var_child_runnable_config = ContextVar(
     "child_runnable_config", default=RunnableConfig()
 )
 
 
 def ensure_config(config: Optional[RunnableConfig] = None) -> RunnableConfig:
@@ -112,23 +120,27 @@
         RunnableConfig: The ensured config.
     """
     empty = RunnableConfig(
         tags=[],
         metadata={},
         callbacks=None,
         recursion_limit=25,
+        run_id=None,
     )
     if var_config := var_child_runnable_config.get():
         empty.update(
             cast(RunnableConfig, {k: v for k, v in var_config.items() if v is not None})
         )
     if config is not None:
         empty.update(
             cast(RunnableConfig, {k: v for k, v in config.items() if v is not None})
         )
+    for key, value in empty.get("configurable", {}).items():
+        if isinstance(value, (str, int, float, bool)) and key not in empty["metadata"]:
+            empty["metadata"][key] = value
     return empty
 
 
 def get_config_list(
     config: Optional[Union[RunnableConfig, List[RunnableConfig]]], length: int
 ) -> List[RunnableConfig]:
     """Get a list of configs from a single config or a list of configs.
@@ -151,19 +163,29 @@
         raise ValueError(f"length must be >= 0, but got {length}")
     if isinstance(config, list) and len(config) != length:
         raise ValueError(
             f"config must be a list of the same length as inputs, "
             f"but got {len(config)} configs for {length} inputs"
         )
 
-    return (
-        list(map(ensure_config, config))
-        if isinstance(config, list)
-        else [ensure_config(config) for _ in range(length)]
-    )
+    if isinstance(config, list):
+        return list(map(ensure_config, config))
+    if length > 1 and isinstance(config, dict) and config.get("run_id") is not None:
+        warnings.warn(
+            "Provided run_id be used only for the first element of the batch.",
+            category=RuntimeWarning,
+        )
+        subsequent = cast(
+            RunnableConfig, {k: v for k, v in config.items() if k != "run_id"}
+        )
+        return [
+            ensure_config(subsequent) if i else ensure_config(config)
+            for i in range(length)
+        ]
+    return [ensure_config(config) for i in range(length)]
 
 
 def patch_config(
     config: Optional[RunnableConfig],
     *,
     callbacks: Optional[BaseCallbackManager] = None,
     recursion_limit: Optional[int] = None,
@@ -192,14 +214,16 @@
     config = ensure_config(config)
     if callbacks is not None:
         # If we're replacing callbacks, we need to unset run_name
         # As that should apply only to the same run as the original callbacks
         config["callbacks"] = callbacks
         if "run_name" in config:
             del config["run_name"]
+        if "run_id" in config:
+            del config["run_id"]
     if recursion_limit is not None:
         config["recursion_limit"] = recursion_limit
     if max_concurrency is not None:
         config["max_concurrency"] = max_concurrency
     if run_name is not None:
         config["run_name"] = run_name
     if configurable is not None:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/configurable.py` & `gigachain_core-0.2.0/langchain_core/runnables/configurable.py`

 * *Files 23% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 
 import enum
 import threading
 from abc import abstractmethod
+from functools import wraps
 from typing import (
     Any,
     AsyncIterator,
     Callable,
     Dict,
     Iterator,
     List,
@@ -22,14 +23,15 @@
 from langchain_core.pydantic_v1 import BaseModel
 from langchain_core.runnables.base import Runnable, RunnableSerializable
 from langchain_core.runnables.config import (
     RunnableConfig,
     ensure_config,
     get_config_list,
     get_executor_for_config,
+    merge_configs,
 )
 from langchain_core.runnables.graph import Graph
 from langchain_core.runnables.utils import (
     AnyConfigurableField,
     ConfigurableField,
     ConfigurableFieldMultiOption,
     ConfigurableFieldSingleOption,
@@ -38,18 +40,20 @@
     Output,
     gather_with_concurrency,
     get_unique_config_specs,
 )
 
 
 class DynamicRunnable(RunnableSerializable[Input, Output]):
-    """A Serializable Runnable that can be dynamically configured."""
+    """Serializable Runnable that can be dynamically configured."""
 
     default: RunnableSerializable[Input, Output]
 
+    config: Optional[RunnableConfig] = None
+
     class Config:
         arbitrary_types_allowed = True
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
@@ -65,55 +69,73 @@
     @property
     def OutputType(self) -> Type[Output]:
         return self.default.OutputType
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.get_input_schema(config)
 
     def get_output_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.get_output_schema(config)
 
     def get_graph(self, config: Optional[RunnableConfig] = None) -> Graph:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.get_graph(config)
 
+    def with_config(
+        self,
+        config: Optional[RunnableConfig] = None,
+        # Sadly Unpack is not well supported by mypy so this will have to be untyped
+        **kwargs: Any,
+    ) -> Runnable[Input, Output]:
+        return self.__class__(
+            **{**self.__dict__, "config": ensure_config(merge_configs(config, kwargs))}  # type: ignore[arg-type]
+        )
+
+    def prepare(
+        self, config: Optional[RunnableConfig] = None
+    ) -> Tuple[Runnable[Input, Output], RunnableConfig]:
+        runnable: Runnable[Input, Output] = self
+        while isinstance(runnable, DynamicRunnable):
+            runnable, config = runnable._prepare(merge_configs(runnable.config, config))
+        return runnable, cast(RunnableConfig, config)
+
     @abstractmethod
     def _prepare(
         self, config: Optional[RunnableConfig] = None
     ) -> Tuple[Runnable[Input, Output], RunnableConfig]:
         ...
 
     def invoke(
         self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
     ) -> Output:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.invoke(input, config, **kwargs)
 
     async def ainvoke(
         self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
     ) -> Output:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return await runnable.ainvoke(input, config, **kwargs)
 
     def batch(
         self,
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
         **kwargs: Optional[Any],
     ) -> List[Output]:
         configs = get_config_list(config, len(inputs))
-        prepared = [self._prepare(c) for c in configs]
+        prepared = [self.prepare(c) for c in configs]
 
         if all(p is self.default for p, _ in prepared):
             return self.default.batch(
                 inputs,
                 [c for _, c in prepared],
                 return_exceptions=return_exceptions,
                 **kwargs,
@@ -147,15 +169,15 @@
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
         **kwargs: Optional[Any],
     ) -> List[Output]:
         configs = get_config_list(config, len(inputs))
-        prepared = [self._prepare(c) for c in configs]
+        prepared = [self.prepare(c) for c in configs]
 
         if all(p is self.default for p, _ in prepared):
             return await self.default.abatch(
                 inputs,
                 [c for _, c in prepared],
                 return_exceptions=return_exceptions,
                 **kwargs,
@@ -182,74 +204,172 @@
 
     def stream(
         self,
         input: Input,
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> Iterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.stream(input, config, **kwargs)
 
     async def astream(
         self,
         input: Input,
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> AsyncIterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         async for chunk in runnable.astream(input, config, **kwargs):
             yield chunk
 
     def transform(
         self,
         input: Iterator[Input],
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> Iterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.transform(input, config, **kwargs)
 
     async def atransform(
         self,
         input: AsyncIterator[Input],
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> AsyncIterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         async for chunk in runnable.atransform(input, config, **kwargs):
             yield chunk
 
+    def __getattr__(self, name: str) -> Any:
+        attr = getattr(self.default, name)
+        if callable(attr):
+
+            @wraps(attr)
+            def wrapper(*args: Any, **kwargs: Any) -> Any:
+                for key, arg in kwargs.items():
+                    if key == "config" and (
+                        isinstance(arg, dict)
+                        and "configurable" in arg
+                        and isinstance(arg["configurable"], dict)
+                    ):
+                        runnable, config = self.prepare(cast(RunnableConfig, arg))
+                        kwargs = {**kwargs, "config": config}
+                        return getattr(runnable, name)(*args, **kwargs)
+
+                for idx, arg in enumerate(args):
+                    if (
+                        isinstance(arg, dict)
+                        and "configurable" in arg
+                        and isinstance(arg["configurable"], dict)
+                    ):
+                        runnable, config = self.prepare(cast(RunnableConfig, arg))
+                        argsl = list(args)
+                        argsl[idx] = config
+                        return getattr(runnable, name)(*argsl, **kwargs)
+
+                if self.config:
+                    runnable, config = self.prepare()
+                    return getattr(runnable, name)(*args, **kwargs)
+
+                return attr(*args, **kwargs)
+
+            return wrapper
+
+        else:
+            return attr
+
 
 class RunnableConfigurableFields(DynamicRunnable[Input, Output]):
-    """A Runnable that can be dynamically configured."""
+    """Runnable that can be dynamically configured.
+
+    A RunnableConfigurableFields should be initiated using the
+    `configurable_fields` method of a Runnable.
+
+    Here is an example of using a RunnableConfigurableFields with LLMs:
+
+        .. code-block:: python
+
+            from langchain_core.prompts import PromptTemplate
+            from langchain_core.runnables import ConfigurableField
+            from langchain_openai import ChatOpenAI
+
+            model = ChatOpenAI(temperature=0).configurable_fields(
+                temperature=ConfigurableField(
+                    id="temperature",
+                    name="LLM Temperature",
+                    description="The temperature of the LLM",
+                )
+            )
+            # This creates a RunnableConfigurableFields for a chat model.
+
+            # When invoking the created RunnableSequence, you can pass in the
+            # value for your ConfigurableField's id which in this case
+            # will be change in temperature
+
+            prompt = PromptTemplate.from_template("Pick a random number above {x}")
+            chain = prompt | model
+
+            chain.invoke({"x": 0})
+            chain.invoke({"x": 0}, config={"configurable": {"temperature": 0.9}})
+
+
+    Here is an example of using a RunnableConfigurableFields with HubRunnables:
+
+        .. code-block:: python
+
+            from langchain_core.prompts import PromptTemplate
+            from langchain_core.runnables import ConfigurableField
+            from langchain_openai import ChatOpenAI
+            from langchain.runnables.hub import HubRunnable
+
+            prompt = HubRunnable("rlm/rag-prompt").configurable_fields(
+                owner_repo_commit=ConfigurableField(
+                    id="hub_commit",
+                    name="Hub Commit",
+                    description="The Hub commit to pull from",
+                )
+            )
+
+            prompt.invoke({"question": "foo", "context": "bar"})
+
+            # Invoking prompt with `with_config` method
+
+            prompt.invoke(
+                {"question": "foo", "context": "bar"},
+                config={"configurable": {"hub_commit": "rlm/rag-prompt-llama"}},
+            )
+    """
 
     fields: Dict[str, AnyConfigurableField]
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     @property
     def config_specs(self) -> List[ConfigurableFieldSpec]:
         return get_unique_config_specs(
             [
-                ConfigurableFieldSpec(
-                    id=spec.id,
-                    name=spec.name,
-                    description=spec.description
-                    or self.default.__fields__[field_name].field_info.description,
-                    annotation=spec.annotation
-                    or self.default.__fields__[field_name].annotation,
-                    default=getattr(self.default, field_name),
-                    is_shared=spec.is_shared,
-                )
-                if isinstance(spec, ConfigurableField)
-                else make_options_spec(
-                    spec, self.default.__fields__[field_name].field_info.description
+                (
+                    ConfigurableFieldSpec(
+                        id=spec.id,
+                        name=spec.name,
+                        description=spec.description
+                        or self.default.__fields__[field_name].field_info.description,
+                        annotation=spec.annotation
+                        or self.default.__fields__[field_name].annotation,
+                        default=getattr(self.default, field_name),
+                        is_shared=spec.is_shared,
+                    )
+                    if isinstance(spec, ConfigurableField)
+                    else make_options_spec(
+                        spec, self.default.__fields__[field_name].field_info.description
+                    )
                 )
                 for field_name, spec in self.fields.items()
             ]
             + list(self.default.config_specs)
         )
 
     def configurable_fields(
@@ -283,25 +403,30 @@
         configurable = {
             **configurable_fields,
             **configurable_single_options,
             **configurable_multi_options,
         }
 
         if configurable:
+            init_params = {
+                k: v
+                for k, v in self.default.__dict__.items()
+                if k in self.default.__fields__
+            }
             return (
-                self.default.__class__(**{**self.default.__dict__, **configurable}),
+                self.default.__class__(**{**init_params, **configurable}),
                 config,
             )
         else:
             return (self.default, config)
 
 
 # Before Python 3.11 native StrEnum is not available
 class StrEnum(str, enum.Enum):
-    """A string enum."""
+    """String enum."""
 
     pass
 
 
 _enums_for_spec: WeakValueDictionary[
     Union[
         ConfigurableFieldSingleOption, ConfigurableFieldMultiOption, ConfigurableField
@@ -309,15 +434,68 @@
     Type[StrEnum],
 ] = WeakValueDictionary()
 
 _enums_for_spec_lock = threading.Lock()
 
 
 class RunnableConfigurableAlternatives(DynamicRunnable[Input, Output]):
-    """A Runnable that can be dynamically configured."""
+    """Runnable that can be dynamically configured.
+
+    A RunnableConfigurableAlternatives should be initiated using the
+    `configurable_alternatives` method of a Runnable or can be
+    initiated directly as well.
+
+    Here is an example of using a RunnableConfigurableAlternatives that uses
+    alternative prompts to illustrate its functionality:
+
+        .. code-block:: python
+
+            from langchain_core.runnables import ConfigurableField
+            from langchain_openai import ChatOpenAI
+
+            # This creates a RunnableConfigurableAlternatives for Prompt Runnable
+            # with two alternatives.
+            prompt = PromptTemplate.from_template(
+                "Tell me a joke about {topic}"
+            ).configurable_alternatives(
+                ConfigurableField(id="prompt"),
+                default_key="joke",
+                poem=PromptTemplate.from_template("Write a short poem about {topic}")
+            )
+
+            # When invoking the created RunnableSequence, you can pass in the
+            # value for your ConfigurableField's id which in this case will either be
+            # `joke` or `poem`.
+            chain = prompt | ChatOpenAI(model="gpt-3.5-turbo-0125", temperature=0)
+
+            # The `with_config` method brings in the desired Prompt Runnable in your
+            # Runnable Sequence.
+            chain.with_config(configurable={"prompt": "poem"}).invoke({"topic": "bears"})
+
+
+    Equivalently, you can initialize RunnableConfigurableAlternatives directly
+    and use in LCEL in the same way:
+
+        .. code-block:: python
+
+            from langchain_core.runnables import ConfigurableField
+            from langchain_core.runnables.configurable import RunnableConfigurableAlternatives
+            from langchain_openai import ChatOpenAI
+
+            prompt = RunnableConfigurableAlternatives(
+                which=ConfigurableField(id='prompt'),
+                default=PromptTemplate.from_template("Tell me a joke about {topic}"),
+                default_key='joke',
+                prefix_keys=False,
+                alternatives={"poem":PromptTemplate.from_template("Write a short poem about {topic}")}
+            )
+            chain = prompt | ChatOpenAI(model="gpt-3.5-turbo-0125", temperature=0)
+            chain.with_config(configurable={"prompt": "poem"}).invoke({"topic": "bears"})
+
+    """  # noqa: E501
 
     which: ConfigurableField
 
     alternatives: Dict[
         str,
         Union[Runnable[Input, Output], Callable[[], Runnable[Input, Output]]],
     ]
@@ -368,30 +546,34 @@
                     for s in self.default.config_specs
                 ]
                 if self.prefix_keys
                 else self.default.config_specs
             )
             # config specs of the alternatives
             + [
-                prefix_config_spec(s, f"{self.which.id}=={alt_key}")
-                if self.prefix_keys
-                else s
+                (
+                    prefix_config_spec(s, f"{self.which.id}=={alt_key}")
+                    if self.prefix_keys
+                    else s
+                )
                 for alt_key, alt in self.alternatives.items()
                 if isinstance(alt, RunnableSerializable)
                 for s in alt.config_specs
             ]
         )
 
     def configurable_fields(
         self, **kwargs: AnyConfigurableField
     ) -> RunnableSerializable[Input, Output]:
         return self.__class__(
             which=self.which,
             default=self.default.configurable_fields(**kwargs),
             alternatives=self.alternatives,
+            default_key=self.default_key,
+            prefix_keys=self.prefix_keys,
         )
 
     def _prepare(
         self, config: Optional[RunnableConfig] = None
     ) -> Tuple[Runnable[Input, Output], RunnableConfig]:
         config = ensure_config(config)
         which = config.get("configurable", {}).get(self.which.id, self.default_key)
@@ -455,15 +637,16 @@
 
 
 def make_options_spec(
     spec: Union[ConfigurableFieldSingleOption, ConfigurableFieldMultiOption],
     description: Optional[str],
 ) -> ConfigurableFieldSpec:
     """Make a ConfigurableFieldSpec for a ConfigurableFieldSingleOption or
-    ConfigurableFieldMultiOption."""
+    ConfigurableFieldMultiOption.
+    """
     with _enums_for_spec_lock:
         if enum := _enums_for_spec.get(spec):
             pass
         else:
             enum = StrEnum(  # type: ignore[call-overload]
                 spec.name or spec.id,
                 ((v, v) for v in list(spec.options.keys())),
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/fallbacks.py` & `gigachain_core-0.2.0/langchain_core/runnables/retry.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,345 +1,342 @@
-import asyncio
 from typing import (
     TYPE_CHECKING,
     Any,
-    Iterator,
+    Dict,
     List,
     Optional,
-    Sequence,
     Tuple,
     Type,
+    TypeVar,
     Union,
+    cast,
 )
 
-from langchain_core.load.dump import dumpd
-from langchain_core.pydantic_v1 import BaseModel
-from langchain_core.runnables.base import Runnable, RunnableSerializable
-from langchain_core.runnables.config import (
-    RunnableConfig,
-    ensure_config,
-    get_async_callback_manager_for_config,
-    get_callback_manager_for_config,
-    get_config_list,
-    patch_config,
-)
-from langchain_core.runnables.utils import (
-    ConfigurableFieldSpec,
-    Input,
-    Output,
-    get_unique_config_specs,
+from tenacity import (
+    AsyncRetrying,
+    RetryCallState,
+    RetryError,
+    Retrying,
+    retry_if_exception_type,
+    stop_after_attempt,
+    wait_exponential_jitter,
 )
 
+from langchain_core.runnables.base import Input, Output, RunnableBindingBase
+from langchain_core.runnables.config import RunnableConfig, patch_config
+
 if TYPE_CHECKING:
-    from langchain_core.callbacks.manager import AsyncCallbackManagerForChainRun
+    from langchain_core.callbacks.manager import (
+        AsyncCallbackManagerForChainRun,
+        CallbackManagerForChainRun,
+    )
 
+    T = TypeVar("T", CallbackManagerForChainRun, AsyncCallbackManagerForChainRun)
+U = TypeVar("U")
 
-class RunnableWithFallbacks(RunnableSerializable[Input, Output]):
-    """A Runnable that can fallback to other Runnables if it fails.
 
-    External APIs (e.g., APIs for a language model) may at times experience
-    degraded performance or even downtime.
+class RunnableRetry(RunnableBindingBase[Input, Output]):
+    """Retry a Runnable if it fails.
 
-    In these cases, it can be useful to have a fallback runnable that can be
-    used in place of the original runnable (e.g., fallback to another LLM provider).
+    RunnableRetry can be used to add retry logic to any object
+    that subclasses the base Runnable.
 
-    Fallbacks can be defined at the level of a single runnable, or at the level
-    of a chain of runnables. Fallbacks are tried in order until one succeeds or
-    all fail.
+    Such retries are especially useful for network calls that may fail
+    due to transient errors.
 
-    While you can instantiate a ``RunnableWithFallbacks`` directly, it is usually
-    more convenient to use the ``with_fallbacks`` method on a runnable.
+    The RunnableRetry is implemented as a RunnableBinding. The easiest
+    way to use it is through the `.with_retry()` method on all Runnables.
 
     Example:
 
+    Here's an example that uses a RunnableLambda to raise an exception
+
         .. code-block:: python
 
-            from langchain_core.chat_models.openai import ChatOpenAI
-            from langchain_core.chat_models.anthropic import ChatAnthropic
+            import time
 
-            model = ChatAnthropic().with_fallbacks([ChatOpenAI()])
-            # Will usually use ChatAnthropic, but fallback to ChatOpenAI
-            # if ChatAnthropic fails.
-            model.invoke('hello')
-
-            # And you can also use fallbacks at the level of a chain.
-            # Here if both LLM providers fail, we'll fallback to a good hardcoded
-            # response.
+            def foo(input) -> None:
+                '''Fake function that raises an exception.'''
+                raise ValueError(f"Invoking foo failed. At time {time.time()}")
+
+            runnable = RunnableLambda(foo)
+
+            runnable_with_retries = runnable.with_retry(
+                retry_if_exception_type=(ValueError,), # Retry only on ValueError
+                wait_exponential_jitter=True, # Add jitter to the exponential backoff
+                stop_after_attempt=2, # Try twice
+            )
 
-            from langchain_core.prompts import PromptTemplate
-            from langchain_core.output_parser import StrOutputParser
-            from langchain_core.runnables import RunnableLambda
+            # The method invocation above is equivalent to the longer form below:
 
-            def when_all_is_lost(inputs):
-                return ("Looks like our LLM providers are down. "
-                        "Here's a nice  emoji for you instead.")
-
-            chain_with_fallback = (
-                PromptTemplate.from_template('Tell me a joke about {topic}')
-                | model
-                | StrOutputParser()
-            ).with_fallbacks([RunnableLambda(when_all_is_lost)])
-    """
+            runnable_with_retries = RunnableRetry(
+                bound=runnable,
+                retry_exception_types=(ValueError,),
+                max_attempt_number=2,
+                wait_exponential_jitter=True
+            )
 
-    runnable: Runnable[Input, Output]
-    """The runnable to run first."""
-    fallbacks: Sequence[Runnable[Input, Output]]
-    """A sequence of fallbacks to try."""
-    exceptions_to_handle: Tuple[Type[BaseException], ...] = (Exception,)
-    """The exceptions on which fallbacks should be tried.
-    
-    Any exception that is not a subclass of these exceptions will be raised immediately.
-    """
+    This logic can be used to retry any Runnable, including a chain of Runnables,
+    but in general it's best practice to keep the scope of the retry as small as
+    possible. For example, if you have a chain of Runnables, you should only retry
+    the Runnable that is likely to fail, not the entire chain.
 
-    class Config:
-        arbitrary_types_allowed = True
+    Example:
 
-    @property
-    def InputType(self) -> Type[Input]:
-        return self.runnable.InputType
+        .. code-block:: python
 
-    @property
-    def OutputType(self) -> Type[Output]:
-        return self.runnable.OutputType
+            from langchain_core.chat_models import ChatOpenAI
+            from langchain_core.prompts import PromptTemplate
 
-    def get_input_schema(
-        self, config: Optional[RunnableConfig] = None
-    ) -> Type[BaseModel]:
-        return self.runnable.get_input_schema(config)
-
-    def get_output_schema(
-        self, config: Optional[RunnableConfig] = None
-    ) -> Type[BaseModel]:
-        return self.runnable.get_output_schema(config)
+            template = PromptTemplate.from_template("tell me a joke about {topic}.")
+            model = ChatOpenAI(temperature=0.5)
 
-    @property
-    def config_specs(self) -> List[ConfigurableFieldSpec]:
-        return get_unique_config_specs(
-            spec
-            for step in [self.runnable, *self.fallbacks]
-            for spec in step.config_specs
-        )
+            # Good
+            chain = template | model.with_retry()
 
-    @classmethod
-    def is_lc_serializable(cls) -> bool:
-        return True
+            # Bad
+            chain = template | model
+            retryable_chain = chain.with_retry()
+    """
+
+    retry_exception_types: Tuple[Type[BaseException], ...] = (Exception,)
+    """The exception types to retry on. By default all exceptions are retried.
+    
+    In general you should only retry on exceptions that are likely to be
+    transient, such as network errors.
+    
+    Good exceptions to retry are all server errors (5xx) and selected client
+    errors (4xx) such as 429 Too Many Requests.
+    """
+
+    wait_exponential_jitter: bool = True
+    """Whether to add jitter to the exponential backoff."""
+
+    max_attempt_number: int = 3
+    """The maximum number of attempts to retry the runnable."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     @property
-    def runnables(self) -> Iterator[Runnable[Input, Output]]:
-        yield self.runnable
-        yield from self.fallbacks
+    def _kwargs_retrying(self) -> Dict[str, Any]:
+        kwargs: Dict[str, Any] = dict()
 
-    def invoke(
-        self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
+        if self.max_attempt_number:
+            kwargs["stop"] = stop_after_attempt(self.max_attempt_number)
+
+        if self.wait_exponential_jitter:
+            kwargs["wait"] = wait_exponential_jitter()
+
+        if self.retry_exception_types:
+            kwargs["retry"] = retry_if_exception_type(self.retry_exception_types)
+
+        return kwargs
+
+    def _sync_retrying(self, **kwargs: Any) -> Retrying:
+        return Retrying(**self._kwargs_retrying, **kwargs)
+
+    def _async_retrying(self, **kwargs: Any) -> AsyncRetrying:
+        return AsyncRetrying(**self._kwargs_retrying, **kwargs)
+
+    def _patch_config(
+        self,
+        config: RunnableConfig,
+        run_manager: "T",
+        retry_state: RetryCallState,
+    ) -> RunnableConfig:
+        attempt = retry_state.attempt_number
+        tag = "retry:attempt:{}".format(attempt) if attempt > 1 else None
+        return patch_config(config, callbacks=run_manager.get_child(tag))
+
+    def _patch_config_list(
+        self,
+        config: List[RunnableConfig],
+        run_manager: List["T"],
+        retry_state: RetryCallState,
+    ) -> List[RunnableConfig]:
+        return [
+            self._patch_config(c, rm, retry_state) for c, rm in zip(config, run_manager)
+        ]
+
+    def _invoke(
+        self,
+        input: Input,
+        run_manager: "CallbackManagerForChainRun",
+        config: RunnableConfig,
+        **kwargs: Any,
     ) -> Output:
-        # setup callbacks
-        config = ensure_config(config)
-        callback_manager = get_callback_manager_for_config(config)
-        # start the root run
-        run_manager = callback_manager.on_chain_start(
-            dumpd(self), input, name=config.get("run_name")
-        )
-        first_error = None
-        for runnable in self.runnables:
-            try:
-                output = runnable.invoke(
+        for attempt in self._sync_retrying(reraise=True):
+            with attempt:
+                result = super().invoke(
                     input,
-                    patch_config(config, callbacks=run_manager.get_child()),
+                    self._patch_config(config, run_manager, attempt.retry_state),
                     **kwargs,
                 )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                run_manager.on_chain_error(e)
-                raise e
-            else:
-                run_manager.on_chain_end(output)
-                return output
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        run_manager.on_chain_error(first_error)
-        raise first_error
+            if attempt.retry_state.outcome and not attempt.retry_state.outcome.failed:
+                attempt.retry_state.set_result(result)
+        return result
 
-    async def ainvoke(
+    def invoke(
+        self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
+    ) -> Output:
+        return self._call_with_config(self._invoke, input, config, **kwargs)
+
+    async def _ainvoke(
         self,
         input: Input,
-        config: Optional[RunnableConfig] = None,
-        **kwargs: Optional[Any],
+        run_manager: "AsyncCallbackManagerForChainRun",
+        config: RunnableConfig,
+        **kwargs: Any,
     ) -> Output:
-        # setup callbacks
-        config = ensure_config(config)
-        callback_manager = get_async_callback_manager_for_config(config)
-        # start the root run
-        run_manager = await callback_manager.on_chain_start(
-            dumpd(self), input, name=config.get("run_name")
-        )
-
-        first_error = None
-        for runnable in self.runnables:
-            try:
-                output = await runnable.ainvoke(
+        async for attempt in self._async_retrying(reraise=True):
+            with attempt:
+                result = await super().ainvoke(
                     input,
-                    patch_config(config, callbacks=run_manager.get_child()),
+                    self._patch_config(config, run_manager, attempt.retry_state),
                     **kwargs,
                 )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                await run_manager.on_chain_error(e)
-                raise e
+            if attempt.retry_state.outcome and not attempt.retry_state.outcome.failed:
+                attempt.retry_state.set_result(result)
+        return result
+
+    async def ainvoke(
+        self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
+    ) -> Output:
+        return await self._acall_with_config(self._ainvoke, input, config, **kwargs)
+
+    def _batch(
+        self,
+        inputs: List[Input],
+        run_manager: List["CallbackManagerForChainRun"],
+        config: List[RunnableConfig],
+        **kwargs: Any,
+    ) -> List[Union[Output, Exception]]:
+        results_map: Dict[int, Output] = {}
+
+        def pending(iterable: List[U]) -> List[U]:
+            return [item for idx, item in enumerate(iterable) if idx not in results_map]
+
+        try:
+            for attempt in self._sync_retrying():
+                with attempt:
+                    # Get the results of the inputs that have not succeeded yet.
+                    result = super().batch(
+                        pending(inputs),
+                        self._patch_config_list(
+                            pending(config), pending(run_manager), attempt.retry_state
+                        ),
+                        return_exceptions=True,
+                        **kwargs,
+                    )
+                    # Register the results of the inputs that have succeeded.
+                    first_exception = None
+                    for i, r in enumerate(result):
+                        if isinstance(r, Exception):
+                            if not first_exception:
+                                first_exception = r
+                            continue
+                        results_map[i] = r
+                    # If any exception occurred, raise it, to retry the failed ones
+                    if first_exception:
+                        raise first_exception
+                if (
+                    attempt.retry_state.outcome
+                    and not attempt.retry_state.outcome.failed
+                ):
+                    attempt.retry_state.set_result(result)
+        except RetryError as e:
+            try:
+                result
+            except UnboundLocalError:
+                result = cast(List[Output], [e] * len(inputs))
+
+        outputs: List[Union[Output, Exception]] = []
+        for idx, _ in enumerate(inputs):
+            if idx in results_map:
+                outputs.append(results_map[idx])
             else:
-                await run_manager.on_chain_end(output)
-                return output
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        await run_manager.on_chain_error(first_error)
-        raise first_error
+                outputs.append(result.pop(0))
+        return outputs
 
     def batch(
         self,
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
-        **kwargs: Optional[Any],
+        **kwargs: Any,
     ) -> List[Output]:
-        from langchain_core.callbacks.manager import CallbackManager
-
-        if return_exceptions:
-            raise NotImplementedError()
-
-        if not inputs:
-            return []
-
-        # setup callbacks
-        configs = get_config_list(config, len(inputs))
-        callback_managers = [
-            CallbackManager.configure(
-                inheritable_callbacks=config.get("callbacks"),
-                local_callbacks=None,
-                verbose=False,
-                inheritable_tags=config.get("tags"),
-                local_tags=None,
-                inheritable_metadata=config.get("metadata"),
-                local_metadata=None,
-            )
-            for config in configs
-        ]
-        # start the root runs, one per input
-        run_managers = [
-            cm.on_chain_start(
-                dumpd(self),
-                input if isinstance(input, dict) else {"input": input},
-                name=config.get("run_name"),
-            )
-            for cm, input, config in zip(callback_managers, inputs, configs)
-        ]
+        return self._batch_with_config(
+            self._batch, inputs, config, return_exceptions=return_exceptions, **kwargs
+        )
 
-        first_error = None
-        for runnable in self.runnables:
+    async def _abatch(
+        self,
+        inputs: List[Input],
+        run_manager: List["AsyncCallbackManagerForChainRun"],
+        config: List[RunnableConfig],
+        **kwargs: Any,
+    ) -> List[Union[Output, Exception]]:
+        results_map: Dict[int, Output] = {}
+
+        def pending(iterable: List[U]) -> List[U]:
+            return [item for idx, item in enumerate(iterable) if idx not in results_map]
+
+        try:
+            async for attempt in self._async_retrying():
+                with attempt:
+                    # Get the results of the inputs that have not succeeded yet.
+                    result = await super().abatch(
+                        pending(inputs),
+                        self._patch_config_list(
+                            pending(config), pending(run_manager), attempt.retry_state
+                        ),
+                        return_exceptions=True,
+                        **kwargs,
+                    )
+                    # Register the results of the inputs that have succeeded.
+                    first_exception = None
+                    for i, r in enumerate(result):
+                        if isinstance(r, Exception):
+                            if not first_exception:
+                                first_exception = r
+                            continue
+                        results_map[i] = r
+                    # If any exception occurred, raise it, to retry the failed ones
+                    if first_exception:
+                        raise first_exception
+                if (
+                    attempt.retry_state.outcome
+                    and not attempt.retry_state.outcome.failed
+                ):
+                    attempt.retry_state.set_result(result)
+        except RetryError as e:
             try:
-                outputs = runnable.batch(
-                    inputs,
-                    [
-                        # each step a child run of the corresponding root run
-                        patch_config(config, callbacks=rm.get_child())
-                        for rm, config in zip(run_managers, configs)
-                    ],
-                    return_exceptions=return_exceptions,
-                    **kwargs,
-                )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                for rm in run_managers:
-                    rm.on_chain_error(e)
-                raise e
+                result
+            except UnboundLocalError:
+                result = cast(List[Output], [e] * len(inputs))
+
+        outputs: List[Union[Output, Exception]] = []
+        for idx, _ in enumerate(inputs):
+            if idx in results_map:
+                outputs.append(results_map[idx])
             else:
-                for rm, output in zip(run_managers, outputs):
-                    rm.on_chain_end(output)
-                return outputs
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        for rm in run_managers:
-            rm.on_chain_error(first_error)
-        raise first_error
+                outputs.append(result.pop(0))
+        return outputs
 
     async def abatch(
         self,
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
-        **kwargs: Optional[Any],
+        **kwargs: Any,
     ) -> List[Output]:
-        from langchain_core.callbacks.manager import AsyncCallbackManager
-
-        if return_exceptions:
-            raise NotImplementedError()
-
-        if not inputs:
-            return []
-
-        # setup callbacks
-        configs = get_config_list(config, len(inputs))
-        callback_managers = [
-            AsyncCallbackManager.configure(
-                inheritable_callbacks=config.get("callbacks"),
-                local_callbacks=None,
-                verbose=False,
-                inheritable_tags=config.get("tags"),
-                local_tags=None,
-                inheritable_metadata=config.get("metadata"),
-                local_metadata=None,
-            )
-            for config in configs
-        ]
-        # start the root runs, one per input
-        run_managers: List[AsyncCallbackManagerForChainRun] = await asyncio.gather(
-            *(
-                cm.on_chain_start(
-                    dumpd(self),
-                    input,
-                    name=config.get("run_name"),
-                )
-                for cm, input, config in zip(callback_managers, inputs, configs)
-            )
+        return await self._abatch_with_config(
+            self._abatch, inputs, config, return_exceptions=return_exceptions, **kwargs
         )
 
-        first_error = None
-        for runnable in self.runnables:
-            try:
-                outputs = await runnable.abatch(
-                    inputs,
-                    [
-                        # each step a child run of the corresponding root run
-                        patch_config(config, callbacks=rm.get_child())
-                        for rm, config in zip(run_managers, configs)
-                    ],
-                    return_exceptions=return_exceptions,
-                    **kwargs,
-                )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                await asyncio.gather(*(rm.on_chain_error(e) for rm in run_managers))
-            else:
-                await asyncio.gather(
-                    *(
-                        rm.on_chain_end(output)
-                        for rm, output in zip(run_managers, outputs)
-                    )
-                )
-                return outputs
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        await asyncio.gather(*(rm.on_chain_error(first_error) for rm in run_managers))
-        raise first_error
+    # stream() and transform() are not retried because retrying a stream
+    # is not very intuitive.
```

#### encoding

```diff
@@ -1 +1 @@
-utf-8
+us-ascii
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/graph_draw.py` & `gigachain_core-0.2.0/langchain_core/runnables/graph_ascii.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 """Draws DAG in ASCII.
 Adapted from https://github.com/iterative/dvc/blob/main/dvc/dagascii.py"""
 
 import math
 import os
-from typing import Any, Mapping, Sequence, Tuple
+from typing import Any, Mapping, Sequence
+
+from langchain_core.runnables.graph import Edge as LangEdge
 
 
 class VertexViewer:
     """Class to define vertex box boundaries that will be accounted for during
     graph building by grandalf.
 
     Args:
@@ -152,38 +154,40 @@
         self.point(x0, y0, "+")
         self.point(x0 + width, y0, "+")
         self.point(x0, y0 + height, "+")
         self.point(x0 + width, y0 + height, "+")
 
 
 def _build_sugiyama_layout(
-    vertices: Mapping[str, str], edges: Sequence[Tuple[str, str]]
+    vertices: Mapping[str, str], edges: Sequence[LangEdge]
 ) -> Any:
     try:
         from grandalf.graphs import Edge, Graph, Vertex  # type: ignore[import]
         from grandalf.layouts import SugiyamaLayout  # type: ignore[import]
         from grandalf.routing import (  # type: ignore[import]
             EdgeViewer,
             route_with_lines,
         )
-    except ImportError:
-        print("Install grandalf to draw graphs. `pip install grandalf`")
-        raise
+    except ImportError as exc:
+        raise ImportError(
+            "Install grandalf to draw graphs: `pip install grandalf`."
+        ) from exc
+
     #
     # Just a reminder about naming conventions:
     # +------------X
     # |
     # |
     # |
     # |
     # Y
     #
 
     vertices_ = {id: Vertex(f" {data} ") for id, data in vertices.items()}
-    edges_ = [Edge(vertices_[s], vertices_[e]) for s, e in edges]
+    edges_ = [Edge(vertices_[s], vertices_[e], data=cond) for s, e, _, cond in edges]
     vertices_list = vertices_.values()
     graph = Graph(vertices_list, edges_)
 
     for vertex in vertices_list:
         vertex.view = VertexViewer(vertex.data)
 
     # NOTE: determine min box length to create the best layout
@@ -203,26 +207,25 @@
     sug.route_edge = route_with_lines
 
     sug.draw()
 
     return sug
 
 
-def draw(vertices: Mapping[str, str], edges: Sequence[Tuple[str, str]]) -> str:
+def draw_ascii(vertices: Mapping[str, str], edges: Sequence[LangEdge]) -> str:
     """Build a DAG and draw it in ASCII.
 
     Args:
         vertices (list): list of graph vertices.
         edges (list): list of graph edges.
 
     Returns:
         str: ASCII representation
 
     Example:
-        >>> from dvc.dagascii import draw
         >>> vertices = [1, 2, 3, 4]
         >>> edges = [(1, 2), (2, 3), (2, 4), (1, 4)]
         >>> print(draw(vertices, edges))
         +---+     +---+
         | 3 |     | 4 |
         +---+    *+---+
           *    **   *
@@ -281,15 +284,15 @@
             end_y = int(round(end[1] - miny))
 
             assert start_x >= 0
             assert start_y >= 0
             assert end_x >= 0
             assert end_y >= 0
 
-            canvas.line(start_x, start_y, end_x, end_y, "*")
+            canvas.line(start_x, start_y, end_x, end_y, "." if edge.data else "*")
 
     for vertex in sug.g.sV:
         # NOTE: moving boxes w/2 to the left
         x = vertex.view.xy[0] - vertex.view.w / 2.0
         y = vertex.view.xy[1]
 
         canvas.box(
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/history.py` & `gigachain_core-0.2.0/langchain_core/runnables/history.py`

 * *Files 11% similar despite different names*

```diff
@@ -11,103 +11,187 @@
     Sequence,
     Type,
     Union,
 )
 
 from langchain_core.chat_history import BaseChatMessageHistory
 from langchain_core.load.load import load
-from langchain_core.pydantic_v1 import BaseModel, create_model
+from langchain_core.pydantic_v1 import BaseModel
 from langchain_core.runnables.base import Runnable, RunnableBindingBase, RunnableLambda
-from langchain_core.runnables.config import run_in_executor
 from langchain_core.runnables.passthrough import RunnablePassthrough
 from langchain_core.runnables.utils import (
     ConfigurableFieldSpec,
+    create_model,
     get_unique_config_specs,
 )
 
 if TYPE_CHECKING:
+    from langchain_core.language_models import LanguageModelLike
     from langchain_core.messages import BaseMessage
     from langchain_core.runnables.config import RunnableConfig
     from langchain_core.tracers.schemas import Run
 
 
 MessagesOrDictWithMessages = Union[Sequence["BaseMessage"], Dict[str, Any]]
 GetSessionHistoryCallable = Callable[..., BaseChatMessageHistory]
 
 
 class RunnableWithMessageHistory(RunnableBindingBase):
-    """A runnable that manages chat message history for another runnable.
+    """Runnable that manages chat message history for another Runnable.
 
-    Base runnable must have inputs and outputs that can be converted to a list of BaseMessages.
+    A chat message history is a sequence of messages that represent a conversation.
 
-    RunnableWithMessageHistory must always be called with a config that contains session_id, e.g. ``{"configurable": {"session_id": "<SESSION_ID>"}}`.
+    RunnableWithMessageHistory wraps another Runnable and manages the chat message
+    history for it; it is responsible for reading and updating the chat message
+    history.
+
+    The formats supports for the inputs and outputs of the wrapped Runnable
+    are described below.
+
+    RunnableWithMessageHistory must always be called with a config that contains
+    the appropriate parameters for the chat message history factory.
+
+    By default the Runnable is expected to take a single configuration parameter
+    called `session_id` which is a string. This parameter is used to create a new
+    or look up an existing chat message history that matches the given session_id.
+
+    In this case, the invocation would look like this:
+
+    `with_history.invoke(..., config={"configurable": {"session_id": "bar"}})`
+    ; e.g., ``{"configurable": {"session_id": "<SESSION_ID>"}}``.
+
+    The configuration can be customized by passing in a list of
+    ``ConfigurableFieldSpec`` objects to the ``history_factory_config`` parameter (see
+    example below).
+
+    In the examples, we will use a chat message history with an in-memory
+    implementation to make it easy to experiment and see the results.
+
+    For production use cases, you will want to use a persistent implementation
+    of chat message history, such as ``RedisChatMessageHistory``.
+
+
+    Example: Chat message history with an in-memory implementation for testing.
+
+    .. code-block:: python
+
+        from operator import itemgetter
+        from typing import List
+
+        from langchain_openai.chat_models import ChatOpenAI
+
+        from langchain_core.chat_history import BaseChatMessageHistory
+        from langchain_core.documents import Document
+        from langchain_core.messages import BaseMessage, AIMessage
+        from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
+        from langchain_core.pydantic_v1 import BaseModel, Field
+        from langchain_core.runnables import (
+            RunnableLambda,
+            ConfigurableFieldSpec,
+            RunnablePassthrough,
+        )
+        from langchain_core.runnables.history import RunnableWithMessageHistory
+
+
+        class InMemoryHistory(BaseChatMessageHistory, BaseModel):
+            \"\"\"In memory implementation of chat message history.\"\"\"
+
+            messages: List[BaseMessage] = Field(default_factory=list)
+
+            def add_messages(self, messages: List[BaseMessage]) -> None:
+                \"\"\"Add a list of messages to the store\"\"\"
+                self.messages.extend(messages)
+
+            def clear(self) -> None:
+                self.messages = []
+
+        # Here we use a global variable to store the chat message history.
+        # This will make it easier to inspect it to see the underlying results.
+        store = {}
+
+        def get_by_session_id(session_id: str) -> BaseChatMessageHistory:
+            if session_id not in store:
+                store[session_id] = InMemoryHistory()
+            return store[session_id]
+
+
+        history = get_by_session_id("1")
+        history.add_message(AIMessage(content="hello"))
+        print(store)  # noqa: T201
+
+
+    Example where the wrapped Runnable takes a dictionary input:
 
-    Example (dict input):
         .. code-block:: python
 
             from typing import Optional
 
             from langchain_community.chat_models import ChatAnthropic
-            from langchain_community.chat_message_histories import RedisChatMessageHistory
-
             from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
             from langchain_core.runnables.history import RunnableWithMessageHistory
 
 
             prompt = ChatPromptTemplate.from_messages([
                 ("system", "You're an assistant who's good at {ability}"),
                 MessagesPlaceholder(variable_name="history"),
                 ("human", "{question}"),
             ])
 
             chain = prompt | ChatAnthropic(model="claude-2")
 
             chain_with_history = RunnableWithMessageHistory(
                 chain,
-                RedisChatMessageHistory,
+                # Uses the get_by_session_id function defined in the example
+                # above.
+                get_by_session_id,
                 input_messages_key="question",
                 history_messages_key="history",
             )
 
-            chain_with_history.invoke(
+            print(chain_with_history.invoke(  # noqa: T201
                 {"ability": "math", "question": "What does cosine mean?"},
                 config={"configurable": {"session_id": "foo"}}
-            )
-            # -> "Cosine is ..."
-            chain_with_history.invoke(
+            ))
+
+            # Uses the store defined in the example above.
+            print(store)  # noqa: T201
+
+            print(chain_with_history.invoke(  # noqa: T201
                 {"ability": "math", "question": "What's its inverse"},
                 config={"configurable": {"session_id": "foo"}}
-            )
-            # -> "The inverse of cosine is called arccosine ..."
+            ))
+
+            print(store)  # noqa: T201
 
 
-    Example (get_session_history takes two keys, user_id and conversation id):
+    Example where the session factory takes two keys, user_id and conversation id):
+
         .. code-block:: python
 
             store = {}
 
             def get_session_history(
                 user_id: str, conversation_id: str
-            ) -> ChatMessageHistory:
+            ) -> BaseChatMessageHistory:
                 if (user_id, conversation_id) not in store:
-                    store[(user_id, conversation_id)] = ChatMessageHistory()
+                    store[(user_id, conversation_id)] = InMemoryHistory()
                 return store[(user_id, conversation_id)]
 
             prompt = ChatPromptTemplate.from_messages([
                 ("system", "You're an assistant who's good at {ability}"),
                 MessagesPlaceholder(variable_name="history"),
                 ("human", "{question}"),
             ])
 
             chain = prompt | ChatAnthropic(model="claude-2")
 
             with_message_history = RunnableWithMessageHistory(
                 chain,
                 get_session_history=get_session_history,
-                input_messages_key="messages",
+                input_messages_key="question",
                 history_messages_key="history",
                 history_factory_config=[
                     ConfigurableFieldSpec(
                         id="user_id",
                         annotation=str,
                         name="User ID",
                         description="Unique identifier for the user.",
@@ -121,15 +205,15 @@
                         description="Unique identifier for the conversation.",
                         default="",
                         is_shared=True,
                     ),
                 ],
             )
 
-            chain_with_history.invoke(
+            with_message_history.invoke(
                 {"ability": "math", "question": "What does cosine mean?"},
                 config={"configurable": {"user_id": "123", "conversation_id": "1"}}
             )
 
     """  # noqa: E501
 
     get_session_history: GetSessionHistoryCallable
@@ -141,17 +225,20 @@
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     def __init__(
         self,
-        runnable: Runnable[
-            MessagesOrDictWithMessages,
-            Union[str, BaseMessage, MessagesOrDictWithMessages],
+        runnable: Union[
+            Runnable[
+                Union[MessagesOrDictWithMessages],
+                Union[str, BaseMessage, MessagesOrDictWithMessages],
+            ],
+            LanguageModelLike,
         ],
         get_session_history: GetSessionHistoryCallable,
         *,
         input_messages_key: Optional[str] = None,
         output_messages_key: Optional[str] = None,
         history_messages_key: Optional[str] = None,
         history_factory_config: Optional[Sequence[ConfigurableFieldSpec]] = None,
@@ -254,15 +341,17 @@
             super().config_specs + list(self.history_factory_config)
         )
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
         super_schema = super().get_input_schema(config)
-        if super_schema.__custom_root_type__ is not None:
+        if super_schema.__custom_root_type__ or not super_schema.schema().get(
+            "properties"
+        ):
             from langchain_core.messages import BaseMessage
 
             fields: Dict = {}
             if self.input_messages_key and self.history_messages_key:
                 fields[self.input_messages_key] = (
                     Union[str, BaseMessage, Sequence[BaseMessage]],
                     ...,
@@ -275,18 +364,27 @@
                 "RunnableWithChatHistoryInput",
                 **fields,
             )
         else:
             return super_schema
 
     def _get_input_messages(
-        self, input_val: Union[str, BaseMessage, Sequence[BaseMessage]]
+        self, input_val: Union[str, BaseMessage, Sequence[BaseMessage], dict]
     ) -> List[BaseMessage]:
         from langchain_core.messages import BaseMessage
 
+        if isinstance(input_val, dict):
+            if self.input_messages_key:
+                key = self.input_messages_key
+            elif len(input_val) == 1:
+                key = list(input_val.keys())[0]
+            else:
+                key = "input"
+            input_val = input_val[key]
+
         if isinstance(input_val, str):
             from langchain_core.messages import HumanMessage
 
             return [HumanMessage(content=input_val)]
         elif isinstance(input_val, BaseMessage):
             return [input_val]
         elif isinstance(input_val, (list, tuple)):
@@ -299,64 +397,78 @@
 
     def _get_output_messages(
         self, output_val: Union[str, BaseMessage, Sequence[BaseMessage], dict]
     ) -> List[BaseMessage]:
         from langchain_core.messages import BaseMessage
 
         if isinstance(output_val, dict):
-            output_val = output_val[self.output_messages_key or "output"]
+            if self.output_messages_key:
+                key = self.output_messages_key
+            elif len(output_val) == 1:
+                key = list(output_val.keys())[0]
+            else:
+                key = "output"
+            # If you are wrapping a chat model directly
+            # The output is actually this weird generations object
+            if key not in output_val and "generations" in output_val:
+                output_val = output_val["generations"][0][0]["message"]
+            else:
+                output_val = output_val[key]
 
         if isinstance(output_val, str):
             from langchain_core.messages import AIMessage
 
             return [AIMessage(content=output_val)]
         elif isinstance(output_val, BaseMessage):
             return [output_val]
         elif isinstance(output_val, (list, tuple)):
             return list(output_val)
         else:
             raise ValueError()
 
     def _enter_history(self, input: Any, config: RunnableConfig) -> List[BaseMessage]:
-        hist = config["configurable"]["message_history"]
-        # return only historic messages
-        if self.history_messages_key:
-            return hist.messages.copy()
-        # return all messages
-        else:
-            input_val = (
-                input if not self.input_messages_key else input[self.input_messages_key]
-            )
-            return hist.messages.copy() + self._get_input_messages(input_val)
+        hist: BaseChatMessageHistory = config["configurable"]["message_history"]
+        messages = hist.messages.copy()
+
+        if not self.history_messages_key:
+            # return all messages
+            messages += self._get_input_messages(input)
+        return messages
 
     async def _aenter_history(
         self, input: Dict[str, Any], config: RunnableConfig
     ) -> List[BaseMessage]:
-        return await run_in_executor(config, self._enter_history, input, config)
+        hist: BaseChatMessageHistory = config["configurable"]["message_history"]
+        messages = (await hist.aget_messages()).copy()
+
+        if not self.history_messages_key:
+            # return all messages
+            input_val = (
+                input if not self.input_messages_key else input[self.input_messages_key]
+            )
+            messages += self._get_input_messages(input_val)
+        return messages
 
     def _exit_history(self, run: Run, config: RunnableConfig) -> None:
-        hist = config["configurable"]["message_history"]
+        hist: BaseChatMessageHistory = config["configurable"]["message_history"]
 
         # Get the input messages
         inputs = load(run.inputs)
-        input_val = inputs[self.input_messages_key or "input"]
-        input_messages = self._get_input_messages(input_val)
+        input_messages = self._get_input_messages(inputs)
 
         # If historic messages were prepended to the input messages, remove them to
         # avoid adding duplicate messages to history.
         if not self.history_messages_key:
             historic_messages = config["configurable"]["message_history"].messages
             input_messages = input_messages[len(historic_messages) :]
 
         # Get the output messages
         output_val = load(run.outputs)
         output_messages = self._get_output_messages(output_val)
-
-        for m in input_messages + output_messages:
-            hist.add_message(m)
+        hist.add_messages(input_messages + output_messages)
 
     def _merge_configs(self, *configs: Optional[RunnableConfig]) -> RunnableConfig:
         config = super()._merge_configs(*configs)
         expected_keys = [field_spec.id for field_spec in self.history_factory_config]
 
         configurable = config.get("configurable", {})
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/passthrough.py` & `gigachain_core-0.2.0/langchain_core/runnables/passthrough.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Implementation of the RunnablePassthrough."""
+
 from __future__ import annotations
 
 import asyncio
 import inspect
 import threading
 from typing import (
     TYPE_CHECKING,
@@ -16,15 +17,15 @@
     Mapping,
     Optional,
     Type,
     Union,
     cast,
 )
 
-from langchain_core.pydantic_v1 import BaseModel, create_model
+from langchain_core.pydantic_v1 import BaseModel
 from langchain_core.runnables.base import (
     Other,
     Runnable,
     RunnableParallel,
     RunnableSerializable,
 )
 from langchain_core.runnables.config import (
@@ -32,43 +33,47 @@
     acall_func_with_variable_args,
     call_func_with_variable_args,
     ensure_config,
     get_executor_for_config,
     patch_config,
 )
 from langchain_core.runnables.graph import Graph
-from langchain_core.runnables.utils import AddableDict, ConfigurableFieldSpec
+from langchain_core.runnables.utils import (
+    AddableDict,
+    ConfigurableFieldSpec,
+    create_model,
+)
 from langchain_core.utils.aiter import atee, py_anext
 from langchain_core.utils.iter import safetee
 
 if TYPE_CHECKING:
     from langchain_core.callbacks.manager import (
         AsyncCallbackManagerForChainRun,
         CallbackManagerForChainRun,
     )
 
 
 def identity(x: Other) -> Other:
-    """An identity function"""
+    """Identity function"""
     return x
 
 
 async def aidentity(x: Other) -> Other:
-    """An async identity function"""
+    """Async identity function"""
     return x
 
 
 class RunnablePassthrough(RunnableSerializable[Other, Other]):
-    """A runnable to passthrough inputs unchanged or with additional keys.
+    """Runnable to passthrough inputs unchanged or with additional keys.
 
     This runnable behaves almost like the identity function, except that it
     can be configured to add additional keys to the output, if the input is a
     dict.
 
-    The examples below demonstrate this runnable works using a few simple
+    The examples below demonstrate this Runnable works using a few simple
     chains. The chains rely on simple lambdas to make the examples easy to execute
     and experiment with.
 
     Examples:
 
         .. code-block:: python
 
@@ -97,26 +102,25 @@
             chain.invoke('hello') # {'original': 'completion', 'parsed': 'noitelpmoc'}
 
     In some cases, it may be useful to pass the input through while adding some
     keys to the output. In this case, you can use the `assign` method:
 
         .. code-block:: python
 
-            from langchain_core.runnables import RunnablePassthrough, RunnableParallel
+            from langchain_core.runnables import RunnablePassthrough
 
             def fake_llm(prompt: str) -> str: # Fake LLM for the example
                 return "completion"
 
             runnable = {
                 'llm1':  fake_llm,
                 'llm2':  fake_llm,
-            }
-            | RunnablePassthrough.assign(
+            } | RunnablePassthrough.assign(
                 total_chars=lambda inputs: len(inputs['llm1'] + inputs['llm2'])
-              )
+            )
 
             runnable.invoke('hello')
             # {'llm1': 'completion', 'llm2': 'completion', 'total_chars': 20}
     """
 
     input_type: Optional[Type[Other]] = None
 
@@ -157,15 +161,15 @@
         input_type: Optional[Type[Other]] = None,
         **kwargs: Any,
     ) -> None:
         if inspect.iscoroutinefunction(func):
             afunc = func
             func = None
 
-        super().__init__(func=func, afunc=afunc, input_type=input_type, **kwargs)
+        super().__init__(func=func, afunc=afunc, input_type=input_type, **kwargs)  # type: ignore[call-arg]
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
@@ -234,24 +238,30 @@
         config: Optional[RunnableConfig] = None,
         **kwargs: Any,
     ) -> Iterator[Other]:
         if self.func is None:
             for chunk in self._transform_stream_with_config(input, identity, config):
                 yield chunk
         else:
-            final = None
+            final: Other
+            got_first_chunk = False
 
             for chunk in self._transform_stream_with_config(input, identity, config):
                 yield chunk
-                if final is None:
+
+                if not got_first_chunk:
                     final = chunk
+                    got_first_chunk = True
                 else:
-                    final = final + chunk
+                    try:
+                        final = final + chunk  # type: ignore[operator]
+                    except TypeError:
+                        final = chunk
 
-            if final is not None:
+            if got_first_chunk:
                 call_func_with_variable_args(
                     self.func, final, ensure_config(config), **kwargs
                 )
 
     async def atransform(
         self,
         input: AsyncIterator[Other],
@@ -260,26 +270,36 @@
     ) -> AsyncIterator[Other]:
         if self.afunc is None and self.func is None:
             async for chunk in self._atransform_stream_with_config(
                 input, identity, config
             ):
                 yield chunk
         else:
-            final = None
+            got_first_chunk = False
 
             async for chunk in self._atransform_stream_with_config(
                 input, identity, config
             ):
                 yield chunk
-                if final is None:
+
+                # By definitions, a function will operate on the aggregated
+                # input. So we'll aggregate the input until we get to the last
+                # chunk.
+                # If the input is not addable, then we'll assume that we can
+                # only operate on the last chunk.
+                if not got_first_chunk:
                     final = chunk
+                    got_first_chunk = True
                 else:
-                    final = final + chunk
+                    try:
+                        final = final + chunk  # type: ignore[operator]
+                    except TypeError:
+                        final = chunk
 
-            if final is not None:
+            if got_first_chunk:
                 config = ensure_config(config)
                 if self.afunc is not None:
                     await acall_func_with_variable_args(
                         self.afunc, final, config, **kwargs
                     )
                 elif self.func is not None:
                     call_func_with_variable_args(self.func, final, config, **kwargs)
@@ -305,37 +325,71 @@
             yield chunk
 
 
 _graph_passthrough: RunnablePassthrough = RunnablePassthrough()
 
 
 class RunnableAssign(RunnableSerializable[Dict[str, Any], Dict[str, Any]]):
-    """
-    A runnable that assigns key-value pairs to Dict[str, Any] inputs.
+    """Runnable that assigns key-value pairs to Dict[str, Any] inputs.
+
+    The `RunnableAssign` class takes input dictionaries and, through a
+    `RunnableParallel` instance, applies transformations, then combines
+    these with the original data, introducing new key-value pairs based
+    on the mapper's logic.
+
+    Examples:
+        .. code-block:: python
+
+            # This is a RunnableAssign
+            from typing import Dict
+            from langchain_core.runnables.passthrough import (
+                RunnableAssign,
+                RunnableParallel,
+            )
+            from langchain_core.runnables.base import RunnableLambda
+
+            def add_ten(x: Dict[str, int]) -> Dict[str, int]:
+                return {"added": x["input"] + 10}
+
+            mapper = RunnableParallel(
+                {"add_step": RunnableLambda(add_ten),}
+            )
+
+            runnable_assign = RunnableAssign(mapper)
+
+            # Synchronous example
+            runnable_assign.invoke({"input": 5})
+            # returns {'input': 5, 'add_step': {'added': 15}}
+
+            # Asynchronous example
+            await runnable_assign.ainvoke({"input": 5})
+            # returns {'input': 5, 'add_step': {'added': 15}}
     """
 
     mapper: RunnableParallel[Dict[str, Any]]
 
     def __init__(self, mapper: RunnableParallel[Dict[str, Any]], **kwargs: Any) -> None:
-        super().__init__(mapper=mapper, **kwargs)
+        super().__init__(mapper=mapper, **kwargs)  # type: ignore[call-arg]
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     def get_name(
         self, suffix: Optional[str] = None, *, name: Optional[str] = None
     ) -> str:
         name = (
-            name or self.name or f"RunnableAssign<{','.join(self.mapper.steps.keys())}>"
+            name
+            or self.name
+            or f"RunnableAssign<{','.join(self.mapper.steps__.keys())}>"
         )
         return super().get_name(suffix, name=name)
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
         map_input_schema = self.mapper.get_input_schema(config)
@@ -446,15 +500,15 @@
         self,
         input: Iterator[Dict[str, Any]],
         run_manager: CallbackManagerForChainRun,
         config: RunnableConfig,
         **kwargs: Any,
     ) -> Iterator[Dict[str, Any]]:
         # collect mapper keys
-        mapper_keys = set(self.mapper.steps.keys())
+        mapper_keys = set(self.mapper.steps__.keys())
         # create two streams, one for the map and one for the passthrough
         for_passthrough, for_map = safetee(input, 2, lock=threading.Lock())
 
         # create map output stream
         map_output = self.mapper.transform(
             for_map,
             patch_config(
@@ -502,15 +556,15 @@
         self,
         input: AsyncIterator[Dict[str, Any]],
         run_manager: AsyncCallbackManagerForChainRun,
         config: RunnableConfig,
         **kwargs: Any,
     ) -> AsyncIterator[Dict[str, Any]]:
         # collect mapper keys
-        mapper_keys = set(self.mapper.steps.keys())
+        mapper_keys = set(self.mapper.steps__.keys())
         # create two streams, one for the map and one for the passthrough
         for_passthrough, for_map = atee(input, 2, lock=asyncio.Lock())
         # create map output stream
         map_output = self.mapper.atransform(
             for_map,
             patch_config(
                 config,
@@ -567,22 +621,44 @@
             yield input
 
         async for chunk in self.atransform(input_aiter(), config, **kwargs):
             yield chunk
 
 
 class RunnablePick(RunnableSerializable[Dict[str, Any], Dict[str, Any]]):
-    """
-    A runnable that picks keys from Dict[str, Any] inputs.
+    """Runnable that picks keys from Dict[str, Any] inputs.
+
+    RunnablePick class represents a runnable that selectively picks keys from a
+    dictionary input. It allows you to specify one or more keys to extract
+    from the input dictionary. It returns a new dictionary containing only
+    the selected keys.
+
+    Example :
+        .. code-block:: python
+
+            from langchain_core.runnables.passthrough import RunnablePick
+
+            input_data = {
+                'name': 'John',
+                'age': 30,
+                'city': 'New York',
+                'country': 'USA'
+            }
+
+            runnable = RunnablePick(keys=['name', 'age'])
+
+            output_data = runnable.invoke(input_data)
+
+            print(output_data)  # Output: {'name': 'John', 'age': 30}
     """
 
     keys: Union[str, List[str]]
 
     def __init__(self, keys: Union[str, List[str]], **kwargs: Any) -> None:
-        super().__init__(keys=keys, **kwargs)
+        super().__init__(keys=keys, **kwargs)  # type: ignore[call-arg]
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/router.py` & `gigachain_core-0.2.0/langchain_core/runnables/router.py`

 * *Files 3% similar despite different names*

```diff
@@ -30,44 +30,57 @@
     ConfigurableFieldSpec,
     gather_with_concurrency,
     get_unique_config_specs,
 )
 
 
 class RouterInput(TypedDict):
-    """A Router input.
+    """Router input.
 
     Attributes:
         key: The key to route on.
         input: The input to pass to the selected runnable.
     """
 
     key: str
     input: Any
 
 
 class RouterRunnable(RunnableSerializable[RouterInput, Output]):
     """
-    A runnable that routes to a set of runnables based on Input['key'].
-    Returns the output of the selected runnable.
+    Runnable that routes to a set of Runnables based on Input['key'].
+    Returns the output of the selected Runnable.
+
+    For example,
+
+    .. code-block:: python
+
+        from langchain_core.runnables.router import RouterRunnable
+        from langchain_core.runnables import RunnableLambda
+
+        add = RunnableLambda(func=lambda x: x + 1)
+        square = RunnableLambda(func=lambda x: x**2)
+
+        router = RouterRunnable(runnables={"add": add, "square": square})
+        router.invoke({"key": "square", "input": 3})
     """
 
     runnables: Mapping[str, Runnable[Any, Output]]
 
     @property
     def config_specs(self) -> List[ConfigurableFieldSpec]:
         return get_unique_config_specs(
             spec for step in self.runnables.values() for spec in step.config_specs
         )
 
     def __init__(
         self,
         runnables: Mapping[str, Union[Runnable[Any, Output], Callable[[Any], Output]]],
     ) -> None:
-        super().__init__(
+        super().__init__(  # type: ignore[call-arg]
             runnables={key: coerce_to_runnable(r) for key, r in runnables.items()}
         )
 
     class Config:
         arbitrary_types_allowed = True
 
     @classmethod
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/runnables/utils.py` & `gigachain_core-0.2.0/langchain_core/runnables/utils.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,33 +1,45 @@
+"""Utility code for runnables."""
+
 from __future__ import annotations
 
 import ast
 import asyncio
 import inspect
 import textwrap
+from functools import lru_cache
 from inspect import signature
 from itertools import groupby
 from typing import (
     Any,
     AsyncIterable,
+    AsyncIterator,
+    Awaitable,
     Callable,
     Coroutine,
     Dict,
     Iterable,
     List,
     Mapping,
     NamedTuple,
     Optional,
     Protocol,
     Sequence,
     Set,
+    Type,
     TypeVar,
     Union,
 )
 
+from typing_extensions import TypeGuard
+
+from langchain_core.pydantic_v1 import BaseConfig, BaseModel
+from langchain_core.pydantic_v1 import create_model as _create_model_base
+from langchain_core.runnables.schema import StreamEvent
+
 Input = TypeVar("Input", contravariant=True)
 # Output type should implement __concat__, as eg str, list, dict do
 Output = TypeVar("Output", covariant=True)
 
 
 async def gated_coro(semaphore: asyncio.Semaphore, coro: Coroutine) -> Any:
     """Run a coroutine with a semaphore.
@@ -39,15 +51,23 @@
         The result of the coroutine.
     """
     async with semaphore:
         return await coro
 
 
 async def gather_with_concurrency(n: Union[int, None], *coros: Coroutine) -> list:
-    """Gather coroutines with a limit on the number of concurrent coroutines."""
+    """Gather coroutines with a limit on the number of concurrent coroutines.
+
+    Args:
+        n: The number of coroutines to run concurrently.
+        coros: The coroutines to run.
+
+    Returns:
+        The results of the coroutines.
+    """
     if n is None:
         return await asyncio.gather(*coros)
 
     semaphore = asyncio.Semaphore(n)
 
     return await asyncio.gather(*(gated_coro(semaphore, c) for c in coros))
 
@@ -199,15 +219,15 @@
     """Get the keys of the first argument of a function if it is a dict."""
     try:
         code = inspect.getsource(func)
         tree = ast.parse(textwrap.dedent(code))
         visitor = IsFunctionArgDict()
         visitor.visit(tree)
         return list(visitor.keys) if visitor.keys else None
-    except (SyntaxError, TypeError, OSError):
+    except (SyntaxError, TypeError, OSError, SystemError):
         return None
 
 
 def get_lambda_source(func: Callable) -> Optional[str]:
     """Get the source code of a lambda function.
 
     Args:
@@ -222,15 +242,15 @@
         name = None
     try:
         code = inspect.getsource(func)
         tree = ast.parse(textwrap.dedent(code))
         visitor = GetLambdaSource()
         visitor.visit(tree)
         return visitor.source if visitor.count == 1 else name
-    except (SyntaxError, TypeError, OSError):
+    except (SyntaxError, TypeError, OSError, SystemError):
         return name
 
 
 def get_function_nonlocals(func: Callable) -> List[Any]:
     """Get the nonlocal variables accessed by a function."""
     try:
         code = inspect.getsource(func)
@@ -241,18 +261,25 @@
         for k, v in inspect.getclosurevars(func).nonlocals.items():
             if k in visitor.nonlocals:
                 values.append(v)
             for kk in visitor.nonlocals:
                 if "." in kk and kk.startswith(k):
                     vv = v
                     for part in kk.split(".")[1:]:
-                        vv = getattr(vv, part)
-                    values.append(vv)
+                        if vv is None:
+                            break
+                        else:
+                            try:
+                                vv = getattr(vv, part)
+                            except AttributeError:
+                                break
+                    else:
+                        values.append(vv)
         return values
-    except (SyntaxError, TypeError, OSError):
+    except (SyntaxError, TypeError, OSError, SystemError):
         return []
 
 
 def indent_lines_after_first(text: str, prefix: str) -> str:
     """Indent all lines of text after the first line.
 
     Args:
@@ -333,44 +360,44 @@
             final = chunk
         else:
             final = final + chunk
     return final
 
 
 class ConfigurableField(NamedTuple):
-    """A field that can be configured by the user."""
+    """Field that can be configured by the user."""
 
     id: str
 
     name: Optional[str] = None
     description: Optional[str] = None
     annotation: Optional[Any] = None
     is_shared: bool = False
 
     def __hash__(self) -> int:
         return hash((self.id, self.annotation))
 
 
 class ConfigurableFieldSingleOption(NamedTuple):
-    """A field that can be configured by the user with a default value."""
+    """Field that can be configured by the user with a default value."""
 
     id: str
     options: Mapping[str, Any]
     default: str
 
     name: Optional[str] = None
     description: Optional[str] = None
     is_shared: bool = False
 
     def __hash__(self) -> int:
         return hash((self.id, tuple(self.options.keys()), self.default))
 
 
 class ConfigurableFieldMultiOption(NamedTuple):
-    """A field that can be configured by the user with multiple default values."""
+    """Field that can be configured by the user with multiple default values."""
 
     id: str
     options: Mapping[str, Any]
     default: Sequence[str]
 
     name: Optional[str] = None
     description: Optional[str] = None
@@ -382,15 +409,15 @@
 
 AnyConfigurableField = Union[
     ConfigurableField, ConfigurableFieldSingleOption, ConfigurableFieldMultiOption
 ]
 
 
 class ConfigurableFieldSpec(NamedTuple):
-    """A field that can be configured by the user. It is a specification of a field."""
+    """Field that can be configured by the user. It is a specification of a field."""
 
     id: str
     annotation: Any
 
     name: Optional[str] = None
     description: Optional[str] = None
     default: Any = None
@@ -415,7 +442,121 @@
             unique.append(first)
         else:
             raise ValueError(
                 "RunnableSequence contains conflicting config specs"
                 f"for {id}: {[first] + others}"
             )
     return unique
+
+
+class _RootEventFilter:
+    def __init__(
+        self,
+        *,
+        include_names: Optional[Sequence[str]] = None,
+        include_types: Optional[Sequence[str]] = None,
+        include_tags: Optional[Sequence[str]] = None,
+        exclude_names: Optional[Sequence[str]] = None,
+        exclude_types: Optional[Sequence[str]] = None,
+        exclude_tags: Optional[Sequence[str]] = None,
+    ) -> None:
+        """Utility to filter the root event in the astream_events implementation.
+
+        This is simply binding the arguments to the namespace to make save on
+        a bit of typing in the astream_events implementation.
+        """
+        self.include_names = include_names
+        self.include_types = include_types
+        self.include_tags = include_tags
+        self.exclude_names = exclude_names
+        self.exclude_types = exclude_types
+        self.exclude_tags = exclude_tags
+
+    def include_event(self, event: StreamEvent, root_type: str) -> bool:
+        """Determine whether to include an event."""
+        if (
+            self.include_names is None
+            and self.include_types is None
+            and self.include_tags is None
+        ):
+            include = True
+        else:
+            include = False
+
+        event_tags = event.get("tags") or []
+
+        if self.include_names is not None:
+            include = include or event["name"] in self.include_names
+        if self.include_types is not None:
+            include = include or root_type in self.include_types
+        if self.include_tags is not None:
+            include = include or any(tag in self.include_tags for tag in event_tags)
+
+        if self.exclude_names is not None:
+            include = include and event["name"] not in self.exclude_names
+        if self.exclude_types is not None:
+            include = include and root_type not in self.exclude_types
+        if self.exclude_tags is not None:
+            include = include and all(
+                tag not in self.exclude_tags for tag in event_tags
+            )
+
+        return include
+
+
+class _SchemaConfig(BaseConfig):
+    arbitrary_types_allowed = True
+    frozen = True
+
+
+def create_model(
+    __model_name: str,
+    **field_definitions: Any,
+) -> Type[BaseModel]:
+    """Create a pydantic model with the given field definitions.
+
+    Args:
+        __model_name: The name of the model.
+        **field_definitions: The field definitions for the model.
+
+    Returns:
+        Type[BaseModel]: The created model.
+    """
+    try:
+        return _create_model_cached(__model_name, **field_definitions)
+    except TypeError:
+        # something in field definitions is not hashable
+        return _create_model_base(
+            __model_name, __config__=_SchemaConfig, **field_definitions
+        )
+
+
+@lru_cache(maxsize=256)
+def _create_model_cached(
+    __model_name: str,
+    **field_definitions: Any,
+) -> Type[BaseModel]:
+    return _create_model_base(
+        __model_name, __config__=_SchemaConfig, **field_definitions
+    )
+
+
+def is_async_generator(
+    func: Any,
+) -> TypeGuard[Callable[..., AsyncIterator]]:
+    """Check if a function is an async generator."""
+    return (
+        inspect.isasyncgenfunction(func)
+        or hasattr(func, "__call__")
+        and inspect.isasyncgenfunction(func.__call__)
+    )
+
+
+def is_async_callable(
+    func: Any,
+) -> TypeGuard[Callable[..., Awaitable]]:
+    """Check if a function is async."""
+    return (
+        asyncio.iscoroutinefunction(func)
+        or hasattr(func, "__call__")
+        and asyncio.iscoroutinefunction(func.__call__)
+    )
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tools.py` & `gigachain_core-0.2.0/langchain_core/tools.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,55 +1,101 @@
-"""Base implementation for tools or skills."""
+"""**Tools** are classes that an Agent uses to interact with the world.
+
+Each tool has a **description**. Agent uses the description to choose the right
+tool for the job.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    RunnableSerializable --> BaseTool --> <name>Tool  # Examples: AIPluginTool, BaseGraphQLTool
+                                          <name>      # Examples: BraveSearch, HumanInputRun
+
+**Main helpers:**
+
+.. code-block::
+
+    CallbackManagerForToolRun, AsyncCallbackManagerForToolRun
+"""  # noqa: E501
+
 from __future__ import annotations
 
+import asyncio
 import inspect
+import textwrap
+import uuid
 import warnings
-from abc import abstractmethod
+from abc import ABC, abstractmethod
+from contextvars import copy_context
+from functools import partial
 from inspect import signature
 from typing import Any, Awaitable, Callable, Dict, List, Optional, Tuple, Type, Union
 
+from langchain_core._api import deprecated
 from langchain_core.callbacks import (
     AsyncCallbackManager,
     AsyncCallbackManagerForToolRun,
     BaseCallbackManager,
     CallbackManager,
     CallbackManagerForToolRun,
+)
+from langchain_core.callbacks.manager import (
     Callbacks,
 )
 from langchain_core.load.serializable import Serializable
+from langchain_core.prompts import (
+    BasePromptTemplate,
+    PromptTemplate,
+    aformat_document,
+    format_document,
+)
 from langchain_core.pydantic_v1 import (
     BaseModel,
     Extra,
     Field,
+    ValidationError,
     create_model,
     root_validator,
     validate_arguments,
 )
+from langchain_core.retrievers import BaseRetriever
 from langchain_core.runnables import (
     Runnable,
     RunnableConfig,
     RunnableSerializable,
     ensure_config,
 )
-from langchain_core.runnables.config import run_in_executor
+from langchain_core.runnables.config import (
+    patch_config,
+    run_in_executor,
+    var_child_runnable_config,
+)
+from langchain_core.runnables.utils import accepts_context
 
 
 class SchemaAnnotationError(TypeError):
     """Raised when 'args_schema' is missing or has an incorrect type annotation."""
 
 
 def _create_subset_model(
-    name: str, model: BaseModel, field_names: list
+    name: str, model: Type[BaseModel], field_names: list
 ) -> Type[BaseModel]:
     """Create a pydantic model with only a subset of model's fields."""
     fields = {}
     for field_name in field_names:
         field = model.__fields__[field_name]
-        fields[field_name] = (field.outer_type_, field.field_info)
-    return create_model(name, **fields)  # type: ignore
+        t = (
+            # this isn't perfect but should work for most functions
+            field.outer_type_
+            if field.required and not field.allow_none
+            else Optional[field.outer_type_]
+        )
+        fields[field_name] = (t, field.field_info)
+    rtn = create_model(name, **fields)  # type: ignore
+    return rtn
 
 
 def _get_filtered_args(
     inferred_model: Type[BaseModel],
     func: Callable,
 ) -> dict:
     """Get the arguments from a function's signature."""
@@ -87,18 +133,18 @@
     valid_properties = _get_filtered_args(inferred_model, func)
     return _create_subset_model(
         f"{model_name}Schema", inferred_model, list(valid_properties)
     )
 
 
 class ToolException(Exception):
-    """An optional exception that tool throws when execution error occurs.
+    """Optional exception that tool throws when execution error occurs.
 
     When this exception is thrown, the agent will not stop working,
-    but will handle the exception according to the handle_tool_error
+    but it will handle the exception according to the handle_tool_error
     variable of the tool, and the processing result will be returned
     to the agent as observation, and printed in red on the console.
     """
 
     pass
 
 
@@ -107,33 +153,32 @@
 
     def __init_subclass__(cls, **kwargs: Any) -> None:
         """Create the definition of the new tool class."""
         super().__init_subclass__(**kwargs)
 
         args_schema_type = cls.__annotations__.get("args_schema", None)
 
-        if args_schema_type is not None:
-            if args_schema_type is None or args_schema_type == BaseModel:
-                # Throw errors for common mis-annotations.
-                # TODO: Use get_args / get_origin and fully
-                # specify valid annotations.
-                typehint_mandate = """
+        if args_schema_type is not None and args_schema_type == BaseModel:
+            # Throw errors for common mis-annotations.
+            # TODO: Use get_args / get_origin and fully
+            # specify valid annotations.
+            typehint_mandate = """
 class ChildTool(BaseTool):
     ...
     args_schema: Type[BaseModel] = SchemaClass
     ..."""
-                name = cls.__name__
-                raise SchemaAnnotationError(
-                    f"Tool definition for {name} must include valid type annotations"
-                    f" for argument 'args_schema' to behave as expected.\n"
-                    f"Expected annotation of 'Type[BaseModel]'"
-                    f" but got '{args_schema_type}'.\n"
-                    f"Expected class looks like:\n"
-                    f"{typehint_mandate}"
-                )
+            name = cls.__name__
+            raise SchemaAnnotationError(
+                f"Tool definition for {name} must include valid type annotations"
+                f" for argument 'args_schema' to behave as expected.\n"
+                f"Expected annotation of 'Type[BaseModel]'"
+                f" but got '{args_schema_type}'.\n"
+                f"Expected class looks like:\n"
+                f"{typehint_mandate}"
+            )
 
     name: str
     """The unique name of the tool that clearly communicates its purpose."""
     description: str
     """Used to tell the model how/when/why to use the tool.
     
     You can provide few-shot examples as a part of the description.
@@ -166,14 +211,19 @@
     """
 
     handle_tool_error: Optional[
         Union[bool, str, Callable[[ToolException], str]]
     ] = False
     """Handle the content of the ToolException thrown."""
 
+    handle_validation_error: Optional[
+        Union[bool, str, Callable[[ValidationError], str]]
+    ] = False
+    """Handle the content of the ValidationError thrown."""
+
     class Config(Serializable.Config):
         """Configuration for this pydantic object."""
 
         arbitrary_types_allowed = True
 
     @property
     def is_single_input(self) -> bool:
@@ -209,14 +259,16 @@
         config = ensure_config(config)
         return self.run(
             input,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            config=config,
             **kwargs,
         )
 
     async def ainvoke(
         self,
         input: Union[str, Dict],
         config: Optional[RunnableConfig] = None,
@@ -225,14 +277,16 @@
         config = ensure_config(config)
         return await self.arun(
             input,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            config=config,
             **kwargs,
         )
 
     # --- Tool ---
 
     def _parse_input(
         self,
@@ -244,15 +298,19 @@
             if input_args is not None:
                 key_ = next(iter(input_args.__fields__.keys()))
                 input_args.validate({key_: tool_input})
             return tool_input
         else:
             if input_args is not None:
                 result = input_args.parse_obj(tool_input)
-                return {k: v for k, v in result.dict().items() if k in tool_input}
+                return {
+                    k: getattr(result, k)
+                    for k, v in result.dict().items()
+                    if k in tool_input
+                }
         return tool_input
 
     @root_validator()
     def raise_deprecation(cls, values: Dict) -> Dict:
         """Raise deprecation warning if callback_manager is used."""
         if values.get("callback_manager") is not None:
             warnings.warn(
@@ -292,27 +350,28 @@
         if isinstance(tool_input, str):
             return (tool_input,), {}
         else:
             return (), tool_input
 
     def run(
         self,
-        tool_input: Union[str, Dict],
+        tool_input: Union[str, Dict[str, Any]],
         verbose: Optional[bool] = None,
         start_color: Optional[str] = "green",
         color: Optional[str] = "green",
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
+        config: Optional[RunnableConfig] = None,
         **kwargs: Any,
     ) -> Any:
         """Run the tool."""
-        parsed_input = self._parse_input(tool_input)
         if not self.verbose and verbose is not None:
             verbose_ = verbose
         else:
             verbose_ = self.verbose
         callback_manager = CallbackManager.configure(
             callbacks,
             self.callbacks,
@@ -325,23 +384,53 @@
         # TODO: maybe also pass through run_manager is _run supports kwargs
         new_arg_supported = signature(self._run).parameters.get("run_manager")
         run_manager = callback_manager.on_tool_start(
             {"name": self.name, "description": self.description},
             tool_input if isinstance(tool_input, str) else str(tool_input),
             color=start_color,
             name=run_name,
+            run_id=run_id,
+            # Inputs by definition should always be dicts.
+            # For now, it's unclear whether this assumption is ever violated,
+            # but if it is we will send a `None` value to the callback instead
+            # And will need to address issue via a patch.
+            inputs=None if isinstance(tool_input, str) else tool_input,
             **kwargs,
         )
         try:
+            child_config = patch_config(
+                config,
+                callbacks=run_manager.get_child(),
+            )
+            context = copy_context()
+            context.run(var_child_runnable_config.set, child_config)
+            parsed_input = self._parse_input(tool_input)
             tool_args, tool_kwargs = self._to_args_and_kwargs(parsed_input)
             observation = (
-                self._run(*tool_args, run_manager=run_manager, **tool_kwargs)
+                context.run(
+                    self._run, *tool_args, run_manager=run_manager, **tool_kwargs
+                )
                 if new_arg_supported
-                else self._run(*tool_args, **tool_kwargs)
+                else context.run(self._run, *tool_args, **tool_kwargs)
             )
+        except ValidationError as e:
+            if not self.handle_validation_error:
+                raise e
+            elif isinstance(self.handle_validation_error, bool):
+                observation = "Tool input validation error"
+            elif isinstance(self.handle_validation_error, str):
+                observation = self.handle_validation_error
+            elif callable(self.handle_validation_error):
+                observation = self.handle_validation_error(e)
+            else:
+                raise ValueError(
+                    f"Got unexpected type of `handle_validation_error`. Expected bool, "
+                    f"str or callable. Received: {self.handle_validation_error}"
+                )
+            return observation
         except ToolException as e:
             if not self.handle_tool_error:
                 run_manager.on_tool_error(e)
                 raise e
             elif isinstance(self.handle_tool_error, bool):
                 if e.args:
                     observation = e.args[0]
@@ -352,42 +441,39 @@
             elif callable(self.handle_tool_error):
                 observation = self.handle_tool_error(e)
             else:
                 raise ValueError(
                     f"Got unexpected type of `handle_tool_error`. Expected bool, str "
                     f"or callable. Received: {self.handle_tool_error}"
                 )
-            run_manager.on_tool_end(
-                str(observation), color="red", name=self.name, **kwargs
-            )
+            run_manager.on_tool_end(observation, color="red", name=self.name, **kwargs)
             return observation
         except (Exception, KeyboardInterrupt) as e:
             run_manager.on_tool_error(e)
             raise e
         else:
-            run_manager.on_tool_end(
-                str(observation), color=color, name=self.name, **kwargs
-            )
+            run_manager.on_tool_end(observation, color=color, name=self.name, **kwargs)
             return observation
 
     async def arun(
         self,
         tool_input: Union[str, Dict],
         verbose: Optional[bool] = None,
         start_color: Optional[str] = "green",
         color: Optional[str] = "green",
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
+        config: Optional[RunnableConfig] = None,
         **kwargs: Any,
     ) -> Any:
         """Run the tool asynchronously."""
-        parsed_input = self._parse_input(tool_input)
         if not self.verbose and verbose is not None:
             verbose_ = verbose
         else:
             verbose_ = self.verbose
         callback_manager = AsyncCallbackManager.configure(
             callbacks,
             self.callbacks,
@@ -399,24 +485,55 @@
         )
         new_arg_supported = signature(self._arun).parameters.get("run_manager")
         run_manager = await callback_manager.on_tool_start(
             {"name": self.name, "description": self.description},
             tool_input if isinstance(tool_input, str) else str(tool_input),
             color=start_color,
             name=run_name,
+            inputs=tool_input,
+            run_id=run_id,
             **kwargs,
         )
         try:
+            parsed_input = self._parse_input(tool_input)
             # We then call the tool on the tool input to get an observation
             tool_args, tool_kwargs = self._to_args_and_kwargs(parsed_input)
-            observation = (
-                await self._arun(*tool_args, run_manager=run_manager, **tool_kwargs)
+            child_config = patch_config(
+                config,
+                callbacks=run_manager.get_child(),
+            )
+            context = copy_context()
+            context.run(var_child_runnable_config.set, child_config)
+            coro = (
+                context.run(
+                    self._arun, *tool_args, run_manager=run_manager, **tool_kwargs
+                )
                 if new_arg_supported
-                else await self._arun(*tool_args, **tool_kwargs)
+                else context.run(self._arun, *tool_args, **tool_kwargs)
             )
+            if accepts_context(asyncio.create_task):
+                observation = await asyncio.create_task(coro, context=context)  # type: ignore
+            else:
+                observation = await coro
+
+        except ValidationError as e:
+            if not self.handle_validation_error:
+                raise e
+            elif isinstance(self.handle_validation_error, bool):
+                observation = "Tool input validation error"
+            elif isinstance(self.handle_validation_error, str):
+                observation = self.handle_validation_error
+            elif callable(self.handle_validation_error):
+                observation = self.handle_validation_error(e)
+            else:
+                raise ValueError(
+                    f"Got unexpected type of `handle_validation_error`. Expected bool, "
+                    f"str or callable. Received: {self.handle_validation_error}"
+                )
+            return observation
         except ToolException as e:
             if not self.handle_tool_error:
                 await run_manager.on_tool_error(e)
                 raise e
             elif isinstance(self.handle_tool_error, bool):
                 if e.args:
                     observation = e.args[0]
@@ -428,26 +545,27 @@
                 observation = self.handle_tool_error(e)
             else:
                 raise ValueError(
                     f"Got unexpected type of `handle_tool_error`. Expected bool, str "
                     f"or callable. Received: {self.handle_tool_error}"
                 )
             await run_manager.on_tool_end(
-                str(observation), color="red", name=self.name, **kwargs
+                observation, color="red", name=self.name, **kwargs
             )
             return observation
         except (Exception, KeyboardInterrupt) as e:
             await run_manager.on_tool_error(e)
             raise e
         else:
             await run_manager.on_tool_end(
-                str(observation), color=color, name=self.name, **kwargs
+                observation, color=color, name=self.name, **kwargs
             )
             return observation
 
+    @deprecated("0.1.47", alternative="invoke", removal="0.3.0")
     def __call__(self, tool_input: str, callbacks: Callbacks = None) -> str:
         """Make tool callable."""
         return self.run(tool_input, callbacks=callbacks)
 
 
 class Tool(BaseTool):
     """Tool that takes in function or coroutine directly."""
@@ -486,15 +604,16 @@
     def _to_args_and_kwargs(self, tool_input: Union[str, Dict]) -> Tuple[Tuple, Dict]:
         """Convert tool input to pydantic model."""
         args, kwargs = super()._to_args_and_kwargs(tool_input)
         # For backwards compatibility. The tool must be run with a single input
         all_args = list(args) + list(kwargs.values())
         if len(all_args) != 1:
             raise ToolException(
-                f"Too many arguments to single-input tool {self.name}."
+                f"""Too many arguments to single-input tool {self.name}.
+                Consider using StructuredTool instead."""
                 f" Args: {all_args}"
             )
         return tuple(all_args), {}
 
     def _run(
         self,
         *args: Any,
@@ -545,15 +664,15 @@
             )
 
     # TODO: this is for backwards compatibility, remove in future
     def __init__(
         self, name: str, func: Optional[Callable], description: str, **kwargs: Any
     ) -> None:
         """Initialize tool."""
-        super(Tool, self).__init__(
+        super(Tool, self).__init__(  # type: ignore[call-arg]
             name=name, func=func, description=description, **kwargs
         )
 
     @classmethod
     def from_function(
         cls,
         func: Optional[Callable],
@@ -703,33 +822,36 @@
         if func is not None:
             source_function = func
         elif coroutine is not None:
             source_function = coroutine
         else:
             raise ValueError("Function and/or coroutine must be provided")
         name = name or source_function.__name__
-        description = description or source_function.__doc__
-        if description is None:
+        description_ = description or source_function.__doc__
+        if description_ is None:
             raise ValueError(
                 "Function must have a docstring if description not provided."
             )
+        if description is None:
+            # Only apply if using the function's docstring
+            description_ = textwrap.dedent(description_).strip()
 
         # Description example:
         # search_api(query: str) - Searches the API for the query.
-        sig = signature(source_function)
-        description = f"{name}{sig} - {description.strip()}"
+        description_ = f"{description_.strip()}"
         _args_schema = args_schema
         if _args_schema is None and infer_schema:
-            _args_schema = create_schema_from_function(f"{name}Schema", source_function)
+            # schema name is appended within function
+            _args_schema = create_schema_from_function(name, source_function)
         return cls(
             name=name,
             func=func,
             coroutine=coroutine,
-            args_schema=_args_schema,
-            description=description,
+            args_schema=_args_schema,  # type: ignore[arg-type]
+            description=description_,
             return_direct=return_direct,
             **kwargs,
         )
 
 
 def tool(
     *args: Union[str, Callable, Runnable],
@@ -841,7 +963,137 @@
         # Example usage: @tool(return_direct=True)
         def _partial(func: Callable[[str], str]) -> BaseTool:
             return _make_with_name(func.__name__)(func)
 
         return _partial
     else:
         raise ValueError("Too many arguments for tool decorator")
+
+
+class RetrieverInput(BaseModel):
+    """Input to the retriever."""
+
+    query: str = Field(description="query to look up in retriever")
+
+
+def _get_relevant_documents(
+    query: str,
+    retriever: BaseRetriever,
+    document_prompt: BasePromptTemplate,
+    document_separator: str,
+    callbacks: Callbacks = None,
+) -> str:
+    docs = retriever.invoke(query, config={"callbacks": callbacks})
+    return document_separator.join(
+        format_document(doc, document_prompt) for doc in docs
+    )
+
+
+async def _aget_relevant_documents(
+    query: str,
+    retriever: BaseRetriever,
+    document_prompt: BasePromptTemplate,
+    document_separator: str,
+    callbacks: Callbacks = None,
+) -> str:
+    docs = await retriever.ainvoke(query, config={"callbacks": callbacks})
+    return document_separator.join(
+        [await aformat_document(doc, document_prompt) for doc in docs]
+    )
+
+
+def create_retriever_tool(
+    retriever: BaseRetriever,
+    name: str,
+    description: str,
+    *,
+    document_prompt: Optional[BasePromptTemplate] = None,
+    document_separator: str = "\n\n",
+) -> Tool:
+    """Create a tool to do retrieval of documents.
+
+    Args:
+        retriever: The retriever to use for the retrieval
+        name: The name for the tool. This will be passed to the language model,
+            so should be unique and somewhat descriptive.
+        description: The description for the tool. This will be passed to the language
+            model, so should be descriptive.
+
+    Returns:
+        Tool class to pass to an agent
+    """
+    document_prompt = document_prompt or PromptTemplate.from_template("{page_content}")
+    func = partial(
+        _get_relevant_documents,
+        retriever=retriever,
+        document_prompt=document_prompt,
+        document_separator=document_separator,
+    )
+    afunc = partial(
+        _aget_relevant_documents,
+        retriever=retriever,
+        document_prompt=document_prompt,
+        document_separator=document_separator,
+    )
+    return Tool(
+        name=name,
+        description=description,
+        func=func,
+        coroutine=afunc,
+        args_schema=RetrieverInput,
+    )
+
+
+ToolsRenderer = Callable[[List[BaseTool]], str]
+
+
+def render_text_description(tools: List[BaseTool]) -> str:
+    """Render the tool name and description in plain text.
+
+    Output will be in the format of:
+
+    .. code-block:: markdown
+
+        search: This tool is used for search
+        calculator: This tool is used for math
+    """
+    descriptions = []
+    for tool in tools:
+        if hasattr(tool, "func") and tool.func:
+            sig = signature(tool.func)
+            description = f"{tool.name}{sig} - {tool.description}"
+        else:
+            description = f"{tool.name} - {tool.description}"
+
+        descriptions.append(description)
+    return "\n".join(descriptions)
+
+
+def render_text_description_and_args(tools: List[BaseTool]) -> str:
+    """Render the tool name, description, and args in plain text.
+
+    Output will be in the format of:
+
+    .. code-block:: markdown
+
+        search: This tool is used for search, args: {"query": {"type": "string"}}
+        calculator: This tool is used for math, \
+args: {"expression": {"type": "string"}}
+    """
+    tool_strings = []
+    for tool in tools:
+        args_schema = str(tool.args)
+        if hasattr(tool, "func") and tool.func:
+            sig = signature(tool.func)
+            description = f"{tool.name}{sig} - {tool.description}"
+        else:
+            description = f"{tool.name} - {tool.description}"
+        tool_strings.append(f"{description}, args: {args_schema}")
+    return "\n".join(tool_strings)
+
+
+class BaseToolkit(BaseModel, ABC):
+    """Base Toolkit representing a collection of related tools."""
+
+    @abstractmethod
+    def get_tools(self) -> List[BaseTool]:
+        """Get the tools in the toolkit."""
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/base.py` & `gigachain_core-0.2.0/langchain_core/tracers/base.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,32 +1,37 @@
 """Base interfaces for tracing runs."""
+
 from __future__ import annotations
 
 import logging
 import sys
 import traceback
 from abc import ABC, abstractmethod
 from datetime import datetime, timezone
 from typing import (
     TYPE_CHECKING,
     Any,
     Dict,
     List,
+    Literal,
     Optional,
     Sequence,
+    Set,
+    Tuple,
     Union,
     cast,
 )
 from uuid import UUID
 
 from tenacity import RetryCallState
 
 from langchain_core.callbacks.base import BaseCallbackHandler
 from langchain_core.exceptions import TracerException
 from langchain_core.load import dumpd
+from langchain_core.messages import BaseMessage
 from langchain_core.outputs import (
     ChatGeneration,
     ChatGenerationChunk,
     GenerationChunk,
     LLMResult,
 )
 from langchain_core.tracers.schemas import Run
@@ -36,17 +41,41 @@
 
 logger = logging.getLogger(__name__)
 
 
 class BaseTracer(BaseCallbackHandler, ABC):
     """Base interface for tracers."""
 
-    def __init__(self, **kwargs: Any) -> None:
+    def __init__(
+        self,
+        *,
+        _schema_format: Literal["original", "streaming_events"] = "original",
+        **kwargs: Any,
+    ) -> None:
+        """Initialize the tracer.
+
+        Args:
+            _schema_format: Primarily changes how the inputs and outputs are
+                handled. For internal use only. This API will change.
+                - 'original' is the format used by all current tracers.
+                   This format is slightly inconsistent with respect to inputs
+                   and outputs.
+                - 'streaming_events' is used for supporting streaming events,
+                   for internal usage. It will likely change in the future, or
+                   be deprecated entirely in favor of a dedicated async tracer
+                   for streaming events.
+            kwargs: Additional keyword arguments that will be passed to
+                    the super class.
+        """
         super().__init__(**kwargs)
+        self._schema_format = _schema_format  # For internal use only API will change.
         self.run_map: Dict[str, Run] = {}
+        """Map of run ID to run. Cleared on run end."""
+        self.order_map: Dict[UUID, Tuple[UUID, str]] = {}
+        """Map of run ID to (trace_id, dotted_order). Cleared when tracer GCed."""
 
     @staticmethod
     def _add_child_run(
         parent_run: Run,
         child_run: Run,
     ) -> None:
         """Add child run to a chain run or tool run."""
@@ -71,115 +100,135 @@
         except:  # noqa: E722
             return msg
 
     def _start_trace(self, run: Run) -> None:
         """Start a trace for a run."""
         current_dotted_order = run.start_time.strftime("%Y%m%dT%H%M%S%fZ") + str(run.id)
         if run.parent_run_id:
-            parent_run = self.run_map.get(str(run.parent_run_id))
-            if parent_run:
-                self._add_child_run(parent_run, run)
-                parent_run.child_execution_order = max(
-                    parent_run.child_execution_order, run.child_execution_order
-                )
-                run.trace_id = parent_run.trace_id
-                if parent_run.dotted_order:
-                    run.dotted_order = (
-                        parent_run.dotted_order + "." + current_dotted_order
-                    )
-                else:
-                    # Something wrong with tracer parent run has no dotted_order
-                    logger.debug(
-                        f"Parent run with UUID {run.parent_run_id} has no dotted_order."
-                    )
+            if parent := self.order_map.get(run.parent_run_id):
+                run.trace_id, run.dotted_order = parent
+                run.dotted_order += "." + current_dotted_order
+                if parent_run := self.run_map.get(str(run.parent_run_id)):
+                    self._add_child_run(parent_run, run)
             else:
-                # Something wrong with tracer, parent run not found
-                # Calculate the trace_id and dotted_order server side
-                logger.debug(f"Parent run with UUID {run.parent_run_id} not found.")
+                logger.debug(
+                    f"Parent run {run.parent_run_id} not found for run {run.id}."
+                    " Treating as a root run."
+                )
+                run.parent_run_id = None
+                run.trace_id = run.id
+                run.dotted_order = current_dotted_order
         else:
             run.trace_id = run.id
             run.dotted_order = current_dotted_order
+        self.order_map[run.id] = (run.trace_id, run.dotted_order)
         self.run_map[str(run.id)] = run
         self._on_run_create(run)
 
     def _end_trace(self, run: Run) -> None:
         """End a trace for a run."""
         if not run.parent_run_id:
             self._persist_run(run)
-        else:
-            parent_run = self.run_map.get(str(run.parent_run_id))
-            if parent_run is None:
-                logger.debug(f"Parent run with UUID {run.parent_run_id} not found.")
-            elif (
-                run.child_execution_order is not None
-                and parent_run.child_execution_order is not None
-                and run.child_execution_order > parent_run.child_execution_order
-            ):
-                parent_run.child_execution_order = run.child_execution_order
         self.run_map.pop(str(run.id))
         self._on_run_update(run)
 
-    def _get_execution_order(self, parent_run_id: Optional[str] = None) -> int:
-        """Get the execution order for a run."""
-        if parent_run_id is None:
-            return 1
-
-        parent_run = self.run_map.get(parent_run_id)
-        if parent_run is None:
-            logger.debug(f"Parent run with UUID {parent_run_id} not found.")
-            return 1
-        if parent_run.child_execution_order is None:
-            raise TracerException(
-                f"Parent run with UUID {parent_run_id} has no child execution order."
-            )
-
-        return parent_run.child_execution_order + 1
-
-    def _get_run(self, run_id: UUID, run_type: Optional[str] = None) -> Run:
+    def _get_run(
+        self, run_id: UUID, run_type: Union[str, Set[str], None] = None
+    ) -> Run:
         try:
             run = self.run_map[str(run_id)]
         except KeyError as exc:
             raise TracerException(f"No indexed run ID {run_id}.") from exc
-        if run_type is not None and run.run_type != run_type:
+
+        if isinstance(run_type, str):
+            run_types: Union[Set[str], None] = {run_type}
+        else:
+            run_types = run_type
+        if run_types is not None and run.run_type not in run_types:
             raise TracerException(
-                f"Found {run.run_type} run at ID {run_id}, but expected {run_type} run."
+                f"Found {run.run_type} run at ID {run_id}, "
+                f"but expected {run_types} run."
             )
         return run
 
+    def on_chat_model_start(
+        self,
+        serialized: Dict[str, Any],
+        messages: List[List[BaseMessage]],
+        *,
+        run_id: UUID,
+        tags: Optional[List[str]] = None,
+        parent_run_id: Optional[UUID] = None,
+        metadata: Optional[Dict[str, Any]] = None,
+        name: Optional[str] = None,
+        **kwargs: Any,
+    ) -> Run:
+        """Start a trace for an LLM run."""
+        if self._schema_format != "streaming_events":
+            # Please keep this un-implemented for backwards compatibility.
+            # When it's unimplemented old tracers that use the "original" format
+            # fallback on the on_llm_start method implementation if they
+            # find that the on_chat_model_start method is not implemented.
+            # This can eventually be cleaned up by writing a "modern" tracer
+            # that has all the updated schema changes corresponding to
+            # the "streaming_events" format.
+            raise NotImplementedError(
+                f"Chat model tracing is not supported in "
+                f"for {self._schema_format} format."
+            )
+        start_time = datetime.now(timezone.utc)
+        if metadata:
+            kwargs.update({"metadata": metadata})
+        chat_model_run = Run(
+            id=run_id,
+            parent_run_id=parent_run_id,
+            serialized=serialized,
+            inputs={"messages": [[dumpd(msg) for msg in batch] for batch in messages]},
+            extra=kwargs,
+            events=[{"name": "start", "time": start_time}],
+            start_time=start_time,
+            # WARNING: This is valid ONLY for streaming_events.
+            # run_type="llm" is what's used by virtually all tracers.
+            # Changing this to "chat_model" may break triggering on_llm_start
+            run_type="chat_model",
+            tags=tags,
+            name=name,  # type: ignore[arg-type]
+        )
+        self._start_trace(chat_model_run)
+        self._on_chat_model_start(chat_model_run)
+        return chat_model_run
+
     def on_llm_start(
         self,
         serialized: Dict[str, Any],
         prompts: List[str],
         *,
         run_id: UUID,
         tags: Optional[List[str]] = None,
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
         **kwargs: Any,
     ) -> Run:
         """Start a trace for an LLM run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         llm_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
+            # TODO: Figure out how to expose kwargs here
             inputs={"prompts": prompts},
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             run_type="llm",
             tags=tags or [],
-            name=name,
+            name=name,  # type: ignore[arg-type]
         )
         self._start_trace(llm_run)
         self._on_llm_start(llm_run)
         return llm_run
 
     def on_llm_new_token(
         self,
@@ -187,15 +236,17 @@
         *,
         chunk: Optional[Union[GenerationChunk, ChatGenerationChunk]] = None,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> Run:
         """Run on new LLM token. Only available when streaming is enabled."""
-        llm_run = self._get_run(run_id, run_type="llm")
+        # "chat_model" is only used for the experimental new streaming_events format.
+        # This change should not affect any existing tracers.
+        llm_run = self._get_run(run_id, run_type={"llm", "chat_model"})
         event_kwargs: Dict[str, Any] = {"token": token}
         if chunk:
             event_kwargs["chunk"] = chunk
         llm_run.events.append(
             {
                 "name": "new_token",
                 "time": datetime.now(timezone.utc),
@@ -234,15 +285,17 @@
                 "kwargs": retry_d,
             },
         )
         return llm_run
 
     def on_llm_end(self, response: LLMResult, *, run_id: UUID, **kwargs: Any) -> Run:
         """End a trace for an LLM run."""
-        llm_run = self._get_run(run_id, run_type="llm")
+        # "chat_model" is only used for the experimental new streaming_events format.
+        # This change should not affect any existing tracers.
+        llm_run = self._get_run(run_id, run_type={"llm", "chat_model"})
         llm_run.outputs = response.dict()
         for i, generations in enumerate(response.generations):
             for j, generation in enumerate(generations):
                 output_generation = llm_run.outputs["generations"][i][j]
                 if "message" in output_generation:
                     output_generation["message"] = dumpd(
                         cast(ChatGeneration, generation).message
@@ -257,15 +310,17 @@
         self,
         error: BaseException,
         *,
         run_id: UUID,
         **kwargs: Any,
     ) -> Run:
         """Handle an error for an LLM run."""
-        llm_run = self._get_run(run_id, run_type="llm")
+        # "chat_model" is only used for the experimental new streaming_events format.
+        # This change should not affect any existing tracers.
+        llm_run = self._get_run(run_id, run_type={"llm", "chat_model"})
         llm_run.error = self._get_stacktrace(error)
         llm_run.end_time = datetime.now(timezone.utc)
         llm_run.events.append({"name": "error", "time": llm_run.end_time})
         self._end_trace(llm_run)
         self._on_llm_error(llm_run)
         return llm_run
 
@@ -279,55 +334,71 @@
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_type: Optional[str] = None,
         name: Optional[str] = None,
         **kwargs: Any,
     ) -> Run:
         """Start a trace for a chain run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         chain_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
-            inputs=inputs if isinstance(inputs, dict) else {"input": inputs},
+            inputs=self._get_chain_inputs(inputs),
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             child_runs=[],
             run_type=run_type or "chain",
-            name=name,
+            name=name,  # type: ignore[arg-type]
             tags=tags or [],
         )
         self._start_trace(chain_run)
         self._on_chain_start(chain_run)
         return chain_run
 
+    def _get_chain_inputs(self, inputs: Any) -> Any:
+        """Get the inputs for a chain run."""
+        if self._schema_format == "original":
+            return inputs if isinstance(inputs, dict) else {"input": inputs}
+        elif self._schema_format == "streaming_events":
+            return {
+                "input": inputs,
+            }
+        else:
+            raise ValueError(f"Invalid format: {self._schema_format}")
+
+    def _get_chain_outputs(self, outputs: Any) -> Any:
+        """Get the outputs for a chain run."""
+        if self._schema_format == "original":
+            return outputs if isinstance(outputs, dict) else {"output": outputs}
+        elif self._schema_format == "streaming_events":
+            return {
+                "output": outputs,
+            }
+        else:
+            raise ValueError(f"Invalid format: {self._schema_format}")
+
     def on_chain_end(
         self,
         outputs: Dict[str, Any],
         *,
         run_id: UUID,
         inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Run:
         """End a trace for a chain run."""
         chain_run = self._get_run(run_id)
-        chain_run.outputs = (
-            outputs if isinstance(outputs, dict) else {"output": outputs}
-        )
+        chain_run.outputs = self._get_chain_outputs(outputs)
         chain_run.end_time = datetime.now(timezone.utc)
         chain_run.events.append({"name": "end", "time": chain_run.end_time})
         if inputs is not None:
-            chain_run.inputs = inputs if isinstance(inputs, dict) else {"input": inputs}
+            chain_run.inputs = self._get_chain_inputs(inputs)
         self._end_trace(chain_run)
         self._on_chain_end(chain_run)
         return chain_run
 
     def on_chain_error(
         self,
         error: BaseException,
@@ -338,57 +409,63 @@
     ) -> Run:
         """Handle an error for a chain run."""
         chain_run = self._get_run(run_id)
         chain_run.error = self._get_stacktrace(error)
         chain_run.end_time = datetime.now(timezone.utc)
         chain_run.events.append({"name": "error", "time": chain_run.end_time})
         if inputs is not None:
-            chain_run.inputs = inputs if isinstance(inputs, dict) else {"input": inputs}
+            chain_run.inputs = self._get_chain_inputs(inputs)
         self._end_trace(chain_run)
         self._on_chain_error(chain_run)
         return chain_run
 
     def on_tool_start(
         self,
         serialized: Dict[str, Any],
         input_str: str,
         *,
         run_id: UUID,
         tags: Optional[List[str]] = None,
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Run:
         """Start a trace for a tool run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
+
+        if self._schema_format == "original":
+            inputs = {"input": input_str}
+        elif self._schema_format == "streaming_events":
+            inputs = {"input": inputs}
+        else:
+            raise AssertionError(f"Invalid format: {self._schema_format}")
+
         tool_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
-            inputs={"input": input_str},
+            # Wrapping in dict since Run requires a dict object.
+            inputs=inputs,
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             child_runs=[],
             run_type="tool",
             tags=tags or [],
-            name=name,
+            name=name,  # type: ignore[arg-type]
         )
         self._start_trace(tool_run)
         self._on_tool_start(tool_run)
         return tool_run
 
-    def on_tool_end(self, output: str, *, run_id: UUID, **kwargs: Any) -> Run:
+    def on_tool_end(self, output: Any, *, run_id: UUID, **kwargs: Any) -> Run:
         """End a trace for a tool run."""
         tool_run = self._get_run(run_id, run_type="tool")
         tool_run.outputs = {"output": output}
         tool_run.end_time = datetime.now(timezone.utc)
         tool_run.events.append({"name": "end", "time": tool_run.end_time})
         self._end_trace(tool_run)
         self._on_tool_end(tool_run)
@@ -419,30 +496,26 @@
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
         **kwargs: Any,
     ) -> Run:
         """Run when Retriever starts running."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         retrieval_run = Run(
             id=run_id,
             name=name or "Retriever",
             parent_run_id=parent_run_id,
             serialized=serialized,
             inputs={"query": query},
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             tags=tags,
             child_runs=[],
             run_type="retriever",
         )
         self._start_trace(retrieval_run)
         self._on_retriever_start(retrieval_run)
         return retrieval_run
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/context.py` & `gigachain_core-0.2.0/langchain_core/tracers/context.py`

 * *Files 5% similar despite different names*

```diff
@@ -14,65 +14,43 @@
     cast,
 )
 from uuid import UUID
 
 from langsmith import utils as ls_utils
 from langsmith.run_helpers import get_run_tree_context
 
-from langchain_core._api import deprecated
 from langchain_core.tracers.langchain import LangChainTracer
-from langchain_core.tracers.langchain_v1 import LangChainTracerV1
 from langchain_core.tracers.run_collector import RunCollectorCallbackHandler
 from langchain_core.tracers.schemas import TracerSessionV1
 from langchain_core.utils.env import env_var_is_set
 
 if TYPE_CHECKING:
     from langsmith import Client as LangSmithClient
 
     from langchain_core.callbacks.base import BaseCallbackHandler, Callbacks
     from langchain_core.callbacks.manager import AsyncCallbackManager, CallbackManager
 
-# Deprecated as of 0.1.0, will be removed in 0.2.0.
-tracing_callback_var: ContextVar[Optional[LangChainTracerV1]] = ContextVar(  # noqa: E501
-    "tracing_callback", default=None
-)
-
-tracing_v2_callback_var: ContextVar[Optional[LangChainTracer]] = ContextVar(  # noqa: E501
+# for backwards partial compatibility if this is imported by users but unused
+tracing_callback_var: Any = None
+tracing_v2_callback_var: ContextVar[Optional[LangChainTracer]] = ContextVar(
     "tracing_callback_v2", default=None
-)
-run_collector_var: ContextVar[Optional[RunCollectorCallbackHandler]] = ContextVar(  # noqa: E501
+)  # noqa: E501
+run_collector_var: ContextVar[Optional[RunCollectorCallbackHandler]] = ContextVar(
     "run_collector", default=None
-)
+)  # noqa: E501
 
 
 @contextmanager
-@deprecated("0.1.0", alternative="tracing_v2_enabled", removal="0.2.0")
 def tracing_enabled(
     session_name: str = "default",
 ) -> Generator[TracerSessionV1, None, None]:
-    """Get the Deprecated LangChainTracer in a context manager.
-
-    Args:
-        session_name (str, optional): The name of the session.
-          Defaults to "default".
-
-    Returns:
-        TracerSessionV1: The LangChainTracer session.
-
-    Example:
-        >>> with tracing_enabled() as session:
-        ...     # Use the LangChainTracer session
-    """
-    cb = LangChainTracerV1()
-    session = cast(TracerSessionV1, cb.load_session(session_name))
-    try:
-        tracing_callback_var.set(cb)
-        yield session
-    finally:
-        tracing_callback_var.set(None)
+    """Throw an error because this has been replaced by tracing_v2_enabled."""
+    raise RuntimeError(
+        "tracing_enabled is no longer supported. Please use tracing_enabled_v2 instead."
+    )
 
 
 @contextmanager
 def tracing_v2_enabled(
     project_name: Optional[str] = None,
     *,
     example_id: Optional[Union[str, UUID]] = None,
@@ -165,14 +143,16 @@
         cb = None
     return cb
 
 
 def _tracing_v2_is_enabled() -> bool:
     return (
         env_var_is_set("LANGCHAIN_TRACING_V2")
+        or env_var_is_set("LANGSMITH_TRACING")
+        or env_var_is_set("LANGSMITH_TRACING_V2")
         or tracing_v2_callback_var.get() is not None
         or get_run_tree_context() is not None
     )
 
 
 def _get_tracer_project() -> str:
     run_tree = get_run_tree_context()
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/evaluation.py` & `gigachain_core-0.2.0/langchain_core/tracers/evaluation.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """A tracer that runs evaluators over completed runs."""
+
 from __future__ import annotations
 
 import logging
 import threading
 import weakref
 from concurrent.futures import Future, ThreadPoolExecutor, wait
 from typing import Any, Dict, List, Optional, Sequence, Tuple, Union, cast
@@ -27,15 +28,15 @@
     global _TRACERS
     for tracer in list(_TRACERS):
         if tracer is not None:
             tracer.wait_for_futures()
 
 
 class EvaluatorCallbackHandler(BaseTracer):
-    """A tracer that runs a run evaluator whenever a run is persisted.
+    """Tracer that runs a run evaluator whenever a run is persisted.
 
     Parameters
     ----------
     evaluators : Sequence[RunEvaluator]
         The run evaluators to apply to all top level runs.
     client : LangSmith Client, optional
         The LangSmith client instance to use for evaluating the runs.
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/langchain.py` & `gigachain_core-0.2.0/langchain_core/tracers/langchain.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """A Tracer implementation that records to LangChain endpoint."""
+
 from __future__ import annotations
 
 import logging
-import weakref
-from concurrent.futures import Future, ThreadPoolExecutor, wait
+from concurrent.futures import ThreadPoolExecutor
 from datetime import datetime, timezone
-from typing import TYPE_CHECKING, Any, Callable, Dict, List, Optional, Union
+from typing import TYPE_CHECKING, Any, Dict, List, Optional, Union
 from uuid import UUID
 
 from langsmith import Client
 from langsmith import utils as ls_utils
 from tenacity import (
     Retrying,
     retry_if_exception_type,
@@ -23,15 +23,14 @@
 from langchain_core.tracers.schemas import Run
 
 if TYPE_CHECKING:
     from langchain_core.messages import BaseMessage
 
 logger = logging.getLogger(__name__)
 _LOGGED = set()
-_TRACERS: weakref.WeakSet[LangChainTracer] = weakref.WeakSet()
 _CLIENT: Optional[Client] = None
 _EXECUTOR: Optional[ThreadPoolExecutor] = None
 
 
 def log_error_once(method: str, exception: Exception) -> None:
     """Log an error once."""
     global _LOGGED
@@ -39,18 +38,17 @@
         return
     _LOGGED.add((method, type(exception)))
     logger.error(exception)
 
 
 def wait_for_all_tracers() -> None:
     """Wait for all tracers to finish."""
-    global _TRACERS
-    for tracer in list(_TRACERS):
-        if tracer is not None:
-            tracer.wait_for_futures()
+    global _CLIENT
+    if _CLIENT is not None and _CLIENT.tracing_queue is not None:
+        _CLIENT.tracing_queue.join()
 
 
 def get_client() -> Client:
     """Get the client."""
     global _CLIENT
     if _CLIENT is None:
         _CLIENT = Client()
@@ -61,84 +59,74 @@
     """Get the executor."""
     global _EXECUTOR
     if _EXECUTOR is None:
         _EXECUTOR = ThreadPoolExecutor()
     return _EXECUTOR
 
 
-def _copy(run: Run) -> Run:
-    """Copy a run."""
-    try:
-        return run.copy(deep=True)
-    except TypeError:
-        # Fallback in case the object contains a lock or other
-        # non-pickleable object
-        return run.copy()
+def _run_to_dict(run: Run) -> dict:
+    return {
+        **run.dict(exclude={"child_runs", "inputs", "outputs"}),
+        "inputs": run.inputs.copy() if run.inputs is not None else None,
+        "outputs": run.outputs.copy() if run.outputs is not None else None,
+    }
 
 
 class LangChainTracer(BaseTracer):
-    """An implementation of the SharedTracer that POSTS to the langchain endpoint."""
+    """Implementation of the SharedTracer that POSTS to the LangChain endpoint."""
 
     def __init__(
         self,
         example_id: Optional[Union[UUID, str]] = None,
         project_name: Optional[str] = None,
         client: Optional[Client] = None,
         tags: Optional[List[str]] = None,
-        use_threading: bool = True,
         **kwargs: Any,
     ) -> None:
         """Initialize the LangChain tracer."""
         super().__init__(**kwargs)
         self.example_id = (
             UUID(example_id) if isinstance(example_id, str) else example_id
         )
         self.project_name = project_name or ls_utils.get_tracer_project()
         self.client = client or get_client()
-        self._futures: weakref.WeakSet[Future] = weakref.WeakSet()
         self.tags = tags or []
-        self.executor = _get_executor() if use_threading else None
         self.latest_run: Optional[Run] = None
-        global _TRACERS
-        _TRACERS.add(self)
 
     def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
         *,
         run_id: UUID,
         tags: Optional[List[str]] = None,
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
         **kwargs: Any,
-    ) -> None:
+    ) -> Run:
         """Start a trace for an LLM run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         chat_model_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
             inputs={"messages": [[dumpd(msg) for msg in batch] for batch in messages]},
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             run_type="llm",
             tags=tags,
-            name=name,
+            name=name,  # type: ignore[arg-type]
         )
         self._start_trace(chat_model_run)
         self._on_chat_model_start(chat_model_run)
+        return chat_model_run
 
     def _persist_run(self, run: Run) -> None:
         run_ = run.copy()
         run_.reference_example_id = self.example_id
         self.latest_run = run_
 
     def get_run_url(self) -> str:
@@ -163,102 +151,96 @@
         """Get combined tags for a run."""
         tags = set(run.tags or [])
         tags.update(self.tags or [])
         return list(tags)
 
     def _persist_run_single(self, run: Run) -> None:
         """Persist a run."""
-        run_dict = run.dict(exclude={"child_runs"})
+        run_dict = _run_to_dict(run)
         run_dict["tags"] = self._get_tags(run)
         extra = run_dict.get("extra", {})
         extra["runtime"] = get_runtime_environment()
         run_dict["extra"] = extra
         try:
             self.client.create_run(**run_dict, project_name=self.project_name)
         except Exception as e:
             # Errors are swallowed by the thread executor so we need to log them here
             log_error_once("post", e)
             raise
 
     def _update_run_single(self, run: Run) -> None:
         """Update a run."""
         try:
-            run_dict = run.dict()
+            run_dict = _run_to_dict(run)
             run_dict["tags"] = self._get_tags(run)
             self.client.update_run(run.id, **run_dict)
         except Exception as e:
             # Errors are swallowed by the thread executor so we need to log them here
             log_error_once("patch", e)
             raise
 
-    def _submit(self, function: Callable[[Run], None], run: Run) -> None:
-        """Submit a function to the executor."""
-        if self.executor is None:
-            function(run)
-        else:
-            self._futures.add(self.executor.submit(function, run))
-
     def _on_llm_start(self, run: Run) -> None:
         """Persist an LLM run."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_chat_model_start(self, run: Run) -> None:
         """Persist an LLM run."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_llm_end(self, run: Run) -> None:
         """Process the LLM Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_llm_error(self, run: Run) -> None:
         """Process the LLM Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_chain_start(self, run: Run) -> None:
         """Process the Chain Run upon start."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_chain_end(self, run: Run) -> None:
         """Process the Chain Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_chain_error(self, run: Run) -> None:
         """Process the Chain Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_tool_start(self, run: Run) -> None:
         """Process the Tool Run upon start."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_tool_end(self, run: Run) -> None:
         """Process the Tool Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_tool_error(self, run: Run) -> None:
         """Process the Tool Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_retriever_start(self, run: Run) -> None:
         """Process the Retriever Run upon start."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_retriever_end(self, run: Run) -> None:
         """Process the Retriever Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_retriever_error(self, run: Run) -> None:
         """Process the Retriever Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def wait_for_futures(self) -> None:
         """Wait for the given futures to complete."""
-        wait(self._futures)
+        if self.client is not None and self.client.tracing_queue is not None:
+            self.client.tracing_queue.join()
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/root_listeners.py` & `gigachain_core-0.2.0/langchain_core/tracers/root_listeners.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 from langchain_core.tracers.base import BaseTracer
 from langchain_core.tracers.schemas import Run
 
 Listener = Union[Callable[[Run], None], Callable[[Run, RunnableConfig], None]]
 
 
 class RootListenersTracer(BaseTracer):
-    """A tracer that calls listeners on run start, end, and error."""
+    """Tracer that calls listeners on run start, end, and error."""
 
     def __init__(
         self,
         *,
         config: RunnableConfig,
         on_start: Optional[Listener],
         on_end: Optional[Listener],
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/run_collector.py` & `gigachain_core-0.2.0/langchain_core/tracers/run_collector.py`

 * *Files 1% similar despite different names*

```diff
@@ -5,15 +5,15 @@
 
 from langchain_core.tracers.base import BaseTracer
 from langchain_core.tracers.schemas import Run
 
 
 class RunCollectorCallbackHandler(BaseTracer):
     """
-    A tracer that collects all nested runs in a list.
+    Tracer that collects all nested runs in a list.
 
     This tracer is useful for inspection and evaluation purposes.
 
     Parameters
     ----------
     example_id : Optional[Union[UUID, str]], default=None
         The ID of the example being traced. It can be either a UUID or a string.
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/schemas.py` & `gigachain_core-0.2.0/langchain_core/tracers/schemas.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Schemas for tracers."""
+
 from __future__ import annotations
 
 import datetime
 import warnings
 from typing import Any, Dict, List, Optional, Type
 from uuid import UUID
 
@@ -10,61 +11,61 @@
 from langsmith.schemas import RunTypeEnum as RunTypeEnumDep
 
 from langchain_core._api import deprecated
 from langchain_core.outputs import LLMResult
 from langchain_core.pydantic_v1 import BaseModel, Field, root_validator
 
 
-@deprecated("0.1.0", alternative="Use string instead.", removal="0.2.0")
+@deprecated("0.1.0", alternative="Use string instead.", removal="0.3.0")
 def RunTypeEnum() -> Type[RunTypeEnumDep]:
     """RunTypeEnum."""
     warnings.warn(
         "RunTypeEnum is deprecated. Please directly use a string instead"
         " (e.g. 'llm', 'chain', 'tool').",
         DeprecationWarning,
     )
     return RunTypeEnumDep
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionV1Base(BaseModel):
     """Base class for TracerSessionV1."""
 
     start_time: datetime.datetime = Field(default_factory=datetime.datetime.utcnow)
     name: Optional[str] = None
     extra: Optional[Dict[str, Any]] = None
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionV1Create(TracerSessionV1Base):
     """Create class for TracerSessionV1."""
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionV1(TracerSessionV1Base):
     """TracerSessionV1 schema."""
 
     id: int
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionBase(TracerSessionV1Base):
     """Base class for TracerSession."""
 
     tenant_id: UUID
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSession(TracerSessionBase):
     """TracerSessionV1 schema for the V2 API."""
 
     id: UUID
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class BaseRun(BaseModel):
     """Base class for Run."""
 
     uuid: str
     parent_uuid: Optional[str] = None
     start_time: datetime.datetime = Field(default_factory=datetime.datetime.utcnow)
     end_time: datetime.datetime = Field(default_factory=datetime.datetime.utcnow)
@@ -72,34 +73,34 @@
     execution_order: int
     child_execution_order: int
     serialized: Dict[str, Any]
     session_id: int
     error: Optional[str] = None
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class LLMRun(BaseRun):
     """Class for LLMRun."""
 
     prompts: List[str]
     response: Optional[LLMResult] = None
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class ChainRun(BaseRun):
     """Class for ChainRun."""
 
     inputs: Dict[str, Any]
     outputs: Optional[Dict[str, Any]] = None
     child_llm_runs: List[LLMRun] = Field(default_factory=list)
     child_chain_runs: List[ChainRun] = Field(default_factory=list)
     child_tool_runs: List[ToolRun] = Field(default_factory=list)
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class ToolRun(BaseRun):
     """Class for ToolRun."""
 
     tool_input: str
     output: Optional[str] = None
     action: str
     child_llm_runs: List[LLMRun] = Field(default_factory=list)
@@ -109,16 +110,14 @@
 
 # Begin V2 API Schemas
 
 
 class Run(BaseRunV2):
     """Run schema for the V2 API in the Tracer."""
 
-    execution_order: int
-    child_execution_order: int
     child_runs: List[Run] = Field(default_factory=list)
     tags: Optional[List[str]] = Field(default_factory=list)
     events: List[Dict[str, Any]] = Field(default_factory=list)
     trace_id: Optional[UUID] = None
     dotted_order: Optional[str] = None
 
     @root_validator(pre=True)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/tracers/stdout.py` & `gigachain_core-0.2.0/langchain_core/tracers/stdout.py`

 * *Files 5% similar despite different names*

```diff
@@ -64,17 +64,17 @@
             else:
                 break
         return parents
 
     def get_breadcrumbs(self, run: Run) -> str:
         parents = self.get_parents(run)[::-1]
         string = " > ".join(
-            f"{parent.execution_order}:{parent.run_type}:{parent.name}"
+            f"{parent.run_type}:{parent.name}"
             if i != len(parents) - 1
-            else f"{parent.execution_order}:{parent.run_type}:{parent.name}"
+            else f"{parent.run_type}:{parent.name}"
             for i, parent in enumerate(parents + [run])
         )
         return string
 
     # logging methods
     def _on_chain_start(self, run: Run) -> None:
         crumbs = self.get_breadcrumbs(run)
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/__init__.py` & `gigachain_core-0.2.0/langchain_core/utils/__init__.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 """
 **Utility functions** for LangChain.
 
 These functions do not depend on any other LangChain module.
 """
 
+from langchain_core.utils import image
 from langchain_core.utils.env import get_from_dict_or_env, get_from_env
 from langchain_core.utils.formatting import StrictFormatter, formatter
 from langchain_core.utils.input import (
     get_bolded_text,
     get_color_mapping,
     get_colored_text,
     print_text,
@@ -37,13 +38,14 @@
     "guard_import",
     "mock_now",
     "print_text",
     "raise_for_status_with_text",
     "xor_args",
     "try_load_from_hub",
     "build_extra_kwargs",
+    "image",
     "get_from_env",
     "get_from_dict_or_env",
     "stringify_dict",
     "comma_list",
     "stringify_value",
 ]
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/aiter.py` & `gigachain_core-0.2.0/langchain_core/utils/aiter.py`

 * *Files 1% similar despite different names*

```diff
@@ -116,15 +116,15 @@
             # if we are the last peer, try and close the iterator
             if not peers and hasattr(iterator, "aclose"):
                 await iterator.aclose()
 
 
 class Tee(Generic[T]):
     """
-    Create ``n`` separate asynchronous iterators over ``iterable``
+    Create ``n`` separate asynchronous iterators over ``iterable``.
 
     This splits a single ``iterable`` into multiple iterators, each providing
     the same items in the same order.
     All child iterators may advance separately but share the same items
     from ``iterable`` -- when the most advanced iterator retrieves an item,
     it is buffered until the least advanced iterator has yielded it as well.
     A ``tee`` works lazily and can handle an infinite ``iterable``, provided
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/env.py` & `gigachain_core-0.2.0/langchain_core/utils/env.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/formatting.py` & `gigachain_core-0.2.0/langchain_core/utils/formatting.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """Utilities for formatting strings."""
+
 from string import Formatter
 from typing import Any, List, Mapping, Sequence
 
 
 class StrictFormatter(Formatter):
-    """A subclass of formatter that checks for extra keys."""
+    """Formatter that checks for extra keys."""
 
     def vformat(
         self, format_string: str, args: Sequence, kwargs: Mapping[str, Any]
     ) -> str:
         """Check that no arguments are provided."""
         if len(args) > 0:
             raise ValueError(
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/html.py` & `gigachain_core-0.2.0/langchain_core/utils/html.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,11 +1,14 @@
+import logging
 import re
 from typing import List, Optional, Sequence, Union
 from urllib.parse import urljoin, urlparse
 
+logger = logging.getLogger(__name__)
+
 PREFIXES_TO_IGNORE = ("javascript:", "mailto:", "#")
 SUFFIXES_TO_IGNORE = (
     ".css",
     ".js",
     ".ico",
     ".png",
     ".jpg",
@@ -48,44 +51,56 @@
     raw_html: str,
     url: str,
     *,
     base_url: Optional[str] = None,
     pattern: Union[str, re.Pattern, None] = None,
     prevent_outside: bool = True,
     exclude_prefixes: Sequence[str] = (),
+    continue_on_failure: bool = False,
 ) -> List[str]:
     """Extract all links from a raw html string and convert into absolute paths.
 
     Args:
         raw_html: original html.
         url: the url of the html.
         base_url: the base url to check for outside links against.
         pattern: Regex to use for extracting links from raw html.
         prevent_outside: If True, ignore external links which are not children
             of the base url.
         exclude_prefixes: Exclude any URLs that start with one of these prefixes.
-
+        continue_on_failure: If True, continue if parsing a specific link raises an
+            exception. Otherwise, raise the exception.
     Returns:
         List[str]: sub links
     """
     base_url_to_use = base_url if base_url is not None else url
     parsed_base_url = urlparse(base_url_to_use)
+    parsed_url = urlparse(url)
     all_links = find_all_links(raw_html, pattern=pattern)
     absolute_paths = set()
     for link in all_links:
-        parsed_link = urlparse(link)
-        # Some may be absolute links like https://to/path
-        if parsed_link.scheme == "http" or parsed_link.scheme == "https":
-            absolute_path = link
-        # Some may have omitted the protocol like //to/path
-        elif link.startswith("//"):
-            absolute_path = f"{urlparse(url).scheme}:{link}"
-        else:
-            absolute_path = urljoin(url, parsed_link.path)
-        absolute_paths.add(absolute_path)
+        try:
+            parsed_link = urlparse(link)
+            # Some may be absolute links like https://to/path
+            if parsed_link.scheme == "http" or parsed_link.scheme == "https":
+                absolute_path = link
+            # Some may have omitted the protocol like //to/path
+            elif link.startswith("//"):
+                absolute_path = f"{parsed_url.scheme}:{link}"
+            else:
+                absolute_path = urljoin(url, parsed_link.path)
+                if parsed_link.query:
+                    absolute_path += f"?{parsed_link.query}"
+            absolute_paths.add(absolute_path)
+        except Exception as e:
+            if continue_on_failure:
+                logger.warning(f"Unable to load link {link}. Raised exception:\n\n{e}")
+                continue
+            else:
+                raise e
 
     results = []
     for path in absolute_paths:
         if any(path.startswith(exclude_prefix) for exclude_prefix in exclude_prefixes):
             continue
 
         if prevent_outside:
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/input.py` & `gigachain_core-0.2.0/langchain_core/utils/input.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Handle chained inputs."""
+
 from typing import Dict, List, Optional, TextIO
 
 _TEXT_COLOR_MAPPING = {
     "blue": "36;1",
     "yellow": "33;1",
     "pink": "38;5;200",
     "green": "32;1",
@@ -33,10 +34,10 @@
 
 
 def print_text(
     text: str, color: Optional[str] = None, end: str = "", file: Optional[TextIO] = None
 ) -> None:
     """Print text with highlighting and no end characters."""
     text_to_print = get_colored_text(text, color) if color else text
-    print(text_to_print, end=end, file=file)
+    print(text_to_print, end=end, file=file)  # noqa: T201
     if file:
         file.flush()  # ensure all printed content are written to file
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/iter.py` & `gigachain_core-0.2.0/langchain_core/utils/iter.py`

 * *Files 10% similar despite different names*

```diff
@@ -161,15 +161,23 @@
             child.close()
 
 
 # Why this is needed https://stackoverflow.com/a/44638570
 safetee = Tee
 
 
-def batch_iterate(size: int, iterable: Iterable[T]) -> Iterator[List[T]]:
-    """Utility batching function."""
+def batch_iterate(size: Optional[int], iterable: Iterable[T]) -> Iterator[List[T]]:
+    """Utility batching function.
+
+    Args:
+        size: The size of the batch. If None, returns a single batch.
+        iterable: The iterable to batch.
+
+    Returns:
+        An iterator over the batches.
+    """
     it = iter(iterable)
     while True:
         chunk = list(islice(it, size))
         if not chunk:
             return
         yield chunk
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/loading.py` & `gigachain_core-0.2.0/langchain_core/utils/loading.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/strings.py` & `gigachain_core-0.2.0/langchain_core/utils/strings.py`

 * *Files identical despite different names*

### Comparing `gigachain_core-0.1.9.1/langchain_core/utils/utils.py` & `gigachain_core-0.2.0/langchain_core/utils/utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Generic utility functions."""
+
 import contextlib
 import datetime
 import functools
 import importlib
 import warnings
 from importlib.metadata import version
 from typing import Any, Callable, Dict, Optional, Set, Tuple, Union
@@ -80,22 +81,23 @@
     finally:
         datetime.datetime = real_datetime
 
 
 def guard_import(
     module_name: str, *, pip_name: Optional[str] = None, package: Optional[str] = None
 ) -> Any:
-    """Dynamically imports a module and raises a helpful exception if the module is not
+    """Dynamically import a module and raise an exception if the module is not
     installed."""
     try:
         module = importlib.import_module(module_name, package)
-    except ImportError:
+    except (ImportError, ModuleNotFoundError):
+        pip_name = pip_name or module_name.split(".")[0].replace("_", "-")
         raise ImportError(
             f"Could not import {module_name} python package. "
-            f"Please install it with `pip install {pip_name or module_name}`."
+            f"Please install it with `pip install {pip_name}`."
         )
     return module
 
 
 def check_package_version(
     package: str,
     lt_version: Optional[str] = None,
```

### Comparing `gigachain_core-0.1.9.1/langchain_core/vectorstores.py` & `gigachain_core-0.2.0/langchain_core/vectorstores.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,7 +1,28 @@
+"""**Vector store** stores embedded data and performs vector search.
+
+One of the most common ways to store and search over unstructured data is to
+embed it and store the resulting embedding vectors, and then query the store
+and retrieve the data that are 'most similar' to the embedded query.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    VectorStore --> <name>  # Examples: Annoy, FAISS, Milvus
+
+    BaseRetriever --> VectorStoreRetriever --> <name>Retriever  # Example: VespaRetriever
+
+**Main helpers:**
+
+.. code-block::
+
+    Embeddings, Document
+"""  # noqa: E501
+
 from __future__ import annotations
 
 import logging
 import math
 import warnings
 from abc import ABC, abstractmethod
 from typing import (
@@ -88,16 +109,15 @@
             ids: List of ids to delete.
             **kwargs: Other keyword arguments that subclasses might use.
 
         Returns:
             Optional[bool]: True if deletion is successful,
             False otherwise, None if not implemented.
         """
-
-        raise NotImplementedError("delete method must be implemented by subclass.")
+        return await run_in_executor(None, self.delete, ids, **kwargs)
 
     async def aadd_texts(
         self,
         texts: Iterable[str],
         metadatas: Optional[List[dict]] = None,
         **kwargs: Any,
     ) -> List[str]:
@@ -439,15 +459,30 @@
         self,
         query: str,
         k: int = 4,
         fetch_k: int = 20,
         lambda_mult: float = 0.5,
         **kwargs: Any,
     ) -> List[Document]:
-        """Return docs selected using the maximal marginal relevance."""
+        """Return docs selected using the maximal marginal relevance.
+
+        Maximal marginal relevance optimizes for similarity to query AND diversity
+        among selected documents.
+
+        Args:
+            query: Text to look up documents similar to.
+            k: Number of Documents to return. Defaults to 4.
+            fetch_k: Number of Documents to fetch to pass to MMR algorithm.
+            lambda_mult: Number between 0 and 1 that determines the degree
+                        of diversity among the results with 0 corresponding
+                        to maximum diversity and 1 to minimum diversity.
+                        Defaults to 0.5.
+        Returns:
+            List of Documents selected by maximal marginal relevance.
+        """
 
         # This is a temporary workaround to make the similarity search
         # asynchronous. The proper solution is to make the similarity search
         # asynchronous in the vector store implementations.
         return await run_in_executor(
             None,
             self.max_marginal_relevance_search,
@@ -489,15 +524,23 @@
         embedding: List[float],
         k: int = 4,
         fetch_k: int = 20,
         lambda_mult: float = 0.5,
         **kwargs: Any,
     ) -> List[Document]:
         """Return docs selected using the maximal marginal relevance."""
-        raise NotImplementedError
+        return await run_in_executor(
+            None,
+            self.max_marginal_relevance_search_by_vector,
+            embedding,
+            k=k,
+            fetch_k=fetch_k,
+            lambda_mult=lambda_mult,
+            **kwargs,
+        )
 
     @classmethod
     def from_documents(
         cls: Type[VST],
         documents: List[Document],
         embedding: Embeddings,
         **kwargs: Any,
```

### Comparing `gigachain_core-0.1.9.1/pyproject.toml` & `gigachain_core-0.2.0/pyproject.toml`

 * *Files 8% similar despite different names*

```diff
@@ -1,45 +1,45 @@
+
 [tool.poetry]
 name = "gigachain-core"
-version = "0.1.9.1"
+version = "0.2.0"
 description = "Building applications with LLMs through composability"
 authors = []
 license = "MIT"
 readme = "README.md"
-repository = "https://github.com/langchain-ai/langchain"
+repository = "https://github.com/ai-forever/gigachain"
 packages = [
     {include = "langchain_core"}
 ]
 
 [tool.poetry.dependencies]
 python = ">=3.8.1,<4.0"
 pydantic = ">=1,<3"
-langsmith = "~0.0.63"
+langsmith = "^0.1.0"
 tenacity = "^8.1.0"
 jsonpatch = "^1.33"
-anyio = ">=3,<5"
 PyYAML = ">=5.3"
-requests = "^2"
 packaging = "^23.2"
-jinja2 = {version = "^3", optional = true}
+jinja2 = { version = "^3", optional = true }
 
 [tool.poetry.group.lint]
 optional = true
 
 [tool.poetry.group.lint.dependencies]
 ruff = "^0.1.5"
 
 [tool.poetry.group.typing]
 optional = true
 
 [tool.poetry.group.typing.dependencies]
-mypy = "^0.991"
+mypy = "^1"
 types-pyyaml = "^6.0.12.2"
 types-requests = "^2.28.11.5"
 types-jinja2 = "^2.11.9"
+gigachain-text-splitters = { path = "../text-splitters", develop = true }
 
 [tool.poetry.group.dev]
 optional = true
 
 [tool.poetry.group.dev.dependencies]
 jupyter = "^1.0.0"
 setuptools = "^67.6.1"
@@ -50,44 +50,51 @@
 
 [tool.poetry.group.test.dependencies]
 # The only dependencies that should be added are
 # dependencies used for running tests (e.g., pytest, freezegun, response).
 # Any dependencies that do not meet that criteria will be removed.
 pytest = "^7.3.0"
 freezegun = "^1.2.2"
-pytest-mock  = "^3.10.0"
+pytest-mock = "^3.10.0"
 syrupy = "^4.0.2"
 pytest-watcher = "^0.3.4"
 pytest-asyncio = "^0.21.1"
 grandalf = "^0.8"
+pytest-profiling = "^1.7.0"
+responses = "^0.25.0"
+numpy = "^1.24.0"
 
 
 [tool.poetry.group.test_integration]
 optional = true
 dependencies = {}
 
 [tool.poetry.extras]
 extended_testing = ["jinja2"]
 
-[tool.ruff]
+[tool.ruff.lint]
 select = [
-  "E",  # pycodestyle
-  "F",  # pyflakes
-  "I",  # isort
+  "E",    # pycodestyle
+  "F",    # pyflakes
+  "I",    # isort
+  "T201", # print
 ]
 
 [tool.mypy]
 disallow_untyped_defs = "True"
 ignore_missing_imports = "True"
 exclude = ["notebooks", "examples", "example_data", "langchain_core/pydantic"]
 
+[[tool.mypy.overrides]]
+# conditional dependencies introduced by langsmith-sdk
+module = ["numpy", "pytest"]
+ignore_missing_imports = true
+
 [tool.coverage.run]
-omit = [
-    "tests/*",
-]
+omit = ["tests/*"]
 
 [build-system]
 requires = ["poetry-core>=1.0.0"]
 build-backend = "poetry.core.masonry.api"
 
 [tool.pytest.ini_options]
 # --strict-markers will raise errors on unknown marks.
@@ -104,7 +111,8 @@
 # https://docs.pytest.org/en/7.1.x/example/markers.html#registering-markers
 markers = [
   "requires: mark tests as requiring a specific library",
   "asyncio: mark tests as requiring asyncio",
   "compile: mark placeholder test used to compile integration tests without running them",
 ]
 asyncio_mode = "auto"
+
```

